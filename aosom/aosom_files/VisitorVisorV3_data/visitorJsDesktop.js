/*! jQuery v2.2.0 | (c) jQuery Foundation | jquery.org/license */
!function (a, b) { "object" == typeof module && "object" == typeof module.exports ? module.exports = a.document ? b(a, !0) : function (a) { if (!a.document) throw new Error("jQuery requires a window with a document"); return b(a) } : b(a) }("undefined" != typeof window ? window : this, function (a, b) {
    var c = [], d = a.document, e = c.slice, f = c.concat, g = c.push, h = c.indexOf, i = {}, j = i.toString, k = i.hasOwnProperty, l = {}, m = "2.2.0", n = function (a, b) { return new n.fn.init(a, b) }, o = /^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, p = /^-ms-/, q = /-([\da-z])/gi, r = function (a, b) { return b.toUpperCase() }; n.fn = n.prototype = { jquery: m, constructor: n, selector: "", length: 0, toArray: function () { return e.call(this) }, get: function (a) { return null != a ? 0 > a ? this[a + this.length] : this[a] : e.call(this) }, pushStack: function (a) { var b = n.merge(this.constructor(), a); return b.prevObject = this, b.context = this.context, b }, each: function (a) { return n.each(this, a) }, map: function (a) { return this.pushStack(n.map(this, function (b, c) { return a.call(b, c, b) })) }, slice: function () { return this.pushStack(e.apply(this, arguments)) }, first: function () { return this.eq(0) }, last: function () { return this.eq(-1) }, eq: function (a) { var b = this.length, c = +a + (0 > a ? b : 0); return this.pushStack(c >= 0 && b > c ? [this[c]] : []) }, end: function () { return this.prevObject || this.constructor() }, push: g, sort: c.sort, splice: c.splice }, n.extend = n.fn.extend = function () { var a, b, c, d, e, f, g = arguments[0] || {}, h = 1, i = arguments.length, j = !1; for ("boolean" == typeof g && (j = g, g = arguments[h] || {}, h++), "object" == typeof g || n.isFunction(g) || (g = {}), h === i && (g = this, h--) ; i > h; h++) if (null != (a = arguments[h])) for (b in a) c = g[b], d = a[b], g !== d && (j && d && (n.isPlainObject(d) || (e = n.isArray(d))) ? (e ? (e = !1, f = c && n.isArray(c) ? c : []) : f = c && n.isPlainObject(c) ? c : {}, g[b] = n.extend(j, f, d)) : void 0 !== d && (g[b] = d)); return g }, n.extend({ expando: "jQuery" + (m + Math.random()).replace(/\D/g, ""), isReady: !0, error: function (a) { throw new Error(a) }, noop: function () { }, isFunction: function (a) { return "function" === n.type(a) }, isArray: Array.isArray, isWindow: function (a) { return null != a && a === a.window }, isNumeric: function (a) { var b = a && a.toString(); return !n.isArray(a) && b - parseFloat(b) + 1 >= 0 }, isPlainObject: function (a) { return "object" !== n.type(a) || a.nodeType || n.isWindow(a) ? !1 : a.constructor && !k.call(a.constructor.prototype, "isPrototypeOf") ? !1 : !0 }, isEmptyObject: function (a) { var b; for (b in a) return !1; return !0 }, type: function (a) { return null == a ? a + "" : "object" == typeof a || "function" == typeof a ? i[j.call(a)] || "object" : typeof a }, globalEval: function (a) { var b, c = eval; a = n.trim(a), a && (1 === a.indexOf("use strict") ? (b = d.createElement("script"), b.text = a, d.head.appendChild(b).parentNode.removeChild(b)) : c(a)) }, camelCase: function (a) { return a.replace(p, "ms-").replace(q, r) }, nodeName: function (a, b) { return a.nodeName && a.nodeName.toLowerCase() === b.toLowerCase() }, each: function (a, b) { var c, d = 0; if (s(a)) { for (c = a.length; c > d; d++) if (b.call(a[d], d, a[d]) === !1) break } else for (d in a) if (b.call(a[d], d, a[d]) === !1) break; return a }, trim: function (a) { return null == a ? "" : (a + "").replace(o, "") }, makeArray: function (a, b) { var c = b || []; return null != a && (s(Object(a)) ? n.merge(c, "string" == typeof a ? [a] : a) : g.call(c, a)), c }, inArray: function (a, b, c) { return null == b ? -1 : h.call(b, a, c) }, merge: function (a, b) { for (var c = +b.length, d = 0, e = a.length; c > d; d++) a[e++] = b[d]; return a.length = e, a }, grep: function (a, b, c) { for (var d, e = [], f = 0, g = a.length, h = !c; g > f; f++) d = !b(a[f], f), d !== h && e.push(a[f]); return e }, map: function (a, b, c) { var d, e, g = 0, h = []; if (s(a)) for (d = a.length; d > g; g++) e = b(a[g], g, c), null != e && h.push(e); else for (g in a) e = b(a[g], g, c), null != e && h.push(e); return f.apply([], h) }, guid: 1, proxy: function (a, b) { var c, d, f; return "string" == typeof b && (c = a[b], b = a, a = c), n.isFunction(a) ? (d = e.call(arguments, 2), f = function () { return a.apply(b || this, d.concat(e.call(arguments))) }, f.guid = a.guid = a.guid || n.guid++, f) : void 0 }, now: Date.now, support: l }), "function" == typeof Symbol && (n.fn[Symbol.iterator] = c[Symbol.iterator]), n.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "), function (a, b) { i["[object " + b + "]"] = b.toLowerCase() }); function s(a) { var b = !!a && "length" in a && a.length, c = n.type(a); return "function" === c || n.isWindow(a) ? !1 : "array" === c || 0 === b || "number" == typeof b && b > 0 && b - 1 in a } var t = function (a) { var b, c, d, e, f, g, h, i, j, k, l, m, n, o, p, q, r, s, t, u = "sizzle" + 1 * new Date, v = a.document, w = 0, x = 0, y = ga(), z = ga(), A = ga(), B = function (a, b) { return a === b && (l = !0), 0 }, C = 1 << 31, D = {}.hasOwnProperty, E = [], F = E.pop, G = E.push, H = E.push, I = E.slice, J = function (a, b) { for (var c = 0, d = a.length; d > c; c++) if (a[c] === b) return c; return -1 }, K = "checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped", L = "[\\x20\\t\\r\\n\\f]", M = "(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+", N = "\\[" + L + "*(" + M + ")(?:" + L + "*([*^$|!~]?=)" + L + "*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|(" + M + "))|)" + L + "*\\]", O = ":(" + M + ")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|" + N + ")*)|.*)\\)|)", P = new RegExp(L + "+", "g"), Q = new RegExp("^" + L + "+|((?:^|[^\\\\])(?:\\\\.)*)" + L + "+$", "g"), R = new RegExp("^" + L + "*," + L + "*"), S = new RegExp("^" + L + "*([>+~]|" + L + ")" + L + "*"), T = new RegExp("=" + L + "*([^\\]'\"]*?)" + L + "*\\]", "g"), U = new RegExp(O), V = new RegExp("^" + M + "$"), W = { ID: new RegExp("^#(" + M + ")"), CLASS: new RegExp("^\\.(" + M + ")"), TAG: new RegExp("^(" + M + "|[*])"), ATTR: new RegExp("^" + N), PSEUDO: new RegExp("^" + O), CHILD: new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\(" + L + "*(even|odd|(([+-]|)(\\d*)n|)" + L + "*(?:([+-]|)" + L + "*(\\d+)|))" + L + "*\\)|)", "i"), bool: new RegExp("^(?:" + K + ")$", "i"), needsContext: new RegExp("^" + L + "*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\(" + L + "*((?:-\\d)?\\d*)" + L + "*\\)|)(?=[^-]|$)", "i") }, X = /^(?:input|select|textarea|button)$/i, Y = /^h\d$/i, Z = /^[^{]+\{\s*\[native \w/, $ = /^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/, _ = /[+~]/, aa = /'|\\/g, ba = new RegExp("\\\\([\\da-f]{1,6}" + L + "?|(" + L + ")|.)", "ig"), ca = function (a, b, c) { var d = "0x" + b - 65536; return d !== d || c ? b : 0 > d ? String.fromCharCode(d + 65536) : String.fromCharCode(d >> 10 | 55296, 1023 & d | 56320) }, da = function () { m() }; try { H.apply(E = I.call(v.childNodes), v.childNodes), E[v.childNodes.length].nodeType } catch (ea) { H = { apply: E.length ? function (a, b) { G.apply(a, I.call(b)) } : function (a, b) { var c = a.length, d = 0; while (a[c++] = b[d++]); a.length = c - 1 } } } function fa(a, b, d, e) { var f, h, j, k, l, o, r, s, w = b && b.ownerDocument, x = b ? b.nodeType : 9; if (d = d || [], "string" != typeof a || !a || 1 !== x && 9 !== x && 11 !== x) return d; if (!e && ((b ? b.ownerDocument || b : v) !== n && m(b), b = b || n, p)) { if (11 !== x && (o = $.exec(a))) if (f = o[1]) { if (9 === x) { if (!(j = b.getElementById(f))) return d; if (j.id === f) return d.push(j), d } else if (w && (j = w.getElementById(f)) && t(b, j) && j.id === f) return d.push(j), d } else { if (o[2]) return H.apply(d, b.getElementsByTagName(a)), d; if ((f = o[3]) && c.getElementsByClassName && b.getElementsByClassName) return H.apply(d, b.getElementsByClassName(f)), d } if (c.qsa && !A[a + " "] && (!q || !q.test(a))) { if (1 !== x) w = b, s = a; else if ("object" !== b.nodeName.toLowerCase()) { (k = b.getAttribute("id")) ? k = k.replace(aa, "\\$&") : b.setAttribute("id", k = u), r = g(a), h = r.length, l = V.test(k) ? "#" + k : "[id='" + k + "']"; while (h--) r[h] = l + " " + qa(r[h]); s = r.join(","), w = _.test(a) && oa(b.parentNode) || b } if (s) try { return H.apply(d, w.querySelectorAll(s)), d } catch (y) { } finally { k === u && b.removeAttribute("id") } } } return i(a.replace(Q, "$1"), b, d, e) } function ga() { var a = []; function b(c, e) { return a.push(c + " ") > d.cacheLength && delete b[a.shift()], b[c + " "] = e } return b } function ha(a) { return a[u] = !0, a } function ia(a) { var b = n.createElement("div"); try { return !!a(b) } catch (c) { return !1 } finally { b.parentNode && b.parentNode.removeChild(b), b = null } } function ja(a, b) { var c = a.split("|"), e = c.length; while (e--) d.attrHandle[c[e]] = b } function ka(a, b) { var c = b && a, d = c && 1 === a.nodeType && 1 === b.nodeType && (~b.sourceIndex || C) - (~a.sourceIndex || C); if (d) return d; if (c) while (c = c.nextSibling) if (c === b) return -1; return a ? 1 : -1 } function la(a) { return function (b) { var c = b.nodeName.toLowerCase(); return "input" === c && b.type === a } } function ma(a) { return function (b) { var c = b.nodeName.toLowerCase(); return ("input" === c || "button" === c) && b.type === a } } function na(a) { return ha(function (b) { return b = +b, ha(function (c, d) { var e, f = a([], c.length, b), g = f.length; while (g--) c[e = f[g]] && (c[e] = !(d[e] = c[e])) }) }) } function oa(a) { return a && "undefined" != typeof a.getElementsByTagName && a } c = fa.support = {}, f = fa.isXML = function (a) { var b = a && (a.ownerDocument || a).documentElement; return b ? "HTML" !== b.nodeName : !1 }, m = fa.setDocument = function (a) { var b, e, g = a ? a.ownerDocument || a : v; return g !== n && 9 === g.nodeType && g.documentElement ? (n = g, o = n.documentElement, p = !f(n), (e = n.defaultView) && e.top !== e && (e.addEventListener ? e.addEventListener("unload", da, !1) : e.attachEvent && e.attachEvent("onunload", da)), c.attributes = ia(function (a) { return a.className = "i", !a.getAttribute("className") }), c.getElementsByTagName = ia(function (a) { return a.appendChild(n.createComment("")), !a.getElementsByTagName("*").length }), c.getElementsByClassName = Z.test(n.getElementsByClassName), c.getById = ia(function (a) { return o.appendChild(a).id = u, !n.getElementsByName || !n.getElementsByName(u).length }), c.getById ? (d.find.ID = function (a, b) { if ("undefined" != typeof b.getElementById && p) { var c = b.getElementById(a); return c ? [c] : [] } }, d.filter.ID = function (a) { var b = a.replace(ba, ca); return function (a) { return a.getAttribute("id") === b } }) : (delete d.find.ID, d.filter.ID = function (a) { var b = a.replace(ba, ca); return function (a) { var c = "undefined" != typeof a.getAttributeNode && a.getAttributeNode("id"); return c && c.value === b } }), d.find.TAG = c.getElementsByTagName ? function (a, b) { return "undefined" != typeof b.getElementsByTagName ? b.getElementsByTagName(a) : c.qsa ? b.querySelectorAll(a) : void 0 } : function (a, b) { var c, d = [], e = 0, f = b.getElementsByTagName(a); if ("*" === a) { while (c = f[e++]) 1 === c.nodeType && d.push(c); return d } return f }, d.find.CLASS = c.getElementsByClassName && function (a, b) { return "undefined" != typeof b.getElementsByClassName && p ? b.getElementsByClassName(a) : void 0 }, r = [], q = [], (c.qsa = Z.test(n.querySelectorAll)) && (ia(function (a) { o.appendChild(a).innerHTML = "<a id='" + u + "'></a><select id='" + u + "-\r\\' msallowcapture=''><option selected=''></option></select>", a.querySelectorAll("[msallowcapture^='']").length && q.push("[*^$]=" + L + "*(?:''|\"\")"), a.querySelectorAll("[selected]").length || q.push("\\[" + L + "*(?:value|" + K + ")"), a.querySelectorAll("[id~=" + u + "-]").length || q.push("~="), a.querySelectorAll(":checked").length || q.push(":checked"), a.querySelectorAll("a#" + u + "+*").length || q.push(".#.+[+~]") }), ia(function (a) { var b = n.createElement("input"); b.setAttribute("type", "hidden"), a.appendChild(b).setAttribute("name", "D"), a.querySelectorAll("[name=d]").length && q.push("name" + L + "*[*^$|!~]?="), a.querySelectorAll(":enabled").length || q.push(":enabled", ":disabled"), a.querySelectorAll("*,:x"), q.push(",.*:") })), (c.matchesSelector = Z.test(s = o.matches || o.webkitMatchesSelector || o.mozMatchesSelector || o.oMatchesSelector || o.msMatchesSelector)) && ia(function (a) { c.disconnectedMatch = s.call(a, "div"), s.call(a, "[s!='']:x"), r.push("!=", O) }), q = q.length && new RegExp(q.join("|")), r = r.length && new RegExp(r.join("|")), b = Z.test(o.compareDocumentPosition), t = b || Z.test(o.contains) ? function (a, b) { var c = 9 === a.nodeType ? a.documentElement : a, d = b && b.parentNode; return a === d || !(!d || 1 !== d.nodeType || !(c.contains ? c.contains(d) : a.compareDocumentPosition && 16 & a.compareDocumentPosition(d))) } : function (a, b) { if (b) while (b = b.parentNode) if (b === a) return !0; return !1 }, B = b ? function (a, b) { if (a === b) return l = !0, 0; var d = !a.compareDocumentPosition - !b.compareDocumentPosition; return d ? d : (d = (a.ownerDocument || a) === (b.ownerDocument || b) ? a.compareDocumentPosition(b) : 1, 1 & d || !c.sortDetached && b.compareDocumentPosition(a) === d ? a === n || a.ownerDocument === v && t(v, a) ? -1 : b === n || b.ownerDocument === v && t(v, b) ? 1 : k ? J(k, a) - J(k, b) : 0 : 4 & d ? -1 : 1) } : function (a, b) { if (a === b) return l = !0, 0; var c, d = 0, e = a.parentNode, f = b.parentNode, g = [a], h = [b]; if (!e || !f) return a === n ? -1 : b === n ? 1 : e ? -1 : f ? 1 : k ? J(k, a) - J(k, b) : 0; if (e === f) return ka(a, b); c = a; while (c = c.parentNode) g.unshift(c); c = b; while (c = c.parentNode) h.unshift(c); while (g[d] === h[d]) d++; return d ? ka(g[d], h[d]) : g[d] === v ? -1 : h[d] === v ? 1 : 0 }, n) : n }, fa.matches = function (a, b) { return fa(a, null, null, b) }, fa.matchesSelector = function (a, b) { if ((a.ownerDocument || a) !== n && m(a), b = b.replace(T, "='$1']"), c.matchesSelector && p && !A[b + " "] && (!r || !r.test(b)) && (!q || !q.test(b))) try { var d = s.call(a, b); if (d || c.disconnectedMatch || a.document && 11 !== a.document.nodeType) return d } catch (e) { } return fa(b, n, null, [a]).length > 0 }, fa.contains = function (a, b) { return (a.ownerDocument || a) !== n && m(a), t(a, b) }, fa.attr = function (a, b) { (a.ownerDocument || a) !== n && m(a); var e = d.attrHandle[b.toLowerCase()], f = e && D.call(d.attrHandle, b.toLowerCase()) ? e(a, b, !p) : void 0; return void 0 !== f ? f : c.attributes || !p ? a.getAttribute(b) : (f = a.getAttributeNode(b)) && f.specified ? f.value : null }, fa.error = function (a) { throw new Error("Syntax error, unrecognized expression: " + a) }, fa.uniqueSort = function (a) { var b, d = [], e = 0, f = 0; if (l = !c.detectDuplicates, k = !c.sortStable && a.slice(0), a.sort(B), l) { while (b = a[f++]) b === a[f] && (e = d.push(f)); while (e--) a.splice(d[e], 1) } return k = null, a }, e = fa.getText = function (a) { var b, c = "", d = 0, f = a.nodeType; if (f) { if (1 === f || 9 === f || 11 === f) { if ("string" == typeof a.textContent) return a.textContent; for (a = a.firstChild; a; a = a.nextSibling) c += e(a) } else if (3 === f || 4 === f) return a.nodeValue } else while (b = a[d++]) c += e(b); return c }, d = fa.selectors = { cacheLength: 50, createPseudo: ha, match: W, attrHandle: {}, find: {}, relative: { ">": { dir: "parentNode", first: !0 }, " ": { dir: "parentNode" }, "+": { dir: "previousSibling", first: !0 }, "~": { dir: "previousSibling" } }, preFilter: { ATTR: function (a) { return a[1] = a[1].replace(ba, ca), a[3] = (a[3] || a[4] || a[5] || "").replace(ba, ca), "~=" === a[2] && (a[3] = " " + a[3] + " "), a.slice(0, 4) }, CHILD: function (a) { return a[1] = a[1].toLowerCase(), "nth" === a[1].slice(0, 3) ? (a[3] || fa.error(a[0]), a[4] = +(a[4] ? a[5] + (a[6] || 1) : 2 * ("even" === a[3] || "odd" === a[3])), a[5] = +(a[7] + a[8] || "odd" === a[3])) : a[3] && fa.error(a[0]), a }, PSEUDO: function (a) { var b, c = !a[6] && a[2]; return W.CHILD.test(a[0]) ? null : (a[3] ? a[2] = a[4] || a[5] || "" : c && U.test(c) && (b = g(c, !0)) && (b = c.indexOf(")", c.length - b) - c.length) && (a[0] = a[0].slice(0, b), a[2] = c.slice(0, b)), a.slice(0, 3)) } }, filter: { TAG: function (a) { var b = a.replace(ba, ca).toLowerCase(); return "*" === a ? function () { return !0 } : function (a) { return a.nodeName && a.nodeName.toLowerCase() === b } }, CLASS: function (a) { var b = y[a + " "]; return b || (b = new RegExp("(^|" + L + ")" + a + "(" + L + "|$)")) && y(a, function (a) { return b.test("string" == typeof a.className && a.className || "undefined" != typeof a.getAttribute && a.getAttribute("class") || "") }) }, ATTR: function (a, b, c) { return function (d) { var e = fa.attr(d, a); return null == e ? "!=" === b : b ? (e += "", "=" === b ? e === c : "!=" === b ? e !== c : "^=" === b ? c && 0 === e.indexOf(c) : "*=" === b ? c && e.indexOf(c) > -1 : "$=" === b ? c && e.slice(-c.length) === c : "~=" === b ? (" " + e.replace(P, " ") + " ").indexOf(c) > -1 : "|=" === b ? e === c || e.slice(0, c.length + 1) === c + "-" : !1) : !0 } }, CHILD: function (a, b, c, d, e) { var f = "nth" !== a.slice(0, 3), g = "last" !== a.slice(-4), h = "of-type" === b; return 1 === d && 0 === e ? function (a) { return !!a.parentNode } : function (b, c, i) { var j, k, l, m, n, o, p = f !== g ? "nextSibling" : "previousSibling", q = b.parentNode, r = h && b.nodeName.toLowerCase(), s = !i && !h, t = !1; if (q) { if (f) { while (p) { m = b; while (m = m[p]) if (h ? m.nodeName.toLowerCase() === r : 1 === m.nodeType) return !1; o = p = "only" === a && !o && "nextSibling" } return !0 } if (o = [g ? q.firstChild : q.lastChild], g && s) { m = q, l = m[u] || (m[u] = {}), k = l[m.uniqueID] || (l[m.uniqueID] = {}), j = k[a] || [], n = j[0] === w && j[1], t = n && j[2], m = n && q.childNodes[n]; while (m = ++n && m && m[p] || (t = n = 0) || o.pop()) if (1 === m.nodeType && ++t && m === b) { k[a] = [w, n, t]; break } } else if (s && (m = b, l = m[u] || (m[u] = {}), k = l[m.uniqueID] || (l[m.uniqueID] = {}), j = k[a] || [], n = j[0] === w && j[1], t = n), t === !1) while (m = ++n && m && m[p] || (t = n = 0) || o.pop()) if ((h ? m.nodeName.toLowerCase() === r : 1 === m.nodeType) && ++t && (s && (l = m[u] || (m[u] = {}), k = l[m.uniqueID] || (l[m.uniqueID] = {}), k[a] = [w, t]), m === b)) break; return t -= e, t === d || t % d === 0 && t / d >= 0 } } }, PSEUDO: function (a, b) { var c, e = d.pseudos[a] || d.setFilters[a.toLowerCase()] || fa.error("unsupported pseudo: " + a); return e[u] ? e(b) : e.length > 1 ? (c = [a, a, "", b], d.setFilters.hasOwnProperty(a.toLowerCase()) ? ha(function (a, c) { var d, f = e(a, b), g = f.length; while (g--) d = J(a, f[g]), a[d] = !(c[d] = f[g]) }) : function (a) { return e(a, 0, c) }) : e } }, pseudos: { not: ha(function (a) { var b = [], c = [], d = h(a.replace(Q, "$1")); return d[u] ? ha(function (a, b, c, e) { var f, g = d(a, null, e, []), h = a.length; while (h--) (f = g[h]) && (a[h] = !(b[h] = f)) }) : function (a, e, f) { return b[0] = a, d(b, null, f, c), b[0] = null, !c.pop() } }), has: ha(function (a) { return function (b) { return fa(a, b).length > 0 } }), contains: ha(function (a) { return a = a.replace(ba, ca), function (b) { return (b.textContent || b.innerText || e(b)).indexOf(a) > -1 } }), lang: ha(function (a) { return V.test(a || "") || fa.error("unsupported lang: " + a), a = a.replace(ba, ca).toLowerCase(), function (b) { var c; do if (c = p ? b.lang : b.getAttribute("xml:lang") || b.getAttribute("lang")) return c = c.toLowerCase(), c === a || 0 === c.indexOf(a + "-"); while ((b = b.parentNode) && 1 === b.nodeType); return !1 } }), target: function (b) { var c = a.location && a.location.hash; return c && c.slice(1) === b.id }, root: function (a) { return a === o }, focus: function (a) { return a === n.activeElement && (!n.hasFocus || n.hasFocus()) && !!(a.type || a.href || ~a.tabIndex) }, enabled: function (a) { return a.disabled === !1 }, disabled: function (a) { return a.disabled === !0 }, checked: function (a) { var b = a.nodeName.toLowerCase(); return "input" === b && !!a.checked || "option" === b && !!a.selected }, selected: function (a) { return a.parentNode && a.parentNode.selectedIndex, a.selected === !0 }, empty: function (a) { for (a = a.firstChild; a; a = a.nextSibling) if (a.nodeType < 6) return !1; return !0 }, parent: function (a) { return !d.pseudos.empty(a) }, header: function (a) { return Y.test(a.nodeName) }, input: function (a) { return X.test(a.nodeName) }, button: function (a) { var b = a.nodeName.toLowerCase(); return "input" === b && "button" === a.type || "button" === b }, text: function (a) { var b; return "input" === a.nodeName.toLowerCase() && "text" === a.type && (null == (b = a.getAttribute("type")) || "text" === b.toLowerCase()) }, first: na(function () { return [0] }), last: na(function (a, b) { return [b - 1] }), eq: na(function (a, b, c) { return [0 > c ? c + b : c] }), even: na(function (a, b) { for (var c = 0; b > c; c += 2) a.push(c); return a }), odd: na(function (a, b) { for (var c = 1; b > c; c += 2) a.push(c); return a }), lt: na(function (a, b, c) { for (var d = 0 > c ? c + b : c; --d >= 0;) a.push(d); return a }), gt: na(function (a, b, c) { for (var d = 0 > c ? c + b : c; ++d < b;) a.push(d); return a }) } }, d.pseudos.nth = d.pseudos.eq; for (b in { radio: !0, checkbox: !0, file: !0, password: !0, image: !0 }) d.pseudos[b] = la(b); for (b in { submit: !0, reset: !0 }) d.pseudos[b] = ma(b); function pa() { } pa.prototype = d.filters = d.pseudos, d.setFilters = new pa, g = fa.tokenize = function (a, b) { var c, e, f, g, h, i, j, k = z[a + " "]; if (k) return b ? 0 : k.slice(0); h = a, i = [], j = d.preFilter; while (h) { (!c || (e = R.exec(h))) && (e && (h = h.slice(e[0].length) || h), i.push(f = [])), c = !1, (e = S.exec(h)) && (c = e.shift(), f.push({ value: c, type: e[0].replace(Q, " ") }), h = h.slice(c.length)); for (g in d.filter) !(e = W[g].exec(h)) || j[g] && !(e = j[g](e)) || (c = e.shift(), f.push({ value: c, type: g, matches: e }), h = h.slice(c.length)); if (!c) break } return b ? h.length : h ? fa.error(a) : z(a, i).slice(0) }; function qa(a) { for (var b = 0, c = a.length, d = ""; c > b; b++) d += a[b].value; return d } function ra(a, b, c) { var d = b.dir, e = c && "parentNode" === d, f = x++; return b.first ? function (b, c, f) { while (b = b[d]) if (1 === b.nodeType || e) return a(b, c, f) } : function (b, c, g) { var h, i, j, k = [w, f]; if (g) { while (b = b[d]) if ((1 === b.nodeType || e) && a(b, c, g)) return !0 } else while (b = b[d]) if (1 === b.nodeType || e) { if (j = b[u] || (b[u] = {}), i = j[b.uniqueID] || (j[b.uniqueID] = {}), (h = i[d]) && h[0] === w && h[1] === f) return k[2] = h[2]; if (i[d] = k, k[2] = a(b, c, g)) return !0 } } } function sa(a) { return a.length > 1 ? function (b, c, d) { var e = a.length; while (e--) if (!a[e](b, c, d)) return !1; return !0 } : a[0] } function ta(a, b, c) { for (var d = 0, e = b.length; e > d; d++) fa(a, b[d], c); return c } function ua(a, b, c, d, e) { for (var f, g = [], h = 0, i = a.length, j = null != b; i > h; h++) (f = a[h]) && (!c || c(f, d, e)) && (g.push(f), j && b.push(h)); return g } function va(a, b, c, d, e, f) { return d && !d[u] && (d = va(d)), e && !e[u] && (e = va(e, f)), ha(function (f, g, h, i) { var j, k, l, m = [], n = [], o = g.length, p = f || ta(b || "*", h.nodeType ? [h] : h, []), q = !a || !f && b ? p : ua(p, m, a, h, i), r = c ? e || (f ? a : o || d) ? [] : g : q; if (c && c(q, r, h, i), d) { j = ua(r, n), d(j, [], h, i), k = j.length; while (k--) (l = j[k]) && (r[n[k]] = !(q[n[k]] = l)) } if (f) { if (e || a) { if (e) { j = [], k = r.length; while (k--) (l = r[k]) && j.push(q[k] = l); e(null, r = [], j, i) } k = r.length; while (k--) (l = r[k]) && (j = e ? J(f, l) : m[k]) > -1 && (f[j] = !(g[j] = l)) } } else r = ua(r === g ? r.splice(o, r.length) : r), e ? e(null, g, r, i) : H.apply(g, r) }) } function wa(a) { for (var b, c, e, f = a.length, g = d.relative[a[0].type], h = g || d.relative[" "], i = g ? 1 : 0, k = ra(function (a) { return a === b }, h, !0), l = ra(function (a) { return J(b, a) > -1 }, h, !0), m = [function (a, c, d) { var e = !g && (d || c !== j) || ((b = c).nodeType ? k(a, c, d) : l(a, c, d)); return b = null, e }]; f > i; i++) if (c = d.relative[a[i].type]) m = [ra(sa(m), c)]; else { if (c = d.filter[a[i].type].apply(null, a[i].matches), c[u]) { for (e = ++i; f > e; e++) if (d.relative[a[e].type]) break; return va(i > 1 && sa(m), i > 1 && qa(a.slice(0, i - 1).concat({ value: " " === a[i - 2].type ? "*" : "" })).replace(Q, "$1"), c, e > i && wa(a.slice(i, e)), f > e && wa(a = a.slice(e)), f > e && qa(a)) } m.push(c) } return sa(m) } function xa(a, b) { var c = b.length > 0, e = a.length > 0, f = function (f, g, h, i, k) { var l, o, q, r = 0, s = "0", t = f && [], u = [], v = j, x = f || e && d.find.TAG("*", k), y = w += null == v ? 1 : Math.random() || .1, z = x.length; for (k && (j = g === n || g || k) ; s !== z && null != (l = x[s]) ; s++) { if (e && l) { o = 0, g || l.ownerDocument === n || (m(l), h = !p); while (q = a[o++]) if (q(l, g || n, h)) { i.push(l); break } k && (w = y) } c && ((l = !q && l) && r--, f && t.push(l)) } if (r += s, c && s !== r) { o = 0; while (q = b[o++]) q(t, u, g, h); if (f) { if (r > 0) while (s--) t[s] || u[s] || (u[s] = F.call(i)); u = ua(u) } H.apply(i, u), k && !f && u.length > 0 && r + b.length > 1 && fa.uniqueSort(i) } return k && (w = y, j = v), t }; return c ? ha(f) : f } return h = fa.compile = function (a, b) { var c, d = [], e = [], f = A[a + " "]; if (!f) { b || (b = g(a)), c = b.length; while (c--) f = wa(b[c]), f[u] ? d.push(f) : e.push(f); f = A(a, xa(e, d)), f.selector = a } return f }, i = fa.select = function (a, b, e, f) { var i, j, k, l, m, n = "function" == typeof a && a, o = !f && g(a = n.selector || a); if (e = e || [], 1 === o.length) { if (j = o[0] = o[0].slice(0), j.length > 2 && "ID" === (k = j[0]).type && c.getById && 9 === b.nodeType && p && d.relative[j[1].type]) { if (b = (d.find.ID(k.matches[0].replace(ba, ca), b) || [])[0], !b) return e; n && (b = b.parentNode), a = a.slice(j.shift().value.length) } i = W.needsContext.test(a) ? 0 : j.length; while (i--) { if (k = j[i], d.relative[l = k.type]) break; if ((m = d.find[l]) && (f = m(k.matches[0].replace(ba, ca), _.test(j[0].type) && oa(b.parentNode) || b))) { if (j.splice(i, 1), a = f.length && qa(j), !a) return H.apply(e, f), e; break } } } return (n || h(a, o))(f, b, !p, e, !b || _.test(a) && oa(b.parentNode) || b), e }, c.sortStable = u.split("").sort(B).join("") === u, c.detectDuplicates = !!l, m(), c.sortDetached = ia(function (a) { return 1 & a.compareDocumentPosition(n.createElement("div")) }), ia(function (a) { return a.innerHTML = "<a href='#'></a>", "#" === a.firstChild.getAttribute("href") }) || ja("type|href|height|width", function (a, b, c) { return c ? void 0 : a.getAttribute(b, "type" === b.toLowerCase() ? 1 : 2) }), c.attributes && ia(function (a) { return a.innerHTML = "<input/>", a.firstChild.setAttribute("value", ""), "" === a.firstChild.getAttribute("value") }) || ja("value", function (a, b, c) { return c || "input" !== a.nodeName.toLowerCase() ? void 0 : a.defaultValue }), ia(function (a) { return null == a.getAttribute("disabled") }) || ja(K, function (a, b, c) { var d; return c ? void 0 : a[b] === !0 ? b.toLowerCase() : (d = a.getAttributeNode(b)) && d.specified ? d.value : null }), fa }(a); n.find = t, n.expr = t.selectors, n.expr[":"] = n.expr.pseudos, n.uniqueSort = n.unique = t.uniqueSort, n.text = t.getText, n.isXMLDoc = t.isXML, n.contains = t.contains; var u = function (a, b, c) { var d = [], e = void 0 !== c; while ((a = a[b]) && 9 !== a.nodeType) if (1 === a.nodeType) { if (e && n(a).is(c)) break; d.push(a) } return d }, v = function (a, b) { for (var c = []; a; a = a.nextSibling) 1 === a.nodeType && a !== b && c.push(a); return c }, w = n.expr.match.needsContext, x = /^<([\w-]+)\s*\/?>(?:<\/\1>|)$/, y = /^.[^:#\[\.,]*$/; function z(a, b, c) { if (n.isFunction(b)) return n.grep(a, function (a, d) { return !!b.call(a, d, a) !== c }); if (b.nodeType) return n.grep(a, function (a) { return a === b !== c }); if ("string" == typeof b) { if (y.test(b)) return n.filter(b, a, c); b = n.filter(b, a) } return n.grep(a, function (a) { return h.call(b, a) > -1 !== c }) } n.filter = function (a, b, c) { var d = b[0]; return c && (a = ":not(" + a + ")"), 1 === b.length && 1 === d.nodeType ? n.find.matchesSelector(d, a) ? [d] : [] : n.find.matches(a, n.grep(b, function (a) { return 1 === a.nodeType })) }, n.fn.extend({ find: function (a) { var b, c = this.length, d = [], e = this; if ("string" != typeof a) return this.pushStack(n(a).filter(function () { for (b = 0; c > b; b++) if (n.contains(e[b], this)) return !0 })); for (b = 0; c > b; b++) n.find(a, e[b], d); return d = this.pushStack(c > 1 ? n.unique(d) : d), d.selector = this.selector ? this.selector + " " + a : a, d }, filter: function (a) { return this.pushStack(z(this, a || [], !1)) }, not: function (a) { return this.pushStack(z(this, a || [], !0)) }, is: function (a) { return !!z(this, "string" == typeof a && w.test(a) ? n(a) : a || [], !1).length } }); var A, B = /^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/, C = n.fn.init = function (a, b, c) { var e, f; if (!a) return this; if (c = c || A, "string" == typeof a) { if (e = "<" === a[0] && ">" === a[a.length - 1] && a.length >= 3 ? [null, a, null] : B.exec(a), !e || !e[1] && b) return !b || b.jquery ? (b || c).find(a) : this.constructor(b).find(a); if (e[1]) { if (b = b instanceof n ? b[0] : b, n.merge(this, n.parseHTML(e[1], b && b.nodeType ? b.ownerDocument || b : d, !0)), x.test(e[1]) && n.isPlainObject(b)) for (e in b) n.isFunction(this[e]) ? this[e](b[e]) : this.attr(e, b[e]); return this } return f = d.getElementById(e[2]), f && f.parentNode && (this.length = 1, this[0] = f), this.context = d, this.selector = a, this } return a.nodeType ? (this.context = this[0] = a, this.length = 1, this) : n.isFunction(a) ? void 0 !== c.ready ? c.ready(a) : a(n) : (void 0 !== a.selector && (this.selector = a.selector, this.context = a.context), n.makeArray(a, this)) }; C.prototype = n.fn, A = n(d); var D = /^(?:parents|prev(?:Until|All))/, E = { children: !0, contents: !0, next: !0, prev: !0 }; n.fn.extend({ has: function (a) { var b = n(a, this), c = b.length; return this.filter(function () { for (var a = 0; c > a; a++) if (n.contains(this, b[a])) return !0 }) }, closest: function (a, b) { for (var c, d = 0, e = this.length, f = [], g = w.test(a) || "string" != typeof a ? n(a, b || this.context) : 0; e > d; d++) for (c = this[d]; c && c !== b; c = c.parentNode) if (c.nodeType < 11 && (g ? g.index(c) > -1 : 1 === c.nodeType && n.find.matchesSelector(c, a))) { f.push(c); break } return this.pushStack(f.length > 1 ? n.uniqueSort(f) : f) }, index: function (a) { return a ? "string" == typeof a ? h.call(n(a), this[0]) : h.call(this, a.jquery ? a[0] : a) : this[0] && this[0].parentNode ? this.first().prevAll().length : -1 }, add: function (a, b) { return this.pushStack(n.uniqueSort(n.merge(this.get(), n(a, b)))) }, addBack: function (a) { return this.add(null == a ? this.prevObject : this.prevObject.filter(a)) } }); function F(a, b) { while ((a = a[b]) && 1 !== a.nodeType); return a } n.each({ parent: function (a) { var b = a.parentNode; return b && 11 !== b.nodeType ? b : null }, parents: function (a) { return u(a, "parentNode") }, parentsUntil: function (a, b, c) { return u(a, "parentNode", c) }, next: function (a) { return F(a, "nextSibling") }, prev: function (a) { return F(a, "previousSibling") }, nextAll: function (a) { return u(a, "nextSibling") }, prevAll: function (a) { return u(a, "previousSibling") }, nextUntil: function (a, b, c) { return u(a, "nextSibling", c) }, prevUntil: function (a, b, c) { return u(a, "previousSibling", c) }, siblings: function (a) { return v((a.parentNode || {}).firstChild, a) }, children: function (a) { return v(a.firstChild) }, contents: function (a) { return a.contentDocument || n.merge([], a.childNodes) } }, function (a, b) { n.fn[a] = function (c, d) { var e = n.map(this, b, c); return "Until" !== a.slice(-5) && (d = c), d && "string" == typeof d && (e = n.filter(d, e)), this.length > 1 && (E[a] || n.uniqueSort(e), D.test(a) && e.reverse()), this.pushStack(e) } }); var G = /\S+/g; function H(a) { var b = {}; return n.each(a.match(G) || [], function (a, c) { b[c] = !0 }), b } n.Callbacks = function (a) { a = "string" == typeof a ? H(a) : n.extend({}, a); var b, c, d, e, f = [], g = [], h = -1, i = function () { for (e = a.once, d = b = !0; g.length; h = -1) { c = g.shift(); while (++h < f.length) f[h].apply(c[0], c[1]) === !1 && a.stopOnFalse && (h = f.length, c = !1) } a.memory || (c = !1), b = !1, e && (f = c ? [] : "") }, j = { add: function () { return f && (c && !b && (h = f.length - 1, g.push(c)), function d(b) { n.each(b, function (b, c) { n.isFunction(c) ? a.unique && j.has(c) || f.push(c) : c && c.length && "string" !== n.type(c) && d(c) }) }(arguments), c && !b && i()), this }, remove: function () { return n.each(arguments, function (a, b) { var c; while ((c = n.inArray(b, f, c)) > -1) f.splice(c, 1), h >= c && h-- }), this }, has: function (a) { return a ? n.inArray(a, f) > -1 : f.length > 0 }, empty: function () { return f && (f = []), this }, disable: function () { return e = g = [], f = c = "", this }, disabled: function () { return !f }, lock: function () { return e = g = [], c || (f = c = ""), this }, locked: function () { return !!e }, fireWith: function (a, c) { return e || (c = c || [], c = [a, c.slice ? c.slice() : c], g.push(c), b || i()), this }, fire: function () { return j.fireWith(this, arguments), this }, fired: function () { return !!d } }; return j }, n.extend({ Deferred: function (a) { var b = [["resolve", "done", n.Callbacks("once memory"), "resolved"], ["reject", "fail", n.Callbacks("once memory"), "rejected"], ["notify", "progress", n.Callbacks("memory")]], c = "pending", d = { state: function () { return c }, always: function () { return e.done(arguments).fail(arguments), this }, then: function () { var a = arguments; return n.Deferred(function (c) { n.each(b, function (b, f) { var g = n.isFunction(a[b]) && a[b]; e[f[1]](function () { var a = g && g.apply(this, arguments); a && n.isFunction(a.promise) ? a.promise().progress(c.notify).done(c.resolve).fail(c.reject) : c[f[0] + "With"](this === d ? c.promise() : this, g ? [a] : arguments) }) }), a = null }).promise() }, promise: function (a) { return null != a ? n.extend(a, d) : d } }, e = {}; return d.pipe = d.then, n.each(b, function (a, f) { var g = f[2], h = f[3]; d[f[1]] = g.add, h && g.add(function () { c = h }, b[1 ^ a][2].disable, b[2][2].lock), e[f[0]] = function () { return e[f[0] + "With"](this === e ? d : this, arguments), this }, e[f[0] + "With"] = g.fireWith }), d.promise(e), a && a.call(e, e), e }, when: function (a) { var b = 0, c = e.call(arguments), d = c.length, f = 1 !== d || a && n.isFunction(a.promise) ? d : 0, g = 1 === f ? a : n.Deferred(), h = function (a, b, c) { return function (d) { b[a] = this, c[a] = arguments.length > 1 ? e.call(arguments) : d, c === i ? g.notifyWith(b, c) : --f || g.resolveWith(b, c) } }, i, j, k; if (d > 1) for (i = new Array(d), j = new Array(d), k = new Array(d) ; d > b; b++) c[b] && n.isFunction(c[b].promise) ? c[b].promise().progress(h(b, j, i)).done(h(b, k, c)).fail(g.reject) : --f; return f || g.resolveWith(k, c), g.promise() } }); var I; n.fn.ready = function (a) { return n.ready.promise().done(a), this }, n.extend({ isReady: !1, readyWait: 1, holdReady: function (a) { a ? n.readyWait++ : n.ready(!0) }, ready: function (a) { (a === !0 ? --n.readyWait : n.isReady) || (n.isReady = !0, a !== !0 && --n.readyWait > 0 || (I.resolveWith(d, [n]), n.fn.triggerHandler && (n(d).triggerHandler("ready"), n(d).off("ready")))) } }); function J() { d.removeEventListener("DOMContentLoaded", J), a.removeEventListener("load", J), n.ready() } n.ready.promise = function (b) { return I || (I = n.Deferred(), "complete" === d.readyState || "loading" !== d.readyState && !d.documentElement.doScroll ? a.setTimeout(n.ready) : (d.addEventListener("DOMContentLoaded", J), a.addEventListener("load", J))), I.promise(b) }, n.ready.promise(); var K = function (a, b, c, d, e, f, g) { var h = 0, i = a.length, j = null == c; if ("object" === n.type(c)) { e = !0; for (h in c) K(a, b, h, c[h], !0, f, g) } else if (void 0 !== d && (e = !0, n.isFunction(d) || (g = !0), j && (g ? (b.call(a, d), b = null) : (j = b, b = function (a, b, c) { return j.call(n(a), c) })), b)) for (; i > h; h++) b(a[h], c, g ? d : d.call(a[h], h, b(a[h], c))); return e ? a : j ? b.call(a) : i ? b(a[0], c) : f }, L = function (a) { return 1 === a.nodeType || 9 === a.nodeType || !+a.nodeType }; function M() { this.expando = n.expando + M.uid++ } M.uid = 1, M.prototype = { register: function (a, b) { var c = b || {}; return a.nodeType ? a[this.expando] = c : Object.defineProperty(a, this.expando, { value: c, writable: !0, configurable: !0 }), a[this.expando] }, cache: function (a) { if (!L(a)) return {}; var b = a[this.expando]; return b || (b = {}, L(a) && (a.nodeType ? a[this.expando] = b : Object.defineProperty(a, this.expando, { value: b, configurable: !0 }))), b }, set: function (a, b, c) { var d, e = this.cache(a); if ("string" == typeof b) e[b] = c; else for (d in b) e[d] = b[d]; return e }, get: function (a, b) { return void 0 === b ? this.cache(a) : a[this.expando] && a[this.expando][b] }, access: function (a, b, c) { var d; return void 0 === b || b && "string" == typeof b && void 0 === c ? (d = this.get(a, b), void 0 !== d ? d : this.get(a, n.camelCase(b))) : (this.set(a, b, c), void 0 !== c ? c : b) }, remove: function (a, b) { var c, d, e, f = a[this.expando]; if (void 0 !== f) { if (void 0 === b) this.register(a); else { n.isArray(b) ? d = b.concat(b.map(n.camelCase)) : (e = n.camelCase(b), b in f ? d = [b, e] : (d = e, d = d in f ? [d] : d.match(G) || [])), c = d.length; while (c--) delete f[d[c]] } (void 0 === b || n.isEmptyObject(f)) && (a.nodeType ? a[this.expando] = void 0 : delete a[this.expando]) } }, hasData: function (a) { var b = a[this.expando]; return void 0 !== b && !n.isEmptyObject(b) } }; var N = new M, O = new M, P = /^(?:\{[\w\W]*\}|\[[\w\W]*\])$/, Q = /[A-Z]/g; function R(a, b, c) {
        var d; if (void 0 === c && 1 === a.nodeType) if (d = "data-" + b.replace(Q, "-$&").toLowerCase(), c = a.getAttribute(d), "string" == typeof c) {
            try { c = "true" === c ? !0 : "false" === c ? !1 : "null" === c ? null : +c + "" === c ? +c : P.test(c) ? n.parseJSON(c) : c } catch (e) { } O.set(a, b, c);
        } else c = void 0; return c
    } n.extend({ hasData: function (a) { return O.hasData(a) || N.hasData(a) }, data: function (a, b, c) { return O.access(a, b, c) }, removeData: function (a, b) { O.remove(a, b) }, _data: function (a, b, c) { return N.access(a, b, c) }, _removeData: function (a, b) { N.remove(a, b) } }), n.fn.extend({ data: function (a, b) { var c, d, e, f = this[0], g = f && f.attributes; if (void 0 === a) { if (this.length && (e = O.get(f), 1 === f.nodeType && !N.get(f, "hasDataAttrs"))) { c = g.length; while (c--) g[c] && (d = g[c].name, 0 === d.indexOf("data-") && (d = n.camelCase(d.slice(5)), R(f, d, e[d]))); N.set(f, "hasDataAttrs", !0) } return e } return "object" == typeof a ? this.each(function () { O.set(this, a) }) : K(this, function (b) { var c, d; if (f && void 0 === b) { if (c = O.get(f, a) || O.get(f, a.replace(Q, "-$&").toLowerCase()), void 0 !== c) return c; if (d = n.camelCase(a), c = O.get(f, d), void 0 !== c) return c; if (c = R(f, d, void 0), void 0 !== c) return c } else d = n.camelCase(a), this.each(function () { var c = O.get(this, d); O.set(this, d, b), a.indexOf("-") > -1 && void 0 !== c && O.set(this, a, b) }) }, null, b, arguments.length > 1, null, !0) }, removeData: function (a) { return this.each(function () { O.remove(this, a) }) } }), n.extend({ queue: function (a, b, c) { var d; return a ? (b = (b || "fx") + "queue", d = N.get(a, b), c && (!d || n.isArray(c) ? d = N.access(a, b, n.makeArray(c)) : d.push(c)), d || []) : void 0 }, dequeue: function (a, b) { b = b || "fx"; var c = n.queue(a, b), d = c.length, e = c.shift(), f = n._queueHooks(a, b), g = function () { n.dequeue(a, b) }; "inprogress" === e && (e = c.shift(), d--), e && ("fx" === b && c.unshift("inprogress"), delete f.stop, e.call(a, g, f)), !d && f && f.empty.fire() }, _queueHooks: function (a, b) { var c = b + "queueHooks"; return N.get(a, c) || N.access(a, c, { empty: n.Callbacks("once memory").add(function () { N.remove(a, [b + "queue", c]) }) }) } }), n.fn.extend({ queue: function (a, b) { var c = 2; return "string" != typeof a && (b = a, a = "fx", c--), arguments.length < c ? n.queue(this[0], a) : void 0 === b ? this : this.each(function () { var c = n.queue(this, a, b); n._queueHooks(this, a), "fx" === a && "inprogress" !== c[0] && n.dequeue(this, a) }) }, dequeue: function (a) { return this.each(function () { n.dequeue(this, a) }) }, clearQueue: function (a) { return this.queue(a || "fx", []) }, promise: function (a, b) { var c, d = 1, e = n.Deferred(), f = this, g = this.length, h = function () { --d || e.resolveWith(f, [f]) }; "string" != typeof a && (b = a, a = void 0), a = a || "fx"; while (g--) c = N.get(f[g], a + "queueHooks"), c && c.empty && (d++, c.empty.add(h)); return h(), e.promise(b) } }); var S = /[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source, T = new RegExp("^(?:([+-])=|)(" + S + ")([a-z%]*)$", "i"), U = ["Top", "Right", "Bottom", "Left"], V = function (a, b) { return a = b || a, "none" === n.css(a, "display") || !n.contains(a.ownerDocument, a) }; function W(a, b, c, d) { var e, f = 1, g = 20, h = d ? function () { return d.cur() } : function () { return n.css(a, b, "") }, i = h(), j = c && c[3] || (n.cssNumber[b] ? "" : "px"), k = (n.cssNumber[b] || "px" !== j && +i) && T.exec(n.css(a, b)); if (k && k[3] !== j) { j = j || k[3], c = c || [], k = +i || 1; do f = f || ".5", k /= f, n.style(a, b, k + j); while (f !== (f = h() / i) && 1 !== f && --g) } return c && (k = +k || +i || 0, e = c[1] ? k + (c[1] + 1) * c[2] : +c[2], d && (d.unit = j, d.start = k, d.end = e)), e } var X = /^(?:checkbox|radio)$/i, Y = /<([\w:-]+)/, Z = /^$|\/(?:java|ecma)script/i, $ = { option: [1, "<select multiple='multiple'>", "</select>"], thead: [1, "<table>", "</table>"], col: [2, "<table><colgroup>", "</colgroup></table>"], tr: [2, "<table><tbody>", "</tbody></table>"], td: [3, "<table><tbody><tr>", "</tr></tbody></table>"], _default: [0, "", ""] }; $.optgroup = $.option, $.tbody = $.tfoot = $.colgroup = $.caption = $.thead, $.th = $.td; function _(a, b) { var c = "undefined" != typeof a.getElementsByTagName ? a.getElementsByTagName(b || "*") : "undefined" != typeof a.querySelectorAll ? a.querySelectorAll(b || "*") : []; return void 0 === b || b && n.nodeName(a, b) ? n.merge([a], c) : c } function aa(a, b) { for (var c = 0, d = a.length; d > c; c++) N.set(a[c], "globalEval", !b || N.get(b[c], "globalEval")) } var ba = /<|&#?\w+;/; function ca(a, b, c, d, e) { for (var f, g, h, i, j, k, l = b.createDocumentFragment(), m = [], o = 0, p = a.length; p > o; o++) if (f = a[o], f || 0 === f) if ("object" === n.type(f)) n.merge(m, f.nodeType ? [f] : f); else if (ba.test(f)) { g = g || l.appendChild(b.createElement("div")), h = (Y.exec(f) || ["", ""])[1].toLowerCase(), i = $[h] || $._default, g.innerHTML = i[1] + n.htmlPrefilter(f) + i[2], k = i[0]; while (k--) g = g.lastChild; n.merge(m, g.childNodes), g = l.firstChild, g.textContent = "" } else m.push(b.createTextNode(f)); l.textContent = "", o = 0; while (f = m[o++]) if (d && n.inArray(f, d) > -1) e && e.push(f); else if (j = n.contains(f.ownerDocument, f), g = _(l.appendChild(f), "script"), j && aa(g), c) { k = 0; while (f = g[k++]) Z.test(f.type || "") && c.push(f) } return l } !function () { var a = d.createDocumentFragment(), b = a.appendChild(d.createElement("div")), c = d.createElement("input"); c.setAttribute("type", "radio"), c.setAttribute("checked", "checked"), c.setAttribute("name", "t"), b.appendChild(c), l.checkClone = b.cloneNode(!0).cloneNode(!0).lastChild.checked, b.innerHTML = "<textarea>x</textarea>", l.noCloneChecked = !!b.cloneNode(!0).lastChild.defaultValue }(); var da = /^key/, ea = /^(?:mouse|pointer|contextmenu|drag|drop)|click/, fa = /^([^.]*)(?:\.(.+)|)/; function ga() { return !0 } function ha() { return !1 } function ia() { try { return d.activeElement } catch (a) { } } function ja(a, b, c, d, e, f) { var g, h; if ("object" == typeof b) { "string" != typeof c && (d = d || c, c = void 0); for (h in b) ja(a, h, c, d, b[h], f); return a } if (null == d && null == e ? (e = c, d = c = void 0) : null == e && ("string" == typeof c ? (e = d, d = void 0) : (e = d, d = c, c = void 0)), e === !1) e = ha; else if (!e) return this; return 1 === f && (g = e, e = function (a) { return n().off(a), g.apply(this, arguments) }, e.guid = g.guid || (g.guid = n.guid++)), a.each(function () { n.event.add(this, b, e, d, c) }) } n.event = { global: {}, add: function (a, b, c, d, e) { var f, g, h, i, j, k, l, m, o, p, q, r = N.get(a); if (r) { c.handler && (f = c, c = f.handler, e = f.selector), c.guid || (c.guid = n.guid++), (i = r.events) || (i = r.events = {}), (g = r.handle) || (g = r.handle = function (b) { return "undefined" != typeof n && n.event.triggered !== b.type ? n.event.dispatch.apply(a, arguments) : void 0 }), b = (b || "").match(G) || [""], j = b.length; while (j--) h = fa.exec(b[j]) || [], o = q = h[1], p = (h[2] || "").split(".").sort(), o && (l = n.event.special[o] || {}, o = (e ? l.delegateType : l.bindType) || o, l = n.event.special[o] || {}, k = n.extend({ type: o, origType: q, data: d, handler: c, guid: c.guid, selector: e, needsContext: e && n.expr.match.needsContext.test(e), namespace: p.join(".") }, f), (m = i[o]) || (m = i[o] = [], m.delegateCount = 0, l.setup && l.setup.call(a, d, p, g) !== !1 || a.addEventListener && a.addEventListener(o, g)), l.add && (l.add.call(a, k), k.handler.guid || (k.handler.guid = c.guid)), e ? m.splice(m.delegateCount++, 0, k) : m.push(k), n.event.global[o] = !0) } }, remove: function (a, b, c, d, e) { var f, g, h, i, j, k, l, m, o, p, q, r = N.hasData(a) && N.get(a); if (r && (i = r.events)) { b = (b || "").match(G) || [""], j = b.length; while (j--) if (h = fa.exec(b[j]) || [], o = q = h[1], p = (h[2] || "").split(".").sort(), o) { l = n.event.special[o] || {}, o = (d ? l.delegateType : l.bindType) || o, m = i[o] || [], h = h[2] && new RegExp("(^|\\.)" + p.join("\\.(?:.*\\.|)") + "(\\.|$)"), g = f = m.length; while (f--) k = m[f], !e && q !== k.origType || c && c.guid !== k.guid || h && !h.test(k.namespace) || d && d !== k.selector && ("**" !== d || !k.selector) || (m.splice(f, 1), k.selector && m.delegateCount--, l.remove && l.remove.call(a, k)); g && !m.length && (l.teardown && l.teardown.call(a, p, r.handle) !== !1 || n.removeEvent(a, o, r.handle), delete i[o]) } else for (o in i) n.event.remove(a, o + b[j], c, d, !0); n.isEmptyObject(i) && N.remove(a, "handle events") } }, dispatch: function (a) { a = n.event.fix(a); var b, c, d, f, g, h = [], i = e.call(arguments), j = (N.get(this, "events") || {})[a.type] || [], k = n.event.special[a.type] || {}; if (i[0] = a, a.delegateTarget = this, !k.preDispatch || k.preDispatch.call(this, a) !== !1) { h = n.event.handlers.call(this, a, j), b = 0; while ((f = h[b++]) && !a.isPropagationStopped()) { a.currentTarget = f.elem, c = 0; while ((g = f.handlers[c++]) && !a.isImmediatePropagationStopped()) (!a.rnamespace || a.rnamespace.test(g.namespace)) && (a.handleObj = g, a.data = g.data, d = ((n.event.special[g.origType] || {}).handle || g.handler).apply(f.elem, i), void 0 !== d && (a.result = d) === !1 && (a.preventDefault(), a.stopPropagation())) } return k.postDispatch && k.postDispatch.call(this, a), a.result } }, handlers: function (a, b) { var c, d, e, f, g = [], h = b.delegateCount, i = a.target; if (h && i.nodeType && ("click" !== a.type || isNaN(a.button) || a.button < 1)) for (; i !== this; i = i.parentNode || this) if (1 === i.nodeType && (i.disabled !== !0 || "click" !== a.type)) { for (d = [], c = 0; h > c; c++) f = b[c], e = f.selector + " ", void 0 === d[e] && (d[e] = f.needsContext ? n(e, this).index(i) > -1 : n.find(e, this, null, [i]).length), d[e] && d.push(f); d.length && g.push({ elem: i, handlers: d }) } return h < b.length && g.push({ elem: this, handlers: b.slice(h) }), g }, props: "altKey bubbles cancelable ctrlKey currentTarget detail eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "), fixHooks: {}, keyHooks: { props: "char charCode key keyCode".split(" "), filter: function (a, b) { return null == a.which && (a.which = null != b.charCode ? b.charCode : b.keyCode), a } }, mouseHooks: { props: "button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "), filter: function (a, b) { var c, e, f, g = b.button; return null == a.pageX && null != b.clientX && (c = a.target.ownerDocument || d, e = c.documentElement, f = c.body, a.pageX = b.clientX + (e && e.scrollLeft || f && f.scrollLeft || 0) - (e && e.clientLeft || f && f.clientLeft || 0), a.pageY = b.clientY + (e && e.scrollTop || f && f.scrollTop || 0) - (e && e.clientTop || f && f.clientTop || 0)), a.which || void 0 === g || (a.which = 1 & g ? 1 : 2 & g ? 3 : 4 & g ? 2 : 0), a } }, fix: function (a) { if (a[n.expando]) return a; var b, c, e, f = a.type, g = a, h = this.fixHooks[f]; h || (this.fixHooks[f] = h = ea.test(f) ? this.mouseHooks : da.test(f) ? this.keyHooks : {}), e = h.props ? this.props.concat(h.props) : this.props, a = new n.Event(g), b = e.length; while (b--) c = e[b], a[c] = g[c]; return a.target || (a.target = d), 3 === a.target.nodeType && (a.target = a.target.parentNode), h.filter ? h.filter(a, g) : a }, special: { load: { noBubble: !0 }, focus: { trigger: function () { return this !== ia() && this.focus ? (this.focus(), !1) : void 0 }, delegateType: "focusin" }, blur: { trigger: function () { return this === ia() && this.blur ? (this.blur(), !1) : void 0 }, delegateType: "focusout" }, click: { trigger: function () { return "checkbox" === this.type && this.click && n.nodeName(this, "input") ? (this.click(), !1) : void 0 }, _default: function (a) { return n.nodeName(a.target, "a") } }, beforeunload: { postDispatch: function (a) { void 0 !== a.result && a.originalEvent && (a.originalEvent.returnValue = a.result) } } } }, n.removeEvent = function (a, b, c) { a.removeEventListener && a.removeEventListener(b, c) }, n.Event = function (a, b) { return this instanceof n.Event ? (a && a.type ? (this.originalEvent = a, this.type = a.type, this.isDefaultPrevented = a.defaultPrevented || void 0 === a.defaultPrevented && a.returnValue === !1 ? ga : ha) : this.type = a, b && n.extend(this, b), this.timeStamp = a && a.timeStamp || n.now(), void (this[n.expando] = !0)) : new n.Event(a, b) }, n.Event.prototype = { constructor: n.Event, isDefaultPrevented: ha, isPropagationStopped: ha, isImmediatePropagationStopped: ha, preventDefault: function () { var a = this.originalEvent; this.isDefaultPrevented = ga, a && a.preventDefault() }, stopPropagation: function () { var a = this.originalEvent; this.isPropagationStopped = ga, a && a.stopPropagation() }, stopImmediatePropagation: function () { var a = this.originalEvent; this.isImmediatePropagationStopped = ga, a && a.stopImmediatePropagation(), this.stopPropagation() } }, n.each({ mouseenter: "mouseover", mouseleave: "mouseout", pointerenter: "pointerover", pointerleave: "pointerout" }, function (a, b) { n.event.special[a] = { delegateType: b, bindType: b, handle: function (a) { var c, d = this, e = a.relatedTarget, f = a.handleObj; return (!e || e !== d && !n.contains(d, e)) && (a.type = f.origType, c = f.handler.apply(this, arguments), a.type = b), c } } }), n.fn.extend({ on: function (a, b, c, d) { return ja(this, a, b, c, d) }, one: function (a, b, c, d) { return ja(this, a, b, c, d, 1) }, off: function (a, b, c) { var d, e; if (a && a.preventDefault && a.handleObj) return d = a.handleObj, n(a.delegateTarget).off(d.namespace ? d.origType + "." + d.namespace : d.origType, d.selector, d.handler), this; if ("object" == typeof a) { for (e in a) this.off(e, b, a[e]); return this } return (b === !1 || "function" == typeof b) && (c = b, b = void 0), c === !1 && (c = ha), this.each(function () { n.event.remove(this, a, c, b) }) } }); var ka = /<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:-]+)[^>]*)\/>/gi, la = /<script|<style|<link/i, ma = /checked\s*(?:[^=]|=\s*.checked.)/i, na = /^true\/(.*)/, oa = /^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g; function pa(a, b) { return n.nodeName(a, "table") && n.nodeName(11 !== b.nodeType ? b : b.firstChild, "tr") ? a.getElementsByTagName("tbody")[0] || a : a } function qa(a) { return a.type = (null !== a.getAttribute("type")) + "/" + a.type, a } function ra(a) { var b = na.exec(a.type); return b ? a.type = b[1] : a.removeAttribute("type"), a } function sa(a, b) { var c, d, e, f, g, h, i, j; if (1 === b.nodeType) { if (N.hasData(a) && (f = N.access(a), g = N.set(b, f), j = f.events)) { delete g.handle, g.events = {}; for (e in j) for (c = 0, d = j[e].length; d > c; c++) n.event.add(b, e, j[e][c]) } O.hasData(a) && (h = O.access(a), i = n.extend({}, h), O.set(b, i)) } } function ta(a, b) { var c = b.nodeName.toLowerCase(); "input" === c && X.test(a.type) ? b.checked = a.checked : ("input" === c || "textarea" === c) && (b.defaultValue = a.defaultValue) } function ua(a, b, c, d) { b = f.apply([], b); var e, g, h, i, j, k, m = 0, o = a.length, p = o - 1, q = b[0], r = n.isFunction(q); if (r || o > 1 && "string" == typeof q && !l.checkClone && ma.test(q)) return a.each(function (e) { var f = a.eq(e); r && (b[0] = q.call(this, e, f.html())), ua(f, b, c, d) }); if (o && (e = ca(b, a[0].ownerDocument, !1, a, d), g = e.firstChild, 1 === e.childNodes.length && (e = g), g || d)) { for (h = n.map(_(e, "script"), qa), i = h.length; o > m; m++) j = e, m !== p && (j = n.clone(j, !0, !0), i && n.merge(h, _(j, "script"))), c.call(a[m], j, m); if (i) for (k = h[h.length - 1].ownerDocument, n.map(h, ra), m = 0; i > m; m++) j = h[m], Z.test(j.type || "") && !N.access(j, "globalEval") && n.contains(k, j) && (j.src ? n._evalUrl && n._evalUrl(j.src) : n.globalEval(j.textContent.replace(oa, ""))) } return a } function va(a, b, c) { for (var d, e = b ? n.filter(b, a) : a, f = 0; null != (d = e[f]) ; f++) c || 1 !== d.nodeType || n.cleanData(_(d)), d.parentNode && (c && n.contains(d.ownerDocument, d) && aa(_(d, "script")), d.parentNode.removeChild(d)); return a } n.extend({ htmlPrefilter: function (a) { return a.replace(ka, "<$1></$2>") }, clone: function (a, b, c) { var d, e, f, g, h = a.cloneNode(!0), i = n.contains(a.ownerDocument, a); if (!(l.noCloneChecked || 1 !== a.nodeType && 11 !== a.nodeType || n.isXMLDoc(a))) for (g = _(h), f = _(a), d = 0, e = f.length; e > d; d++) ta(f[d], g[d]); if (b) if (c) for (f = f || _(a), g = g || _(h), d = 0, e = f.length; e > d; d++) sa(f[d], g[d]); else sa(a, h); return g = _(h, "script"), g.length > 0 && aa(g, !i && _(a, "script")), h }, cleanData: function (a) { for (var b, c, d, e = n.event.special, f = 0; void 0 !== (c = a[f]) ; f++) if (L(c)) { if (b = c[N.expando]) { if (b.events) for (d in b.events) e[d] ? n.event.remove(c, d) : n.removeEvent(c, d, b.handle); c[N.expando] = void 0 } c[O.expando] && (c[O.expando] = void 0) } } }), n.fn.extend({ domManip: ua, detach: function (a) { return va(this, a, !0) }, remove: function (a) { return va(this, a) }, text: function (a) { return K(this, function (a) { return void 0 === a ? n.text(this) : this.empty().each(function () { (1 === this.nodeType || 11 === this.nodeType || 9 === this.nodeType) && (this.textContent = a) }) }, null, a, arguments.length) }, append: function () { return ua(this, arguments, function (a) { if (1 === this.nodeType || 11 === this.nodeType || 9 === this.nodeType) { var b = pa(this, a); b.appendChild(a) } }) }, prepend: function () { return ua(this, arguments, function (a) { if (1 === this.nodeType || 11 === this.nodeType || 9 === this.nodeType) { var b = pa(this, a); b.insertBefore(a, b.firstChild) } }) }, before: function () { return ua(this, arguments, function (a) { this.parentNode && this.parentNode.insertBefore(a, this) }) }, after: function () { return ua(this, arguments, function (a) { this.parentNode && this.parentNode.insertBefore(a, this.nextSibling) }) }, empty: function () { for (var a, b = 0; null != (a = this[b]) ; b++) 1 === a.nodeType && (n.cleanData(_(a, !1)), a.textContent = ""); return this }, clone: function (a, b) { return a = null == a ? !1 : a, b = null == b ? a : b, this.map(function () { return n.clone(this, a, b) }) }, html: function (a) { return K(this, function (a) { var b = this[0] || {}, c = 0, d = this.length; if (void 0 === a && 1 === b.nodeType) return b.innerHTML; if ("string" == typeof a && !la.test(a) && !$[(Y.exec(a) || ["", ""])[1].toLowerCase()]) { a = n.htmlPrefilter(a); try { for (; d > c; c++) b = this[c] || {}, 1 === b.nodeType && (n.cleanData(_(b, !1)), b.innerHTML = a); b = 0 } catch (e) { } } b && this.empty().append(a) }, null, a, arguments.length) }, replaceWith: function () { var a = []; return ua(this, arguments, function (b) { var c = this.parentNode; n.inArray(this, a) < 0 && (n.cleanData(_(this)), c && c.replaceChild(b, this)) }, a) } }), n.each({ appendTo: "append", prependTo: "prepend", insertBefore: "before", insertAfter: "after", replaceAll: "replaceWith" }, function (a, b) { n.fn[a] = function (a) { for (var c, d = [], e = n(a), f = e.length - 1, h = 0; f >= h; h++) c = h === f ? this : this.clone(!0), n(e[h])[b](c), g.apply(d, c.get()); return this.pushStack(d) } }); var wa, xa = { HTML: "block", BODY: "block" }; function ya(a, b) { var c = n(b.createElement(a)).appendTo(b.body), d = n.css(c[0], "display"); return c.detach(), d } function za(a) { var b = d, c = xa[a]; return c || (c = ya(a, b), "none" !== c && c || (wa = (wa || n("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement), b = wa[0].contentDocument, b.write(), b.close(), c = ya(a, b), wa.detach()), xa[a] = c), c } var Aa = /^margin/, Ba = new RegExp("^(" + S + ")(?!px)[a-z%]+$", "i"), Ca = function (b) { var c = b.ownerDocument.defaultView; return c.opener || (c = a), c.getComputedStyle(b) }, Da = function (a, b, c, d) { var e, f, g = {}; for (f in b) g[f] = a.style[f], a.style[f] = b[f]; e = c.apply(a, d || []); for (f in b) a.style[f] = g[f]; return e }, Ea = d.documentElement; !function () { var b, c, e, f, g = d.createElement("div"), h = d.createElement("div"); if (h.style) { h.style.backgroundClip = "content-box", h.cloneNode(!0).style.backgroundClip = "", l.clearCloneStyle = "content-box" === h.style.backgroundClip, g.style.cssText = "border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute", g.appendChild(h); function i() { h.style.cssText = "-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%", h.innerHTML = "", Ea.appendChild(g); var d = a.getComputedStyle(h); b = "1%" !== d.top, f = "2px" === d.marginLeft, c = "4px" === d.width, h.style.marginRight = "50%", e = "4px" === d.marginRight, Ea.removeChild(g) } n.extend(l, { pixelPosition: function () { return i(), b }, boxSizingReliable: function () { return null == c && i(), c }, pixelMarginRight: function () { return null == c && i(), e }, reliableMarginLeft: function () { return null == c && i(), f }, reliableMarginRight: function () { var b, c = h.appendChild(d.createElement("div")); return c.style.cssText = h.style.cssText = "-webkit-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0", c.style.marginRight = c.style.width = "0", h.style.width = "1px", Ea.appendChild(g), b = !parseFloat(a.getComputedStyle(c).marginRight), Ea.removeChild(g), h.removeChild(c), b } }) } }(); function Fa(a, b, c) { var d, e, f, g, h = a.style; return c = c || Ca(a), c && (g = c.getPropertyValue(b) || c[b], "" !== g || n.contains(a.ownerDocument, a) || (g = n.style(a, b)), !l.pixelMarginRight() && Ba.test(g) && Aa.test(b) && (d = h.width, e = h.minWidth, f = h.maxWidth, h.minWidth = h.maxWidth = h.width = g, g = c.width, h.width = d, h.minWidth = e, h.maxWidth = f)), void 0 !== g ? g + "" : g } function Ga(a, b) { return { get: function () { return a() ? void delete this.get : (this.get = b).apply(this, arguments) } } } var Ha = /^(none|table(?!-c[ea]).+)/, Ia = { position: "absolute", visibility: "hidden", display: "block" }, Ja = { letterSpacing: "0", fontWeight: "400" }, Ka = ["Webkit", "O", "Moz", "ms"], La = d.createElement("div").style; function Ma(a) { if (a in La) return a; var b = a[0].toUpperCase() + a.slice(1), c = Ka.length; while (c--) if (a = Ka[c] + b, a in La) return a } function Na(a, b, c) { var d = T.exec(b); return d ? Math.max(0, d[2] - (c || 0)) + (d[3] || "px") : b } function Oa(a, b, c, d, e) { for (var f = c === (d ? "border" : "content") ? 4 : "width" === b ? 1 : 0, g = 0; 4 > f; f += 2) "margin" === c && (g += n.css(a, c + U[f], !0, e)), d ? ("content" === c && (g -= n.css(a, "padding" + U[f], !0, e)), "margin" !== c && (g -= n.css(a, "border" + U[f] + "Width", !0, e))) : (g += n.css(a, "padding" + U[f], !0, e), "padding" !== c && (g += n.css(a, "border" + U[f] + "Width", !0, e))); return g } function Pa(b, c, e) { var f = !0, g = "width" === c ? b.offsetWidth : b.offsetHeight, h = Ca(b), i = "border-box" === n.css(b, "boxSizing", !1, h); if (d.msFullscreenElement && a.top !== a && b.getClientRects().length && (g = Math.round(100 * b.getBoundingClientRect()[c])), 0 >= g || null == g) { if (g = Fa(b, c, h), (0 > g || null == g) && (g = b.style[c]), Ba.test(g)) return g; f = i && (l.boxSizingReliable() || g === b.style[c]), g = parseFloat(g) || 0 } return g + Oa(b, c, e || (i ? "border" : "content"), f, h) + "px" } function Qa(a, b) { for (var c, d, e, f = [], g = 0, h = a.length; h > g; g++) d = a[g], d.style && (f[g] = N.get(d, "olddisplay"), c = d.style.display, b ? (f[g] || "none" !== c || (d.style.display = ""), "" === d.style.display && V(d) && (f[g] = N.access(d, "olddisplay", za(d.nodeName)))) : (e = V(d), "none" === c && e || N.set(d, "olddisplay", e ? c : n.css(d, "display")))); for (g = 0; h > g; g++) d = a[g], d.style && (b && "none" !== d.style.display && "" !== d.style.display || (d.style.display = b ? f[g] || "" : "none")); return a } n.extend({ cssHooks: { opacity: { get: function (a, b) { if (b) { var c = Fa(a, "opacity"); return "" === c ? "1" : c } } } }, cssNumber: { animationIterationCount: !0, columnCount: !0, fillOpacity: !0, flexGrow: !0, flexShrink: !0, fontWeight: !0, lineHeight: !0, opacity: !0, order: !0, orphans: !0, widows: !0, zIndex: !0, zoom: !0 }, cssProps: { "float": "cssFloat" }, style: function (a, b, c, d) { if (a && 3 !== a.nodeType && 8 !== a.nodeType && a.style) { var e, f, g, h = n.camelCase(b), i = a.style; return b = n.cssProps[h] || (n.cssProps[h] = Ma(h) || h), g = n.cssHooks[b] || n.cssHooks[h], void 0 === c ? g && "get" in g && void 0 !== (e = g.get(a, !1, d)) ? e : i[b] : (f = typeof c, "string" === f && (e = T.exec(c)) && e[1] && (c = W(a, b, e), f = "number"), null != c && c === c && ("number" === f && (c += e && e[3] || (n.cssNumber[h] ? "" : "px")), l.clearCloneStyle || "" !== c || 0 !== b.indexOf("background") || (i[b] = "inherit"), g && "set" in g && void 0 === (c = g.set(a, c, d)) || (i[b] = c)), void 0) } }, css: function (a, b, c, d) { var e, f, g, h = n.camelCase(b); return b = n.cssProps[h] || (n.cssProps[h] = Ma(h) || h), g = n.cssHooks[b] || n.cssHooks[h], g && "get" in g && (e = g.get(a, !0, c)), void 0 === e && (e = Fa(a, b, d)), "normal" === e && b in Ja && (e = Ja[b]), "" === c || c ? (f = parseFloat(e), c === !0 || isFinite(f) ? f || 0 : e) : e } }), n.each(["height", "width"], function (a, b) { n.cssHooks[b] = { get: function (a, c, d) { return c ? Ha.test(n.css(a, "display")) && 0 === a.offsetWidth ? Da(a, Ia, function () { return Pa(a, b, d) }) : Pa(a, b, d) : void 0 }, set: function (a, c, d) { var e, f = d && Ca(a), g = d && Oa(a, b, d, "border-box" === n.css(a, "boxSizing", !1, f), f); return g && (e = T.exec(c)) && "px" !== (e[3] || "px") && (a.style[b] = c, c = n.css(a, b)), Na(a, c, g) } } }), n.cssHooks.marginLeft = Ga(l.reliableMarginLeft, function (a, b) { return b ? (parseFloat(Fa(a, "marginLeft")) || a.getBoundingClientRect().left - Da(a, { marginLeft: 0 }, function () { return a.getBoundingClientRect().left })) + "px" : void 0 }), n.cssHooks.marginRight = Ga(l.reliableMarginRight, function (a, b) { return b ? Da(a, { display: "inline-block" }, Fa, [a, "marginRight"]) : void 0 }), n.each({ margin: "", padding: "", border: "Width" }, function (a, b) { n.cssHooks[a + b] = { expand: function (c) { for (var d = 0, e = {}, f = "string" == typeof c ? c.split(" ") : [c]; 4 > d; d++) e[a + U[d] + b] = f[d] || f[d - 2] || f[0]; return e } }, Aa.test(a) || (n.cssHooks[a + b].set = Na) }), n.fn.extend({ css: function (a, b) { return K(this, function (a, b, c) { var d, e, f = {}, g = 0; if (n.isArray(b)) { for (d = Ca(a), e = b.length; e > g; g++) f[b[g]] = n.css(a, b[g], !1, d); return f } return void 0 !== c ? n.style(a, b, c) : n.css(a, b) }, a, b, arguments.length > 1) }, show: function () { return Qa(this, !0) }, hide: function () { return Qa(this) }, toggle: function (a) { return "boolean" == typeof a ? a ? this.show() : this.hide() : this.each(function () { V(this) ? n(this).show() : n(this).hide() }) } }); function Ra(a, b, c, d, e) { return new Ra.prototype.init(a, b, c, d, e) } n.Tween = Ra, Ra.prototype = { constructor: Ra, init: function (a, b, c, d, e, f) { this.elem = a, this.prop = c, this.easing = e || n.easing._default, this.options = b, this.start = this.now = this.cur(), this.end = d, this.unit = f || (n.cssNumber[c] ? "" : "px") }, cur: function () { var a = Ra.propHooks[this.prop]; return a && a.get ? a.get(this) : Ra.propHooks._default.get(this) }, run: function (a) { var b, c = Ra.propHooks[this.prop]; return this.options.duration ? this.pos = b = n.easing[this.easing](a, this.options.duration * a, 0, 1, this.options.duration) : this.pos = b = a, this.now = (this.end - this.start) * b + this.start, this.options.step && this.options.step.call(this.elem, this.now, this), c && c.set ? c.set(this) : Ra.propHooks._default.set(this), this } }, Ra.prototype.init.prototype = Ra.prototype, Ra.propHooks = { _default: { get: function (a) { var b; return 1 !== a.elem.nodeType || null != a.elem[a.prop] && null == a.elem.style[a.prop] ? a.elem[a.prop] : (b = n.css(a.elem, a.prop, ""), b && "auto" !== b ? b : 0) }, set: function (a) { n.fx.step[a.prop] ? n.fx.step[a.prop](a) : 1 !== a.elem.nodeType || null == a.elem.style[n.cssProps[a.prop]] && !n.cssHooks[a.prop] ? a.elem[a.prop] = a.now : n.style(a.elem, a.prop, a.now + a.unit) } } }, Ra.propHooks.scrollTop = Ra.propHooks.scrollLeft = { set: function (a) { a.elem.nodeType && a.elem.parentNode && (a.elem[a.prop] = a.now) } }, n.easing = { linear: function (a) { return a }, swing: function (a) { return .5 - Math.cos(a * Math.PI) / 2 }, _default: "swing" }, n.fx = Ra.prototype.init, n.fx.step = {}; var Sa, Ta, Ua = /^(?:toggle|show|hide)$/, Va = /queueHooks$/; function Wa() { return a.setTimeout(function () { Sa = void 0 }), Sa = n.now() } function Xa(a, b) { var c, d = 0, e = { height: a }; for (b = b ? 1 : 0; 4 > d; d += 2 - b) c = U[d], e["margin" + c] = e["padding" + c] = a; return b && (e.opacity = e.width = a), e } function Ya(a, b, c) { for (var d, e = (_a.tweeners[b] || []).concat(_a.tweeners["*"]), f = 0, g = e.length; g > f; f++) if (d = e[f].call(c, b, a)) return d } function Za(a, b, c) { var d, e, f, g, h, i, j, k, l = this, m = {}, o = a.style, p = a.nodeType && V(a), q = N.get(a, "fxshow"); c.queue || (h = n._queueHooks(a, "fx"), null == h.unqueued && (h.unqueued = 0, i = h.empty.fire, h.empty.fire = function () { h.unqueued || i() }), h.unqueued++, l.always(function () { l.always(function () { h.unqueued--, n.queue(a, "fx").length || h.empty.fire() }) })), 1 === a.nodeType && ("height" in b || "width" in b) && (c.overflow = [o.overflow, o.overflowX, o.overflowY], j = n.css(a, "display"), k = "none" === j ? N.get(a, "olddisplay") || za(a.nodeName) : j, "inline" === k && "none" === n.css(a, "float") && (o.display = "inline-block")), c.overflow && (o.overflow = "hidden", l.always(function () { o.overflow = c.overflow[0], o.overflowX = c.overflow[1], o.overflowY = c.overflow[2] })); for (d in b) if (e = b[d], Ua.exec(e)) { if (delete b[d], f = f || "toggle" === e, e === (p ? "hide" : "show")) { if ("show" !== e || !q || void 0 === q[d]) continue; p = !0 } m[d] = q && q[d] || n.style(a, d) } else j = void 0; if (n.isEmptyObject(m)) "inline" === ("none" === j ? za(a.nodeName) : j) && (o.display = j); else { q ? "hidden" in q && (p = q.hidden) : q = N.access(a, "fxshow", {}), f && (q.hidden = !p), p ? n(a).show() : l.done(function () { n(a).hide() }), l.done(function () { var b; N.remove(a, "fxshow"); for (b in m) n.style(a, b, m[b]) }); for (d in m) g = Ya(p ? q[d] : 0, d, l), d in q || (q[d] = g.start, p && (g.end = g.start, g.start = "width" === d || "height" === d ? 1 : 0)) } } function $a(a, b) { var c, d, e, f, g; for (c in a) if (d = n.camelCase(c), e = b[d], f = a[c], n.isArray(f) && (e = f[1], f = a[c] = f[0]), c !== d && (a[d] = f, delete a[c]), g = n.cssHooks[d], g && "expand" in g) { f = g.expand(f), delete a[d]; for (c in f) c in a || (a[c] = f[c], b[c] = e) } else b[d] = e } function _a(a, b, c) { var d, e, f = 0, g = _a.prefilters.length, h = n.Deferred().always(function () { delete i.elem }), i = function () { if (e) return !1; for (var b = Sa || Wa(), c = Math.max(0, j.startTime + j.duration - b), d = c / j.duration || 0, f = 1 - d, g = 0, i = j.tweens.length; i > g; g++) j.tweens[g].run(f); return h.notifyWith(a, [j, f, c]), 1 > f && i ? c : (h.resolveWith(a, [j]), !1) }, j = h.promise({ elem: a, props: n.extend({}, b), opts: n.extend(!0, { specialEasing: {}, easing: n.easing._default }, c), originalProperties: b, originalOptions: c, startTime: Sa || Wa(), duration: c.duration, tweens: [], createTween: function (b, c) { var d = n.Tween(a, j.opts, b, c, j.opts.specialEasing[b] || j.opts.easing); return j.tweens.push(d), d }, stop: function (b) { var c = 0, d = b ? j.tweens.length : 0; if (e) return this; for (e = !0; d > c; c++) j.tweens[c].run(1); return b ? (h.notifyWith(a, [j, 1, 0]), h.resolveWith(a, [j, b])) : h.rejectWith(a, [j, b]), this } }), k = j.props; for ($a(k, j.opts.specialEasing) ; g > f; f++) if (d = _a.prefilters[f].call(j, a, k, j.opts)) return n.isFunction(d.stop) && (n._queueHooks(j.elem, j.opts.queue).stop = n.proxy(d.stop, d)), d; return n.map(k, Ya, j), n.isFunction(j.opts.start) && j.opts.start.call(a, j), n.fx.timer(n.extend(i, { elem: a, anim: j, queue: j.opts.queue })), j.progress(j.opts.progress).done(j.opts.done, j.opts.complete).fail(j.opts.fail).always(j.opts.always) } n.Animation = n.extend(_a, { tweeners: { "*": [function (a, b) { var c = this.createTween(a, b); return W(c.elem, a, T.exec(b), c), c }] }, tweener: function (a, b) { n.isFunction(a) ? (b = a, a = ["*"]) : a = a.match(G); for (var c, d = 0, e = a.length; e > d; d++) c = a[d], _a.tweeners[c] = _a.tweeners[c] || [], _a.tweeners[c].unshift(b) }, prefilters: [Za], prefilter: function (a, b) { b ? _a.prefilters.unshift(a) : _a.prefilters.push(a) } }), n.speed = function (a, b, c) { var d = a && "object" == typeof a ? n.extend({}, a) : { complete: c || !c && b || n.isFunction(a) && a, duration: a, easing: c && b || b && !n.isFunction(b) && b }; return d.duration = n.fx.off ? 0 : "number" == typeof d.duration ? d.duration : d.duration in n.fx.speeds ? n.fx.speeds[d.duration] : n.fx.speeds._default, (null == d.queue || d.queue === !0) && (d.queue = "fx"), d.old = d.complete, d.complete = function () { n.isFunction(d.old) && d.old.call(this), d.queue && n.dequeue(this, d.queue) }, d }, n.fn.extend({ fadeTo: function (a, b, c, d) { return this.filter(V).css("opacity", 0).show().end().animate({ opacity: b }, a, c, d) }, animate: function (a, b, c, d) { var e = n.isEmptyObject(a), f = n.speed(b, c, d), g = function () { var b = _a(this, n.extend({}, a), f); (e || N.get(this, "finish")) && b.stop(!0) }; return g.finish = g, e || f.queue === !1 ? this.each(g) : this.queue(f.queue, g) }, stop: function (a, b, c) { var d = function (a) { var b = a.stop; delete a.stop, b(c) }; return "string" != typeof a && (c = b, b = a, a = void 0), b && a !== !1 && this.queue(a || "fx", []), this.each(function () { var b = !0, e = null != a && a + "queueHooks", f = n.timers, g = N.get(this); if (e) g[e] && g[e].stop && d(g[e]); else for (e in g) g[e] && g[e].stop && Va.test(e) && d(g[e]); for (e = f.length; e--;) f[e].elem !== this || null != a && f[e].queue !== a || (f[e].anim.stop(c), b = !1, f.splice(e, 1)); (b || !c) && n.dequeue(this, a) }) }, finish: function (a) { return a !== !1 && (a = a || "fx"), this.each(function () { var b, c = N.get(this), d = c[a + "queue"], e = c[a + "queueHooks"], f = n.timers, g = d ? d.length : 0; for (c.finish = !0, n.queue(this, a, []), e && e.stop && e.stop.call(this, !0), b = f.length; b--;) f[b].elem === this && f[b].queue === a && (f[b].anim.stop(!0), f.splice(b, 1)); for (b = 0; g > b; b++) d[b] && d[b].finish && d[b].finish.call(this); delete c.finish }) } }), n.each(["toggle", "show", "hide"], function (a, b) { var c = n.fn[b]; n.fn[b] = function (a, d, e) { return null == a || "boolean" == typeof a ? c.apply(this, arguments) : this.animate(Xa(b, !0), a, d, e) } }), n.each({ slideDown: Xa("show"), slideUp: Xa("hide"), slideToggle: Xa("toggle"), fadeIn: { opacity: "show" }, fadeOut: { opacity: "hide" }, fadeToggle: { opacity: "toggle" } }, function (a, b) { n.fn[a] = function (a, c, d) { return this.animate(b, a, c, d) } }), n.timers = [], n.fx.tick = function () { var a, b = 0, c = n.timers; for (Sa = n.now() ; b < c.length; b++) a = c[b], a() || c[b] !== a || c.splice(b--, 1); c.length || n.fx.stop(), Sa = void 0 }, n.fx.timer = function (a) { n.timers.push(a), a() ? n.fx.start() : n.timers.pop() }, n.fx.interval = 13, n.fx.start = function () { Ta || (Ta = a.setInterval(n.fx.tick, n.fx.interval)) }, n.fx.stop = function () { a.clearInterval(Ta), Ta = null }, n.fx.speeds = { slow: 600, fast: 200, _default: 400 }, n.fn.delay = function (b, c) { return b = n.fx ? n.fx.speeds[b] || b : b, c = c || "fx", this.queue(c, function (c, d) { var e = a.setTimeout(c, b); d.stop = function () { a.clearTimeout(e) } }) }, function () { var a = d.createElement("input"), b = d.createElement("select"), c = b.appendChild(d.createElement("option")); a.type = "checkbox", l.checkOn = "" !== a.value, l.optSelected = c.selected, b.disabled = !0, l.optDisabled = !c.disabled, a = d.createElement("input"), a.value = "t", a.type = "radio", l.radioValue = "t" === a.value }(); var ab, bb = n.expr.attrHandle; n.fn.extend({ attr: function (a, b) { return K(this, n.attr, a, b, arguments.length > 1) }, removeAttr: function (a) { return this.each(function () { n.removeAttr(this, a) }) } }), n.extend({ attr: function (a, b, c) { var d, e, f = a.nodeType; if (3 !== f && 8 !== f && 2 !== f) return "undefined" == typeof a.getAttribute ? n.prop(a, b, c) : (1 === f && n.isXMLDoc(a) || (b = b.toLowerCase(), e = n.attrHooks[b] || (n.expr.match.bool.test(b) ? ab : void 0)), void 0 !== c ? null === c ? void n.removeAttr(a, b) : e && "set" in e && void 0 !== (d = e.set(a, c, b)) ? d : (a.setAttribute(b, c + ""), c) : e && "get" in e && null !== (d = e.get(a, b)) ? d : (d = n.find.attr(a, b), null == d ? void 0 : d)) }, attrHooks: { type: { set: function (a, b) { if (!l.radioValue && "radio" === b && n.nodeName(a, "input")) { var c = a.value; return a.setAttribute("type", b), c && (a.value = c), b } } } }, removeAttr: function (a, b) { var c, d, e = 0, f = b && b.match(G); if (f && 1 === a.nodeType) while (c = f[e++]) d = n.propFix[c] || c, n.expr.match.bool.test(c) && (a[d] = !1), a.removeAttribute(c) } }), ab = { set: function (a, b, c) { return b === !1 ? n.removeAttr(a, c) : a.setAttribute(c, c), c } }, n.each(n.expr.match.bool.source.match(/\w+/g), function (a, b) { var c = bb[b] || n.find.attr; bb[b] = function (a, b, d) { var e, f; return d || (f = bb[b], bb[b] = e, e = null != c(a, b, d) ? b.toLowerCase() : null, bb[b] = f), e } }); var cb = /^(?:input|select|textarea|button)$/i, db = /^(?:a|area)$/i; n.fn.extend({ prop: function (a, b) { return K(this, n.prop, a, b, arguments.length > 1) }, removeProp: function (a) { return this.each(function () { delete this[n.propFix[a] || a] }) } }), n.extend({
        prop: function (a, b, c) {
            var d, e, f = a.nodeType; if (3 !== f && 8 !== f && 2 !== f) return 1 === f && n.isXMLDoc(a) || (b = n.propFix[b] || b, e = n.propHooks[b]), void 0 !== c ? e && "set" in e && void 0 !== (d = e.set(a, c, b)) ? d : a[b] = c : e && "get" in e && null !== (d = e.get(a, b)) ? d : a[b];
        }, propHooks: { tabIndex: { get: function (a) { var b = n.find.attr(a, "tabindex"); return b ? parseInt(b, 10) : cb.test(a.nodeName) || db.test(a.nodeName) && a.href ? 0 : -1 } } }, propFix: { "for": "htmlFor", "class": "className" }
    }), l.optSelected || (n.propHooks.selected = { get: function (a) { var b = a.parentNode; return b && b.parentNode && b.parentNode.selectedIndex, null } }), n.each(["tabIndex", "readOnly", "maxLength", "cellSpacing", "cellPadding", "rowSpan", "colSpan", "useMap", "frameBorder", "contentEditable"], function () { n.propFix[this.toLowerCase()] = this }); var eb = /[\t\r\n\f]/g; function fb(a) { return a.getAttribute && a.getAttribute("class") || "" } n.fn.extend({ addClass: function (a) { var b, c, d, e, f, g, h, i = 0; if (n.isFunction(a)) return this.each(function (b) { n(this).addClass(a.call(this, b, fb(this))) }); if ("string" == typeof a && a) { b = a.match(G) || []; while (c = this[i++]) if (e = fb(c), d = 1 === c.nodeType && (" " + e + " ").replace(eb, " ")) { g = 0; while (f = b[g++]) d.indexOf(" " + f + " ") < 0 && (d += f + " "); h = n.trim(d), e !== h && c.setAttribute("class", h) } } return this }, removeClass: function (a) { var b, c, d, e, f, g, h, i = 0; if (n.isFunction(a)) return this.each(function (b) { n(this).removeClass(a.call(this, b, fb(this))) }); if (!arguments.length) return this.attr("class", ""); if ("string" == typeof a && a) { b = a.match(G) || []; while (c = this[i++]) if (e = fb(c), d = 1 === c.nodeType && (" " + e + " ").replace(eb, " ")) { g = 0; while (f = b[g++]) while (d.indexOf(" " + f + " ") > -1) d = d.replace(" " + f + " ", " "); h = n.trim(d), e !== h && c.setAttribute("class", h) } } return this }, toggleClass: function (a, b) { var c = typeof a; return "boolean" == typeof b && "string" === c ? b ? this.addClass(a) : this.removeClass(a) : n.isFunction(a) ? this.each(function (c) { n(this).toggleClass(a.call(this, c, fb(this), b), b) }) : this.each(function () { var b, d, e, f; if ("string" === c) { d = 0, e = n(this), f = a.match(G) || []; while (b = f[d++]) e.hasClass(b) ? e.removeClass(b) : e.addClass(b) } else (void 0 === a || "boolean" === c) && (b = fb(this), b && N.set(this, "__className__", b), this.setAttribute && this.setAttribute("class", b || a === !1 ? "" : N.get(this, "__className__") || "")) }) }, hasClass: function (a) { var b, c, d = 0; b = " " + a + " "; while (c = this[d++]) if (1 === c.nodeType && (" " + fb(c) + " ").replace(eb, " ").indexOf(b) > -1) return !0; return !1 } }); var gb = /\r/g; n.fn.extend({ val: function (a) { var b, c, d, e = this[0]; { if (arguments.length) return d = n.isFunction(a), this.each(function (c) { var e; 1 === this.nodeType && (e = d ? a.call(this, c, n(this).val()) : a, null == e ? e = "" : "number" == typeof e ? e += "" : n.isArray(e) && (e = n.map(e, function (a) { return null == a ? "" : a + "" })), b = n.valHooks[this.type] || n.valHooks[this.nodeName.toLowerCase()], b && "set" in b && void 0 !== b.set(this, e, "value") || (this.value = e)) }); if (e) return b = n.valHooks[e.type] || n.valHooks[e.nodeName.toLowerCase()], b && "get" in b && void 0 !== (c = b.get(e, "value")) ? c : (c = e.value, "string" == typeof c ? c.replace(gb, "") : null == c ? "" : c) } } }), n.extend({ valHooks: { option: { get: function (a) { return n.trim(a.value) } }, select: { get: function (a) { for (var b, c, d = a.options, e = a.selectedIndex, f = "select-one" === a.type || 0 > e, g = f ? null : [], h = f ? e + 1 : d.length, i = 0 > e ? h : f ? e : 0; h > i; i++) if (c = d[i], (c.selected || i === e) && (l.optDisabled ? !c.disabled : null === c.getAttribute("disabled")) && (!c.parentNode.disabled || !n.nodeName(c.parentNode, "optgroup"))) { if (b = n(c).val(), f) return b; g.push(b) } return g }, set: function (a, b) { var c, d, e = a.options, f = n.makeArray(b), g = e.length; while (g--) d = e[g], (d.selected = n.inArray(n.valHooks.option.get(d), f) > -1) && (c = !0); return c || (a.selectedIndex = -1), f } } } }), n.each(["radio", "checkbox"], function () { n.valHooks[this] = { set: function (a, b) { return n.isArray(b) ? a.checked = n.inArray(n(a).val(), b) > -1 : void 0 } }, l.checkOn || (n.valHooks[this].get = function (a) { return null === a.getAttribute("value") ? "on" : a.value }) }); var hb = /^(?:focusinfocus|focusoutblur)$/; n.extend(n.event, { trigger: function (b, c, e, f) { var g, h, i, j, l, m, o, p = [e || d], q = k.call(b, "type") ? b.type : b, r = k.call(b, "namespace") ? b.namespace.split(".") : []; if (h = i = e = e || d, 3 !== e.nodeType && 8 !== e.nodeType && !hb.test(q + n.event.triggered) && (q.indexOf(".") > -1 && (r = q.split("."), q = r.shift(), r.sort()), l = q.indexOf(":") < 0 && "on" + q, b = b[n.expando] ? b : new n.Event(q, "object" == typeof b && b), b.isTrigger = f ? 2 : 3, b.namespace = r.join("."), b.rnamespace = b.namespace ? new RegExp("(^|\\.)" + r.join("\\.(?:.*\\.|)") + "(\\.|$)") : null, b.result = void 0, b.target || (b.target = e), c = null == c ? [b] : n.makeArray(c, [b]), o = n.event.special[q] || {}, f || !o.trigger || o.trigger.apply(e, c) !== !1)) { if (!f && !o.noBubble && !n.isWindow(e)) { for (j = o.delegateType || q, hb.test(j + q) || (h = h.parentNode) ; h; h = h.parentNode) p.push(h), i = h; i === (e.ownerDocument || d) && p.push(i.defaultView || i.parentWindow || a) } g = 0; while ((h = p[g++]) && !b.isPropagationStopped()) b.type = g > 1 ? j : o.bindType || q, m = (N.get(h, "events") || {})[b.type] && N.get(h, "handle"), m && m.apply(h, c), m = l && h[l], m && m.apply && L(h) && (b.result = m.apply(h, c), b.result === !1 && b.preventDefault()); return b.type = q, f || b.isDefaultPrevented() || o._default && o._default.apply(p.pop(), c) !== !1 || !L(e) || l && n.isFunction(e[q]) && !n.isWindow(e) && (i = e[l], i && (e[l] = null), n.event.triggered = q, e[q](), n.event.triggered = void 0, i && (e[l] = i)), b.result } }, simulate: function (a, b, c) { var d = n.extend(new n.Event, c, { type: a, isSimulated: !0 }); n.event.trigger(d, null, b), d.isDefaultPrevented() && c.preventDefault() } }), n.fn.extend({ trigger: function (a, b) { return this.each(function () { n.event.trigger(a, b, this) }) }, triggerHandler: function (a, b) { var c = this[0]; return c ? n.event.trigger(a, b, c, !0) : void 0 } }), n.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "), function (a, b) { n.fn[b] = function (a, c) { return arguments.length > 0 ? this.on(b, null, a, c) : this.trigger(b) } }), n.fn.extend({ hover: function (a, b) { return this.mouseenter(a).mouseleave(b || a) } }), l.focusin = "onfocusin" in a, l.focusin || n.each({ focus: "focusin", blur: "focusout" }, function (a, b) { var c = function (a) { n.event.simulate(b, a.target, n.event.fix(a)) }; n.event.special[b] = { setup: function () { var d = this.ownerDocument || this, e = N.access(d, b); e || d.addEventListener(a, c, !0), N.access(d, b, (e || 0) + 1) }, teardown: function () { var d = this.ownerDocument || this, e = N.access(d, b) - 1; e ? N.access(d, b, e) : (d.removeEventListener(a, c, !0), N.remove(d, b)) } } }); var ib = a.location, jb = n.now(), kb = /\?/; n.parseJSON = function (a) { return JSON.parse(a + "") }, n.parseXML = function (b) { var c; if (!b || "string" != typeof b) return null; try { c = (new a.DOMParser).parseFromString(b, "text/xml") } catch (d) { c = void 0 } return (!c || c.getElementsByTagName("parsererror").length) && n.error("Invalid XML: " + b), c }; var lb = /#.*$/, mb = /([?&])_=[^&]*/, nb = /^(.*?):[ \t]*([^\r\n]*)$/gm, ob = /^(?:about|app|app-storage|.+-extension|file|res|widget):$/, pb = /^(?:GET|HEAD)$/, qb = /^\/\//, rb = {}, sb = {}, tb = "*/".concat("*"), ub = d.createElement("a"); ub.href = ib.href; function vb(a) { return function (b, c) { "string" != typeof b && (c = b, b = "*"); var d, e = 0, f = b.toLowerCase().match(G) || []; if (n.isFunction(c)) while (d = f[e++]) "+" === d[0] ? (d = d.slice(1) || "*", (a[d] = a[d] || []).unshift(c)) : (a[d] = a[d] || []).push(c) } } function wb(a, b, c, d) { var e = {}, f = a === sb; function g(h) { var i; return e[h] = !0, n.each(a[h] || [], function (a, h) { var j = h(b, c, d); return "string" != typeof j || f || e[j] ? f ? !(i = j) : void 0 : (b.dataTypes.unshift(j), g(j), !1) }), i } return g(b.dataTypes[0]) || !e["*"] && g("*") } function xb(a, b) { var c, d, e = n.ajaxSettings.flatOptions || {}; for (c in b) void 0 !== b[c] && ((e[c] ? a : d || (d = {}))[c] = b[c]); return d && n.extend(!0, a, d), a } function yb(a, b, c) { var d, e, f, g, h = a.contents, i = a.dataTypes; while ("*" === i[0]) i.shift(), void 0 === d && (d = a.mimeType || b.getResponseHeader("Content-Type")); if (d) for (e in h) if (h[e] && h[e].test(d)) { i.unshift(e); break } if (i[0] in c) f = i[0]; else { for (e in c) { if (!i[0] || a.converters[e + " " + i[0]]) { f = e; break } g || (g = e) } f = f || g } return f ? (f !== i[0] && i.unshift(f), c[f]) : void 0 } function zb(a, b, c, d) { var e, f, g, h, i, j = {}, k = a.dataTypes.slice(); if (k[1]) for (g in a.converters) j[g.toLowerCase()] = a.converters[g]; f = k.shift(); while (f) if (a.responseFields[f] && (c[a.responseFields[f]] = b), !i && d && a.dataFilter && (b = a.dataFilter(b, a.dataType)), i = f, f = k.shift()) if ("*" === f) f = i; else if ("*" !== i && i !== f) { if (g = j[i + " " + f] || j["* " + f], !g) for (e in j) if (h = e.split(" "), h[1] === f && (g = j[i + " " + h[0]] || j["* " + h[0]])) { g === !0 ? g = j[e] : j[e] !== !0 && (f = h[0], k.unshift(h[1])); break } if (g !== !0) if (g && a["throws"]) b = g(b); else try { b = g(b) } catch (l) { return { state: "parsererror", error: g ? l : "No conversion from " + i + " to " + f } } } return { state: "success", data: b } } n.extend({ active: 0, lastModified: {}, etag: {}, ajaxSettings: { url: ib.href, type: "GET", isLocal: ob.test(ib.protocol), global: !0, processData: !0, async: !0, contentType: "application/x-www-form-urlencoded; charset=UTF-8", accepts: { "*": tb, text: "text/plain", html: "text/html", xml: "application/xml, text/xml", json: "application/json, text/javascript" }, contents: { xml: /\bxml\b/, html: /\bhtml/, json: /\bjson\b/ }, responseFields: { xml: "responseXML", text: "responseText", json: "responseJSON" }, converters: { "* text": String, "text html": !0, "text json": n.parseJSON, "text xml": n.parseXML }, flatOptions: { url: !0, context: !0 } }, ajaxSetup: function (a, b) { return b ? xb(xb(a, n.ajaxSettings), b) : xb(n.ajaxSettings, a) }, ajaxPrefilter: vb(rb), ajaxTransport: vb(sb), ajax: function (b, c) { "object" == typeof b && (c = b, b = void 0), c = c || {}; var e, f, g, h, i, j, k, l, m = n.ajaxSetup({}, c), o = m.context || m, p = m.context && (o.nodeType || o.jquery) ? n(o) : n.event, q = n.Deferred(), r = n.Callbacks("once memory"), s = m.statusCode || {}, t = {}, u = {}, v = 0, w = "canceled", x = { readyState: 0, getResponseHeader: function (a) { var b; if (2 === v) { if (!h) { h = {}; while (b = nb.exec(g)) h[b[1].toLowerCase()] = b[2] } b = h[a.toLowerCase()] } return null == b ? null : b }, getAllResponseHeaders: function () { return 2 === v ? g : null }, setRequestHeader: function (a, b) { var c = a.toLowerCase(); return v || (a = u[c] = u[c] || a, t[a] = b), this }, overrideMimeType: function (a) { return v || (m.mimeType = a), this }, statusCode: function (a) { var b; if (a) if (2 > v) for (b in a) s[b] = [s[b], a[b]]; else x.always(a[x.status]); return this }, abort: function (a) { var b = a || w; return e && e.abort(b), z(0, b), this } }; if (q.promise(x).complete = r.add, x.success = x.done, x.error = x.fail, m.url = ((b || m.url || ib.href) + "").replace(lb, "").replace(qb, ib.protocol + "//"), m.type = c.method || c.type || m.method || m.type, m.dataTypes = n.trim(m.dataType || "*").toLowerCase().match(G) || [""], null == m.crossDomain) { j = d.createElement("a"); try { j.href = m.url, j.href = j.href, m.crossDomain = ub.protocol + "//" + ub.host != j.protocol + "//" + j.host } catch (y) { m.crossDomain = !0 } } if (m.data && m.processData && "string" != typeof m.data && (m.data = n.param(m.data, m.traditional)), wb(rb, m, c, x), 2 === v) return x; k = n.event && m.global, k && 0 === n.active++ && n.event.trigger("ajaxStart"), m.type = m.type.toUpperCase(), m.hasContent = !pb.test(m.type), f = m.url, m.hasContent || (m.data && (f = m.url += (kb.test(f) ? "&" : "?") + m.data, delete m.data), m.cache === !1 && (m.url = mb.test(f) ? f.replace(mb, "$1_=" + jb++) : f + (kb.test(f) ? "&" : "?") + "_=" + jb++)), m.ifModified && (n.lastModified[f] && x.setRequestHeader("If-Modified-Since", n.lastModified[f]), n.etag[f] && x.setRequestHeader("If-None-Match", n.etag[f])), (m.data && m.hasContent && m.contentType !== !1 || c.contentType) && x.setRequestHeader("Content-Type", m.contentType), x.setRequestHeader("Accept", m.dataTypes[0] && m.accepts[m.dataTypes[0]] ? m.accepts[m.dataTypes[0]] + ("*" !== m.dataTypes[0] ? ", " + tb + "; q=0.01" : "") : m.accepts["*"]); for (l in m.headers) x.setRequestHeader(l, m.headers[l]); if (m.beforeSend && (m.beforeSend.call(o, x, m) === !1 || 2 === v)) return x.abort(); w = "abort"; for (l in { success: 1, error: 1, complete: 1 }) x[l](m[l]); if (e = wb(sb, m, c, x)) { if (x.readyState = 1, k && p.trigger("ajaxSend", [x, m]), 2 === v) return x; m.async && m.timeout > 0 && (i = a.setTimeout(function () { x.abort("timeout") }, m.timeout)); try { v = 1, e.send(t, z) } catch (y) { if (!(2 > v)) throw y; z(-1, y) } } else z(-1, "No Transport"); function z(b, c, d, h) { var j, l, t, u, w, y = c; 2 !== v && (v = 2, i && a.clearTimeout(i), e = void 0, g = h || "", x.readyState = b > 0 ? 4 : 0, j = b >= 200 && 300 > b || 304 === b, d && (u = yb(m, x, d)), u = zb(m, u, x, j), j ? (m.ifModified && (w = x.getResponseHeader("Last-Modified"), w && (n.lastModified[f] = w), w = x.getResponseHeader("etag"), w && (n.etag[f] = w)), 204 === b || "HEAD" === m.type ? y = "nocontent" : 304 === b ? y = "notmodified" : (y = u.state, l = u.data, t = u.error, j = !t)) : (t = y, (b || !y) && (y = "error", 0 > b && (b = 0))), x.status = b, x.statusText = (c || y) + "", j ? q.resolveWith(o, [l, y, x]) : q.rejectWith(o, [x, y, t]), x.statusCode(s), s = void 0, k && p.trigger(j ? "ajaxSuccess" : "ajaxError", [x, m, j ? l : t]), r.fireWith(o, [x, y]), k && (p.trigger("ajaxComplete", [x, m]), --n.active || n.event.trigger("ajaxStop"))) } return x }, getJSON: function (a, b, c) { return n.get(a, b, c, "json") }, getScript: function (a, b) { return n.get(a, void 0, b, "script") } }), n.each(["get", "post"], function (a, b) { n[b] = function (a, c, d, e) { return n.isFunction(c) && (e = e || d, d = c, c = void 0), n.ajax(n.extend({ url: a, type: b, dataType: e, data: c, success: d }, n.isPlainObject(a) && a)) } }), n._evalUrl = function (a) { return n.ajax({ url: a, type: "GET", dataType: "script", async: !1, global: !1, "throws": !0 }) }, n.fn.extend({ wrapAll: function (a) { var b; return n.isFunction(a) ? this.each(function (b) { n(this).wrapAll(a.call(this, b)) }) : (this[0] && (b = n(a, this[0].ownerDocument).eq(0).clone(!0), this[0].parentNode && b.insertBefore(this[0]), b.map(function () { var a = this; while (a.firstElementChild) a = a.firstElementChild; return a }).append(this)), this) }, wrapInner: function (a) { return n.isFunction(a) ? this.each(function (b) { n(this).wrapInner(a.call(this, b)) }) : this.each(function () { var b = n(this), c = b.contents(); c.length ? c.wrapAll(a) : b.append(a) }) }, wrap: function (a) { var b = n.isFunction(a); return this.each(function (c) { n(this).wrapAll(b ? a.call(this, c) : a) }) }, unwrap: function () { return this.parent().each(function () { n.nodeName(this, "body") || n(this).replaceWith(this.childNodes) }).end() } }), n.expr.filters.hidden = function (a) { return !n.expr.filters.visible(a) }, n.expr.filters.visible = function (a) { return a.offsetWidth > 0 || a.offsetHeight > 0 || a.getClientRects().length > 0 }; var Ab = /%20/g, Bb = /\[\]$/, Cb = /\r?\n/g, Db = /^(?:submit|button|image|reset|file)$/i, Eb = /^(?:input|select|textarea|keygen)/i; function Fb(a, b, c, d) { var e; if (n.isArray(b)) n.each(b, function (b, e) { c || Bb.test(a) ? d(a, e) : Fb(a + "[" + ("object" == typeof e && null != e ? b : "") + "]", e, c, d) }); else if (c || "object" !== n.type(b)) d(a, b); else for (e in b) Fb(a + "[" + e + "]", b[e], c, d) } n.param = function (a, b) { var c, d = [], e = function (a, b) { b = n.isFunction(b) ? b() : null == b ? "" : b, d[d.length] = encodeURIComponent(a) + "=" + encodeURIComponent(b) }; if (void 0 === b && (b = n.ajaxSettings && n.ajaxSettings.traditional), n.isArray(a) || a.jquery && !n.isPlainObject(a)) n.each(a, function () { e(this.name, this.value) }); else for (c in a) Fb(c, a[c], b, e); return d.join("&").replace(Ab, "+") }, n.fn.extend({ serialize: function () { return n.param(this.serializeArray()) }, serializeArray: function () { return this.map(function () { var a = n.prop(this, "elements"); return a ? n.makeArray(a) : this }).filter(function () { var a = this.type; return this.name && !n(this).is(":disabled") && Eb.test(this.nodeName) && !Db.test(a) && (this.checked || !X.test(a)) }).map(function (a, b) { var c = n(this).val(); return null == c ? null : n.isArray(c) ? n.map(c, function (a) { return { name: b.name, value: a.replace(Cb, "\r\n") } }) : { name: b.name, value: c.replace(Cb, "\r\n") } }).get() } }), n.ajaxSettings.xhr = function () { try { return new a.XMLHttpRequest } catch (b) { } }; var Gb = { 0: 200, 1223: 204 }, Hb = n.ajaxSettings.xhr(); l.cors = !!Hb && "withCredentials" in Hb, l.ajax = Hb = !!Hb, n.ajaxTransport(function (b) { var c, d; return l.cors || Hb && !b.crossDomain ? { send: function (e, f) { var g, h = b.xhr(); if (h.open(b.type, b.url, b.async, b.username, b.password), b.xhrFields) for (g in b.xhrFields) h[g] = b.xhrFields[g]; b.mimeType && h.overrideMimeType && h.overrideMimeType(b.mimeType), b.crossDomain || e["X-Requested-With"] || (e["X-Requested-With"] = "XMLHttpRequest"); for (g in e) h.setRequestHeader(g, e[g]); c = function (a) { return function () { c && (c = d = h.onload = h.onerror = h.onabort = h.onreadystatechange = null, "abort" === a ? h.abort() : "error" === a ? "number" != typeof h.status ? f(0, "error") : f(h.status, h.statusText) : f(Gb[h.status] || h.status, h.statusText, "text" !== (h.responseType || "text") || "string" != typeof h.responseText ? { binary: h.response } : { text: h.responseText }, h.getAllResponseHeaders())) } }, h.onload = c(), d = h.onerror = c("error"), void 0 !== h.onabort ? h.onabort = d : h.onreadystatechange = function () { 4 === h.readyState && a.setTimeout(function () { c && d() }) }, c = c("abort"); try { h.send(b.hasContent && b.data || null) } catch (i) { if (c) throw i } }, abort: function () { c && c() } } : void 0 }), n.ajaxSetup({ accepts: { script: "text/javascript, application/javascript, application/ecmascript, application/x-ecmascript" }, contents: { script: /\b(?:java|ecma)script\b/ }, converters: { "text script": function (a) { return n.globalEval(a), a } } }), n.ajaxPrefilter("script", function (a) { void 0 === a.cache && (a.cache = !1), a.crossDomain && (a.type = "GET") }), n.ajaxTransport("script", function (a) { if (a.crossDomain) { var b, c; return { send: function (e, f) { b = n("<script>").prop({ charset: a.scriptCharset, src: a.url }).on("load error", c = function (a) { b.remove(), c = null, a && f("error" === a.type ? 404 : 200, a.type) }), d.head.appendChild(b[0]) }, abort: function () { c && c() } } } }); var Ib = [], Jb = /(=)\?(?=&|$)|\?\?/; n.ajaxSetup({ jsonp: "callback", jsonpCallback: function () { var a = Ib.pop() || n.expando + "_" + jb++; return this[a] = !0, a } }), n.ajaxPrefilter("json jsonp", function (b, c, d) { var e, f, g, h = b.jsonp !== !1 && (Jb.test(b.url) ? "url" : "string" == typeof b.data && 0 === (b.contentType || "").indexOf("application/x-www-form-urlencoded") && Jb.test(b.data) && "data"); return h || "jsonp" === b.dataTypes[0] ? (e = b.jsonpCallback = n.isFunction(b.jsonpCallback) ? b.jsonpCallback() : b.jsonpCallback, h ? b[h] = b[h].replace(Jb, "$1" + e) : b.jsonp !== !1 && (b.url += (kb.test(b.url) ? "&" : "?") + b.jsonp + "=" + e), b.converters["script json"] = function () { return g || n.error(e + " was not called"), g[0] }, b.dataTypes[0] = "json", f = a[e], a[e] = function () { g = arguments }, d.always(function () { void 0 === f ? n(a).removeProp(e) : a[e] = f, b[e] && (b.jsonpCallback = c.jsonpCallback, Ib.push(e)), g && n.isFunction(f) && f(g[0]), g = f = void 0 }), "script") : void 0 }), l.createHTMLDocument = function () { var a = d.implementation.createHTMLDocument("").body; return a.innerHTML = "<form></form><form></form>", 2 === a.childNodes.length }(), n.parseHTML = function (a, b, c) { if (!a || "string" != typeof a) return null; "boolean" == typeof b && (c = b, b = !1), b = b || (l.createHTMLDocument ? d.implementation.createHTMLDocument("") : d); var e = x.exec(a), f = !c && []; return e ? [b.createElement(e[1])] : (e = ca([a], b, f), f && f.length && n(f).remove(), n.merge([], e.childNodes)) }; var Kb = n.fn.load; n.fn.load = function (a, b, c) { if ("string" != typeof a && Kb) return Kb.apply(this, arguments); var d, e, f, g = this, h = a.indexOf(" "); return h > -1 && (d = n.trim(a.slice(h)), a = a.slice(0, h)), n.isFunction(b) ? (c = b, b = void 0) : b && "object" == typeof b && (e = "POST"), g.length > 0 && n.ajax({ url: a, type: e || "GET", dataType: "html", data: b }).done(function (a) { f = arguments, g.html(d ? n("<div>").append(n.parseHTML(a)).find(d) : a) }).always(c && function (a, b) { g.each(function () { c.apply(g, f || [a.responseText, b, a]) }) }), this }, n.each(["ajaxStart", "ajaxStop", "ajaxComplete", "ajaxError", "ajaxSuccess", "ajaxSend"], function (a, b) { n.fn[b] = function (a) { return this.on(b, a) } }), n.expr.filters.animated = function (a) { return n.grep(n.timers, function (b) { return a === b.elem }).length }; function Lb(a) { return n.isWindow(a) ? a : 9 === a.nodeType && a.defaultView } n.offset = { setOffset: function (a, b, c) { var d, e, f, g, h, i, j, k = n.css(a, "position"), l = n(a), m = {}; "static" === k && (a.style.position = "relative"), h = l.offset(), f = n.css(a, "top"), i = n.css(a, "left"), j = ("absolute" === k || "fixed" === k) && (f + i).indexOf("auto") > -1, j ? (d = l.position(), g = d.top, e = d.left) : (g = parseFloat(f) || 0, e = parseFloat(i) || 0), n.isFunction(b) && (b = b.call(a, c, n.extend({}, h))), null != b.top && (m.top = b.top - h.top + g), null != b.left && (m.left = b.left - h.left + e), "using" in b ? b.using.call(a, m) : l.css(m) } }, n.fn.extend({ offset: function (a) { if (arguments.length) return void 0 === a ? this : this.each(function (b) { n.offset.setOffset(this, a, b) }); var b, c, d = this[0], e = { top: 0, left: 0 }, f = d && d.ownerDocument; if (f) return b = f.documentElement, n.contains(b, d) ? (e = d.getBoundingClientRect(), c = Lb(f), { top: e.top + c.pageYOffset - b.clientTop, left: e.left + c.pageXOffset - b.clientLeft }) : e }, position: function () { if (this[0]) { var a, b, c = this[0], d = { top: 0, left: 0 }; return "fixed" === n.css(c, "position") ? b = c.getBoundingClientRect() : (a = this.offsetParent(), b = this.offset(), n.nodeName(a[0], "html") || (d = a.offset()), d.top += n.css(a[0], "borderTopWidth", !0) - a.scrollTop(), d.left += n.css(a[0], "borderLeftWidth", !0) - a.scrollLeft()), { top: b.top - d.top - n.css(c, "marginTop", !0), left: b.left - d.left - n.css(c, "marginLeft", !0) } } }, offsetParent: function () { return this.map(function () { var a = this.offsetParent; while (a && "static" === n.css(a, "position")) a = a.offsetParent; return a || Ea }) } }), n.each({ scrollLeft: "pageXOffset", scrollTop: "pageYOffset" }, function (a, b) { var c = "pageYOffset" === b; n.fn[a] = function (d) { return K(this, function (a, d, e) { var f = Lb(a); return void 0 === e ? f ? f[b] : a[d] : void (f ? f.scrollTo(c ? f.pageXOffset : e, c ? e : f.pageYOffset) : a[d] = e) }, a, d, arguments.length) } }), n.each(["top", "left"], function (a, b) { n.cssHooks[b] = Ga(l.pixelPosition, function (a, c) { return c ? (c = Fa(a, b), Ba.test(c) ? n(a).position()[b] + "px" : c) : void 0 }) }), n.each({ Height: "height", Width: "width" }, function (a, b) { n.each({ padding: "inner" + a, content: b, "": "outer" + a }, function (c, d) { n.fn[d] = function (d, e) { var f = arguments.length && (c || "boolean" != typeof d), g = c || (d === !0 || e === !0 ? "margin" : "border"); return K(this, function (b, c, d) { var e; return n.isWindow(b) ? b.document.documentElement["client" + a] : 9 === b.nodeType ? (e = b.documentElement, Math.max(b.body["scroll" + a], e["scroll" + a], b.body["offset" + a], e["offset" + a], e["client" + a])) : void 0 === d ? n.css(b, c, g) : n.style(b, c, d, g) }, b, f ? d : void 0, f, null) } }) }), n.fn.extend({ bind: function (a, b, c) { return this.on(a, null, b, c) }, unbind: function (a, b) { return this.off(a, null, b) }, delegate: function (a, b, c, d) { return this.on(b, a, c, d) }, undelegate: function (a, b, c) { return 1 === arguments.length ? this.off(a, "**") : this.off(b, a || "**", c) }, size: function () { return this.length } }), n.fn.andSelf = n.fn.addBack, "function" == typeof define && define.amd && define("jquery", [], function () { return n }); var Mb = a.jQuery, Nb = a.$; return n.noConflict = function (b) { return a.$ === n && (a.$ = Nb), b && a.jQuery === n && (a.jQuery = Mb), n }, b || (a.jQuery = a.$ = n), n
});

/* jquery.signalR.core.js */
/*global window:false */
/*!
 * ASP.NET SignalR JavaScript Library 2.4.3
 * http://signalr.net/
 *
 * Copyright (c) .NET Foundation. All rights reserved.
 * Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.
 *
 */

/// <reference path="Scripts/jquery-1.6.4.js" />
/// <reference path="jquery.signalR.version.js" />
(function ($, window, undefined) {

    var resources = {
        nojQuery: "jQuery was not found. Please ensure jQuery is referenced before the SignalR client JavaScript file.",
        noTransportOnInit: "No transport could be initialized successfully. Try specifying a different transport or none at all for auto initialization.",
        errorOnNegotiate: "Error during negotiation request.",
        stoppedWhileLoading: "The connection was stopped during page load.",
        stoppedWhileNegotiating: "The connection was stopped during the negotiate request.",
        errorParsingNegotiateResponse: "Error parsing negotiate response.",
        errorRedirectionExceedsLimit: "Negotiate redirection limit exceeded.",
        errorDuringStartRequest: "Error during start request. Stopping the connection.",
        errorFromServer: "Error message received from the server: '{0}'.",
        stoppedDuringStartRequest: "The connection was stopped during the start request.",
        errorParsingStartResponse: "Error parsing start response: '{0}'. Stopping the connection.",
        invalidStartResponse: "Invalid start response: '{0}'. Stopping the connection.",
        protocolIncompatible: "You are using a version of the client that isn't compatible with the server. Client version {0}, server version {1}.",
        aspnetCoreSignalrServer: "Detected a connection attempt to an ASP.NET Core SignalR Server. This client only supports connecting to an ASP.NET SignalR Server. See https://aka.ms/signalr-core-differences for details.",
        sendFailed: "Send failed.",
        parseFailed: "Failed at parsing response: {0}",
        longPollFailed: "Long polling request failed.",
        eventSourceFailedToConnect: "EventSource failed to connect.",
        eventSourceError: "Error raised by EventSource",
        webSocketClosed: "WebSocket closed.",
        pingServerFailedInvalidResponse: "Invalid ping response when pinging server: '{0}'.",
        pingServerFailed: "Failed to ping server.",
        pingServerFailedStatusCode: "Failed to ping server.  Server responded with status code {0}, stopping the connection.",
        pingServerFailedParse: "Failed to parse ping server response, stopping the connection.",
        noConnectionTransport: "Connection is in an invalid state, there is no transport active.",
        webSocketsInvalidState: "The Web Socket transport is in an invalid state, transitioning into reconnecting.",
        reconnectTimeout: "Couldn't reconnect within the configured timeout of {0} ms, disconnecting.",
        reconnectWindowTimeout: "The client has been inactive since {0} and it has exceeded the inactivity timeout of {1} ms. Stopping the connection.",
        jsonpNotSupportedWithAccessToken: "The JSONP protocol does not support connections that require a Bearer token to connect, such as the Azure SignalR Service."
    };

    if (typeof ($) !== "function") {
        // no jQuery!
        throw new Error(resources.nojQuery);
    }

    var signalR,
        _connection,
        _pageLoaded = (window.document.readyState === "complete"),
        _pageWindow = $(window),
        _negotiateAbortText = "__Negotiate Aborted__",
        events = {
            onStart: "onStart",
            onStarting: "onStarting",
            onReceived: "onReceived",
            onError: "onError",
            onConnectionSlow: "onConnectionSlow",
            onReconnecting: "onReconnecting",
            onReconnect: "onReconnect",
            onStateChanged: "onStateChanged",
            onDisconnect: "onDisconnect"
        },
        ajaxDefaults = {
            processData: true,
            timeout: null,
            async: true,
            global: false,
            cache: false
        },
        log = function (msg, logging) {
            if (logging === false) {
                return;
            }
            var m;
            if (typeof (window.console) === "undefined") {
                return;
            }
            m = "[" + new Date().toTimeString() + "] SignalR: " + msg;
            if (window.console.debug) {
                window.console.debug(m);
            } else if (window.console.log) {
                window.console.log(m);
            }
        },

        changeState = function (connection, expectedState, newState) {
            if (expectedState === connection.state) {
                connection.state = newState;

                $(connection).triggerHandler(events.onStateChanged, [{ oldState: expectedState, newState: newState }]);
                return true;
            }

            return false;
        },

        isDisconnecting = function (connection) {
            return connection.state === signalR.connectionState.disconnected;
        },

        supportsKeepAlive = function (connection) {
            return connection._.keepAliveData.activated &&
                connection.transport.supportsKeepAlive(connection);
        },

        configureStopReconnectingTimeout = function (connection) {
            var stopReconnectingTimeout,
                onReconnectTimeout;

            // Check if this connection has already been configured to stop reconnecting after a specified timeout.
            // Without this check if a connection is stopped then started events will be bound multiple times.
            if (!connection._.configuredStopReconnectingTimeout) {
                onReconnectTimeout = function (connection) {
                    var message = signalR._.format(signalR.resources.reconnectTimeout, connection.disconnectTimeout);
                    connection.log(message);
                    $(connection).triggerHandler(events.onError, [signalR._.error(message, /* source */ "TimeoutException")]);
                    connection.stop(/* async */ false, /* notifyServer */ false);
                };

                connection.reconnecting(function () {
                    var connection = this;

                    // Guard against state changing in a previous user defined even handler
                    if (connection.state === signalR.connectionState.reconnecting) {
                        stopReconnectingTimeout = window.setTimeout(function () { onReconnectTimeout(connection); }, connection.disconnectTimeout);
                    }
                });

                connection.stateChanged(function (data) {
                    if (data.oldState === signalR.connectionState.reconnecting) {
                        // Clear the pending reconnect timeout check
                        window.clearTimeout(stopReconnectingTimeout);
                    }
                });

                connection._.configuredStopReconnectingTimeout = true;
            }
        };

    signalR = function (url, qs, logging) {
        /// <summary>Creates a new SignalR connection for the given url</summary>
        /// <param name="url" type="String">The URL of the long polling endpoint</param>
        /// <param name="qs" type="Object">
        ///     [Optional] Custom querystring parameters to add to the connection URL.
        ///     If an object, every non-function member will be added to the querystring.
        ///     If a string, it's added to the QS as specified.
        /// </param>
        /// <param name="logging" type="Boolean">
        ///     [Optional] A flag indicating whether connection logging is enabled to the browser
        ///     console/log. Defaults to false.
        /// </param>

        return new signalR.fn.init(url, qs, logging);
    };

    signalR._ = {
        defaultContentType: "application/x-www-form-urlencoded; charset=UTF-8",

        ieVersion: (function () {
            var version,
                matches;

            if (window.navigator.appName === 'Microsoft Internet Explorer') {
                // Check if the user agent has the pattern "MSIE (one or more numbers).(one or more numbers)";
                matches = /MSIE ([0-9]+\.[0-9]+)/.exec(window.navigator.userAgent);

                if (matches) {
                    version = window.parseFloat(matches[1]);
                }
            }

            // undefined value means not IE
            return version;
        })(),

        error: function (message, source, context) {
            var e = new Error(message);
            e.source = source;

            if (typeof context !== "undefined") {
                e.context = context;
            }

            return e;
        },

        transportError: function (message, transport, source, context) {
            var e = this.error(message, source, context);
            e.transport = transport ? transport.name : undefined;
            return e;
        },

        format: function () {
            /// <summary>Usage: format("Hi {0}, you are {1}!", "Foo", 100) </summary>
            var s = arguments[0];
            for (var i = 0; i < arguments.length - 1; i++) {
                s = s.replace("{" + i + "}", arguments[i + 1]);
            }
            return s;
        },

        firefoxMajorVersion: function (userAgent) {
            // Firefox user agents: http://useragentstring.com/pages/Firefox/
            var matches = userAgent.match(/Firefox\/(\d+)/);
            if (!matches || !matches.length || matches.length < 2) {
                return 0;
            }
            return parseInt(matches[1], 10 /* radix */);
        },

        configurePingInterval: function (connection) {
            var config = connection._.config,
                onFail = function (error) {
                    $(connection).triggerHandler(events.onError, [error]);
                };

            if (config && !connection._.pingIntervalId && config.pingInterval) {
                connection._.pingIntervalId = window.setInterval(function () {
                    signalR.transports._logic.pingServer(connection).fail(onFail);
                }, config.pingInterval);
            }
        }
    };

    signalR.events = events;

    signalR.resources = resources;

    signalR.ajaxDefaults = ajaxDefaults;

    signalR.changeState = changeState;

    signalR.isDisconnecting = isDisconnecting;

    signalR.connectionState = {
        connecting: 0,
        connected: 1,
        reconnecting: 2,
        disconnected: 4
    };

    signalR.hub = {
        start: function () {
            // This will get replaced with the real hub connection start method when hubs is referenced correctly
            throw new Error("SignalR: Error loading hubs. Ensure your hubs reference is correct, e.g. <script src='/signalr/js'></script>.");
        }
    };

    // .on() was added in version 1.7.0, .load() was removed in version 3.0.0 so we fallback to .load() if .on() does
    // not exist to not break existing applications
    if (typeof _pageWindow.on === "function") {
        _pageWindow.on("load", function () { _pageLoaded = true; });
    }
    else {
        _pageWindow.load(function () { _pageLoaded = true; });
    }

    function validateTransport(requestedTransport, connection) {
        /// <summary>Validates the requested transport by cross checking it with the pre-defined signalR.transports</summary>
        /// <param name="requestedTransport" type="Object">The designated transports that the user has specified.</param>
        /// <param name="connection" type="signalR">The connection that will be using the requested transports.  Used for logging purposes.</param>
        /// <returns type="Object" />

        if ($.isArray(requestedTransport)) {
            // Go through transport array and remove an "invalid" tranports
            for (var i = requestedTransport.length - 1; i >= 0; i--) {
                var transport = requestedTransport[i];
                if ($.type(transport) !== "string" || !signalR.transports[transport]) {
                    connection.log("Invalid transport: " + transport + ", removing it from the transports list.");
                    requestedTransport.splice(i, 1);
                }
            }

            // Verify we still have transports left, if we dont then we have invalid transports
            if (requestedTransport.length === 0) {
                connection.log("No transports remain within the specified transport array.");
                requestedTransport = null;
            }
        } else if (!signalR.transports[requestedTransport] && requestedTransport !== "auto") {
            connection.log("Invalid transport: " + requestedTransport.toString() + ".");
            requestedTransport = null;
        } else if (requestedTransport === "auto" && signalR._.ieVersion <= 8) {
            // If we're doing an auto transport and we're IE8 then force longPolling, #1764
            return ["longPolling"];

        }

        return requestedTransport;
    }

    function getDefaultPort(protocol) {
        if (protocol === "http:") {
            return 80;
        } else if (protocol === "https:") {
            return 443;
        }
    }

    function addDefaultPort(protocol, url) {
        // Remove ports  from url.  We have to check if there's a / or end of line
        // following the port in order to avoid removing ports such as 8080.
        if (url.match(/:\d+$/)) {
            return url;
        } else {
            return url + ":" + getDefaultPort(protocol);
        }
    }

    function ConnectingMessageBuffer(connection, drainCallback) {
        var that = this,
            buffer = [];

        that.tryBuffer = function (message) {
            if (connection.state === $.signalR.connectionState.connecting) {
                buffer.push(message);

                return true;
            }

            return false;
        };

        that.drain = function () {
            // Ensure that the connection is connected when we drain (do not want to drain while a connection is not active)
            if (connection.state === $.signalR.connectionState.connected) {
                while (buffer.length > 0) {
                    drainCallback(buffer.shift());
                }
            }
        };

        that.clear = function () {
            buffer = [];
        };
    }

    signalR.fn = signalR.prototype = {
        init: function (url, qs, logging) {
            var $connection = $(this);

            this.url = url;
            this.qs = qs;
            this.lastError = null;
            this._ = {
                keepAliveData: {},
                connectingMessageBuffer: new ConnectingMessageBuffer(this, function (message) {
                    $connection.triggerHandler(events.onReceived, [message]);
                }),
                lastMessageAt: new Date().getTime(),
                lastActiveAt: new Date().getTime(),
                beatInterval: 5000, // Default value, will only be overridden if keep alive is enabled,
                beatHandle: null,
                totalTransportConnectTimeout: 0, // This will be the sum of the TransportConnectTimeout sent in response to negotiate and connection.transportConnectTimeout
                redirectQs: null
            };
            if (typeof (logging) === "boolean") {
                this.logging = logging;
            }
        },

        _parseResponse: function (response) {
            var that = this;

            if (!response) {
                return response;
            } else if (typeof response === "string") {
                return that.json.parse(response);
            } else {
                return response;
            }
        },

        _originalJson: window.JSON,

        json: window.JSON,

        isCrossDomain: function (url, against) {
            /// <summary>Checks if url is cross domain</summary>
            /// <param name="url" type="String">The base URL</param>
            /// <param name="against" type="Object">
            ///     An optional argument to compare the URL against, if not specified it will be set to window.location.
            ///     If specified it must contain a protocol and a host property.
            /// </param>
            var link;

            url = $.trim(url);

            against = against || window.location;

            if (url.indexOf("http") !== 0) {
                return false;
            }

            // Create an anchor tag.
            link = window.document.createElement("a");
            link.href = url;

            // When checking for cross domain we have to special case port 80 because the window.location will remove the
            return link.protocol + addDefaultPort(link.protocol, link.host) !== against.protocol + addDefaultPort(against.protocol, against.host);
        },

        ajaxDataType: "text",

        contentType: "application/json; charset=UTF-8",

        logging: false,

        state: signalR.connectionState.disconnected,

        clientProtocol: "2.1",

        // We want to support older servers since the 2.0 change is to support redirection results, which isn't
        // really breaking in the protocol. So if a user updates their client to 2.0 protocol version there's
        // no reason they can't still connect to a 1.5 server. The 2.1 protocol is sent by the client so the SignalR
        // service knows the client will use they query string returned via the RedirectUrl for subsequent requests.
        // It doesn't matter whether the server reflects back 2.1 or continues using 2.0 as the protocol version.
        supportedProtocols: ["1.5", "2.0", "2.1"],

        negotiateRedirectSupportedProtocols: ["2.0", "2.1"],

        reconnectDelay: 2000,

        transportConnectTimeout: 0,

        disconnectTimeout: 30000, // This should be set by the server in response to the negotiate request (30s default)

        reconnectWindow: 30000, // This should be set by the server in response to the negotiate request

        keepAliveWarnAt: 2 / 3, // Warn user of slow connection if we breach the X% mark of the keep alive timeout

        start: function (options, callback) {
            /// <summary>Starts the connection</summary>
            /// <param name="options" type="Object">Options map</param>
            /// <param name="callback" type="Function">A callback function to execute when the connection has started</param>
            var connection = this,
                config = {
                    pingInterval: 300000,
                    waitForPageLoad: true,
                    transport: "auto",
                    jsonp: false
                },
                initialize,
                deferred = connection._deferral || $.Deferred(), // Check to see if there is a pre-existing deferral that's being built on, if so we want to keep using it
                parser = window.document.createElement("a"),
                setConnectionUrl = function (connection, url) {
                    if (connection.url === url && connection.baseUrl) {
                        // when the url related properties are already set
                        return;
                    }

                    connection.url = url;

                    // Resolve the full url
                    parser.href = connection.url;
                    if (!parser.protocol || parser.protocol === ":") {
                        connection.protocol = window.document.location.protocol;
                        connection.host = parser.host || window.document.location.host;
                    } else {
                        connection.protocol = parser.protocol;
                        connection.host = parser.host;
                    }

                    connection.baseUrl = connection.protocol + "//" + connection.host;

                    // Set the websocket protocol
                    connection.wsProtocol = connection.protocol === "https:" ? "wss://" : "ws://";

                    // If the url is protocol relative, prepend the current windows protocol to the url.
                    if (connection.url.indexOf("//") === 0) {
                        connection.url = window.location.protocol + connection.url;
                        connection.log("Protocol relative URL detected, normalizing it to '" + connection.url + "'.");
                    }

                    if (connection.isCrossDomain(connection.url)) {
                        connection.log("Auto detected cross domain url.");

                        if (config.transport === "auto") {
                            // Cross-domain does not support foreverFrame
                            config.transport = ["webSockets", "serverSentEvents", "longPolling"];
                        }

                        if (typeof connection.withCredentials === "undefined") {
                            connection.withCredentials = true;
                        }

                        // Determine if jsonp is the only choice for negotiation, ajaxSend and ajaxAbort.
                        // i.e. if the browser doesn't supports CORS
                        // If it is, ignore any preference to the contrary, and switch to jsonp.
                        if (!$.support.cors) {
                            connection.ajaxDataType = "jsonp";
                            connection.log("Using jsonp because this browser doesn't support CORS.");
                        }

                        connection.contentType = signalR._.defaultContentType;
                    }
                };

            connection.lastError = null;

            // Persist the deferral so that if start is called multiple times the same deferral is used.
            connection._deferral = deferred;

            if (!connection.json) {
                // no JSON!
                throw new Error("SignalR: No JSON parser found. Please ensure json2.js is referenced before the SignalR.js file if you need to support clients without native JSON parsing support, e.g. IE<8.");
            }

            if ($.type(options) === "function") {
                // Support calling with single callback parameter
                callback = options;
            } else if ($.type(options) === "object") {
                $.extend(config, options);
                if ($.type(config.callback) === "function") {
                    callback = config.callback;
                }
            }

            config.transport = validateTransport(config.transport, connection);

            // If the transport is invalid throw an error and abort start
            if (!config.transport) {
                throw new Error("SignalR: Invalid transport(s) specified, aborting start.");
            }

            connection._.config = config;

            // Check to see if start is being called prior to page load
            // If waitForPageLoad is true we then want to re-direct function call to the window load event
            if (!_pageLoaded && config.waitForPageLoad === true) {
                connection._.deferredStartHandler = function () {
                    connection.start(options, callback);
                };
                _pageWindow.bind("load", connection._.deferredStartHandler);

                return deferred.promise();
            }

            // If we're already connecting just return the same deferral as the original connection start
            if (connection.state === signalR.connectionState.connecting) {
                return deferred.promise();
            } else if (changeState(connection,
                signalR.connectionState.disconnected,
                signalR.connectionState.connecting) === false) {
                // We're not connecting so try and transition into connecting.
                // If we fail to transition then we're either in connected or reconnecting.

                deferred.resolve(connection);
                return deferred.promise();
            }

            configureStopReconnectingTimeout(connection);

            // If jsonp with no/auto transport is specified, then set the transport to long polling
            // since that is the only transport for which jsonp really makes sense.
            // Some developers might actually choose to specify jsonp for same origin requests
            // as demonstrated by Issue #623.
            if (config.transport === "auto" && config.jsonp === true) {
                config.transport = "longPolling";
            }

            connection.withCredentials = config.withCredentials;

            // Save the original url so that we can reset it when we stop and restart the connection
            connection._originalUrl = connection.url;

            connection.ajaxDataType = config.jsonp ? "jsonp" : "text";

            setConnectionUrl(connection, connection.url);

            $(connection).bind(events.onStart, function (e, data) {
                if ($.type(callback) === "function") {
                    callback.call(connection);
                }
                deferred.resolve(connection);
            });

            connection._.initHandler = signalR.transports._logic.initHandler(connection);

            initialize = function (transports, index) {
                var noTransportError = signalR._.error(resources.noTransportOnInit);

                index = index || 0;
                if (index >= transports.length) {
                    if (index === 0) {
                        connection.log("No transports supported by the server were selected.");
                    } else if (index === 1) {
                        connection.log("No fallback transports were selected.");
                    } else {
                        connection.log("Fallback transports exhausted.");
                    }

                    // No transport initialized successfully
                    $(connection).triggerHandler(events.onError, [noTransportError]);
                    deferred.reject(noTransportError);
                    // Stop the connection if it has connected and move it into the disconnected state
                    connection.stop();
                    return;
                }

                // The connection was aborted
                if (connection.state === signalR.connectionState.disconnected) {
                    return;
                }

                var transportName = transports[index],
                    transport = signalR.transports[transportName],
                    onFallback = function () {
                        initialize(transports, index + 1);
                    };

                connection.transport = transport;

                try {
                    connection._.initHandler.start(transport, function () { // success
                        // Firefox 11+ doesn't allow sync XHR withCredentials: https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest#withCredentials
                        var isFirefox11OrGreater = signalR._.firefoxMajorVersion(window.navigator.userAgent) >= 11,
                            asyncAbort = true;

                        connection.log("The start request succeeded. Transitioning to the connected state.");

                        if (supportsKeepAlive(connection)) {
                            signalR.transports._logic.monitorKeepAlive(connection);
                        }

                        if (connection._.keepAliveData.activated) {
                            signalR.transports._logic.startHeartbeat(connection);
                        }

                        // Used to ensure low activity clients maintain their authentication.
                        // Must be configured once a transport has been decided to perform valid ping requests.
                        signalR._.configurePingInterval(connection);

                        if (!changeState(connection,
                            signalR.connectionState.connecting,
                            signalR.connectionState.connected)) {
                            connection.log("WARNING! The connection was not in the connecting state.");
                        }

                        // Drain any incoming buffered messages (messages that came in prior to connect)
                        connection._.connectingMessageBuffer.drain();

                        $(connection).triggerHandler(events.onStart);

                        // wire the stop handler for when the user leaves the page
                        _pageWindow.bind("unload", function () {
                            connection.log("Window unloading, stopping the connection.");

                            connection.stop(asyncAbort);
                        });

                        if (isFirefox11OrGreater) {
                            // Firefox does not fire cross-domain XHRs in the normal unload handler on tab close.
                            // #2400
                            _pageWindow.bind("beforeunload", function () {
                                // If connection.stop() runs runs in beforeunload and fails, it will also fail
                                // in unload unless connection.stop() runs after a timeout.
                                window.setTimeout(function () {
                                    connection.stop(asyncAbort);
                                }, 0);
                            });
                        }
                    }, onFallback);
                }
                catch (error) {
                    connection.log(transport.name + " transport threw '" + error.message + "' when attempting to start.");
                    onFallback();
                }
            };

            var url = connection.url + "/negotiate",
                onFailed = function (error, connection) {
                    var err = signalR._.error(resources.errorOnNegotiate, error, connection._.negotiateRequest);

                    $(connection).triggerHandler(events.onError, err);
                    deferred.reject(err);
                    // Stop the connection if negotiate failed
                    connection.stop();
                };

            $(connection).triggerHandler(events.onStarting);

            url = signalR.transports._logic.prepareQueryString(connection, url);

            connection.log("Negotiating with '" + url + "'.");

            // Save the ajax negotiate request object so we can abort it if stop is called while the request is in flight.
            connection._.negotiateRequest = function () {
                var res,
                    redirects = 0,
                    MAX_REDIRECTS = 100,
                    keepAliveData,
                    protocolError,
                    transports = [],
                    supportedTransports = [],
                    negotiate = function (connection, onSuccess) {
                        var url = signalR.transports._logic.prepareQueryString(connection, connection.url + "/negotiate");
                        connection.log("Negotiating with '" + url + "'.");
                        var options = {
                            url: url,
                            error: function (error, statusText) {
                                // We don't want to cause any errors if we're aborting our own negotiate request.
                                if (statusText !== _negotiateAbortText) {
                                    onFailed(error, connection);
                                } else {
                                    // This rejection will noop if the deferred has already been resolved or rejected.
                                    deferred.reject(signalR._.error(resources.stoppedWhileNegotiating, null /* error */, connection._.negotiateRequest));
                                }
                            },
                            success: onSuccess
                        };

                        if (connection.accessToken) {
                            options.headers = { "Authorization": "Bearer " + connection.accessToken };
                        }

                        return signalR.transports._logic.ajax(connection, options);
                    },
                    callback = function (result) {
                        try {
                            res = connection._parseResponse(result);
                        } catch (error) {
                            onFailed(signalR._.error(resources.errorParsingNegotiateResponse, error), connection);
                            return;
                        }

                        // Check if the server is an ASP.NET Core app
                        if (res.availableTransports) {
                            protocolError = signalR._.error(resources.aspnetCoreSignalrServer);
                            $(connection).triggerHandler(events.onError, [protocolError]);
                            deferred.reject(protocolError);
                            return;
                        }

                        if (!res.ProtocolVersion || (connection.supportedProtocols.indexOf(res.ProtocolVersion) === -1)) {
                            protocolError = signalR._.error(signalR._.format(resources.protocolIncompatible, connection.clientProtocol, res.ProtocolVersion));
                            $(connection).triggerHandler(events.onError, [protocolError]);
                            deferred.reject(protocolError);

                            return;
                        }

                        // Check for a redirect response (which must have a ProtocolVersion of 2.0 or greater)
                        // ProtocolVersion 2.1 is the highest supported by the client, so we can just check for 2.0 or 2.1 for now
                        // instead of trying to do proper version string comparison in JavaScript.
                        if (connection.negotiateRedirectSupportedProtocols.indexOf(res.ProtocolVersion) !== -1) {
                            if (res.Error) {
                                protocolError = signalR._.error(signalR._.format(resources.errorFromServer, res.Error));
                                $(connection).triggerHandler(events.onError, [protocolError]);
                                deferred.reject(protocolError);
                                return;
                            }
                            else if (res.RedirectUrl) {
                                if (redirects === MAX_REDIRECTS) {
                                    onFailed(signalR._.error(resources.errorRedirectionExceedsLimit), connection);
                                    return;
                                }

                                if (config.transport === "auto") {
                                    // Redirected connections do not support foreverFrame
                                    config.transport = ["webSockets", "serverSentEvents", "longPolling"];
                                }

                                connection.log("Received redirect to: " + res.RedirectUrl);
                                connection.accessToken = res.AccessToken;

                                var splitUrlAndQs = res.RedirectUrl.split("?", 2);
                                setConnectionUrl(connection, splitUrlAndQs[0]);

                                // Update redirectQs with query string from only the most recent RedirectUrl.
                                connection._.redirectQs = splitUrlAndQs.length === 2 ? splitUrlAndQs[1] : null;

                                if (connection.ajaxDataType === "jsonp" && connection.accessToken) {
                                    onFailed(signalR._.error(resources.jsonpNotSupportedWithAccessToken), connection);
                                    return;
                                }

                                redirects++;
                                negotiate(connection, callback);
                                return;
                            }
                        }

                        keepAliveData = connection._.keepAliveData;
                        connection.appRelativeUrl = res.Url;
                        connection.id = res.ConnectionId;
                        connection.token = res.ConnectionToken;
                        connection.webSocketServerUrl = res.WebSocketServerUrl;

                        // The long poll timeout is the ConnectionTimeout plus 10 seconds
                        connection._.pollTimeout = res.ConnectionTimeout * 1000 + 10000; // in ms

                        // Once the server has labeled the PersistentConnection as Disconnected, we should stop attempting to reconnect
                        // after res.DisconnectTimeout seconds.
                        connection.disconnectTimeout = res.DisconnectTimeout * 1000; // in ms

                        // Add the TransportConnectTimeout from the response to the transportConnectTimeout from the client to calculate the total timeout
                        connection._.totalTransportConnectTimeout = connection.transportConnectTimeout + res.TransportConnectTimeout * 1000;

                        // If we have a keep alive
                        if (res.KeepAliveTimeout) {
                            // Register the keep alive data as activated
                            keepAliveData.activated = true;

                            // Timeout to designate when to force the connection into reconnecting converted to milliseconds
                            keepAliveData.timeout = res.KeepAliveTimeout * 1000;

                            // Timeout to designate when to warn the developer that the connection may be dead or is not responding.
                            keepAliveData.timeoutWarning = keepAliveData.timeout * connection.keepAliveWarnAt;

                            // Instantiate the frequency in which we check the keep alive.  It must be short in order to not miss/pick up any changes
                            connection._.beatInterval = (keepAliveData.timeout - keepAliveData.timeoutWarning) / 3;
                        } else {
                            keepAliveData.activated = false;
                        }

                        connection.reconnectWindow = connection.disconnectTimeout + (keepAliveData.timeout || 0);

                        $.each(signalR.transports, function (key) {
                            if ((key.indexOf("_") === 0) || (key === "webSockets" && !res.TryWebSockets)) {
                                return true;
                            }
                            supportedTransports.push(key);
                        });

                        if ($.isArray(config.transport)) {
                            $.each(config.transport, function (_, transport) {
                                if ($.inArray(transport, supportedTransports) >= 0) {
                                    transports.push(transport);
                                }
                            });
                        } else if (config.transport === "auto") {
                            transports = supportedTransports;
                        } else if ($.inArray(config.transport, supportedTransports) >= 0) {
                            transports.push(config.transport);
                        }

                        initialize(transports);
                    };

                return negotiate(connection, callback);
            }();

            return deferred.promise();
        },

        starting: function (callback) {
            /// <summary>Adds a callback that will be invoked before anything is sent over the connection</summary>
            /// <param name="callback" type="Function">A callback function to execute before the connection is fully instantiated.</param>
            /// <returns type="signalR" />
            var connection = this;
            $(connection).bind(events.onStarting, function (e, data) {
                callback.call(connection);
            });
            return connection;
        },

        send: function (data) {
            /// <summary>Sends data over the connection</summary>
            /// <param name="data" type="String">The data to send over the connection</param>
            /// <returns type="signalR" />
            var connection = this;

            if (connection.state === signalR.connectionState.disconnected) {
                // Connection hasn't been started yet
                throw new Error("SignalR: Connection must be started before data can be sent. Call .start() before .send()");
            }

            if (connection.state === signalR.connectionState.connecting) {
                // Connection hasn't been started yet
                throw new Error("SignalR: Connection has not been fully initialized. Use .start().done() or .start().fail() to run logic after the connection has started.");
            }

            connection.transport.send(connection, data);
            // REVIEW: Should we return deferred here?
            return connection;
        },

        received: function (callback) {
            /// <summary>Adds a callback that will be invoked after anything is received over the connection</summary>
            /// <param name="callback" type="Function">A callback function to execute when any data is received on the connection</param>
            /// <returns type="signalR" />
            var connection = this;
            $(connection).bind(events.onReceived, function (e, data) {
                callback.call(connection, data);
            });
            return connection;
        },

        stateChanged: function (callback) {
            /// <summary>Adds a callback that will be invoked when the connection state changes</summary>
            /// <param name="callback" type="Function">A callback function to execute when the connection state changes</param>
            /// <returns type="signalR" />
            var connection = this;
            $(connection).bind(events.onStateChanged, function (e, data) {
                callback.call(connection, data);
            });
            return connection;
        },

        error: function (callback) {
            /// <summary>Adds a callback that will be invoked after an error occurs with the connection</summary>
            /// <param name="callback" type="Function">A callback function to execute when an error occurs on the connection</param>
            /// <returns type="signalR" />
            var connection = this;
            $(connection).bind(events.onError, function (e, errorData, sendData) {
                connection.lastError = errorData;
                // In practice 'errorData' is the SignalR built error object.
                // In practice 'sendData' is undefined for all error events except those triggered by
                // 'ajaxSend' and 'webSockets.send'.'sendData' is the original send payload.
                callback.call(connection, errorData, sendData);
            });
            return connection;
        },

        disconnected: function (callback) {
            /// <summary>Adds a callback that will be invoked when the client disconnects</summary>
            /// <param name="callback" type="Function">A callback function to execute when the connection is broken</param>
            /// <returns type="signalR" />
            var connection = this;
            $(connection).bind(events.onDisconnect, function (e, data) {
                callback.call(connection);
            });
            return connection;
        },

        connectionSlow: function (callback) {
            /// <summary>Adds a callback that will be invoked when the client detects a slow connection</summary>
            /// <param name="callback" type="Function">A callback function to execute when the connection is slow</param>
            /// <returns type="signalR" />
            var connection = this;
            $(connection).bind(events.onConnectionSlow, function (e, data) {
                callback.call(connection);
            });

            return connection;
        },

        reconnecting: function (callback) {
            /// <summary>Adds a callback that will be invoked when the underlying transport begins reconnecting</summary>
            /// <param name="callback" type="Function">A callback function to execute when the connection enters a reconnecting state</param>
            /// <returns type="signalR" />
            var connection = this;
            $(connection).bind(events.onReconnecting, function (e, data) {
                callback.call(connection);
            });
            return connection;
        },

        reconnected: function (callback) {
            /// <summary>Adds a callback that will be invoked when the underlying transport reconnects</summary>
            /// <param name="callback" type="Function">A callback function to execute when the connection is restored</param>
            /// <returns type="signalR" />
            var connection = this;
            $(connection).bind(events.onReconnect, function (e, data) {
                callback.call(connection);
            });
            return connection;
        },

        stop: function (async, notifyServer) {
            /// <summary>Stops listening</summary>
            /// <param name="async" type="Boolean">Whether or not to asynchronously abort the connection</param>
            /// <param name="notifyServer" type="Boolean">Whether we want to notify the server that we are aborting the connection</param>
            /// <returns type="signalR" />
            var connection = this,
                // Save deferral because this is always cleaned up
                deferral = connection._deferral;

            // Verify that we've bound a load event.
            if (connection._.deferredStartHandler) {
                // Unbind the event.
                _pageWindow.unbind("load", connection._.deferredStartHandler);
            }

            // Always clean up private non-timeout based state.
            delete connection._.config;
            delete connection._.deferredStartHandler;

            // This needs to be checked despite the connection state because a connection start can be deferred until page load.
            // If we've deferred the start due to a page load we need to unbind the "onLoad" -> start event.
            if (!_pageLoaded && (!connection._.config || connection._.config.waitForPageLoad === true)) {
                connection.log("Stopping connection prior to negotiate.");

                // If we have a deferral we should reject it
                if (deferral) {
                    deferral.reject(signalR._.error(resources.stoppedWhileLoading));
                }

                // Short-circuit because the start has not been fully started.
                return;
            }

            if (connection.state === signalR.connectionState.disconnected) {
                return;
            }

            connection.log("Stopping connection.");

            // Clear this no matter what
            window.clearTimeout(connection._.beatHandle);
            window.clearInterval(connection._.pingIntervalId);

            if (connection.transport) {
                connection.transport.stop(connection);

                if (notifyServer !== false) {
                    connection.transport.abort(connection, async);
                }

                if (supportsKeepAlive(connection)) {
                    signalR.transports._logic.stopMonitoringKeepAlive(connection);
                }

                connection.transport = null;
            }

            if (connection._.negotiateRequest) {
                // If the negotiation request has already completed this will noop.
                connection._.negotiateRequest.abort(_negotiateAbortText);
                delete connection._.negotiateRequest;
            }

            // Ensure that initHandler.stop() is called before connection._deferral is deleted
            if (connection._.initHandler) {
                connection._.initHandler.stop();
            }

            delete connection._deferral;
            delete connection.messageId;
            delete connection.groupsToken;
            delete connection.id;
            delete connection._.pingIntervalId;
            delete connection._.lastMessageAt;
            delete connection._.lastActiveAt;

            // Clear out our message buffer
            connection._.connectingMessageBuffer.clear();

            // Clean up this event
            $(connection).unbind(events.onStart);

            // Reset the URL and clear the access token
            delete connection.accessToken;
            delete connection.protocol;
            delete connection.host;
            delete connection.baseUrl;
            delete connection.wsProtocol;
            delete connection.contentType;
            connection.url = connection._originalUrl;
            connection._.redirectQs = null;

            // Trigger the disconnect event
            changeState(connection, connection.state, signalR.connectionState.disconnected);
            $(connection).triggerHandler(events.onDisconnect);

            return connection;
        },

        log: function (msg) {
            log(msg, this.logging);
        }
    };

    signalR.fn.init.prototype = signalR.fn;

    signalR.noConflict = function () {
        /// <summary>Reinstates the original value of $.connection and returns the signalR object for manual assignment</summary>
        /// <returns type="signalR" />
        if ($.connection === signalR) {
            $.connection = _connection;
        }
        return signalR;
    };

    if ($.connection) {
        _connection = $.connection;
    }

    $.connection = $.signalR = signalR;

}(window.jQuery, window));
/* jquery.signalR.transports.common.js */
// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.

/*global window:false */
/// <reference path="jquery.signalR.core.js" />

(function ($, window, undefined) {

    var signalR = $.signalR,
        events = $.signalR.events,
        changeState = $.signalR.changeState,
        startAbortText = "__Start Aborted__",
        transportLogic;

    signalR.transports = {};

    function beat(connection) {
        if (connection._.keepAliveData.monitoring) {
            checkIfAlive(connection);
        }

        // Ensure that we successfully marked active before continuing the heartbeat.
        if (transportLogic.markActive(connection)) {
            connection._.beatHandle = window.setTimeout(function () {
                beat(connection);
            }, connection._.beatInterval);
        }
    }

    function checkIfAlive(connection) {
        var keepAliveData = connection._.keepAliveData,
            timeElapsed;

        // Only check if we're connected
        if (connection.state === signalR.connectionState.connected) {
            timeElapsed = new Date().getTime() - connection._.lastMessageAt;

            // Check if the keep alive has completely timed out
            if (timeElapsed >= keepAliveData.timeout) {
                connection.log("Keep alive timed out.  Notifying transport that connection has been lost.");

                // Notify transport that the connection has been lost
                connection.transport.lostConnection(connection);
            } else if (timeElapsed >= keepAliveData.timeoutWarning) {
                // This is to assure that the user only gets a single warning
                if (!keepAliveData.userNotified) {
                    connection.log("Keep alive has been missed, connection may be dead/slow.");
                    $(connection).triggerHandler(events.onConnectionSlow);
                    keepAliveData.userNotified = true;
                }
            } else {
                keepAliveData.userNotified = false;
            }
        }
    }

    function getAjaxUrl(connection, path) {
        var url = connection.url + path;

        if (connection.transport) {
            url += "?transport=" + connection.transport.name;
        }

        return transportLogic.prepareQueryString(connection, url);
    }

    function InitHandler(connection) {
        this.connection = connection;

        this.startRequested = false;
        this.startCompleted = false;
        this.connectionStopped = false;
    }

    InitHandler.prototype = {
        start: function (transport, onSuccess, onFallback) {
            var that = this,
                connection = that.connection,
                failCalled = false;

            if (that.startRequested || that.connectionStopped) {
                connection.log("WARNING! " + transport.name + " transport cannot be started. Initialization ongoing or completed.");
                return;
            }

            connection.log(transport.name + " transport starting.");

            transport.start(connection, function () {
                if (!failCalled) {
                    that.initReceived(transport, onSuccess);
                }
            }, function (error) {
                // Don't allow the same transport to cause onFallback to be called twice
                if (!failCalled) {
                    failCalled = true;
                    that.transportFailed(transport, error, onFallback);
                }

                // Returns true if the transport should stop;
                // false if it should attempt to reconnect
                return !that.startCompleted || that.connectionStopped;
            });

            that.transportTimeoutHandle = window.setTimeout(function () {
                if (!failCalled) {
                    failCalled = true;
                    connection.log(transport.name + " transport timed out when trying to connect.");
                    that.transportFailed(transport, undefined, onFallback);
                }
            }, connection._.totalTransportConnectTimeout);
        },

        stop: function () {
            this.connectionStopped = true;
            window.clearTimeout(this.transportTimeoutHandle);
            signalR.transports._logic.tryAbortStartRequest(this.connection);
        },

        initReceived: function (transport, onSuccess) {
            var that = this,
                connection = that.connection;

            if (that.startRequested) {
                connection.log("WARNING! The client received multiple init messages.");
                return;
            }

            if (that.connectionStopped) {
                return;
            }

            that.startRequested = true;
            window.clearTimeout(that.transportTimeoutHandle);

            connection.log(transport.name + " transport connected. Initiating start request.");
            signalR.transports._logic.ajaxStart(connection, function () {
                that.startCompleted = true;
                onSuccess();
            });
        },

        transportFailed: function (transport, error, onFallback) {
            var connection = this.connection,
                deferred = connection._deferral,
                wrappedError;

            if (this.connectionStopped) {
                return;
            }

            window.clearTimeout(this.transportTimeoutHandle);

            if (!this.startRequested) {
                transport.stop(connection);

                connection.log(transport.name + " transport failed to connect. Attempting to fall back.");
                onFallback();
            } else if (!this.startCompleted) {
                // Do not attempt to fall back if a start request is ongoing during a transport failure.
                // Instead, trigger an error and stop the connection.
                wrappedError = signalR._.error(signalR.resources.errorDuringStartRequest, error);

                connection.log(transport.name + " transport failed during the start request. Stopping the connection.");
                $(connection).triggerHandler(events.onError, [wrappedError]);
                if (deferred) {
                    deferred.reject(wrappedError);
                }

                connection.stop();
            } else {
                // The start request has completed, but the connection has not stopped.
                // No need to do anything here. The transport should attempt its normal reconnect logic.
            }
        }
    };

    transportLogic = signalR.transports._logic = {
        ajax: function (connection, options) {
            return $.ajax(
                $.extend(/*deep copy*/ true, {}, $.signalR.ajaxDefaults, {
                    type: "GET",
                    data: {},
                    xhrFields: { withCredentials: connection.withCredentials },
                    contentType: connection.contentType,
                    dataType: connection.ajaxDataType
                }, options));
        },

        pingServer: function (connection) {
            /// <summary>Pings the server</summary>
            /// <param name="connection" type="signalr">Connection associated with the server ping</param>
            /// <returns type="signalR" />
            var url,
                xhr,
                deferral = $.Deferred();

            if (connection.transport) {
                url = connection.url + "/ping";

                url = transportLogic.addQs(url, connection.qs);

                xhr = transportLogic.ajax(connection, {
                    url: url,
                    headers: connection.accessToken ? { "Authorization": "Bearer " + connection.accessToken } : {},
                    success: function (result) {
                        var data;

                        try {
                            data = connection._parseResponse(result);
                        }
                        catch (error) {
                            deferral.reject(
                                signalR._.transportError(
                                    signalR.resources.pingServerFailedParse,
                                    connection.transport,
                                    error,
                                    xhr
                                )
                            );
                            connection.stop();
                            return;
                        }

                        if (data.Response === "pong") {
                            deferral.resolve();
                        }
                        else {
                            deferral.reject(
                                signalR._.transportError(
                                    signalR._.format(signalR.resources.pingServerFailedInvalidResponse, result),
                                    connection.transport,
                                    null /* error */,
                                    xhr
                                )
                            );
                        }
                    },
                    error: function (error) {
                        if (error.status === 401 || error.status === 403) {
                            deferral.reject(
                                signalR._.transportError(
                                    signalR._.format(signalR.resources.pingServerFailedStatusCode, error.status),
                                    connection.transport,
                                    error,
                                    xhr
                                )
                            );
                            connection.stop();
                        }
                        else {
                            deferral.reject(
                                signalR._.transportError(
                                    signalR.resources.pingServerFailed,
                                    connection.transport,
                                    error,
                                    xhr
                                )
                            );
                        }
                    }
                });
            }
            else {
                deferral.reject(
                    signalR._.transportError(
                        signalR.resources.noConnectionTransport,
                        connection.transport
                    )
                );
            }

            return deferral.promise();
        },

        prepareQueryString: function (connection, url) {
            var preparedUrl;

            // Use addQs to start since it handles the ?/& prefix for us
            preparedUrl = transportLogic.addQs(url, "clientProtocol=" + connection.clientProtocol);

            if (typeof (connection._.redirectQs) === "string") {
                // Add the redirect-specified query string params if any
                preparedUrl = transportLogic.addQs(preparedUrl, connection._.redirectQs);
            } else {
                // Otherwise, add the user-specified query string params if any
                preparedUrl = transportLogic.addQs(preparedUrl, connection.qs);
            }

            if (connection.token) {
                preparedUrl += "&connectionToken=" + window.encodeURIComponent(connection.token);
            }

            if (connection.data) {
                preparedUrl += "&connectionData=" + window.encodeURIComponent(connection.data);
            }

            return preparedUrl;
        },

        addQs: function (url, qs) {
            var appender = url.indexOf("?") !== -1 ? "&" : "?",
                firstChar;

            if (!qs) {
                return url;
            }

            if (typeof (qs) === "object") {
                return url + appender + $.param(qs);
            }

            if (typeof (qs) === "string") {
                firstChar = qs.charAt(0);

                if (firstChar === "?" || firstChar === "&") {
                    appender = "";
                }

                return url + appender + qs;
            }

            throw new Error("Query string property must be either a string or object.");
        },

        // BUG #2953: The url needs to be same otherwise it will cause a memory leak
        getUrl: function (connection, transport, reconnecting, poll, ajaxPost) {
            /// <summary>Gets the url for making a GET based connect request</summary>
            var baseUrl = transport === "webSockets" ? "" : connection.baseUrl,
                url = baseUrl + connection.appRelativeUrl,
                qs = "transport=" + transport;

            if (!ajaxPost && connection.groupsToken) {
                qs += "&groupsToken=" + window.encodeURIComponent(connection.groupsToken);
            }

            if (!reconnecting) {
                url += "/connect";
            } else {
                if (poll) {
                    // longPolling transport specific
                    url += "/poll";
                } else {
                    url += "/reconnect";
                }

                if (!ajaxPost && connection.messageId) {
                    qs += "&messageId=" + window.encodeURIComponent(connection.messageId);
                }
            }
            url += "?" + qs;
            url = transportLogic.prepareQueryString(connection, url);

            // With sse or ws, access_token in request header is not supported
            if (connection.transport && connection.accessToken) {
                if (connection.transport.name === "serverSentEvents" || connection.transport.name === "webSockets") {
                    url += "&access_token=" + window.encodeURIComponent(connection.accessToken);
                }
            }

            if (!ajaxPost) {
                url += "&tid=" + Math.floor(Math.random() * 11);
            }

            return url;
        },

        maximizePersistentResponse: function (minPersistentResponse) {
            return {
                MessageId: minPersistentResponse.C,
                Messages: minPersistentResponse.M,
                Initialized: typeof (minPersistentResponse.S) !== "undefined" ? true : false,
                ShouldReconnect: typeof (minPersistentResponse.T) !== "undefined" ? true : false,
                LongPollDelay: minPersistentResponse.L,
                GroupsToken: minPersistentResponse.G,
                Error: minPersistentResponse.E
            };
        },

        updateGroups: function (connection, groupsToken) {
            if (groupsToken) {
                connection.groupsToken = groupsToken;
            }
        },

        stringifySend: function (connection, message) {
            if (typeof (message) === "string" || typeof (message) === "undefined" || message === null) {
                return message;
            }
            return connection.json.stringify(message);
        },

        ajaxSend: function (connection, data) {
            var payload = transportLogic.stringifySend(connection, data),
                url = getAjaxUrl(connection, "/send"),
                xhr,
                onFail = function (error, connection) {
                    $(connection).triggerHandler(events.onError, [signalR._.transportError(signalR.resources.sendFailed, connection.transport, error, xhr), data]);
                };


            xhr = transportLogic.ajax(connection, {
                url: url,
                type: connection.ajaxDataType === "jsonp" ? "GET" : "POST",
                contentType: signalR._.defaultContentType,
                headers: connection.accessToken ? { "Authorization": "Bearer " + connection.accessToken } : {},
                data: {
                    data: payload
                },
                success: function (result) {
                    var res;

                    if (result) {
                        try {
                            res = connection._parseResponse(result);
                        }
                        catch (error) {
                            onFail(error, connection);
                            connection.stop();
                            return;
                        }

                        transportLogic.triggerReceived(connection, res);
                    }
                },
                error: function (error, textStatus) {
                    if (textStatus === "abort" || textStatus === "parsererror") {
                        // The parsererror happens for sends that don't return any data, and hence
                        // don't write the jsonp callback to the response. This is harder to fix on the server
                        // so just hack around it on the client for now.
                        return;
                    }

                    onFail(error, connection);
                }
            });

            return xhr;
        },

        ajaxAbort: function (connection, async) {
            if (typeof (connection.transport) === "undefined") {
                return;
            }

            // Async by default unless explicitly overidden
            async = typeof async === "undefined" ? true : async;

            var url = getAjaxUrl(connection, "/abort");

            var requestHeaders = connection.accessToken ? { "Authorization": "Bearer " + connection.accessToken } : {};

            //option #1 - send "fetch" with keepalive
            if (window.fetch) {
                // use the fetch API with keepalive
                window.fetch(url, {
                    method: "POST",
                    keepalive: true,
                    headers: requestHeaders,
                    credentials: connection.withCredentials === true ? "include" : "same-origin"
                });
            }
            else { 
                // fetch is not available - fallback to $.ajax
                transportLogic.ajax(connection, {
                    url: url,
                    async: async,
                    timeout: 1000,
                    type: "POST",
                    headers: requestHeaders,
                    dataType: "text" // We don't want to use JSONP here even when JSONP is enabled
                });
            }

            connection.log("Fired ajax abort async = " + async + ".");
        },

        ajaxStart: function (connection, onSuccess) {
            var rejectDeferred = function (error) {
                    var deferred = connection._deferral;
                    if (deferred) {
                        deferred.reject(error);
                    }
                },
                triggerStartError = function (error) {
                    connection.log("The start request failed. Stopping the connection.");
                    $(connection).triggerHandler(events.onError, [error]);
                    rejectDeferred(error);
                    connection.stop();
                };

            connection._.startRequest = transportLogic.ajax(connection, {
                url: getAjaxUrl(connection, "/start"),
                headers: connection.accessToken ? { "Authorization": "Bearer " + connection.accessToken } : {},
                success: function (result, statusText, xhr) {
                    var data;

                    try {
                        data = connection._parseResponse(result);
                    } catch (error) {
                        triggerStartError(signalR._.error(
                            signalR._.format(signalR.resources.errorParsingStartResponse, result),
                            error, xhr));
                        return;
                    }

                    if (data.Response === "started") {
                        onSuccess();
                    } else {
                        triggerStartError(signalR._.error(
                            signalR._.format(signalR.resources.invalidStartResponse, result),
                            null /* error */, xhr));
                    }
                },
                error: function (xhr, statusText, error) {
                    if (statusText !== startAbortText) {
                        triggerStartError(signalR._.error(
                            signalR.resources.errorDuringStartRequest,
                            error, xhr));
                    } else {
                        // Stop has been called, no need to trigger the error handler
                        // or stop the connection again with onStartError
                        connection.log("The start request aborted because connection.stop() was called.");
                        rejectDeferred(signalR._.error(
                            signalR.resources.stoppedDuringStartRequest,
                            null /* error */, xhr));
                    }
                }
            });
        },

        tryAbortStartRequest: function (connection) {
            if (connection._.startRequest) {
                // If the start request has already completed this will noop.
                connection._.startRequest.abort(startAbortText);
                delete connection._.startRequest;
            }
        },

        tryInitialize: function (connection, persistentResponse, onInitialized) {
            if (persistentResponse.Initialized && onInitialized) {
                onInitialized();
            } else if (persistentResponse.Initialized) {
                connection.log("WARNING! The client received an init message after reconnecting.");
            }

        },

        triggerReceived: function (connection, data) {
            if (!connection._.connectingMessageBuffer.tryBuffer(data)) {
                $(connection).triggerHandler(events.onReceived, [data]);
            }
        },

        processMessages: function (connection, minData, onInitialized) {
            var data;

            if(minData && (typeof minData.I !== "undefined")) {
                // This is a response to a message the client sent
                transportLogic.triggerReceived(connection, minData);
                return;
            }

            // Update the last message time stamp
            transportLogic.markLastMessage(connection);

            if (minData) {
                // This is a message send directly to the client
                data = transportLogic.maximizePersistentResponse(minData);

                if (data.Error) {
                    // This is a global error, stop the connection.
                    connection.log("Received an error message from the server: " + minData.E);
                    $(connection).triggerHandler(signalR.events.onError, [signalR._.error(minData.E, /* source */ "ServerError")]);
                    connection.stop(/* async */ false, /* notifyServer */ false);
                    return;
                }

                transportLogic.updateGroups(connection, data.GroupsToken);

                if (data.MessageId) {
                    connection.messageId = data.MessageId;
                }

                if (data.Messages) {
                    $.each(data.Messages, function (index, message) {
                        transportLogic.triggerReceived(connection, message);
                    });

                    transportLogic.tryInitialize(connection, data, onInitialized);
                }
            }
        },

        monitorKeepAlive: function (connection) {
            var keepAliveData = connection._.keepAliveData;

            // If we haven't initiated the keep alive timeouts then we need to
            if (!keepAliveData.monitoring) {
                keepAliveData.monitoring = true;

                transportLogic.markLastMessage(connection);

                // Save the function so we can unbind it on stop
                connection._.keepAliveData.reconnectKeepAliveUpdate = function () {
                    // Mark a new message so that keep alive doesn't time out connections
                    transportLogic.markLastMessage(connection);
                };

                // Update Keep alive on reconnect
                $(connection).bind(events.onReconnect, connection._.keepAliveData.reconnectKeepAliveUpdate);

                connection.log("Now monitoring keep alive with a warning timeout of " + keepAliveData.timeoutWarning + ", keep alive timeout of " + keepAliveData.timeout + " and disconnecting timeout of " + connection.disconnectTimeout);
            } else {
                connection.log("Tried to monitor keep alive but it's already being monitored.");
            }
        },

        stopMonitoringKeepAlive: function (connection) {
            var keepAliveData = connection._.keepAliveData;

            // Only attempt to stop the keep alive monitoring if its being monitored
            if (keepAliveData.monitoring) {
                // Stop monitoring
                keepAliveData.monitoring = false;

                // Remove the updateKeepAlive function from the reconnect event
                $(connection).unbind(events.onReconnect, connection._.keepAliveData.reconnectKeepAliveUpdate);

                // Clear all the keep alive data
                connection._.keepAliveData = {};
                connection.log("Stopping the monitoring of the keep alive.");
            }
        },

        startHeartbeat: function (connection) {
            connection._.lastActiveAt = new Date().getTime();
            beat(connection);
        },

        markLastMessage: function (connection) {
            connection._.lastMessageAt = new Date().getTime();
            connection._.lastActiveAt = connection._.lastMessageAt;
        },

        markActive: function (connection) {
            if (transportLogic.verifyLastActive(connection)) {
                connection._.lastActiveAt = new Date().getTime();
                return true;
            }

            return false;
        },

        isConnectedOrReconnecting: function (connection) {
            return connection.state === signalR.connectionState.connected ||
                   connection.state === signalR.connectionState.reconnecting;
        },

        ensureReconnectingState: function (connection) {
            if (changeState(connection,
                        signalR.connectionState.connected,
                        signalR.connectionState.reconnecting) === true) {
                $(connection).triggerHandler(events.onReconnecting);
            }
            return connection.state === signalR.connectionState.reconnecting;
        },

        clearReconnectTimeout: function (connection) {
            if (connection && connection._.reconnectTimeout) {
                window.clearTimeout(connection._.reconnectTimeout);
                delete connection._.reconnectTimeout;
            }
        },

        verifyLastActive: function (connection) {
            // If there is no keep alive configured, we cannot assume that timer callbacks will
            // run frequently enough to keep lastActiveAt updated.
            // https://github.com/SignalR/SignalR/issues/4536
            if (!connection._.keepAliveData.activated ||
                new Date().getTime() - connection._.lastActiveAt < connection.reconnectWindow) {
                return true;
            }

            var message = signalR._.format(signalR.resources.reconnectWindowTimeout, new Date(connection._.lastActiveAt), connection.reconnectWindow);
            connection.log(message);
            $(connection).triggerHandler(events.onError, [signalR._.error(message, /* source */ "TimeoutException")]);
            connection.stop(/* async */ false, /* notifyServer */ false);
            return false;
        },

        reconnect: function (connection, transportName) {
            var transport = signalR.transports[transportName];

            // We should only set a reconnectTimeout if we are currently connected
            // and a reconnectTimeout isn't already set.
            if (transportLogic.isConnectedOrReconnecting(connection) && !connection._.reconnectTimeout) {
                // Need to verify before the setTimeout occurs because an application sleep could occur during the setTimeout duration.
                if (!transportLogic.verifyLastActive(connection)) {
                    return;
                }

                connection._.reconnectTimeout = window.setTimeout(function () {
                    if (!transportLogic.verifyLastActive(connection)) {
                        return;
                    }

                    transport.stop(connection);

                    if (transportLogic.ensureReconnectingState(connection)) {
                        connection.log(transportName + " reconnecting.");
                        transport.start(connection);
                    }
                }, connection.reconnectDelay);
            }
        },

        handleParseFailure: function (connection, result, error, onFailed, context) {
            var wrappedError = signalR._.transportError(
                signalR._.format(signalR.resources.parseFailed, result),
                connection.transport,
                error,
                context);

            // If we're in the initialization phase trigger onFailed, otherwise stop the connection.
            if (onFailed && onFailed(wrappedError)) {
                connection.log("Failed to parse server response while attempting to connect.");
            } else {
                $(connection).triggerHandler(events.onError, [wrappedError]);
                connection.stop();
            }
        },

        initHandler: function (connection) {
            return new InitHandler(connection);
        },

        foreverFrame: {
            count: 0,
            connections: {}
        }
    };

}(window.jQuery, window));
/* jquery.signalR.transports.webSockets.js */
// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.


/*global window:false */
/// <reference path="jquery.signalR.transports.common.js" />

(function ($, window, undefined) {

    var signalR = $.signalR,
        events = $.signalR.events,
        changeState = $.signalR.changeState,
        transportLogic = signalR.transports._logic;

    signalR.transports.webSockets = {
        name: "webSockets",

        supportsKeepAlive: function () {
            return true;
        },

        send: function (connection, data) {
            var payload = transportLogic.stringifySend(connection, data);

            try {
                connection.socket.send(payload);
            } catch (ex) {
                $(connection).triggerHandler(events.onError,
                    [signalR._.transportError(
                        signalR.resources.webSocketsInvalidState,
                        connection.transport,
                        ex,
                        connection.socket
                    ),
                    data]);
            }
        },

        start: function (connection, onSuccess, onFailed) {
            var url,
                opened = false,
                that = this,
                reconnecting = !onSuccess,
                $connection = $(connection);

            if (!window.WebSocket) {
                onFailed();
                return;
            }

            if (!connection.socket) {
                if (connection.webSocketServerUrl) {
                    url = connection.webSocketServerUrl;
                } else {
                    url = connection.wsProtocol + connection.host;
                }

                url += transportLogic.getUrl(connection, this.name, reconnecting);

                connection.log("Connecting to websocket endpoint '" + url + "'.");
                connection.socket = new window.WebSocket(url);

                connection.socket.onopen = function () {
                    opened = true;
                    connection.log("Websocket opened.");

                    transportLogic.clearReconnectTimeout(connection);

                    if (changeState(connection,
                                    signalR.connectionState.reconnecting,
                                    signalR.connectionState.connected) === true) {
                        $connection.triggerHandler(events.onReconnect);
                    }
                };

                connection.socket.onclose = function (event) {
                    var error;

                    // Only handle a socket close if the close is from the current socket.
                    // Sometimes on disconnect the server will push down an onclose event
                    // to an expired socket.

                    if (this === connection.socket) {
                        if (opened && typeof event.wasClean !== "undefined" && event.wasClean === false) {
                            // Ideally this would use the websocket.onerror handler (rather than checking wasClean in onclose) but
                            // I found in some circumstances Chrome won't call onerror. This implementation seems to work on all browsers.
                            error = signalR._.transportError(
                                signalR.resources.webSocketClosed,
                                connection.transport,
                                event);

                            connection.log("Unclean disconnect from websocket: " + (event.reason || "[no reason given]."));
                        } else {
                            connection.log("Websocket closed.");
                        }

                        if (!onFailed || !onFailed(error)) {
                            if (error) {
                                $(connection).triggerHandler(events.onError, [error]);
                            }

                            that.reconnect(connection);
                        }
                    }
                };

                connection.socket.onmessage = function (event) {
                    var data;

                    try {
                        data = connection._parseResponse(event.data);
                    }
                    catch (error) {
                        transportLogic.handleParseFailure(connection, event.data, error, onFailed, event);
                        return;
                    }

                    if (data) {
                        transportLogic.processMessages(connection, data, onSuccess);
                    }
                };
            }
        },

        reconnect: function (connection) {
            transportLogic.reconnect(connection, this.name);
        },

        lostConnection: function (connection) {
            this.reconnect(connection);
        },

        stop: function (connection) {
            // Don't trigger a reconnect after stopping
            transportLogic.clearReconnectTimeout(connection);

            if (connection.socket) {
                connection.log("Closing the Websocket.");
                connection.socket.close();
                connection.socket = null;
            }
        },

        abort: function (connection, async) {
            transportLogic.ajaxAbort(connection, async);
        }
    };

}(window.jQuery, window));
/* jquery.signalR.transports.serverSentEvents.js */
// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.


/*global window:false */
/// <reference path="jquery.signalR.transports.common.js" />

(function ($, window, undefined) {

    var signalR = $.signalR,
        events = $.signalR.events,
        changeState = $.signalR.changeState,
        transportLogic = signalR.transports._logic,
        clearReconnectAttemptTimeout = function (connection) {
            window.clearTimeout(connection._.reconnectAttemptTimeoutHandle);
            delete connection._.reconnectAttemptTimeoutHandle;
        };

    signalR.transports.serverSentEvents = {
        name: "serverSentEvents",

        supportsKeepAlive: function () {
            return true;
        },

        timeOut: 3000,

        start: function (connection, onSuccess, onFailed) {
            var that = this,
                opened = false,
                $connection = $(connection),
                reconnecting = !onSuccess,
                url;

            if (connection.eventSource) {
                connection.log("The connection already has an event source. Stopping it.");
                connection.stop();
            }

            if (!window.EventSource) {
                if (onFailed) {
                    connection.log("This browser doesn't support SSE.");
                    onFailed();
                }
                return;
            }

            url = transportLogic.getUrl(connection, this.name, reconnecting);

            try {
                connection.log("Attempting to connect to SSE endpoint '" + url + "'.");
                connection.eventSource = new window.EventSource(url, { withCredentials: connection.withCredentials });
            }
            catch (e) {
                connection.log("EventSource failed trying to connect with error " + e.Message + ".");
                if (onFailed) {
                    // The connection failed, call the failed callback
                    onFailed();
                } else {
                    $connection.triggerHandler(events.onError, [signalR._.transportError(signalR.resources.eventSourceFailedToConnect, connection.transport, e)]);
                    if (reconnecting) {
                        // If we were reconnecting, rather than doing initial connect, then try reconnect again
                        that.reconnect(connection);
                    }
                }
                return;
            }

            if (reconnecting) {
                connection._.reconnectAttemptTimeoutHandle = window.setTimeout(function () {
                    if (opened === false) {
                        // If we're reconnecting and the event source is attempting to connect,
                        // don't keep retrying. This causes duplicate connections to spawn.
                        if (connection.eventSource.readyState !== window.EventSource.OPEN) {
                            // If we were reconnecting, rather than doing initial connect, then try reconnect again
                            that.reconnect(connection);
                        }
                    }
                },
                that.timeOut);
            }

            connection.eventSource.addEventListener("open", function (e) {
                connection.log("EventSource connected.");

                clearReconnectAttemptTimeout(connection);
                transportLogic.clearReconnectTimeout(connection);

                if (opened === false) {
                    opened = true;

                    if (changeState(connection,
                                         signalR.connectionState.reconnecting,
                                         signalR.connectionState.connected) === true) {
                        $connection.triggerHandler(events.onReconnect);
                    }
                }
            }, false);

            connection.eventSource.addEventListener("message", function (e) {
                var res;

                // process messages
                if (e.data === "initialized") {
                    return;
                }

                try {
                    res = connection._parseResponse(e.data);
                }
                catch (error) {
                    transportLogic.handleParseFailure(connection, e.data, error, onFailed, e);
                    return;
                }

                transportLogic.processMessages(connection, res, onSuccess);
            }, false);

            connection.eventSource.addEventListener("error", function (e) {
                var error = signalR._.transportError(
                    signalR.resources.eventSourceError,
                    connection.transport,
                    e);

                // Only handle an error if the error is from the current Event Source.
                // Sometimes on disconnect the server will push down an error event
                // to an expired Event Source.
                if (this !== connection.eventSource) {
                    return;
                }

                if (onFailed && onFailed(error)) {
                    return;
                }

                connection.log("EventSource readyState: " + connection.eventSource.readyState + ".");

                if (e.eventPhase === window.EventSource.CLOSED) {
                    // We don't use the EventSource's native reconnect function as it
                    // doesn't allow us to change the URL when reconnecting. We need
                    // to change the URL to not include the /connect suffix, and pass
                    // the last message id we received.
                    connection.log("EventSource reconnecting due to the server connection ending.");
                    that.reconnect(connection);
                } else {
                    // connection error
                    connection.log("EventSource error.");
                    $connection.triggerHandler(events.onError, [error]);
                }
            }, false);
        },

        reconnect: function (connection) {
            transportLogic.reconnect(connection, this.name);
        },

        lostConnection: function (connection) {
            this.reconnect(connection);
        },

        send: function (connection, data) {
            transportLogic.ajaxSend(connection, data);
        },

        stop: function (connection) {
            // Don't trigger a reconnect after stopping
            clearReconnectAttemptTimeout(connection);
            transportLogic.clearReconnectTimeout(connection);

            if (connection && connection.eventSource) {
                connection.log("EventSource calling close().");
                connection.eventSource.close();
                connection.eventSource = null;
                delete connection.eventSource;
            }
        },

        abort: function (connection, async) {
            transportLogic.ajaxAbort(connection, async);
        }
    };

}(window.jQuery, window));
/* jquery.signalR.transports.foreverFrame.js */
// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.


/*global window:false */
/// <reference path="jquery.signalR.transports.common.js" />

(function ($, window, undefined) {

    var signalR = $.signalR,
        events = $.signalR.events,
        changeState = $.signalR.changeState,
        transportLogic = signalR.transports._logic,
        createFrame = function () {
            var frame = window.document.createElement("iframe");
            frame.setAttribute("style", "position:absolute;top:0;left:0;width:0;height:0;visibility:hidden;");
            return frame;
        },
        // Used to prevent infinite loading icon spins in older versions of ie
        // We build this object inside a closure so we don't pollute the rest of
        // the foreverFrame transport with unnecessary functions/utilities.
        loadPreventer = (function () {
            var loadingFixIntervalId = null,
                loadingFixInterval = 1000,
                attachedTo = 0;

            return {
                prevent: function () {
                    // Prevent additional iframe removal procedures from newer browsers
                    if (signalR._.ieVersion <= 8) {
                        // We only ever want to set the interval one time, so on the first attachedTo
                        if (attachedTo === 0) {
                            // Create and destroy iframe every 3 seconds to prevent loading icon, super hacky
                            loadingFixIntervalId = window.setInterval(function () {
                                var tempFrame = createFrame();

                                window.document.body.appendChild(tempFrame);
                                window.document.body.removeChild(tempFrame);

                                tempFrame = null;
                            }, loadingFixInterval);
                        }

                        attachedTo++;
                    }
                },
                cancel: function () {
                    // Only clear the interval if there's only one more object that the loadPreventer is attachedTo
                    if (attachedTo === 1) {
                        window.clearInterval(loadingFixIntervalId);
                    }

                    if (attachedTo > 0) {
                        attachedTo--;
                    }
                }
            };
        })();

    signalR.transports.foreverFrame = {
        name: "foreverFrame",

        supportsKeepAlive: function () {
            return true;
        },

        // Added as a value here so we can create tests to verify functionality
        iframeClearThreshold: 50,

        start: function (connection, onSuccess, onFailed) {
            if (connection.accessToken) {
                if (onFailed) {
                    connection.log("Forever Frame does not support connections that require a Bearer token to connect, such as the Azure SignalR Service.");
                    onFailed();
                }
                return;
            }

            var that = this,
                frameId = (transportLogic.foreverFrame.count += 1),
                url,
                frame = createFrame(),
                frameLoadHandler = function () {
                    connection.log("Forever frame iframe finished loading and is no longer receiving messages.");
                    if (!onFailed || !onFailed()) {
                        that.reconnect(connection);
                    }
                };

            if (window.EventSource) {
                // If the browser supports SSE, don't use Forever Frame
                if (onFailed) {
                    connection.log("Forever Frame is not supported by SignalR on browsers with SSE support.");
                    onFailed();
                }
                return;
            }

            frame.setAttribute("data-signalr-connection-id", connection.id);

            // Start preventing loading icon
            // This will only perform work if the loadPreventer is not attached to another connection.
            loadPreventer.prevent();

            // Build the url
            url = transportLogic.getUrl(connection, this.name);
            url += "&frameId=" + frameId;

            // add frame to the document prior to setting URL to avoid caching issues.
            window.document.documentElement.appendChild(frame);

            connection.log("Binding to iframe's load event.");

            if (frame.addEventListener) {
                frame.addEventListener("load", frameLoadHandler, false);
            } else if (frame.attachEvent) {
                frame.attachEvent("onload", frameLoadHandler);
            }

            frame.src = url;
            transportLogic.foreverFrame.connections[frameId] = connection;

            connection.frame = frame;
            connection.frameId = frameId;

            if (onSuccess) {
                connection.onSuccess = function () {
                    connection.log("Iframe transport started.");
                    onSuccess();
                };
            }
        },

        reconnect: function (connection) {
            var that = this;

            // Need to verify connection state and verify before the setTimeout occurs because an application sleep could occur during the setTimeout duration.
            if (transportLogic.isConnectedOrReconnecting(connection) && transportLogic.verifyLastActive(connection)) {
                window.setTimeout(function () {
                    // Verify that we're ok to reconnect.
                    if (!transportLogic.verifyLastActive(connection)) {
                        return;
                    }

                    if (connection.frame && transportLogic.ensureReconnectingState(connection)) {
                        var frame = connection.frame,
                            src = transportLogic.getUrl(connection, that.name, true) + "&frameId=" + connection.frameId;
                        connection.log("Updating iframe src to '" + src + "'.");
                        frame.src = src;
                    }
                }, connection.reconnectDelay);
            }
        },

        lostConnection: function (connection) {
            this.reconnect(connection);
        },

        send: function (connection, data) {
            transportLogic.ajaxSend(connection, data);
        },

        receive: function (connection, data) {
            var cw,
                body,
                response;

            if (connection.json !== connection._originalJson) {
                // If there's a custom JSON parser configured then serialize the object
                // using the original (browser) JSON parser and then deserialize it using
                // the custom parser (connection._parseResponse does that). This is so we
                // can easily send the response from the server as "raw" JSON but still
                // support custom JSON deserialization in the browser.
                data = connection._originalJson.stringify(data);
            }

            response = connection._parseResponse(data);

            transportLogic.processMessages(connection, response, connection.onSuccess);

            // Protect against connection stopping from a callback trigger within the processMessages above.
            if (connection.state === $.signalR.connectionState.connected) {
                // Delete the script & div elements
                connection.frameMessageCount = (connection.frameMessageCount || 0) + 1;
                if (connection.frameMessageCount > signalR.transports.foreverFrame.iframeClearThreshold) {
                    connection.frameMessageCount = 0;
                    cw = connection.frame.contentWindow || connection.frame.contentDocument;
                    if (cw && cw.document && cw.document.body) {
                        body = cw.document.body;

                        // Remove all the child elements from the iframe's body to conserver memory
                        while (body.firstChild) {
                            body.removeChild(body.firstChild);
                        }
                    }
                }
            }
        },

        stop: function (connection) {
            var cw = null;

            // Stop attempting to prevent loading icon
            loadPreventer.cancel();

            if (connection.frame) {
                if (connection.frame.stop) {
                    connection.frame.stop();
                } else {
                    try {
                        cw = connection.frame.contentWindow || connection.frame.contentDocument;
                        if (cw.document && cw.document.execCommand) {
                            cw.document.execCommand("Stop");
                        }
                    }
                    catch (e) {
                        connection.log("Error occurred when stopping foreverFrame transport. Message = " + e.message + ".");
                    }
                }

                // Ensure the iframe is where we left it
                if (connection.frame.parentNode === window.document.documentElement) {
                    window.document.documentElement.removeChild(connection.frame);
                }

                delete transportLogic.foreverFrame.connections[connection.frameId];
                connection.frame = null;
                connection.frameId = null;
                delete connection.frame;
                delete connection.frameId;
                delete connection.onSuccess;
                delete connection.frameMessageCount;
                connection.log("Stopping forever frame.");
            }
        },

        abort: function (connection, async) {
            transportLogic.ajaxAbort(connection, async);
        },

        getConnection: function (id) {
            return transportLogic.foreverFrame.connections[id];
        },

        started: function (connection) {
            if (changeState(connection,
                signalR.connectionState.reconnecting,
                signalR.connectionState.connected) === true) {

                $(connection).triggerHandler(events.onReconnect);
            }
        }
    };

}(window.jQuery, window));
/* jquery.signalR.transports.longPolling.js */
// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.


/*global window:false */
/// <reference path="jquery.signalR.transports.common.js" />

(function ($, window, undefined) {

    var signalR = $.signalR,
        events = $.signalR.events,
        changeState = $.signalR.changeState,
        isDisconnecting = $.signalR.isDisconnecting,
        transportLogic = signalR.transports._logic;

    signalR.transports.longPolling = {
        name: "longPolling",

        supportsKeepAlive: function () {
            return false;
        },

        reconnectDelay: 3000,

        start: function (connection, onSuccess, onFailed) {
            /// <summary>Starts the long polling connection</summary>
            /// <param name="connection" type="signalR">The SignalR connection to start</param>
            var that = this,
                fireConnect = function () {
                    fireConnect = $.noop;

                    connection.log("LongPolling connected.");

                    if (onSuccess) {
                        onSuccess();
                    } else {
                        connection.log("WARNING! The client received an init message after reconnecting.");
                    }
                },
                tryFailConnect = function (error) {
                    if (onFailed(error)) {
                        connection.log("LongPolling failed to connect.");
                        return true;
                    }

                    return false;
                },
                privateData = connection._,
                reconnectErrors = 0,
                fireReconnected = function (instance) {
                    window.clearTimeout(privateData.reconnectTimeoutId);
                    privateData.reconnectTimeoutId = null;

                    if (changeState(instance,
                                    signalR.connectionState.reconnecting,
                                    signalR.connectionState.connected) === true) {
                        // Successfully reconnected!
                        instance.log("Raising the reconnect event");
                        $(instance).triggerHandler(events.onReconnect);
                    }
                },
                // 1 hour
                maxFireReconnectedTimeout = 3600000;

            if (connection.pollXhr) {
                connection.log("Polling xhr requests already exists, aborting.");
                connection.stop();
            }

            connection.messageId = null;

            privateData.reconnectTimeoutId = null;

            privateData.pollTimeoutId = window.setTimeout(function () {
                (function poll(instance, raiseReconnect) {
                    var messageId = instance.messageId,
                        connect = (messageId === null),
                        reconnecting = !connect,
                        polling = !raiseReconnect,
                        url = transportLogic.getUrl(instance, that.name, reconnecting, polling, true /* use Post for longPolling */),
                        postData = {};

                    if (instance.messageId) {
                        postData.messageId = instance.messageId;
                    }

                    if (instance.groupsToken) {
                        postData.groupsToken = instance.groupsToken;
                    }

                    // If we've disconnected during the time we've tried to re-instantiate the poll then stop.
                    if (isDisconnecting(instance) === true) {
                        return;
                    }

                    connection.log("Opening long polling request to '" + url + "'.");
                    instance.pollXhr = transportLogic.ajax(connection, {
                        xhrFields: {
                            onprogress: function () {
                                transportLogic.markLastMessage(connection);
                            }
                        },
                        url: url,
                        type: "POST",
                        contentType: signalR._.defaultContentType,
                        data: postData,
                        timeout: connection._.pollTimeout,
                        headers: connection.accessToken ? { "Authorization": "Bearer " + connection.accessToken } : {},
                        success: function (result) {
                            var minData,
                                delay = 0,
                                data,
                                shouldReconnect;

                            connection.log("Long poll complete.");

                            // Reset our reconnect errors so if we transition into a reconnecting state again we trigger
                            // reconnected quickly
                            reconnectErrors = 0;

                            try {
                                // Remove any keep-alives from the beginning of the result
                                minData = connection._parseResponse(result);
                            }
                            catch (error) {
                                transportLogic.handleParseFailure(instance, result, error, tryFailConnect, instance.pollXhr);
                                return;
                            }

                            // If there's currently a timeout to trigger reconnect, fire it now before processing messages
                            if (privateData.reconnectTimeoutId !== null) {
                                fireReconnected(instance);
                            }

                            if (minData) {
                                data = transportLogic.maximizePersistentResponse(minData);
                            }

                            transportLogic.processMessages(instance, minData, fireConnect);

                            if (data &&
                                $.type(data.LongPollDelay) === "number") {
                                delay = data.LongPollDelay;
                            }

                            if (isDisconnecting(instance) === true) {
                                return;
                            }

                            shouldReconnect = data && data.ShouldReconnect;
                            if (shouldReconnect) {
                                // Transition into the reconnecting state
                                // If this fails then that means that the user transitioned the connection into a invalid state in processMessages.
                                if (!transportLogic.ensureReconnectingState(instance)) {
                                    return;
                                }
                            }

                            // We never want to pass a raiseReconnect flag after a successful poll.  This is handled via the error function
                            if (delay > 0) {
                                privateData.pollTimeoutId = window.setTimeout(function () {
                                    poll(instance, shouldReconnect);
                                }, delay);
                            } else {
                                poll(instance, shouldReconnect);
                            }
                        },

                        error: function (data, textStatus) {
                            var error = signalR._.transportError(signalR.resources.longPollFailed, connection.transport, data, instance.pollXhr);

                            // Stop trying to trigger reconnect, connection is in an error state
                            // If we're not in the reconnect state this will noop
                            window.clearTimeout(privateData.reconnectTimeoutId);
                            privateData.reconnectTimeoutId = null;

                            if (textStatus === "abort") {
                                connection.log("Aborted xhr request.");
                                return;
                            }

                            if (!tryFailConnect(error)) {

                                // Increment our reconnect errors, we assume all errors to be reconnect errors
                                // In the case that it's our first error this will cause Reconnect to be fired
                                // after 1 second due to reconnectErrors being = 1.
                                reconnectErrors++;

                                if (connection.state !== signalR.connectionState.reconnecting) {
                                    connection.log("An error occurred using longPolling. Status = " + textStatus + ".  Response = " + data.responseText + ".");
                                    $(instance).triggerHandler(events.onError, [error]);
                                }

                                // We check the state here to verify that we're not in an invalid state prior to verifying Reconnect.
                                // If we're not in connected or reconnecting then the next ensureReconnectingState check will fail and will return.
                                // Therefore we don't want to change that failure code path.
                                if ((connection.state === signalR.connectionState.connected ||
                                    connection.state === signalR.connectionState.reconnecting) &&
                                    !transportLogic.verifyLastActive(connection)) {
                                    return;
                                }

                                // Transition into the reconnecting state
                                // If this fails then that means that the user transitioned the connection into the disconnected or connecting state within the above error handler trigger.
                                if (!transportLogic.ensureReconnectingState(instance)) {
                                    return;
                                }

                                // Call poll with the raiseReconnect flag as true after the reconnect delay
                                privateData.pollTimeoutId = window.setTimeout(function () {
                                    poll(instance, true);
                                }, that.reconnectDelay);
                            }
                        }
                    });

                    // This will only ever pass after an error has occurred via the poll ajax procedure.
                    if (reconnecting && raiseReconnect === true) {
                        // We wait to reconnect depending on how many times we've failed to reconnect.
                        // This is essentially a heuristic that will exponentially increase in wait time before
                        // triggering reconnected.  This depends on the "error" handler of Poll to cancel this
                        // timeout if it triggers before the Reconnected event fires.
                        // The Math.min at the end is to ensure that the reconnect timeout does not overflow.
                        privateData.reconnectTimeoutId = window.setTimeout(function () { fireReconnected(instance); }, Math.min(1000 * (Math.pow(2, reconnectErrors) - 1), maxFireReconnectedTimeout));
                    }
                }(connection));
            }, 250); // Have to delay initial poll so Chrome doesn't show loader spinner in tab
        },

        lostConnection: function (connection) {
            if (connection.pollXhr) {
                connection.pollXhr.abort("lostConnection");
            }
        },

        send: function (connection, data) {
            transportLogic.ajaxSend(connection, data);
        },

        stop: function (connection) {
            /// <summary>Stops the long polling connection</summary>
            /// <param name="connection" type="signalR">The SignalR connection to stop</param>

            window.clearTimeout(connection._.pollTimeoutId);
            window.clearTimeout(connection._.reconnectTimeoutId);

            delete connection._.pollTimeoutId;
            delete connection._.reconnectTimeoutId;

            if (connection.pollXhr) {
                connection.pollXhr.abort();
                connection.pollXhr = null;
                delete connection.pollXhr;
            }
        },

        abort: function (connection, async) {
            transportLogic.ajaxAbort(connection, async);
        }
    };

}(window.jQuery, window));
/* jquery.signalR.hubs.js */
// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.

/*global window:false */
/// <reference path="jquery.signalR.core.js" />

(function ($, window, undefined) {

    var nextGuid = 0;
    var eventNamespace = ".hubProxy",
        signalR = $.signalR;

    function makeEventName(event) {
        return event + eventNamespace;
    }

    // Equivalent to Array.prototype.map
    function map(arr, fun, thisp) {
        var i,
            length = arr.length,
            result = [];
        for (i = 0; i < length; i += 1) {
            if (arr.hasOwnProperty(i)) {
                result[i] = fun.call(thisp, arr[i], i, arr);
            }
        }
        return result;
    }

    function getArgValue(a) {
        return $.isFunction(a) ? null : ($.type(a) === "undefined" ? null : a);
    }

    function hasMembers(obj) {
        for (var key in obj) {
            // If we have any properties in our callback map then we have callbacks and can exit the loop via return
            if (obj.hasOwnProperty(key)) {
                return true;
            }
        }

        return false;
    }

    function clearInvocationCallbacks(connection, error) {
        /// <param name="connection" type="hubConnection" />
        var callbacks = connection._.invocationCallbacks,
            callback;

        if (hasMembers(callbacks)) {
            connection.log("Clearing hub invocation callbacks with error: " + error + ".");
        }

        // Reset the callback cache now as we have a local var referencing it
        connection._.invocationCallbackId = 0;
        delete connection._.invocationCallbacks;
        connection._.invocationCallbacks = {};

        // Loop over the callbacks and invoke them.
        // We do this using a local var reference and *after* we've cleared the cache
        // so that if a fail callback itself tries to invoke another method we don't
        // end up with its callback in the list we're looping over.
        for (var callbackId in callbacks) {
            callback = callbacks[callbackId];
            callback.method.call(callback.scope, { E: error });
        }
    }

    function isCallbackFromGeneratedHubProxy(callback) {
        // https://github.com/SignalR/SignalR/issues/4310
        // The stringified callback from the old generated hub proxy is 137 characters in Edge, Firefox and Chrome.
        // We slice to avoid wasting too many cycles searching through the text of a long large function.
        return $.isFunction(callback) && callback.toString().slice(0, 256).indexOf("// Call the client hub method") >= 0;
    }

    // hubProxy
    function hubProxy(hubConnection, hubName) {
        /// <summary>
        ///     Creates a new proxy object for the given hub connection that can be used to invoke
        ///     methods on server hubs and handle client method invocation requests from the server.
        /// </summary>
        return new hubProxy.fn.init(hubConnection, hubName);
    }

    hubProxy.fn = hubProxy.prototype = {
        init: function (connection, hubName) {
            this.state = {};
            this.connection = connection;
            this.hubName = hubName;
            this._ = {
                callbackMap: {}
            };
        },

        constructor: hubProxy,

        hasSubscriptions: function () {
            return hasMembers(this._.callbackMap);
        },

        on: function (eventName, callback, callbackIdentity) {
            /// <summary>Wires up a callback to be invoked when a invocation request is received from the server hub.</summary>
            /// <param name="eventName" type="String">The name of the hub event to register the callback for.</param>
            /// <param name="callback" type="Function">The callback to be invoked.</param>
            /// <param name="callbackIdentity" type="Object">An optional object to use as the "identity" for the callback when checking if the handler has already been registered. Defaults to the value of 'callback' if not provided.</param>
            var that = this,
                callbackMap = that._.callbackMap,
                isFromOldGeneratedHubProxy = !callbackIdentity && isCallbackFromGeneratedHubProxy(callback);

            // We need the third "identity" argument because the registerHubProxies call made by signalr/js wraps the user-provided callback in a custom wrapper which breaks the identity comparison.
            // callbackIdentity allows the caller of `on` to provide a separate object to use as the "identity". `registerHubProxies` uses the original user callback as this identity object.
            callbackIdentity = callbackIdentity || callback;

            // Assign a global ID to the identity object. This tags the object so we can detect the same object when it comes back.
            if(!callbackIdentity._signalRGuid) {
                callbackIdentity._signalRGuid = nextGuid++;
            }

            // Normalize the event name to lowercase
            eventName = eventName.toLowerCase();

            // If there is not an event registered for this callback yet we want to create its event space in the callback map.
            var callbackSpace = callbackMap[eventName];
            if (!callbackSpace) {
                callbackSpace = [];
                callbackMap[eventName] = callbackSpace;
            }

            // Check if there's already a registration
            var registration;
            for (var i = 0; i < callbackSpace.length; i++) {
                if (callbackSpace[i].guid === callbackIdentity._signalRGuid || (isFromOldGeneratedHubProxy && callbackSpace[i].isFromOldGeneratedHubProxy)) {
                    registration = callbackSpace[i];
                }
            }

            // Create a registration if there isn't one already
            if (!registration) {
                registration = {
                    guid: callbackIdentity._signalRGuid,
                    eventHandlers: [],
                    isFromOldGeneratedHubProxy: isFromOldGeneratedHubProxy
                };
                callbackMap[eventName].push(registration);
            }

            var handler = function (e, data) {
                callback.apply(that, data);
            };
            registration.eventHandlers.push(handler);

            $(that).bind(makeEventName(eventName), handler);

            return that;
        },

        off: function (eventName, callback, callbackIdentity) {
            /// <summary>Removes the callback invocation request from the server hub for the given event name.</summary>
            /// <param name="eventName" type="String">The name of the hub event to unregister the callback for.</param>
            /// <param name="callback" type="Function">The callback to be removed.</param>
            /// <param name="callbackIdentity" type="Object">An optional object to use as the "identity" when looking up the callback. Corresponds to the same parameter provided to 'on'. Defaults to the value of 'callback' if not provided.</param>
            var that = this,
                callbackMap = that._.callbackMap,
                callbackSpace,
                isFromOldGeneratedHubProxy = !callbackIdentity && isCallbackFromGeneratedHubProxy(callback);

            callbackIdentity = callbackIdentity || callback;

            // Normalize the event name to lowercase
            eventName = eventName.toLowerCase();

            callbackSpace = callbackMap[eventName];

            // Verify that there is an event space to unbind
            if (callbackSpace) {

                if (callback) {
                    // Find the callback registration
                    var callbackRegistration;
                    var callbackIndex;
                    for (var i = 0; i < callbackSpace.length; i++) {
                        if (callbackSpace[i].guid === callbackIdentity._signalRGuid || (isFromOldGeneratedHubProxy && callbackSpace[i].isFromOldGeneratedHubProxy)) {
                            callbackIndex = i;
                            callbackRegistration = callbackSpace[i];
                        }
                    }

                    // Only unbind if there's an event bound with eventName and a callback with the specified callback
                    if (callbackRegistration) {
                        // Unbind all event handlers associated with the registration.
                        for (var j = 0; j < callbackRegistration.eventHandlers.length; j++) {
                            $(that).unbind(makeEventName(eventName), callbackRegistration.eventHandlers[j]);
                        }

                        // Remove the registration from the list
                        callbackSpace.splice(i, 1);

                        // Check if there are any registrations left, if not we need to destroy it.
                        if (callbackSpace.length === 0) {
                            delete callbackMap[eventName];
                        }
                    }
                } else if (!callback) { // Check if we're removing the whole event and we didn't error because of an invalid callback
                    $(that).unbind(makeEventName(eventName));

                    delete callbackMap[eventName];
                }
            }

            return that;
        },

        invoke: function (methodName) {
            /// <summary>Invokes a server hub method with the given arguments.</summary>
            /// <param name="methodName" type="String">The name of the server hub method.</param>

            var that = this,
                connection = that.connection,
                args = $.makeArray(arguments).slice(1),
                argValues = map(args, getArgValue),
                data = { H: that.hubName, M: methodName, A: argValues, I: connection._.invocationCallbackId },
                d = $.Deferred(),
                callback = function (minResult) {
                    var result = that._maximizeHubResponse(minResult),
                        source,
                        error;

                    // Update the hub state
                    $.extend(that.state, result.State);

                    if (result.Progress) {
                        if (d.notifyWith) {
                            // Progress is only supported in jQuery 1.7+
                            d.notifyWith(that, [result.Progress.Data]);
                        } else if (!connection._.progressjQueryVersionLogged) {
                            connection.log("A hub method invocation progress update was received but the version of jQuery in use (" + $.prototype.jquery + ") does not support progress updates. Upgrade to jQuery 1.7+ to receive progress notifications.");
                            connection._.progressjQueryVersionLogged = true;
                        }
                    } else if (result.Error) {
                        // Server hub method threw an exception, log it & reject the deferred
                        if (result.StackTrace) {
                            connection.log(result.Error + "\n" + result.StackTrace + ".");
                        }

                        // result.ErrorData is only set if a HubException was thrown
                        source = result.IsHubException ? "HubException" : "Exception";
                        error = signalR._.error(result.Error, source);
                        error.data = result.ErrorData;

                        connection.log(that.hubName + "." + methodName + " failed to execute. Error: " + error.message);
                        d.rejectWith(that, [error]);
                    } else {
                        // Server invocation succeeded, resolve the deferred
                        connection.log("Invoked " + that.hubName + "." + methodName);
                        d.resolveWith(that, [result.Result]);
                    }
                };

            connection._.invocationCallbacks[connection._.invocationCallbackId.toString()] = { scope: that, method: callback };
            connection._.invocationCallbackId += 1;

            if (!$.isEmptyObject(that.state)) {
                data.S = that.state;
            }

            connection.log("Invoking " + that.hubName + "." + methodName);
            connection.send(data);

            return d.promise();
        },

        _maximizeHubResponse: function (minHubResponse) {
            return {
                State: minHubResponse.S,
                Result: minHubResponse.R,
                Progress: minHubResponse.P ? {
                    Id: minHubResponse.P.I,
                    Data: minHubResponse.P.D
                } : null,
                Id: minHubResponse.I,
                IsHubException: minHubResponse.H,
                Error: minHubResponse.E,
                StackTrace: minHubResponse.T,
                ErrorData: minHubResponse.D
            };
        }
    };

    hubProxy.fn.init.prototype = hubProxy.fn;

    // hubConnection
    function hubConnection(url, options) {
        /// <summary>Creates a new hub connection.</summary>
        /// <param name="url" type="String">[Optional] The hub route url, defaults to "/signalr".</param>
        /// <param name="options" type="Object">[Optional] Settings to use when creating the hubConnection.</param>
        var settings = {
            qs: null,
            logging: false,
            useDefaultPath: true
        };

        $.extend(settings, options);

        if (!url || settings.useDefaultPath) {
            url = (url || "") + "/signalr";
        }
        return new hubConnection.fn.init(url, settings);
    }

    hubConnection.fn = hubConnection.prototype = $.connection();

    hubConnection.fn.init = function (url, options) {
        var settings = {
            qs: null,
            logging: false,
            useDefaultPath: true
        },
            connection = this;

        $.extend(settings, options);

        // Call the base constructor
        $.signalR.fn.init.call(connection, url, settings.qs, settings.logging);

        // Object to store hub proxies for this connection
        connection.proxies = {};

        connection._.invocationCallbackId = 0;
        connection._.invocationCallbacks = {};

        // Wire up the received handler
        connection.received(function (minData) {
            var data, proxy, dataCallbackId, callback, hubName, eventName;
            if (!minData) {
                return;
            }

            // We have to handle progress updates first in order to ensure old clients that receive
            // progress updates enter the return value branch and then no-op when they can't find
            // the callback in the map (because the minData.I value will not be a valid callback ID)
            // Process progress notification
            if (typeof (minData.P) !== "undefined") {
                dataCallbackId = minData.P.I.toString();
                callback = connection._.invocationCallbacks[dataCallbackId];
                if (callback) {
                    callback.method.call(callback.scope, minData);
                }
            } else if (typeof (minData.I) !== "undefined") {
                // We received the return value from a server method invocation, look up callback by id and call it
                dataCallbackId = minData.I.toString();
                callback = connection._.invocationCallbacks[dataCallbackId];
                if (callback) {
                    // Delete the callback from the proxy
                    connection._.invocationCallbacks[dataCallbackId] = null;
                    delete connection._.invocationCallbacks[dataCallbackId];

                    // Invoke the callback
                    callback.method.call(callback.scope, minData);
                }
            } else {
                data = this._maximizeClientHubInvocation(minData);

                // We received a client invocation request, i.e. broadcast from server hub
                connection.log("Triggering client hub event '" + data.Method + "' on hub '" + data.Hub + "'.");

                // Normalize the names to lowercase
                hubName = data.Hub.toLowerCase();
                eventName = data.Method.toLowerCase();

                // Trigger the local invocation event
                proxy = this.proxies[hubName];

                // Update the hub state
                $.extend(proxy.state, data.State);
                $(proxy).triggerHandler(makeEventName(eventName), [data.Args]);
            }
        });

        connection.error(function (errData, origData) {
            var callbackId, callback;

            if (!origData) {
                // No original data passed so this is not a send error
                return;
            }

            callbackId = origData.I;
            callback = connection._.invocationCallbacks[callbackId];

            // Verify that there is a callback bound (could have been cleared)
            if (callback) {
                // Delete the callback
                connection._.invocationCallbacks[callbackId] = null;
                delete connection._.invocationCallbacks[callbackId];

                // Invoke the callback with an error to reject the promise
                callback.method.call(callback.scope, { E: errData });
            }
        });

        connection.reconnecting(function () {
            if (connection.transport && connection.transport.name === "webSockets") {
                clearInvocationCallbacks(connection, "Connection started reconnecting before invocation result was received.");
            }
        });

        connection.disconnected(function () {
            clearInvocationCallbacks(connection, "Connection was disconnected before invocation result was received.");
        });
    };

    hubConnection.fn._maximizeClientHubInvocation = function (minClientHubInvocation) {
        return {
            Hub: minClientHubInvocation.H,
            Method: minClientHubInvocation.M,
            Args: minClientHubInvocation.A,
            State: minClientHubInvocation.S
        };
    };

    hubConnection.fn._registerSubscribedHubs = function () {
        /// <summary>
        ///     Sets the starting event to loop through the known hubs and register any new hubs
        ///     that have been added to the proxy.
        /// </summary>
        var connection = this;

        if (!connection._subscribedToHubs) {
            connection._subscribedToHubs = true;
            connection.starting(function () {
                // Set the connection's data object with all the hub proxies with active subscriptions.
                // These proxies will receive notifications from the server.
                var subscribedHubs = [];

                $.each(connection.proxies, function (key) {
                    if (this.hasSubscriptions()) {
                        subscribedHubs.push({ name: key });
                        connection.log("Client subscribed to hub '" + key + "'.");
                    }
                });

                if (subscribedHubs.length === 0) {
                    connection.log("No hubs have been subscribed to.  The client will not receive data from hubs.  To fix, declare at least one client side function prior to connection start for each hub you wish to subscribe to.");
                }

                connection.data = connection.json.stringify(subscribedHubs);
            });
        }
    };

    hubConnection.fn.createHubProxy = function (hubName) {
        /// <summary>
        ///     Creates a new proxy object for the given hub connection that can be used to invoke
        ///     methods on server hubs and handle client method invocation requests from the server.
        /// </summary>
        /// <param name="hubName" type="String">
        ///     The name of the hub on the server to create the proxy for.
        /// </param>

        // Normalize the name to lowercase
        hubName = hubName.toLowerCase();

        var proxy = this.proxies[hubName];
        if (!proxy) {
            proxy = hubProxy(this, hubName);
            this.proxies[hubName] = proxy;
        }

        this._registerSubscribedHubs();

        return proxy;
    };

    hubConnection.fn.init.prototype = hubConnection.fn;

    $.hubConnection = hubConnection;

}(window.jQuery, window));
/* jquery.signalR.version.js */
// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.


/*global window:false */
/// <reference path="jquery.signalR.core.js" />
(function ($, undefined) {
    // This will be modified by the build script
    $.signalR.version = "2.4.3";
}(window.jQuery));

/*!
 * ASP.NET SignalR JavaScript Library 2.4.3
 * http://signalr.net/
 *
 * Copyright (c) .NET Foundation. All rights reserved.
 * Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.
 *
 */

/// <reference path="..\..\SignalR.Client.JS\Scripts\jquery-1.6.4.js" />
/// <reference path="jquery.signalR.js" />
(function ($, window, undefined) {
    /// <param name="$" type="jQuery" />
    "use strict";

    if (typeof ($.signalR) !== "function") {
        throw new Error("SignalR: SignalR is not loaded. Please ensure jquery.signalR-x.js is referenced before ~/signalr/js.");
    }

    var signalR = $.signalR;

    function makeProxyCallback(hub, callback) {
        return function () {
            // Call the client hub method
            callback.apply(hub, $.makeArray(arguments));
        };
    }

    function registerHubProxies(instance, shouldSubscribe) {
        var key, hub, memberKey, memberValue, subscriptionMethod;

        for (key in instance) {
            if (instance.hasOwnProperty(key)) {
                hub = instance[key];

                if (!(hub.hubName)) {
                    // Not a client hub
                    continue;
                }

                if (shouldSubscribe) {
                    // We want to subscribe to the hub events
                    subscriptionMethod = hub.on;
                } else {
                    // We want to unsubscribe from the hub events
                    subscriptionMethod = hub.off;
                }

                // Loop through all members on the hub and find client hub functions to subscribe/unsubscribe
                for (memberKey in hub.client) {
                    if (hub.client.hasOwnProperty(memberKey)) {
                        memberValue = hub.client[memberKey];

                        if (!$.isFunction(memberValue)) {
                            // Not a client hub function
                            continue;
                        }

                        // Use the actual user-provided callback as the "identity" value for the registration.
                        subscriptionMethod.call(hub, memberKey, makeProxyCallback(hub, memberValue), memberValue);
                    }
                }
            }
        }
    }

    $.hubConnection.prototype.createHubProxies = function () {
        var proxies = {};
        this.starting(function () {
            // Register the hub proxies as subscribed
            // (instance, shouldSubscribe)
            registerHubProxies(proxies, true);

            this._registerSubscribedHubs();
        }).disconnected(function () {
            // Unsubscribe all hub proxies when we "disconnect".  This is to ensure that we do not re-add functional call backs.
            // (instance, shouldSubscribe)
            registerHubProxies(proxies, false);
        });

        proxies['hubInterface'] = this.createHubProxy('hubInterface'); 
        proxies['hubInterface'].client = { };
        proxies['hubInterface'].server = {
            alertAgentAddToCart: function (title, tokenAgent, tokenVisitor, tokenRoom, action) {
            /// <summary>Calls the AlertAgentAddToCart method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"title\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenAgent\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenVisitor\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenRoom\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"action\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["AlertAgentAddToCart"], $.makeArray(arguments)));
             },

            alertAgentAddToMyList: function (title, tokenAgent, tokenVisitor, tokenRoom, whoAdd) {
            /// <summary>Calls the AlertAgentAddToMyList method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"title\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenAgent\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenVisitor\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenRoom\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"whoAdd\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["AlertAgentAddToMyList"], $.makeArray(arguments)));
             },

            assignedVisitorsFromLogin: function (agentId) {
            /// <summary>Calls the AssignedVisitorsFromLogin method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"agentId\" type=\"Number\">Server side type is System.Int32</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["AssignedVisitorsFromLogin"], $.makeArray(arguments)));
             },

            cleanInactiveVisitors: function (minutesInactivity) {
            /// <summary>Calls the CleanInactiveVisitors method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"minutesInactivity\" type=\"Number\">Server side type is System.Int32</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["CleanInactiveVisitors"], $.makeArray(arguments)));
             },

            closeLastConnection: function (room) {
            /// <summary>Calls the CloseLastConnection method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["CloseLastConnection"], $.makeArray(arguments)));
             },

            closeSession: function (room, tokenAgent, hideMessage) {
            /// <summary>Calls the CloseSession method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenAgent\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"hideMessage\" type=\"\">Server side type is System.Boolean</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["CloseSession"], $.makeArray(arguments)));
             },

            connectBotFromOverflow: function (initData, contextVars) {
            /// <summary>Calls the ConnectBotFromOverflow method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"initData\" type=\"Object\">Server side type is Model.Dto.SignalR.InitBotConversationData</param>
            /// <param name=\"contextVars\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["ConnectBotFromOverflow"], $.makeArray(arguments)));
             },

            connectedAgent: function (agent, connectionId) {
            /// <summary>Calls the ConnectedAgent method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"agent\" type=\"Object\">Server side type is Model.Dto.SignalR.Agent</param>
            /// <param name=\"connectionId\" type=\"Number\">Server side type is System.Int32</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["ConnectedAgent"], $.makeArray(arguments)));
             },

            connectFromPincode: function (room, tokenAgent) {
            /// <summary>Calls the ConnectFromPincode method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenAgent\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["ConnectFromPincode"], $.makeArray(arguments)));
             },

            createSessionSameToken: function (db, transfer, deptSelected) {
            /// <summary>Calls the CreateSessionSameToken method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"db\" type=\"Object\">Server side type is Model.Ado.Oct8neEntities</param>
            /// <param name=\"transfer\" type=\"Object\">Server side type is Model.Dto.Transfer</param>
            /// <param name=\"deptSelected\" type=\"Number\">Server side type is System.Int32</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["CreateSessionSameToken"], $.makeArray(arguments)));
             },

            doneSaveTempInteraction: function (room) {
            /// <summary>Calls the DoneSaveTempInteraction method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["DoneSaveTempInteraction"], $.makeArray(arguments)));
             },

            forceCloseRoom: function (room, tokenAgent) {
            /// <summary>Calls the ForceCloseRoom method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenAgent\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["ForceCloseRoom"], $.makeArray(arguments)));
             },

            forceCloseSession: function (tokenVisitor, tokenAgent, room) {
            /// <summary>Calls the ForceCloseSession method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"tokenVisitor\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenAgent\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["ForceCloseSession"], $.makeArray(arguments)));
             },

            forceKickAgent: function (agentId, channel) {
            /// <summary>Calls the ForceKickAgent method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"agentId\" type=\"Number\">Server side type is System.Int32</param>
            /// <param name=\"channel\" type=\"Number\">Server side type is System.Int32</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["ForceKickAgent"], $.makeArray(arguments)));
             },

            forceLogoutAgent: function (agentId, myAgentId) {
            /// <summary>Calls the ForceLogoutAgent method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"agentId\" type=\"Number\">Server side type is System.Int32</param>
            /// <param name=\"myAgentId\" type=\"Number\">Server side type is System.Int32</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["ForceLogoutAgent"], $.makeArray(arguments)));
             },

            getFirstVisitorToOverbookingList: function (myAgentId, room) {
            /// <summary>Calls the GetFirstVisitorToOverbookingList method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"myAgentId\" type=\"Number\">Server side type is System.Int32</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["GetFirstVisitorToOverbookingList"], $.makeArray(arguments)));
             },

            getVisitorStatusCall: function (room) {
            /// <summary>Calls the GetVisitorStatusCall method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["GetVisitorStatusCall"], $.makeArray(arguments)));
             },

            goToBackgroundAppMobile: function (conference) {
            /// <summary>Calls the GoToBackgroundAppMobile method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"conference\" type=\"Object\">Server side type is Model.Dto.SignalR.ConferenceApp</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["GoToBackgroundAppMobile"], $.makeArray(arguments)));
             },

            goToBotAction: function (newLocation, room) {
            /// <summary>Calls the goToBotAction method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"newLocation\" type=\"Object\">Server side type is Model.Dto.SignalR.NodeLocation</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["goToBotAction"], $.makeArray(arguments)));
             },

            initBotConversation: function (initData, contextVars) {
            /// <summary>Calls the InitBotConversation method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"initData\" type=\"Object\">Server side type is Model.Dto.SignalR.InitBotConversationData</param>
            /// <param name=\"contextVars\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["InitBotConversation"], $.makeArray(arguments)));
             },

            isTyping: function (chat) {
            /// <summary>Calls the IsTyping method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"chat\" type=\"Object\">Server side type is Model.Dto.SignalR.Message</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["IsTyping"], $.makeArray(arguments)));
             },

            joinAgent: function (tokenAgent) {
            /// <summary>Calls the JoinAgent method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"tokenAgent\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["JoinAgent"], $.makeArray(arguments)));
             },

            logOffOtherAgent: function (oldTokenAgent, token) {
            /// <summary>Calls the LogOffOtherAgent method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"oldTokenAgent\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"token\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["LogOffOtherAgent"], $.makeArray(arguments)));
             },

            markAsTransferredInVideoCallInDic: function (room, status) {
            /// <summary>Calls the MarkAsTransferredInVideoCallInDic method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"status\" type=\"Object\">Server side type is System.Nullable`1[System.Boolean]</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["MarkAsTransferredInVideoCallInDic"], $.makeArray(arguments)));
             },

            receivePingBot: function (connId) {
            /// <summary>Calls the ReceivePingBot method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"connId\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["ReceivePingBot"], $.makeArray(arguments)));
             },

            receiveTag: function (room, tag) {
            /// <summary>Calls the ReceiveTag method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tag\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["ReceiveTag"], $.makeArray(arguments)));
             },

            rejectedVideoCall: function (room) {
            /// <summary>Calls the RejectedVideoCall method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["RejectedVideoCall"], $.makeArray(arguments)));
             },

            reloadAgents: function (domainId) {
            /// <summary>Calls the ReloadAgents method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"domainId\" type=\"Number\">Server side type is System.Int32</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["ReloadAgents"], $.makeArray(arguments)));
             },

            sendAddToMyCartToVisitor: function (internalId, tokenSession) {
            /// <summary>Calls the SendAddToMyCartToVisitor method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"internalId\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenSession\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendAddToMyCartToVisitor"], $.makeArray(arguments)));
             },

            sendAddToMyListToVisitor: function (internalId, tokenSession) {
            /// <summary>Calls the SendAddToMyListToVisitor method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"internalId\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenSession\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendAddToMyListToVisitor"], $.makeArray(arguments)));
             },

            sendAgentCoviewerLoaded: function (room) {
            /// <summary>Calls the SendAgentCoviewerLoaded method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendAgentCoviewerLoaded"], $.makeArray(arguments)));
             },

            sendAgentsChatMessage: function (chat) {
            /// <summary>Calls the SendAgentsChatMessage method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"chat\" type=\"Object\">Server side type is Model.Dto.SignalR.AgentChat</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendAgentsChatMessage"], $.makeArray(arguments)));
             },

            sendAnalyticsEvent: function (eventData, room) {
            /// <summary>Calls the SendAnalyticsEvent method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"eventData\" type=\"Object\">Server side type is Model.Dto.SignalR.AnalyticsEvent</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendAnalyticsEvent"], $.makeArray(arguments)));
             },

            sendCartData: function (room, cartSummary) {
            /// <summary>Calls the SendCartData method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"cartSummary\" type=\"Object\">Server side type is Model.Dto.CartSummary</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendCartData"], $.makeArray(arguments)));
             },

            sendChoice: function (choice, room) {
            /// <summary>Calls the SendChoice method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"choice\" type=\"Object\">Server side type is Model.Dto.SignalR.Choice</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendChoice"], $.makeArray(arguments)));
             },

            sendChoiceResponse: function (response, room) {
            /// <summary>Calls the SendChoiceResponse method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"response\" type=\"Object\">Server side type is Model.Dto.SignalR.ChoiceResponse</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendChoiceResponse"], $.makeArray(arguments)));
             },

            sendConferenceMessage: function (message, conferenceId, data) {
            /// <summary>Calls the SendConferenceMessage method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"message\" type=\"Number\">Server side type is System.Int32</param>
            /// <param name=\"conferenceId\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"data\" type=\"Object\">Server side type is Newtonsoft.Json.Linq.JObject</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendConferenceMessage"], $.makeArray(arguments)));
             },

            sendCustomForm: function (form, room, delay) {
            /// <summary>Calls the SendCustomForm method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"form\" type=\"Object\">Server side type is Model.Dto.SignalR.CustomForm</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"delay\" type=\"Number\">Server side type is System.Int32</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendCustomForm"], $.makeArray(arguments)));
             },

            sendCustomFormResponse: function (response, room) {
            /// <summary>Calls the SendCustomFormResponse method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"response\" type=\"Object\">Server side type is Model.Dto.SignalR.CustomFormResponse</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendCustomFormResponse"], $.makeArray(arguments)));
             },

            sendDashboard: function (room, schedule, currentIframeStatus) {
            /// <summary>Calls the SendDashboard method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"schedule\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"currentIframeStatus\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendDashboard"], $.makeArray(arguments)));
             },

            sendDataVisitor: function (room, scfVisitor) {
            /// <summary>Calls the SendDataVisitor method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"scfVisitor\" type=\"Object\">Server side type is Model.Dto.Visitors</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendDataVisitor"], $.makeArray(arguments)));
             },

            sendDataVisitorWithRoom: function (room, scfVisitor) {
            /// <summary>Calls the SendDataVisitorWithRoom method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"scfVisitor\" type=\"Object\">Server side type is Model.Dto.Visitors</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendDataVisitorWithRoom"], $.makeArray(arguments)));
             },

            sendDelay: function (delay, room) {
            /// <summary>Calls the SendDelay method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"delay\" type=\"Object\">Server side type is Model.Dto.SignalR.Delay</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendDelay"], $.makeArray(arguments)));
             },

            sendDelayCallback: function (room, agentId) {
            /// <summary>Calls the SendDelayCallback method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"agentId\" type=\"Number\">Server side type is System.Int32</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendDelayCallback"], $.makeArray(arguments)));
             },

            sendDeleteVisitor: function (domainId, visitor) {
            /// <summary>Calls the SendDeleteVisitor method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"domainId\" type=\"Number\">Server side type is System.Int32</param>
            /// <param name=\"visitor\" type=\"Object\">Server side type is Model.Dto.ModalVisitor</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendDeleteVisitor"], $.makeArray(arguments)));
             },

            sendDrag: function (drag) {
            /// <summary>Calls the SendDrag method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"drag\" type=\"Object\">Server side type is Model.Dto.SignalR.Drag</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendDrag"], $.makeArray(arguments)));
             },

            sendDrawing: function (drawing) {
            /// <summary>Calls the SendDrawing method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"drawing\" type=\"Object\">Server side type is Model.Dto.SignalR.Drawing</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendDrawing"], $.makeArray(arguments)));
             },

            sendEnableClientTranslation: function (translation) {
            /// <summary>Calls the SendEnableClientTranslation method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"translation\" type=\"Object\">Server side type is Model.Dto.SignalR.Translation</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendEnableClientTranslation"], $.makeArray(arguments)));
             },

            sendError: function (error, room) {
            /// <summary>Calls the SendError method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"error\" type=\"Object\">Server side type is Model.Dto.SignalR.ErrorMessage</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendError"], $.makeArray(arguments)));
             },

            sendFormResponse: function (message) {
            /// <summary>Calls the SendFormResponse method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"message\" type=\"Object\">Server side type is Model.Dto.SignalR.Message</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendFormResponse"], $.makeArray(arguments)));
             },

            sendFormVisitor: function (room, disconnectSignalR) {
            /// <summary>Calls the SendFormVisitor method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"disconnectSignalR\" type=\"\">Server side type is System.Boolean</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendFormVisitor"], $.makeArray(arguments)));
             },

            sendImage: function (media) {
            /// <summary>Calls the SendImage method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"media\" type=\"Object\">Server side type is Model.Dto.SignalR.Medias</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendImage"], $.makeArray(arguments)));
             },

            sendInputValidation: function (validation, room) {
            /// <summary>Calls the SendInputValidation method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"validation\" type=\"Object\">Server side type is Model.Dto.SignalR.InputValidation</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendInputValidation"], $.makeArray(arguments)));
             },

            sendInteractionsToAgent: function (agentToken, tokenVisitor, interactionsToSave) {
            /// <summary>Calls the SendInteractionsToAgent method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"agentToken\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenVisitor\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"interactionsToSave\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendInteractionsToAgent"], $.makeArray(arguments)));
             },

            sendMessage: function (message) {
            /// <summary>Calls the SendMessage method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"message\" type=\"Object\">Server side type is Model.Dto.SignalR.Message</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendMessage"], $.makeArray(arguments)));
             },

            sendMessageRating: function (rating, room) {
            /// <summary>Calls the SendMessageRating method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"rating\" type=\"Object\">Server side type is Model.Dto.SignalR.MessageRating</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendMessageRating"], $.makeArray(arguments)));
             },

            sendMessageRatingResponse: function (response, room, domainId) {
            /// <summary>Calls the SendMessageRatingResponse method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"response\" type=\"Object\">Server side type is Model.Dto.SignalR.MessageRatingResponse</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"domainId\" type=\"Number\">Server side type is System.Int32</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendMessageRatingResponse"], $.makeArray(arguments)));
             },

            sendNode: function (node) {
            /// <summary>Calls the SendNode method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"node\" type=\"Object\">Server side type is Model.Dto.SignalR.Nodes</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendNode"], $.makeArray(arguments)));
             },

            sendNote: function (note) {
            /// <summary>Calls the SendNote method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"note\" type=\"Object\">Server side type is Model.Dto.SignalR.Note</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendNote"], $.makeArray(arguments)));
             },

            sendPin: function (pin) {
            /// <summary>Calls the SendPin method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"pin\" type=\"Object\">Server side type is Model.Dto.SignalR.Point</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendPin"], $.makeArray(arguments)));
             },

            sendPingBot: function (id, connId) {
            /// <summary>Calls the SendPingBot method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"id\" type=\"Number\">Server side type is System.Int32</param>
            /// <param name=\"connId\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendPingBot"], $.makeArray(arguments)));
             },

            sendPoint: function (point) {
            /// <summary>Calls the SendPoint method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"point\" type=\"Object\">Server side type is Model.Dto.SignalR.Point</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendPoint"], $.makeArray(arguments)));
             },

            sendProductSearch: function (search, room, delay) {
            /// <summary>Calls the SendProductSearch method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"search\" type=\"Object\">Server side type is Model.Dto.SignalR.ProductSearchFromBot</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"delay\" type=\"Number\">Server side type is System.Int32</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendProductSearch"], $.makeArray(arguments)));
             },

            sendProductSearchResultsCallback: function (results, room) {
            /// <summary>Calls the SendProductSearchResultsCallback method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"results\" type=\"Number\">Server side type is System.Int32</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendProductSearchResultsCallback"], $.makeArray(arguments)));
             },

            sendResetImage: function (zoom) {
            /// <summary>Calls the SendResetImage method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"zoom\" type=\"Object\">Server side type is Model.Dto.SignalR.Zoom</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendResetImage"], $.makeArray(arguments)));
             },

            sendRunAsyncScript: function (script, room) {
            /// <summary>Calls the SendRunAsyncScript method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"script\" type=\"Object\">Server side type is Model.Dto.SignalR.RunAsyncScript</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendRunAsyncScript"], $.makeArray(arguments)));
             },

            sendSearchOrder: function (message) {
            /// <summary>Calls the SendSearchOrder method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"message\" type=\"Object\">Server side type is Model.Dto.SignalR.OrderStatus</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendSearchOrder"], $.makeArray(arguments)));
             },

            sendSearchTerm: function (search, sendSearchToAgent) {
            /// <summary>Calls the SendSearchTerm method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"search\" type=\"Object\">Server side type is Model.Dto.SignalR.Search</param>
            /// <param name=\"sendSearchToAgent\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendSearchTerm"], $.makeArray(arguments)));
             },

            sendSearchTermCatalog: function (search) {
            /// <summary>Calls the SendSearchTermCatalog method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"search\" type=\"Object\">Server side type is Model.Dto.SignalR.Search</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendSearchTermCatalog"], $.makeArray(arguments)));
             },

            sendSideBubble: function (sideBubble, room) {
            /// <summary>Calls the SendSideBubble method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"sideBubble\" type=\"Object\">Server side type is Model.Dto.SignalR.SideBubble</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendSideBubble"], $.makeArray(arguments)));
             },

            sendSignalingMessage: function (data, conferenceId) {
            /// <summary>Calls the SendSignalingMessage method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"data\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"conferenceId\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendSignalingMessage"], $.makeArray(arguments)));
             },

            sendStatus: function (data) {
            /// <summary>Calls the SendStatus method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"data\" type=\"Object\">Server side type is Model.Dto.SignalR.ChangeStatus</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendStatus"], $.makeArray(arguments)));
             },

            sendStatusDomain: function (status, domainId) {
            /// <summary>Calls the SendStatusDomain method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"status\" type=\"Object\">Server side type is Tools.Constant.Domain+Status</param>
            /// <param name=\"domainId\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendStatusDomain"], $.makeArray(arguments)));
             },

            sendSummary: function (chat) {
            /// <summary>Calls the SendSummary method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"chat\" type=\"Object\">Server side type is Model.Dto.SignalR.Message</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendSummary"], $.makeArray(arguments)));
             },

            sendSupervisorMessage: function (message) {
            /// <summary>Calls the sendSupervisorMessage method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"message\" type=\"Object\">Server side type is Model.Dto.SignalR.SupervisorMessage</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["sendSupervisorMessage"], $.makeArray(arguments)));
             },

            sendUndo: function (undo) {
            /// <summary>Calls the SendUndo method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"undo\" type=\"Object\">Server side type is Model.Dto.SignalR.Undo</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendUndo"], $.makeArray(arguments)));
             },

            sendViewChange: function (changeView) {
            /// <summary>Calls the SendViewChange method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"changeView\" type=\"Object\">Server side type is Model.Dto.SignalR.ChangeView</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendViewChange"], $.makeArray(arguments)));
             },

            sendVisitorCheckout: function (room, tokenSession) {
            /// <summary>Calls the SendVisitorCheckout method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenSession\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendVisitorCheckout"], $.makeArray(arguments)));
             },

            sendVisitorOrderRequest: function (orderId, room) {
            /// <summary>Calls the SendVisitorOrderRequest method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"orderId\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendVisitorOrderRequest"], $.makeArray(arguments)));
             },

            sendVisitorOrderResult: function (details, room) {
            /// <summary>Calls the SendVisitorOrderResult method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"details\" type=\"Object\">Server side type is Model.Dto.SignalR.Oct8neOrderResult</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendVisitorOrderResult"], $.makeArray(arguments)));
             },

            sendVoiceForm: function (message) {
            /// <summary>Calls the SendVoiceForm method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"message\" type=\"Object\">Server side type is Model.Dto.SignalR.Message</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendVoiceForm"], $.makeArray(arguments)));
             },

            sendZoom: function (zoom) {
            /// <summary>Calls the SendZoom method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"zoom\" type=\"Object\">Server side type is Model.Dto.SignalR.Zoom</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["SendZoom"], $.makeArray(arguments)));
             },

            transfer: function (tokenOldAgent, tokenNewAgent, room, transferText, typeTransfer, idDept) {
            /// <summary>Calls the Transfer method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"tokenOldAgent\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"tokenNewAgent\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"transferText\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"typeTransfer\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"idDept\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["Transfer"], $.makeArray(arguments)));
             },

            transferVisitor: function (idOldAgent, idNewAgent, tokenVisitor, transferText, typeTransfer, idDept, forceNoMoreAgentsResult) {
            /// <summary>Calls the TransferVisitor method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"idOldAgent\" type=\"Number\">Server side type is System.Int32</param>
            /// <param name=\"idNewAgent\" type=\"Object\">Server side type is System.Nullable`1[System.Int32]</param>
            /// <param name=\"tokenVisitor\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"transferText\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"typeTransfer\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"idDept\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"forceNoMoreAgentsResult\" type=\"\">Server side type is System.Boolean</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["TransferVisitor"], $.makeArray(arguments)));
             },

            transferVisitorFromBot: function (transfer) {
            /// <summary>Calls the TransferVisitorFromBot method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"transfer\" type=\"Object\">Server side type is Model.Dto.SignalR.TransferVisitorFromBot</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["TransferVisitorFromBot"], $.makeArray(arguments)));
             },

            transferVisitorMobile: function (transfer) {
            /// <summary>Calls the TransferVisitorMobile method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"transfer\" type=\"Object\">Server side type is Oct8ne.SignalR.TransferMobile</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["TransferVisitorMobile"], $.makeArray(arguments)));
             },

            updateStatusCallInDic: function (room, status) {
            /// <summary>Calls the UpdateStatusCallInDic method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"status\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["UpdateStatusCallInDic"], $.makeArray(arguments)));
             },

            updateVisitor: function (room) {
            /// <summary>Calls the UpdateVisitor method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["UpdateVisitor"], $.makeArray(arguments)));
             },

            updateVisitorMuteAudioInDic: function (room, status) {
            /// <summary>Calls the UpdateVisitorMuteAudioInDic method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"status\" type=\"\">Server side type is System.Boolean</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["UpdateVisitorMuteAudioInDic"], $.makeArray(arguments)));
             },

            updateVisitorMuteVideoInDic: function (room, status) {
            /// <summary>Calls the updateVisitorMuteVideoInDic method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"status\" type=\"\">Server side type is System.Boolean</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["updateVisitorMuteVideoInDic"], $.makeArray(arguments)));
             },

            videoAction: function (action, time, room) {
            /// <summary>Calls the VideoAction method on the server-side HubInterface hub.&#10;Returns a jQuery.Deferred() promise.</summary>
            /// <param name=\"action\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"time\" type=\"String\">Server side type is System.String</param>
            /// <param name=\"room\" type=\"String\">Server side type is System.String</param>
                return proxies['hubInterface'].invoke.apply(proxies['hubInterface'], $.merge(["VideoAction"], $.makeArray(arguments)));
             }
        };

        return proxies;
    };

    signalR.hub = $.hubConnection("/signalr", { useDefaultPath: false });
    $.extend(signalR, signalR.hub.createHubProxies());

}(window.jQuery, window));

/*!
 * jQuery Mousewheel 3.1.13
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license
 * http://jquery.org/license
 */

(function (factory) {
    if (typeof define === 'function' && define.amd) {
        // AMD. Register as an anonymous module.
        define(['jquery'], factory);
    } else if (typeof exports === 'object') {
        // Node/CommonJS style for Browserify
        module.exports = factory;
    } else {
        // Browser globals
        factory(jQuery);
    }
}(function ($) {

    var toFix = ['wheel', 'mousewheel', 'DOMMouseScroll', 'MozMousePixelScroll'],
        toBind = ('onwheel' in document || document.documentMode >= 9) ?
            ['wheel'] : ['mousewheel', 'DomMouseScroll', 'MozMousePixelScroll'],
        slice = Array.prototype.slice,
        nullLowestDeltaTimeout, lowestDelta;

    if ($.event.fixHooks) {
        for (var i = toFix.length; i;) {
            $.event.fixHooks[toFix[--i]] = $.event.mouseHooks;
        }
    }

    var special = $.event.special.mousewheel = {
        version: '3.1.12',

        setup: function () {
            if (this.addEventListener) {
                for (var i = toBind.length; i;) {
                    this.addEventListener(toBind[--i], handler, true);
                }
            } else {
                this.onmousewheel = handler;
            }
            // Store the line height and page height for this particular element
            $.data(this, 'mousewheel-line-height', special.getLineHeight(this));
            $.data(this, 'mousewheel-page-height', special.getPageHeight(this));
        },

        teardown: function () {
            if (this.removeEventListener) {
                for (var i = toBind.length; i;) {
                    this.removeEventListener(toBind[--i], handler, true);
                }
            } else {
                this.onmousewheel = null;
            }
            // Clean up the data we added to the element
            $.removeData(this, 'mousewheel-line-height');
            $.removeData(this, 'mousewheel-page-height');
        },

        getLineHeight: function (elem) {
            var $elem = $(elem),
                $parent = $elem['offsetParent' in $.fn ? 'offsetParent' : 'parent']();
            if (!$parent.length) {
                $parent = $('body');
            }
            return parseInt($parent.css('fontSize'), 10) || parseInt($elem.css('fontSize'), 10) || 16;
        },

        getPageHeight: function (elem) {
            return $(elem).height();
        },

        settings: {
            adjustOldDeltas: true, // see shouldAdjustOldDeltas() below
            normalizeOffset: true  // calls getBoundingClientRect for each event
        }
    };

    $.fn.extend({
        mousewheel: function (fn) {
            return fn ? this.bind('mousewheel', fn) : this.trigger('mousewheel');
        },

        unmousewheel: function (fn) {
            return this.unbind('mousewheel', fn);
        }
    });


    function handler(event) {
        var orgEvent = event || window.event,
            args = slice.call(arguments, 1),
            delta = 0,
            deltaX = 0,
            deltaY = 0,
            absDelta = 0,
            offsetX = 0,
            offsetY = 0;
        event = $.event.fix(orgEvent);
        event.type = 'mousewheel';

        // Old school scrollwheel delta
        if ('detail' in orgEvent) { deltaY = orgEvent.detail * -1; }
        if ('wheelDelta' in orgEvent) { deltaY = orgEvent.wheelDelta; }
        if ('wheelDeltaY' in orgEvent) { deltaY = orgEvent.wheelDeltaY; }
        if ('wheelDeltaX' in orgEvent) { deltaX = orgEvent.wheelDeltaX * -1; }

        // Firefox < 17 horizontal scrolling related to DOMMouseScroll event
        if ('axis' in orgEvent && orgEvent.axis === orgEvent.HORIZONTAL_AXIS) {
            deltaX = deltaY * -1;
            deltaY = 0;
        }

        // Set delta to be deltaY or deltaX if deltaY is 0 for backwards compatabilitiy
        delta = deltaY === 0 ? deltaX : deltaY;

        // New school wheel delta (wheel event)
        if ('deltaY' in orgEvent) {
            deltaY = orgEvent.deltaY * -1;
            delta = deltaY;
        }
        if ('deltaX' in orgEvent) {
            deltaX = orgEvent.deltaX;
            if (deltaY === 0) { delta = deltaX * -1; }
        }

        // No change actually happened, no reason to go any further
        if (deltaY === 0 && deltaX === 0) { return; }

        // Need to convert lines and pages to pixels if we aren't already in pixels
        // There are three delta modes:
        //   * deltaMode 0 is by pixels, nothing to do
        //   * deltaMode 1 is by lines
        //   * deltaMode 2 is by pages
        if (orgEvent.deltaMode === 1) {
            var lineHeight = $.data(this, 'mousewheel-line-height');
            delta *= lineHeight;
            deltaY *= lineHeight;
            deltaX *= lineHeight;
        } else if (orgEvent.deltaMode === 2) {
            var pageHeight = $.data(this, 'mousewheel-page-height');
            delta *= pageHeight;
            deltaY *= pageHeight;
            deltaX *= pageHeight;
        }

        // Store lowest absolute delta to normalize the delta values
        absDelta = Math.max(Math.abs(deltaY), Math.abs(deltaX));

        if (!lowestDelta || absDelta < lowestDelta) {
            lowestDelta = absDelta;

            // Adjust older deltas if necessary
            if (shouldAdjustOldDeltas(orgEvent, absDelta)) {
                lowestDelta /= 40;
            }
        }

        // Adjust older deltas if necessary
        if (shouldAdjustOldDeltas(orgEvent, absDelta)) {
            // Divide all the things by 40!
            delta /= 40;
            deltaX /= 40;
            deltaY /= 40;
        }

        // Get a whole, normalized value for the deltas
        delta = Math[delta >= 1 ? 'floor' : 'ceil'](delta / lowestDelta);
        deltaX = Math[deltaX >= 1 ? 'floor' : 'ceil'](deltaX / lowestDelta);
        deltaY = Math[deltaY >= 1 ? 'floor' : 'ceil'](deltaY / lowestDelta);

        // Normalise offsetX and offsetY properties
        if (special.settings.normalizeOffset && this.getBoundingClientRect) {
            var boundingRect = this.getBoundingClientRect();
            offsetX = event.clientX - boundingRect.left;
            offsetY = event.clientY - boundingRect.top;
        }

        // Add information to the event object
        event.deltaX = deltaX;
        event.deltaY = deltaY;
        event.deltaFactor = lowestDelta;
        event.offsetX = offsetX;
        event.offsetY = offsetY;
        // Go ahead and set deltaMode to 0 since we converted to pixels
        // Although this is a little odd since we overwrite the deltaX/Y
        // properties with normalized deltas.
        event.deltaMode = 0;

        // Add event and delta to the front of the arguments
        args.unshift(event, delta, deltaX, deltaY);

        // Clearout lowestDelta after sometime to better
        // handle multiple device types that give different
        // a different lowestDelta
        // Ex: trackpad = 3 and mouse wheel = 120
        if (nullLowestDeltaTimeout) { clearTimeout(nullLowestDeltaTimeout); }
        nullLowestDeltaTimeout = setTimeout(nullLowestDelta, 200);

        return ($.event.dispatch || $.event.handle).apply(this, args);
    }

    function nullLowestDelta() {
        lowestDelta = null;
    }

    function shouldAdjustOldDeltas(orgEvent, absDelta) {
        // If this is an older event and the delta is divisable by 120,
        // then we are assuming that the browser is treating this as an
        // older mouse wheel event and that we should divide the deltas
        // by 40 to try and get a more usable deltaFactor.
        // Side note, this actually impacts the reported scroll distance
        // in older browsers and can cause scrolling to be slower than native.
        // Turn this off by setting $.event.special.mousewheel.settings.adjustOldDeltas to false.
        return special.settings.adjustOldDeltas && orgEvent.type === 'mousewheel' && absDelta % 120 === 0;
    }

}));

/*
== malihu jquery custom scrollbar plugin == 
Version: 3.1.5 
Plugin URI: http://manos.malihu.gr/jquery-custom-content-scroller 
Author: malihu
Author URI: http://manos.malihu.gr
License: MIT License (MIT)
*/

/*
Copyright Manos Malihutsakis (email: manos@malihu.gr)

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
*/

/*
The code below is fairly long, fully commented and should be normally used in development. 
For production, use either the minified jquery.mCustomScrollbar.min.js script or 
the production-ready jquery.mCustomScrollbar.concat.min.js which contains the plugin 
and dependencies (minified). 
*/

(function (factory) {
    if (typeof define === "function" && define.amd) {
        define(["jquery"], factory);
    } else if (typeof module !== "undefined" && module.exports) {
        module.exports = factory;
    } else {
        factory(jQuery, window, document);
    }
}(function ($) {
    (function (init) {
        var _rjs = typeof define === "function" && define.amd, /* RequireJS */
            _njs = typeof module !== "undefined" && module.exports, /* NodeJS */
            _dlp = ("https:" == document.location.protocol) ? "https:" : "http:", /* location protocol */
            _url = "cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js";
        if (!_rjs) {
            if (_njs) {
                require("jquery-mousewheel")($);
            } else {
                /* load jquery-mousewheel plugin (via CDN) if it's not present or not loaded via RequireJS 
                (works when mCustomScrollbar fn is called on window load) */
                $.event.special.mousewheel || $("head").append(decodeURI("%3Cscript src=" + _dlp + "//" + _url + "%3E%3C/script%3E"));
            }
        }
        init();
    }(function () {

        /* 
        ----------------------------------------
        PLUGIN NAMESPACE, PREFIX, DEFAULT SELECTOR(S) 
        ----------------------------------------
        */

        var pluginNS = "mCustomScrollbar",
            pluginPfx = "mCS",
            defaultSelector = ".mCustomScrollbar",





            /* 
            ----------------------------------------
            DEFAULT OPTIONS 
            ----------------------------------------
            */

            defaults = {
                /*
                set element/content width/height programmatically 
                values: boolean, pixels, percentage 
                    option						default
                    -------------------------------------
                    setWidth					false
                    setHeight					false
                */
                /*
                set the initial css top property of content  
                values: string (e.g. "-100px", "10%" etc.)
                */
                setTop: 0,
                /*
                set the initial css left property of content  
                values: string (e.g. "-100px", "10%" etc.)
                */
                setLeft: 0,
                /* 
                scrollbar axis (vertical and/or horizontal scrollbars) 
                values (string): "y", "x", "yx"
                */
                axis: "y",
                /*
                position of scrollbar relative to content  
                values (string): "inside", "outside" ("outside" requires elements with position:relative)
                */
                scrollbarPosition: "inside",
                /*
                scrolling inertia
                values: integer (milliseconds)
                */
                scrollInertia: 950,
                /* 
                auto-adjust scrollbar dragger length
                values: boolean
                */
                autoDraggerLength: true,
                /*
                auto-hide scrollbar when idle 
                values: boolean
                    option						default
                    -------------------------------------
                    autoHideScrollbar			false
                */
                /*
                auto-expands scrollbar on mouse-over and dragging
                values: boolean
                    option						default
                    -------------------------------------
                    autoExpandScrollbar			false
                */
                /*
                always show scrollbar, even when there's nothing to scroll 
                values: integer (0=disable, 1=always show dragger rail and buttons, 2=always show dragger rail, dragger and buttons), boolean
                */
                alwaysShowScrollbar: 0,
                /*
                scrolling always snaps to a multiple of this number in pixels
                values: integer, array ([y,x])
                    option						default
                    -------------------------------------
                    snapAmount					null
                */
                /*
                when snapping, snap with this number in pixels as an offset 
                values: integer
                */
                snapOffset: 0,
                /* 
                mouse-wheel scrolling
                */
                mouseWheel: {
                    /* 
                    enable mouse-wheel scrolling
                    values: boolean
                    */
                    enable: true,
                    /* 
                    scrolling amount in pixels
                    values: "auto", integer 
                    */
                    scrollAmount: "auto",
                    /* 
                    mouse-wheel scrolling axis 
                    the default scrolling direction when both vertical and horizontal scrollbars are present 
                    values (string): "y", "x" 
                    */
                    axis: "y",
                    /* 
                    prevent the default behaviour which automatically scrolls the parent element(s) when end of scrolling is reached 
                    values: boolean
                        option						default
                        -------------------------------------
                        preventDefault				null
                    */
                    /*
                    the reported mouse-wheel delta value. The number of lines (translated to pixels) one wheel notch scrolls.  
                    values: "auto", integer 
                    "auto" uses the default OS/browser value 
                    */
                    deltaFactor: "auto",
                    /*
                    normalize mouse-wheel delta to -1 or 1 (disables mouse-wheel acceleration) 
                    values: boolean
                        option						default
                        -------------------------------------
                        normalizeDelta				null
                    */
                    /*
                    invert mouse-wheel scrolling direction 
                    values: boolean
                        option						default
                        -------------------------------------
                        invert						null
                    */
                    /*
                    the tags that disable mouse-wheel when cursor is over them
                    */
                    disableOver: ["select", "option", "keygen", "datalist", "textarea"]
                },
                /* 
                scrollbar buttons
                */
                scrollButtons: {
                    /*
                    enable scrollbar buttons
                    values: boolean
                        option						default
                        -------------------------------------
                        enable						null
                    */
                    /*
                    scrollbar buttons scrolling type 
                    values (string): "stepless", "stepped"
                    */
                    scrollType: "stepless",
                    /*
                    scrolling amount in pixels
                    values: "auto", integer 
                    */
                    scrollAmount: "auto"
                    /*
                    tabindex of the scrollbar buttons
                    values: false, integer
                        option						default
                        -------------------------------------
                        tabindex					null
                    */
                },
                /* 
                keyboard scrolling
                */
                keyboard: {
                    /*
                    enable scrolling via keyboard
                    values: boolean
                    */
                    enable: true,
                    /*
                    keyboard scrolling type 
                    values (string): "stepless", "stepped"
                    */
                    scrollType: "stepless",
                    /*
                    scrolling amount in pixels
                    values: "auto", integer 
                    */
                    scrollAmount: "auto"
                },
                /*
                enable content touch-swipe scrolling 
                values: boolean, integer, string (number)
                integer values define the axis-specific minimum amount required for scrolling momentum
                */
                contentTouchScroll: 25,
                /*
                enable/disable document (default) touch-swipe scrolling 
                */
                documentTouchScroll: true,
                /*
                advanced option parameters
                */
                advanced: {
                    /*
                    auto-expand content horizontally (for "x" or "yx" axis) 
                    values: boolean, integer (the value 2 forces the non scrollHeight/scrollWidth method, the value 3 forces the scrollHeight/scrollWidth method)
                        option						default
                        -------------------------------------
                        autoExpandHorizontalScroll	null
                    */
                    /*
                    auto-scroll to elements with focus
                    */
                    autoScrollOnFocus: "input,textarea,select,button,datalist,keygen,a[tabindex],area,object,[contenteditable='true']",
                    /*
                    auto-update scrollbars on content, element or viewport resize 
                    should be true for fluid layouts/elements, adding/removing content dynamically, hiding/showing elements, content with images etc. 
                    values: boolean
                    */
                    updateOnContentResize: true,
                    /*
                    auto-update scrollbars each time each image inside the element is fully loaded 
                    values: "auto", boolean
                    */
                    updateOnImageLoad: "auto",
                    /*
                    auto-update scrollbars based on the amount and size changes of specific selectors 
                    useful when you need to update the scrollbar(s) automatically, each time a type of element is added, removed or changes its size 
                    values: boolean, string (e.g. "ul li" will auto-update scrollbars each time list-items inside the element are changed) 
                    a value of true (boolean) will auto-update scrollbars each time any element is changed
                        option						default
                        -------------------------------------
                        updateOnSelectorChange		null
                    */
                    /*
                    extra selectors that'll allow scrollbar dragging upon mousemove/up, pointermove/up, touchend etc. (e.g. "selector-1, selector-2")
                        option						default
                        -------------------------------------
                        extraDraggableSelectors		null
                    */
                    /*
                    extra selectors that'll release scrollbar dragging upon mouseup, pointerup, touchend etc. (e.g. "selector-1, selector-2")
                        option						default
                        -------------------------------------
                        releaseDraggableSelectors	null
                    */
                    /*
                    auto-update timeout 
                    values: integer (milliseconds)
                    */
                    autoUpdateTimeout: 60
                },
                /* 
                scrollbar theme 
                values: string (see CSS/plugin URI for a list of ready-to-use themes)
                */
                theme: "light",
                /*
                user defined callback functions
                */
                callbacks: {
                    /*
                    Available callbacks: 
                        callback					default
                        -------------------------------------
                        onCreate					null
                        onInit						null
                        onScrollStart				null
                        onScroll					null
                        onTotalScroll				null
                        onTotalScrollBack			null
                        whileScrolling				null
                        onOverflowY					null
                        onOverflowX					null
                        onOverflowYNone				null
                        onOverflowXNone				null
                        onImageLoad					null
                        onSelectorChange			null
                        onBeforeUpdate				null
                        onUpdate					null
                    */
                    onTotalScrollOffset: 0,
                    onTotalScrollBackOffset: 0,
                    alwaysTriggerOffsets: true
                }
                /*
                add scrollbar(s) on all elements matching the current selector, now and in the future 
                values: boolean, string 
                string values: "on" (enable), "once" (disable after first invocation), "off" (disable)
                liveSelector values: string (selector)
                    option						default
                    -------------------------------------
                    live						false
                    liveSelector				null
                */
            },





            /* 
            ----------------------------------------
            VARS, CONSTANTS 
            ----------------------------------------
            */

            totalInstances = 0, /* plugin instances amount */
            liveTimers = {}, /* live option timers */
            oldIE = (window.attachEvent && !window.addEventListener) ? 1 : 0, /* detect IE < 9 */
            touchActive = false, touchable, /* global touch vars (for touch and pointer events) */
            /* general plugin classes */
            classes = [
                "mCSB_dragger_onDrag", "mCSB_scrollTools_onDrag", "mCS_img_loaded", "mCS_disabled", "mCS_destroyed", "mCS_no_scrollbar",
                "mCS-autoHide", "mCS-dir-rtl", "mCS_no_scrollbar_y", "mCS_no_scrollbar_x", "mCS_y_hidden", "mCS_x_hidden", "mCSB_draggerContainer",
                "mCSB_buttonUp", "mCSB_buttonDown", "mCSB_buttonLeft", "mCSB_buttonRight"
            ],





            /* 
            ----------------------------------------
            METHODS 
            ----------------------------------------
            */

            methods = {

                /* 
                plugin initialization method 
                creates the scrollbar(s), plugin data object and options
                ----------------------------------------
                */

                init: function (options) {

                    var options = $.extend(true, {}, defaults, options),
                        selector = _selector.call(this); /* validate selector */

                    /* 
                    if live option is enabled, monitor for elements matching the current selector and 
                    apply scrollbar(s) when found (now and in the future) 
                    */
                    if (options.live) {
                        var liveSelector = options.liveSelector || this.selector || defaultSelector, /* live selector(s) */
                            $liveSelector = $(liveSelector); /* live selector(s) as jquery object */
                        if (options.live === "off") {
                            /* 
                            disable live if requested 
                            usage: $(selector).mCustomScrollbar({live:"off"}); 
                            */
                            removeLiveTimers(liveSelector);
                            return;
                        }
                        liveTimers[liveSelector] = setTimeout(function () {
                            /* call mCustomScrollbar fn on live selector(s) every half-second */
                            $liveSelector.mCustomScrollbar(options);
                            if (options.live === "once" && $liveSelector.length) {
                                /* disable live after first invocation */
                                removeLiveTimers(liveSelector);
                            }
                        }, 500);
                    } else {
                        removeLiveTimers(liveSelector);
                    }

                    /* options backward compatibility (for versions < 3.0.0) and normalization */
                    options.setWidth = (options.set_width) ? options.set_width : options.setWidth;
                    options.setHeight = (options.set_height) ? options.set_height : options.setHeight;
                    options.axis = (options.horizontalScroll) ? "x" : _findAxis(options.axis);
                    options.scrollInertia = options.scrollInertia > 0 && options.scrollInertia < 17 ? 17 : options.scrollInertia;
                    if (typeof options.mouseWheel !== "object" && options.mouseWheel == true) { /* old school mouseWheel option (non-object) */
                        options.mouseWheel = { enable: true, scrollAmount: "auto", axis: "y", preventDefault: false, deltaFactor: "auto", normalizeDelta: false, invert: false }
                    }
                    options.mouseWheel.scrollAmount = !options.mouseWheelPixels ? options.mouseWheel.scrollAmount : options.mouseWheelPixels;
                    options.mouseWheel.normalizeDelta = !options.advanced.normalizeMouseWheelDelta ? options.mouseWheel.normalizeDelta : options.advanced.normalizeMouseWheelDelta;
                    options.scrollButtons.scrollType = _findScrollButtonsType(options.scrollButtons.scrollType);

                    _theme(options); /* theme-specific options */

                    /* plugin constructor */
                    return $(selector).each(function () {

                        var $this = $(this);

                        if (!$this.data(pluginPfx)) { /* prevent multiple instantiations */

                            /* store options and create objects in jquery data */
                            $this.data(pluginPfx, {
                                idx: ++totalInstances, /* instance index */
                                opt: options, /* options */
                                scrollRatio: { y: null, x: null }, /* scrollbar to content ratio */
                                overflowed: null, /* overflowed axis */
                                contentReset: { y: null, x: null }, /* object to check when content resets */
                                bindEvents: false, /* object to check if events are bound */
                                tweenRunning: false, /* object to check if tween is running */
                                sequential: {}, /* sequential scrolling object */
                                langDir: $this.css("direction"), /* detect/store direction (ltr or rtl) */
                                cbOffsets: null, /* object to check whether callback offsets always trigger */
                                /* 
                                object to check how scrolling events where last triggered 
                                "internal" (default - triggered by this script), "external" (triggered by other scripts, e.g. via scrollTo method) 
                                usage: object.data("mCS").trigger
                                */
                                trigger: null,
                                /* 
                                object to check for changes in elements in order to call the update method automatically 
                                */
                                poll: { size: { o: 0, n: 0 }, img: { o: 0, n: 0 }, change: { o: 0, n: 0 } }
                            });

                            var d = $this.data(pluginPfx), o = d.opt,
                                /* HTML data attributes */
                                htmlDataAxis = $this.data("mcs-axis"), htmlDataSbPos = $this.data("mcs-scrollbar-position"), htmlDataTheme = $this.data("mcs-theme");

                            if (htmlDataAxis) { o.axis = htmlDataAxis; } /* usage example: data-mcs-axis="y" */
                            if (htmlDataSbPos) { o.scrollbarPosition = htmlDataSbPos; } /* usage example: data-mcs-scrollbar-position="outside" */
                            if (htmlDataTheme) { /* usage example: data-mcs-theme="minimal" */
                                o.theme = htmlDataTheme;
                                _theme(o); /* theme-specific options */
                            }

                            _pluginMarkup.call(this); /* add plugin markup */

                            if (d && o.callbacks.onCreate && typeof o.callbacks.onCreate === "function") { o.callbacks.onCreate.call(this); } /* callbacks: onCreate */

                            $("#mCSB_" + d.idx + "_container img:not(." + classes[2] + ")").addClass(classes[2]); /* flag loaded images */
                           
                            methods.update.call(null, $this); /* call the update method */

                        }

                    });

                },
                /* ---------------------------------------- */



                /* 
                plugin update method 
                updates content and scrollbar(s) values, events and status 
                ----------------------------------------
                usage: $(selector).mCustomScrollbar("update");
                */

                update: function (el, cb) {
                    var selector = el || _selector.call(this); /* validate selector */

                    return $(selector).each(function () {

                        var $this = $(this);

                        if ($this.data(pluginPfx)) { /* check if plugin has initialized */

                            var d = $this.data(pluginPfx), o = d.opt,
                                mCSB_container = $("#mCSB_" + d.idx + "_container"),
                                mCustomScrollBox = $("#mCSB_" + d.idx),
                                mCSB_dragger = [$("#mCSB_" + d.idx + "_dragger_vertical"), $("#mCSB_" + d.idx + "_dragger_horizontal")];

                            if (!mCSB_container.length) { return; }

                            if (d.tweenRunning) { _stop($this); } /* stop any running tweens while updating */

                            if (cb && d && o.callbacks.onBeforeUpdate && typeof o.callbacks.onBeforeUpdate === "function") { o.callbacks.onBeforeUpdate.call(this); } /* callbacks: onBeforeUpdate */

                            /* if element was disabled or destroyed, remove class(es) */
                            if ($this.hasClass(classes[3])) { $this.removeClass(classes[3]); }
                            if ($this.hasClass(classes[4])) { $this.removeClass(classes[4]); }

                            /* css flexbox fix, detect/set max-height */
                            mCustomScrollBox.css("max-height", "none");
                            if (mCustomScrollBox.height() !== $this.height()) { mCustomScrollBox.css("max-height", $this.height()); }

                            _expandContentHorizontally.call(this); /* expand content horizontally */

                            if (o.axis !== "y" && !o.advanced.autoExpandHorizontalScroll) {
                                mCSB_container.css("width", _contentWidth(mCSB_container));
                            }

                            d.overflowed = _overflowed.call(this); /* determine if scrolling is required */

                            _scrollbarVisibility.call(this); /* show/hide scrollbar(s) */

                            /* auto-adjust scrollbar dragger length analogous to content */
                            if (o.autoDraggerLength) { _setDraggerLength.call(this); }

                            _scrollRatio.call(this); /* calculate and store scrollbar to content ratio */

                            _bindEvents.call(this); /* bind scrollbar events */

                            /* reset scrolling position and/or events */
                            var to = [Math.abs(mCSB_container[0].offsetTop), Math.abs(mCSB_container[0].offsetLeft)];
                            if (o.axis !== "x") { /* y/yx axis */
                                if (!d.overflowed[0]) { /* y scrolling is not required */
                                    _resetContentPosition.call(this); /* reset content position */
                                    if (o.axis === "y") {
                                        _unbindEvents.call(this);
                                    } else if (o.axis === "yx" && d.overflowed[1]) {
                                        _scrollTo($this, to[1].toString(), { dir: "x", dur: 0, overwrite: "none" });
                                    }
                                } else if (mCSB_dragger[0].height() > mCSB_dragger[0].parent().height()) {
                                    _resetContentPosition.call(this); /* reset content position */
                                } else { /* y scrolling is required */
                                    _scrollTo($this, to[0].toString(), { dir: "y", dur: 0, overwrite: "none" });
                                    d.contentReset.y = null;
                                }
                            }
                            if (o.axis !== "y") { /* x/yx axis */
                                if (!d.overflowed[1]) { /* x scrolling is not required */
                                    _resetContentPosition.call(this); /* reset content position */
                                    if (o.axis === "x") {
                                        _unbindEvents.call(this);
                                    } else if (o.axis === "yx" && d.overflowed[0]) {
                                        _scrollTo($this, to[0].toString(), { dir: "y", dur: 0, overwrite: "none" });
                                    }
                                } else if (mCSB_dragger[1].width() > mCSB_dragger[1].parent().width()) {
                                    _resetContentPosition.call(this); /* reset content position */
                                } else { /* x scrolling is required */
                                    _scrollTo($this, to[1].toString(), { dir: "x", dur: 0, overwrite: "none" });
                                    d.contentReset.x = null;
                                }
                            }

                            /* callbacks: onImageLoad, onSelectorChange, onUpdate */
                            if (cb && d) {
                                if (cb === 2 && o.callbacks.onImageLoad && typeof o.callbacks.onImageLoad === "function") {
                                    o.callbacks.onImageLoad.call(this);
                                } else if (cb === 3 && o.callbacks.onSelectorChange && typeof o.callbacks.onSelectorChange === "function") {
                                    o.callbacks.onSelectorChange.call(this);
                                } else if (o.callbacks.onUpdate && typeof o.callbacks.onUpdate === "function") {
                                    o.callbacks.onUpdate.call(this);
                                }
                            }

                            _autoUpdate.call(this); /* initialize automatic updating (for dynamic content, fluid layouts etc.) */

                        }

                    });

                },
                /* ---------------------------------------- */



                /* 
                plugin scrollTo method 
                triggers a scrolling event to a specific value
                ----------------------------------------
                usage: $(selector).mCustomScrollbar("scrollTo",value,options);
                */

                scrollTo: function (val, options) {

                    /* prevent silly things like $(selector).mCustomScrollbar("scrollTo",undefined); */
                    if (typeof val == "undefined" || val == null) { return; }

                    var selector = _selector.call(this); /* validate selector */

                    return $(selector).each(function () {

                        var $this = $(this);

                        if ($this.data(pluginPfx)) { /* check if plugin has initialized */

                            var d = $this.data(pluginPfx), o = d.opt,
                                /* method default options */
                                methodDefaults = {
                                    trigger: "external", /* method is by default triggered externally (e.g. from other scripts) */
                                    scrollInertia: o.scrollInertia, /* scrolling inertia (animation duration) */
                                    scrollEasing: "mcsEaseInOut", /* animation easing */
                                    moveDragger: false, /* move dragger instead of content */
                                    timeout: 60, /* scroll-to delay */
                                    callbacks: true, /* enable/disable callbacks */
                                    onStart: true,
                                    onUpdate: true,
                                    onComplete: true
                                },
                                methodOptions = $.extend(true, {}, methodDefaults, options),
                                to = _arr.call(this, val), dur = methodOptions.scrollInertia > 0 && methodOptions.scrollInertia < 17 ? 17 : methodOptions.scrollInertia;

                            /* translate yx values to actual scroll-to positions */
                            to[0] = _to.call(this, to[0], "y");
                            to[1] = _to.call(this, to[1], "x");

                            /* 
                            check if scroll-to value moves the dragger instead of content. 
                            Only pixel values apply on dragger (e.g. 100, "100px", "-=100" etc.) 
                            */
                            if (methodOptions.moveDragger) {
                                to[0] *= d.scrollRatio.y;
                                to[1] *= d.scrollRatio.x;
                            }

                            methodOptions.dur = _isTabHidden() ? 0 : dur; //skip animations if browser tab is hidden

                            setTimeout(function () {
                                /* do the scrolling */
                                if (to[0] !== null && typeof to[0] !== "undefined" && o.axis !== "x" && d.overflowed[0]) { /* scroll y */
                                    methodOptions.dir = "y";
                                    methodOptions.overwrite = "all";
                                    _scrollTo($this, to[0].toString(), methodOptions);
                                }
                                if (to[1] !== null && typeof to[1] !== "undefined" && o.axis !== "y" && d.overflowed[1]) { /* scroll x */
                                    methodOptions.dir = "x";
                                    methodOptions.overwrite = "none";
                                    _scrollTo($this, to[1].toString(), methodOptions);
                                }
                            }, methodOptions.timeout);

                        }

                    });

                },
                /* ---------------------------------------- */



                /*
                plugin stop method 
                stops scrolling animation
                ----------------------------------------
                usage: $(selector).mCustomScrollbar("stop");
                */
                stop: function () {

                    var selector = _selector.call(this); /* validate selector */

                    return $(selector).each(function () {

                        var $this = $(this);

                        if ($this.data(pluginPfx)) { /* check if plugin has initialized */

                            _stop($this);

                        }

                    });

                },
                /* ---------------------------------------- */



                /*
                plugin disable method 
                temporarily disables the scrollbar(s) 
                ----------------------------------------
                usage: $(selector).mCustomScrollbar("disable",reset); 
                reset (boolean): resets content position to 0 
                */
                disable: function (r) {

                    var selector = _selector.call(this); /* validate selector */

                    return $(selector).each(function () {

                        var $this = $(this);

                        if ($this.data(pluginPfx)) { /* check if plugin has initialized */

                            var d = $this.data(pluginPfx);

                            _autoUpdate.call(this, "remove"); /* remove automatic updating */

                            _unbindEvents.call(this); /* unbind events */

                            if (r) { _resetContentPosition.call(this); } /* reset content position */

                            _scrollbarVisibility.call(this, true); /* show/hide scrollbar(s) */

                            $this.addClass(classes[3]); /* add disable class */

                        }

                    });

                },
                /* ---------------------------------------- */



                /*
                plugin destroy method 
                completely removes the scrollbar(s) and returns the element to its original state
                ----------------------------------------
                usage: $(selector).mCustomScrollbar("destroy"); 
                */
                destroy: function () {

                    var selector = _selector.call(this); /* validate selector */

                    return $(selector).each(function () {

                        var $this = $(this);

                        if ($this.data(pluginPfx)) { /* check if plugin has initialized */

                            var d = $this.data(pluginPfx), o = d.opt,
                                mCustomScrollBox = $("#mCSB_" + d.idx),
                                mCSB_container = $("#mCSB_" + d.idx + "_container"),
                                scrollbar = $(".mCSB_" + d.idx + "_scrollbar");

                            if (o.live) { removeLiveTimers(o.liveSelector || $(selector).selector); } /* remove live timers */

                            _autoUpdate.call(this, "remove"); /* remove automatic updating */

                            _unbindEvents.call(this); /* unbind events */

                            _resetContentPosition.call(this); /* reset content position */

                            $this.removeData(pluginPfx); /* remove plugin data object */

                            _delete(this, "mcs"); /* delete callbacks object */

                            /* remove plugin markup */
                            scrollbar.remove(); /* remove scrollbar(s) first (those can be either inside or outside plugin's inner wrapper) */
                            mCSB_container.find("img." + classes[2]).removeClass(classes[2]); /* remove loaded images flag */
                            mCustomScrollBox.replaceWith(mCSB_container.contents()); /* replace plugin's inner wrapper with the original content */
                            /* remove plugin classes from the element and add destroy class */
                            $this.removeClass(pluginNS + " _" + pluginPfx + "_" + d.idx + " " + classes[6] + " " + classes[7] + " " + classes[5] + " " + classes[3]).addClass(classes[4]);

                        }

                    });

                }
                /* ---------------------------------------- */

            },





            /* 
            ----------------------------------------
            FUNCTIONS
            ----------------------------------------
            */

            /* validates selector (if selector is invalid or undefined uses the default one) */
            _selector = function () {
                return (typeof $(this) !== "object" || $(this).length < 1) ? defaultSelector : this;
            },
            /* -------------------- */


            /* changes options according to theme */
            _theme = function (obj) {
                var fixedSizeScrollbarThemes = ["rounded", "rounded-dark", "rounded-dots", "rounded-dots-dark"],
                    nonExpandedScrollbarThemes = ["rounded-dots", "rounded-dots-dark", "3d", "3d-dark", "3d-thick", "3d-thick-dark", "inset", "inset-dark", "inset-2", "inset-2-dark", "inset-3", "inset-3-dark"],
                    disabledScrollButtonsThemes = ["minimal", "minimal-dark"],
                    enabledAutoHideScrollbarThemes = ["minimal", "minimal-dark"],
                    scrollbarPositionOutsideThemes = ["minimal", "minimal-dark"];
                obj.autoDraggerLength = $.inArray(obj.theme, fixedSizeScrollbarThemes) > -1 ? false : obj.autoDraggerLength;
                obj.autoExpandScrollbar = $.inArray(obj.theme, nonExpandedScrollbarThemes) > -1 ? false : obj.autoExpandScrollbar;
                obj.scrollButtons.enable = $.inArray(obj.theme, disabledScrollButtonsThemes) > -1 ? false : obj.scrollButtons.enable;
                obj.autoHideScrollbar = $.inArray(obj.theme, enabledAutoHideScrollbarThemes) > -1 ? true : obj.autoHideScrollbar;
                obj.scrollbarPosition = $.inArray(obj.theme, scrollbarPositionOutsideThemes) > -1 ? "outside" : obj.scrollbarPosition;
            },
            /* -------------------- */


            /* live option timers removal */
            removeLiveTimers = function (selector) {
                if (liveTimers[selector]) {
                    clearTimeout(liveTimers[selector]);
                    _delete(liveTimers, selector);
                }
            },
            /* -------------------- */


            /* normalizes axis option to valid values: "y", "x", "yx" */
            _findAxis = function (val) {
                return (val === "yx" || val === "xy" || val === "auto") ? "yx" : (val === "x" || val === "horizontal") ? "x" : "y";
            },
            /* -------------------- */


            /* normalizes scrollButtons.scrollType option to valid values: "stepless", "stepped" */
            _findScrollButtonsType = function (val) {
                return (val === "stepped" || val === "pixels" || val === "step" || val === "click") ? "stepped" : "stepless";
            },
            /* -------------------- */


            /* generates plugin markup */
            _pluginMarkup = function () {
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt,
                    expandClass = o.autoExpandScrollbar ? " " + classes[1] + "_expand" : "",
                    scrollbar = ["<div id='mCSB_" + d.idx + "_scrollbar_vertical' class='mCSB_scrollTools mCSB_" + d.idx + "_scrollbar mCS-" + o.theme + " mCSB_scrollTools_vertical" + expandClass + "'><div class='" + classes[12] + "'><div id='mCSB_" + d.idx + "_dragger_vertical' class='mCSB_dragger' style='position:absolute;'><div class='mCSB_dragger_bar' /></div><div class='mCSB_draggerRail' /></div></div>", "<div id='mCSB_" + d.idx + "_scrollbar_horizontal' class='mCSB_scrollTools mCSB_" + d.idx + "_scrollbar mCS-" + o.theme + " mCSB_scrollTools_horizontal" + expandClass + "'><div class='" + classes[12] + "'><div id='mCSB_" + d.idx + "_dragger_horizontal' class='mCSB_dragger' style='position:absolute;'><div class='mCSB_dragger_bar' /></div><div class='mCSB_draggerRail' /></div></div>"],
                    wrapperClass = o.axis === "yx" ? "mCSB_vertical_horizontal" : o.axis === "x" ? "mCSB_horizontal" : "mCSB_vertical",
                    scrollbars = o.axis === "yx" ? scrollbar[0] + scrollbar[1] : o.axis === "x" ? scrollbar[1] : scrollbar[0],
                    contentWrapper = o.axis === "yx" ? "<div id='mCSB_" + d.idx + "_container_wrapper' class='mCSB_container_wrapper' />" : "",
                    autoHideClass = o.autoHideScrollbar ? " " + classes[6] : "",
                    scrollbarDirClass = (o.axis !== "x" && d.langDir === "rtl") ? " " + classes[7] : "";
                if (o.setWidth) { $this.css("width", o.setWidth); } /* set element width */
                if (o.setHeight) { $this.css("height", o.setHeight); } /* set element height */
                o.setLeft = (o.axis !== "y" && d.langDir === "rtl") ? "989999px" : o.setLeft; /* adjust left position for rtl direction */
                $this.addClass(pluginNS + " _" + pluginPfx + "_" + d.idx + autoHideClass + scrollbarDirClass).wrapInner("<div id='mCSB_" + d.idx + "' class='mCustomScrollBox mCS-" + o.theme + " " + wrapperClass + "'><div id='mCSB_" + d.idx + "_container' class='mCSB_container' style='position:relative; top:" + o.setTop + "; left:" + o.setLeft + ";' dir='" + d.langDir + "' /></div>");
                var mCustomScrollBox = $("#mCSB_" + d.idx),
                    mCSB_container = $("#mCSB_" + d.idx + "_container");
                if (o.axis !== "y" && !o.advanced.autoExpandHorizontalScroll) {
                    mCSB_container.css("width", _contentWidth(mCSB_container));
                }
                if (o.scrollbarPosition === "outside") {
                    if ($this.css("position") === "static") { /* requires elements with non-static position */
                        $this.css("position", "relative");
                    }
                    $this.css("overflow", "visible");
                    mCustomScrollBox.addClass("mCSB_outside").after(scrollbars);
                } else {
                    mCustomScrollBox.addClass("mCSB_inside").append(scrollbars);
                    mCSB_container.wrap(contentWrapper);
                }
                _scrollButtons.call(this); /* add scrollbar buttons */
                /* minimum dragger length */
                var mCSB_dragger = [$("#mCSB_" + d.idx + "_dragger_vertical"), $("#mCSB_" + d.idx + "_dragger_horizontal")];
                mCSB_dragger[0].css("min-height", mCSB_dragger[0].height());
                mCSB_dragger[1].css("min-width", mCSB_dragger[1].width());
            },
            /* -------------------- */


            /* calculates content width */
            _contentWidth = function (el) {
                var val = [el[0].scrollWidth, Math.max.apply(Math, el.children().map(function () { return $(this).outerWidth(true); }).get())], w = el.parent().width();
                return val[0] > w ? val[0] : val[1] > w ? val[1] : "100%";
            },
            /* -------------------- */


            /* expands content horizontally */
            _expandContentHorizontally = function () {
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt,
                    mCSB_container = $("#mCSB_" + d.idx + "_container");
                if (o.advanced.autoExpandHorizontalScroll && o.axis !== "y") {
                    /* calculate scrollWidth */
                    mCSB_container.css({ "width": "auto", "min-width": 0, "overflow-x": "scroll" });
                    var w = Math.ceil(mCSB_container[0].scrollWidth);
                    if (o.advanced.autoExpandHorizontalScroll === 3 || (o.advanced.autoExpandHorizontalScroll !== 2 && w > mCSB_container.parent().width())) {
                        mCSB_container.css({ "width": w, "min-width": "100%", "overflow-x": "inherit" });
                    } else {
                        /* 
                        wrap content with an infinite width div and set its position to absolute and width to auto. 
                        Setting width to auto before calculating the actual width is important! 
                        We must let the browser set the width as browser zoom values are impossible to calculate.
                        */
                        mCSB_container.css({ "overflow-x": "inherit", "position": "absolute" })
                            .wrap("<div class='mCSB_h_wrapper' style='position:relative; left:0; width:999999px;' />")
                            .css({ /* set actual width, original position and un-wrap */
                                /* 
                                get the exact width (with decimals) and then round-up. 
                                Using jquery outerWidth() will round the width value which will mess up with inner elements that have non-integer width
                                */
                                "width": (Math.ceil(mCSB_container[0].getBoundingClientRect().right + 0.4) - Math.floor(mCSB_container[0].getBoundingClientRect().left)),
                                "min-width": "100%",
                                "position": "relative"
                            }).unwrap();
                    }
                }
            },
            /* -------------------- */


            /* adds scrollbar buttons */
            _scrollButtons = function () {
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt,
                    mCSB_scrollTools = $(".mCSB_" + d.idx + "_scrollbar:first"),
                    tabindex = !_isNumeric(o.scrollButtons.tabindex) ? "" : "tabindex='" + o.scrollButtons.tabindex + "'",
                    btnHTML = [
                        "<a href='#' class='" + classes[13] + "' " + tabindex + " />",
                        "<a href='#' class='" + classes[14] + "' " + tabindex + " />",
                        "<a href='#' class='" + classes[15] + "' " + tabindex + " />",
                        "<a href='#' class='" + classes[16] + "' " + tabindex + " />"
                    ],
                    btn = [(o.axis === "x" ? btnHTML[2] : btnHTML[0]), (o.axis === "x" ? btnHTML[3] : btnHTML[1]), btnHTML[2], btnHTML[3]];
                if (o.scrollButtons.enable) {
                    mCSB_scrollTools.prepend(btn[0]).append(btn[1]).next(".mCSB_scrollTools").prepend(btn[2]).append(btn[3]);
                }
            },
            /* -------------------- */


            /* auto-adjusts scrollbar dragger length */
            _setDraggerLength = function () {
                var $this = $(this), d = $this.data(pluginPfx),
                    mCustomScrollBox = $("#mCSB_" + d.idx),
                    mCSB_container = $("#mCSB_" + d.idx + "_container"),
                    mCSB_dragger = [$("#mCSB_" + d.idx + "_dragger_vertical"), $("#mCSB_" + d.idx + "_dragger_horizontal")],
                    ratio = [mCustomScrollBox.height() / mCSB_container.outerHeight(false), mCustomScrollBox.width() / mCSB_container.outerWidth(false)],
                    l = [
                        parseInt(mCSB_dragger[0].css("min-height")), Math.round(ratio[0] * mCSB_dragger[0].parent().height()),
                        parseInt(mCSB_dragger[1].css("min-width")), Math.round(ratio[1] * mCSB_dragger[1].parent().width())
                    ],
                    h = oldIE && (l[1] < l[0]) ? l[0] : l[1], w = oldIE && (l[3] < l[2]) ? l[2] : l[3];
                mCSB_dragger[0].css({
                    "height": h, "max-height": (mCSB_dragger[0].parent().height() - 10)
                }).find(".mCSB_dragger_bar").css({ "line-height": l[0] + "px" });
                mCSB_dragger[1].css({
                    "width": w, "max-width": (mCSB_dragger[1].parent().width() - 10)
                });
            },
            /* -------------------- */


            /* calculates scrollbar to content ratio */
            _scrollRatio = function () {
                var $this = $(this), d = $this.data(pluginPfx),
                    mCustomScrollBox = $("#mCSB_" + d.idx),
                    mCSB_container = $("#mCSB_" + d.idx + "_container"),
                    mCSB_dragger = [$("#mCSB_" + d.idx + "_dragger_vertical"), $("#mCSB_" + d.idx + "_dragger_horizontal")],
                    scrollAmount = [mCSB_container.outerHeight(false) - mCustomScrollBox.height(), mCSB_container.outerWidth(false) - mCustomScrollBox.width()],
                    ratio = [
                        scrollAmount[0] / (mCSB_dragger[0].parent().height() - mCSB_dragger[0].height()),
                        scrollAmount[1] / (mCSB_dragger[1].parent().width() - mCSB_dragger[1].width())
                    ];
                d.scrollRatio = { y: ratio[0], x: ratio[1] };
            },
            /* -------------------- */


            /* toggles scrolling classes */
            _onDragClasses = function (el, action, xpnd) {
                var expandClass = xpnd ? classes[0] + "_expanded" : "",
                    scrollbar = el.closest(".mCSB_scrollTools");
                if (action === "active") {
                    el.toggleClass(classes[0] + " " + expandClass); scrollbar.toggleClass(classes[1]);
                    el[0]._draggable = el[0]._draggable ? 0 : 1;
                } else {
                    if (!el[0]._draggable) {
                        if (action === "hide") {
                            el.removeClass(classes[0]); scrollbar.removeClass(classes[1]);
                        } else {
                            el.addClass(classes[0]); scrollbar.addClass(classes[1]);
                        }
                    }
                }
            },
            /* -------------------- */


            /* checks if content overflows its container to determine if scrolling is required */
            _overflowed = function () {
                var $this = $(this), d = $this.data(pluginPfx),
                    mCustomScrollBox = $("#mCSB_" + d.idx),
                    mCSB_container = $("#mCSB_" + d.idx + "_container"),
                    contentHeight = d.overflowed == null ? mCSB_container.height() : mCSB_container.outerHeight(false),
                    contentWidth = d.overflowed == null ? mCSB_container.width() : mCSB_container.outerWidth(false),
                    h = mCSB_container[0].scrollHeight, w = mCSB_container[0].scrollWidth;
                if (h > contentHeight) { contentHeight = h; }
                if (w > contentWidth) { contentWidth = w; }
                return [contentHeight > mCustomScrollBox.height(), contentWidth > mCustomScrollBox.width()];
            },
            /* -------------------- */


            /* resets content position to 0 */
            _resetContentPosition = function () {
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt,
                    mCustomScrollBox = $("#mCSB_" + d.idx),
                    mCSB_container = $("#mCSB_" + d.idx + "_container"),
                    mCSB_dragger = [$("#mCSB_" + d.idx + "_dragger_vertical"), $("#mCSB_" + d.idx + "_dragger_horizontal")];
                _stop($this); /* stop any current scrolling before resetting */
                if ((o.axis !== "x" && !d.overflowed[0]) || (o.axis === "y" && d.overflowed[0])) { /* reset y */
                    mCSB_dragger[0].add(mCSB_container).css("top", 0);
                    _scrollTo($this, "_resetY");
                }
                if ((o.axis !== "y" && !d.overflowed[1]) || (o.axis === "x" && d.overflowed[1])) { /* reset x */
                    var cx = dx = 0;
                    if (d.langDir === "rtl") { /* adjust left position for rtl direction */
                        cx = mCustomScrollBox.width() - mCSB_container.outerWidth(false);
                        dx = Math.abs(cx / d.scrollRatio.x);
                    }
                    mCSB_container.css("left", cx);
                    mCSB_dragger[1].css("left", dx);
                    _scrollTo($this, "_resetX");
                }
            },
            /* -------------------- */


            /* binds scrollbar events */
            _bindEvents = function () {
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt;
                if (!d.bindEvents) { /* check if events are already bound */
                    _draggable.call(this);
                    if (o.contentTouchScroll) { _contentDraggable.call(this); }
                    _selectable.call(this);
                    if (o.mouseWheel.enable) { /* bind mousewheel fn when plugin is available */
                        function _mwt() {
                            mousewheelTimeout = setTimeout(function () {
                                if (!$.event.special.mousewheel) {
                                    _mwt();
                                } else {
                                    clearTimeout(mousewheelTimeout);
                                    _mousewheel.call($this[0]);
                                }
                            }, 100);
                        }
                        var mousewheelTimeout;
                        _mwt();
                    }
                    _draggerRail.call(this);
                    _wrapperScroll.call(this);
                    if (o.advanced.autoScrollOnFocus) { _focus.call(this); }
                    if (o.scrollButtons.enable) { _buttons.call(this); }
                    if (o.keyboard.enable) { _keyboard.call(this); }
                    d.bindEvents = true;
                }
            },
            /* -------------------- */


            /* unbinds scrollbar events */
            _unbindEvents = function () {
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt,
                    namespace = pluginPfx + "_" + d.idx,
                    sb = ".mCSB_" + d.idx + "_scrollbar",
                    sel = $("#mCSB_" + d.idx + ",#mCSB_" + d.idx + "_container,#mCSB_" + d.idx + "_container_wrapper," + sb + " ." + classes[12] + ",#mCSB_" + d.idx + "_dragger_vertical,#mCSB_" + d.idx + "_dragger_horizontal," + sb + ">a"),
                    mCSB_container = $("#mCSB_" + d.idx + "_container");
                if (o.advanced.releaseDraggableSelectors) { sel.add($(o.advanced.releaseDraggableSelectors)); }
                if (o.advanced.extraDraggableSelectors) { sel.add($(o.advanced.extraDraggableSelectors)); }
                if (d.bindEvents) { /* check if events are bound */
                    /* unbind namespaced events from document/selectors */
                    $(document).add($(!_canAccessIFrame() || top.document)).unbind("." + namespace);
                    sel.each(function () {
                        $(this).unbind("." + namespace);
                    });
                    /* clear and delete timeouts/objects */
                    clearTimeout($this[0]._focusTimeout); _delete($this[0], "_focusTimeout");
                    clearTimeout(d.sequential.step); _delete(d.sequential, "step");
                    clearTimeout(mCSB_container[0].onCompleteTimeout); _delete(mCSB_container[0], "onCompleteTimeout");
                    d.bindEvents = false;
                }
            },
            /* -------------------- */


            /* toggles scrollbar visibility */
            _scrollbarVisibility = function (disabled) {
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt,
                    contentWrapper = $("#mCSB_" + d.idx + "_container_wrapper"),
                    content = contentWrapper.length ? contentWrapper : $("#mCSB_" + d.idx + "_container"),
                    scrollbar = [$("#mCSB_" + d.idx + "_scrollbar_vertical"), $("#mCSB_" + d.idx + "_scrollbar_horizontal")],
                    mCSB_dragger = [scrollbar[0].find(".mCSB_dragger"), scrollbar[1].find(".mCSB_dragger")];
                if (o.axis !== "x") {
                    if (d.overflowed[0] && !disabled) {
                        scrollbar[0].add(mCSB_dragger[0]).add(scrollbar[0].children("a")).css("display", "block");
                        content.removeClass(classes[8] + " " + classes[10]);
                    } else {
                        if (o.alwaysShowScrollbar) {
                            if (o.alwaysShowScrollbar !== 2) { mCSB_dragger[0].css("display", "none"); }
                            content.removeClass(classes[10]);
                        } else {
                            scrollbar[0].css("display", "none");
                            content.addClass(classes[10]);
                        }
                        content.addClass(classes[8]);
                    }
                }
                if (o.axis !== "y") {
                    if (d.overflowed[1] && !disabled) {
                        scrollbar[1].add(mCSB_dragger[1]).add(scrollbar[1].children("a")).css("display", "block");
                        content.removeClass(classes[9] + " " + classes[11]);
                    } else {
                        if (o.alwaysShowScrollbar) {
                            if (o.alwaysShowScrollbar !== 2) { mCSB_dragger[1].css("display", "none"); }
                            content.removeClass(classes[11]);
                        } else {
                            scrollbar[1].css("display", "none");
                            content.addClass(classes[11]);
                        }
                        content.addClass(classes[9]);
                    }
                }
                if (!d.overflowed[0] && !d.overflowed[1]) {
                    $this.addClass(classes[5]);
                } else {
                    $this.removeClass(classes[5]);
                }
            },
            /* -------------------- */


            /* returns input coordinates of pointer, touch and mouse events (relative to document) */
            _coordinates = function (e) {
                var t = e.type, o = e.target.ownerDocument !== document && frameElement !== null ? [$(frameElement).offset().top, $(frameElement).offset().left] : null,
                    io = _canAccessIFrame() && e.target.ownerDocument !== top.document && frameElement !== null ? [$(e.view.frameElement).offset().top, $(e.view.frameElement).offset().left] : [0, 0];
                switch (t) {
                    case "pointerdown": case "MSPointerDown": case "pointermove": case "MSPointerMove": case "pointerup": case "MSPointerUp":
                        return o ? [e.originalEvent.pageY - o[0] + io[0], e.originalEvent.pageX - o[1] + io[1], false] : [e.originalEvent.pageY, e.originalEvent.pageX, false];
                        break;
                    case "touchstart": case "touchmove": case "touchend":
                        var touch = e.originalEvent.touches[0] || e.originalEvent.changedTouches[0],
                            touches = e.originalEvent.touches.length || e.originalEvent.changedTouches.length;
                        return e.target.ownerDocument !== document ? [touch.screenY, touch.screenX, touches > 1] : [touch.pageY, touch.pageX, touches > 1];
                        break;
                    default:
                        return o ? [e.pageY - o[0] + io[0], e.pageX - o[1] + io[1], false] : [e.pageY, e.pageX, false];
                }
            },
            /* -------------------- */


            /* 
            SCROLLBAR DRAG EVENTS
            scrolls content via scrollbar dragging 
            */
            _draggable = function () {
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt,
                    namespace = pluginPfx + "_" + d.idx,
                    draggerId = ["mCSB_" + d.idx + "_dragger_vertical", "mCSB_" + d.idx + "_dragger_horizontal"],
                    mCSB_container = $("#mCSB_" + d.idx + "_container"),
                    mCSB_dragger = $("#" + draggerId[0] + ",#" + draggerId[1]),
                    draggable, dragY, dragX,
                    rds = o.advanced.releaseDraggableSelectors ? mCSB_dragger.add($(o.advanced.releaseDraggableSelectors)) : mCSB_dragger,
                    eds = o.advanced.extraDraggableSelectors ? $(!_canAccessIFrame() || top.document).add($(o.advanced.extraDraggableSelectors)) : $(!_canAccessIFrame() || top.document);
                mCSB_dragger.bind("contextmenu." + namespace, function (e) {
                    e.preventDefault(); //prevent right click
                }).bind("mousedown." + namespace + " touchstart." + namespace + " pointerdown." + namespace + " MSPointerDown." + namespace, function (e) {
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    if (!_mouseBtnLeft(e)) { return; } /* left mouse button only */
                    touchActive = true;
                    if (oldIE) { document.onselectstart = function () { return false; } } /* disable text selection for IE < 9 */
                    _iframe.call(mCSB_container, false); /* enable scrollbar dragging over iframes by disabling their events */
                    _stop($this);
                    draggable = $(this);
                    var offset = draggable.offset(), y = _coordinates(e)[0] - offset.top, x = _coordinates(e)[1] - offset.left,
                        h = draggable.height() + offset.top, w = draggable.width() + offset.left;
                    if (y < h && y > 0 && x < w && x > 0) {
                        dragY = y;
                        dragX = x;
                    }
                    _onDragClasses(draggable, "active", o.autoExpandScrollbar);
                }).bind("touchmove." + namespace, function (e) {
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    var offset = draggable.offset(), y = _coordinates(e)[0] - offset.top, x = _coordinates(e)[1] - offset.left;
                    _drag(dragY, dragX, y, x);
                });
                $(document).add(eds).bind("mousemove." + namespace + " pointermove." + namespace + " MSPointerMove." + namespace, function (e) {
                    if (draggable) {
                        var offset = draggable.offset(), y = _coordinates(e)[0] - offset.top, x = _coordinates(e)[1] - offset.left;
                        if (dragY === y && dragX === x) { return; } /* has it really moved? */
                        _drag(dragY, dragX, y, x);
                    }
                }).add(rds).bind("mouseup." + namespace + " touchend." + namespace + " pointerup." + namespace + " MSPointerUp." + namespace, function (e) {
                    if (draggable) {
                        _onDragClasses(draggable, "active", o.autoExpandScrollbar);
                        draggable = null;
                    }
                    touchActive = false;
                    if (oldIE) { document.onselectstart = null; } /* enable text selection for IE < 9 */
                    _iframe.call(mCSB_container, true); /* enable iframes events */
                });
                function _drag(dragY, dragX, y, x) {
                    mCSB_container[0].idleTimer = o.scrollInertia < 233 ? 250 : 0;
                    if (draggable.attr("id") === draggerId[1]) {
                        var dir = "x", to = ((draggable[0].offsetLeft - dragX) + x) * d.scrollRatio.x;
                    } else {
                        var dir = "y", to = ((draggable[0].offsetTop - dragY) + y) * d.scrollRatio.y;
                    }
                    _scrollTo($this, to.toString(), { dir: dir, drag: true });
                }
            },
            /* -------------------- */


            /* 
            TOUCH SWIPE EVENTS
            scrolls content via touch swipe 
            Emulates the native touch-swipe scrolling with momentum found in iOS, Android and WP devices 
            */
            _contentDraggable = function () {
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt,
                    namespace = pluginPfx + "_" + d.idx,
                    mCustomScrollBox = $("#mCSB_" + d.idx),
                    mCSB_container = $("#mCSB_" + d.idx + "_container"),
                    mCSB_dragger = [$("#mCSB_" + d.idx + "_dragger_vertical"), $("#mCSB_" + d.idx + "_dragger_horizontal")],
                    draggable, dragY, dragX, touchStartY, touchStartX, touchMoveY = [], touchMoveX = [], startTime, runningTime, endTime, distance, speed, amount,
                    durA = 0, durB, overwrite = o.axis === "yx" ? "none" : "all", touchIntent = [], touchDrag, docDrag,
                    iframe = mCSB_container.find("iframe"),
                    events = [
                        "touchstart." + namespace + " pointerdown." + namespace + " MSPointerDown." + namespace, //start
                        "touchmove." + namespace + " pointermove." + namespace + " MSPointerMove." + namespace, //move
                        "touchend." + namespace + " pointerup." + namespace + " MSPointerUp." + namespace //end
                    ],
                    touchAction = document.body.style.touchAction !== undefined && document.body.style.touchAction !== "";
                mCSB_container.bind(events[0], function (e) {
                    _onTouchstart(e);
                }).bind(events[1], function (e) {
                    _onTouchmove(e);
                });
                mCustomScrollBox.bind(events[0], function (e) {
                    _onTouchstart2(e);
                }).bind(events[2], function (e) {
                    _onTouchend(e);
                });
                if (iframe.length) {
                    iframe.each(function () {
                        $(this).bind("load", function () {
                            /* bind events on accessible iframes */
                            if (_canAccessIFrame(this)) {
                                $(this.contentDocument || this.contentWindow.document).bind(events[0], function (e) {
                                    _onTouchstart(e);
                                    _onTouchstart2(e);
                                }).bind(events[1], function (e) {
                                    _onTouchmove(e);
                                }).bind(events[2], function (e) {
                                    _onTouchend(e);
                                });
                            }
                        });
                    });
                }
                function _onTouchstart(e) {
                    if (!_pointerTouch(e) || touchActive || _coordinates(e)[2]) { touchable = 0; return; }
                    touchable = 1; touchDrag = 0; docDrag = 0; draggable = 1;
                    $this.removeClass("mCS_touch_action");
                    var offset = mCSB_container.offset();
                    dragY = _coordinates(e)[0] - offset.top;
                    dragX = _coordinates(e)[1] - offset.left;
                    touchIntent = [_coordinates(e)[0], _coordinates(e)[1]];
                }
                function _onTouchmove(e) {
                    if (!_pointerTouch(e) || touchActive || _coordinates(e)[2]) { return; }
                    if (!o.documentTouchScroll) { e.preventDefault(); }
                    e.stopImmediatePropagation();
                    if (docDrag && !touchDrag) { return; }
                    if (draggable) {
                        runningTime = _getTime();
                        var offset = mCustomScrollBox.offset(), y = _coordinates(e)[0] - offset.top, x = _coordinates(e)[1] - offset.left,
                            easing = "mcsLinearOut";
                        touchMoveY.push(y);
                        touchMoveX.push(x);
                        touchIntent[2] = Math.abs(_coordinates(e)[0] - touchIntent[0]); touchIntent[3] = Math.abs(_coordinates(e)[1] - touchIntent[1]);
                        if (d.overflowed[0]) {
                            var limit = mCSB_dragger[0].parent().height() - mCSB_dragger[0].height(),
                                prevent = ((dragY - y) > 0 && (y - dragY) > -(limit * d.scrollRatio.y) && (touchIntent[3] * 2 < touchIntent[2] || o.axis === "yx"));
                        }
                        if (d.overflowed[1]) {
                            var limitX = mCSB_dragger[1].parent().width() - mCSB_dragger[1].width(),
                                preventX = ((dragX - x) > 0 && (x - dragX) > -(limitX * d.scrollRatio.x) && (touchIntent[2] * 2 < touchIntent[3] || o.axis === "yx"));
                        }
                        if (prevent || preventX) { /* prevent native document scrolling */
                            if (!touchAction) { e.preventDefault(); }
                            touchDrag = 1;
                        } else {
                            docDrag = 1;
                            $this.addClass("mCS_touch_action");
                        }
                        if (touchAction) { e.preventDefault(); }
                        amount = o.axis === "yx" ? [(dragY - y), (dragX - x)] : o.axis === "x" ? [null, (dragX - x)] : [(dragY - y), null];
                        mCSB_container[0].idleTimer = 250;
                        if (d.overflowed[0]) { _drag(amount[0], durA, easing, "y", "all", true); }
                        if (d.overflowed[1]) { _drag(amount[1], durA, easing, "x", overwrite, true); }
                    }
                }
                function _onTouchstart2(e) {
                    if (!_pointerTouch(e) || touchActive || _coordinates(e)[2]) { touchable = 0; return; }
                    touchable = 1;
                    e.stopImmediatePropagation();
                    _stop($this);
                    startTime = _getTime();
                    var offset = mCustomScrollBox.offset();
                    touchStartY = _coordinates(e)[0] - offset.top;
                    touchStartX = _coordinates(e)[1] - offset.left;
                    touchMoveY = []; touchMoveX = [];
                }
                function _onTouchend(e) {
                    if (!_pointerTouch(e) || touchActive || _coordinates(e)[2]) { return; }
                    draggable = 0;
                    e.stopImmediatePropagation();
                    touchDrag = 0; docDrag = 0;
                    endTime = _getTime();
                    var offset = mCustomScrollBox.offset(), y = _coordinates(e)[0] - offset.top, x = _coordinates(e)[1] - offset.left;
                    if ((endTime - runningTime) > 30) { return; }
                    speed = 1000 / (endTime - startTime);
                    var easing = "mcsEaseOut", slow = speed < 2.5,
                        diff = slow ? [touchMoveY[touchMoveY.length - 2], touchMoveX[touchMoveX.length - 2]] : [0, 0];
                    distance = slow ? [(y - diff[0]), (x - diff[1])] : [y - touchStartY, x - touchStartX];
                    var absDistance = [Math.abs(distance[0]), Math.abs(distance[1])];
                    speed = slow ? [Math.abs(distance[0] / 4), Math.abs(distance[1] / 4)] : [speed, speed];
                    var a = [
                        Math.abs(mCSB_container[0].offsetTop) - (distance[0] * _m((absDistance[0] / speed[0]), speed[0])),
                        Math.abs(mCSB_container[0].offsetLeft) - (distance[1] * _m((absDistance[1] / speed[1]), speed[1]))
                    ];
                    amount = o.axis === "yx" ? [a[0], a[1]] : o.axis === "x" ? [null, a[1]] : [a[0], null];
                    durB = [(absDistance[0] * 4) + o.scrollInertia, (absDistance[1] * 4) + o.scrollInertia];
                    var md = parseInt(o.contentTouchScroll) || 0; /* absolute minimum distance required */
                    amount[0] = absDistance[0] > md ? amount[0] : 0;
                    amount[1] = absDistance[1] > md ? amount[1] : 0;
                    if (d.overflowed[0]) { _drag(amount[0], durB[0], easing, "y", overwrite, false); }
                    if (d.overflowed[1]) { _drag(amount[1], durB[1], easing, "x", overwrite, false); }
                }
                function _m(ds, s) {
                    var r = [s * 1.5, s * 2, s / 1.5, s / 2];
                    if (ds > 90) {
                        return s > 4 ? r[0] : r[3];
                    } else if (ds > 60) {
                        return s > 3 ? r[3] : r[2];
                    } else if (ds > 30) {
                        return s > 8 ? r[1] : s > 6 ? r[0] : s > 4 ? s : r[2];
                    } else {
                        return s > 8 ? s : r[3];
                    }
                }
                function _drag(amount, dur, easing, dir, overwrite, drag) {
                    if (!amount) { return; }
                    _scrollTo($this, amount.toString(), { dur: dur, scrollEasing: easing, dir: dir, overwrite: overwrite, drag: drag });
                }
            },
            /* -------------------- */


            /* 
            SELECT TEXT EVENTS 
            scrolls content when text is selected 
            */
            _selectable = function () {
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt, seq = d.sequential,
                    namespace = pluginPfx + "_" + d.idx,
                    mCSB_container = $("#mCSB_" + d.idx + "_container"),
                    wrapper = mCSB_container.parent(),
                    action;
                mCSB_container.bind("mousedown." + namespace, function (e) {
                    if (touchable) { return; }
                    if (!action) { action = 1; touchActive = true; }
                }).add(document).bind("mousemove." + namespace, function (e) {
                    if (!touchable && action && _sel()) {
                        var offset = mCSB_container.offset(),
                            y = _coordinates(e)[0] - offset.top + mCSB_container[0].offsetTop, x = _coordinates(e)[1] - offset.left + mCSB_container[0].offsetLeft;
                        if (y > 0 && y < wrapper.height() && x > 0 && x < wrapper.width()) {
                            if (seq.step) { _seq("off", null, "stepped"); }
                        } else {
                            if (o.axis !== "x" && d.overflowed[0]) {
                                if (y < 0) {
                                    _seq("on", 38);
                                } else if (y > wrapper.height()) {
                                    _seq("on", 40);
                                }
                            }
                            if (o.axis !== "y" && d.overflowed[1]) {
                                if (x < 0) {
                                    _seq("on", 37);
                                } else if (x > wrapper.width()) {
                                    _seq("on", 39);
                                }
                            }
                        }
                    }
                }).bind("mouseup." + namespace + " dragend." + namespace, function (e) {
                    if (touchable) { return; }
                    if (action) { action = 0; _seq("off", null); }
                    touchActive = false;
                });
                function _sel() {
                    return window.getSelection ? window.getSelection().toString() :
                        document.selection && document.selection.type != "Control" ? document.selection.createRange().text : 0;
                }
                function _seq(a, c, s) {
                    seq.type = s && action ? "stepped" : "stepless";
                    seq.scrollAmount = 10;
                    _sequentialScroll($this, a, c, "mcsLinearOut", s ? 60 : null);
                }
            },
            /* -------------------- */


            /* 
            MOUSE WHEEL EVENT
            scrolls content via mouse-wheel 
            via mouse-wheel plugin (https://github.com/brandonaaron/jquery-mousewheel)
            */
            _mousewheel = function () {
                if (!$(this).data(pluginPfx)) { return; } /* Check if the scrollbar is ready to use mousewheel events (issue: #185) */
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt,
                    namespace = pluginPfx + "_" + d.idx,
                    mCustomScrollBox = $("#mCSB_" + d.idx),
                    mCSB_dragger = [$("#mCSB_" + d.idx + "_dragger_vertical"), $("#mCSB_" + d.idx + "_dragger_horizontal")],
                    iframe = $("#mCSB_" + d.idx + "_container").find("iframe");
                if (iframe.length) {
                    iframe.each(function () {
                        $(this).bind("load", function () {
                            /* bind events on accessible iframes */
                            if (_canAccessIFrame(this)) {
                                $(this.contentDocument || this.contentWindow.document).bind("mousewheel." + namespace, function (e, delta) {
                                    _onMousewheel(e, delta);
                                });
                            }
                        });
                    });
                }
                mCustomScrollBox.bind("mousewheel." + namespace, function (e, delta) {
                    _onMousewheel(e, delta);
                });
                function _onMousewheel(e, delta) {
                    _stop($this);
                    if (_disableMousewheel($this, e.target)) { return; } /* disables mouse-wheel when hovering specific elements */
                    var deltaFactor = o.mouseWheel.deltaFactor !== "auto" ? parseInt(o.mouseWheel.deltaFactor) : (oldIE && e.deltaFactor < 100) ? 100 : e.deltaFactor || 100,
                        dur = o.scrollInertia;
                    if (o.axis === "x" || o.mouseWheel.axis === "x") {
                        var dir = "x",
                            px = [Math.round(deltaFactor * d.scrollRatio.x), parseInt(o.mouseWheel.scrollAmount)],
                            amount = o.mouseWheel.scrollAmount !== "auto" ? px[1] : px[0] >= mCustomScrollBox.width() ? mCustomScrollBox.width() * 0.9 : px[0],
                            contentPos = Math.abs($("#mCSB_" + d.idx + "_container")[0].offsetLeft),
                            draggerPos = mCSB_dragger[1][0].offsetLeft,
                            limit = mCSB_dragger[1].parent().width() - mCSB_dragger[1].width(),
                            dlt = o.mouseWheel.axis === "y" ? (e.deltaY || delta) : e.deltaX;
                    } else {
                        var dir = "y",
                            px = [Math.round(deltaFactor * d.scrollRatio.y), parseInt(o.mouseWheel.scrollAmount)],
                            amount = o.mouseWheel.scrollAmount !== "auto" ? px[1] : px[0] >= mCustomScrollBox.height() ? mCustomScrollBox.height() * 0.9 : px[0],
                            contentPos = Math.abs($("#mCSB_" + d.idx + "_container")[0].offsetTop),
                            draggerPos = mCSB_dragger[0][0].offsetTop,
                            limit = mCSB_dragger[0].parent().height() - mCSB_dragger[0].height(),
                            dlt = e.deltaY || delta;
                    }
                    if ((dir === "y" && !d.overflowed[0]) || (dir === "x" && !d.overflowed[1])) { return; }
                    if (o.mouseWheel.invert || e.webkitDirectionInvertedFromDevice) { dlt = -dlt; }
                    if (o.mouseWheel.normalizeDelta) { dlt = dlt < 0 ? -1 : 1; }
                    if ((dlt > 0 && draggerPos !== 0) || (dlt < 0 && draggerPos !== limit) || o.mouseWheel.preventDefault) {
                        e.stopImmediatePropagation();
                        e.preventDefault();
                    }
                    if (e.deltaFactor < 5 && !o.mouseWheel.normalizeDelta) {
                        //very low deltaFactor values mean some kind of delta acceleration (e.g. osx trackpad), so adjusting scrolling accordingly
                        amount = e.deltaFactor; dur = 17;
                    }
                    _scrollTo($this, (contentPos - (dlt * amount)).toString(), { dir: dir, dur: dur });
                }
            },
            /* -------------------- */


            /* checks if iframe can be accessed */
            _canAccessIFrameCache = new Object(),
            _canAccessIFrame = function (iframe) {
                var result = false, cacheKey = false, html = null;
                if (iframe === undefined) {
                    cacheKey = "#empty";
                } else if ($(iframe).attr("id") !== undefined) {
                    cacheKey = $(iframe).attr("id");
                }
                if (cacheKey !== false && _canAccessIFrameCache[cacheKey] !== undefined) {
                    return _canAccessIFrameCache[cacheKey];
                }
                if (!iframe) {
                    try {
                        var doc = top.document;
                        html = doc.body.innerHTML;
                    } catch (err) {/* do nothing */ }
                    result = (html !== null);
                } else {
                    try {
                        var doc = iframe.contentDocument || iframe.contentWindow.document;
                        html = doc.body.innerHTML;
                    } catch (err) {/* do nothing */ }
                    result = (html !== null);
                }
                if (cacheKey !== false) { _canAccessIFrameCache[cacheKey] = result; }
                return result;
            },
            /* -------------------- */


            /* switches iframe's pointer-events property (drag, mousewheel etc. over cross-domain iframes) */
            _iframe = function (evt) {
                var el = this.find("iframe");
                if (!el.length) { return; } /* check if content contains iframes */
                var val = !evt ? "none" : "auto";
                el.css("pointer-events", val); /* for IE11, iframe's display property should not be "block" */
            },
            /* -------------------- */


            /* disables mouse-wheel when hovering specific elements like select, datalist etc. */
            _disableMousewheel = function (el, target) {
                var tag = target.nodeName.toLowerCase(),
                    tags = el.data(pluginPfx).opt.mouseWheel.disableOver,
                    /* elements that require focus */
                    focusTags = ["select", "textarea"];
                return $.inArray(tag, tags) > -1 && !($.inArray(tag, focusTags) > -1 && !$(target).is(":focus"));
            },
            /* -------------------- */


            /* 
            DRAGGER RAIL CLICK EVENT
            scrolls content via dragger rail 
            */
            _draggerRail = function () {
                var $this = $(this), d = $this.data(pluginPfx),
                    namespace = pluginPfx + "_" + d.idx,
                    mCSB_container = $("#mCSB_" + d.idx + "_container"),
                    wrapper = mCSB_container.parent(),
                    mCSB_draggerContainer = $(".mCSB_" + d.idx + "_scrollbar ." + classes[12]),
                    clickable;
                mCSB_draggerContainer.bind("mousedown." + namespace + " touchstart." + namespace + " pointerdown." + namespace + " MSPointerDown." + namespace, function (e) {
                    touchActive = true;
                    if (!$(e.target).hasClass("mCSB_dragger")) { clickable = 1; }
                }).bind("touchend." + namespace + " pointerup." + namespace + " MSPointerUp." + namespace, function (e) {
                    touchActive = false;
                }).bind("click." + namespace, function (e) {
                    if (!clickable) { return; }
                    clickable = 0;
                    if ($(e.target).hasClass(classes[12]) || $(e.target).hasClass("mCSB_draggerRail")) {
                        _stop($this);
                        var el = $(this), mCSB_dragger = el.find(".mCSB_dragger");
                        if (el.parent(".mCSB_scrollTools_horizontal").length > 0) {
                            if (!d.overflowed[1]) { return; }
                            var dir = "x",
                                clickDir = e.pageX > mCSB_dragger.offset().left ? -1 : 1,
                                to = Math.abs(mCSB_container[0].offsetLeft) - (clickDir * (wrapper.width() * 0.9));
                        } else {
                            if (!d.overflowed[0]) { return; }
                            var dir = "y",
                                clickDir = e.pageY > mCSB_dragger.offset().top ? -1 : 1,
                                to = Math.abs(mCSB_container[0].offsetTop) - (clickDir * (wrapper.height() * 0.9));
                        }
                        _scrollTo($this, to.toString(), { dir: dir, scrollEasing: "mcsEaseInOut" });
                    }
                });
            },
            /* -------------------- */


            /* 
            FOCUS EVENT
            scrolls content via element focus (e.g. clicking an input, pressing TAB key etc.)
            */
            _focus = function () {
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt,
                    namespace = pluginPfx + "_" + d.idx,
                    mCSB_container = $("#mCSB_" + d.idx + "_container"),
                    wrapper = mCSB_container.parent();
                mCSB_container.bind("focusin." + namespace, function (e) {
                    var el = $(document.activeElement),
                        nested = mCSB_container.find(".mCustomScrollBox").length,
                        dur = 0;
                    if (!el.is(o.advanced.autoScrollOnFocus)) { return; }
                    _stop($this);
                    clearTimeout($this[0]._focusTimeout);
                    $this[0]._focusTimer = nested ? (dur + 17) * nested : 0;
                    $this[0]._focusTimeout = setTimeout(function () {
                        var to = [_childPos(el)[0], _childPos(el)[1]],
                            contentPos = [mCSB_container[0].offsetTop, mCSB_container[0].offsetLeft],
                            isVisible = [
                                (contentPos[0] + to[0] >= 0 && contentPos[0] + to[0] < wrapper.height() - el.outerHeight(false)),
                                (contentPos[1] + to[1] >= 0 && contentPos[0] + to[1] < wrapper.width() - el.outerWidth(false))
                            ],
                            overwrite = (o.axis === "yx" && !isVisible[0] && !isVisible[1]) ? "none" : "all";
                        if (o.axis !== "x" && !isVisible[0]) {
                            _scrollTo($this, to[0].toString(), { dir: "y", scrollEasing: "mcsEaseInOut", overwrite: overwrite, dur: dur });
                        }
                        if (o.axis !== "y" && !isVisible[1]) {
                            _scrollTo($this, to[1].toString(), { dir: "x", scrollEasing: "mcsEaseInOut", overwrite: overwrite, dur: dur });
                        }
                    }, $this[0]._focusTimer);
                });
            },
            /* -------------------- */


            /* sets content wrapper scrollTop/scrollLeft always to 0 */
            _wrapperScroll = function () {
                var $this = $(this), d = $this.data(pluginPfx),
                    namespace = pluginPfx + "_" + d.idx,
                    wrapper = $("#mCSB_" + d.idx + "_container").parent();
                wrapper.bind("scroll." + namespace, function (e) {
                    if (wrapper.scrollTop() !== 0 || wrapper.scrollLeft() !== 0) {
                        $(".mCSB_" + d.idx + "_scrollbar").css("visibility", "hidden"); /* hide scrollbar(s) */
                    }
                });
            },
            /* -------------------- */


            /* 
            BUTTONS EVENTS
            scrolls content via up, down, left and right buttons 
            */
            _buttons = function () {
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt, seq = d.sequential,
                    namespace = pluginPfx + "_" + d.idx,
                    sel = ".mCSB_" + d.idx + "_scrollbar",
                    btn = $(sel + ">a");
                btn.bind("contextmenu." + namespace, function (e) {
                    e.preventDefault(); //prevent right click
                }).bind("mousedown." + namespace + " touchstart." + namespace + " pointerdown." + namespace + " MSPointerDown." + namespace + " mouseup." + namespace + " touchend." + namespace + " pointerup." + namespace + " MSPointerUp." + namespace + " mouseout." + namespace + " pointerout." + namespace + " MSPointerOut." + namespace + " click." + namespace, function (e) {
                    e.preventDefault();
                    if (!_mouseBtnLeft(e)) { return; } /* left mouse button only */
                    var btnClass = $(this).attr("class");
                    seq.type = o.scrollButtons.scrollType;
                    switch (e.type) {
                        case "mousedown": case "touchstart": case "pointerdown": case "MSPointerDown":
                            if (seq.type === "stepped") { return; }
                            touchActive = true;
                            d.tweenRunning = false;
                            _seq("on", btnClass);
                            break;
                        case "mouseup": case "touchend": case "pointerup": case "MSPointerUp":
                        case "mouseout": case "pointerout": case "MSPointerOut":
                            if (seq.type === "stepped") { return; }
                            touchActive = false;
                            if (seq.dir) { _seq("off", btnClass); }
                            break;
                        case "click":
                            if (seq.type !== "stepped" || d.tweenRunning) { return; }
                            _seq("on", btnClass);
                            break;
                    }
                    function _seq(a, c) {
                        seq.scrollAmount = o.scrollButtons.scrollAmount;
                        _sequentialScroll($this, a, c);
                    }
                });
            },
            /* -------------------- */


            /* 
            KEYBOARD EVENTS
            scrolls content via keyboard 
            Keys: up arrow, down arrow, left arrow, right arrow, PgUp, PgDn, Home, End
            */
            _keyboard = function () {
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt, seq = d.sequential,
                    namespace = pluginPfx + "_" + d.idx,
                    mCustomScrollBox = $("#mCSB_" + d.idx),
                    mCSB_container = $("#mCSB_" + d.idx + "_container"),
                    wrapper = mCSB_container.parent(),
                    editables = "input,textarea,select,datalist,keygen,[contenteditable='true']",
                    iframe = mCSB_container.find("iframe"),
                    events = ["blur." + namespace + " keydown." + namespace + " keyup." + namespace];
                if (iframe.length) {
                    iframe.each(function () {
                        $(this).bind("load", function () {
                            /* bind events on accessible iframes */
                            if (_canAccessIFrame(this)) {
                                $(this.contentDocument || this.contentWindow.document).bind(events[0], function (e) {
                                    _onKeyboard(e);
                                });
                            }
                        });
                    });
                }
                mCustomScrollBox.attr("tabindex", "0").bind(events[0], function (e) {
                    _onKeyboard(e);
                });
                function _onKeyboard(e) {
                    switch (e.type) {
                        case "blur":
                            if (d.tweenRunning && seq.dir) { _seq("off", null); }
                            break;
                        case "keydown": case "keyup":
                            var code = e.keyCode ? e.keyCode : e.which, action = "on";
                            if ((o.axis !== "x" && (code === 38 || code === 40)) || (o.axis !== "y" && (code === 37 || code === 39))) {
                                /* up (38), down (40), left (37), right (39) arrows */
                                if (((code === 38 || code === 40) && !d.overflowed[0]) || ((code === 37 || code === 39) && !d.overflowed[1])) { return; }
                                if (e.type === "keyup") { action = "off"; }
                                if (!$(document.activeElement).is(editables)) {
                                    e.preventDefault();
                                    e.stopImmediatePropagation();
                                    _seq(action, code);
                                }
                            } else if (code === 33 || code === 34) {
                                /* PgUp (33), PgDn (34) */
                                if (d.overflowed[0] || d.overflowed[1]) {
                                    e.preventDefault();
                                    e.stopImmediatePropagation();
                                }
                                if (e.type === "keyup") {
                                    _stop($this);
                                    var keyboardDir = code === 34 ? -1 : 1;
                                    if (o.axis === "x" || (o.axis === "yx" && d.overflowed[1] && !d.overflowed[0])) {
                                        var dir = "x", to = Math.abs(mCSB_container[0].offsetLeft) - (keyboardDir * (wrapper.width() * 0.9));
                                    } else {
                                        var dir = "y", to = Math.abs(mCSB_container[0].offsetTop) - (keyboardDir * (wrapper.height() * 0.9));
                                    }
                                    _scrollTo($this, to.toString(), { dir: dir, scrollEasing: "mcsEaseInOut" });
                                }
                            } else if (code === 35 || code === 36) {
                                /* End (35), Home (36) */
                                if (!$(document.activeElement).is(editables)) {
                                    if (d.overflowed[0] || d.overflowed[1]) {
                                        e.preventDefault();
                                        e.stopImmediatePropagation();
                                    }
                                    if (e.type === "keyup") {
                                        if (o.axis === "x" || (o.axis === "yx" && d.overflowed[1] && !d.overflowed[0])) {
                                            var dir = "x", to = code === 35 ? Math.abs(wrapper.width() - mCSB_container.outerWidth(false)) : 0;
                                        } else {
                                            var dir = "y", to = code === 35 ? Math.abs(wrapper.height() - mCSB_container.outerHeight(false)) : 0;
                                        }
                                        _scrollTo($this, to.toString(), { dir: dir, scrollEasing: "mcsEaseInOut" });
                                    }
                                }
                            }
                            break;
                    }
                    function _seq(a, c) {
                        seq.type = o.keyboard.scrollType;
                        seq.scrollAmount = o.keyboard.scrollAmount;
                        if (seq.type === "stepped" && d.tweenRunning) { return; }
                        _sequentialScroll($this, a, c);
                    }
                }
            },
            /* -------------------- */


            /* scrolls content sequentially (used when scrolling via buttons, keyboard arrows etc.) */
            _sequentialScroll = function (el, action, trigger, e, s) {
                var d = el.data(pluginPfx), o = d.opt, seq = d.sequential,
                    mCSB_container = $("#mCSB_" + d.idx + "_container"),
                    once = seq.type === "stepped" ? true : false,
                    steplessSpeed = o.scrollInertia < 26 ? 26 : o.scrollInertia, /* 26/1.5=17 */
                    steppedSpeed = o.scrollInertia < 1 ? 17 : o.scrollInertia;
                switch (action) {
                    case "on":
                        seq.dir = [
                            (trigger === classes[16] || trigger === classes[15] || trigger === 39 || trigger === 37 ? "x" : "y"),
                            (trigger === classes[13] || trigger === classes[15] || trigger === 38 || trigger === 37 ? -1 : 1)
                        ];
                        _stop(el);
                        if (_isNumeric(trigger) && seq.type === "stepped") { return; }
                        _on(once);
                        break;
                    case "off":
                        _off();
                        if (once || (d.tweenRunning && seq.dir)) {
                            _on(true);
                        }
                        break;
                }

                /* starts sequence */
                function _on(once) {
                    if (o.snapAmount) { seq.scrollAmount = !(o.snapAmount instanceof Array) ? o.snapAmount : seq.dir[0] === "x" ? o.snapAmount[1] : o.snapAmount[0]; } /* scrolling snapping */
                    var c = seq.type !== "stepped", /* continuous scrolling */
                        t = s ? s : !once ? 1000 / 60 : c ? steplessSpeed / 1.5 : steppedSpeed, /* timer */
                        m = !once ? 2.5 : c ? 7.5 : 40, /* multiplier */
                        contentPos = [Math.abs(mCSB_container[0].offsetTop), Math.abs(mCSB_container[0].offsetLeft)],
                        ratio = [d.scrollRatio.y > 10 ? 10 : d.scrollRatio.y, d.scrollRatio.x > 10 ? 10 : d.scrollRatio.x],
                        amount = seq.dir[0] === "x" ? contentPos[1] + (seq.dir[1] * (ratio[1] * m)) : contentPos[0] + (seq.dir[1] * (ratio[0] * m)),
                        px = seq.dir[0] === "x" ? contentPos[1] + (seq.dir[1] * parseInt(seq.scrollAmount)) : contentPos[0] + (seq.dir[1] * parseInt(seq.scrollAmount)),
                        to = seq.scrollAmount !== "auto" ? px : amount,
                        easing = e ? e : !once ? "mcsLinear" : c ? "mcsLinearOut" : "mcsEaseInOut",
                        onComplete = !once ? false : true;
                    if (once && t < 17) {
                        to = seq.dir[0] === "x" ? contentPos[1] : contentPos[0];
                    }
                    _scrollTo(el, to.toString(), { dir: seq.dir[0], scrollEasing: easing, dur: t, onComplete: onComplete });
                    if (once) {
                        seq.dir = false;
                        return;
                    }
                    clearTimeout(seq.step);
                    seq.step = setTimeout(function () {
                        _on();
                    }, t);
                }
                /* stops sequence */
                function _off() {
                    clearTimeout(seq.step);
                    _delete(seq, "step");
                    _stop(el);
                }
            },
            /* -------------------- */


            /* returns a yx array from value */
            _arr = function (val) {
                var o = $(this).data(pluginPfx).opt, vals = [];
                if (typeof val === "function") { val = val(); } /* check if the value is a single anonymous function */
                /* check if value is object or array, its length and create an array with yx values */
                if (!(val instanceof Array)) { /* object value (e.g. {y:"100",x:"100"}, 100 etc.) */
                    vals[0] = val.y ? val.y : val.x || o.axis === "x" ? null : val;
                    vals[1] = val.x ? val.x : val.y || o.axis === "y" ? null : val;
                } else { /* array value (e.g. [100,100]) */
                    vals = val.length > 1 ? [val[0], val[1]] : o.axis === "x" ? [null, val[0]] : [val[0], null];
                }
                /* check if array values are anonymous functions */
                if (typeof vals[0] === "function") { vals[0] = vals[0](); }
                if (typeof vals[1] === "function") { vals[1] = vals[1](); }
                return vals;
            },
            /* -------------------- */


            /* translates values (e.g. "top", 100, "100px", "#id") to actual scroll-to positions */
            _to = function (val, dir) {
                if (val == null || typeof val == "undefined") { return; }
                var $this = $(this), d = $this.data(pluginPfx), o = d.opt,
                    mCSB_container = $("#mCSB_" + d.idx + "_container"),
                    wrapper = mCSB_container.parent(),
                    t = typeof val;
                if (!dir) { dir = o.axis === "x" ? "x" : "y"; }
                var contentLength = dir === "x" ? mCSB_container.outerWidth(false) - wrapper.width() : mCSB_container.outerHeight(false) - wrapper.height(),
                    contentPos = dir === "x" ? mCSB_container[0].offsetLeft : mCSB_container[0].offsetTop,
                    cssProp = dir === "x" ? "left" : "top";
                switch (t) {
                    case "function": /* this currently is not used. Consider removing it */
                        return val();
                        break;
                    case "object": /* js/jquery object */
                        var obj = val.jquery ? val : $(val);
                        if (!obj.length) { return; }
                        return dir === "x" ? _childPos(obj)[1] : _childPos(obj)[0];
                        break;
                    case "string": case "number":
                        if (_isNumeric(val)) { /* numeric value */
                            return Math.abs(val);
                        } else if (val.indexOf("%") !== -1) { /* percentage value */
                            return Math.abs(contentLength * parseInt(val) / 100);
                        } else if (val.indexOf("-=") !== -1) { /* decrease value */
                            return Math.abs(contentPos - parseInt(val.split("-=")[1]));
                        } else if (val.indexOf("+=") !== -1) { /* inrease value */
                            var p = (contentPos + parseInt(val.split("+=")[1]));
                            return p >= 0 ? 0 : Math.abs(p);
                        } else if (val.indexOf("px") !== -1 && _isNumeric(val.split("px")[0])) { /* pixels string value (e.g. "100px") */
                            return Math.abs(val.split("px")[0]);
                        } else {
                            if (val === "top" || val === "left") { /* special strings */
                                return 0;
                            } else if (val === "bottom") {
                                return Math.abs(wrapper.height() - mCSB_container.outerHeight(false));
                            } else if (val === "right") {
                                return Math.abs(wrapper.width() - mCSB_container.outerWidth(false));
                            } else if (val === "first" || val === "last") {
                                var obj = mCSB_container.find(":" + val);
                                return dir === "x" ? _childPos(obj)[1] : _childPos(obj)[0];
                            } else {
                                if ($(val).length) { /* jquery selector */
                                    return dir === "x" ? _childPos($(val))[1] : _childPos($(val))[0];
                                } else { /* other values (e.g. "100em") */
                                    mCSB_container.css(cssProp, val);
                                    methods.update.call(null, $this[0]);
                                    return;
                                }
                            }
                        }
                        break;
                }
            },
            /* -------------------- */


            /* calls the update method automatically */
            _autoUpdate = function (rem) {

                var $this = $(this), d = $this.data(pluginPfx), o = d.opt,
                    mCSB_container = $("#mCSB_" + d.idx + "_container");
                if (rem) {
                    /* 
                    removes autoUpdate timer 
                    usage: _autoUpdate.call(this,"remove");
                    */
                    clearTimeout(mCSB_container[0].autoUpdate);
                    _delete(mCSB_container[0], "autoUpdate");
                    return;
                }
                upd();
                function upd() {
                    clearTimeout(mCSB_container[0].autoUpdate);
                    if ($this.parents("html").length === 0) {
                        /* check element in dom tree */
                        $this = null;
                        return;
                    }

                    mCSB_container[0].autoUpdate = setTimeout(function () {
                        /* update on specific selector(s) length and size change */
                        if (o.advanced.updateOnSelectorChange) {
                            d.poll.change.n = sizesSum();
                            if (d.poll.change.n !== d.poll.change.o) {
                                d.poll.change.o = d.poll.change.n;
                                doUpd(3);
                                return;
                            }
                        }
                        /* update on main element and scrollbar size changes */
                        if (o.advanced.updateOnContentResize) {
                            d.poll.size.n = $this[0].scrollHeight + $this[0].scrollWidth + mCSB_container[0].offsetHeight + $this[0].offsetHeight + $this[0].offsetWidth;

                            //ORIGINAL CODE
                            //if (d.poll.size.n !== d.poll.size.o) {
                            //    d.poll.size.o = d.poll.size.n;

                            //    doUpd(1);
                            //    return;
                            //}
                            //--- NEW
                            if (d.poll.size.n > d.poll.size.o + 1 || d.poll.size.n < d.poll.size.o - 1) {
                                //console.warn("Update");
                                d.poll.size.o = d.poll.size.n;
                                 doUpd(1);
                                return;
                            } else if (d.poll.size.n !== d.poll.size.o) {
                              //  console.warn("Avoid")
                                d.poll.size.o = d.poll.size.n;
                            }
                            //----
                        }
                        /* update on image load */
                        if (o.advanced.updateOnImageLoad) {
                            if (!(o.advanced.updateOnImageLoad === "auto" && o.axis === "y")) { //by default, it doesn't run on vertical content
                                d.poll.img.n = mCSB_container.find("img").length;
                                if (d.poll.img.n !== d.poll.img.o) {
                                    d.poll.img.o = d.poll.img.n;
                                    mCSB_container.find("img").each(function () {
                                        imgLoader(this);
                                    });
                                    return;
                                }
                            }
                        }
                        if (o.advanced.updateOnSelectorChange || o.advanced.updateOnContentResize || o.advanced.updateOnImageLoad) { upd(); }
                    }, o.advanced.autoUpdateTimeout);
                }
                /* a tiny image loader */
                function imgLoader(el) {
                    if ($(el).hasClass(classes[2])) { doUpd(); return; }
                    var img = new Image();
                    function createDelegate(contextObject, delegateMethod) {
                        return function () { return delegateMethod.apply(contextObject, arguments); }
                    }
                    function imgOnLoad() {
                        this.onload = null;
                        $(el).addClass(classes[2]);
                        doUpd(2);
                    }
                    img.onload = createDelegate(img, imgOnLoad);
                    img.src = el.src;
                }
                /* returns the total height and width sum of all elements matching the selector */
                function sizesSum() {
                    if (o.advanced.updateOnSelectorChange === true) { o.advanced.updateOnSelectorChange = "*"; }
                    var total = 0, sel = mCSB_container.find(o.advanced.updateOnSelectorChange);
                    if (o.advanced.updateOnSelectorChange && sel.length > 0) { sel.each(function () { total += this.offsetHeight + this.offsetWidth; }); }
                    return total;
                }
                /* calls the update method */
                function doUpd(cb) {
                    clearTimeout(mCSB_container[0].autoUpdate);                   
                    methods.update.call(null, $this[0], cb);
                }
            },
            /* -------------------- */


            /* snaps scrolling to a multiple of a pixels number */
            _snapAmount = function (to, amount, offset) {
                return (Math.round(to / amount) * amount - offset);
            },
            /* -------------------- */


            /* stops content and scrollbar animations */
            _stop = function (el) {
                var d = el.data(pluginPfx),
                    sel = $("#mCSB_" + d.idx + "_container,#mCSB_" + d.idx + "_container_wrapper,#mCSB_" + d.idx + "_dragger_vertical,#mCSB_" + d.idx + "_dragger_horizontal");
                sel.each(function () {
                    _stopTween.call(this);
                });
            },
            /* -------------------- */


            /* 
            ANIMATES CONTENT 
            This is where the actual scrolling happens
            */
            _scrollTo = function (el, to, options) {
                var d = el.data(pluginPfx), o = d.opt,
                    defaults = {
                        trigger: "internal",
                        dir: "y",
                        scrollEasing: "mcsEaseOut",
                        drag: false,
                        dur: o.scrollInertia,
                        overwrite: "all",
                        callbacks: true,
                        onStart: true,
                        onUpdate: true,
                        onComplete: true
                    },
                    options = $.extend(defaults, options),
                    dur = [options.dur, (options.drag ? 0 : options.dur)],
                    mCustomScrollBox = $("#mCSB_" + d.idx),
                    mCSB_container = $("#mCSB_" + d.idx + "_container"),
                    wrapper = mCSB_container.parent(),
                    totalScrollOffsets = o.callbacks.onTotalScrollOffset ? _arr.call(el, o.callbacks.onTotalScrollOffset) : [0, 0],
                    totalScrollBackOffsets = o.callbacks.onTotalScrollBackOffset ? _arr.call(el, o.callbacks.onTotalScrollBackOffset) : [0, 0];
                d.trigger = options.trigger;
                if (wrapper.scrollTop() !== 0 || wrapper.scrollLeft() !== 0) { /* always reset scrollTop/Left */
                    $(".mCSB_" + d.idx + "_scrollbar").css("visibility", "visible");
                    wrapper.scrollTop(0).scrollLeft(0);
                }
                if (to === "_resetY" && !d.contentReset.y) {
                    /* callbacks: onOverflowYNone */
                    if (_cb("onOverflowYNone")) { o.callbacks.onOverflowYNone.call(el[0]); }
                    d.contentReset.y = 1;
                }
                if (to === "_resetX" && !d.contentReset.x) {
                    /* callbacks: onOverflowXNone */
                    if (_cb("onOverflowXNone")) { o.callbacks.onOverflowXNone.call(el[0]); }
                    d.contentReset.x = 1;
                }
                if (to === "_resetY" || to === "_resetX") { return; }
                if ((d.contentReset.y || !el[0].mcs) && d.overflowed[0]) {
                    /* callbacks: onOverflowY */
                    if (_cb("onOverflowY")) { o.callbacks.onOverflowY.call(el[0]); }
                    d.contentReset.x = null;
                }
                if ((d.contentReset.x || !el[0].mcs) && d.overflowed[1]) {
                    /* callbacks: onOverflowX */
                    if (_cb("onOverflowX")) { o.callbacks.onOverflowX.call(el[0]); }
                    d.contentReset.x = null;
                }
                if (o.snapAmount) { /* scrolling snapping */
                    var snapAmount = !(o.snapAmount instanceof Array) ? o.snapAmount : options.dir === "x" ? o.snapAmount[1] : o.snapAmount[0];
                    to = _snapAmount(to, snapAmount, o.snapOffset);
                }
                switch (options.dir) {
                    case "x":
                        var mCSB_dragger = $("#mCSB_" + d.idx + "_dragger_horizontal"),
                            property = "left",
                            contentPos = mCSB_container[0].offsetLeft,
                            limit = [
                                mCustomScrollBox.width() - mCSB_container.outerWidth(false),
                                mCSB_dragger.parent().width() - mCSB_dragger.width()
                            ],
                            scrollTo = [to, to === 0 ? 0 : (to / d.scrollRatio.x)],
                            tso = totalScrollOffsets[1],
                            tsbo = totalScrollBackOffsets[1],
                            totalScrollOffset = tso > 0 ? tso / d.scrollRatio.x : 0,
                            totalScrollBackOffset = tsbo > 0 ? tsbo / d.scrollRatio.x : 0;
                        break;
                    case "y":
                        var mCSB_dragger = $("#mCSB_" + d.idx + "_dragger_vertical"),
                            property = "top",
                            contentPos = mCSB_container[0].offsetTop,
                            limit = [
                                mCustomScrollBox.height() - mCSB_container.outerHeight(false),
                                mCSB_dragger.parent().height() - mCSB_dragger.height()
                            ],
                            scrollTo = [to, to === 0 ? 0 : (to / d.scrollRatio.y)],
                            tso = totalScrollOffsets[0],
                            tsbo = totalScrollBackOffsets[0],
                            totalScrollOffset = tso > 0 ? tso / d.scrollRatio.y : 0,
                            totalScrollBackOffset = tsbo > 0 ? tsbo / d.scrollRatio.y : 0;
                        break;
                }
                if (scrollTo[1] < 0 || (scrollTo[0] === 0 && scrollTo[1] === 0)) {
                    scrollTo = [0, 0];
                } else if (scrollTo[1] >= limit[1]) {
                    scrollTo = [limit[0], limit[1]];
                } else {
                    scrollTo[0] = -scrollTo[0];
                }
                if (!el[0].mcs) {
                    _mcs();  /* init mcs object (once) to make it available before callbacks */
                    if (_cb("onInit")) { o.callbacks.onInit.call(el[0]); } /* callbacks: onInit */
                }
                clearTimeout(mCSB_container[0].onCompleteTimeout);
                _tweenTo(mCSB_dragger[0], property, Math.round(scrollTo[1]), dur[1], options.scrollEasing);
                if (!d.tweenRunning && ((contentPos === 0 && scrollTo[0] >= 0) || (contentPos === limit[0] && scrollTo[0] <= limit[0]))) { return; }
                _tweenTo(mCSB_container[0], property, Math.round(scrollTo[0]), dur[0], options.scrollEasing, options.overwrite, {
                    onStart: function () {
                        if (options.callbacks && options.onStart && !d.tweenRunning) {
                            /* callbacks: onScrollStart */
                            if (_cb("onScrollStart")) { _mcs(); o.callbacks.onScrollStart.call(el[0]); }
                            d.tweenRunning = true;
                            _onDragClasses(mCSB_dragger);
                            d.cbOffsets = _cbOffsets();
                        }
                    }, onUpdate: function () {
                        if (options.callbacks && options.onUpdate) {
                            /* callbacks: whileScrolling */
                            if (_cb("whileScrolling")) { _mcs(); o.callbacks.whileScrolling.call(el[0]); }
                        }
                    }, onComplete: function () {
                        if (options.callbacks && options.onComplete) {
                            if (o.axis === "yx") { clearTimeout(mCSB_container[0].onCompleteTimeout); }
                            var t = mCSB_container[0].idleTimer || 0;
                            mCSB_container[0].onCompleteTimeout = setTimeout(function () {
                                /* callbacks: onScroll, onTotalScroll, onTotalScrollBack */
                                if (_cb("onScroll")) { _mcs(); o.callbacks.onScroll.call(el[0]); }
                                if (_cb("onTotalScroll") && scrollTo[1] >= limit[1] - totalScrollOffset && d.cbOffsets[0]) { _mcs(); o.callbacks.onTotalScroll.call(el[0]); }
                                if (_cb("onTotalScrollBack") && scrollTo[1] <= totalScrollBackOffset && d.cbOffsets[1]) { _mcs(); o.callbacks.onTotalScrollBack.call(el[0]); }
                                d.tweenRunning = false;
                                mCSB_container[0].idleTimer = 0;
                                _onDragClasses(mCSB_dragger, "hide");
                            }, t);
                        }
                    }
                });
                /* checks if callback function exists */
                function _cb(cb) {
                    return d && o.callbacks[cb] && typeof o.callbacks[cb] === "function";
                }
                /* checks whether callback offsets always trigger */
                function _cbOffsets() {
                    return [o.callbacks.alwaysTriggerOffsets || contentPos >= limit[0] + tso, o.callbacks.alwaysTriggerOffsets || contentPos <= -tsbo];
                }
                /* 
                populates object with useful values for the user 
                values: 
                    content: this.mcs.content
                    content top position: this.mcs.top 
                    content left position: this.mcs.left 
                    dragger top position: this.mcs.draggerTop 
                    dragger left position: this.mcs.draggerLeft 
                    scrolling y percentage: this.mcs.topPct 
                    scrolling x percentage: this.mcs.leftPct 
                    scrolling direction: this.mcs.direction
                */
                function _mcs() {
                    var cp = [mCSB_container[0].offsetTop, mCSB_container[0].offsetLeft], /* content position */
                        dp = [mCSB_dragger[0].offsetTop, mCSB_dragger[0].offsetLeft], /* dragger position */
                        cl = [mCSB_container.outerHeight(false), mCSB_container.outerWidth(false)], /* content length */
                        pl = [mCustomScrollBox.height(), mCustomScrollBox.width()]; /* content parent length */
                    el[0].mcs = {
                        content: mCSB_container, /* original content wrapper as jquery object */
                        top: cp[0], left: cp[1], draggerTop: dp[0], draggerLeft: dp[1],
                        topPct: Math.round((100 * Math.abs(cp[0])) / (Math.abs(cl[0]) - pl[0])), leftPct: Math.round((100 * Math.abs(cp[1])) / (Math.abs(cl[1]) - pl[1])),
                        direction: options.dir
                    };
                    /* 
                    this refers to the original element containing the scrollbar(s)
                    usage: this.mcs.top, this.mcs.leftPct etc. 
                    */
                }
            },
            /* -------------------- */


            /* 
            CUSTOM JAVASCRIPT ANIMATION TWEEN 
            Lighter and faster than jquery animate() and css transitions 
            Animates top/left properties and includes easings 
            */
            _tweenTo = function (el, prop, to, duration, easing, overwrite, callbacks) {
                if (!el._mTween) { el._mTween = { top: {}, left: {} }; }
                var callbacks = callbacks || {},
                    onStart = callbacks.onStart || function () { }, onUpdate = callbacks.onUpdate || function () { }, onComplete = callbacks.onComplete || function () { },
                    startTime = _getTime(), _delay, progress = 0, from = el.offsetTop, elStyle = el.style, _request, tobj = el._mTween[prop];
                if (prop === "left") { from = el.offsetLeft; }
                var diff = to - from;
                tobj.stop = 0;
                if (overwrite !== "none") { _cancelTween(); }
                _startTween();
                function _step() {
                    if (tobj.stop) { return; }
                    if (!progress) { onStart.call(); }
                    progress = _getTime() - startTime;
                    _tween();
                    if (progress >= tobj.time) {
                        tobj.time = (progress > tobj.time) ? progress + _delay - (progress - tobj.time) : progress + _delay - 1;
                        if (tobj.time < progress + 1) { tobj.time = progress + 1; }
                    }
                    if (tobj.time < duration) { tobj.id = _request(_step); } else { onComplete.call(); }
                }
                function _tween() {
                    if (duration > 0) {
                        tobj.currVal = _ease(tobj.time, from, diff, duration, easing);
                        elStyle[prop] = Math.round(tobj.currVal) + "px";
                    } else {
                        elStyle[prop] = to + "px";
                    }
                    onUpdate.call();
                }
                function _startTween() {
                    _delay = 1000 / 60;
                    tobj.time = progress + _delay;
                    _request = (!window.requestAnimationFrame) ? function (f) { _tween(); return setTimeout(f, 0.01); } : window.requestAnimationFrame;
                    tobj.id = _request(_step);
                }
                function _cancelTween() {
                    if (tobj.id == null) { return; }
                    if (!window.requestAnimationFrame) {
                        clearTimeout(tobj.id);
                    } else { window.cancelAnimationFrame(tobj.id); }
                    tobj.id = null;
                }
                function _ease(t, b, c, d, type) {
                    switch (type) {
                        case "linear": case "mcsLinear":
                            return c * t / d + b;
                            break;
                        case "mcsLinearOut":
                            t /= d; t--; return c * Math.sqrt(1 - t * t) + b;
                            break;
                        case "easeInOutSmooth":
                            t /= d / 2;
                            if (t < 1) return c / 2 * t * t + b;
                            t--;
                            return -c / 2 * (t * (t - 2) - 1) + b;
                            break;
                        case "easeInOutStrong":
                            t /= d / 2;
                            if (t < 1) return c / 2 * Math.pow(2, 10 * (t - 1)) + b;
                            t--;
                            return c / 2 * (-Math.pow(2, -10 * t) + 2) + b;
                            break;
                        case "easeInOut": case "mcsEaseInOut":
                            t /= d / 2;
                            if (t < 1) return c / 2 * t * t * t + b;
                            t -= 2;
                            return c / 2 * (t * t * t + 2) + b;
                            break;
                        case "easeOutSmooth":
                            t /= d; t--;
                            return -c * (t * t * t * t - 1) + b;
                            break;
                        case "easeOutStrong":
                            return c * (-Math.pow(2, -10 * t / d) + 1) + b;
                            break;
                        case "easeOut": case "mcsEaseOut": default:
                            var ts = (t /= d) * t, tc = ts * t;
                            return b + c * (0.499999999999997 * tc * ts + -2.5 * ts * ts + 5.5 * tc + -6.5 * ts + 4 * t);
                    }
                }
            },
            /* -------------------- */


            /* returns current time */
            _getTime = function () {
                if (window.performance && window.performance.now) {
                    return window.performance.now();
                } else {
                    if (window.performance && window.performance.webkitNow) {
                        return window.performance.webkitNow();
                    } else {
                        if (Date.now) { return Date.now(); } else { return new Date().getTime(); }
                    }
                }
            },
            /* -------------------- */


            /* stops a tween */
            _stopTween = function () {
                var el = this;
                if (!el._mTween) { el._mTween = { top: {}, left: {} }; }
                var props = ["top", "left"];
                for (var i = 0; i < props.length; i++) {
                    var prop = props[i];
                    if (el._mTween[prop].id) {
                        if (!window.requestAnimationFrame) {
                            clearTimeout(el._mTween[prop].id);
                        } else { window.cancelAnimationFrame(el._mTween[prop].id); }
                        el._mTween[prop].id = null;
                        el._mTween[prop].stop = 1;
                    }
                }
            },
            /* -------------------- */


            /* deletes a property (avoiding the exception thrown by IE) */
            _delete = function (c, m) {
                try { delete c[m]; } catch (e) { c[m] = null; }
            },
            /* -------------------- */


            /* detects left mouse button */
            _mouseBtnLeft = function (e) {
                return !(e.which && e.which !== 1);
            },
            /* -------------------- */


            /* detects if pointer type event is touch */
            _pointerTouch = function (e) {
                var t = e.originalEvent.pointerType;
                return !(t && t !== "touch" && t !== 2);
            },
            /* -------------------- */


            /* checks if value is numeric */
            _isNumeric = function (val) {
                return !isNaN(parseFloat(val)) && isFinite(val);
            },
            /* -------------------- */


            /* returns element position according to content */
            _childPos = function (el) {
                var p = el.parents(".mCSB_container");
                return [el.offset().top - p.offset().top, el.offset().left - p.offset().left];
            },
            /* -------------------- */


            /* checks if browser tab is hidden/inactive via Page Visibility API */
            _isTabHidden = function () {
                var prop = _getHiddenProp();
                if (!prop) return false;
                return document[prop];
                function _getHiddenProp() {
                    var pfx = ["webkit", "moz", "ms", "o"];
                    if ("hidden" in document) return "hidden"; //natively supported
                    for (var i = 0; i < pfx.length; i++) { //prefixed
                        if ((pfx[i] + "Hidden") in document)
                            return pfx[i] + "Hidden";
                    }
                    return null; //not supported
                }
            };
        /* -------------------- */





        /* 
        ----------------------------------------
        PLUGIN SETUP 
        ----------------------------------------
        */

        /* plugin constructor functions */
        $.fn[pluginNS] = function (method) { /* usage: $(selector).mCustomScrollbar(); */
            if (methods[method]) {
                return methods[method].apply(this, Array.prototype.slice.call(arguments, 1));
            } else if (typeof method === "object" || !method) {
                return methods.init.apply(this, arguments);
            } else {
                $.error("Method " + method + " does not exist");
            }
        };
        $[pluginNS] = function (method) { /* usage: $.mCustomScrollbar(); */
            if (methods[method]) {
                return methods[method].apply(this, Array.prototype.slice.call(arguments, 1));
            } else if (typeof method === "object" || !method) {
                return methods.init.apply(this, arguments);
            } else {
                $.error("Method " + method + " does not exist");
            }
        };

        /* 
        allow setting plugin default options. 
        usage: $.mCustomScrollbar.defaults.scrollInertia=500; 
        to apply any changed default options on default selectors (below), use inside document ready fn 
        e.g.: $(document).ready(function(){ $.mCustomScrollbar.defaults.scrollInertia=500; });
        */
        $[pluginNS].defaults = defaults;

        /* 
        add window object (window.mCustomScrollbar) 
        usage: if(window.mCustomScrollbar){console.log("custom scrollbar plugin loaded");}
        */
        window[pluginNS] = true;

        $(window).bind("load", function () {

            $(defaultSelector)[pluginNS](); /* add scrollbars automatically on default selector */

            /* extend jQuery expressions */
            $.extend($.expr[":"], {
                /* checks if element is within scrollable viewport */
                mcsInView: $.expr[":"].mcsInView || function (el) {
                    var $el = $(el), content = $el.parents(".mCSB_container"), wrapper, cPos;
                    if (!content.length) { return; }
                    wrapper = content.parent();
                    cPos = [content[0].offsetTop, content[0].offsetLeft];
                    return cPos[0] + _childPos($el)[0] >= 0 && cPos[0] + _childPos($el)[0] < wrapper.height() - $el.outerHeight(false) &&
                        cPos[1] + _childPos($el)[1] >= 0 && cPos[1] + _childPos($el)[1] < wrapper.width() - $el.outerWidth(false);
                },
                /* checks if element or part of element is in view of scrollable viewport */
                mcsInSight: $.expr[":"].mcsInSight || function (el, i, m) {
                    var $el = $(el), elD, content = $el.parents(".mCSB_container"), wrapperView, pos, wrapperViewPct,
                        pctVals = m[3] === "exact" ? [[1, 0], [1, 0]] : [[0.9, 0.1], [0.6, 0.4]];
                    if (!content.length) { return; }
                    elD = [$el.outerHeight(false), $el.outerWidth(false)];
                    pos = [content[0].offsetTop + _childPos($el)[0], content[0].offsetLeft + _childPos($el)[1]];
                    wrapperView = [content.parent()[0].offsetHeight, content.parent()[0].offsetWidth];
                    wrapperViewPct = [elD[0] < wrapperView[0] ? pctVals[0] : pctVals[1], elD[1] < wrapperView[1] ? pctVals[0] : pctVals[1]];
                    return pos[0] - (wrapperView[0] * wrapperViewPct[0][0]) < 0 && pos[0] + elD[0] - (wrapperView[0] * wrapperViewPct[0][1]) >= 0 &&
                        pos[1] - (wrapperView[1] * wrapperViewPct[1][0]) < 0 && pos[1] + elD[1] - (wrapperView[1] * wrapperViewPct[1][1]) >= 0;
                },
                /* checks if element is overflowed having visible scrollbar(s) */
                mcsOverflow: $.expr[":"].mcsOverflow || function (el) {
                    var d = $(el).data(pluginPfx);
                    if (!d) { return; }
                    return d.overflowed[0] || d.overflowed[1];
                }
            });

        });

    }))
}));
// noUISlider
// https://github.com/leongersen/noUiSlider

/**@preserve
$.fn.noUiSlider - WTFPL - refreshless.com/nouislider/ */

/*jslint browser: true */
/*jslint sub: true */
/*jslint white: true */
/*jslint continue: true */
/*jslint plusplus: true */

(function( $ ){

	'use strict';

	var
	// Cache the document selector;
	/** @const */
	doc = $(document),
	// Make a backup of the original jQuery/Zepto .val() method.
	/** @const */
	$val = $.fn.val,
	// Namespace for binding and unbinding slider events;
	/** @const */
	namespace = '.nui',
	// Determine the events to bind. IE11 implements pointerEvents without
	// a prefix, which breaks compatibility with the IE10 implementation.
	/** @const */
	actions = window.navigator['pointerEnabled'] ? {
		start: 'pointerdown',
		move: 'pointermove',
		end: 'pointerup'
	} : window.navigator['msPointerEnabled'] ? {
		start: 'MSPointerDown',
		move: 'MSPointerMove',
		end: 'MSPointerUp'
	} : {
		start: 'mousedown touchstart',
		move: 'mousemove touchmove',
		end: 'mouseup touchend'
	},
	// Re-usable list of classes;
	/** @const */
	Classes = [
/*  0 */  'noUi-target'
/*  1 */ ,'noUi-base'
/*  2 */ ,'noUi-origin'
/*  3 */ ,'noUi-handle'
/*  4 */ ,'noUi-horizontal'
/*  5 */ ,'noUi-vertical'
/*  6 */ ,'noUi-background'
/*  7 */ ,'noUi-connect'
/*  8 */ ,'noUi-ltr'
/*  9 */ ,'noUi-rtl'
/* 10 */ ,'noUi-dragable'
/* 11 */ ,''
/* 12 */ ,'noUi-state-drag'
/* 13 */ ,''
/* 14 */ ,'noUi-state-tap'
/* 15 */ ,'noUi-active'
/* 16 */ ,'noUi-extended'
/* 17 */ ,'noUi-stacking'
	];


// General helpers

	// Limits a value to 0 - 100
	function limit ( a ) {
		return Math.max(Math.min(a, 100), 0);
	}

	// Round a value to the closest 'to'.
	function closest ( value, to ) {
		return Math.round(value / to) * to;
	}

	// Determine the size of a sub-range in relation to a full range.
	function subRangeRatio ( pa, pb ) {
		return (100 / (pb - pa));
	}


// Type validation

	// Checks whether a value is numerical.
	function isNumeric ( a ) {
		return typeof a === 'number' && !isNaN( a ) && isFinite( a );
	}

	// Wraps a variable as an array, if it isn't one yet.
	function asArray ( a ) {
		return $.isArray(a) ? a : [a];
	}


// Class handling

	// Sets a class and removes it after [duration] ms.
	function addClassFor ( element, className, duration ) {
		element.addClass(className);
		setTimeout(function(){
			element.removeClass(className);
		}, duration);
	}


// Value calculation

	// (percentage) How many percent is this value of this range?
	function fromPercentage ( range, value ) {
		return (value * 100) / ( range[1] - range[0] );
	}

	// (percentage) Where is this value on this range?
	function toPercentage ( range, value ) {
		return fromPercentage( range, range[0] < 0 ?
			value + Math.abs(range[0]) :
				value - range[0] );
	}

	// (value) How much is this percentage on this range?
	function isPercentage ( range, value ) {
		return ((value * ( range[1] - range[0] )) / 100) + range[0];
	}

	// (percentage)
	function toStepping ( options, value ) {

		if ( value >= options.xVal.slice(-1)[0] ){
			return 100;
		}

		var j = 1, va, vb, pa, pb;
		while ( value >= options.xVal[j] ){
			j++;
		}

		va = options.xVal[j-1];
		vb = options.xVal[j];
		pa = options.xPct[j-1];
		pb = options.xPct[j];

		return pa + (toPercentage([va, vb], value) / subRangeRatio (pa, pb));
	}

	// (value)
	function fromStepping ( options, value ) {

		// There is no range group that fits 100
		if ( value >= 100 ){
			return options.xVal.slice(-1)[0];
		}

		var j = 1, va, vb, pa, pb;
		while ( value >= options.xPct[j] ){
			j++;
		}

		va = options.xVal[j-1];
		vb = options.xVal[j];
		pa = options.xPct[j-1];
		pb = options.xPct[j];

		return isPercentage([va, vb], (value - pa) * subRangeRatio (pa, pb));
	}

	// (percentage) Get the step that applies at a certain value.
	function getStep ( options, value ){

		var j = 1, a, b;

		// Find the proper step for rtl sliders by search in inverse direction.
		// Fixes issue #262.
		while ( (options.dir ? (100 - value) : value) >= options.xPct[j] ){
			j++;
		}

		if ( options.snap ) {

			a = options.xPct[j-1];
			b = options.xPct[j];

			if ((value - a) > ((b-a)/2)){
				return b;
			}

			return a;
		}

		if ( !options.xSteps[j-1] ){
			return value;
		}

		return options.xPct[j-1] + closest(
			value - options.xPct[j-1],
			options.xSteps[j-1]
		);
	}


// Event handling

	// Provide a clean event with standardized offset values.
	function fixEvent ( e ) {

		// Prevent scrolling and panning on touch events, while
		// attempting to slide. The tap event also depends on this.
		e.preventDefault();

		// Filter the event to register the type, which can be
		// touch, mouse or pointer. Offset changes need to be
		// made on an event specific basis.
		var  touch = e.type.indexOf('touch') === 0
			,mouse = e.type.indexOf('mouse') === 0
			,pointer = e.type.indexOf('pointer') === 0
			,x,y, event = e;

		// IE10 implemented pointer events with a prefix;
		if ( e.type.indexOf('MSPointer') === 0 ) {
			pointer = true;
		}

		// Get the originalEvent, if the event has been wrapped
		// by jQuery. Zepto doesn't wrap the event.
		if ( e.originalEvent ) {
			e = e.originalEvent;
		}

		if ( touch ) {
			// noUiSlider supports one movement at a time,
			// so we can select the first 'changedTouch'.
			x = e.changedTouches[0].pageX;
			y = e.changedTouches[0].pageY;
		}

		if ( mouse || pointer ) {

			// Polyfill the pageXOffset and pageYOffset
			// variables for IE7 and IE8;
			if( !pointer && window.pageXOffset === undefined ){
				window.pageXOffset = document.documentElement.scrollLeft;
				window.pageYOffset = document.documentElement.scrollTop;
			}

			x = e.clientX + window.pageXOffset;
			y = e.clientY + window.pageYOffset;
		}

		event.points = [x, y];
		event.cursor = mouse;

		return event;
	}


// Input validation

	function testStep ( parsed, entry ) {

		if ( !isNumeric( entry ) ) {
			throw new Error("noUiSlider: 'step' is not numeric.");
		}

		// The step option can still be used to set stepping
		// for linear sliders. Overwritten if set in 'range'.
		parsed.xSteps[0] = entry;
	}

	function testRange ( parsed, entry ) {

		// Filter incorrect input.
		if ( typeof entry !== 'object' || $.isArray(entry) ) {
			throw new Error("noUiSlider: 'range' is not an object.");
		}

		// Catch missing start or end.
		if ( entry['min'] === undefined ||
				entry['max'] === undefined ) {
			throw new Error("noUiSlider: Missing 'min' or 'max' in 'range'.");
		}

		// Loop all entries.
		$.each( entry, function ( index, value ) {

			var percentage;

			// Wrap numerical input in an array.
			if ( typeof value === "number" ) {
				value = [value];
			}

			// Reject any invalid input.
			if ( !$.isArray( value ) ){
				throw new Error("noUiSlider: 'range' contains invalid value.");
			}

			// Covert min/max syntax to 0 and 100.
			if ( index === 'min' ) {
				percentage = 0;
			} else if ( index === 'max' ) {
				percentage = 100;
			} else {
				percentage = parseFloat( index );
			}

			// Check for correct input.
			if ( !isNumeric( percentage ) || !isNumeric( value[0] ) ) {
				throw new Error("noUiSlider: 'range' value isn't numeric.");
			}

			// Store values.
			parsed.xPct.push( percentage );
			parsed.xVal.push( value[0] );

			// NaN will evaluate to false too, but to keep
			// logging clear, set step explicitly. Make sure
			// not to override the 'step' setting with false.
			if ( !percentage ) {
				if ( !isNaN( value[1] ) ) {
					parsed.xSteps[0] = value[1];
				}
			} else {
				parsed.xSteps.push( isNaN(value[1]) ? false : value[1] );
			}
		});

		$.each(parsed.xSteps, function(i,n){

			// Ignore 'false' stepping.
			if ( !n ) {
				return true;
			}

			// Check if step fits. Not required, but this might serve some goal.
			// !((parsed.xVal[i+1] - parsed.xVal[i]) % n);

			// Factor to range ratio
			parsed.xSteps[i] = fromPercentage([
				 parsed.xVal[i]
				,parsed.xVal[i+1]
			], n) / subRangeRatio (
				parsed.xPct[i],
				parsed.xPct[i+1] );
		});
	}

	function testStart ( parsed, entry ) {

		if ( typeof entry === "number" ) {
			entry = [entry];
		}

		// Validate input. Values aren't tested, the internal Link will do
		// that and provide a valid location.
		if ( !$.isArray( entry ) || !entry.length || entry.length > 2 ) {
			throw new Error("noUiSlider: 'start' option is incorrect.");
		}

		// Store the number of handles.
		parsed.handles = entry.length;

		// When the slider is initialized, the .val method will
		// be called with the start options.
		parsed.start = entry;
	}

	function testSnap ( parsed, entry ) {

		// Enforce 100% stepping within subranges.
		parsed.snap = entry;

		if ( typeof entry !== 'boolean' ){
			throw new Error("noUiSlider: 'snap' option must be a boolean.");
		}
	}

	function testConnect ( parsed, entry ) {

		if ( entry === 'lower' && parsed.handles === 1 ) {
			parsed.connect = 1;
		} else if ( entry === 'upper' && parsed.handles === 1 ) {
			parsed.connect = 2;
		} else if ( entry === true && parsed.handles === 2 ) {
			parsed.connect = 3;
		} else if ( entry === false ) {
			parsed.connect = 0;
		} else {
			throw new Error("noUiSlider: 'connect' option doesn't match handle count.");
		}
	}

	function testOrientation ( parsed, entry ) {

		// Set orientation to an a numerical value for easy
		// array selection.
		switch ( entry ){
		  case 'horizontal':
			parsed.ort = 0;
			break;
		  case 'vertical':
			parsed.ort = 1;
			break;
		  default:
			throw new Error("noUiSlider: 'orientation' option is invalid.");
		}
	}

	function testMargin ( parsed, entry ) {

		if ( parsed.xPct.length > 2 ) {
			throw new Error("noUiSlider: 'margin' option is only supported on linear sliders.");
		}

		// Parse value to range and store. As xVal is checked
		// to be no bigger than 2, use it as range.
		parsed.margin = fromPercentage(parsed.xVal, entry);

		if ( !isNumeric(entry) ){
			throw new Error("noUiSlider: 'margin' option must be numeric.");
		}
	}

	function testDirection ( parsed, entry ) {

		// Set direction as a numerical value for easy parsing.
		// Invert connection for RTL sliders, so that the proper
		// handles get the connect/background classes.
		switch ( entry ) {
		  case 'ltr':
			parsed.dir = 0;
			break;
		  case 'rtl':
			parsed.dir = 1;
			parsed.connect = [0,2,1,3][parsed.connect];
			break;
		  default:
			throw new Error("noUiSlider: 'direction' option was not recognized.");
		}
	}

	function testBehaviour ( parsed, entry ) {

		// Make sure the input is a string.
		if ( typeof entry !== 'string' ) {
			throw new Error("noUiSlider: 'behaviour' must be a string containing options.");
		}

		// Check if the string contains any keywords.
		// None are required.
		var tap = entry.indexOf('tap') >= 0,
			extend = entry.indexOf('extend') >= 0,
			drag = entry.indexOf('drag') >= 0,
			fixed = entry.indexOf('fixed') >= 0,
			snap = entry.indexOf('snap') >= 0;

		parsed.events = {
			tap: tap || snap,
			extend: extend,
			drag: drag,
			fixed: fixed,
			snap: snap
		};
	}

	function testSerialization ( parsed, entry, sliders ) {

		parsed.ser = [ entry['lower'], entry['upper'] ];
		parsed.formatting = entry['format'];

		$.each( parsed.ser, function( index, linkInstances ){

			// Check if the provided option is an array.
			if ( !$.isArray(linkInstances) ) {
				throw new Error("noUiSlider: 'serialization."+(!index ? 'lower' : 'upper')+"' must be an array.");
			}

			$.each(linkInstances, function(){

				// Check if entry is a Link.
				if ( !(this instanceof $.Link) ) {
					throw new Error("noUiSlider: 'serialization."+(!index ? 'lower' : 'upper')+"' can only contain Link instances.");
				}

				// Assign properties.
				this.setIndex ( index );
				this.setObject( sliders );
				this.setFormatting( entry['format'] );
			});
		});

		// If the slider has two handles and is RTL,
		// reverse the serialization input. For one handle,
		// lower is still lower.
		if ( parsed.dir && parsed.handles > 1 ) {
			parsed.ser.reverse();
		}
	}

	// Test all developer settings and parse to assumption-safe values.
	function test ( options, sliders ){

	/*	Every input option is tested and parsed. This'll prevent
		endless validation in internal methods. These tests are
		structured with an item for every option available. An
		option can be marked as required by setting the 'r' flag.
		The testing function is provided with three arguments:
			- The provided value for the option;
			- A reference to the options object;
			- The name for the option;

		The testing function returns false when an error is detected,
		or true when everything is OK. It can also modify the option
		object, to make sure all values can be correctly looped elsewhere. */

		var parsed = {
			 xPct: []
			,xVal: []
			,xSteps: [ false ]
			,margin: 0
		}, tests;

		// Tests are executed in the order they are presented here.
		tests = {
			'step': { r: false, t: testStep },
			'start': { r: true, t: testStart },
			'connect': { r: true, t: testConnect },
			'direction': { r: true, t: testDirection },
			'range': { r: true, t: testRange },
			'snap': { r: false, t: testSnap },
			'orientation': { r: false, t: testOrientation },
			'margin': { r: false, t: testMargin },
			'behaviour': { r: true, t: testBehaviour },
			'serialization': { r: true, t: testSerialization }
		};

		// Set defaults where applicable.
		options = $.extend({
			'connect': false,
			'direction': 'ltr',
			'behaviour': 'tap',
			'orientation': 'horizontal'
		}, options);

		// Make sure the test for serialization runs.
		options['serialization'] = $.extend({
			 'lower': []
			,'upper': []
			,'format': {}
		}, options['serialization']);

		// Run all options through a testing mechanism to ensure correct
		// input. It should be noted that options might get modified to
		// be handled properly. E.g. wrapping integers in arrays.
		$.each( tests, function( name, test ){

			if ( options[name] === undefined ) {

				if ( test.r ) {
					throw new Error("noUiSlider: '" + name + "' is required.");
				}

				return true;
			}

			test.t( parsed, options[name], sliders );
		});

		// Pre-define the styles.
		parsed.style = parsed.ort ? 'top' : 'left';

		return parsed;
	}


// DOM additions

	// Append a handle to the base.
	function addHandle ( options, index ) {

		var handle = $('<div><div/></div>').addClass( Classes[2] ),
			additions = [ '-lower', '-upper' ];

		if ( options.dir ) {
			additions.reverse();
		}

		handle.children().addClass(
			Classes[3] + " " + Classes[3]+additions[index]
		);

		return handle;
	}

	// Create a copy of an element-creating Link.
	function addElement ( handle, link ) {

		// If the Link requires creation of a new element,
		// create this element and return a new Link instance.
		if ( link.el ) {

			link = new $.Link({
				'target': $(link.el).clone().appendTo( handle ),
				'method': link.method,
				'format': link.formatting
			}, true);
		}

		// Otherwise, return the reference.
		return link;
	}

	// Loop all links for a handle.
	function addElements ( elements, handle, formatting ) {
		var index, list = [], standard = new $.Link({}, true);

		// Use the Link interface to provide unified
		// formatting for the .val() method.
		standard.setFormatting(formatting);

		// The list now contains at least one element.
		list.push( standard );

		// Loop all links in either 'lower' or 'upper'.
		for ( index = 0; index < elements.length; index++ ) {
			list.push(addElement(handle, elements[index]));
		}

		return list;
	}

	// Go over all Links and assign them to a handle.
	function addLinks ( options, handles ) {

		var index, links = [];

		// Copy the links into a new array, instead of modifying
		// the 'options.ser' list. This allows replacement of the invalid
		// '.el' Links, while the others are still passed by reference.
		for ( index = 0; index < options.handles; index++ ) {

			// Append a new array.
			links[index] = addElements(
				options.ser[index],
				handles[index].children(),
				options.formatting
			);
		}

		return links;
	}

	// Add the proper connection classes.
	function addConnection ( connect, target, handles ) {

		// Apply the required connection classes to the elements
		// that need them. Some classes are made up for several
		// segments listed in the class list, to allow easy
		// renaming and provide a minor compression benefit.
		switch ( connect ) {
			case 1:	target.addClass( Classes[7] );
					handles[0].addClass( Classes[6] );
					break;
			case 3: handles[1].addClass( Classes[6] );
					/* falls through */
			case 2: handles[0].addClass( Classes[7] );
					/* falls through */
			case 0: target.addClass(Classes[6]);
					break;
		}
	}

	// Add handles and loop Link elements.
	function addHandles ( options, base ) {

		var index, handles = [];

		// Append handles.
		for ( index = 0; index < options.handles; index++ ) {

			// Keep a list of all added handles.
			handles.push( addHandle( options, index ).appendTo(base) );
		}

		return handles;
	}

	// Initialize a single slider.
	function addSlider ( options, target ) {

		// Apply classes and data to the target.
		target.addClass([
			Classes[0],
			Classes[8 + options.dir],
			Classes[4 + options.ort]
		].join(' '));

		return $('<div/>').appendTo(target).addClass( Classes[1] );
	}


// Slider scope

function closure ( target, options, originalOptions ){

// Internal variables

	// All variables local to 'closure' are marked $.
	var $Target = $(target),
		$Locations = [-1, -1],
		$Base,
		$Serialization,
		$Handles;

	// Shorthand for base dimensions.
	function baseSize ( ) {
		return $Base[['width', 'height'][options.ort]]();
	}


// External event handling

	function fireEvents ( events ) {

		// Use the external api to get the values.
		// Wrap the values in an array, as .trigger takes
		// only one additional argument.
		var index, values = [ $Target.val() ];

		for ( index = 0; index < events.length; index++ ){
			$Target.trigger(events[index], values);
		}
	}


// Handle placement

	// Test suggested values and apply margin, step.
	function setHandle ( handle, to, delimit ) {

		var n = handle[0] !== $Handles[0][0] ? 1 : 0,
			lower = $Locations[0] + options.margin,
			upper = $Locations[1] - options.margin;

		// Don't delimit range dragging.
		if ( delimit && $Handles.length > 1 ) {
			to = n ? Math.max( to, lower ) : Math.min( to, upper );
		}

		// Handle the step option.
		if ( to < 100 ){
			to = getStep(options, to);
		}

		// Limit to 0/100 for .val input, trim anything beyond 7 digits, as
		// JavaScript has some issues in its floating point implementation.
		to = limit(parseFloat(to.toFixed(7)));

		// Return falsy if handle can't move. False for 0 or 100 limit,
		// '0' for limiting by another handle.
		if ( to === $Locations[n] ) {
			if ( $Handles.length === 1 ) {
				return false;
			}
			return ( to === lower || to === upper ) ? 0 : false;
		}

		// Set the handle to the new position.
		handle.css( options.style, to + '%' );

		// Force proper handle stacking
		if ( handle.is(':first-child') ) {
			handle.toggleClass(Classes[17], to > 50 );
		}

		// Update locations.
		$Locations[n] = to;

		// Invert the value if this is a right-to-left slider.
		if ( options.dir ) {
			to = 100 - to;
		}

		// Write values to serialization Links.
		// Convert the value to the correct relative representation.
		// Convert the value to the slider stepping/range.
		$($Serialization[n]).each(function(){
			this.write( fromStepping( options, to ), handle.children(), $Target );
		});

		return true;
	}

	// Delimit proposed values for handle positions.
	function getPositions ( a, b, delimit ) {

		// Add movement to current position.
		var c = a + b[0], d = a + b[1];

		// Only alter the other position on drag,
		// not on standard sliding.
		if ( delimit ) {
			if ( c < 0 ) {
				d += Math.abs(c);
			}
			if ( d > 100 ) {
				c -= ( d - 100 );
			}

			// Limit values to 0 and 100.
			return [limit(c), limit(d)];
		}

		return [c,d];
	}

	// Handles movement by tapping.
	function jump ( handle, to, instant ) {

		if ( !instant ) {
			// Flag the slider as it is now in a transitional state.
			// Transition takes 300 ms, so re-enable the slider afterwards.
			addClassFor( $Target, Classes[14], 300 );
		}

		// Move the handle to the new position.
		setHandle( handle, to, false );

		fireEvents(['slide', 'set', 'change']);
	}


// Events

	// Handler for attaching events trough a proxy.
	function attach ( events, element, callback, data ) {

		// Add the noUiSlider namespace to all events.
		events = events.replace( /\s/g, namespace + ' ' ) + namespace;

		// Bind a closure on the target.
		return element.on( events, function( e ){

			// jQuery and Zepto handle unset attributes differently.
			var disabled = $Target.attr('disabled');
				disabled = !( disabled === undefined || disabled === null );

			// Test if there is anything that should prevent an event
			// from being handled, such as a disabled state or an active
			// 'tap' transition.
			if( $Target.hasClass( Classes[14] ) || disabled ) {
				return false;
			}

			e = fixEvent(e);
			e.calcPoint = e.points[ options.ort ];

			// Call the event handler with the event [ and additional data ].
			callback ( e, data );
		});
	}

	// Handle movement on document for handle and range drag.
	function move ( event, data ) {

		var handles = data.handles || $Handles, positions, state = false,
			proposal = ((event.calcPoint - data.start) * 100) / baseSize(),
			h = handles[0][0] !== $Handles[0][0] ? 1 : 0;

		// Calculate relative positions for the handles.
		positions = getPositions( proposal, data.positions, handles.length > 1);

		state = setHandle ( handles[0], positions[h], handles.length === 1 );

		if ( handles.length > 1 ) {
			state = setHandle ( handles[1], positions[h?0:1], false ) || state;
		}

		// Fire the 'slide' event if any handle moved.
		if ( state ) {
			fireEvents(['slide']);
		}
	}

	// Unbind move events on document, call callbacks.
	function end ( event ) {

		// The handle is no longer active, so remove the class.
		$('.' + Classes[15]).removeClass(Classes[15]);

		// Remove cursor styles and text-selection events bound to the body.
		if ( event.cursor ) {
			$('body').css('cursor', '').off( namespace );
		}

		// Unbind the move and end events, which are added on 'start'.
		doc.off( namespace );

		// Remove dragging class.
		$Target.removeClass(Classes[12]);

		// Fire the change and set events.
		fireEvents(['set', 'change']);
	}

	// Bind move events on document.
	function start ( event, data ) {

		// Mark the handle as 'active' so it can be styled.
		if( data.handles.length === 1 ) {
			data.handles[0].children().addClass(Classes[15]);
		}

		// A drag should never propagate up to the 'tap' event.
		event.stopPropagation();

		// Attach the move event.
		attach ( actions.move, doc, move, {
			start: event.calcPoint,
			handles: data.handles,
			positions: [
				$Locations[0],
				$Locations[$Handles.length - 1]
			]
		});

		// Unbind all movement when the drag ends.
		attach ( actions.end, doc, end, null );

		// Text selection isn't an issue on touch devices,
		// so adding cursor styles can be skipped.
		if ( event.cursor ) {

			// Prevent the 'I' cursor and extend the range-drag cursor.
			$('body').css('cursor', $(event.target).css('cursor'));

			// Mark the target with a dragging state.
			if ( $Handles.length > 1 ) {
				$Target.addClass(Classes[12]);
			}

			// Prevent text selection when dragging the handles.
			$('body').on('selectstart' + namespace, false);
		}
	}

	// Move closest handle to tapped location.
	function tap ( event ) {

		var location = event.calcPoint, total = 0, to;

		// The tap event shouldn't propagate up and cause 'edge' to run.
		event.stopPropagation();

		// Add up the handle offsets.
		$.each( $Handles, function(){
			total += this.offset()[ options.style ];
		});

		// Find the handle closest to the tapped position.
		total = ( location < total/2 || $Handles.length === 1 ) ? 0 : 1;

		location -= $Base.offset()[ options.style ];

		// Calculate the new position.
		to = ( location * 100 ) / baseSize();

		// Find the closest handle and calculate the tapped point.
		// The set handle to the new position.
		jump( $Handles[total], to, options.events.snap );

		if ( options.events.snap ) {
			start(event, { handles: [$Handles[total]] });
		}
	}

	// Move handle to edges when target gets tapped.
	function edge ( event ) {

		var i = event.calcPoint < $Base.offset()[ options.style ],
			to = i ? 0 : 100;

		i = i ? 0 : $Handles.length - 1;

		jump( $Handles[i], to, false );
	}

	// Attach events to several slider parts.
	function events ( behaviour ) {

		var i, drag;

		// Attach the standard drag event to the handles.
		if ( !behaviour.fixed ) {

			for ( i = 0; i < $Handles.length; i++ ) {

				// These events are only bound to the visual handle
				// element, not the 'real' origin element.
				attach ( actions.start, $Handles[i].children(), start, {
					handles: [ $Handles[i] ]
				});
			}
		}

		// Attach the tap event to the slider base.
		if ( behaviour.tap ) {
			attach ( actions.start, $Base, tap, {
				handles: $Handles
			});
		}

		// Extend tapping behaviour to target
		if ( behaviour.extend ) {

			$Target.addClass( Classes[16] );

			if ( behaviour.tap ) {
				attach ( actions.start, $Target, edge, {
					handles: $Handles
				});
			}
		}

		// Make the range dragable.
		if ( behaviour.drag ){

			drag = $Base.find( '.' + Classes[7] ).addClass( Classes[10] );

			// When the range is fixed, the entire range can
			// be dragged by the handles. The handle in the first
			// origin will propagate the start event upward,
			// but it needs to be bound manually on the other.
			if ( behaviour.fixed ) {
				drag = drag.add($Base.children().not( drag ).children());
			}

			attach ( actions.start, drag, start, {
				handles: $Handles
			});
		}
	}


// Initialize slider

	// Throw an error if the slider was already initialized.
	if ( $Target.hasClass(Classes[0]) ) {
		throw new Error('Slider was already initialized.');
	}

	// Create the base element, initialise HTML and set classes.
	// Add handles and links.
	$Base = addSlider( options, $Target );
	$Handles = addHandles( options, $Base );
	$Serialization = addLinks( options, $Handles );

	// Set the connect classes.
	addConnection ( options.connect, $Target, $Handles );

	// Attach user events.
	events( options.events );


// Methods

	// Set the slider value.
	/** @expose */
	target.vSet = function ( ) {

		var args = Array.prototype.slice.call( arguments, 0 ),
			callback, link, update, animate,
			i, count, actual, to, values = asArray( args[0] );

		// Extract modifiers for value method.
		if ( typeof args[1] === 'object' ) {
			callback = args[1]['set'];
			link = args[1]['link'];
			update = args[1]['update'];
			animate = args[1]['animate'];

		// Support the 'true' option.
		} else if ( args[1] === true ) {
			callback = true;
		}

		// The RTL settings is implemented by reversing the front-end,
		// internal mechanisms are the same.
		if ( options.dir && options.handles > 1 ) {
			values.reverse();
		}

		// Animation is optional.
		if ( animate ) {
			addClassFor( $Target, Classes[14], 300 );
		}

		// Determine how often to set the handles.
		count = $Handles.length > 1 ? 3 : 1;
		if ( values.length === 1 ) {
			count = 1;
		}

		// If there are multiple handles to be set run the setting
		// mechanism twice for the first handle, to make sure it
		// can be bounced of the second one properly.
		for ( i = 0; i < count; i++ ) {

			to = link || $Serialization[i%2][0];
			to = to.getValue( values[i%2] );

			if ( to === false ) {
				continue;
			}

			// Calculate the new handle position
			to = toStepping( options, to );

			// Invert the value if this is a right-to-left slider.
			if ( options.dir ) {
				to = 100 - to;
			}

			// Force delimitation.
			if ( setHandle( $Handles[i%2], to, true ) === true ) {
				continue;
			}

			// Reset the input if it doesn't match the slider.
			$($Serialization[i%2]).each(function(index){

				if (!index) {
					actual = this.actual;
					return true;
				}

				this.write(
					actual,
					$Handles[i%2].children(),
					$Target,
					update
				);
			});
		}

		// Optionally fire the 'set' event.
		if( callback === true ) {
			fireEvents(['set']);
		}

		return this;
	};

	// Get the slider value.
	/** @expose */
	target.vGet = function ( ) {

		var i, retour = [];

		// Get the value from all handles.
		for ( i = 0; i < options.handles; i++ ){
			retour[i] = $Serialization[i][0].saved;
		}

		// If only one handle is used, return a single value.
		if ( retour.length === 1 ){
			return retour[0];
		}

		if ( options.dir ) {
			return retour.reverse();
		}

		return retour;
	};

	// Destroy the slider and unbind all events.
	/** @expose */
	target.destroy = function ( ) {

		// Loop all linked serialization objects and unbind all
		// events in the noUiSlider namespace.
		$.each($Serialization, function(){
			$.each(this, function(){
				// Won't remove 'change' when bound implicitly.
				if ( this.target ) {
					this.target.off( namespace );
				}
			});
		});

		// Unbind events on the slider, remove all classes and child elements.
		$(this).off(namespace)
			.removeClass(Classes.join(' '))
			.empty();

		// Return the original options from the closure.
		return originalOptions;
	};


// Value setting

	// Use the public value method to set the start values.
	$Target.val( options.start );
}


// Access points

	// Run the standard initializer
	function initialize ( originalOptions ) {

		// Throw error if group is empty.
		if ( !this.length ){
			throw new Error("noUiSlider: Can't initialize slider on empty selection.");
		}

		// Test the options once, not for every slider.
		var options = test( originalOptions, this );

		// Loop all items, and provide a new closed-scope environment.
		return this.each(function(){
			closure(this, options, originalOptions);
		});
	}

	// Destroy the slider, then re-enter initialization.
	function rebuild ( options ) {

		return this.each(function(){

			// Get the current values from the slider,
			// including the initialization options.
			var values = $(this).val(),
				originalOptions = this.destroy(),

				// Extend the previous options with the newly provided ones.
				newOptions = $.extend( {}, originalOptions, options );

			// Run the standard initializer.
			$(this).noUiSlider( newOptions );

			// If the start option hasn't changed,
			// reset the previous values.
			if ( originalOptions.start === newOptions.start ) {
				$(this).val(values);
			}
		});
	}

	// Access the internal getting and setting methods based on argument count.
	function value ( ) {
		return this[0][ !arguments.length ? 'vGet' : 'vSet' ].apply(this[0], arguments);
	}

	// Override the .val() method. Test every element. Is it a slider? Go to
	// the slider value handling. No? Use the standard method.
	// Note how $.fn.val extects 'this' to be an instance of $. For convenience,
	// the above 'value' function does too.
	$.fn.val = function ( ) {

		// this === instanceof $

		function valMethod( a ){
			return a.hasClass(Classes[0]) ? value : $val;
		}

		var args = arguments,
			first = $(this[0]);

		if ( !arguments.length ) {
			return valMethod(first).call(first);
		}

		// Return the set so it remains chainable
		return this.each(function(){
			valMethod($(this)).apply($(this), args);
		});
	};

// Remap the serialization constructor for legacy support.
	/** @expose */
	$.noUiSlider = { 'Link': $.Link };

// Extend jQuery/Zepto with the noUiSlider method.
	/** @expose */
	$.fn.noUiSlider = function ( options, re ) {
		return ( re ? rebuild : initialize ).call(this, options);
	};

}( window['jQuery'] || window['Zepto'] ));

/**@preserve
$.Link (part of noUiSlider) - WTFPL */

/*jslint browser: true */
/*jslint sub: true */
/*jslint white: true */

(function ($) {

    'use strict';

    // Throw an error if formatting options are incompatible.
    function throwEqualError(F, a, b) {
        if ((F[a] || F[b]) && (F[a] === F[b])) {
            throw new Error("(Link) '" + a + "' can't match '" + b + "'.'");
        }
    }

    // Test in an object is an instance of jQuery or Zepto.
    function isInstance(a) {
        return a instanceof $ || ($['zepto'] && $['zepto']['isZ'](a));
    }

    var
    /** @const */ Formatting = [
    /*  0 */  'decimals'
    /*  1 */, 'mark'
    /*  2 */, 'thousand'
    /*  3 */, 'prefix'
    /*  4 */, 'postfix'
    /*  5 */, 'encoder'
    /*  6 */, 'decoder'
    /*  7 */, 'negative'
    /*  8 */, 'negativeBefore'
    /*  9 */, 'to'
    /* 10 */, 'from'
    ],
    /** @const */ FormatDefaults = [
    /*  0 */  2
    /*  1 */, '.'
    /*  2 */, ''
    /*  3 */, ''
    /*  4 */, ''
    /*  5 */, function (a) { return a; }
    /*  6 */, function (a) { return a; }
    /*  7 */, '-'
    /*  8 */, ''
    /*  9 */, function (a) { return a; }
    /* 10 */, function (a) { return a; }
    ];


    /** @constructor */
    function Format(options) {

        // If no settings where provided, the defaults will be loaded.
        if (options === undefined) {
            options = {};
        }

        if (typeof options !== 'object') {
            throw new Error("(Format) 'format' option must be an object.");
        }

        var settings = {};

        // Copy all values into a new object.
        $(Formatting).each(function (i, val) {

            if (options[val] === undefined) {

                settings[val] = FormatDefaults[i];

                // When we aren't loading defaults, validate the entry.
            } else if ((typeof options[val]) === (typeof FormatDefaults[i])) {

                // Support for up to 7 decimals.
                // More can't be guaranteed due to floating point issues.
                if (val === 'decimals') {
                    if (options[val] < 0 || options[val] > 7) {
                        throw new Error("(Format) 'format.decimals' option must be between 0 and 7.");
                    }
                }

                settings[val] = options[val];

                // If the value isn't valid, emit an error.
            } else {
                throw new Error("(Format) 'format." + val + "' must be a " + typeof FormatDefaults[i] + ".");
            }
        });

        // Some values can't be extracted from a
        // string if certain combinations are present.
        throwEqualError(settings, 'mark', 'thousand');
        throwEqualError(settings, 'prefix', 'negative');
        throwEqualError(settings, 'prefix', 'negativeBefore');

        this.settings = settings;
    }

    // Shorthand for internal value get
    Format.prototype.v = function (a) {
        return this.settings[a];
    };

    Format.prototype.to = function (number) {

        function reverse(a) {
            return a.split('').reverse().join('');
        }

        number = this.v('encoder')(number);

        var decimals = this.v('decimals'),
			negative = '', preNegative = '', base = '', mark = '';

        // Rounding away decimals might cause a value of -0
        // when using very small ranges. Remove those cases.
        if (parseFloat(number.toFixed(decimals)) === 0) {
            number = '0';
        }

        if (number < 0) {
            negative = this.v('negative');
            preNegative = this.v('negativeBefore');
        }

        // Round to proper decimal count
        number = Math.abs(number).toFixed(decimals).toString();
        number = number.split('.');

        // Group numbers in sets of three.
        if (this.v('thousand')) {
            base = reverse(number[0]).match(/.{1,3}/g);
            base = reverse(base.join(reverse(this.v('thousand'))));
        } else {
            base = number[0];
        }

        // Ignore the decimal separator if decimals are set to 0.
        if (this.v('mark') && number.length > 1) {
            mark = this.v('mark') + number[1];
        }

        // Return the finalized formatted number.
        return this.v('to')(preNegative +
			this.v('prefix') +
			negative +
			base +
			mark +
			this.v('postfix'));
    };

    Format.prototype.from = function (input) {

        function esc(s) {
            return s.replace(/[\-\/\\\^$*+?.()|\[\]{}]/g, '\\$&');
        }

        var isNeg;
        // The set request might want to ignore this handle.
        // Test for 'undefined' too, as a two-handle slider
        // can still be set with an integer.
        if (input === null || input === undefined) {
            return false;
        }

        input = this.v('from')(input);

        // Remove formatting and set period for float parsing.
        input = input.toString();

        // Replace the preNegative indicator.
        isNeg = input.replace(new RegExp('^' + esc(this.v('negativeBefore'))), '');

        // Check if the value changed by removing the negativeBefore symbol.
        if (input !== isNeg) {
            input = isNeg;
            isNeg = '-';
        } else {
            isNeg = '';
        }

        // If prefix is set and the number is actually prefixed.
        input = input.replace(new RegExp('^' + esc(this.v('prefix'))), '');

        // Only replace if a negative sign is set.
        if (this.v('negative')) {

            // Reset isNeg to prevent double '-' insertion.
            isNeg = '';

            // Reset the negative sign to '-'
            input = input.replace(new RegExp('^' + esc(this.v('negative'))), '-');
        }

        // Clean the input string
        input = input
		// If postfix is set and the number is postfixed.
			.replace(new RegExp(esc(this.v('postfix')) + '$'), '')
		// Remove the separator every three digits.
			.replace(new RegExp(esc(this.v('thousand')), 'g'), '')
		// Set the decimal separator back to period.
			.replace(this.v('mark'), '.');

        // Run the user defined decoder. Returns input by default.
        input = this.v('decoder')(parseFloat(isNeg + input));

        // Ignore invalid input
        if (isNaN(input)) {
            return false;
        }

        return input;
    };


    /** @expose */
    /** @constructor */
    function Link(entry, update) {

        if (typeof entry !== "object") {
            $.error("(Link) Initialize with an object.");
        }

        // Make sure Link isn't called as a function, in which case
        // the 'this' scope would be the window.
        return new Link.prototype.init(entry['target'] || function () { }, entry['method'], entry['format'] || {}, update);
    }

    Link.prototype.setTooltip = function (target, method) {

        // By default, use the 'html' method.
        this.method = method || 'html';

        // Use jQuery to create the element
        this.el = $(target.replace('-tooltip-', '') || '<div/>')[0];
    };

    Link.prototype.setHidden = function (target) {

        this.method = 'val';

        this.el = document.createElement('input');
        this.el.name = target;
        this.el.type = 'hidden';
    };

    Link.prototype.setField = function (target) {

        // Returns nulled array.
        function at(a, b, c) {
            return [c ? a : b, c ? b : a];
        }

        // In IE < 9, .bind() isn't available, need this link in .change().
        var that = this;

        // Default to .val if this is an input element.
        this.method = 'val';
        // Set the slider to a new value on change.
        this.target = target.on('change', function (e) {
            that.obj.val(
				at(null, $(e.target).val(), that.N),
				{ 'link': that, 'set': true }
			);
        });
    };


    // Initialisor
    /** @constructor */
    Link.prototype.init = function (target, method, format, update) {

        // Write all formatting to this object.
        // No validation needed, as we'll merge these with the parent
        // format options first.
        this.formatting = format;

        // Store the update option.
        this.update = !update;

        // If target is a string, a new hidden input will be created.
        if (typeof target === 'string' && target.indexOf('-tooltip-') === 0) {
            this.setTooltip(target, method);
            return;
        }

        // If the string doesn't begin with '-', which is reserved, add a new hidden input.
        if (typeof target === 'string' && target.indexOf('-') !== 0) {
            this.setHidden(target);
            return;
        }

        // The target can also be a function, which will be called.
        if (typeof target === 'function') {
            this.target = false;
            this.method = target;
            return;
        }

        if (isInstance(target)) {
            // If a jQuery/Zepto input element is provided, but no method is set,
            // the element can assume it needs to respond to 'change'...

            if (!method) {

                if (target.is('input, select, textarea')) {
                    this.setField(target);
                    return;
                }

                // If no method is set, and we are not auto-binding an input, default to 'html'.
                method = 'html';
            }

            // The method must exist on the element.
            if (typeof method === 'function' || (typeof method === 'string' && target[method])) {
                this.method = method;
                this.target = target;
                return;
            }
        }

        // Nothing matched, throw error.
        throw new RangeError("(Link) Invalid Link.");
    };

    // Provides external items with the slider value.
    Link.prototype.write = function (value, handle, slider, update) {

        // Don't synchronize this Link.
        if (this.update && update === false) {
            return;
        }

        this.actual = value;

        // Format values for display.
        value = this.format(value);

        // Store the numerical value.
        this.saved = value;

        // Branch between serialization to a function or an object.
        if (typeof this.method === 'function') {
            // When target is undefined, the target was a function.
            // In that case, provided the slider as the calling scope.
            // Use [0] to get the DOM element, not the $ instance.
            this.method.call(this.target[0] || slider[0], value, handle, slider);
        } else {
            this.target[this.method](value, handle, slider);
        }
    };

    // Set formatting options.
    Link.prototype.setFormatting = function (options) {
        this.formatting = new Format($.extend({},
			options,
			this.formatting instanceof Format ? this.formatting.settings : this.formatting
		));
    };

    Link.prototype.setObject = function (obj) {
        this.obj = obj;
    };

    Link.prototype.setIndex = function (index) {
        this.N = index;
    };

    // Parses slider value to user defined display.
    Link.prototype.format = function (a) {
        return this.formatting.to(a);
    };

    // Converts a formatted value back to a real number.
    Link.prototype.getValue = function (a) {
        return this.formatting.from(a);
    };

    // We can now test for Link.init to be an instance of Link.
    Link.prototype.init.prototype = Link.prototype;

    /** @expose */
    $.Link = Link;

}(window['jQuery'] || window['Zepto']));


!function(){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n};!function(e){function a(n,e){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},t=Object.create(n.prototype);for(var o in a)t[o]=a[o];return t.constructor=e,e.prototype=t,e}function t(n){n=n||{},this.defaultProtocol=n.hasOwnProperty("defaultProtocol")?n.defaultProtocol:h.defaultProtocol,this.events=n.hasOwnProperty("events")?n.events:h.events,this.format=n.hasOwnProperty("format")?n.format:h.format,this.formatHref=n.hasOwnProperty("formatHref")?n.formatHref:h.formatHref,this.nl2br=n.hasOwnProperty("nl2br")?n.nl2br:h.nl2br,this.tagName=n.hasOwnProperty("tagName")?n.tagName:h.tagName,this.target=n.hasOwnProperty("target")?n.target:h.target,this.validate=n.hasOwnProperty("validate")?n.validate:h.validate,this.ignoreTags=[],this.attributes=n.attributes||n.linkAttributes||h.attributes,this.className=n.hasOwnProperty("className")?n.className:n.linkClass||h.className;for(var e=n.hasOwnProperty("ignoreTags")?n.ignoreTags:h.ignoreTags,a=0;a<e.length;a++)this.ignoreTags.push(e[a].toUpperCase())}function o(n,e){for(var a=0;a<n.length;a++)if(n[a]===e)return!0;return!1}function r(n){return n}function i(n,e){return"url"===e?"_blank":null}function s(){return function(n){this.j=[],this.T=n||null}}function c(n,e,a,t){for(var o=0,r=n.length,i=e,s=[],c=void 0;o<r&&(c=i.next(n[o]));)i=c,o++;if(o>=r)return[];for(;o<r-1;)c=new m(t),s.push(c),i.on(n[o],c),i=c,o++;return c=new m(a),s.push(c),i.on(n[r-1],c),s}function l(){return function(n){n&&(this.v=n)}}function u(n){var e=n?{v:n}:{};return a(d,l(),e)}function g(n){return n instanceof x||n instanceof C}var h={defaultProtocol:"http",events:null,format:r,formatHref:r,nl2br:!1,tagName:"a",target:i,validate:!0,ignoreTags:[],attributes:null,className:"linkified"};t.prototype={resolve:function(n){var e=n.toHref(this.defaultProtocol);return{formatted:this.get("format",n.toString(),n),formattedHref:this.get("formatHref",e,n),tagName:this.get("tagName",e,n),className:this.get("className",e,n),target:this.get("target",e,n),events:this.getObject("events",e,n),attributes:this.getObject("attributes",e,n)}},check:function(n){return this.get("validate",n.toString(),n)},get:function(e,a,t){var o=void 0,r=this[e];if(!r)return r;switch("undefined"==typeof r?"undefined":n(r)){case"function":return r(a,t.type);case"object":return o=r.hasOwnProperty(t.type)?r[t.type]:h[e],"function"==typeof o?o(a,t.type):o}return r},getObject:function(n,e,a){var t=this[n];return"function"==typeof t?t(e,a.type):t}};var b=Object.freeze({defaults:h,Options:t,contains:o}),p=s();p.prototype={defaultTransition:!1,on:function(n,e){if(n instanceof Array){for(var a=0;a<n.length;a++)this.j.push([n[a],e]);return this}return this.j.push([n,e]),this},next:function(n){for(var e=0;e<this.j.length;e++){var a=this.j[e],t=a[0],o=a[1];if(this.test(n,t))return o}return this.defaultTransition},accepts:function(){return!!this.T},test:function(n,e){return n===e},emit:function(){return this.T}};var m=a(p,s(),{test:function(n,e){return n===e||e instanceof RegExp&&e.test(n)}}),f=a(p,s(),{jump:function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=this.next(new n(""));return a===this.defaultTransition?(a=new this.constructor(e),this.on(n,a)):e&&(a.T=e),a},test:function(n,e){return n instanceof e}}),d=l();d.prototype={toString:function(){return this.v+""}};var x=u(),y=u("@"),v=u(":"),k=u("."),w=u(),j=u(),z=u("\n"),O=u(),q=u("+"),N=u("#"),S=u(),T=u("mailto:"),A=u("?"),L=u("/"),P=u("_"),E=u(),C=u(),R=u(),H=u("{"),B=u("["),U=u("<"),M=u("("),D=u("}"),I=u("]"),K=u(">"),_=u(")"),G=u("&"),Y=Object.freeze({Base:d,DOMAIN:x,AT:y,COLON:v,DOT:k,PUNCTUATION:w,LOCALHOST:j,NL:z,NUM:O,PLUS:q,POUND:N,QUERY:A,PROTOCOL:S,MAILTO:T,SLASH:L,UNDERSCORE:P,SYM:E,TLD:C,WS:R,OPENBRACE:H,OPENBRACKET:B,OPENANGLEBRACKET:U,OPENPAREN:M,CLOSEBRACE:D,CLOSEBRACKET:I,CLOSEANGLEBRACKET:K,CLOSEPAREN:_,AMPERSAND:G}),Q="aaa|aarp|abarth|abb|abbott|abbvie|abc|able|abogado|abudhabi|ac|academy|accenture|accountant|accountants|aco|active|actor|ad|adac|ads|adult|ae|aeg|aero|aetna|af|afamilycompany|afl|africa|ag|agakhan|agency|ai|aig|aigo|airbus|airforce|airtel|akdn|al|alfaromeo|alibaba|alipay|allfinanz|allstate|ally|alsace|alstom|am|americanexpress|americanfamily|amex|amfam|amica|amsterdam|analytics|android|anquan|anz|ao|aol|apartments|app|apple|aq|aquarelle|ar|arab|aramco|archi|army|arpa|art|arte|as|asda|asia|associates|at|athleta|attorney|au|auction|audi|audible|audio|auspost|author|auto|autos|avianca|aw|aws|ax|axa|az|azure|ba|baby|baidu|banamex|bananarepublic|band|bank|bar|barcelona|barclaycard|barclays|barefoot|bargains|baseball|basketball|bauhaus|bayern|bb|bbc|bbt|bbva|bcg|bcn|bd|be|beats|beauty|beer|bentley|berlin|best|bestbuy|bet|bf|bg|bh|bharti|bi|bible|bid|bike|bing|bingo|bio|biz|bj|black|blackfriday|blanco|blockbuster|blog|bloomberg|blue|bm|bms|bmw|bn|bnl|bnpparibas|bo|boats|boehringer|bofa|bom|bond|boo|book|booking|boots|bosch|bostik|boston|bot|boutique|box|br|bradesco|bridgestone|broadway|broker|brother|brussels|bs|bt|budapest|bugatti|build|builders|business|buy|buzz|bv|bw|by|bz|bzh|ca|cab|cafe|cal|call|calvinklein|cam|camera|camp|cancerresearch|canon|capetown|capital|capitalone|car|caravan|cards|care|career|careers|cars|cartier|casa|case|caseih|cash|casino|cat|catering|catholic|cba|cbn|cbre|cbs|cc|cd|ceb|center|ceo|cern|cf|cfa|cfd|cg|ch|chanel|channel|chase|chat|cheap|chintai|chloe|christmas|chrome|chrysler|church|ci|cipriani|circle|cisco|citadel|citi|citic|city|cityeats|ck|cl|claims|cleaning|click|clinic|clinique|clothing|cloud|club|clubmed|cm|cn|co|coach|codes|coffee|college|cologne|com|comcast|commbank|community|company|compare|computer|comsec|condos|construction|consulting|contact|contractors|cooking|cookingchannel|cool|coop|corsica|country|coupon|coupons|courses|cr|credit|creditcard|creditunion|cricket|crown|crs|cruise|cruises|csc|cu|cuisinella|cv|cw|cx|cy|cymru|cyou|cz|dabur|dad|dance|data|date|dating|datsun|day|dclk|dds|de|deal|dealer|deals|degree|delivery|dell|deloitte|delta|democrat|dental|dentist|desi|design|dev|dhl|diamonds|diet|digital|direct|directory|discount|discover|dish|diy|dj|dk|dm|dnp|do|docs|doctor|dodge|dog|doha|domains|dot|download|drive|dtv|dubai|duck|dunlop|duns|dupont|durban|dvag|dvr|dz|earth|eat|ec|eco|edeka|edu|education|ee|eg|email|emerck|energy|engineer|engineering|enterprises|epost|epson|equipment|er|ericsson|erni|es|esq|estate|esurance|et|etisalat|eu|eurovision|eus|events|everbank|exchange|expert|exposed|express|extraspace|fage|fail|fairwinds|faith|family|fan|fans|farm|farmers|fashion|fast|fedex|feedback|ferrari|ferrero|fi|fiat|fidelity|fido|film|final|finance|financial|fire|firestone|firmdale|fish|fishing|fit|fitness|fj|fk|flickr|flights|flir|florist|flowers|fly|fm|fo|foo|food|foodnetwork|football|ford|forex|forsale|forum|foundation|fox|fr|free|fresenius|frl|frogans|frontdoor|frontier|ftr|fujitsu|fujixerox|fun|fund|furniture|futbol|fyi|ga|gal|gallery|gallo|gallup|game|games|gap|garden|gb|gbiz|gd|gdn|ge|gea|gent|genting|george|gf|gg|ggee|gh|gi|gift|gifts|gives|giving|gl|glade|glass|gle|global|globo|gm|gmail|gmbh|gmo|gmx|gn|godaddy|gold|goldpoint|golf|goo|goodhands|goodyear|goog|google|gop|got|gov|gp|gq|gr|grainger|graphics|gratis|green|gripe|grocery|group|gs|gt|gu|guardian|gucci|guge|guide|guitars|guru|gw|gy|hair|hamburg|hangout|haus|hbo|hdfc|hdfcbank|health|healthcare|help|helsinki|here|hermes|hgtv|hiphop|hisamitsu|hitachi|hiv|hk|hkt|hm|hn|hockey|holdings|holiday|homedepot|homegoods|homes|homesense|honda|honeywell|horse|hospital|host|hosting|hot|hoteles|hotels|hotmail|house|how|hr|hsbc|ht|htc|hu|hughes|hyatt|hyundai|ibm|icbc|ice|icu|id|ie|ieee|ifm|ikano|il|im|imamat|imdb|immo|immobilien|in|industries|infiniti|info|ing|ink|institute|insurance|insure|int|intel|international|intuit|investments|io|ipiranga|iq|ir|irish|is|iselect|ismaili|ist|istanbul|it|itau|itv|iveco|iwc|jaguar|java|jcb|jcp|je|jeep|jetzt|jewelry|jio|jlc|jll|jm|jmp|jnj|jo|jobs|joburg|jot|joy|jp|jpmorgan|jprs|juegos|juniper|kaufen|kddi|ke|kerryhotels|kerrylogistics|kerryproperties|kfh|kg|kh|ki|kia|kim|kinder|kindle|kitchen|kiwi|km|kn|koeln|komatsu|kosher|kp|kpmg|kpn|kr|krd|kred|kuokgroup|kw|ky|kyoto|kz|la|lacaixa|ladbrokes|lamborghini|lamer|lancaster|lancia|lancome|land|landrover|lanxess|lasalle|lat|latino|latrobe|law|lawyer|lb|lc|lds|lease|leclerc|lefrak|legal|lego|lexus|lgbt|li|liaison|lidl|life|lifeinsurance|lifestyle|lighting|like|lilly|limited|limo|lincoln|linde|link|lipsy|live|living|lixil|lk|loan|loans|locker|locus|loft|lol|london|lotte|lotto|love|lpl|lplfinancial|lr|ls|lt|ltd|ltda|lu|lundbeck|lupin|luxe|luxury|lv|ly|ma|macys|madrid|maif|maison|makeup|man|management|mango|map|market|marketing|markets|marriott|marshalls|maserati|mattel|mba|mc|mckinsey|md|me|med|media|meet|melbourne|meme|memorial|men|menu|meo|merckmsd|metlife|mg|mh|miami|microsoft|mil|mini|mint|mit|mitsubishi|mk|ml|mlb|mls|mm|mma|mn|mo|mobi|mobile|mobily|moda|moe|moi|mom|monash|money|monster|mopar|mormon|mortgage|moscow|moto|motorcycles|mov|movie|movistar|mp|mq|mr|ms|msd|mt|mtn|mtr|mu|museum|mutual|mv|mw|mx|my|mz|na|nab|nadex|nagoya|name|nationwide|natura|navy|nba|nc|ne|nec|net|netbank|netflix|network|neustar|new|newholland|news|next|nextdirect|nexus|nf|nfl|ng|ngo|nhk|ni|nico|nike|nikon|ninja|nissan|nissay|nl|no|nokia|northwesternmutual|norton|now|nowruz|nowtv|np|nr|nra|nrw|ntt|nu|nyc|nz|obi|observer|off|office|okinawa|olayan|olayangroup|oldnavy|ollo|om|omega|one|ong|onl|online|onyourside|ooo|open|oracle|orange|org|organic|origins|osaka|otsuka|ott|ovh|pa|page|panasonic|panerai|paris|pars|partners|parts|party|passagens|pay|pccw|pe|pet|pf|pfizer|pg|ph|pharmacy|phd|philips|phone|photo|photography|photos|physio|piaget|pics|pictet|pictures|pid|pin|ping|pink|pioneer|pizza|pk|pl|place|play|playstation|plumbing|plus|pm|pn|pnc|pohl|poker|politie|porn|post|pr|pramerica|praxi|press|prime|pro|prod|productions|prof|progressive|promo|properties|property|protection|pru|prudential|ps|pt|pub|pw|pwc|py|qa|qpon|quebec|quest|qvc|racing|radio|raid|re|read|realestate|realtor|realty|recipes|red|redstone|redumbrella|rehab|reise|reisen|reit|reliance|ren|rent|rentals|repair|report|republican|rest|restaurant|review|reviews|rexroth|rich|richardli|ricoh|rightathome|ril|rio|rip|rmit|ro|rocher|rocks|rodeo|rogers|room|rs|rsvp|ru|rugby|ruhr|run|rw|rwe|ryukyu|sa|saarland|safe|safety|sakura|sale|salon|samsclub|samsung|sandvik|sandvikcoromant|sanofi|sap|sapo|sarl|sas|save|saxo|sb|sbi|sbs|sc|sca|scb|schaeffler|schmidt|scholarships|school|schule|schwarz|science|scjohnson|scor|scot|sd|se|search|seat|secure|security|seek|select|sener|services|ses|seven|sew|sex|sexy|sfr|sg|sh|shangrila|sharp|shaw|shell|shia|shiksha|shoes|shop|shopping|shouji|show|showtime|shriram|si|silk|sina|singles|site|sj|sk|ski|skin|sky|skype|sl|sling|sm|smart|smile|sn|sncf|so|soccer|social|softbank|software|sohu|solar|solutions|song|sony|soy|space|spiegel|spot|spreadbetting|sr|srl|srt|st|stada|staples|star|starhub|statebank|statefarm|statoil|stc|stcgroup|stockholm|storage|store|stream|studio|study|style|su|sucks|supplies|supply|support|surf|surgery|suzuki|sv|swatch|swiftcover|swiss|sx|sy|sydney|symantec|systems|sz|tab|taipei|talk|taobao|target|tatamotors|tatar|tattoo|tax|taxi|tc|tci|td|tdk|team|tech|technology|tel|telecity|telefonica|temasek|tennis|teva|tf|tg|th|thd|theater|theatre|tiaa|tickets|tienda|tiffany|tips|tires|tirol|tj|tjmaxx|tjx|tk|tkmaxx|tl|tm|tmall|tn|to|today|tokyo|tools|top|toray|toshiba|total|tours|town|toyota|toys|tr|trade|trading|training|travel|travelchannel|travelers|travelersinsurance|trust|trv|tt|tube|tui|tunes|tushu|tv|tvs|tw|tz|ua|ubank|ubs|uconnect|ug|uk|unicom|university|uno|uol|ups|us|uy|uz|va|vacations|vana|vanguard|vc|ve|vegas|ventures|verisign|versicherung|vet|vg|vi|viajes|video|vig|viking|villas|vin|vip|virgin|visa|vision|vista|vistaprint|viva|vivo|vlaanderen|vn|vodka|volkswagen|volvo|vote|voting|voto|voyage|vu|vuelos|wales|walmart|walter|wang|wanggou|warman|watch|watches|weather|weatherchannel|webcam|weber|website|wed|wedding|weibo|weir|wf|whoswho|wien|wiki|williamhill|win|windows|wine|winners|wme|wolterskluwer|woodside|work|works|world|wow|ws|wtc|wtf|xbox|xerox|xfinity|xihuan|xin|xn--11b4c3d|xn--1ck2e1b|xn--1qqw23a|xn--2scrj9c|xn--30rr7y|xn--3bst00m|xn--3ds443g|xn--3e0b707e|xn--3hcrj9c|xn--3oq18vl8pn36a|xn--3pxu8k|xn--42c2d9a|xn--45br5cyl|xn--45brj9c|xn--45q11c|xn--4gbrim|xn--54b7fta0cc|xn--55qw42g|xn--55qx5d|xn--5su34j936bgsg|xn--5tzm5g|xn--6frz82g|xn--6qq986b3xl|xn--80adxhks|xn--80ao21a|xn--80aqecdr1a|xn--80asehdb|xn--80aswg|xn--8y0a063a|xn--90a3ac|xn--90ae|xn--90ais|xn--9dbq2a|xn--9et52u|xn--9krt00a|xn--b4w605ferd|xn--bck1b9a5dre4c|xn--c1avg|xn--c2br7g|xn--cck2b3b|xn--cg4bki|xn--clchc0ea0b2g2a9gcd|xn--czr694b|xn--czrs0t|xn--czru2d|xn--d1acj3b|xn--d1alf|xn--e1a4c|xn--eckvdtc9d|xn--efvy88h|xn--estv75g|xn--fct429k|xn--fhbei|xn--fiq228c5hs|xn--fiq64b|xn--fiqs8s|xn--fiqz9s|xn--fjq720a|xn--flw351e|xn--fpcrj9c3d|xn--fzc2c9e2c|xn--fzys8d69uvgm|xn--g2xx48c|xn--gckr3f0f|xn--gecrj9c|xn--gk3at1e|xn--h2breg3eve|xn--h2brj9c|xn--h2brj9c8c|xn--hxt814e|xn--i1b6b1a6a2e|xn--imr513n|xn--io0a7i|xn--j1aef|xn--j1amh|xn--j6w193g|xn--jlq61u9w7b|xn--jvr189m|xn--kcrx77d1x4a|xn--kprw13d|xn--kpry57d|xn--kpu716f|xn--kput3i|xn--l1acc|xn--lgbbat1ad8j|xn--mgb9awbf|xn--mgba3a3ejt|xn--mgba3a4f16a|xn--mgba7c0bbn0a|xn--mgbaakc7dvf|xn--mgbaam7a8h|xn--mgbab2bd|xn--mgbai9azgqp6j|xn--mgbayh7gpa|xn--mgbb9fbpob|xn--mgbbh1a|xn--mgbbh1a71e|xn--mgbc0a9azcg|xn--mgbca7dzdo|xn--mgberp4a5d4ar|xn--mgbgu82a|xn--mgbi4ecexp|xn--mgbpl2fh|xn--mgbt3dhd|xn--mgbtx2b|xn--mgbx4cd0ab|xn--mix891f|xn--mk1bu44c|xn--mxtq1m|xn--ngbc5azd|xn--ngbe9e0a|xn--ngbrx|xn--node|xn--nqv7f|xn--nqv7fs00ema|xn--nyqy26a|xn--o3cw4h|xn--ogbpf8fl|xn--p1acf|xn--p1ai|xn--pbt977c|xn--pgbs0dh|xn--pssy2u|xn--q9jyb4c|xn--qcka1pmc|xn--qxam|xn--rhqv96g|xn--rovu88b|xn--rvc1e0am3e|xn--s9brj9c|xn--ses554g|xn--t60b56a|xn--tckwe|xn--tiq49xqyj|xn--unup4y|xn--vermgensberater-ctb|xn--vermgensberatung-pwb|xn--vhquv|xn--vuq861b|xn--w4r85el8fhu5dnra|xn--w4rs40l|xn--wgbh1c|xn--wgbl6a|xn--xhq521b|xn--xkc2al3hye2a|xn--xkc2dl3a5ee0h|xn--y9a3aq|xn--yfro4i67o|xn--ygbi2ammx|xn--zfr164b|xperia|xxx|xyz|yachts|yahoo|yamaxun|yandex|ye|yodobashi|yoga|yokohama|you|youtube|yt|yun|za|zappos|zara|zero|zip|zippo|zm|zone|zuerich|zw".split("|"),W="0123456789".split(""),X="0123456789abcdefghijklmnopqrstuvwxyz".split(""),Z=[" ","\f","\r","\t","\x0B","","",""],F=[],J=function(n){return new m(n)},V=J(),$=J(O),nn=J(x),en=J(),an=J(R);V.on("@",J(y)).on(".",J(k)).on("+",J(q)).on("#",J(N)).on("?",J(A)).on("/",J(L)).on("_",J(P)).on(":",J(v)).on("{",J(H)).on("[",J(B)).on("<",J(U)).on("(",J(M)).on("}",J(D)).on("]",J(I)).on(">",J(K)).on(")",J(_)).on("&",J(G)).on([",",";","!",'"',"'"],J(w)),V.on("\n",J(z)).on(Z,an),an.on(Z,an);for(var tn=0;tn<Q.length;tn++){var on=c(Q[tn],V,C,x);F.push.apply(F,on)}var rn=c("file",V,x,x),sn=c("ftp",V,x,x),cn=c("http",V,x,x),ln=c("mailto",V,x,x);F.push.apply(F,rn),F.push.apply(F,sn),F.push.apply(F,cn),F.push.apply(F,ln);var un=rn.pop(),gn=sn.pop(),hn=cn.pop(),bn=ln.pop(),pn=J(x),mn=J(S),fn=J(T);gn.on("s",pn).on(":",mn),hn.on("s",pn).on(":",mn),F.push(pn),un.on(":",mn),pn.on(":",mn),bn.on(":",fn);var dn=c("localhost",V,j,x);F.push.apply(F,dn),V.on(W,$),$.on("-",en).on(W,$).on(X,nn),nn.on("-",en).on(X,nn);for(var xn=0;xn<F.length;xn++)F[xn].on("-",en).on(X,nn);en.on("-",en).on(W,nn).on(X,nn),V.defaultTransition=J(E);var yn=function(n){for(var e=n.replace(/[A-Z]/g,function(n){return n.toLowerCase()}),a=n.length,t=[],o=0;o<a;){for(var r=V,i=null,s=0,c=null,l=-1;o<a&&(i=r.next(e[o]));)r=i,r.accepts()?(l=0,c=r):l>=0&&l++,s++,o++;if(!(l<0)){o-=l,s-=l;var u=c.emit();t.push(new u(n.substr(o-s,s)))}}return t},vn=V,kn=Object.freeze({State:m,TOKENS:Y,run:yn,start:vn}),wn=l();wn.prototype={type:"token",isLink:!1,toString:function(){for(var n=[],e=0;e<this.v.length;e++)n.push(this.v[e].toString());return n.join("")},toHref:function(){return this.toString()},toObject:function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"http";return{type:this.type,value:this.toString(),href:this.toHref(n)}}};var jn=a(wn,l(),{type:"email",isLink:!0}),zn=a(wn,l(),{type:"email",isLink:!0,toHref:function(){return"mailto:"+this.toString()}}),On=a(wn,l(),{type:"text"}),qn=a(wn,l(),{type:"nl"}),Nn=a(wn,l(),{type:"url",isLink:!0,toHref:function(){for(var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"http",e=!1,a=!1,t=this.v,o=[],r=0;t[r]instanceof S;)e=!0,o.push(t[r].toString().toLowerCase()),r++;for(;t[r]instanceof L;)a=!0,o.push(t[r].toString()),r++;for(;g(t[r]);)o.push(t[r].toString().toLowerCase()),r++;for(;r<t.length;r++)o.push(t[r].toString());return o=o.join(""),e||a||(o=n+"://"+o),o},hasProtocol:function(){return this.v[0]instanceof S}}),Sn=Object.freeze({Base:wn,MAILTOEMAIL:jn,EMAIL:zn,NL:qn,TEXT:On,URL:Nn}),Tn=function(n){return new f(n)},An=Tn(),Ln=Tn(),Pn=Tn(),En=Tn(),Cn=Tn(),Rn=Tn(),Hn=Tn(),Bn=Tn(Nn),Un=Tn(),Mn=Tn(Nn),Dn=Tn(Nn),In=Tn(),Kn=Tn(),_n=Tn(),Gn=Tn(),Yn=Tn(),Qn=Tn(Nn),Wn=Tn(Nn),Xn=Tn(Nn),Zn=Tn(Nn),Fn=Tn(),Jn=Tn(),Vn=Tn(),$n=Tn(),ne=Tn(),ee=Tn(),ae=Tn(zn),te=Tn(),oe=Tn(zn),re=Tn(jn),ie=Tn(),se=Tn(),ce=Tn(),le=Tn(),ue=Tn(qn);An.on(z,ue).on(S,Ln).on(T,Pn).on(L,En),Ln.on(L,En),En.on(L,Cn),An.on(C,Rn).on(x,Rn).on(j,Bn).on(O,Rn),Cn.on(C,Dn).on(x,Dn).on(O,Dn).on(j,Dn),Rn.on(k,Hn),ne.on(k,ee),Hn.on(C,Bn).on(x,Rn).on(O,Rn).on(j,Rn),ee.on(C,ae).on(x,ne).on(O,ne).on(j,ne),Bn.on(k,Hn),ae.on(k,ee),Bn.on(v,Un).on(L,Dn),Un.on(O,Mn),Mn.on(L,Dn),ae.on(v,te),te.on(O,oe);var ge=[x,y,j,O,q,N,S,L,C,P,E,G],he=[v,k,A,w,D,I,K,_,H,B,U,M];Dn.on(H,Kn).on(B,_n).on(U,Gn).on(M,Yn),In.on(H,Kn).on(B,_n).on(U,Gn).on(M,Yn),Kn.on(D,Dn),_n.on(I,Dn),Gn.on(K,Dn),Yn.on(_,Dn),Qn.on(D,Dn),Wn.on(I,Dn),Xn.on(K,Dn),Zn.on(_,Dn),Fn.on(D,Dn),Jn.on(I,Dn),Vn.on(K,Dn),$n.on(_,Dn),Kn.on(ge,Qn),_n.on(ge,Wn),Gn.on(ge,Xn),Yn.on(ge,Zn),Kn.on(he,Fn),_n.on(he,Jn),Gn.on(he,Vn),Yn.on(he,$n),Qn.on(ge,Qn),Wn.on(ge,Wn),Xn.on(ge,Xn),Zn.on(ge,Zn),Qn.on(he,Qn),Wn.on(he,Wn),Xn.on(he,Xn),Zn.on(he,Zn),Fn.on(ge,Qn),Jn.on(ge,Wn),Vn.on(ge,Xn),$n.on(ge,Zn),Fn.on(he,Fn),Jn.on(he,Jn),Vn.on(he,Vn),$n.on(he,$n),Dn.on(ge,Dn),In.on(ge,Dn),Dn.on(he,In),In.on(he,In),Pn.on(C,re).on(x,re).on(O,re).on(j,re),re.on(ge,re).on(he,ie),ie.on(ge,re).on(he,ie);var be=[x,O,q,N,A,P,E,G,C];Rn.on(be,se).on(y,ce),Bn.on(be,se).on(y,ce),Hn.on(be,se),se.on(be,se).on(y,ce).on(k,le),le.on(be,se),ce.on(C,ne).on(x,ne).on(j,ae);var pe=function(n){for(var e=n.length,a=0,t=[],o=[];a<e;){for(var r=An,i=null,s=null,c=0,l=null,u=-1;a<e&&!(i=r.next(n[a]));)o.push(n[a++]);for(;a<e&&(s=i||r.next(n[a]));)i=null,r=s,r.accepts()?(u=0,l=r):u>=0&&u++,a++,c++;if(u<0)for(var g=a-c;g<a;g++)o.push(n[g]);else{o.length>0&&(t.push(new On(o)),o=[]),a-=u,c-=u;var h=l.emit();t.push(new h(n.slice(a-c,a)))}}return o.length>0&&t.push(new On(o)),t},me=Object.freeze({State:f,TOKENS:Sn,run:pe,start:An});Array.isArray||(Array.isArray=function(n){return"[object Array]"===Object.prototype.toString.call(n)});var fe=function(n){return pe(yn(n))},de=function(n){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=fe(n),t=[],o=0;o<a.length;o++){var r=a[o];!r.isLink||e&&r.type!==e||t.push(r.toObject())}return t},xe=function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=fe(n);return 1===a.length&&a[0].isLink&&(!e||a[0].type===e)};e.find=de,e.inherits=a,e.options=b,e.parser=me,e.scanner=kn,e.test=xe,e.tokenize=fe}(self.linkify=self.linkify||{})}();
"use strict";!function(t,i){var s=function(t){function i(t){this.a=t}function s(t){return v.test(t)}function e(t){return k.test(t)}function h(t){return t.replace(A,"\n")}function r(t,i){this.b=t,this.c=i,this.d=null,this.input=null,this.e=-1,this.f=-1,this.g=-1,this.h=-1,this.i=-1,this.j()}function n(t,i){this.k=null,this.startLine=1,this.startColumn=0,this.options=i||{},this.tokenizer=new r(this,t)}function a(t,s){var e=new n(new i(p),s);return e.tokenize(t)}function o(t){var i,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=z.tokenize(t),h=[],r=[];for(s=new D(s),i=0;i<e.length;i++){var n=e[i];if(n.type!==y)if(n.type===T){var a=u(n.chars,s);h.push.apply(h,a)}else h.push(n);else{h.push(n);var o=n.tagName.toUpperCase(),c="A"===o||N.contains(s.ignoreTags,o);if(!c)continue;var p=h.length;f(o,e,++i,h),i+=h.length-p-1}}for(i=0;i<h.length;i++){var l=h[i];switch(l.type){case y:var m="<"+l.tagName;if(l.attributes.length>0){var g=d(l.attributes);m+=" "+g.join(" ")}m+=">",r.push(m);break;case C:r.push("</"+l.tagName+">");break;case T:r.push(b(l.chars));break;case F:r.push("<!--"+b(l.chars)+"-->")}}return r.join("")}function u(i,s){for(var e=t.tokenize(i),h=[],r=0;r<e.length;r++){var n=e[r];if("nl"===n.type&&s.nl2br)h.push({type:y,tagName:"br",attributes:[],l:!0});else if(n.isLink&&s.check(n)){var a=s.resolve(n),o=a.formatted,u=a.formattedHref,f=a.tagName,b=a.className,c=a.target,d=a.attributes,p=[["href",u]];b&&p.push(["class",b]),c&&p.push(["target",c]);for(var l in d)p.push([l,d[l]]);h.push({type:y,tagName:f,attributes:p,l:!1}),h.push({type:T,chars:o}),h.push({type:C,tagName:f})}else h.push({type:T,chars:n.toString()})}return h}function f(t,i,s,e){for(var h=1;s<i.length&&h>0;){var r=i[s];r.type===y&&r.tagName.toUpperCase()===t?h++:r.type===C&&r.tagName.toUpperCase()===t&&h--,e.push(r),s++}return e}function b(t){return t}function c(t){return t.replace(/"/g,"&quot;")}function d(t){for(var i=[],s=0;s<t.length;s++){var e=t[s],h=e[0],r=e[1];i.push(h+'="'+c(r)+'"')}return i}var p={m:""},l=/^#[xX]([A-Fa-f0-9]+)$/,m=/^#([0-9]+)$/,g=/^([A-Za-z0-9]+)$/;i.prototype.parse=function(t){if(t){var i=t.match(l);return i?"&#x"+i[1]+";":(i=t.match(m))?"&#"+i[1]+";":(i=t.match(g),i?this.a[i[1]]||"&"+i[1]+";":void 0)}};var v=/[\t\n\f ]/,k=/[A-Za-z]/,A=/\r\n?/g;r.prototype={j:function(){this.d="beforeData",this.input="",this.e=0,this.f=1,this.g=0,this.h=-1,this.i=-1,this.b.j()},tokenize:function(t){this.j(),this.tokenizePart(t),this.tokenizeEOF()},tokenizePart:function(t){for(this.input+=h(t);this.e<this.input.length;)this.n[this.d].call(this)},tokenizeEOF:function(){this.o()},o:function(){"data"===this.d&&(this.b.p(),this.d="beforeData")},q:function(){return this.input.charAt(this.e)},r:function(){var t=this.q();return this.e++,"\n"===t?(this.f++,this.g=0):this.g++,t},s:function(){var t=this.input.indexOf(";",this.e);if(t!==-1){var i=this.input.slice(this.e,t),s=this.c.parse(i);if(s){for(var e=i.length;e;)this.r(),e--;return this.r(),s}}},t:function(){this.h=this.f,this.i=this.g,this.b.tagOpen&&this.b.tagOpen()},n:{beforeData:function(){var t=this.q();"<"===t?(this.d="tagOpen",this.t(),this.r()):(this.d="data",this.b.u())},data:function(){var t=this.q();"<"===t?(this.b.p(),this.d="tagOpen",this.t(),this.r()):"&"===t?(this.r(),this.b.v(this.s()||"&")):(this.r(),this.b.v(t))},tagOpen:function(){var t=this.r();"!"===t?this.d="markupDeclaration":"/"===t?this.d="endTagOpen":e(t)&&(this.d="tagName",this.b.w(),this.b.x(t.toLowerCase()))},markupDeclaration:function(){var t=this.r();"-"===t&&"-"===this.input.charAt(this.e)&&(this.r(),this.d="commentStart",this.b.y())},commentStart:function(){var t=this.r();"-"===t?this.d="commentStartDash":">"===t?(this.b.z(),this.d="beforeData"):(this.b.A(t),this.d="comment")},commentStartDash:function(){var t=this.r();"-"===t?this.d="commentEnd":">"===t?(this.b.z(),this.d="beforeData"):(this.b.A("-"),this.d="comment")},comment:function(){var t=this.r();"-"===t?this.d="commentEndDash":this.b.A(t)},commentEndDash:function(){var t=this.r();"-"===t?this.d="commentEnd":(this.b.A("-"+t),this.d="comment")},commentEnd:function(){var t=this.r();">"===t?(this.b.z(),this.d="beforeData"):(this.b.A("--"+t),this.d="comment")},tagName:function(){var t=this.r();s(t)?this.d="beforeAttributeName":"/"===t?this.d="selfClosingStartTag":">"===t?(this.b.B(),this.d="beforeData"):this.b.x(t)},beforeAttributeName:function(){var t=this.q();return s(t)?void this.r():void("/"===t?(this.d="selfClosingStartTag",this.r()):">"===t?(this.r(),this.b.B(),this.d="beforeData"):(this.d="attributeName",this.b.C(),this.r(),this.b.D(t)))},attributeName:function(){var t=this.q();s(t)?(this.d="afterAttributeName",this.r()):"/"===t?(this.b.F(!1),this.b.G(),this.r(),this.d="selfClosingStartTag"):"="===t?(this.d="beforeAttributeValue",this.r()):">"===t?(this.b.F(!1),this.b.G(),this.r(),this.b.B(),this.d="beforeData"):(this.r(),this.b.D(t))},afterAttributeName:function(){var t=this.q();return s(t)?void this.r():void("/"===t?(this.b.F(!1),this.b.G(),this.r(),this.d="selfClosingStartTag"):"="===t?(this.r(),this.d="beforeAttributeValue"):">"===t?(this.b.F(!1),this.b.G(),this.r(),this.b.B(),this.d="beforeData"):(this.b.F(!1),this.b.G(),this.r(),this.d="attributeName",this.b.C(),this.b.D(t)))},beforeAttributeValue:function(){var t=this.q();s(t)?this.r():'"'===t?(this.d="attributeValueDoubleQuoted",this.b.F(!0),this.r()):"'"===t?(this.d="attributeValueSingleQuoted",this.b.F(!0),this.r()):">"===t?(this.b.F(!1),this.b.G(),this.r(),this.b.B(),this.d="beforeData"):(this.d="attributeValueUnquoted",this.b.F(!1),this.r(),this.b.H(t))},attributeValueDoubleQuoted:function(){var t=this.r();'"'===t?(this.b.G(),this.d="afterAttributeValueQuoted"):"&"===t?this.b.H(this.s('"')||"&"):this.b.H(t)},attributeValueSingleQuoted:function(){var t=this.r();"'"===t?(this.b.G(),this.d="afterAttributeValueQuoted"):"&"===t?this.b.H(this.s("'")||"&"):this.b.H(t)},attributeValueUnquoted:function(){var t=this.q();s(t)?(this.b.G(),this.r(),this.d="beforeAttributeName"):"&"===t?(this.r(),this.b.H(this.s(">")||"&")):">"===t?(this.b.G(),this.r(),this.b.B(),this.d="beforeData"):(this.r(),this.b.H(t))},afterAttributeValueQuoted:function(){var t=this.q();s(t)?(this.r(),this.d="beforeAttributeName"):"/"===t?(this.r(),this.d="selfClosingStartTag"):">"===t?(this.r(),this.b.B(),this.d="beforeData"):this.d="beforeAttributeName"},selfClosingStartTag:function(){var t=this.q();">"===t?(this.r(),this.b.I(),this.b.B(),this.d="beforeData"):this.d="beforeAttributeName"},endTagOpen:function(){var t=this.r();e(t)&&(this.d="tagName",this.b.J(),this.b.x(t.toLowerCase()))}}},n.prototype={tokenize:function(t){return this.K=[],this.tokenizer.tokenize(t),this.K},tokenizePart:function(t){return this.K=[],this.tokenizer.tokenizePart(t),this.K},tokenizeEOF:function(){return this.K=[],this.tokenizer.tokenizeEOF(),this.K[0]},j:function(){this.k=null,this.startLine=1,this.startColumn=0},L:function(){this.options.M&&(this.k.M={start:{f:this.startLine,g:this.startColumn},N:{f:this.tokenizer.f,g:this.tokenizer.g}}),this.startLine=this.tokenizer.f,this.startColumn=this.tokenizer.g},u:function(){this.k={type:"Chars",chars:""},this.K.push(this.k)},v:function(t){this.k.chars+=t},p:function(){this.L()},y:function(){this.k={type:"Comment",chars:""},this.K.push(this.k)},A:function(t){this.k.chars+=t},z:function(){this.L()},w:function(){this.k={type:"StartTag",tagName:"",attributes:[],l:!1},this.K.push(this.k)},J:function(){this.k={type:"EndTag",tagName:""},this.K.push(this.k)},B:function(){this.L()},I:function(){this.k.l=!0},x:function(t){this.k.tagName+=t},C:function(){this._currentAttribute=["","",null],this.k.attributes.push(this._currentAttribute)},D:function(t){this._currentAttribute[0]+=t},F:function(t){this._currentAttribute[2]=t},H:function(t){this._currentAttribute[1]=this._currentAttribute[1]||"",this._currentAttribute[1]+=t},G:function(){}};var z={HTML5NamedCharRefs:p,EntityParser:i,EventedTokenizer:r,Tokenizer:n,tokenize:a},N=t.options,D=N.Options,y="StartTag",C="EndTag",T="Chars",F="Comment";return o}(i);t.linkifyHtml=s}(window,linkify);
/*!
 * Knockout JavaScript library v3.4.0
 * (c) Steven Sanderson - http://knockoutjs.com/
 * License: MIT (http://www.opensource.org/licenses/mit-license.php)
 */

(function () {
    (function (n) {
        var x = this || (0, eval)("this"), u = x.document, M = x.navigator, v = x.jQuery, F = x.JSON; (function (n) { "function" === typeof define && define.amd ? define(["exports", "require"], n) : "object" === typeof exports && "object" === typeof module ? n(module.exports || exports) : n(x.ko = {}) })(function (N, O) {
            function J(a, c) { return null === a || typeof a in T ? a === c : !1 } function U(b, c) { var d; return function () { d || (d = a.a.setTimeout(function () { d = n; b() }, c)) } } function V(b, c) { var d; return function () { clearTimeout(d); d = a.a.setTimeout(b, c) } } function W(a,
            c) { c && c !== I ? "beforeChange" === c ? this.Kb(a) : this.Ha(a, c) : this.Lb(a) } function X(a, c) { null !== c && c.k && c.k() } function Y(a, c) { var d = this.Hc, e = d[s]; e.R || (this.lb && this.Ma[c] ? (d.Pb(c, a, this.Ma[c]), this.Ma[c] = null, --this.lb) : e.r[c] || d.Pb(c, a, e.s ? { ia: a } : d.uc(a))) } function K(b, c, d, e) {
                a.d[b] = { init: function (b, g, k, l, m) { var h, r; a.m(function () { var q = a.a.c(g()), p = !d !== !q, A = !r; if (A || c || p !== h) A && a.va.Aa() && (r = a.a.ua(a.f.childNodes(b), !0)), p ? (A || a.f.da(b, a.a.ua(r)), a.eb(e ? e(m, q) : m, b)) : a.f.xa(b), h = p }, null, { i: b }); return { controlsDescendantBindings: !0 } } };
                a.h.ta[b] = !1; a.f.Z[b] = !0
            } var a = "undefined" !== typeof N ? N : {}; a.b = function (b, c) { for (var d = b.split("."), e = a, f = 0; f < d.length - 1; f++) e = e[d[f]]; e[d[d.length - 1]] = c }; a.G = function (a, c, d) { a[c] = d }; a.version = "3.4.0"; a.b("version", a.version); a.options = { deferUpdates: !1, useOnlyNativeEvents: !1 }; a.a = function () {
                function b(a, b) { for (var c in a) a.hasOwnProperty(c) && b(c, a[c]) } function c(a, b) { if (b) for (var c in b) b.hasOwnProperty(c) && (a[c] = b[c]); return a } function d(a, b) { a.__proto__ = b; return a } function e(b, c, d, e) {
                    var h = b[c].match(r) ||
                    []; a.a.q(d.match(r), function (b) { a.a.pa(h, b, e) }); b[c] = h.join(" ")
                } var f = { __proto__: [] } instanceof Array, g = "function" === typeof Symbol, k = {}, l = {}; k[M && /Firefox\/2/i.test(M.userAgent) ? "KeyboardEvent" : "UIEvents"] = ["keyup", "keydown", "keypress"]; k.MouseEvents = "click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave".split(" "); b(k, function (a, b) { if (b.length) for (var c = 0, d = b.length; c < d; c++) l[b[c]] = a }); var m = { propertychange: !0 }, h = u && function () {
                    for (var a = 3, b = u.createElement("div"), c =
                    b.getElementsByTagName("i") ; b.innerHTML = "\x3c!--[if gt IE " + ++a + "]><i></i><![endif]--\x3e", c[0];); return 4 < a ? a : n
                }(), r = /\S+/g; return {
                    cc: ["authenticity_token", /^__RequestVerificationToken(_.*)?$/], q: function (a, b) { for (var c = 0, d = a.length; c < d; c++) b(a[c], c) }, o: function (a, b) { if ("function" == typeof Array.prototype.indexOf) return Array.prototype.indexOf.call(a, b); for (var c = 0, d = a.length; c < d; c++) if (a[c] === b) return c; return -1 }, Sb: function (a, b, c) {
                        for (var d = 0, e = a.length; d < e; d++) if (b.call(c, a[d], d)) return a[d];
                        return null
                    }, La: function (b, c) { var d = a.a.o(b, c); 0 < d ? b.splice(d, 1) : 0 === d && b.shift() }, Tb: function (b) { b = b || []; for (var c = [], d = 0, e = b.length; d < e; d++) 0 > a.a.o(c, b[d]) && c.push(b[d]); return c }, fb: function (a, b) { a = a || []; for (var c = [], d = 0, e = a.length; d < e; d++) c.push(b(a[d], d)); return c }, Ka: function (a, b) { a = a || []; for (var c = [], d = 0, e = a.length; d < e; d++) b(a[d], d) && c.push(a[d]); return c }, ra: function (a, b) { if (b instanceof Array) a.push.apply(a, b); else for (var c = 0, d = b.length; c < d; c++) a.push(b[c]); return a }, pa: function (b, c, d) {
                        var e =
                        a.a.o(a.a.zb(b), c); 0 > e ? d && b.push(c) : d || b.splice(e, 1)
                    }, ka: f, extend: c, Xa: d, Ya: f ? d : c, D: b, Ca: function (a, b) { if (!a) return a; var c = {}, d; for (d in a) a.hasOwnProperty(d) && (c[d] = b(a[d], d, a)); return c }, ob: function (b) { for (; b.firstChild;) a.removeNode(b.firstChild) }, jc: function (b) { b = a.a.V(b); for (var c = (b[0] && b[0].ownerDocument || u).createElement("div"), d = 0, e = b.length; d < e; d++) c.appendChild(a.$(b[d])); return c }, ua: function (b, c) { for (var d = 0, e = b.length, h = []; d < e; d++) { var m = b[d].cloneNode(!0); h.push(c ? a.$(m) : m) } return h },
                    da: function (b, c) { a.a.ob(b); if (c) for (var d = 0, e = c.length; d < e; d++) b.appendChild(c[d]) }, qc: function (b, c) { var d = b.nodeType ? [b] : b; if (0 < d.length) { for (var e = d[0], h = e.parentNode, m = 0, l = c.length; m < l; m++) h.insertBefore(c[m], e); m = 0; for (l = d.length; m < l; m++) a.removeNode(d[m]) } }, za: function (a, b) {
                        if (a.length) {
                            for (b = 8 === b.nodeType && b.parentNode || b; a.length && a[0].parentNode !== b;) a.splice(0, 1); for (; 1 < a.length && a[a.length - 1].parentNode !== b;) a.length--; if (1 < a.length) {
                                var c = a[0], d = a[a.length - 1]; for (a.length = 0; c !== d;) a.push(c),
                                c = c.nextSibling; a.push(d)
                            }
                        } return a
                    }, sc: function (a, b) { 7 > h ? a.setAttribute("selected", b) : a.selected = b }, $a: function (a) { return null === a || a === n ? "" : a.trim ? a.trim() : a.toString().replace(/^[\s\xa0]+|[\s\xa0]+$/g, "") }, nd: function (a, b) { a = a || ""; return b.length > a.length ? !1 : a.substring(0, b.length) === b }, Mc: function (a, b) {
                        if (a === b) return !0; if (11 === a.nodeType) return !1; if (b.contains) return b.contains(3 === a.nodeType ? a.parentNode : a); if (b.compareDocumentPosition) return 16 == (b.compareDocumentPosition(a) & 16); for (; a && a !=
                        b;) a = a.parentNode; return !!a
                    }, nb: function (b) { return a.a.Mc(b, b.ownerDocument.documentElement) }, Qb: function (b) { return !!a.a.Sb(b, a.a.nb) }, A: function (a) { return a && a.tagName && a.tagName.toLowerCase() }, Wb: function (b) { return a.onError ? function () { try { return b.apply(this, arguments) } catch (c) { throw a.onError && a.onError(c), c; } } : b }, setTimeout: function (b, c) { return setTimeout(a.a.Wb(b), c) }, $b: function (b) { setTimeout(function () { a.onError && a.onError(b); throw b; }, 0) }, p: function (b, c, d) {
                        var e = a.a.Wb(d); d = h && m[c]; if (a.options.useOnlyNativeEvents ||
                        d || !v) if (d || "function" != typeof b.addEventListener) if ("undefined" != typeof b.attachEvent) { var l = function (a) { e.call(b, a) }, f = "on" + c; b.attachEvent(f, l); a.a.F.oa(b, function () { b.detachEvent(f, l) }) } else throw Error("Browser doesn't support addEventListener or attachEvent"); else b.addEventListener(c, e, !1); else v(b).bind(c, e)
                    }, Da: function (b, c) {
                        if (!b || !b.nodeType) throw Error("element must be a DOM node when calling triggerEvent"); var d; "input" === a.a.A(b) && b.type && "click" == c.toLowerCase() ? (d = b.type, d = "checkbox" ==
                        d || "radio" == d) : d = !1; if (a.options.useOnlyNativeEvents || !v || d) if ("function" == typeof u.createEvent) if ("function" == typeof b.dispatchEvent) d = u.createEvent(l[c] || "HTMLEvents"), d.initEvent(c, !0, !0, x, 0, 0, 0, 0, 0, !1, !1, !1, !1, 0, b), b.dispatchEvent(d); else throw Error("The supplied element doesn't support dispatchEvent"); else if (d && b.click) b.click(); else if ("undefined" != typeof b.fireEvent) b.fireEvent("on" + c); else throw Error("Browser doesn't support triggering events"); else v(b).trigger(c)
                    }, c: function (b) {
                        return a.H(b) ?
                        b() : b
                    }, zb: function (b) { return a.H(b) ? b.t() : b }, bb: function (b, c, d) { var h; c && ("object" === typeof b.classList ? (h = b.classList[d ? "add" : "remove"], a.a.q(c.match(r), function (a) { h.call(b.classList, a) })) : "string" === typeof b.className.baseVal ? e(b.className, "baseVal", c, d) : e(b, "className", c, d)) }, Za: function (b, c) { var d = a.a.c(c); if (null === d || d === n) d = ""; var e = a.f.firstChild(b); !e || 3 != e.nodeType || a.f.nextSibling(e) ? a.f.da(b, [b.ownerDocument.createTextNode(d)]) : e.data = d; a.a.Rc(b) }, rc: function (a, b) {
                        a.name = b; if (7 >= h) try {
                            a.mergeAttributes(u.createElement("<input name='" +
                            a.name + "'/>"), !1)
                        } catch (c) { }
                    }, Rc: function (a) { 9 <= h && (a = 1 == a.nodeType ? a : a.parentNode, a.style && (a.style.zoom = a.style.zoom)) }, Nc: function (a) { if (h) { var b = a.style.width; a.style.width = 0; a.style.width = b } }, hd: function (b, c) { b = a.a.c(b); c = a.a.c(c); for (var d = [], e = b; e <= c; e++) d.push(e); return d }, V: function (a) { for (var b = [], c = 0, d = a.length; c < d; c++) b.push(a[c]); return b }, Yb: function (a) { return g ? Symbol(a) : a }, rd: 6 === h, sd: 7 === h, C: h, ec: function (b, c) {
                        for (var d = a.a.V(b.getElementsByTagName("input")).concat(a.a.V(b.getElementsByTagName("textarea"))),
                        e = "string" == typeof c ? function (a) { return a.name === c } : function (a) { return c.test(a.name) }, h = [], m = d.length - 1; 0 <= m; m--) e(d[m]) && h.push(d[m]); return h
                    }, ed: function (b) { return "string" == typeof b && (b = a.a.$a(b)) ? F && F.parse ? F.parse(b) : (new Function("return " + b))() : null }, Eb: function (b, c, d) {
                        if (!F || !F.stringify) throw Error("Cannot find JSON.stringify(). Some browsers (e.g., IE < 8) don't support it natively, but you can overcome this by adding a script reference to json2.js, downloadable from http://www.json.org/json2.js");
                        return F.stringify(a.a.c(b), c, d)
                    }, fd: function (c, d, e) {
                        e = e || {}; var h = e.params || {}, m = e.includeFields || this.cc, l = c; if ("object" == typeof c && "form" === a.a.A(c)) for (var l = c.action, f = m.length - 1; 0 <= f; f--) for (var g = a.a.ec(c, m[f]), k = g.length - 1; 0 <= k; k--) h[g[k].name] = g[k].value; d = a.a.c(d); var r = u.createElement("form"); r.style.display = "none"; r.action = l; r.method = "post"; for (var n in d) c = u.createElement("input"), c.type = "hidden", c.name = n, c.value = a.a.Eb(a.a.c(d[n])), r.appendChild(c); b(h, function (a, b) {
                            var c = u.createElement("input");
                            c.type = "hidden"; c.name = a; c.value = b; r.appendChild(c)
                        }); u.body.appendChild(r); e.submitter ? e.submitter(r) : r.submit(); setTimeout(function () { r.parentNode.removeChild(r) }, 0)
                    }
                }
            }(); a.b("utils", a.a); a.b("utils.arrayForEach", a.a.q); a.b("utils.arrayFirst", a.a.Sb); a.b("utils.arrayFilter", a.a.Ka); a.b("utils.arrayGetDistinctValues", a.a.Tb); a.b("utils.arrayIndexOf", a.a.o); a.b("utils.arrayMap", a.a.fb); a.b("utils.arrayPushAll", a.a.ra); a.b("utils.arrayRemoveItem", a.a.La); a.b("utils.extend", a.a.extend); a.b("utils.fieldsIncludedWithJsonPost",
            a.a.cc); a.b("utils.getFormFields", a.a.ec); a.b("utils.peekObservable", a.a.zb); a.b("utils.postJson", a.a.fd); a.b("utils.parseJson", a.a.ed); a.b("utils.registerEventHandler", a.a.p); a.b("utils.stringifyJson", a.a.Eb); a.b("utils.range", a.a.hd); a.b("utils.toggleDomNodeCssClass", a.a.bb); a.b("utils.triggerEvent", a.a.Da); a.b("utils.unwrapObservable", a.a.c); a.b("utils.objectForEach", a.a.D); a.b("utils.addOrRemoveItem", a.a.pa); a.b("utils.setTextContent", a.a.Za); a.b("unwrap", a.a.c); Function.prototype.bind || (Function.prototype.bind =
            function (a) { var c = this; if (1 === arguments.length) return function () { return c.apply(a, arguments) }; var d = Array.prototype.slice.call(arguments, 1); return function () { var e = d.slice(0); e.push.apply(e, arguments); return c.apply(a, e) } }); a.a.e = new function () {
                function a(b, g) { var k = b[d]; if (!k || "null" === k || !e[k]) { if (!g) return n; k = b[d] = "ko" + c++; e[k] = {} } return e[k] } var c = 0, d = "__ko__" + (new Date).getTime(), e = {}; return {
                    get: function (c, d) { var e = a(c, !1); return e === n ? n : e[d] }, set: function (c, d, e) {
                        if (e !== n || a(c, !1) !== n) a(c, !0)[d] =
                        e
                    }, clear: function (a) { var b = a[d]; return b ? (delete e[b], a[d] = null, !0) : !1 }, I: function () { return c++ + d }
                }
            }; a.b("utils.domData", a.a.e); a.b("utils.domData.clear", a.a.e.clear); a.a.F = new function () {
                function b(b, c) { var e = a.a.e.get(b, d); e === n && c && (e = [], a.a.e.set(b, d, e)); return e } function c(d) { var e = b(d, !1); if (e) for (var e = e.slice(0), l = 0; l < e.length; l++) e[l](d); a.a.e.clear(d); a.a.F.cleanExternalData(d); if (f[d.nodeType]) for (e = d.firstChild; d = e;) e = d.nextSibling, 8 === d.nodeType && c(d) } var d = a.a.e.I(), e = { 1: !0, 8: !0, 9: !0 },
                f = { 1: !0, 9: !0 }; return { oa: function (a, c) { if ("function" != typeof c) throw Error("Callback must be a function"); b(a, !0).push(c) }, pc: function (c, e) { var l = b(c, !1); l && (a.a.La(l, e), 0 == l.length && a.a.e.set(c, d, n)) }, $: function (b) { if (e[b.nodeType] && (c(b), f[b.nodeType])) { var d = []; a.a.ra(d, b.getElementsByTagName("*")); for (var l = 0, m = d.length; l < m; l++) c(d[l]) } return b }, removeNode: function (b) { a.$(b); b.parentNode && b.parentNode.removeChild(b) }, cleanExternalData: function (a) { v && "function" == typeof v.cleanData && v.cleanData([a]) } }
            };
            a.$ = a.a.F.$; a.removeNode = a.a.F.removeNode; a.b("cleanNode", a.$); a.b("removeNode", a.removeNode); a.b("utils.domNodeDisposal", a.a.F); a.b("utils.domNodeDisposal.addDisposeCallback", a.a.F.oa); a.b("utils.domNodeDisposal.removeDisposeCallback", a.a.F.pc); (function () {
                var b = [0, "", ""], c = [1, "<table>", "</table>"], d = [3, "<table><tbody><tr>", "</tr></tbody></table>"], e = [1, "<select multiple='multiple'>", "</select>"], f = { thead: c, tbody: c, tfoot: c, tr: [2, "<table><tbody>", "</tbody></table>"], td: d, th: d, option: e, optgroup: e },
                g = 8 >= a.a.C; a.a.ma = function (c, d) {
                    var e; if (v) if (v.parseHTML) e = v.parseHTML(c, d) || []; else { if ((e = v.clean([c], d)) && e[0]) { for (var h = e[0]; h.parentNode && 11 !== h.parentNode.nodeType;) h = h.parentNode; h.parentNode && h.parentNode.removeChild(h) } } else {
                        (e = d) || (e = u); var h = e.parentWindow || e.defaultView || x, r = a.a.$a(c).toLowerCase(), q = e.createElement("div"), p; p = (r = r.match(/^<([a-z]+)[ >]/)) && f[r[1]] || b; r = p[0]; p = "ignored<div>" + p[1] + c + p[2] + "</div>"; "function" == typeof h.innerShiv ? q.appendChild(h.innerShiv(p)) : (g && e.appendChild(q),
                        q.innerHTML = p, g && q.parentNode.removeChild(q)); for (; r--;) q = q.lastChild; e = a.a.V(q.lastChild.childNodes)
                    } return e
                }; a.a.Cb = function (b, c) { a.a.ob(b); c = a.a.c(c); if (null !== c && c !== n) if ("string" != typeof c && (c = c.toString()), v) v(b).html(c); else for (var d = a.a.ma(c, b.ownerDocument), e = 0; e < d.length; e++) b.appendChild(d[e]) }
            })(); a.b("utils.parseHtmlFragment", a.a.ma); a.b("utils.setHtml", a.a.Cb); a.M = function () {
                function b(c, e) {
                    if (c) if (8 == c.nodeType) { var f = a.M.lc(c.nodeValue); null != f && e.push({ Lc: c, cd: f }) } else if (1 == c.nodeType) for (var f =
                    0, g = c.childNodes, k = g.length; f < k; f++) b(g[f], e)
                } var c = {}; return {
                    wb: function (a) { if ("function" != typeof a) throw Error("You can only pass a function to ko.memoization.memoize()"); var b = (4294967296 * (1 + Math.random()) | 0).toString(16).substring(1) + (4294967296 * (1 + Math.random()) | 0).toString(16).substring(1); c[b] = a; return "\x3c!--[ko_memo:" + b + "]--\x3e" }, xc: function (a, b) {
                        var f = c[a]; if (f === n) throw Error("Couldn't find any memo with ID " + a + ". Perhaps it's already been unmemoized."); try {
                            return f.apply(null, b || []),
                            !0
                        } finally { delete c[a] }
                    }, yc: function (c, e) { var f = []; b(c, f); for (var g = 0, k = f.length; g < k; g++) { var l = f[g].Lc, m = [l]; e && a.a.ra(m, e); a.M.xc(f[g].cd, m); l.nodeValue = ""; l.parentNode && l.parentNode.removeChild(l) } }, lc: function (a) { return (a = a.match(/^\[ko_memo\:(.*?)\]$/)) ? a[1] : null }
                }
            }(); a.b("memoization", a.M); a.b("memoization.memoize", a.M.wb); a.b("memoization.unmemoize", a.M.xc); a.b("memoization.parseMemoText", a.M.lc); a.b("memoization.unmemoizeDomNodeAndDescendants", a.M.yc); a.Y = function () {
                function b() {
                    if (e) for (var b =
                    e, c = 0, m; g < e;) if (m = d[g++]) { if (g > b) { if (5E3 <= ++c) { g = e; a.a.$b(Error("'Too much recursion' after processing " + c + " task groups.")); break } b = e } try { m() } catch (h) { a.a.$b(h) } }
                } function c() { b(); g = e = d.length = 0 } var d = [], e = 0, f = 1, g = 0; return {
                    scheduler: x.MutationObserver ? function (a) { var b = u.createElement("div"); (new MutationObserver(a)).observe(b, { attributes: !0 }); return function () { b.classList.toggle("foo") } }(c) : u && "onreadystatechange" in u.createElement("script") ? function (a) {
                        var b = u.createElement("script"); b.onreadystatechange =
                        function () { b.onreadystatechange = null; u.documentElement.removeChild(b); b = null; a() }; u.documentElement.appendChild(b)
                    } : function (a) { setTimeout(a, 0) }, Wa: function (b) { e || a.Y.scheduler(c); d[e++] = b; return f++ }, cancel: function (a) { a -= f - e; a >= g && a < e && (d[a] = null) }, resetForTesting: function () { var a = e - g; g = e = d.length = 0; return a }, md: b
                }
            }(); a.b("tasks", a.Y); a.b("tasks.schedule", a.Y.Wa); a.b("tasks.runEarly", a.Y.md); a.ya = {
                throttle: function (b, c) {
                    b.throttleEvaluation = c; var d = null; return a.B({
                        read: b, write: function (e) {
                            clearTimeout(d);
                            d = a.a.setTimeout(function () { b(e) }, c)
                        }
                    })
                }, rateLimit: function (a, c) { var d, e, f; "number" == typeof c ? d = c : (d = c.timeout, e = c.method); a.cb = !1; f = "notifyWhenChangesStop" == e ? V : U; a.Ta(function (a) { return f(a, d) }) }, deferred: function (b, c) { if (!0 !== c) throw Error("The 'deferred' extender only accepts the value 'true', because it is not supported to turn deferral off once enabled."); b.cb || (b.cb = !0, b.Ta(function (c) { var e; return function () { a.Y.cancel(e); e = a.Y.Wa(c); b.notifySubscribers(n, "dirty") } })) }, notify: function (a, c) {
                    a.equalityComparer =
                    "always" == c ? null : J
                }
            }; var T = { undefined: 1, "boolean": 1, number: 1, string: 1 }; a.b("extenders", a.ya); a.vc = function (b, c, d) { this.ia = b; this.gb = c; this.Kc = d; this.R = !1; a.G(this, "dispose", this.k) }; a.vc.prototype.k = function () { this.R = !0; this.Kc() }; a.J = function () { a.a.Ya(this, D); D.rb(this) }; var I = "change", D = {
                rb: function (a) { a.K = {}; a.Nb = 1 }, X: function (b, c, d) { var e = this; d = d || I; var f = new a.vc(e, c ? b.bind(c) : b, function () { a.a.La(e.K[d], f); e.Ia && e.Ia(d) }); e.sa && e.sa(d); e.K[d] || (e.K[d] = []); e.K[d].push(f); return f }, notifySubscribers: function (b,
                c) { c = c || I; c === I && this.zc(); if (this.Pa(c)) try { a.l.Ub(); for (var d = this.K[c].slice(0), e = 0, f; f = d[e]; ++e) f.R || f.gb(b) } finally { a.l.end() } }, Na: function () { return this.Nb }, Uc: function (a) { return this.Na() !== a }, zc: function () { ++this.Nb }, Ta: function (b) { var c = this, d = a.H(c), e, f, g; c.Ha || (c.Ha = c.notifySubscribers, c.notifySubscribers = W); var k = b(function () { c.Mb = !1; d && g === c && (g = c()); e = !1; c.tb(f, g) && c.Ha(f = g) }); c.Lb = function (a) { c.Mb = e = !0; g = a; k() }; c.Kb = function (a) { e || (f = a, c.Ha(a, "beforeChange")) } }, Pa: function (a) {
                    return this.K[a] &&
                    this.K[a].length
                }, Sc: function (b) { if (b) return this.K[b] && this.K[b].length || 0; var c = 0; a.a.D(this.K, function (a, b) { "dirty" !== a && (c += b.length) }); return c }, tb: function (a, c) { return !this.equalityComparer || !this.equalityComparer(a, c) }, extend: function (b) { var c = this; b && a.a.D(b, function (b, e) { var f = a.ya[b]; "function" == typeof f && (c = f(c, e) || c) }); return c }
            }; a.G(D, "subscribe", D.X); a.G(D, "extend", D.extend); a.G(D, "getSubscriptionsCount", D.Sc); a.a.ka && a.a.Xa(D, Function.prototype); a.J.fn = D; a.hc = function (a) {
                return null !=
                a && "function" == typeof a.X && "function" == typeof a.notifySubscribers
            }; a.b("subscribable", a.J); a.b("isSubscribable", a.hc); a.va = a.l = function () { function b(a) { d.push(e); e = a } function c() { e = d.pop() } var d = [], e, f = 0; return { Ub: b, end: c, oc: function (b) { if (e) { if (!a.hc(b)) throw Error("Only subscribable things can act as dependencies"); e.gb.call(e.Gc, b, b.Cc || (b.Cc = ++f)) } }, w: function (a, d, e) { try { return b(), a.apply(d, e || []) } finally { c() } }, Aa: function () { if (e) return e.m.Aa() }, Sa: function () { if (e) return e.Sa } } }(); a.b("computedContext",
            a.va); a.b("computedContext.getDependenciesCount", a.va.Aa); a.b("computedContext.isInitial", a.va.Sa); a.b("ignoreDependencies", a.qd = a.l.w); var E = a.a.Yb("_latestValue"); a.N = function (b) { function c() { if (0 < arguments.length) return c.tb(c[E], arguments[0]) && (c.ga(), c[E] = arguments[0], c.fa()), this; a.l.oc(c); return c[E] } c[E] = b; a.a.ka || a.a.extend(c, a.J.fn); a.J.fn.rb(c); a.a.Ya(c, B); a.options.deferUpdates && a.ya.deferred(c, !0); return c }; var B = {
                equalityComparer: J, t: function () { return this[E] }, fa: function () { this.notifySubscribers(this[E]) },
                ga: function () { this.notifySubscribers(this[E], "beforeChange") }
            }; a.a.ka && a.a.Xa(B, a.J.fn); var H = a.N.gd = "__ko_proto__"; B[H] = a.N; a.Oa = function (b, c) { return null === b || b === n || b[H] === n ? !1 : b[H] === c ? !0 : a.Oa(b[H], c) }; a.H = function (b) { return a.Oa(b, a.N) }; a.Ba = function (b) { return "function" == typeof b && b[H] === a.N || "function" == typeof b && b[H] === a.B && b.Vc ? !0 : !1 }; a.b("observable", a.N); a.b("isObservable", a.H); a.b("isWriteableObservable", a.Ba); a.b("isWritableObservable", a.Ba); a.b("observable.fn", B); a.G(B, "peek", B.t); a.G(B,
            "valueHasMutated", B.fa); a.G(B, "valueWillMutate", B.ga); a.la = function (b) { b = b || []; if ("object" != typeof b || !("length" in b)) throw Error("The argument passed when initializing an observable array must be an array, or null, or undefined."); b = a.N(b); a.a.Ya(b, a.la.fn); return b.extend({ trackArrayChanges: !0 }) }; a.la.fn = {
                remove: function (b) {
                    for (var c = this.t(), d = [], e = "function" != typeof b || a.H(b) ? function (a) { return a === b } : b, f = 0; f < c.length; f++) { var g = c[f]; e(g) && (0 === d.length && this.ga(), d.push(g), c.splice(f, 1), f--) } d.length &&
                    this.fa(); return d
                }, removeAll: function (b) { if (b === n) { var c = this.t(), d = c.slice(0); this.ga(); c.splice(0, c.length); this.fa(); return d } return b ? this.remove(function (c) { return 0 <= a.a.o(b, c) }) : [] }, destroy: function (b) { var c = this.t(), d = "function" != typeof b || a.H(b) ? function (a) { return a === b } : b; this.ga(); for (var e = c.length - 1; 0 <= e; e--) d(c[e]) && (c[e]._destroy = !0); this.fa() }, destroyAll: function (b) { return b === n ? this.destroy(function () { return !0 }) : b ? this.destroy(function (c) { return 0 <= a.a.o(b, c) }) : [] }, indexOf: function (b) {
                    var c =
                    this(); return a.a.o(c, b)
                }, replace: function (a, c) { var d = this.indexOf(a); 0 <= d && (this.ga(), this.t()[d] = c, this.fa()) }
            }; a.a.ka && a.a.Xa(a.la.fn, a.N.fn); a.a.q("pop push reverse shift sort splice unshift".split(" "), function (b) { a.la.fn[b] = function () { var a = this.t(); this.ga(); this.Vb(a, b, arguments); var d = a[b].apply(a, arguments); this.fa(); return d === a ? this : d } }); a.a.q(["slice"], function (b) { a.la.fn[b] = function () { var a = this(); return a[b].apply(a, arguments) } }); a.b("observableArray", a.la); a.ya.trackArrayChanges = function (b,
            c) {
                function d() { if (!e) { e = !0; var c = b.notifySubscribers; b.notifySubscribers = function (a, b) { b && b !== I || ++k; return c.apply(this, arguments) }; var d = [].concat(b.t() || []); f = null; g = b.X(function (c) { c = [].concat(c || []); if (b.Pa("arrayChange")) { var e; if (!f || 1 < k) f = a.a.ib(d, c, b.hb); e = f } d = c; f = null; k = 0; e && e.length && b.notifySubscribers(e, "arrayChange") }) } } b.hb = {}; c && "object" == typeof c && a.a.extend(b.hb, c); b.hb.sparse = !0; if (!b.Vb) {
                    var e = !1, f = null, g, k = 0, l = b.sa, m = b.Ia; b.sa = function (a) { l && l.call(b, a); "arrayChange" === a && d() };
                    b.Ia = function (a) { m && m.call(b, a); "arrayChange" !== a || b.Pa("arrayChange") || (g.k(), e = !1) }; b.Vb = function (b, c, d) {
                        function m(a, b, c) { return l[l.length] = { status: a, value: b, index: c } } if (e && !k) {
                            var l = [], g = b.length, t = d.length, G = 0; switch (c) {
                                case "push": G = g; case "unshift": for (c = 0; c < t; c++) m("added", d[c], G + c); break; case "pop": G = g - 1; case "shift": g && m("deleted", b[G], G); break; case "splice": c = Math.min(Math.max(0, 0 > d[0] ? g + d[0] : d[0]), g); for (var g = 1 === t ? g : Math.min(c + (d[1] || 0), g), t = c + t - 2, G = Math.max(g, t), P = [], n = [], Q = 2; c < G; ++c,
                                ++Q) c < g && n.push(m("deleted", b[c], c)), c < t && P.push(m("added", d[Q], c)); a.a.dc(n, P); break; default: return
                            } f = l
                        }
                    }
                }
            }; var s = a.a.Yb("_state"); a.m = a.B = function (b, c, d) {
                function e() { if (0 < arguments.length) { if ("function" === typeof f) f.apply(g.pb, arguments); else throw Error("Cannot write a value to a ko.computed unless you specify a 'write' option. If you wish to read the current value, don't pass any parameters."); return this } a.l.oc(e); (g.S || g.s && e.Qa()) && e.aa(); return g.T } "object" === typeof b ? d = b : (d = d || {}, b && (d.read =
                b)); if ("function" != typeof d.read) throw Error("Pass a function that returns the value of the ko.computed"); var f = d.write, g = { T: n, S: !0, Ra: !1, Fb: !1, R: !1, Va: !1, s: !1, jd: d.read, pb: c || d.owner, i: d.disposeWhenNodeIsRemoved || d.i || null, wa: d.disposeWhen || d.wa, mb: null, r: {}, L: 0, bc: null }; e[s] = g; e.Vc = "function" === typeof f; a.a.ka || a.a.extend(e, a.J.fn); a.J.fn.rb(e); a.a.Ya(e, z); d.pure ? (g.Va = !0, g.s = !0, a.a.extend(e, $)) : d.deferEvaluation && a.a.extend(e, aa); a.options.deferUpdates && a.ya.deferred(e, !0); g.i && (g.Fb = !0, g.i.nodeType ||
                (g.i = null)); g.s || d.deferEvaluation || e.aa(); g.i && e.ba() && a.a.F.oa(g.i, g.mb = function () { e.k() }); return e
            }; var z = {
                equalityComparer: J, Aa: function () { return this[s].L }, Pb: function (a, c, d) { if (this[s].Va && c === this) throw Error("A 'pure' computed must not be called recursively"); this[s].r[a] = d; d.Ga = this[s].L++; d.na = c.Na() }, Qa: function () { var a, c, d = this[s].r; for (a in d) if (d.hasOwnProperty(a) && (c = d[a], c.ia.Uc(c.na))) return !0 }, bd: function () { this.Fa && !this[s].Ra && this.Fa() }, ba: function () { return this[s].S || 0 < this[s].L },
                ld: function () { this.Mb || this.ac() }, uc: function (a) { if (a.cb && !this[s].i) { var c = a.X(this.bd, this, "dirty"), d = a.X(this.ld, this); return { ia: a, k: function () { c.k(); d.k() } } } return a.X(this.ac, this) }, ac: function () { var b = this, c = b.throttleEvaluation; c && 0 <= c ? (clearTimeout(this[s].bc), this[s].bc = a.a.setTimeout(function () { b.aa(!0) }, c)) : b.Fa ? b.Fa() : b.aa(!0) }, aa: function (b) {
                    var c = this[s], d = c.wa; if (!c.Ra && !c.R) {
                        if (c.i && !a.a.nb(c.i) || d && d()) { if (!c.Fb) { this.k(); return } } else c.Fb = !1; c.Ra = !0; try { this.Qc(b) } finally { c.Ra = !1 } c.L ||
                        this.k()
                    }
                }, Qc: function (b) { var c = this[s], d = c.Va ? n : !c.L, e = { Hc: this, Ma: c.r, lb: c.L }; a.l.Ub({ Gc: e, gb: Y, m: this, Sa: d }); c.r = {}; c.L = 0; e = this.Pc(c, e); this.tb(c.T, e) && (c.s || this.notifySubscribers(c.T, "beforeChange"), c.T = e, c.s ? this.zc() : b && this.notifySubscribers(c.T)); d && this.notifySubscribers(c.T, "awake") }, Pc: function (b, c) { try { var d = b.jd; return b.pb ? d.call(b.pb) : d() } finally { a.l.end(), c.lb && !b.s && a.a.D(c.Ma, X), b.S = !1 } }, t: function () { var a = this[s]; (a.S && !a.L || a.s && this.Qa()) && this.aa(); return a.T }, Ta: function (b) {
                    a.J.fn.Ta.call(this,
                    b); this.Fa = function () { this.Kb(this[s].T); this[s].S = !0; this.Lb(this) }
                }, k: function () { var b = this[s]; !b.s && b.r && a.a.D(b.r, function (a, b) { b.k && b.k() }); b.i && b.mb && a.a.F.pc(b.i, b.mb); b.r = null; b.L = 0; b.R = !0; b.S = !1; b.s = !1; b.i = null }
            }, $ = {
                sa: function (b) { var c = this, d = c[s]; if (!d.R && d.s && "change" == b) { d.s = !1; if (d.S || c.Qa()) d.r = null, d.L = 0, d.S = !0, c.aa(); else { var e = []; a.a.D(d.r, function (a, b) { e[b.Ga] = a }); a.a.q(e, function (a, b) { var e = d.r[a], l = c.uc(e.ia); l.Ga = b; l.na = e.na; d.r[a] = l }) } d.R || c.notifySubscribers(d.T, "awake") } },
                Ia: function (b) { var c = this[s]; c.R || "change" != b || this.Pa("change") || (a.a.D(c.r, function (a, b) { b.k && (c.r[a] = { ia: b.ia, Ga: b.Ga, na: b.na }, b.k()) }), c.s = !0, this.notifySubscribers(n, "asleep")) }, Na: function () { var b = this[s]; b.s && (b.S || this.Qa()) && this.aa(); return a.J.fn.Na.call(this) }
            }, aa = { sa: function (a) { "change" != a && "beforeChange" != a || this.t() } }; a.a.ka && a.a.Xa(z, a.J.fn); var R = a.N.gd; a.m[R] = a.N; z[R] = a.m; a.Xc = function (b) { return a.Oa(b, a.m) }; a.Yc = function (b) { return a.Oa(b, a.m) && b[s] && b[s].Va }; a.b("computed", a.m);
            a.b("dependentObservable", a.m); a.b("isComputed", a.Xc); a.b("isPureComputed", a.Yc); a.b("computed.fn", z); a.G(z, "peek", z.t); a.G(z, "dispose", z.k); a.G(z, "isActive", z.ba); a.G(z, "getDependenciesCount", z.Aa); a.nc = function (b, c) { if ("function" === typeof b) return a.m(b, c, { pure: !0 }); b = a.a.extend({}, b); b.pure = !0; return a.m(b, c) }; a.b("pureComputed", a.nc); (function () {
                function b(a, f, g) {
                    g = g || new d; a = f(a); if ("object" != typeof a || null === a || a === n || a instanceof RegExp || a instanceof Date || a instanceof String || a instanceof
                    Number || a instanceof Boolean) return a; var k = a instanceof Array ? [] : {}; g.save(a, k); c(a, function (c) { var d = f(a[c]); switch (typeof d) { case "boolean": case "number": case "string": case "function": k[c] = d; break; case "object": case "undefined": var h = g.get(d); k[c] = h !== n ? h : b(d, f, g) } }); return k
                } function c(a, b) { if (a instanceof Array) { for (var c = 0; c < a.length; c++) b(c); "function" == typeof a.toJSON && b("toJSON") } else for (c in a) b(c) } function d() { this.keys = []; this.Ib = [] } a.wc = function (c) {
                    if (0 == arguments.length) throw Error("When calling ko.toJS, pass the object you want to convert.");
                    return b(c, function (b) { for (var c = 0; a.H(b) && 10 > c; c++) b = b(); return b })
                }; a.toJSON = function (b, c, d) { b = a.wc(b); return a.a.Eb(b, c, d) }; d.prototype = { save: function (b, c) { var d = a.a.o(this.keys, b); 0 <= d ? this.Ib[d] = c : (this.keys.push(b), this.Ib.push(c)) }, get: function (b) { b = a.a.o(this.keys, b); return 0 <= b ? this.Ib[b] : n } }
            })(); a.b("toJS", a.wc); a.b("toJSON", a.toJSON); (function () {
                a.j = {
                    u: function (b) {
                        switch (a.a.A(b)) {
                            case "option": return !0 === b.__ko__hasDomDataOptionValue__ ? a.a.e.get(b, a.d.options.xb) : 7 >= a.a.C ? b.getAttributeNode("value") &&
                            b.getAttributeNode("value").specified ? b.value : b.text : b.value; case "select": return 0 <= b.selectedIndex ? a.j.u(b.options[b.selectedIndex]) : n; default: return b.value
                        }
                    }, ha: function (b, c, d) {
                        switch (a.a.A(b)) {
                            case "option": switch (typeof c) { case "string": a.a.e.set(b, a.d.options.xb, n); "__ko__hasDomDataOptionValue__" in b && delete b.__ko__hasDomDataOptionValue__; b.value = c; break; default: a.a.e.set(b, a.d.options.xb, c), b.__ko__hasDomDataOptionValue__ = !0, b.value = "number" === typeof c ? c : "" } break; case "select": if ("" === c ||
                            null === c) c = n; for (var e = -1, f = 0, g = b.options.length, k; f < g; ++f) if (k = a.j.u(b.options[f]), k == c || "" == k && c === n) { e = f; break } if (d || 0 <= e || c === n && 1 < b.size) b.selectedIndex = e; break; default: if (null === c || c === n) c = ""; b.value = c
                        }
                    }
                }
            })(); a.b("selectExtensions", a.j); a.b("selectExtensions.readValue", a.j.u); a.b("selectExtensions.writeValue", a.j.ha); a.h = function () {
                function b(b) {
                    b = a.a.$a(b); 123 === b.charCodeAt(0) && (b = b.slice(1, -1)); var c = [], d = b.match(e), r, k = [], p = 0; if (d) {
                        d.push(","); for (var A = 0, y; y = d[A]; ++A) {
                            var t = y.charCodeAt(0);
                            if (44 === t) { if (0 >= p) { c.push(r && k.length ? { key: r, value: k.join("") } : { unknown: r || k.join("") }); r = p = 0; k = []; continue } } else if (58 === t) { if (!p && !r && 1 === k.length) { r = k.pop(); continue } } else 47 === t && A && 1 < y.length ? (t = d[A - 1].match(f)) && !g[t[0]] && (b = b.substr(b.indexOf(y) + 1), d = b.match(e), d.push(","), A = -1, y = "/") : 40 === t || 123 === t || 91 === t ? ++p : 41 === t || 125 === t || 93 === t ? --p : r || k.length || 34 !== t && 39 !== t || (y = y.slice(1, -1)); k.push(y)
                        }
                    } return c
                } var c = ["true", "false", "null", "undefined"], d = /^(?:[$_a-z][$\w]*|(.+)(\.\s*[$_a-z][$\w]*|\[.+\]))$/i,
                e = RegExp("\"(?:[^\"\\\\]|\\\\.)*\"|'(?:[^'\\\\]|\\\\.)*'|/(?:[^/\\\\]|\\\\.)*/w*|[^\\s:,/][^,\"'{}()/:[\\]]*[^\\s,\"'{}()/:[\\]]|[^\\s]", "g"), f = /[\])"'A-Za-z0-9_$]+$/, g = { "in": 1, "return": 1, "typeof": 1 }, k = {}; return {
                    ta: [], ea: k, yb: b, Ua: function (e, m) {
                        function h(b, e) {
                            var m; if (!A) { var l = a.getBindingHandler(b); if (l && l.preprocess && !(e = l.preprocess(e, b, h))) return; if (l = k[b]) m = e, 0 <= a.a.o(c, m) ? m = !1 : (l = m.match(d), m = null === l ? !1 : l[1] ? "Object(" + l[1] + ")" + l[2] : m), l = m; l && g.push("'" + b + "':function(_z){" + m + "=_z}") } p && (e =
                            "function(){return " + e + " }"); f.push("'" + b + "':" + e)
                        } m = m || {}; var f = [], g = [], p = m.valueAccessors, A = m.bindingParams, y = "string" === typeof e ? b(e) : e; a.a.q(y, function (a) { h(a.key || a.unknown, a.value) }); g.length && h("_ko_property_writers", "{" + g.join(",") + " }"); return f.join(",")
                    }, ad: function (a, b) { for (var c = 0; c < a.length; c++) if (a[c].key == b) return !0; return !1 }, Ea: function (b, c, d, e, f) { if (b && a.H(b)) !a.Ba(b) || f && b.t() === e || b(e); else if ((b = c.get("_ko_property_writers")) && b[d]) b[d](e) }
                }
            }(); a.b("expressionRewriting", a.h); a.b("expressionRewriting.bindingRewriteValidators",
            a.h.ta); a.b("expressionRewriting.parseObjectLiteral", a.h.yb); a.b("expressionRewriting.preProcessBindings", a.h.Ua); a.b("expressionRewriting._twoWayBindings", a.h.ea); a.b("jsonExpressionRewriting", a.h); a.b("jsonExpressionRewriting.insertPropertyAccessorsIntoJson", a.h.Ua); (function () {
                function b(a) { return 8 == a.nodeType && g.test(f ? a.text : a.nodeValue) } function c(a) { return 8 == a.nodeType && k.test(f ? a.text : a.nodeValue) } function d(a, d) {
                    for (var e = a, f = 1, l = []; e = e.nextSibling;) {
                        if (c(e) && (f--, 0 === f)) return l; l.push(e);
                        b(e) && f++
                    } if (!d) throw Error("Cannot find closing comment tag to match: " + a.nodeValue); return null
                } function e(a, b) { var c = d(a, b); return c ? 0 < c.length ? c[c.length - 1].nextSibling : a.nextSibling : null } var f = u && "\x3c!--test--\x3e" === u.createComment("test").text, g = f ? /^\x3c!--\s*ko(?:\s+([\s\S]+))?\s*--\x3e$/ : /^\s*ko(?:\s+([\s\S]+))?\s*$/, k = f ? /^\x3c!--\s*\/ko\s*--\x3e$/ : /^\s*\/ko\s*$/, l = { ul: !0, ol: !0 }; a.f = {
                    Z: {}, childNodes: function (a) { return b(a) ? d(a) : a.childNodes }, xa: function (c) {
                        if (b(c)) {
                            c = a.f.childNodes(c); for (var d =
                            0, e = c.length; d < e; d++) a.removeNode(c[d])
                        } else a.a.ob(c)
                    }, da: function (c, d) { if (b(c)) { a.f.xa(c); for (var e = c.nextSibling, f = 0, l = d.length; f < l; f++) e.parentNode.insertBefore(d[f], e) } else a.a.da(c, d) }, mc: function (a, c) { b(a) ? a.parentNode.insertBefore(c, a.nextSibling) : a.firstChild ? a.insertBefore(c, a.firstChild) : a.appendChild(c) }, gc: function (c, d, e) { e ? b(c) ? c.parentNode.insertBefore(d, e.nextSibling) : e.nextSibling ? c.insertBefore(d, e.nextSibling) : c.appendChild(d) : a.f.mc(c, d) }, firstChild: function (a) {
                        return b(a) ? !a.nextSibling ||
                        c(a.nextSibling) ? null : a.nextSibling : a.firstChild
                    }, nextSibling: function (a) { b(a) && (a = e(a)); return a.nextSibling && c(a.nextSibling) ? null : a.nextSibling }, Tc: b, pd: function (a) { return (a = (f ? a.text : a.nodeValue).match(g)) ? a[1] : null }, kc: function (d) {
                        if (l[a.a.A(d)]) {
                            var h = d.firstChild; if (h) {
                                do if (1 === h.nodeType) {
                                    var f; f = h.firstChild; var g = null; if (f) { do if (g) g.push(f); else if (b(f)) { var k = e(f, !0); k ? f = k : g = [f] } else c(f) && (g = [f]); while (f = f.nextSibling) } if (f = g) for (g = h.nextSibling, k = 0; k < f.length; k++) g ? d.insertBefore(f[k],
                                    g) : d.appendChild(f[k])
                                } while (h = h.nextSibling)
                            }
                        }
                    }
                }
            })(); a.b("virtualElements", a.f); a.b("virtualElements.allowedBindings", a.f.Z); a.b("virtualElements.emptyNode", a.f.xa); a.b("virtualElements.insertAfter", a.f.gc); a.b("virtualElements.prepend", a.f.mc); a.b("virtualElements.setDomNodeChildren", a.f.da); (function () {
                a.Q = function () { this.Fc = {} }; a.a.extend(a.Q.prototype, {
                    nodeHasBindings: function (b) {
                        switch (b.nodeType) {
                            case 1: return null != b.getAttribute("data-bind") || a.g.getComponentNameForNode(b); case 8: return a.f.Tc(b);
                            default: return !1
                        }
                    }, getBindings: function (b, c) { var d = this.getBindingsString(b, c), d = d ? this.parseBindingsString(d, c, b) : null; return a.g.Ob(d, b, c, !1) }, getBindingAccessors: function (b, c) { var d = this.getBindingsString(b, c), d = d ? this.parseBindingsString(d, c, b, { valueAccessors: !0 }) : null; return a.g.Ob(d, b, c, !0) }, getBindingsString: function (b) { switch (b.nodeType) { case 1: return b.getAttribute("data-bind"); case 8: return a.f.pd(b); default: return null } }, parseBindingsString: function (b, c, d, e) {
                        try {
                            var f = this.Fc, g = b + (e && e.valueAccessors ||
                            ""), k; if (!(k = f[g])) { var l, m = "with($context){with($data||{}){return{" + a.h.Ua(b, e) + "}}}"; l = new Function("$context", "$element", m); k = f[g] = l } return k(c, d)
                        } catch (h) { throw h.message = "Unable to parse bindings.\nBindings value: " + b + "\nMessage: " + h.message, h; }
                    }
                }); a.Q.instance = new a.Q
            })(); a.b("bindingProvider", a.Q); (function () {
                function b(a) { return function () { return a } } function c(a) { return a() } function d(b) { return a.a.Ca(a.l.w(b), function (a, c) { return function () { return b()[c] } }) } function e(c, e, h) {
                    return "function" ===
                    typeof c ? d(c.bind(null, e, h)) : a.a.Ca(c, b)
                } function f(a, b) { return d(this.getBindings.bind(this, a, b)) } function g(b, c, d) { var e, h = a.f.firstChild(c), f = a.Q.instance, m = f.preprocessNode; if (m) { for (; e = h;) h = a.f.nextSibling(e), m.call(f, e); h = a.f.firstChild(c) } for (; e = h;) h = a.f.nextSibling(e), k(b, e, d) } function k(b, c, d) { var e = !0, h = 1 === c.nodeType; h && a.f.kc(c); if (h && d || a.Q.instance.nodeHasBindings(c)) e = m(c, null, b, d).shouldBindDescendants; e && !r[a.a.A(c)] && g(b, c, !h) } function l(b) {
                    var c = [], d = {}, e = []; a.a.D(b, function Z(h) {
                        if (!d[h]) {
                            var f =
                            a.getBindingHandler(h); f && (f.after && (e.push(h), a.a.q(f.after, function (c) { if (b[c]) { if (-1 !== a.a.o(e, c)) throw Error("Cannot combine the following bindings, because they have a cyclic dependency: " + e.join(", ")); Z(c) } }), e.length--), c.push({ key: h, fc: f })); d[h] = !0
                        }
                    }); return c
                } function m(b, d, e, h) {
                    var m = a.a.e.get(b, q); if (!d) { if (m) throw Error("You cannot apply bindings multiple times to the same element."); a.a.e.set(b, q, !0) } !m && h && a.tc(b, e); var g; if (d && "function" !== typeof d) g = d; else {
                        var k = a.Q.instance, r = k.getBindingAccessors ||
                        f, p = a.B(function () { (g = d ? d(e, b) : r.call(k, b, e)) && e.P && e.P(); return g }, null, { i: b }); g && p.ba() || (p = null)
                    } var u; if (g) {
                        var v = p ? function (a) { return function () { return c(p()[a]) } } : function (a) { return g[a] }, s = function () { return a.a.Ca(p ? p() : g, c) }; s.get = function (a) { return g[a] && c(v(a)) }; s.has = function (a) { return a in g }; h = l(g); a.a.q(h, function (c) {
                            var d = c.fc.init, h = c.fc.update, f = c.key; if (8 === b.nodeType && !a.f.Z[f]) throw Error("The binding '" + f + "' cannot be used with virtual elements"); try {
                                "function" == typeof d && a.l.w(function () {
                                    var a =
                                    d(b, v(f), s, e.$data, e); if (a && a.controlsDescendantBindings) { if (u !== n) throw Error("Multiple bindings (" + u + " and " + f + ") are trying to control descendant bindings of the same element. You cannot use these bindings together on the same element."); u = f }
                                }), "function" == typeof h && a.B(function () { h(b, v(f), s, e.$data, e) }, null, { i: b })
                            } catch (m) { throw m.message = 'Unable to process binding "' + f + ": " + g[f] + '"\nMessage: ' + m.message, m; }
                        })
                    } return { shouldBindDescendants: u === n }
                } function h(b) { return b && b instanceof a.U ? b : new a.U(b) }
                a.d = {}; var r = { script: !0, textarea: !0, template: !0 }; a.getBindingHandler = function (b) { return a.d[b] }; a.U = function (b, c, d, e) {
                    var h = this, f = "function" == typeof b && !a.H(b), m, g = a.B(function () { var m = f ? b() : b, l = a.a.c(m); c ? (c.P && c.P(), a.a.extend(h, c), g && (h.P = g)) : (h.$parents = [], h.$root = l, h.ko = a); h.$rawData = m; h.$data = l; d && (h[d] = l); e && e(h, c, l); return h.$data }, null, { wa: function () { return m && !a.a.Qb(m) }, i: !0 }); g.ba() && (h.P = g, g.equalityComparer = null, m = [], g.Ac = function (b) {
                        m.push(b); a.a.F.oa(b, function (b) {
                            a.a.La(m, b); m.length ||
                            (g.k(), h.P = g = n)
                        })
                    })
                }; a.U.prototype.createChildContext = function (b, c, d) { return new a.U(b, this, c, function (a, b) { a.$parentContext = b; a.$parent = b.$data; a.$parents = (b.$parents || []).slice(0); a.$parents.unshift(a.$parent); d && d(a) }) }; a.U.prototype.extend = function (b) { return new a.U(this.P || this.$data, this, null, function (c, d) { c.$rawData = d.$rawData; a.a.extend(c, "function" == typeof b ? b() : b) }) }; var q = a.a.e.I(), p = a.a.e.I(); a.tc = function (b, c) {
                    if (2 == arguments.length) a.a.e.set(b, p, c), c.P && c.P.Ac(b); else return a.a.e.get(b,
                    p)
                }; a.Ja = function (b, c, d) { 1 === b.nodeType && a.f.kc(b); return m(b, c, h(d), !0) }; a.Dc = function (b, c, d) { d = h(d); return a.Ja(b, e(c, d, b), d) }; a.eb = function (a, b) { 1 !== b.nodeType && 8 !== b.nodeType || g(h(a), b, !0) }; a.Rb = function (a, b) { !v && x.jQuery && (v = x.jQuery); if (b && 1 !== b.nodeType && 8 !== b.nodeType) throw Error("ko.applyBindings: first parameter should be your view model; second parameter should be a DOM node"); b = b || x.document.body; k(h(a), b, !0) }; a.kb = function (b) {
                    switch (b.nodeType) {
                        case 1: case 8: var c = a.tc(b); if (c) return c;
                            if (b.parentNode) return a.kb(b.parentNode)
                    } return n
                }; a.Jc = function (b) { return (b = a.kb(b)) ? b.$data : n }; a.b("bindingHandlers", a.d); a.b("applyBindings", a.Rb); a.b("applyBindingsToDescendants", a.eb); a.b("applyBindingAccessorsToNode", a.Ja); a.b("applyBindingsToNode", a.Dc); a.b("contextFor", a.kb); a.b("dataFor", a.Jc)
            })(); (function (b) {
                function c(c, e) {
                    var m = f.hasOwnProperty(c) ? f[c] : b, h; m ? m.X(e) : (m = f[c] = new a.J, m.X(e), d(c, function (b, d) {
                        var e = !(!d || !d.synchronous); g[c] = { definition: b, Zc: e }; delete f[c]; h || e ? m.notifySubscribers(b) :
                        a.Y.Wa(function () { m.notifySubscribers(b) })
                    }), h = !0)
                } function d(a, b) { e("getConfig", [a], function (c) { c ? e("loadComponent", [a, c], function (a) { b(a, c) }) : b(null, null) }) } function e(c, d, f, h) { h || (h = a.g.loaders.slice(0)); var g = h.shift(); if (g) { var q = g[c]; if (q) { var p = !1; if (q.apply(g, d.concat(function (a) { p ? f(null) : null !== a ? f(a) : e(c, d, f, h) })) !== b && (p = !0, !g.suppressLoaderExceptions)) throw Error("Component loaders must supply values by invoking the callback, not by returning values synchronously."); } else e(c, d, f, h) } else f(null) }
                var f = {}, g = {}; a.g = { get: function (d, e) { var f = g.hasOwnProperty(d) ? g[d] : b; f ? f.Zc ? a.l.w(function () { e(f.definition) }) : a.Y.Wa(function () { e(f.definition) }) : c(d, e) }, Xb: function (a) { delete g[a] }, Jb: e }; a.g.loaders = []; a.b("components", a.g); a.b("components.get", a.g.get); a.b("components.clearCachedDefinition", a.g.Xb)
            })(); (function () {
                function b(b, c, d, e) {
                    function g() { 0 === --y && e(k) } var k = {}, y = 2, t = d.template; d = d.viewModel; t ? f(c, t, function (c) { a.g.Jb("loadTemplate", [b, c], function (a) { k.template = a; g() }) }) : g(); d ? f(c, d, function (c) {
                        a.g.Jb("loadViewModel",
                        [b, c], function (a) { k[l] = a; g() })
                    }) : g()
                } function c(a, b, d) { if ("function" === typeof b) d(function (a) { return new b(a) }); else if ("function" === typeof b[l]) d(b[l]); else if ("instance" in b) { var e = b.instance; d(function () { return e }) } else "viewModel" in b ? c(a, b.viewModel, d) : a("Unknown viewModel value: " + b) } function d(b) { switch (a.a.A(b)) { case "script": return a.a.ma(b.text); case "textarea": return a.a.ma(b.value); case "template": if (e(b.content)) return a.a.ua(b.content.childNodes) } return a.a.ua(b.childNodes) } function e(a) {
                    return x.DocumentFragment ?
                    a instanceof DocumentFragment : a && 11 === a.nodeType
                } function f(a, b, c) { "string" === typeof b.require ? O || x.require ? (O || x.require)([b.require], c) : a("Uses require, but no AMD loader is present") : c(b) } function g(a) { return function (b) { throw Error("Component '" + a + "': " + b); } } var k = {}; a.g.register = function (b, c) { if (!c) throw Error("Invalid configuration for " + b); if (a.g.ub(b)) throw Error("Component " + b + " is already registered"); k[b] = c }; a.g.ub = function (a) { return k.hasOwnProperty(a) }; a.g.od = function (b) {
                    delete k[b];
                    a.g.Xb(b)
                }; a.g.Zb = {
                    getConfig: function (a, b) { b(k.hasOwnProperty(a) ? k[a] : null) }, loadComponent: function (a, c, d) { var e = g(a); f(e, c, function (c) { b(a, e, c, d) }) }, loadTemplate: function (b, c, f) {
                        b = g(b); if ("string" === typeof c) f(a.a.ma(c)); else if (c instanceof Array) f(c); else if (e(c)) f(a.a.V(c.childNodes)); else if (c.element) if (c = c.element, x.HTMLElement ? c instanceof HTMLElement : c && c.tagName && 1 === c.nodeType) f(d(c)); else if ("string" === typeof c) { var l = u.getElementById(c); l ? f(d(l)) : b("Cannot find element with ID " + c) } else b("Unknown element type: " +
                        c); else b("Unknown template value: " + c)
                    }, loadViewModel: function (a, b, d) { c(g(a), b, d) }
                }; var l = "createViewModel"; a.b("components.register", a.g.register); a.b("components.isRegistered", a.g.ub); a.b("components.unregister", a.g.od); a.b("components.defaultLoader", a.g.Zb); a.g.loaders.push(a.g.Zb); a.g.Bc = k
            })(); (function () {
                function b(b, e) {
                    var f = b.getAttribute("params"); if (f) {
                        var f = c.parseBindingsString(f, e, b, { valueAccessors: !0, bindingParams: !0 }), f = a.a.Ca(f, function (c) { return a.m(c, null, { i: b }) }), g = a.a.Ca(f, function (c) {
                            var e =
                            c.t(); return c.ba() ? a.m({ read: function () { return a.a.c(c()) }, write: a.Ba(e) && function (a) { c()(a) }, i: b }) : e
                        }); g.hasOwnProperty("$raw") || (g.$raw = f); return g
                    } return { $raw: {} }
                } a.g.getComponentNameForNode = function (b) { var c = a.a.A(b); if (a.g.ub(c) && (-1 != c.indexOf("-") || "[object HTMLUnknownElement]" == "" + b || 8 >= a.a.C && b.tagName === c)) return c }; a.g.Ob = function (c, e, f, g) {
                    if (1 === e.nodeType) {
                        var k = a.g.getComponentNameForNode(e); if (k) {
                            c = c || {}; if (c.component) throw Error('Cannot use the "component" binding on a custom element matching a component');
                            var l = { name: k, params: b(e, f) }; c.component = g ? function () { return l } : l
                        }
                    } return c
                }; var c = new a.Q; 9 > a.a.C && (a.g.register = function (a) { return function (b) { u.createElement(b); return a.apply(this, arguments) } }(a.g.register), u.createDocumentFragment = function (b) { return function () { var c = b(), f = a.g.Bc, g; for (g in f) f.hasOwnProperty(g) && c.createElement(g); return c } }(u.createDocumentFragment))
            })(); (function (b) {
                function c(b, c, d) { c = c.template; if (!c) throw Error("Component '" + b + "' has no template"); b = a.a.ua(c); a.f.da(d, b) }
                function d(a, b, c, d) { var e = a.createViewModel; return e ? e.call(a, d, { element: b, templateNodes: c }) : d } var e = 0; a.d.component = {
                    init: function (f, g, k, l, m) {
                        function h() { var a = r && r.dispose; "function" === typeof a && a.call(r); q = r = null } var r, q, p = a.a.V(a.f.childNodes(f)); a.a.F.oa(f, h); a.m(function () {
                            var l = a.a.c(g()), k, t; "string" === typeof l ? k = l : (k = a.a.c(l.name), t = a.a.c(l.params)); if (!k) throw Error("No component name specified"); var n = q = ++e; a.g.get(k, function (e) {
                                if (q === n) {
                                    h(); if (!e) throw Error("Unknown component '" + k +
                                    "'"); c(k, e, f); var g = d(e, f, p, t); e = m.createChildContext(g, b, function (a) { a.$component = g; a.$componentTemplateNodes = p }); r = g; a.eb(e, f)
                                }
                            })
                        }, null, { i: f }); return { controlsDescendantBindings: !0 }
                    }
                }; a.f.Z.component = !0
            })(); var S = { "class": "className", "for": "htmlFor" }; a.d.attr = {
                update: function (b, c) {
                    var d = a.a.c(c()) || {}; a.a.D(d, function (c, d) {
                        d = a.a.c(d); var g = !1 === d || null === d || d === n; g && b.removeAttribute(c); 8 >= a.a.C && c in S ? (c = S[c], g ? b.removeAttribute(c) : b[c] = d) : g || b.setAttribute(c, d.toString()); "name" === c && a.a.rc(b,
                        g ? "" : d.toString())
                    })
                }
            }; (function () {
                a.d.checked = {
                    after: ["value", "attr"], init: function (b, c, d) {
                        function e() { var e = b.checked, f = p ? g() : e; if (!a.va.Sa() && (!l || e)) { var m = a.l.w(c); if (h) { var k = r ? m.t() : m; q !== f ? (e && (a.a.pa(k, f, !0), a.a.pa(k, q, !1)), q = f) : a.a.pa(k, f, e); r && a.Ba(m) && m(k) } else a.h.Ea(m, d, "checked", f, !0) } } function f() { var d = a.a.c(c()); b.checked = h ? 0 <= a.a.o(d, g()) : k ? d : g() === d } var g = a.nc(function () { return d.has("checkedValue") ? a.a.c(d.get("checkedValue")) : d.has("value") ? a.a.c(d.get("value")) : b.value }), k =
                        "checkbox" == b.type, l = "radio" == b.type; if (k || l) { var m = c(), h = k && a.a.c(m) instanceof Array, r = !(h && m.push && m.splice), q = h ? g() : n, p = l || h; l && !b.name && a.d.uniqueName.init(b, function () { return !0 }); a.m(e, null, { i: b }); a.a.p(b, "click", e); a.m(f, null, { i: b }); m = n }
                    }
                }; a.h.ea.checked = !0; a.d.checkedValue = { update: function (b, c) { b.value = a.a.c(c()) } }
            })(); a.d.css = {
                update: function (b, c) {
                    var d = a.a.c(c()); null !== d && "object" == typeof d ? a.a.D(d, function (c, d) { d = a.a.c(d); a.a.bb(b, c, d) }) : (d = a.a.$a(String(d || "")), a.a.bb(b, b.__ko__cssValue,
                    !1), b.__ko__cssValue = d, a.a.bb(b, d, !0))
                }
            }; a.d.enable = { update: function (b, c) { var d = a.a.c(c()); d && b.disabled ? b.removeAttribute("disabled") : d || b.disabled || (b.disabled = !0) } }; a.d.disable = { update: function (b, c) { a.d.enable.update(b, function () { return !a.a.c(c()) }) } }; a.d.event = {
                init: function (b, c, d, e, f) {
                    var g = c() || {}; a.a.D(g, function (g) {
                        "string" == typeof g && a.a.p(b, g, function (b) {
                            var m, h = c()[g]; if (h) {
                                try { var r = a.a.V(arguments); e = f.$data; r.unshift(e); m = h.apply(e, r) } finally {
                                    !0 !== m && (b.preventDefault ? b.preventDefault() :
                                    b.returnValue = !1)
                                } !1 === d.get(g + "Bubble") && (b.cancelBubble = !0, b.stopPropagation && b.stopPropagation())
                            }
                        })
                    })
                }
            }; a.d.foreach = {
                ic: function (b) { return function () { var c = b(), d = a.a.zb(c); if (!d || "number" == typeof d.length) return { foreach: c, templateEngine: a.W.sb }; a.a.c(c); return { foreach: d.data, as: d.as, includeDestroyed: d.includeDestroyed, afterAdd: d.afterAdd, beforeRemove: d.beforeRemove, afterRender: d.afterRender, beforeMove: d.beforeMove, afterMove: d.afterMove, templateEngine: a.W.sb } } }, init: function (b, c) {
                    return a.d.template.init(b,
                    a.d.foreach.ic(c))
                }, update: function (b, c, d, e, f) { return a.d.template.update(b, a.d.foreach.ic(c), d, e, f) }
            }; a.h.ta.foreach = !1; a.f.Z.foreach = !0; a.d.hasfocus = {
                init: function (b, c, d) {
                    function e(e) { b.__ko_hasfocusUpdating = !0; var f = b.ownerDocument; if ("activeElement" in f) { var g; try { g = f.activeElement } catch (h) { g = f.body } e = g === b } f = c(); a.h.Ea(f, d, "hasfocus", e, !0); b.__ko_hasfocusLastValue = e; b.__ko_hasfocusUpdating = !1 } var f = e.bind(null, !0), g = e.bind(null, !1); a.a.p(b, "focus", f); a.a.p(b, "focusin", f); a.a.p(b, "blur", g); a.a.p(b,
                    "focusout", g)
                }, update: function (b, c) { var d = !!a.a.c(c()); b.__ko_hasfocusUpdating || b.__ko_hasfocusLastValue === d || (d ? b.focus() : b.blur(), !d && b.__ko_hasfocusLastValue && b.ownerDocument.body.focus(), a.l.w(a.a.Da, null, [b, d ? "focusin" : "focusout"])) }
            }; a.h.ea.hasfocus = !0; a.d.hasFocus = a.d.hasfocus; a.h.ea.hasFocus = !0; a.d.html = { init: function () { return { controlsDescendantBindings: !0 } }, update: function (b, c) { a.a.Cb(b, c()) } }; K("if"); K("ifnot", !1, !0); K("with", !0, !1, function (a, c) { return a.createChildContext(c) }); var L = {};
            a.d.options = {
                init: function (b) { if ("select" !== a.a.A(b)) throw Error("options binding applies only to SELECT elements"); for (; 0 < b.length;) b.remove(0); return { controlsDescendantBindings: !0 } }, update: function (b, c, d) {
                    function e() { return a.a.Ka(b.options, function (a) { return a.selected }) } function f(a, b, c) { var d = typeof b; return "function" == d ? b(a) : "string" == d ? a[b] : c } function g(c, e) {
                        if (A && h) a.j.ha(b, a.a.c(d.get("value")), !0); else if (p.length) {
                            var f = 0 <= a.a.o(p, a.j.u(e[0])); a.a.sc(e[0], f); A && !f && a.l.w(a.a.Da, null, [b,
                            "change"])
                        }
                    } var k = b.multiple, l = 0 != b.length && k ? b.scrollTop : null, m = a.a.c(c()), h = d.get("valueAllowUnset") && d.has("value"), r = d.get("optionsIncludeDestroyed"); c = {}; var q, p = []; h || (k ? p = a.a.fb(e(), a.j.u) : 0 <= b.selectedIndex && p.push(a.j.u(b.options[b.selectedIndex]))); m && ("undefined" == typeof m.length && (m = [m]), q = a.a.Ka(m, function (b) { return r || b === n || null === b || !a.a.c(b._destroy) }), d.has("optionsCaption") && (m = a.a.c(d.get("optionsCaption")), null !== m && m !== n && q.unshift(L))); var A = !1; c.beforeRemove = function (a) { b.removeChild(a) };
                    m = g; d.has("optionsAfterRender") && "function" == typeof d.get("optionsAfterRender") && (m = function (b, c) { g(0, c); a.l.w(d.get("optionsAfterRender"), null, [c[0], b !== L ? b : n]) }); a.a.Bb(b, q, function (c, e, g) { g.length && (p = !h && g[0].selected ? [a.j.u(g[0])] : [], A = !0); e = b.ownerDocument.createElement("option"); c === L ? (a.a.Za(e, d.get("optionsCaption")), a.j.ha(e, n)) : (g = f(c, d.get("optionsValue"), c), a.j.ha(e, a.a.c(g)), c = f(c, d.get("optionsText"), g), a.a.Za(e, c)); return [e] }, c, m); a.l.w(function () {
                        h ? a.j.ha(b, a.a.c(d.get("value")),
                        !0) : (k ? p.length && e().length < p.length : p.length && 0 <= b.selectedIndex ? a.j.u(b.options[b.selectedIndex]) !== p[0] : p.length || 0 <= b.selectedIndex) && a.a.Da(b, "change")
                    }); a.a.Nc(b); l && 20 < Math.abs(l - b.scrollTop) && (b.scrollTop = l)
                }
            }; a.d.options.xb = a.a.e.I(); a.d.selectedOptions = {
                after: ["options", "foreach"], init: function (b, c, d) { a.a.p(b, "change", function () { var e = c(), f = []; a.a.q(b.getElementsByTagName("option"), function (b) { b.selected && f.push(a.j.u(b)) }); a.h.Ea(e, d, "selectedOptions", f) }) }, update: function (b, c) {
                    if ("select" !=
                    a.a.A(b)) throw Error("values binding applies only to SELECT elements"); var d = a.a.c(c()), e = b.scrollTop; d && "number" == typeof d.length && a.a.q(b.getElementsByTagName("option"), function (b) { var c = 0 <= a.a.o(d, a.j.u(b)); b.selected != c && a.a.sc(b, c) }); b.scrollTop = e
                }
            }; a.h.ea.selectedOptions = !0; a.d.style = { update: function (b, c) { var d = a.a.c(c() || {}); a.a.D(d, function (c, d) { d = a.a.c(d); if (null === d || d === n || !1 === d) d = ""; b.style[c] = d }) } }; a.d.submit = {
                init: function (b, c, d, e, f) {
                    if ("function" != typeof c()) throw Error("The value for a submit binding must be a function");
                    a.a.p(b, "submit", function (a) { var d, e = c(); try { d = e.call(f.$data, b) } finally { !0 !== d && (a.preventDefault ? a.preventDefault() : a.returnValue = !1) } })
                }
            }; a.d.text = { init: function () { return { controlsDescendantBindings: !0 } }, update: function (b, c) { a.a.Za(b, c()) } }; a.f.Z.text = !0; (function () {
                if (x && x.navigator) var b = function (a) { if (a) return parseFloat(a[1]) }, c = x.opera && x.opera.version && parseInt(x.opera.version()), d = x.navigator.userAgent, e = b(d.match(/^(?:(?!chrome).)*version\/([^ ]*) safari/i)), f = b(d.match(/Firefox\/([^ ]*)/));
                if (10 > a.a.C) var g = a.a.e.I(), k = a.a.e.I(), l = function (b) { var c = this.activeElement; (c = c && a.a.e.get(c, k)) && c(b) }, m = function (b, c) { var d = b.ownerDocument; a.a.e.get(d, g) || (a.a.e.set(d, g, !0), a.a.p(d, "selectionchange", l)); a.a.e.set(b, k, c) }; a.d.textInput = {
                    init: function (b, d, g) {
                        function l(c, d) { a.a.p(b, c, d) } function k() { var c = a.a.c(d()); if (null === c || c === n) c = ""; v !== n && c === v ? a.a.setTimeout(k, 4) : b.value !== c && (u = c, b.value = c) } function y() { s || (v = b.value, s = a.a.setTimeout(t, 4)) } function t() {
                            clearTimeout(s); v = s = n; var c =
                            b.value; u !== c && (u = c, a.h.Ea(d(), g, "textInput", c))
                        } var u = b.value, s, v, x = 9 == a.a.C ? y : t; 10 > a.a.C ? (l("propertychange", function (a) { "value" === a.propertyName && x(a) }), 8 == a.a.C && (l("keyup", t), l("keydown", t)), 8 <= a.a.C && (m(b, x), l("dragend", y))) : (l("input", t), 5 > e && "textarea" === a.a.A(b) ? (l("keydown", y), l("paste", y), l("cut", y)) : 11 > c ? l("keydown", y) : 4 > f && (l("DOMAutoComplete", t), l("dragdrop", t), l("drop", t))); l("change", t); a.m(k, null, { i: b })
                    }
                }; a.h.ea.textInput = !0; a.d.textinput = {
                    preprocess: function (a, b, c) {
                        c("textInput",
                        a)
                    }
                }
            })(); a.d.uniqueName = { init: function (b, c) { if (c()) { var d = "ko_unique_" + ++a.d.uniqueName.Ic; a.a.rc(b, d) } } }; a.d.uniqueName.Ic = 0; a.d.value = {
                after: ["options", "foreach"], init: function (b, c, d) {
                    if ("input" != b.tagName.toLowerCase() || "checkbox" != b.type && "radio" != b.type) {
                        var e = ["change"], f = d.get("valueUpdate"), g = !1, k = null; f && ("string" == typeof f && (f = [f]), a.a.ra(e, f), e = a.a.Tb(e)); var l = function () { k = null; g = !1; var e = c(), f = a.j.u(b); a.h.Ea(e, d, "value", f) }; !a.a.C || "input" != b.tagName.toLowerCase() || "text" != b.type ||
                        "off" == b.autocomplete || b.form && "off" == b.form.autocomplete || -1 != a.a.o(e, "propertychange") || (a.a.p(b, "propertychange", function () { g = !0 }), a.a.p(b, "focus", function () { g = !1 }), a.a.p(b, "blur", function () { g && l() })); a.a.q(e, function (c) { var d = l; a.a.nd(c, "after") && (d = function () { k = a.j.u(b); a.a.setTimeout(l, 0) }, c = c.substring(5)); a.a.p(b, c, d) }); var m = function () {
                            var e = a.a.c(c()), f = a.j.u(b); if (null !== k && e === k) a.a.setTimeout(m, 0); else if (e !== f) if ("select" === a.a.A(b)) {
                                var g = d.get("valueAllowUnset"), f = function () {
                                    a.j.ha(b,
                                    e, g)
                                }; f(); g || e === a.j.u(b) ? a.a.setTimeout(f, 0) : a.l.w(a.a.Da, null, [b, "change"])
                            } else a.j.ha(b, e)
                        }; a.m(m, null, { i: b })
                    } else a.Ja(b, { checkedValue: c })
                }, update: function () { }
            }; a.h.ea.value = !0; a.d.visible = { update: function (b, c) { var d = a.a.c(c()), e = "none" != b.style.display; d && !e ? b.style.display = "" : !d && e && (b.style.display = "none") } }; (function (b) { a.d[b] = { init: function (c, d, e, f, g) { return a.d.event.init.call(this, c, function () { var a = {}; a[b] = d(); return a }, e, f, g) } } })("click"); a.O = function () { }; a.O.prototype.renderTemplateSource =
            function () { throw Error("Override renderTemplateSource"); }; a.O.prototype.createJavaScriptEvaluatorBlock = function () { throw Error("Override createJavaScriptEvaluatorBlock"); }; a.O.prototype.makeTemplateSource = function (b, c) { if ("string" == typeof b) { c = c || u; var d = c.getElementById(b); if (!d) throw Error("Cannot find template with ID " + b); return new a.v.n(d) } if (1 == b.nodeType || 8 == b.nodeType) return new a.v.qa(b); throw Error("Unknown template type: " + b); }; a.O.prototype.renderTemplate = function (a, c, d, e) {
                a = this.makeTemplateSource(a,
                e); return this.renderTemplateSource(a, c, d, e)
            }; a.O.prototype.isTemplateRewritten = function (a, c) { return !1 === this.allowTemplateRewriting ? !0 : this.makeTemplateSource(a, c).data("isRewritten") }; a.O.prototype.rewriteTemplate = function (a, c, d) { a = this.makeTemplateSource(a, d); c = c(a.text()); a.text(c); a.data("isRewritten", !0) }; a.b("templateEngine", a.O); a.Gb = function () {
                function b(b, c, d, k) {
                    b = a.h.yb(b); for (var l = a.h.ta, m = 0; m < b.length; m++) {
                        var h = b[m].key; if (l.hasOwnProperty(h)) {
                            var r = l[h]; if ("function" === typeof r) {
                                if (h =
                                r(b[m].value)) throw Error(h);
                            } else if (!r) throw Error("This template engine does not support the '" + h + "' binding within its templates");
                        }
                    } d = "ko.__tr_ambtns(function($context,$element){return(function(){return{ " + a.h.Ua(b, { valueAccessors: !0 }) + " } })()},'" + d.toLowerCase() + "')"; return k.createJavaScriptEvaluatorBlock(d) + c
                } var c = /(<([a-z]+\d*)(?:\s+(?!data-bind\s*=\s*)[a-z0-9\-]+(?:=(?:\"[^\"]*\"|\'[^\']*\'|[^>]*))?)*\s+)data-bind\s*=\s*(["'])([\s\S]*?)\3/gi, d = /\x3c!--\s*ko\b\s*([\s\S]*?)\s*--\x3e/g; return {
                    Oc: function (b,
                    c, d) { c.isTemplateRewritten(b, d) || c.rewriteTemplate(b, function (b) { return a.Gb.dd(b, c) }, d) }, dd: function (a, f) { return a.replace(c, function (a, c, d, e, h) { return b(h, c, d, f) }).replace(d, function (a, c) { return b(c, "\x3c!-- ko --\x3e", "#comment", f) }) }, Ec: function (b, c) { return a.M.wb(function (d, k) { var l = d.nextSibling; l && l.nodeName.toLowerCase() === c && a.Ja(l, b, k) }) }
                }
            }(); a.b("__tr_ambtns", a.Gb.Ec); (function () {
                a.v = {}; a.v.n = function (b) {
                    if (this.n = b) {
                        var c = a.a.A(b); this.ab = "script" === c ? 1 : "textarea" === c ? 2 : "template" == c &&
                        b.content && 11 === b.content.nodeType ? 3 : 4
                    }
                }; a.v.n.prototype.text = function () { var b = 1 === this.ab ? "text" : 2 === this.ab ? "value" : "innerHTML"; if (0 == arguments.length) return this.n[b]; var c = arguments[0]; "innerHTML" === b ? a.a.Cb(this.n, c) : this.n[b] = c }; var b = a.a.e.I() + "_"; a.v.n.prototype.data = function (c) { if (1 === arguments.length) return a.a.e.get(this.n, b + c); a.a.e.set(this.n, b + c, arguments[1]) }; var c = a.a.e.I(); a.v.n.prototype.nodes = function () {
                    var b = this.n; if (0 == arguments.length) return (a.a.e.get(b, c) || {}).jb || (3 === this.ab ?
                    b.content : 4 === this.ab ? b : n); a.a.e.set(b, c, { jb: arguments[0] })
                }; a.v.qa = function (a) { this.n = a }; a.v.qa.prototype = new a.v.n; a.v.qa.prototype.text = function () { if (0 == arguments.length) { var b = a.a.e.get(this.n, c) || {}; b.Hb === n && b.jb && (b.Hb = b.jb.innerHTML); return b.Hb } a.a.e.set(this.n, c, { Hb: arguments[0] }) }; a.b("templateSources", a.v); a.b("templateSources.domElement", a.v.n); a.b("templateSources.anonymousTemplate", a.v.qa)
            })(); (function () {
                function b(b, c, d) {
                    var e; for (c = a.f.nextSibling(c) ; b && (e = b) !== c;) b = a.f.nextSibling(e),
                    d(e, b)
                } function c(c, d) { if (c.length) { var e = c[0], f = c[c.length - 1], g = e.parentNode, k = a.Q.instance, n = k.preprocessNode; if (n) { b(e, f, function (a, b) { var c = a.previousSibling, d = n.call(k, a); d && (a === e && (e = d[0] || b), a === f && (f = d[d.length - 1] || c)) }); c.length = 0; if (!e) return; e === f ? c.push(e) : (c.push(e, f), a.a.za(c, g)) } b(e, f, function (b) { 1 !== b.nodeType && 8 !== b.nodeType || a.Rb(d, b) }); b(e, f, function (b) { 1 !== b.nodeType && 8 !== b.nodeType || a.M.yc(b, [d]) }); a.a.za(c, g) } } function d(a) { return a.nodeType ? a : 0 < a.length ? a[0] : null } function e(b,
                e, f, k, q) {
                    q = q || {}; var p = (b && d(b) || f || {}).ownerDocument, n = q.templateEngine || g; a.Gb.Oc(f, n, p); f = n.renderTemplate(f, k, q, p); if ("number" != typeof f.length || 0 < f.length && "number" != typeof f[0].nodeType) throw Error("Template engine must return an array of DOM nodes"); p = !1; switch (e) { case "replaceChildren": a.f.da(b, f); p = !0; break; case "replaceNode": a.a.qc(b, f); p = !0; break; case "ignoreTargetNode": break; default: throw Error("Unknown renderMode: " + e); } p && (c(f, k), q.afterRender && a.l.w(q.afterRender, null, [f, k.$data]));
                    return f
                } function f(b, c, d) { return a.H(b) ? b() : "function" === typeof b ? b(c, d) : b } var g; a.Db = function (b) { if (b != n && !(b instanceof a.O)) throw Error("templateEngine must inherit from ko.templateEngine"); g = b }; a.Ab = function (b, c, h, k, q) {
                    h = h || {}; if ((h.templateEngine || g) == n) throw Error("Set a template engine before calling renderTemplate"); q = q || "replaceChildren"; if (k) {
                        var p = d(k); return a.B(function () { var g = c && c instanceof a.U ? c : new a.U(a.a.c(c)), n = f(b, g.$data, g), g = e(k, q, n, g, h); "replaceNode" == q && (k = g, p = d(k)) }, null,
                        { wa: function () { return !p || !a.a.nb(p) }, i: p && "replaceNode" == q ? p.parentNode : p })
                    } return a.M.wb(function (d) { a.Ab(b, c, h, d, "replaceNode") })
                }; a.kd = function (b, d, g, k, q) {
                    function p(a, b) { c(b, s); g.afterRender && g.afterRender(b, a); s = null } function u(a, c) { s = q.createChildContext(a, g.as, function (a) { a.$index = c }); var d = f(b, a, s); return e(null, "ignoreTargetNode", d, s, g) } var s; return a.B(function () {
                        var b = a.a.c(d) || []; "undefined" == typeof b.length && (b = [b]); b = a.a.Ka(b, function (b) { return g.includeDestroyed || b === n || null === b || !a.a.c(b._destroy) });
                        a.l.w(a.a.Bb, null, [k, b, u, g, p])
                    }, null, { i: k })
                }; var k = a.a.e.I(); a.d.template = {
                    init: function (b, c) { var d = a.a.c(c()); if ("string" == typeof d || d.name) a.f.xa(b); else { if ("nodes" in d) { if (d = d.nodes || [], a.H(d)) throw Error('The "nodes" option must be a plain, non-observable array.'); } else d = a.f.childNodes(b); d = a.a.jc(d); (new a.v.qa(b)).nodes(d) } return { controlsDescendantBindings: !0 } }, update: function (b, c, d, e, f) {
                        var g = c(), s; c = a.a.c(g); d = !0; e = null; "string" == typeof c ? c = {} : (g = c.name, "if" in c && (d = a.a.c(c["if"])), d && "ifnot" in
                        c && (d = !a.a.c(c.ifnot)), s = a.a.c(c.data)); "foreach" in c ? e = a.kd(g || b, d && c.foreach || [], c, b, f) : d ? (f = "data" in c ? f.createChildContext(s, c.as) : f, e = a.Ab(g || b, f, c, b)) : a.f.xa(b); f = e; (s = a.a.e.get(b, k)) && "function" == typeof s.k && s.k(); a.a.e.set(b, k, f && f.ba() ? f : n)
                    }
                }; a.h.ta.template = function (b) { b = a.h.yb(b); return 1 == b.length && b[0].unknown || a.h.ad(b, "name") ? null : "This template engine does not support anonymous templates nested within its templates" }; a.f.Z.template = !0
            })(); a.b("setTemplateEngine", a.Db); a.b("renderTemplate",
            a.Ab); a.a.dc = function (a, c, d) { if (a.length && c.length) { var e, f, g, k, l; for (e = f = 0; (!d || e < d) && (k = a[f]) ; ++f) { for (g = 0; l = c[g]; ++g) if (k.value === l.value) { k.moved = l.index; l.moved = k.index; c.splice(g, 1); e = g = 0; break } e += g } } }; a.a.ib = function () {
                function b(b, d, e, f, g) {
                    var k = Math.min, l = Math.max, m = [], h, n = b.length, q, p = d.length, s = p - n || 1, u = n + p + 1, t, v, x; for (h = 0; h <= n; h++) for (v = t, m.push(t = []), x = k(p, h + s), q = l(0, h - 1) ; q <= x; q++) t[q] = q ? h ? b[h - 1] === d[q - 1] ? v[q - 1] : k(v[q] || u, t[q - 1] || u) + 1 : q + 1 : h + 1; k = []; l = []; s = []; h = n; for (q = p; h || q;) p = m[h][q] -
                    1, q && p === m[h][q - 1] ? l.push(k[k.length] = { status: e, value: d[--q], index: q }) : h && p === m[h - 1][q] ? s.push(k[k.length] = { status: f, value: b[--h], index: h }) : (--q, --h, g.sparse || k.push({ status: "retained", value: d[q] })); a.a.dc(s, l, !g.dontLimitMoves && 10 * n); return k.reverse()
                } return function (a, d, e) { e = "boolean" === typeof e ? { dontLimitMoves: e } : e || {}; a = a || []; d = d || []; return a.length < d.length ? b(a, d, "added", "deleted", e) : b(d, a, "deleted", "added", e) }
            }(); a.b("utils.compareArrays", a.a.ib); (function () {
                function b(b, c, d, k, l) {
                    var m = [],
                    h = a.B(function () { var h = c(d, l, a.a.za(m, b)) || []; 0 < m.length && (a.a.qc(m, h), k && a.l.w(k, null, [d, h, l])); m.length = 0; a.a.ra(m, h) }, null, { i: b, wa: function () { return !a.a.Qb(m) } }); return { ca: m, B: h.ba() ? h : n }
                } var c = a.a.e.I(), d = a.a.e.I(); a.a.Bb = function (e, f, g, k, l) {
                    function m(b, c) { w = q[c]; v !== c && (D[b] = w); w.qb(v++); a.a.za(w.ca, e); u.push(w); z.push(w) } function h(b, c) { if (b) for (var d = 0, e = c.length; d < e; d++) c[d] && a.a.q(c[d].ca, function (a) { b(a, d, c[d].ja) }) } f = f || []; k = k || {}; var r = a.a.e.get(e, c) === n, q = a.a.e.get(e, c) || [], p = a.a.fb(q,
                    function (a) { return a.ja }), s = a.a.ib(p, f, k.dontLimitMoves), u = [], t = 0, v = 0, x = [], z = []; f = []; for (var D = [], p = [], w, C = 0, B, E; B = s[C]; C++) switch (E = B.moved, B.status) { case "deleted": E === n && (w = q[t], w.B && (w.B.k(), w.B = n), a.a.za(w.ca, e).length && (k.beforeRemove && (u.push(w), z.push(w), w.ja === d ? w = null : f[C] = w), w && x.push.apply(x, w.ca))); t++; break; case "retained": m(C, t++); break; case "added": E !== n ? m(C, E) : (w = { ja: B.value, qb: a.N(v++) }, u.push(w), z.push(w), r || (p[C] = w)) } a.a.e.set(e, c, u); h(k.beforeMove, D); a.a.q(x, k.beforeRemove ? a.$ :
                    a.removeNode); for (var C = 0, r = a.f.firstChild(e), F; w = z[C]; C++) { w.ca || a.a.extend(w, b(e, g, w.ja, l, w.qb)); for (t = 0; s = w.ca[t]; r = s.nextSibling, F = s, t++) s !== r && a.f.gc(e, s, F); !w.Wc && l && (l(w.ja, w.ca, w.qb), w.Wc = !0) } h(k.beforeRemove, f); for (C = 0; C < f.length; ++C) f[C] && (f[C].ja = d); h(k.afterMove, D); h(k.afterAdd, p)
                }
            })(); a.b("utils.setDomNodeChildrenFromArrayMapping", a.a.Bb); a.W = function () { this.allowTemplateRewriting = !1 }; a.W.prototype = new a.O; a.W.prototype.renderTemplateSource = function (b, c, d, e) {
                if (c = (9 > a.a.C ? 0 : b.nodes) ?
                b.nodes() : null) return a.a.V(c.cloneNode(!0).childNodes); b = b.text(); return a.a.ma(b, e)
            }; a.W.sb = new a.W; a.Db(a.W.sb); a.b("nativeTemplateEngine", a.W); (function () {
                a.vb = function () {
                    var a = this.$c = function () { if (!v || !v.tmpl) return 0; try { if (0 <= v.tmpl.tag.tmpl.open.toString().indexOf("__")) return 2 } catch (a) { } return 1 }(); this.renderTemplateSource = function (b, e, f, g) {
                        g = g || u; f = f || {}; if (2 > a) throw Error("Your version of jQuery.tmpl is too old. Please upgrade to jQuery.tmpl 1.0.0pre or later."); var k = b.data("precompiled");
                        k || (k = b.text() || "", k = v.template(null, "{{ko_with $item.koBindingContext}}" + k + "{{/ko_with}}"), b.data("precompiled", k)); b = [e.$data]; e = v.extend({ koBindingContext: e }, f.templateOptions); e = v.tmpl(k, b, e); e.appendTo(g.createElement("div")); v.fragments = {}; return e
                    }; this.createJavaScriptEvaluatorBlock = function (a) { return "{{ko_code ((function() { return " + a + " })()) }}" }; this.addTemplate = function (a, b) { u.write("<script type='text/html' id='" + a + "'>" + b + "\x3c/script>") }; 0 < a && (v.tmpl.tag.ko_code = { open: "__.push($1 || '');" },
                    v.tmpl.tag.ko_with = { open: "with($1) {", close: "} " })
                }; a.vb.prototype = new a.O; var b = new a.vb; 0 < b.$c && a.Db(b); a.b("jqueryTmplTemplateEngine", a.vb)
            })()
        })
    })();
})();
/*! jQuery UI - v1.13.3 - 2024-05-31
* https://jqueryui.com
* Includes: widget.js, position.js, data.js, jquery-patch.js, keycode.js, labels.js, scroll-parent.js, unique-id.js, widgets/draggable.js, widgets/mouse.js, effect.js, effects/effect-pulsate.js
* Copyright OpenJS Foundation and other contributors; Licensed MIT */

!function (t) { "use strict"; "function" == typeof define && define.amd ? define(["jquery"], t) : t(jQuery) }(function (x) { "use strict"; x.ui = x.ui || {}; x.ui.version = "1.13.3"; var s, o, P, C, n, r, a, l, h, i, L = 0, A = Array.prototype.hasOwnProperty, c = Array.prototype.slice; x.cleanData = (s = x.cleanData, function (t) { for (var e, i, o = 0; null != (i = t[o]); o++)(e = x._data(i, "events")) && e.remove && x(i).triggerHandler("remove"); s(t) }), x.widget = function (t, i, e) { var o, s, n, r = {}, a = t.split(".")[0], l = a + "-" + (t = t.split(".")[1]); return e || (e = i, i = x.Widget), Array.isArray(e) && (e = x.extend.apply(null, [{}].concat(e))), x.expr.pseudos[l.toLowerCase()] = function (t) { return !!x.data(t, l) }, x[a] = x[a] || {}, o = x[a][t], s = x[a][t] = function (t, e) { if (!this || !this._createWidget) return new s(t, e); arguments.length && this._createWidget(t, e) }, x.extend(s, o, { version: e.version, _proto: x.extend({}, e), _childConstructors: [] }), (n = new i).options = x.widget.extend({}, n.options), x.each(e, function (e, o) { function s() { return i.prototype[e].apply(this, arguments) } function n(t) { return i.prototype[e].apply(this, t) } r[e] = "function" != typeof o ? o : function () { var t, e = this._super, i = this._superApply; return this._super = s, this._superApply = n, t = o.apply(this, arguments), this._super = e, this._superApply = i, t } }), s.prototype = x.widget.extend(n, { widgetEventPrefix: o && n.widgetEventPrefix || t }, r, { constructor: s, namespace: a, widgetName: t, widgetFullName: l }), o ? (x.each(o._childConstructors, function (t, e) { var i = e.prototype; x.widget(i.namespace + "." + i.widgetName, s, e._proto) }), delete o._childConstructors) : i._childConstructors.push(s), x.widget.bridge(t, s), s }, x.widget.extend = function (t) { for (var e, i, o = c.call(arguments, 1), s = 0, n = o.length; s < n; s++)for (e in o[s]) i = o[s][e], A.call(o[s], e) && void 0 !== i && (x.isPlainObject(i) ? t[e] = x.isPlainObject(t[e]) ? x.widget.extend({}, t[e], i) : x.widget.extend({}, i) : t[e] = i); return t }, x.widget.bridge = function (n, e) { var r = e.prototype.widgetFullName || n; x.fn[n] = function (i) { var t = "string" == typeof i, o = c.call(arguments, 1), s = this; return t ? this.length || "instance" !== i ? this.each(function () { var t, e = x.data(this, r); return "instance" === i ? (s = e, !1) : e ? "function" != typeof e[i] || "_" === i.charAt(0) ? x.error("no such method '" + i + "' for " + n + " widget instance") : (t = e[i].apply(e, o)) !== e && void 0 !== t ? (s = t && t.jquery ? s.pushStack(t.get()) : t, !1) : void 0 : x.error("cannot call methods on " + n + " prior to initialization; attempted to call method '" + i + "'") }) : s = void 0 : (o.length && (i = x.widget.extend.apply(null, [i].concat(o))), this.each(function () { var t = x.data(this, r); t ? (t.option(i || {}), t._init && t._init()) : x.data(this, r, new e(i, this)) })), s } }, x.Widget = function () { }, x.Widget._childConstructors = [], x.Widget.prototype = { widgetName: "widget", widgetEventPrefix: "", defaultElement: "<div>", options: { classes: {}, disabled: !1, create: null }, _createWidget: function (t, e) { e = x(e || this.defaultElement || this)[0], this.element = x(e), this.uuid = L++, this.eventNamespace = "." + this.widgetName + this.uuid, this.bindings = x(), this.hoverable = x(), this.focusable = x(), this.classesElementLookup = {}, e !== this && (x.data(e, this.widgetFullName, this), this._on(!0, this.element, { remove: function (t) { t.target === e && this.destroy() } }), this.document = x(e.style ? e.ownerDocument : e.document || e), this.window = x(this.document[0].defaultView || this.document[0].parentWindow)), this.options = x.widget.extend({}, this.options, this._getCreateOptions(), t), this._create(), this.options.disabled && this._setOptionDisabled(this.options.disabled), this._trigger("create", null, this._getCreateEventData()), this._init() }, _getCreateOptions: function () { return {} }, _getCreateEventData: x.noop, _create: x.noop, _init: x.noop, destroy: function () { var i = this; this._destroy(), x.each(this.classesElementLookup, function (t, e) { i._removeClass(e, t) }), this.element.off(this.eventNamespace).removeData(this.widgetFullName), this.widget().off(this.eventNamespace).removeAttr("aria-disabled"), this.bindings.off(this.eventNamespace) }, _destroy: x.noop, widget: function () { return this.element }, option: function (t, e) { var i, o, s, n = t; if (0 === arguments.length) return x.widget.extend({}, this.options); if ("string" == typeof t) if (n = {}, t = (i = t.split(".")).shift(), i.length) { for (o = n[t] = x.widget.extend({}, this.options[t]), s = 0; s < i.length - 1; s++)o[i[s]] = o[i[s]] || {}, o = o[i[s]]; if (t = i.pop(), 1 === arguments.length) return void 0 === o[t] ? null : o[t]; o[t] = e } else { if (1 === arguments.length) return void 0 === this.options[t] ? null : this.options[t]; n[t] = e } return this._setOptions(n), this }, _setOptions: function (t) { for (var e in t) this._setOption(e, t[e]); return this }, _setOption: function (t, e) { return "classes" === t && this._setOptionClasses(e), this.options[t] = e, "disabled" === t && this._setOptionDisabled(e), this }, _setOptionClasses: function (t) { var e, i, o; for (e in t) o = this.classesElementLookup[e], t[e] !== this.options.classes[e] && o && o.length && (i = x(o.get()), this._removeClass(o, e), i.addClass(this._classes({ element: i, keys: e, classes: t, add: !0 }))) }, _setOptionDisabled: function (t) { this._toggleClass(this.widget(), this.widgetFullName + "-disabled", null, !!t), t && (this._removeClass(this.hoverable, null, "ui-state-hover"), this._removeClass(this.focusable, null, "ui-state-focus")) }, enable: function () { return this._setOptions({ disabled: !1 }) }, disable: function () { return this._setOptions({ disabled: !0 }) }, _classes: function (s) { var n = [], r = this; function t(t, e) { for (var i, o = 0; o < t.length; o++)i = r.classesElementLookup[t[o]] || x(), i = s.add ? (function () { var i = []; s.element.each(function (t, e) { x.map(r.classesElementLookup, function (t) { return t }).some(function (t) { return t.is(e) }) || i.push(e) }), r._on(x(i), { remove: "_untrackClassesElement" }) }(), x(x.uniqueSort(i.get().concat(s.element.get())))) : x(i.not(s.element).get()), r.classesElementLookup[t[o]] = i, n.push(t[o]), e && s.classes[t[o]] && n.push(s.classes[t[o]]) } return (s = x.extend({ element: this.element, classes: this.options.classes || {} }, s)).keys && t(s.keys.match(/\S+/g) || [], !0), s.extra && t(s.extra.match(/\S+/g) || []), n.join(" ") }, _untrackClassesElement: function (i) { var o = this; x.each(o.classesElementLookup, function (t, e) { -1 !== x.inArray(i.target, e) && (o.classesElementLookup[t] = x(e.not(i.target).get())) }), this._off(x(i.target)) }, _removeClass: function (t, e, i) { return this._toggleClass(t, e, i, !1) }, _addClass: function (t, e, i) { return this._toggleClass(t, e, i, !0) }, _toggleClass: function (t, e, i, o) { var s = "string" == typeof t || null === t, e = { extra: s ? e : i, keys: s ? t : e, element: s ? this.element : t, add: o = "boolean" == typeof o ? o : i }; return e.element.toggleClass(this._classes(e), o), this }, _on: function (s, n, t) { var r, a = this; "boolean" != typeof s && (t = n, n = s, s = !1), t ? (n = r = x(n), this.bindings = this.bindings.add(n)) : (t = n, n = this.element, r = this.widget()), x.each(t, function (t, e) { function i() { if (s || !0 !== a.options.disabled && !x(this).hasClass("ui-state-disabled")) return ("string" == typeof e ? a[e] : e).apply(a, arguments) } "string" != typeof e && (i.guid = e.guid = e.guid || i.guid || x.guid++); var t = t.match(/^([\w:-]*)\s*(.*)$/), o = t[1] + a.eventNamespace, t = t[2]; t ? r.on(o, t, i) : n.on(o, i) }) }, _off: function (t, e) { e = (e || "").split(" ").join(this.eventNamespace + " ") + this.eventNamespace, t.off(e), this.bindings = x(this.bindings.not(t).get()), this.focusable = x(this.focusable.not(t).get()), this.hoverable = x(this.hoverable.not(t).get()) }, _delay: function (t, e) { var i = this; return setTimeout(function () { return ("string" == typeof t ? i[t] : t).apply(i, arguments) }, e || 0) }, _hoverable: function (t) { this.hoverable = this.hoverable.add(t), this._on(t, { mouseenter: function (t) { this._addClass(x(t.currentTarget), null, "ui-state-hover") }, mouseleave: function (t) { this._removeClass(x(t.currentTarget), null, "ui-state-hover") } }) }, _focusable: function (t) { this.focusable = this.focusable.add(t), this._on(t, { focusin: function (t) { this._addClass(x(t.currentTarget), null, "ui-state-focus") }, focusout: function (t) { this._removeClass(x(t.currentTarget), null, "ui-state-focus") } }) }, _trigger: function (t, e, i) { var o, s, n = this.options[t]; if (i = i || {}, (e = x.Event(e)).type = (t === this.widgetEventPrefix ? t : this.widgetEventPrefix + t).toLowerCase(), e.target = this.element[0], s = e.originalEvent) for (o in s) o in e || (e[o] = s[o]); return this.element.trigger(e, i), !("function" == typeof n && !1 === n.apply(this.element[0], [e].concat(i)) || e.isDefaultPrevented()) } }, x.each({ show: "fadeIn", hide: "fadeOut" }, function (n, r) { x.Widget.prototype["_" + n] = function (e, t, i) { var o, s = (t = "string" == typeof t ? { effect: t } : t) ? !0 !== t && "number" != typeof t && t.effect || r : n; "number" == typeof (t = t || {}) ? t = { duration: t } : !0 === t && (t = {}), o = !x.isEmptyObject(t), t.complete = i, t.delay && e.delay(t.delay), o && x.effects && x.effects.effect[s] ? e[n](t) : s !== n && e[s] ? e[s](t.duration, t.easing, i) : e.queue(function (t) { x(this)[n](), i && i.call(e[0]), t() }) } }), x.widget; function k(t, e, i) { return [parseFloat(t[0]) * (h.test(t[0]) ? e / 100 : 1), parseFloat(t[1]) * (h.test(t[1]) ? i / 100 : 1)] } function T(t, e) { return parseInt(x.css(t, e), 10) || 0 } function S(t) { return null != t && t === t.window } P = Math.max, C = Math.abs, n = /left|center|right/, r = /top|center|bottom/, a = /[\+\-]\d+(\.[\d]+)?%?/, l = /^\w+/, h = /%$/, i = x.fn.position, x.position = { scrollbarWidth: function () { var t, e, i; return void 0 !== o ? o : (i = (e = x("<div style='display:block;position:absolute;width:200px;height:200px;overflow:hidden;'><div style='height:300px;width:auto;'></div></div>")).children()[0], x("body").append(e), t = i.offsetWidth, e.css("overflow", "scroll"), t === (i = i.offsetWidth) && (i = e[0].clientWidth), e.remove(), o = t - i) }, getScrollInfo: function (t) { var e = t.isWindow || t.isDocument ? "" : t.element.css("overflow-x"), i = t.isWindow || t.isDocument ? "" : t.element.css("overflow-y"), e = "scroll" === e || "auto" === e && t.width < t.element[0].scrollWidth; return { width: "scroll" === i || "auto" === i && t.height < t.element[0].scrollHeight ? x.position.scrollbarWidth() : 0, height: e ? x.position.scrollbarWidth() : 0 } }, getWithinInfo: function (t) { var e = x(t || window), i = S(e[0]), o = !!e[0] && 9 === e[0].nodeType; return { element: e, isWindow: i, isDocument: o, offset: !i && !o ? x(t).offset() : { left: 0, top: 0 }, scrollLeft: e.scrollLeft(), scrollTop: e.scrollTop(), width: e.outerWidth(), height: e.outerHeight() } } }, x.fn.position = function (f) { var p, u, d, g, m, v, _, b, y, w, t, e; return f && f.of ? (v = "string" == typeof (f = x.extend({}, f)).of ? x(document).find(f.of) : x(f.of), _ = x.position.getWithinInfo(f.within), b = x.position.getScrollInfo(_), y = (f.collision || "flip").split(" "), w = {}, e = 9 === (e = (t = v)[0]).nodeType ? { width: t.width(), height: t.height(), offset: { top: 0, left: 0 } } : S(e) ? { width: t.width(), height: t.height(), offset: { top: t.scrollTop(), left: t.scrollLeft() } } : e.preventDefault ? { width: 0, height: 0, offset: { top: e.pageY, left: e.pageX } } : { width: t.outerWidth(), height: t.outerHeight(), offset: t.offset() }, v[0].preventDefault && (f.at = "left top"), u = e.width, d = e.height, m = x.extend({}, g = e.offset), x.each(["my", "at"], function () { var t, e, i = (f[this] || "").split(" "); (i = 1 === i.length ? n.test(i[0]) ? i.concat(["center"]) : r.test(i[0]) ? ["center"].concat(i) : ["center", "center"] : i)[0] = n.test(i[0]) ? i[0] : "center", i[1] = r.test(i[1]) ? i[1] : "center", t = a.exec(i[0]), e = a.exec(i[1]), w[this] = [t ? t[0] : 0, e ? e[0] : 0], f[this] = [l.exec(i[0])[0], l.exec(i[1])[0]] }), 1 === y.length && (y[1] = y[0]), "right" === f.at[0] ? m.left += u : "center" === f.at[0] && (m.left += u / 2), "bottom" === f.at[1] ? m.top += d : "center" === f.at[1] && (m.top += d / 2), p = k(w.at, u, d), m.left += p[0], m.top += p[1], this.each(function () { var i, t, r = x(this), a = r.outerWidth(), l = r.outerHeight(), e = T(this, "marginLeft"), o = T(this, "marginTop"), s = a + e + T(this, "marginRight") + b.width, n = l + o + T(this, "marginBottom") + b.height, h = x.extend({}, m), c = k(w.my, r.outerWidth(), r.outerHeight()); "right" === f.my[0] ? h.left -= a : "center" === f.my[0] && (h.left -= a / 2), "bottom" === f.my[1] ? h.top -= l : "center" === f.my[1] && (h.top -= l / 2), h.left += c[0], h.top += c[1], i = { marginLeft: e, marginTop: o }, x.each(["left", "top"], function (t, e) { x.ui.position[y[t]] && x.ui.position[y[t]][e](h, { targetWidth: u, targetHeight: d, elemWidth: a, elemHeight: l, collisionPosition: i, collisionWidth: s, collisionHeight: n, offset: [p[0] + c[0], p[1] + c[1]], my: f.my, at: f.at, within: _, elem: r }) }), f.using && (t = function (t) { var e = g.left - h.left, i = e + u - a, o = g.top - h.top, s = o + d - l, n = { target: { element: v, left: g.left, top: g.top, width: u, height: d }, element: { element: r, left: h.left, top: h.top, width: a, height: l }, horizontal: i < 0 ? "left" : 0 < e ? "right" : "center", vertical: s < 0 ? "top" : 0 < o ? "bottom" : "middle" }; u < a && C(e + i) < u && (n.horizontal = "center"), d < l && C(o + s) < d && (n.vertical = "middle"), P(C(e), C(i)) > P(C(o), C(s)) ? n.important = "horizontal" : n.important = "vertical", f.using.call(this, t, n) }), r.offset(x.extend(h, { using: t })) })) : i.apply(this, arguments) }, x.ui.position = { fit: { left: function (t, e) { var i, o = e.within, s = o.isWindow ? o.scrollLeft : o.offset.left, o = o.width, n = t.left - e.collisionPosition.marginLeft, r = s - n, a = n + e.collisionWidth - o - s; e.collisionWidth > o ? 0 < r && a <= 0 ? (i = t.left + r + e.collisionWidth - o - s, t.left += r - i) : t.left = !(0 < a && r <= 0) && a < r ? s + o - e.collisionWidth : s : 0 < r ? t.left += r : 0 < a ? t.left -= a : t.left = P(t.left - n, t.left) }, top: function (t, e) { var i, o = e.within, o = o.isWindow ? o.scrollTop : o.offset.top, s = e.within.height, n = t.top - e.collisionPosition.marginTop, r = o - n, a = n + e.collisionHeight - s - o; e.collisionHeight > s ? 0 < r && a <= 0 ? (i = t.top + r + e.collisionHeight - s - o, t.top += r - i) : t.top = !(0 < a && r <= 0) && a < r ? o + s - e.collisionHeight : o : 0 < r ? t.top += r : 0 < a ? t.top -= a : t.top = P(t.top - n, t.top) } }, flip: { left: function (t, e) { var i = e.within, o = i.offset.left + i.scrollLeft, s = i.width, i = i.isWindow ? i.scrollLeft : i.offset.left, n = t.left - e.collisionPosition.marginLeft, r = n - i, n = n + e.collisionWidth - s - i, a = "left" === e.my[0] ? -e.elemWidth : "right" === e.my[0] ? e.elemWidth : 0, l = "left" === e.at[0] ? e.targetWidth : "right" === e.at[0] ? -e.targetWidth : 0, h = -2 * e.offset[0]; r < 0 ? ((s = t.left + a + l + h + e.collisionWidth - s - o) < 0 || s < C(r)) && (t.left += a + l + h) : 0 < n && (0 < (o = t.left - e.collisionPosition.marginLeft + a + l + h - i) || C(o) < n) && (t.left += a + l + h) }, top: function (t, e) { var i = e.within, o = i.offset.top + i.scrollTop, s = i.height, i = i.isWindow ? i.scrollTop : i.offset.top, n = t.top - e.collisionPosition.marginTop, r = n - i, n = n + e.collisionHeight - s - i, a = "top" === e.my[1] ? -e.elemHeight : "bottom" === e.my[1] ? e.elemHeight : 0, l = "top" === e.at[1] ? e.targetHeight : "bottom" === e.at[1] ? -e.targetHeight : 0, h = -2 * e.offset[1]; r < 0 ? ((s = t.top + a + l + h + e.collisionHeight - s - o) < 0 || s < C(r)) && (t.top += a + l + h) : 0 < n && (0 < (o = t.top - e.collisionPosition.marginTop + a + l + h - i) || C(o) < n) && (t.top += a + l + h) } }, flipfit: { left: function () { x.ui.position.flip.left.apply(this, arguments), x.ui.position.fit.left.apply(this, arguments) }, top: function () { x.ui.position.flip.top.apply(this, arguments), x.ui.position.fit.top.apply(this, arguments) } } }; x.ui.position, x.extend(x.expr.pseudos, { data: x.expr.createPseudo ? x.expr.createPseudo(function (e) { return function (t) { return !!x.data(t, e) } }) : function (t, e, i) { return !!x.data(t, i[3]) } }), x.expr.pseudos || (x.expr.pseudos = x.expr[":"]), x.uniqueSort || (x.uniqueSort = x.unique), x.escapeSelector || (e = /([\0-\x1f\x7f]|^-?\d)|^-$|[^\x80-\uFFFF\w-]/g, f = function (t, e) { return e ? "\0" === t ? "" : t.slice(0, -1) + "\\" + t.charCodeAt(t.length - 1).toString(16) + " " : "\\" + t }, x.escapeSelector = function (t) { return (t + "").replace(e, f) }), x.fn.even && x.fn.odd || x.fn.extend({ even: function () { return this.filter(function (t) { return t % 2 == 0 }) }, odd: function () { return this.filter(function (t) { return t % 2 == 1 }) } }), x.ui.keyCode = { BACKSPACE: 8, COMMA: 188, DELETE: 46, DOWN: 40, END: 35, ENTER: 13, ESCAPE: 27, HOME: 36, LEFT: 37, PAGE_DOWN: 34, PAGE_UP: 33, PERIOD: 190, RIGHT: 39, SPACE: 32, TAB: 9, UP: 38 }, x.fn.labels = function () { var t, e, i; return this.length ? this[0].labels && this[0].labels.length ? this.pushStack(this[0].labels) : (e = this.eq(0).parents("label"), (t = this.attr("id")) && (i = (i = this.eq(0).parents().last()).add((i.length ? i : this).siblings()), t = "label[for='" + x.escapeSelector(t) + "']", e = e.add(i.find(t).addBack(t))), this.pushStack(e)) : this.pushStack([]) }, x.fn.scrollParent = function (t) { var e = this.css("position"), i = "absolute" === e, o = t ? /(auto|scroll|hidden)/ : /(auto|scroll)/, t = this.parents().filter(function () { var t = x(this); return (!i || "static" !== t.css("position")) && o.test(t.css("overflow") + t.css("overflow-y") + t.css("overflow-x")) }).eq(0); return "fixed" !== e && t.length ? t : x(this[0].ownerDocument || document) }, x.fn.extend({ uniqueId: (t = 0, function () { return this.each(function () { this.id || (this.id = "ui-id-" + ++t) }) }), removeUniqueId: function () { return this.each(function () { /^ui-id-\d+$/.test(this.id) && x(this).removeAttr("id") }) } }), x.ui.ie = !!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase()); var e, f, t, p = !1, u = (x(document).on("mouseup", function () { p = !1 }), x.widget("ui.mouse", { version: "1.13.3", options: { cancel: "input, textarea, button, select, option", distance: 1, delay: 0 }, _mouseInit: function () { var e = this; this.element.on("mousedown." + this.widgetName, function (t) { return e._mouseDown(t) }).on("click." + this.widgetName, function (t) { if (!0 === x.data(t.target, e.widgetName + ".preventClickEvent")) return x.removeData(t.target, e.widgetName + ".preventClickEvent"), t.stopImmediatePropagation(), !1 }), this.started = !1 }, _mouseDestroy: function () { this.element.off("." + this.widgetName), this._mouseMoveDelegate && this.document.off("mousemove." + this.widgetName, this._mouseMoveDelegate).off("mouseup." + this.widgetName, this._mouseUpDelegate) }, _mouseDown: function (t) { var e, i, o; if (!p) return this._mouseMoved = !1, this._mouseStarted && this._mouseUp(t), i = 1 === (this._mouseDownEvent = t).which, o = !("string" != typeof (e = this).options.cancel || !t.target.nodeName) && x(t.target).closest(this.options.cancel).length, i && !o && this._mouseCapture(t) && (this.mouseDelayMet = !this.options.delay, this.mouseDelayMet || (this._mouseDelayTimer = setTimeout(function () { e.mouseDelayMet = !0 }, this.options.delay)), this._mouseDistanceMet(t) && this._mouseDelayMet(t) && (this._mouseStarted = !1 !== this._mouseStart(t), !this._mouseStarted) ? t.preventDefault() : (!0 === x.data(t.target, this.widgetName + ".preventClickEvent") && x.removeData(t.target, this.widgetName + ".preventClickEvent"), this._mouseMoveDelegate = function (t) { return e._mouseMove(t) }, this._mouseUpDelegate = function (t) { return e._mouseUp(t) }, this.document.on("mousemove." + this.widgetName, this._mouseMoveDelegate).on("mouseup." + this.widgetName, this._mouseUpDelegate), t.preventDefault(), p = !0)), !0 }, _mouseMove: function (t) { if (this._mouseMoved) { if (x.ui.ie && (!document.documentMode || document.documentMode < 9) && !t.button) return this._mouseUp(t); if (!t.which) if (t.originalEvent.altKey || t.originalEvent.ctrlKey || t.originalEvent.metaKey || t.originalEvent.shiftKey) this.ignoreMissingWhich = !0; else if (!this.ignoreMissingWhich) return this._mouseUp(t) } return (t.which || t.button) && (this._mouseMoved = !0), this._mouseStarted ? (this._mouseDrag(t), t.preventDefault()) : (this._mouseDistanceMet(t) && this._mouseDelayMet(t) && (this._mouseStarted = !1 !== this._mouseStart(this._mouseDownEvent, t), this._mouseStarted ? this._mouseDrag(t) : this._mouseUp(t)), !this._mouseStarted) }, _mouseUp: function (t) { this.document.off("mousemove." + this.widgetName, this._mouseMoveDelegate).off("mouseup." + this.widgetName, this._mouseUpDelegate), this._mouseStarted && (this._mouseStarted = !1, t.target === this._mouseDownEvent.target && x.data(t.target, this.widgetName + ".preventClickEvent", !0), this._mouseStop(t)), this._mouseDelayTimer && (clearTimeout(this._mouseDelayTimer), delete this._mouseDelayTimer), this.ignoreMissingWhich = !1, p = !1, t.preventDefault() }, _mouseDistanceMet: function (t) { return Math.max(Math.abs(this._mouseDownEvent.pageX - t.pageX), Math.abs(this._mouseDownEvent.pageY - t.pageY)) >= this.options.distance }, _mouseDelayMet: function () { return this.mouseDelayMet }, _mouseStart: function () { }, _mouseDrag: function () { }, _mouseStop: function () { }, _mouseCapture: function () { return !0 } }), x.ui.plugin = { add: function (t, e, i) { var o, s = x.ui[t].prototype; for (o in i) s.plugins[o] = s.plugins[o] || [], s.plugins[o].push([e, i[o]]) }, call: function (t, e, i, o) { var s, n = t.plugins[e]; if (n && (o || t.element[0].parentNode && 11 !== t.element[0].parentNode.nodeType)) for (s = 0; s < n.length; s++)t.options[n[s][0]] && n[s][1].apply(t.element, i) } }, x.ui.safeActiveElement = function (e) { var i; try { i = e.activeElement } catch (t) { i = e.body } return i = (i = i || e.body).nodeName ? i : e.body }, x.ui.safeBlur = function (t) { t && "body" !== t.nodeName.toLowerCase() && x(t).trigger("blur") }, x.widget("ui.draggable", x.ui.mouse, { version: "1.13.3", widgetEventPrefix: "drag", options: { addClasses: !0, appendTo: "parent", axis: !1, connectToSortable: !1, containment: !1, cursor: "auto", cursorAt: !1, grid: !1, handle: !1, helper: "original", iframeFix: !1, opacity: !1, refreshPositions: !1, revert: !1, revertDuration: 500, scope: "default", scroll: !0, scrollSensitivity: 20, scrollSpeed: 20, snap: !1, snapMode: "both", snapTolerance: 20, stack: !1, zIndex: !1, drag: null, start: null, stop: null }, _create: function () { "original" === this.options.helper && this._setPositionRelative(), this.options.addClasses && this._addClass("ui-draggable"), this._setHandleClassName(), this._mouseInit() }, _setOption: function (t, e) { this._super(t, e), "handle" === t && (this._removeHandleClassName(), this._setHandleClassName()) }, _destroy: function () { (this.helper || this.element).is(".ui-draggable-dragging") ? this.destroyOnClear = !0 : (this._removeHandleClassName(), this._mouseDestroy()) }, _mouseCapture: function (t) { var e = this.options; return !(this.helper || e.disabled || 0 < x(t.target).closest(".ui-resizable-handle").length || (this.handle = this._getHandle(t), !this.handle) || (this._blurActiveElement(t), this._blockFrames(!0 === e.iframeFix ? "iframe" : e.iframeFix), 0)) }, _blockFrames: function (t) { this.iframeBlocks = this.document.find(t).map(function () { var t = x(this); return x("<div>").css("position", "absolute").appendTo(t.parent()).outerWidth(t.outerWidth()).outerHeight(t.outerHeight()).offset(t.offset())[0] }) }, _unblockFrames: function () { this.iframeBlocks && (this.iframeBlocks.remove(), delete this.iframeBlocks) }, _blurActiveElement: function (t) { var e = x.ui.safeActiveElement(this.document[0]); x(t.target).closest(e).length || x.ui.safeBlur(e) }, _mouseStart: function (t) { var e = this.options; return this.helper = this._createHelper(t), this._addClass(this.helper, "ui-draggable-dragging"), this._cacheHelperProportions(), x.ui.ddmanager && (x.ui.ddmanager.current = this), this._cacheMargins(), this.cssPosition = this.helper.css("position"), this.scrollParent = this.helper.scrollParent(!0), this.offsetParent = this.helper.offsetParent(), this.hasFixedAncestor = 0 < this.helper.parents().filter(function () { return "fixed" === x(this).css("position") }).length, this.positionAbs = this.element.offset(), this._refreshOffsets(t), this.originalPosition = this.position = this._generatePosition(t, !1), this.originalPageX = t.pageX, this.originalPageY = t.pageY, e.cursorAt && this._adjustOffsetFromHelper(e.cursorAt), this._setContainment(), !1 === this._trigger("start", t) ? (this._clear(), !1) : (this._cacheHelperProportions(), x.ui.ddmanager && !e.dropBehaviour && x.ui.ddmanager.prepareOffsets(this, t), this._mouseDrag(t, !0), x.ui.ddmanager && x.ui.ddmanager.dragStart(this, t), !0) }, _refreshOffsets: function (t) { this.offset = { top: this.positionAbs.top - this.margins.top, left: this.positionAbs.left - this.margins.left, scroll: !1, parent: this._getParentOffset(), relative: this._getRelativeOffset() }, this.offset.click = { left: t.pageX - this.offset.left, top: t.pageY - this.offset.top } }, _mouseDrag: function (t, e) { if (this.hasFixedAncestor && (this.offset.parent = this._getParentOffset()), this.position = this._generatePosition(t, !0), this.positionAbs = this._convertPositionTo("absolute"), !e) { e = this._uiHash(); if (!1 === this._trigger("drag", t, e)) return this._mouseUp(new x.Event("mouseup", t)), !1; this.position = e.position } return this.helper[0].style.left = this.position.left + "px", this.helper[0].style.top = this.position.top + "px", x.ui.ddmanager && x.ui.ddmanager.drag(this, t), !1 }, _mouseStop: function (t) { var e = this, i = !1; return x.ui.ddmanager && !this.options.dropBehaviour && (i = x.ui.ddmanager.drop(this, t)), this.dropped && (i = this.dropped, this.dropped = !1), "invalid" === this.options.revert && !i || "valid" === this.options.revert && i || !0 === this.options.revert || "function" == typeof this.options.revert && this.options.revert.call(this.element, i) ? x(this.helper).animate(this.originalPosition, parseInt(this.options.revertDuration, 10), function () { !1 !== e._trigger("stop", t) && e._clear() }) : !1 !== this._trigger("stop", t) && this._clear(), !1 }, _mouseUp: function (t) { return this._unblockFrames(), x.ui.ddmanager && x.ui.ddmanager.dragStop(this, t), this.handleElement.is(t.target) && this.element.trigger("focus"), x.ui.mouse.prototype._mouseUp.call(this, t) }, cancel: function () { return this.helper.is(".ui-draggable-dragging") ? this._mouseUp(new x.Event("mouseup", { target: this.element[0] })) : this._clear(), this }, _getHandle: function (t) { return !this.options.handle || !!x(t.target).closest(this.element.find(this.options.handle)).length }, _setHandleClassName: function () { this.handleElement = this.options.handle ? this.element.find(this.options.handle) : this.element, this._addClass(this.handleElement, "ui-draggable-handle") }, _removeHandleClassName: function () { this._removeClass(this.handleElement, "ui-draggable-handle") }, _createHelper: function (t) { var e = this.options, i = "function" == typeof e.helper, t = i ? x(e.helper.apply(this.element[0], [t])) : "clone" === e.helper ? this.element.clone().removeAttr("id") : this.element; return t.parents("body").length || t.appendTo("parent" === e.appendTo ? this.element[0].parentNode : e.appendTo), i && t[0] === this.element[0] && this._setPositionRelative(), t[0] === this.element[0] || /(fixed|absolute)/.test(t.css("position")) || t.css("position", "absolute"), t }, _setPositionRelative: function () { /^(?:r|a|f)/.test(this.element.css("position")) || (this.element[0].style.position = "relative") }, _adjustOffsetFromHelper: function (t) { "string" == typeof t && (t = t.split(" ")), "left" in (t = Array.isArray(t) ? { left: +t[0], top: +t[1] || 0 } : t) && (this.offset.click.left = t.left + this.margins.left), "right" in t && (this.offset.click.left = this.helperProportions.width - t.right + this.margins.left), "top" in t && (this.offset.click.top = t.top + this.margins.top), "bottom" in t && (this.offset.click.top = this.helperProportions.height - t.bottom + this.margins.top) }, _isRootNode: function (t) { return /(html|body)/i.test(t.tagName) || t === this.document[0] }, _getParentOffset: function () { var t = this.offsetParent.offset(), e = this.document[0]; return "absolute" === this.cssPosition && this.scrollParent[0] !== e && x.contains(this.scrollParent[0], this.offsetParent[0]) && (t.left += this.scrollParent.scrollLeft(), t.top += this.scrollParent.scrollTop()), { top: (t = this._isRootNode(this.offsetParent[0]) ? { top: 0, left: 0 } : t).top + (parseInt(this.offsetParent.css("borderTopWidth"), 10) || 0), left: t.left + (parseInt(this.offsetParent.css("borderLeftWidth"), 10) || 0) } }, _getRelativeOffset: function () { var t, e; return "relative" !== this.cssPosition ? { top: 0, left: 0 } : (t = this.element.position(), e = this._isRootNode(this.scrollParent[0]), { top: t.top - (parseInt(this.helper.css("top"), 10) || 0) + (e ? 0 : this.scrollParent.scrollTop()), left: t.left - (parseInt(this.helper.css("left"), 10) || 0) + (e ? 0 : this.scrollParent.scrollLeft()) }) }, _cacheMargins: function () { this.margins = { left: parseInt(this.element.css("marginLeft"), 10) || 0, top: parseInt(this.element.css("marginTop"), 10) || 0, right: parseInt(this.element.css("marginRight"), 10) || 0, bottom: parseInt(this.element.css("marginBottom"), 10) || 0 } }, _cacheHelperProportions: function () { this.helperProportions = { width: this.helper.outerWidth(), height: this.helper.outerHeight() } }, _setContainment: function () { var t, e = this.options, i = this.document[0]; this.relativeContainer = null, e.containment ? "window" === e.containment ? this.containment = [x(window).scrollLeft() - this.offset.relative.left - this.offset.parent.left, x(window).scrollTop() - this.offset.relative.top - this.offset.parent.top, x(window).scrollLeft() + x(window).width() - this.helperProportions.width - this.margins.left, x(window).scrollTop() + (x(window).height() || i.body.parentNode.scrollHeight) - this.helperProportions.height - this.margins.top] : "document" === e.containment ? this.containment = [0, 0, x(i).width() - this.helperProportions.width - this.margins.left, (x(i).height() || i.body.parentNode.scrollHeight) - this.helperProportions.height - this.margins.top] : e.containment.constructor === Array ? this.containment = e.containment : ("parent" === e.containment && (e.containment = this.helper[0].parentNode), (e = (i = x(e.containment))[0]) && (t = /(scroll|auto)/.test(i.css("overflow")), this.containment = [(parseInt(i.css("borderLeftWidth"), 10) || 0) + (parseInt(i.css("paddingLeft"), 10) || 0), (parseInt(i.css("borderTopWidth"), 10) || 0) + (parseInt(i.css("paddingTop"), 10) || 0), (t ? Math.max(e.scrollWidth, e.offsetWidth) : e.offsetWidth) - (parseInt(i.css("borderRightWidth"), 10) || 0) - (parseInt(i.css("paddingRight"), 10) || 0) - this.helperProportions.width - this.margins.left - this.margins.right, (t ? Math.max(e.scrollHeight, e.offsetHeight) : e.offsetHeight) - (parseInt(i.css("borderBottomWidth"), 10) || 0) - (parseInt(i.css("paddingBottom"), 10) || 0) - this.helperProportions.height - this.margins.top - this.margins.bottom], this.relativeContainer = i)) : this.containment = null }, _convertPositionTo: function (t, e) { e = e || this.position; var t = "absolute" === t ? 1 : -1, i = this._isRootNode(this.scrollParent[0]); return { top: e.top + this.offset.relative.top * t + this.offset.parent.top * t - ("fixed" === this.cssPosition ? -this.offset.scroll.top : i ? 0 : this.offset.scroll.top) * t, left: e.left + this.offset.relative.left * t + this.offset.parent.left * t - ("fixed" === this.cssPosition ? -this.offset.scroll.left : i ? 0 : this.offset.scroll.left) * t } }, _generatePosition: function (t, e) { var i, o = this.options, s = this._isRootNode(this.scrollParent[0]), n = t.pageX, r = t.pageY; return s && this.offset.scroll || (this.offset.scroll = { top: this.scrollParent.scrollTop(), left: this.scrollParent.scrollLeft() }), { top: (r = e && (this.containment && (i = this.relativeContainer ? (e = this.relativeContainer.offset(), [this.containment[0] + e.left, this.containment[1] + e.top, this.containment[2] + e.left, this.containment[3] + e.top]) : this.containment, t.pageX - this.offset.click.left < i[0] && (n = i[0] + this.offset.click.left), t.pageY - this.offset.click.top < i[1] && (r = i[1] + this.offset.click.top), t.pageX - this.offset.click.left > i[2] && (n = i[2] + this.offset.click.left), t.pageY - this.offset.click.top > i[3]) && (r = i[3] + this.offset.click.top), o.grid && (e = o.grid[1] ? this.originalPageY + Math.round((r - this.originalPageY) / o.grid[1]) * o.grid[1] : this.originalPageY, r = !i || e - this.offset.click.top >= i[1] || e - this.offset.click.top > i[3] ? e : e - this.offset.click.top >= i[1] ? e - o.grid[1] : e + o.grid[1], t = o.grid[0] ? this.originalPageX + Math.round((n - this.originalPageX) / o.grid[0]) * o.grid[0] : this.originalPageX, n = !i || t - this.offset.click.left >= i[0] || t - this.offset.click.left > i[2] ? t : t - this.offset.click.left >= i[0] ? t - o.grid[0] : t + o.grid[0]), "y" === o.axis && (n = this.originalPageX), "x" === o.axis) ? this.originalPageY : r) - this.offset.click.top - this.offset.relative.top - this.offset.parent.top + ("fixed" === this.cssPosition ? -this.offset.scroll.top : s ? 0 : this.offset.scroll.top), left: n - this.offset.click.left - this.offset.relative.left - this.offset.parent.left + ("fixed" === this.cssPosition ? -this.offset.scroll.left : s ? 0 : this.offset.scroll.left) } }, _clear: function () { this._removeClass(this.helper, "ui-draggable-dragging"), this.helper[0] === this.element[0] || this.cancelHelperRemoval || this.helper.remove(), this.helper = null, this.cancelHelperRemoval = !1, this.destroyOnClear && this.destroy() }, _trigger: function (t, e, i) { return i = i || this._uiHash(), x.ui.plugin.call(this, t, [e, i, this], !0), /^(drag|start|stop)/.test(t) && (this.positionAbs = this._convertPositionTo("absolute"), i.offset = this.positionAbs), x.Widget.prototype._trigger.call(this, t, e, i) }, plugins: {}, _uiHash: function () { return { helper: this.helper, position: this.position, originalPosition: this.originalPosition, offset: this.positionAbs } } }), x.ui.plugin.add("draggable", "connectToSortable", { start: function (e, t, i) { var o = x.extend({}, t, { item: i.element }); i.sortables = [], x(i.options.connectToSortable).each(function () { var t = x(this).sortable("instance"); t && !t.options.disabled && (i.sortables.push(t), t.refreshPositions(), t._trigger("activate", e, o)) }) }, stop: function (e, t, i) { var o = x.extend({}, t, { item: i.element }); i.cancelHelperRemoval = !1, x.each(i.sortables, function () { var t = this; t.isOver ? (t.isOver = 0, i.cancelHelperRemoval = !0, t.cancelHelperRemoval = !1, t._storedCSS = { position: t.placeholder.css("position"), top: t.placeholder.css("top"), left: t.placeholder.css("left") }, t._mouseStop(e), t.options.helper = t.options._helper) : (t.cancelHelperRemoval = !0, t._trigger("deactivate", e, o)) }) }, drag: function (i, o, s) { x.each(s.sortables, function () { var t = !1, e = this; e.positionAbs = s.positionAbs, e.helperProportions = s.helperProportions, e.offset.click = s.offset.click, e._intersectsWith(e.containerCache) && (t = !0, x.each(s.sortables, function () { return this.positionAbs = s.positionAbs, this.helperProportions = s.helperProportions, this.offset.click = s.offset.click, t = this !== e && this._intersectsWith(this.containerCache) && x.contains(e.element[0], this.element[0]) ? !1 : t })), t ? (e.isOver || (e.isOver = 1, s._parent = o.helper.parent(), e.currentItem = o.helper.appendTo(e.element).data("ui-sortable-item", !0), e.options._helper = e.options.helper, e.options.helper = function () { return o.helper[0] }, i.target = e.currentItem[0], e._mouseCapture(i, !0), e._mouseStart(i, !0, !0), e.offset.click.top = s.offset.click.top, e.offset.click.left = s.offset.click.left, e.offset.parent.left -= s.offset.parent.left - e.offset.parent.left, e.offset.parent.top -= s.offset.parent.top - e.offset.parent.top, s._trigger("toSortable", i), s.dropped = e.element, x.each(s.sortables, function () { this.refreshPositions() }), s.currentItem = s.element, e.fromOutside = s), e.currentItem && (e._mouseDrag(i), o.position = e.position)) : e.isOver && (e.isOver = 0, e.cancelHelperRemoval = !0, e.options._revert = e.options.revert, e.options.revert = !1, e._trigger("out", i, e._uiHash(e)), e._mouseStop(i, !0), e.options.revert = e.options._revert, e.options.helper = e.options._helper, e.placeholder && e.placeholder.remove(), o.helper.appendTo(s._parent), s._refreshOffsets(i), o.position = s._generatePosition(i, !0), s._trigger("fromSortable", i), s.dropped = !1, x.each(s.sortables, function () { this.refreshPositions() })) }) } }), x.ui.plugin.add("draggable", "cursor", { start: function (t, e, i) { var o = x("body"), i = i.options; o.css("cursor") && (i._cursor = o.css("cursor")), o.css("cursor", i.cursor) }, stop: function (t, e, i) { i = i.options; i._cursor && x("body").css("cursor", i._cursor) } }), x.ui.plugin.add("draggable", "opacity", { start: function (t, e, i) { e = x(e.helper), i = i.options; e.css("opacity") && (i._opacity = e.css("opacity")), e.css("opacity", i.opacity) }, stop: function (t, e, i) { i = i.options; i._opacity && x(e.helper).css("opacity", i._opacity) } }), x.ui.plugin.add("draggable", "scroll", { start: function (t, e, i) { i.scrollParentNotHidden || (i.scrollParentNotHidden = i.helper.scrollParent(!1)), i.scrollParentNotHidden[0] !== i.document[0] && "HTML" !== i.scrollParentNotHidden[0].tagName && (i.overflowOffset = i.scrollParentNotHidden.offset()) }, drag: function (t, e, i) { var o = i.options, s = !1, n = i.scrollParentNotHidden[0], r = i.document[0]; n !== r && "HTML" !== n.tagName ? (o.axis && "x" === o.axis || (i.overflowOffset.top + n.offsetHeight - t.pageY < o.scrollSensitivity ? n.scrollTop = s = n.scrollTop + o.scrollSpeed : t.pageY - i.overflowOffset.top < o.scrollSensitivity && (n.scrollTop = s = n.scrollTop - o.scrollSpeed)), o.axis && "y" === o.axis || (i.overflowOffset.left + n.offsetWidth - t.pageX < o.scrollSensitivity ? n.scrollLeft = s = n.scrollLeft + o.scrollSpeed : t.pageX - i.overflowOffset.left < o.scrollSensitivity && (n.scrollLeft = s = n.scrollLeft - o.scrollSpeed))) : (o.axis && "x" === o.axis || (t.pageY - x(r).scrollTop() < o.scrollSensitivity ? s = x(r).scrollTop(x(r).scrollTop() - o.scrollSpeed) : x(window).height() - (t.pageY - x(r).scrollTop()) < o.scrollSensitivity && (s = x(r).scrollTop(x(r).scrollTop() + o.scrollSpeed))), o.axis && "y" === o.axis || (t.pageX - x(r).scrollLeft() < o.scrollSensitivity ? s = x(r).scrollLeft(x(r).scrollLeft() - o.scrollSpeed) : x(window).width() - (t.pageX - x(r).scrollLeft()) < o.scrollSensitivity && (s = x(r).scrollLeft(x(r).scrollLeft() + o.scrollSpeed)))), !1 !== s && x.ui.ddmanager && !o.dropBehaviour && x.ui.ddmanager.prepareOffsets(i, t) } }), x.ui.plugin.add("draggable", "snap", { start: function (t, e, i) { var o = i.options; i.snapElements = [], x(o.snap.constructor !== String ? o.snap.items || ":data(ui-draggable)" : o.snap).each(function () { var t = x(this), e = t.offset(); this !== i.element[0] && i.snapElements.push({ item: this, width: t.outerWidth(), height: t.outerHeight(), top: e.top, left: e.left }) }) }, drag: function (t, e, i) { for (var o, s, n, r, a, l, h, c, f, p = i.options, u = p.snapTolerance, d = e.offset.left, g = d + i.helperProportions.width, m = e.offset.top, v = m + i.helperProportions.height, _ = i.snapElements.length - 1; 0 <= _; _--)l = (a = i.snapElements[_].left - i.margins.left) + i.snapElements[_].width, c = (h = i.snapElements[_].top - i.margins.top) + i.snapElements[_].height, g < a - u || l + u < d || v < h - u || c + u < m || !x.contains(i.snapElements[_].item.ownerDocument, i.snapElements[_].item) ? (i.snapElements[_].snapping && i.options.snap.release && i.options.snap.release.call(i.element, t, x.extend(i._uiHash(), { snapItem: i.snapElements[_].item })), i.snapElements[_].snapping = !1) : ("inner" !== p.snapMode && (o = Math.abs(h - v) <= u, s = Math.abs(c - m) <= u, n = Math.abs(a - g) <= u, r = Math.abs(l - d) <= u, o && (e.position.top = i._convertPositionTo("relative", { top: h - i.helperProportions.height, left: 0 }).top), s && (e.position.top = i._convertPositionTo("relative", { top: c, left: 0 }).top), n && (e.position.left = i._convertPositionTo("relative", { top: 0, left: a - i.helperProportions.width }).left), r) && (e.position.left = i._convertPositionTo("relative", { top: 0, left: l }).left), f = o || s || n || r, "outer" !== p.snapMode && (o = Math.abs(h - m) <= u, s = Math.abs(c - v) <= u, n = Math.abs(a - d) <= u, r = Math.abs(l - g) <= u, o && (e.position.top = i._convertPositionTo("relative", { top: h, left: 0 }).top), s && (e.position.top = i._convertPositionTo("relative", { top: c - i.helperProportions.height, left: 0 }).top), n && (e.position.left = i._convertPositionTo("relative", { top: 0, left: a }).left), r) && (e.position.left = i._convertPositionTo("relative", { top: 0, left: l - i.helperProportions.width }).left), !i.snapElements[_].snapping && (o || s || n || r || f) && i.options.snap.snap && i.options.snap.snap.call(i.element, t, x.extend(i._uiHash(), { snapItem: i.snapElements[_].item })), i.snapElements[_].snapping = o || s || n || r || f) } }), x.ui.plugin.add("draggable", "stack", { start: function (t, e, i) { var o, i = i.options, i = x.makeArray(x(i.stack)).sort(function (t, e) { return (parseInt(x(t).css("zIndex"), 10) || 0) - (parseInt(x(e).css("zIndex"), 10) || 0) }); i.length && (o = parseInt(x(i[0]).css("zIndex"), 10) || 0, x(i).each(function (t) { x(this).css("zIndex", o + t) }), this.css("zIndex", o + i.length)) } }), x.ui.plugin.add("draggable", "zIndex", { start: function (t, e, i) { e = x(e.helper), i = i.options; e.css("zIndex") && (i._zIndex = e.css("zIndex")), e.css("zIndex", i.zIndex) }, stop: function (t, e, i) { i = i.options; i._zIndex && x(e.helper).css("zIndex", i._zIndex) } }), x.ui.draggable, x), d = {}, R = d.toString, B = /^([\-+])=\s*(\d+\.?\d*)/, F = [{ re: /rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/, parse: function (t) { return [t[1], t[2], t[3], t[4]] } }, { re: /rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/, parse: function (t) { return [2.55 * t[1], 2.55 * t[2], 2.55 * t[3], t[4]] } }, { re: /#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})?/, parse: function (t) { return [parseInt(t[1], 16), parseInt(t[2], 16), parseInt(t[3], 16), t[4] ? (parseInt(t[4], 16) / 255).toFixed(2) : 1] } }, { re: /#([a-f0-9])([a-f0-9])([a-f0-9])([a-f0-9])?/, parse: function (t) { return [parseInt(t[1] + t[1], 16), parseInt(t[2] + t[2], 16), parseInt(t[3] + t[3], 16), t[4] ? (parseInt(t[4] + t[4], 16) / 255).toFixed(2) : 1] } }, { re: /hsla?\(\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/, space: "hsla", parse: function (t) { return [t[1], t[2] / 100, t[3] / 100, t[4]] } }], g = u.Color = function (t, e, i, o) { return new u.Color.fn.parse(t, e, i, o) }, m = { rgba: { props: { red: { idx: 0, type: "byte" }, green: { idx: 1, type: "byte" }, blue: { idx: 2, type: "byte" } } }, hsla: { props: { hue: { idx: 0, type: "degrees" }, saturation: { idx: 1, type: "percent" }, lightness: { idx: 2, type: "percent" } } } }, v = { byte: { floor: !0, max: 255 }, percent: { max: 1 }, degrees: { mod: 360, floor: !0 } }, _ = g.support = {}, j = u("<p>")[0], b = u.each; function y(t) { return null == t ? t + "" : "object" == typeof t ? d[R.call(t)] || "object" : typeof t } function w(t, e, i) { var o = v[e.type] || {}; return null == t ? i || !e.def ? null : e.def : (t = o.floor ? ~~t : parseFloat(t), isNaN(t) ? e.def : o.mod ? (t + o.mod) % o.mod : Math.min(o.max, Math.max(0, t))) } function z(o) { var s = g(), n = s._rgba = []; return o = o.toLowerCase(), b(F, function (t, e) { var i = e.re.exec(o), i = i && e.parse(i), e = e.space || "rgba"; if (i) return i = s[e](i), s[m[e].cache] = i[m[e].cache], n = s._rgba = i._rgba, !1 }), n.length ? ("0,0,0,0" === n.join() && u.extend(n, W.transparent), s) : W[o] } function E(t, e, i) { return 6 * (i = (i + 1) % 1) < 1 ? t + (e - t) * i * 6 : 2 * i < 1 ? e : 3 * i < 2 ? t + (e - t) * (2 / 3 - i) * 6 : t } j.style.cssText = "background-color:rgba(1,1,1,.5)", _.rgba = -1 < j.style.backgroundColor.indexOf("rgba"), b(m, function (t, e) { e.cache = "_" + t, e.props.alpha = { idx: 3, type: "percent", def: 1 } }), u.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "), function (t, e) { d["[object " + e + "]"] = e.toLowerCase() }), (g.fn = u.extend(g.prototype, { parse: function (s, t, e, i) { if (void 0 === s) return this._rgba = [null, null, null, null], this; (s.jquery || s.nodeType) && (s = u(s).css(t), t = void 0); var n = this, o = y(s), r = this._rgba = []; return void 0 !== t && (s = [s, t, e, i], o = "array"), "string" === o ? this.parse(z(s) || W._default) : "array" === o ? (b(m.rgba.props, function (t, e) { r[e.idx] = w(s[e.idx], e) }), this) : "object" === o ? (s instanceof g ? b(m, function (t, e) { s[e.cache] && (n[e.cache] = s[e.cache].slice()) }) : b(m, function (t, i) { var o = i.cache; b(i.props, function (t, e) { if (!n[o] && i.to) { if ("alpha" === t || null == s[t]) return; n[o] = i.to(n._rgba) } n[o][e.idx] = w(s[t], e, !0) }), n[o] && u.inArray(null, n[o].slice(0, 3)) < 0 && (null == n[o][3] && (n[o][3] = 1), i.from) && (n._rgba = i.from(n[o])) }), this) : void 0 }, is: function (t) { var s = g(t), n = !0, r = this; return b(m, function (t, e) { var i, o = s[e.cache]; return o && (i = r[e.cache] || e.to && e.to(r._rgba) || [], b(e.props, function (t, e) { if (null != o[e.idx]) return n = o[e.idx] === i[e.idx] })), n }), n }, _space: function () { var i = [], o = this; return b(m, function (t, e) { o[e.cache] && i.push(t) }), i.pop() }, transition: function (t, r) { var t = (h = g(t))._space(), e = m[t], i = 0 === this.alpha() ? g("transparent") : this, a = i[e.cache] || e.to(i._rgba), l = a.slice(), h = h[e.cache]; return b(e.props, function (t, e) { var i = e.idx, o = a[i], s = h[i], n = v[e.type] || {}; null !== s && (null === o ? l[i] = s : (n.mod && (s - o > n.mod / 2 ? o += n.mod : o - s > n.mod / 2 && (o -= n.mod)), l[i] = w((s - o) * r + o, e))) }), this[t](l) }, blend: function (t) { var e, i, o; return 1 === this._rgba[3] ? this : (e = this._rgba.slice(), i = e.pop(), o = g(t)._rgba, g(u.map(e, function (t, e) { return (1 - i) * o[e] + i * t }))) }, toRgbaString: function () { var t = "rgba(", e = u.map(this._rgba, function (t, e) { return null != t ? t : 2 < e ? 1 : 0 }); return 1 === e[3] && (e.pop(), t = "rgb("), t + e.join() + ")" }, toHslaString: function () { var t = "hsla(", e = u.map(this.hsla(), function (t, e) { return null == t && (t = 2 < e ? 1 : 0), t = e && e < 3 ? Math.round(100 * t) + "%" : t }); return 1 === e[3] && (e.pop(), t = "hsl("), t + e.join() + ")" }, toHexString: function (t) { var e = this._rgba.slice(), i = e.pop(); return t && e.push(~~(255 * i)), "#" + u.map(e, function (t) { return 1 === (t = (t || 0).toString(16)).length ? "0" + t : t }).join("") }, toString: function () { return 0 === this._rgba[3] ? "transparent" : this.toRgbaString() } })).parse.prototype = g.fn, m.hsla.to = function (t) { var e, i, o, s, n, r, a, l; return null == t[0] || null == t[1] || null == t[2] ? [null, null, null, t[3]] : (e = t[0] / 255, i = t[1] / 255, o = t[2] / 255, t = t[3], s = (l = Math.max(e, i, o)) - (a = Math.min(e, i, o)), r = .5 * (n = l + a), a = a === l ? 0 : e === l ? 60 * (i - o) / s + 360 : i === l ? 60 * (o - e) / s + 120 : 60 * (e - i) / s + 240, l = 0 == s ? 0 : r <= .5 ? s / n : s / (2 - n), [Math.round(a) % 360, l, r, null == t ? 1 : t]) }, m.hsla.from = function (t) { var e, i, o; return null == t[0] || null == t[1] || null == t[2] ? [null, null, null, t[3]] : (e = t[0] / 360, o = t[1], i = t[2], t = t[3], o = 2 * i - (i = i <= .5 ? i * (1 + o) : i + o - i * o), [Math.round(255 * E(o, i, e + 1 / 3)), Math.round(255 * E(o, i, e)), Math.round(255 * E(o, i, e - 1 / 3)), t]) }, b(m, function (a, t) { var e = t.props, n = t.cache, r = t.to, l = t.from; g.fn[a] = function (t) { var i, o, s; return r && !this[n] && (this[n] = r(this._rgba)), void 0 === t ? this[n].slice() : (i = y(t), o = "array" === i || "object" === i ? t : arguments, s = this[n].slice(), b(e, function (t, e) { t = o["object" === i ? t : e.idx]; null == t && (t = s[e.idx]), s[e.idx] = w(t, e) }), l ? ((t = g(l(s)))[n] = s, t) : g(s)) }, b(e, function (n, r) { g.fn[n] || (g.fn[n] = function (t) { var e = y(t), i = "alpha" === n ? this._hsla ? "hsla" : "rgba" : a, o = this[i](), s = o[r.idx]; return "undefined" === e ? s : ("function" === e && (e = y(t = t.call(this, s))), null == t && r.empty ? this : ("string" === e && (e = B.exec(t)) && (t = s + parseFloat(e[2]) * ("+" === e[1] ? 1 : -1)), o[r.idx] = t, this[i](o))) }) }) }), (g.hook = function (t) { t = t.split(" "); b(t, function (t, n) { u.cssHooks[n] = { set: function (t, e) { var i, o, s = ""; if ("transparent" !== e && ("string" !== y(e) || (i = z(e)))) { if (e = g(i || e), !_.rgba && 1 !== e._rgba[3]) { for (o = "backgroundColor" === n ? t.parentNode : t; ("" === s || "transparent" === s) && o && o.style;)try { s = u.css(o, "backgroundColor"), o = o.parentNode } catch (t) { } e = e.blend(s && "transparent" !== s ? s : "_default") } e = e.toRgbaString() } try { t.style[n] = e } catch (t) { } } }, u.fx.step[n] = function (t) { t.colorInit || (t.start = g(t.elem, n), t.end = g(t.end), t.colorInit = !0), u.cssHooks[n].set(t.elem, t.start.transition(t.end, t.pos)) } }) })("backgroundColor borderBottomColor borderLeftColor borderRightColor borderTopColor color columnRuleColor outlineColor textDecorationColor textEmphasisColor"), u.cssHooks.borderColor = { expand: function (i) { var o = {}; return b(["Top", "Right", "Bottom", "Left"], function (t, e) { o["border" + e + "Color"] = i }), o } }; var q, U, X, Y, K, $, Q, G, V, H, W = u.Color.names = { aqua: "#00ffff", black: "#000000", blue: "#0000ff", fuchsia: "#ff00ff", gray: "#808080", green: "#008000", lime: "#00ff00", maroon: "#800000", navy: "#000080", olive: "#808000", purple: "#800080", red: "#ff0000", silver: "#c0c0c0", teal: "#008080", white: "#ffffff", yellow: "#ffff00", transparent: [null, null, null, 0], _default: "#ffffff" }, D = "ui-effects-", N = "ui-effects-style", I = "ui-effects-animated"; function J(t) { var e, i, o = t.ownerDocument.defaultView ? t.ownerDocument.defaultView.getComputedStyle(t, null) : t.currentStyle, s = {}; if (o && o.length && o[0] && o[o[0]]) for (i = o.length; i--;)"string" == typeof o[e = o[i]] && (s[e.replace(/-([\da-z])/gi, function (t, e) { return e.toUpperCase() })] = o[e]); else for (e in o) "string" == typeof o[e] && (s[e] = o[e]); return s } function M(t, e, i, o) { return t = { effect: t = x.isPlainObject(t) ? (e = t).effect : t }, "function" == typeof (e = null == e ? {} : e) && (o = e, i = null, e = {}), "number" != typeof e && !x.fx.speeds[e] || (o = i, i = e, e = {}), "function" == typeof i && (o = i, i = null), e && x.extend(t, e), i = i || e.duration, t.duration = x.fx.off ? 0 : "number" == typeof i ? i : i in x.fx.speeds ? x.fx.speeds[i] : x.fx.speeds._default, t.complete = o || e.complete, t } function O(t) { return !t || "number" == typeof t || x.fx.speeds[t] || "string" == typeof t && !x.effects.effect[t] || "function" == typeof t || "object" == typeof t && !t.effect } function Z(t, e) { var i = e.outerWidth(), e = e.outerHeight(), t = /^rect\((-?\d*\.?\d*px|-?\d+%|auto),?\s*(-?\d*\.?\d*px|-?\d+%|auto),?\s*(-?\d*\.?\d*px|-?\d+%|auto),?\s*(-?\d*\.?\d*px|-?\d+%|auto)\)$/.exec(t) || ["", 0, i, e, 0]; return { top: parseFloat(t[1]) || 0, right: "auto" === t[2] ? i : parseFloat(t[2]), bottom: "auto" === t[3] ? e : parseFloat(t[3]), left: parseFloat(t[4]) || 0 } } x.effects = { effect: {} }, Y = ["add", "remove", "toggle"], K = { border: 1, borderBottom: 1, borderColor: 1, borderLeft: 1, borderRight: 1, borderTop: 1, borderWidth: 1, margin: 1, padding: 1 }, x.each(["borderLeftStyle", "borderRightStyle", "borderBottomStyle", "borderTopStyle"], function (t, e) { x.fx.step[e] = function (t) { ("none" !== t.end && !t.setAttr || 1 === t.pos && !t.setAttr) && (u.style(t.elem, e, t.end), t.setAttr = !0) } }), x.fn.addBack || (x.fn.addBack = function (t) { return this.add(null == t ? this.prevObject : this.prevObject.filter(t)) }), x.effects.animateClass = function (s, t, e, i) { var n = x.speed(t, e, i); return this.queue(function () { var i = x(this), t = i.attr("class") || "", e = (e = n.children ? i.find("*").addBack() : i).map(function () { return { el: x(this), start: J(this) } }), o = function () { x.each(Y, function (t, e) { s[e] && i[e + "Class"](s[e]) }) }; o(), e = e.map(function () { return this.end = J(this.el[0]), this.diff = function (t, e) { var i, o, s = {}; for (i in e) o = e[i], t[i] === o || K[i] || !x.fx.step[i] && isNaN(parseFloat(o)) || (s[i] = o); return s }(this.start, this.end), this }), i.attr("class", t), e = e.map(function () { var t = this, e = x.Deferred(), i = x.extend({}, n, { queue: !1, complete: function () { e.resolve(t) } }); return this.el.animate(this.diff, i), e.promise() }), x.when.apply(x, e.get()).done(function () { o(), x.each(arguments, function () { var e = this.el; x.each(this.diff, function (t) { e.css(t, "") }) }), n.complete.call(i[0]) }) }) }, x.fn.extend({ addClass: (X = x.fn.addClass, function (t, e, i, o) { return e ? x.effects.animateClass.call(this, { add: t }, e, i, o) : X.apply(this, arguments) }), removeClass: (U = x.fn.removeClass, function (t, e, i, o) { return 1 < arguments.length ? x.effects.animateClass.call(this, { remove: t }, e, i, o) : U.apply(this, arguments) }), toggleClass: (q = x.fn.toggleClass, function (t, e, i, o, s) { return "boolean" == typeof e || void 0 === e ? i ? x.effects.animateClass.call(this, e ? { add: t } : { remove: t }, i, o, s) : q.apply(this, arguments) : x.effects.animateClass.call(this, { toggle: t }, e, i, o) }), switchClass: function (t, e, i, o, s) { return x.effects.animateClass.call(this, { add: e, remove: t }, i, o, s) } }), x.expr && x.expr.pseudos && x.expr.pseudos.animated && (x.expr.pseudos.animated = ($ = x.expr.pseudos.animated, function (t) { return !!x(t).data(I) || $(t) })), !1 !== x.uiBackCompat && x.extend(x.effects, { save: function (t, e) { for (var i = 0, o = e.length; i < o; i++)null !== e[i] && t.data(D + e[i], t[0].style[e[i]]) }, restore: function (t, e) { for (var i, o = 0, s = e.length; o < s; o++)null !== e[o] && (i = t.data(D + e[o]), t.css(e[o], i)) }, setMode: function (t, e) { return e = "toggle" === e ? t.is(":hidden") ? "show" : "hide" : e }, createWrapper: function (i) { if (i.parent().is(".ui-effects-wrapper")) return i.parent(); var o = { width: i.outerWidth(!0), height: i.outerHeight(!0), float: i.css("float") }, t = x("<div></div>").addClass("ui-effects-wrapper").css({ fontSize: "100%", background: "transparent", border: "none", margin: 0, padding: 0 }), e = { width: i.width(), height: i.height() }, s = document.activeElement; try { s.id } catch (t) { s = document.body } return i.wrap(t), i[0] !== s && !x.contains(i[0], s) || x(s).trigger("focus"), t = i.parent(), "static" === i.css("position") ? (t.css({ position: "relative" }), i.css({ position: "relative" })) : (x.extend(o, { position: i.css("position"), zIndex: i.css("z-index") }), x.each(["top", "left", "bottom", "right"], function (t, e) { o[e] = i.css(e), isNaN(parseInt(o[e], 10)) && (o[e] = "auto") }), i.css({ position: "relative", top: 0, left: 0, right: "auto", bottom: "auto" })), i.css(e), t.css(o).show() }, removeWrapper: function (t) { var e = document.activeElement; return t.parent().is(".ui-effects-wrapper") && (t.parent().replaceWith(t), t[0] !== e && !x.contains(t[0], e) || x(e).trigger("focus")), t } }), x.extend(x.effects, { version: "1.13.3", define: function (t, e, i) { return i || (i = e, e = "effect"), x.effects.effect[t] = i, x.effects.effect[t].mode = e, i }, scaledDimensions: function (t, e, i) { var o; return 0 === e ? { height: 0, width: 0, outerHeight: 0, outerWidth: 0 } : (o = "horizontal" !== i ? (e || 100) / 100 : 1, i = "vertical" !== i ? (e || 100) / 100 : 1, { height: t.height() * i, width: t.width() * o, outerHeight: t.outerHeight() * i, outerWidth: t.outerWidth() * o }) }, clipToBox: function (t) { return { width: t.clip.right - t.clip.left, height: t.clip.bottom - t.clip.top, left: t.clip.left, top: t.clip.top } }, unshift: function (t, e, i) { var o = t.queue(); 1 < e && o.splice.apply(o, [1, 0].concat(o.splice(e, i))), t.dequeue() }, saveStyle: function (t) { t.data(N, t[0].style.cssText) }, restoreStyle: function (t) { t[0].style.cssText = t.data(N) || "", t.removeData(N) }, mode: function (t, e) { t = t.is(":hidden"); return "toggle" === e && (e = t ? "show" : "hide"), e = (t ? "hide" === e : "show" === e) ? "none" : e }, getBaseline: function (t, e) { var i, o; switch (t[0]) { case "top": i = 0; break; case "middle": i = .5; break; case "bottom": i = 1; break; default: i = t[0] / e.height }switch (t[1]) { case "left": o = 0; break; case "center": o = .5; break; case "right": o = 1; break; default: o = t[1] / e.width }return { x: o, y: i } }, createPlaceholder: function (t) { var e, i = t.css("position"), o = t.position(); return t.css({ marginTop: t.css("marginTop"), marginBottom: t.css("marginBottom"), marginLeft: t.css("marginLeft"), marginRight: t.css("marginRight") }).outerWidth(t.outerWidth()).outerHeight(t.outerHeight()), /^(static|relative)/.test(i) && (i = "absolute", e = x("<" + t[0].nodeName + ">").insertAfter(t).css({ display: /^(inline|ruby)/.test(t.css("display")) ? "inline-block" : "block", visibility: "hidden", marginTop: t.css("marginTop"), marginBottom: t.css("marginBottom"), marginLeft: t.css("marginLeft"), marginRight: t.css("marginRight"), float: t.css("float") }).outerWidth(t.outerWidth()).outerHeight(t.outerHeight()).addClass("ui-effects-placeholder"), t.data(D + "placeholder", e)), t.css({ position: i, left: o.left, top: o.top }), e }, removePlaceholder: function (t) { var e = D + "placeholder", i = t.data(e); i && (i.remove(), t.removeData(e)) }, cleanUp: function (t) { x.effects.restoreStyle(t), x.effects.removePlaceholder(t) }, setTransition: function (o, t, s, n) { return n = n || {}, x.each(t, function (t, e) { var i = o.cssUnit(e); 0 < i[0] && (n[e] = i[0] * s + i[1]) }), n } }), x.fn.extend({ effect: function () { function t(t) { var e = x(this), i = x.effects.mode(e, a) || n; e.data(I, !0), l.push(i), n && ("show" === i || i === n && "hide" === i) && e.show(), n && "none" === i || x.effects.saveStyle(e), "function" == typeof t && t() } var o = M.apply(this, arguments), s = x.effects.effect[o.effect], n = s.mode, e = o.queue, i = e || "fx", r = o.complete, a = o.mode, l = []; return x.fx.off || !s ? a ? this[a](o.duration, r) : this.each(function () { r && r.call(this) }) : !1 === e ? this.each(t).each(h) : this.queue(i, t).queue(i, h); function h(t) { var e = x(this); function i() { "function" == typeof r && r.call(e[0]), "function" == typeof t && t() } o.mode = l.shift(), !1 === x.uiBackCompat || n ? "none" === o.mode ? (e[a](), i()) : s.call(e[0], o, function () { e.removeData(I), x.effects.cleanUp(e), "hide" === o.mode && e.hide(), i() }) : (e.is(":hidden") ? "hide" === a : "show" === a) ? (e[a](), i()) : s.call(e[0], o, i) } }, show: (V = x.fn.show, function (t) { return O(t) ? V.apply(this, arguments) : ((t = M.apply(this, arguments)).mode = "show", this.effect.call(this, t)) }), hide: (G = x.fn.hide, function (t) { return O(t) ? G.apply(this, arguments) : ((t = M.apply(this, arguments)).mode = "hide", this.effect.call(this, t)) }), toggle: (Q = x.fn.toggle, function (t) { return O(t) || "boolean" == typeof t ? Q.apply(this, arguments) : ((t = M.apply(this, arguments)).mode = "toggle", this.effect.call(this, t)) }), cssUnit: function (t) { var i = this.css(t), o = []; return x.each(["em", "px", "%", "pt"], function (t, e) { 0 < i.indexOf(e) && (o = [parseFloat(i), e]) }), o }, cssClip: function (t) { return t ? this.css("clip", "rect(" + t.top + "px " + t.right + "px " + t.bottom + "px " + t.left + "px)") : Z(this.css("clip"), this) }, transfer: function (t, e) { var i = x(this), o = x(t.to), s = "fixed" === o.css("position"), n = x("body"), r = s ? n.scrollTop() : 0, n = s ? n.scrollLeft() : 0, a = o.offset(), a = { top: a.top - r, left: a.left - n, height: o.innerHeight(), width: o.innerWidth() }, o = i.offset(), l = x("<div class='ui-effects-transfer'></div>"); l.appendTo("body").addClass(t.className).css({ top: o.top - r, left: o.left - n, height: i.innerHeight(), width: i.innerWidth(), position: s ? "fixed" : "absolute" }).animate(a, t.duration, t.easing, function () { l.remove(), "function" == typeof e && e() }) } }), x.fx.step.clip = function (t) { t.clipInit || (t.start = x(t.elem).cssClip(), "string" == typeof t.end && (t.end = Z(t.end, t.elem)), t.clipInit = !0), x(t.elem).cssClip({ top: t.pos * (t.end.top - t.start.top) + t.start.top, right: t.pos * (t.end.right - t.start.right) + t.start.right, bottom: t.pos * (t.end.bottom - t.start.bottom) + t.start.bottom, left: t.pos * (t.end.left - t.start.left) + t.start.left }) }, H = {}, x.each(["Quad", "Cubic", "Quart", "Quint", "Expo"], function (e, t) { H[t] = function (t) { return Math.pow(t, e + 2) } }), x.extend(H, { Sine: function (t) { return 1 - Math.cos(t * Math.PI / 2) }, Circ: function (t) { return 1 - Math.sqrt(1 - t * t) }, Elastic: function (t) { return 0 === t || 1 === t ? t : -Math.pow(2, 8 * (t - 1)) * Math.sin((80 * (t - 1) - 7.5) * Math.PI / 15) }, Back: function (t) { return t * t * (3 * t - 2) }, Bounce: function (t) { for (var e, i = 4; t < ((e = Math.pow(2, --i)) - 1) / 11;); return 1 / Math.pow(4, 3 - i) - 7.5625 * Math.pow((3 * e - 2) / 22 - t, 2) } }), x.each(H, function (t, e) { x.easing["easeIn" + t] = e, x.easing["easeOut" + t] = function (t) { return 1 - e(1 - t) }, x.easing["easeInOut" + t] = function (t) { return t < .5 ? e(2 * t) / 2 : 1 - e(-2 * t + 2) / 2 } }); x.effects, x.effects.define("pulsate", "show", function (t, e) { var i = x(this), o = t.mode, s = "show" === o, n = 2 * (t.times || 5) + (s || "hide" === o ? 1 : 0), r = t.duration / n, a = 0, l = 1, o = i.queue().length; for (!s && i.is(":visible") || (i.css("opacity", 0).show(), a = 1); l < n; l++)i.animate({ opacity: a }, r, t.easing), a = 1 - a; i.animate({ opacity: a }, r, t.easing), i.queue(e), x.effects.unshift(i, o, 1 + n) }) });
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var BotFactory = (function () {
    function BotFactory() {
    }
    BotFactory.create = function (type) {
        if (type == 5) {
            var variablesManager = new TreeVariablesManager();
            return BotTreeManager.Instance(variablesManager);
        }
        else if (type == 4) {
            return BotInbentaManager.Instance;
        }
        else {
            return null;
        }
    };
    return BotFactory;
}());
var BotManager = (function () {
    function BotManager() {
        this.room = Core.Helpers.getTokenRoom();
    }
    BotManager.prototype.init = function (isOverflow, license) {
        return __awaiter(this, void 0, void 0, function () {
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.isOverflow = isOverflow;
                        this.license = license;
                        if (this.disableChatInputAtStart) {
                            $o.inactivity.disableChatInputUI();
                        }
                        $o.chat.toggleChatUploadButton(false);
                        if (!($o.utils && $o.utils.initBotAction)) return [3, 1];
                        $o.utils.initBotAction(this.mustLaunchBot());
                        return [3, 5];
                    case 1:
                        if (!this.mustLaunchBot()) return [3, 3];
                        return [4, this.startAsync()];
                    case 2:
                        _a.sent();
                        return [3, 5];
                    case 3: return [4, this.botLaunchedActions()];
                    case 4:
                        _a.sent();
                        _a.label = 5;
                    case 5:
                        $o.core.doPostMessageToApi("BOT_READY");
                        return [2];
                }
            });
        });
    };
    ;
    BotManager.prototype.connectOverflowAsync = function () {
        return __awaiter(this, void 0, void 0, function () {
            var data;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4, this.getStartDataAsync()];
                    case 1:
                        data = _a.sent();
                        data.startNode.nodeId = data.startNode.nodeId === "" ? null : data.startNode.nodeId;
                        $o.core.globalVariables.startedBotOffline = true;
                        return [2];
                }
            });
        });
    };
    BotManager.prototype.startConnectedAsync = function (startData) {
        return __awaiter(this, void 0, void 0, function () {
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4, $.connection.hubInterface.server.initBotConversation(startData, JSON.stringify(this.initialContext))];
                    case 1:
                        _a.sent();
                        return [2];
                }
            });
        });
    };
    BotManager.prototype.getActionsOfflineAsync = function (startNodeData) {
        return __awaiter(this, void 0, void 0, function () {
            var keepStarting, nodesToExecute, _loop_1, _i, nodesToExecute_1, node;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        keepStarting = this.validateStart(startNodeData);
                        if (!keepStarting) return [3, 6];
                        return [4, this.getInteractionsToExecute(startNodeData)];
                    case 1:
                        nodesToExecute = _a.sent();
                        _loop_1 = function (node) {
                            var newNodeBackend, newNode;
                            return __generator(this, function (_b) {
                                switch (_b.label) {
                                    case 0:
                                        newNodeBackend = Interactions.BaseManager.objectAdapter(node, Interactions.Targets.Backend);
                                        if (!(newNodeBackend.Method == "sendMessage")) return [3, 2];
                                        $.connection.hubInterface.client.receiveMessage(newNodeBackend.Param, newNodeBackend.Delay);
                                        return [4, new Promise(function (resolve) { return setTimeout(resolve, newNodeBackend.delay); })];
                                    case 1:
                                        _b.sent();
                                        _b.label = 2;
                                    case 2:
                                        if (newNodeBackend.Method == "sendAnalyticsEvent") {
                                            $.connection.hubInterface.client.receiveAnalyticsEvent(newNodeBackend.Param);
                                        }
                                        if (newNodeBackend.Method == "sendInputValidation") {
                                            $.connection.hubInterface.client.receiveInputValidation(newNodeBackend.Param);
                                        }
                                        if (node.method == "sendRunAsyncScript") {
                                            $.connection.hubInterface.client.receiveRunAsyncScript(node.Param);
                                        }
                                        newNode = Interactions.BaseManager.objectAdapter(node, Interactions.Targets.Frontend);
                                        if (!(newNode.method == "sendChoice")) return [3, 4];
                                        $.connection.hubInterface.client.receiveChoice(newNode.param, newNode.delay);
                                        return [4, new Promise(function (resolve) { return setTimeout(resolve, newNode.delay); })];
                                    case 3:
                                        _b.sent();
                                        _b.label = 4;
                                    case 4:
                                        if (newNode.method == "sendSideBubble") {
                                            $.connection.hubInterface.client.receiveSideBubble(newNode.param);
                                        }
                                        if (!(newNode.method == "sendDelay")) return [3, 6];
                                        return [4, $o.delayAction.process(newNode.param, false)];
                                    case 5:
                                        _b.sent();
                                        _b.label = 6;
                                    case 6:
                                        if (!(newNode.method == "sendError")) return [3, 8];
                                        return [4, $o.botErrors.process(newNode.param)];
                                    case 7:
                                        _b.sent();
                                        _b.label = 8;
                                    case 8:
                                        if (!(newNode.method == "sendCustomForm")) return [3, 10];
                                        $.connection.hubInterface.client.receiveCustomForm(newNode.param, newNode.delay);
                                        return [4, new Promise(function (resolve) { return setTimeout(resolve, newNode.delay); })];
                                    case 9:
                                        _b.sent();
                                        _b.label = 10;
                                    case 10: return [2];
                                }
                            });
                        };
                        _i = 0, nodesToExecute_1 = nodesToExecute;
                        _a.label = 2;
                    case 2:
                        if (!(_i < nodesToExecute_1.length)) return [3, 5];
                        node = nodesToExecute_1[_i];
                        return [5, _loop_1(node)];
                    case 3:
                        _a.sent();
                        _a.label = 4;
                    case 4:
                        _i++;
                        return [3, 2];
                    case 5:
                        ;
                        _a.label = 6;
                    case 6: return [2];
                }
            });
        });
    };
    BotManager.prototype.startAsync = function () {
        return __awaiter(this, void 0, void 0, function () {
            var data;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4, this.getStartDataAsync()];
                    case 1:
                        data = _a.sent();
                        $o.chat.isTypingWhileBotRequest();
                        if (!this.isOverflow) return [3, 3];
                        return [4, this.getActionsOfflineAsync(data)];
                    case 2:
                        _a.sent();
                        return [3, 5];
                    case 3: return [4, this.startConnectedAsync(data)];
                    case 4:
                        _a.sent();
                        _a.label = 5;
                    case 5: return [2];
                }
            });
        });
    };
    ;
    BotManager.prototype.mustLaunchBot = function () {
        if ($o.core.globalVariables.enterType != $o.core.enterType.REOPEN && $o.core.globalVariables.enterType != $o.core.enterType.CHECKOUT) {
            return true;
        }
        else {
            return false;
        }
    };
    BotManager.prototype.getInteractionsToExecute = function (data) {
        return __awaiter(this, void 0, void 0, function () {
            var backendData, info, room, domainId, actions;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        backendData = Interactions.BaseManager.objectAdapter(data, Interactions.Targets.Backend);
                        info = {
                            room: Core.Helpers.getTokenRoom(),
                            tokenVisitor: $o.core.globalVariables.myToken,
                            domainId: $o.core.globalVariables.domainId,
                            botName: $o.core.globalVariables.agentName,
                            data: backendData,
                            jsonContextVars: JSON.stringify(this.initialContext),
                        };
                        room = Core.Helpers.getTokenRoom();
                        domainId = $o.core.globalVariables.domainId;
                        if (data && data.startNode && data.startNode.treeKey) {
                            if (data.startNode.treeKey.indexOf("preview-") > -1) {
                                domainId = room.split('-')[1];
                            }
                        }
                        return [4, $.post("".concat($o.settings.botServerHttp).concat(this.type, "/InitBot"), {
                                room: room,
                                contextVariables: JSON.stringify(this.initialContext),
                                botName: $o.core.globalVariables.agentName,
                                startNode: {
                                    treeKey: backendData.StartNode.TreeKey,
                                    nodeId: backendData.StartNode.NodeId
                                },
                                domainId: domainId,
                                license: data.license
                            })
                                .fail(function (xhr, textStatus, errorThrown) {
                                var logInfo = {
                                    title: "AJAX FAIL GetFirstActionsToExecute",
                                    userAgent: window.navigator.userAgent,
                                    domainId: $o.core.globalVariables.domainId,
                                    room: Core.Helpers.getTokenRoom(),
                                    infoParam: info,
                                    errorStatus: xhr.status,
                                    errorText: textStatus,
                                    errorThrown: errorThrown
                                };
                                $.post("Log/BotNotResponding?", {
                                    logInfo: JSON.stringify(logInfo)
                                });
                            })];
                    case 1:
                        actions = _a.sent();
                        return [2, actions];
                }
            });
        });
    };
    ;
    return BotManager;
}());

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var BotInbentaManager = (function (_super) {
    __extends(BotInbentaManager, _super);
    function BotInbentaManager() {
        var _this = _super.call(this) || this;
        _this.startMessage = "sys-welcome";
        _this.type = "Inbenta";
        _this.initialContext = {};
        _this.disableChatInputAtStart = false;
        return _this;
    }
    Object.defineProperty(BotInbentaManager, "Instance", {
        get: function () {
            return this._instance || (this._instance = new this());
        },
        enumerable: false,
        configurable: true
    });
    ;
    BotInbentaManager.prototype.getStartDataAsync = function () {
        return __awaiter(this, void 0, void 0, function () {
            var startData;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!($o.utils && $o.utils.getInitialData)) return [3, 2];
                        return [4, $o.utils.getInitialData()];
                    case 1:
                        startData = _a.sent();
                        return [3, 3];
                    case 2:
                        startData = {
                            startNode: { nodeId: null, treeKey: null },
                            license: null,
                            welcomeMessage: this.startMessage,
                            room: this.room
                        };
                        _a.label = 3;
                    case 3:
                        this.startData = startData;
                        return [2, new Promise(function (resolve, reject) {
                                resolve(startData);
                            })];
                }
            });
        });
    };
    ;
    BotInbentaManager.prototype.validateStart = function (startNodeData) {
        return true;
    };
    BotInbentaManager.prototype.botLaunchedActions = function () {
        return null;
    };
    return BotInbentaManager;
}(BotManager));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var BotTreeManager = (function (_super) {
    __extends(BotTreeManager, _super);
    function BotTreeManager(variablesManager) {
        var _this = _super.call(this) || this;
        _this.type = "Tree";
        _this.initialContext = {};
        _this.disableChatInputAtStart = true;
        _this.variablesManager = variablesManager;
        window.addEventListener("message", _this.receiveRequestFromApi.bind(_this));
        return _this;
    }
    BotTreeManager.Instance = function (variablesManager) {
        return this._instance || (this._instance = new this(variablesManager));
    };
    ;
    BotTreeManager.prototype.gotoBotAction = function (node) {
        this.sendGotoAction(node);
    };
    ;
    BotTreeManager.prototype.botLaunchedActions = function () {
        if (!this.isOverflow) {
            this.initialContext = this.variablesManager.recoverInitialContext();
        }
    };
    ;
    BotTreeManager.prototype.validateStart = function (startData) {
        if (startData.startNode.treeKey === null) {
            return false;
        }
        ;
        return true;
    };
    BotTreeManager.prototype.getStartDataAsync = function () {
        return __awaiter(this, void 0, void 0, function () {
            var data, startData;
            var _a;
            return __generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        if (!(this.startData &&
                            this.startData.hasOwnProperty("startNode") &&
                            this.startData.startNode.hasOwnProperty("treeKey") &&
                            this.startData.startNode != null)) return [3, 1];
                        return [2, this.startData];
                    case 1:
                        if (!($o.utils && $o.utils.getInitialData)) return [3, 3];
                        return [4, $o.utils.getInitialData()];
                    case 2:
                        data = _b.sent();
                        this.startData = data;
                        this.setInitialContext($o.utils.botContextVars);
                        return [2, data];
                    case 3:
                        _a = {};
                        return [4, this.getInitialNodeInfo()];
                    case 4:
                        startData = (_a.startNode = _b.sent(),
                            _a.license = this.license,
                            _a.welcomeMessage = null,
                            _a.room = Core.Helpers.getTokenRoom(),
                            _a);
                        this.startData = startData;
                        return [2, startData];
                }
            });
        });
    };
    ;
    BotTreeManager.prototype.getInitialTreeAsync = function () {
        return __awaiter(this, void 0, void 0, function () {
            var contextVars, trees, gotoFromApi, defaultTree, _i, _a, tree;
            return __generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        if (!$o.core.globalVariables.treePreviewId) return [3, 2];
                        return [4, this.getContextVarsForPreview()];
                    case 1:
                        contextVars = _b.sent();
                        this.setInitialContext(contextVars);
                        return [2, $o.core.globalVariables.treePreviewId];
                    case 2: return [4, this.getActiveTrees()];
                    case 3:
                        trees = _b.sent();
                        trees = Interactions.BaseManager.objectAdapter(trees, Interactions.Targets.Frontend);
                        this.activeTreesList = trees.treesList;
                        this.setInitialContext(trees.botContextVars);
                        gotoFromApi = $o.core.globalVariables.treeStartFromGoto;
                        if (this.activeTreesList.length) {
                            defaultTree = null;
                            for (_i = 0, _a = this.activeTreesList; _i < _a.length; _i++) {
                                tree = _a[_i];
                                if ((gotoFromApi != null && tree.id === gotoFromApi.treeId) ||
                                    ((gotoFromApi === null || gotoFromApi.treeId === null) && tree.defaultTree === true)) {
                                    return [2, tree.key];
                                }
                            }
                        }
                        return [2, null];
                    case 4:
                        ;
                        return [2];
                }
            });
        });
    };
    ;
    BotTreeManager.prototype.setInitialContext = function (contextVars) {
        if (contextVars && Object.keys(contextVars).length > 0) {
            this.initialContext = this.variablesManager.setInitialContext(contextVars);
        }
    };
    ;
    BotTreeManager.prototype.getActiveTrees = function () {
        return __awaiter(this, void 0, void 0, function () {
            var treesInfo;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4, $.post("/Oct8ne/GetActiveTrees?tokenSession=" + Core.Helpers.getTokenRoom())];
                    case 1:
                        treesInfo = _a.sent();
                        return [2, treesInfo];
                }
            });
        });
    };
    ;
    BotTreeManager.prototype.getContextVarsForPreview = function () {
        return __awaiter(this, void 0, void 0, function () {
            var contextVars;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4, $.post("/Oct8ne/GetDomainContextVars?domainId=" + parseInt($o.core.globalVariables.domainId))];
                    case 1:
                        contextVars = _a.sent();
                        return [2, contextVars];
                }
            });
        });
    };
    ;
    BotTreeManager.prototype.getInitialNodeInfo = function () {
        return __awaiter(this, void 0, void 0, function () {
            var treeId, startingNode, node;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4, this.getInitialTreeAsync()];
                    case 1:
                        treeId = _a.sent();
                        this.responseChecker = new BotTreesResponseChecker(this.isOverflow, treeId);
                        startingNode = null;
                        if ($o.core.globalVariables.treeStartFromGoto != null) {
                            startingNode = $o.core.globalVariables.treeStartFromGoto.nodeId;
                        }
                        ;
                        node = {
                            nodeId: startingNode,
                            treeKey: treeId
                        };
                        return [2, node];
                }
            });
        });
    };
    ;
    BotTreeManager.prototype.sendGotoAction = function (node) {
        return __awaiter(this, void 0, void 0, function () {
            var startData, startData;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if ($o.core.globalVariables.agentType !== $o.visitorStart.agentTypes.BOT) {
                            return [2];
                        }
                        $o.choices.disablePrevious();
                        if (!!this.isOverflow) return [3, 3];
                        if (!(node.treeId == null)) return [3, 2];
                        return [4, this.getStartDataAsync()];
                    case 1:
                        startData = _a.sent();
                        node.treeId = parseInt(startData.startNode.treeKey.split("-")[0]);
                        _a.label = 2;
                    case 2:
                        if (node.nodeId === null || node.nodeId === undefined)
                            node.nodeId = "";
                        $.connection.hubInterface.server.goToBotAction(node, Core.Helpers.getTokenRoom());
                        return [3, 6];
                    case 3:
                        this.startData = null;
                        $o.core.globalVariables.treeStartFromGoto = { nodeId: node.nodeId, treeId: node.treeId };
                        return [4, this.getStartDataAsync()];
                    case 4:
                        startData = _a.sent();
                        startData.startNode.nodeId = node.nodeId === null || node.nodeId === undefined ? "" : node.nodeId;
                        return [4, this.getActionsOfflineAsync(startData)];
                    case 5:
                        _a.sent();
                        _a.label = 6;
                    case 6: return [2];
                }
            });
        });
    };
    ;
    BotTreeManager.prototype.receiveRequestFromApi = function (message) {
        if (message.data && typeof message.data === 'string') {
            if (message.data) {
                var info = message.data.split(","), action = info[0];
                if (action === actions.GETTREEVARS) {
                    this.variablesManager.getAsync();
                }
                else if (action === actions.UPDATETREEVARS) {
                    this.variablesManager.updateAsync(info[1]);
                }
                else if (action === actions.BOT_GOTO) {
                    var newNodeLocation = JSON.parse(decodeURIComponent(info[1]));
                    this.sendGotoAction(newNodeLocation);
                }
            }
        }
    };
    ;
    return BotTreeManager;
}(BotManager));
var TreePreview = (function () {
    function TreePreview() {
    }
    TreePreview.preparePreview = function () {
        $o.core.globalVariables.agentsConnected = "True";
        $o.variablesVisitor.domain = this.getDomainIdForPreview();
        $o.core.globalVariables.enabledDepartments = false;
        $o.enterData.allowedDepartmentsId = null;
    };
    ;
    TreePreview.getDomainIdForPreview = function () {
        var env = $("#server-environment").val();
        switch (env) {
            case "https://webteste2ebackoffice.oct8ne.com/":
                return 295;
            case "https://webtestbackoffice.oct8ne.com/":
                return 294;
            case "https://backoffice-eu.oct8ne.com/":
                return 1892;
            case "https://backoffice.oct8ne.com/":
                return 19870;
            case "https://stagingbackoffice.oct8ne.com/":
                return 16;
            case "http://localhost:4700/":
                return 7002;
            default:
                return 0;
        }
    };
    ;
    return TreePreview;
}());

var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var BotTreesResponseChecker = (function () {
    function BotTreesResponseChecker(isOverflow, treeId) {
        this.responseTimeInterval = null;
        this.responseDelayCount = 0;
        this.responseDelayTimeout = 1000 * 30;
        this.responseDelayInterval = 1000;
        this.isEnabled = true;
        this.room = Core.Helpers.getTokenRoom();
        this.isOverflow = isOverflow;
        this.treeId = treeId;
    }
    BotTreesResponseChecker.prototype.startWaiting = function () {
        var _this = this;
        if (this.isEnabled && this.responseDelayCount == 0) {
            this.countResponseTime();
            this.responseTimeInterval = setInterval(function () { _this.countResponseTime(); }, this.responseDelayInterval);
        }
    };
    ;
    BotTreesResponseChecker.prototype.onResponseReceived = function () {
        this.stopCount();
    };
    ;
    BotTreesResponseChecker.prototype.disableCounter = function () {
        this.isEnabled = false;
    };
    BotTreesResponseChecker.prototype.stopCount = function () {
        if (this.responseDelayCount > 0) {
            clearInterval(this.responseTimeInterval);
            this.responseTimeInterval = null;
            this.responseDelayCount = 0;
        }
    };
    ;
    BotTreesResponseChecker.prototype.countResponseTime = function () {
        return __awaiter(this, void 0, void 0, function () {
            var os, status, signalR, logInfo;
            return __generator(this, function (_a) {
                this.responseDelayCount = this.responseDelayCount + this.responseDelayInterval;
                if (this.responseDelayCount >= this.responseDelayTimeout) {
                    this.stopCount();
                    os = "Unknown OS";
                    status = "";
                    signalR = {
                        status: "Unknown",
                        connectionId: "Unknown"
                    };
                    try {
                        if (navigator.userAgent.indexOf("Win") !== -1)
                            os = "Windows OS";
                        if (navigator.userAgent.indexOf("Mac") !== -1)
                            os = "Macintosh";
                        if (navigator.userAgent.indexOf("Linux") !== -1)
                            os = "Linux OS";
                        if (navigator.userAgent.indexOf("Android") !== -1)
                            os = "Android OS";
                        if (navigator.userAgent.indexOf("like Mac") !== -1)
                            os = "iOS";
                        if ($.connection.hub.state === $.signalR.connectionState.disconnected)
                            status = "disconnected";
                        if ($.connection.hub.state === $.signalR.connectionState.connected)
                            status = "connected";
                        if ($.connection.hub.state === $.signalR.connectionState.connecting)
                            status = "connecting";
                        if ($.connection.hub.state === $.signalR.connectionState.reconnecting)
                            status = "reconnecting";
                        signalR.status = status;
                        signalR.connectionId = $.connection.hub.id;
                    }
                    catch (e) {
                    }
                    logInfo = {
                        domainId: $o.core.globalVariables.domainId,
                        tree: this.treeId,
                        room: this.room,
                        os: os,
                        signalR: signalR,
                        isOverflow: this.isOverflow,
                    };
                }
                return [2];
            });
        });
    };
    return BotTreesResponseChecker;
}());

var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var TreeVariablesManager = (function () {
    function TreeVariablesManager() {
        this.endPoint = "".concat($o.settings.botServer, "visitor/variables?domainId=").concat(Core.Helpers.getDomainId());
    }
    TreeVariablesManager.prototype.updateAsync = function (updatedVars) {
        return __awaiter(this, void 0, void 0, function () {
            var endpoint, result;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        endpoint = "".concat(this.endPoint, "&room=").concat(Core.Helpers.getTokenRoom());
                        return [4, fetch(endpoint, {
                                headers: { 'Content-Type': 'application/json' },
                                method: "post",
                                body: decodeURIComponent(updatedVars)
                            })];
                    case 1:
                        result = _a.sent();
                        if (!result.ok) {
                            throw new Error(result.statusText);
                        }
                        return [2];
                }
            });
        });
    };
    TreeVariablesManager.prototype.getAsync = function () {
        return __awaiter(this, void 0, void 0, function () {
            var endpoint, result, _a, _b;
            return __generator(this, function (_c) {
                switch (_c.label) {
                    case 0:
                        endpoint = "".concat(this.endPoint, "&room=").concat(Core.Helpers.getTokenRoom());
                        return [4, fetch(endpoint)];
                    case 1:
                        result = _c.sent();
                        if (!result.ok) {
                            throw new Error(result.statusText);
                        }
                        _b = (_a = console).log;
                        return [4, result.json()];
                    case 2:
                        _b.apply(_a, [_c.sent()]);
                        return [2];
                }
            });
        });
    };
    TreeVariablesManager.prototype.setInitialContext = function (initialContext) {
        $o.storage.local.set("oct8ne-bot-context", JSON.stringify(initialContext));
        return this.parseInitialContext(initialContext);
    };
    TreeVariablesManager.prototype.recoverInitialContext = function () {
        var contextFromStorage = $o.storage.local.get("oct8ne-bot-context");
        if (contextFromStorage) {
            var parsedInitialContext = this.parseInitialContext(JSON.parse(contextFromStorage));
            this.updateAsync(JSON.stringify(parsedInitialContext));
            return parsedInitialContext;
        }
        return {};
    };
    TreeVariablesManager.prototype.parseInitialContext = function (initialContext) {
        var parsedContext = {};
        for (var _i = 0, _a = Object.entries(initialContext); _i < _a.length; _i++) {
            var _b = _a[_i], key = _b[0], value = _b[1];
            try {
                parsedContext[key] = eval(value);
            }
            catch (e) {
            }
        }
        return parsedContext;
    };
    return TreeVariablesManager;
}());
var actions;
(function (actions) {
    actions["UPDATETREEVARS"] = "UPDATETREEVARS";
    actions["GETTREEVARS"] = "GETTREEVARS";
    actions["BOT_GOTO"] = "BOT_GOTO";
})(actions || (actions = {}));

advancedSearchViewModel = function () {
    var self = this;
    self.results = ko.observableArray([]);
    self.totalResults = ko.observable(0);
   // self.isActiveForAgent = ko.observable(false);
    self.add = function (node) {
      

        //TODO REVISAR TODO ESTO DE PRICELAYOUT
        var priceLayout = ""; 
        if (node.Price != "0.00" && (node.PrevPrice == node.Price)) {
            priceLayout = $o.carousel.searchPriceLayouts.normal;
            priceLayout = priceLayout.replace("[0]", node.Price);
        }

        if (node.Price == "0.00" || node.Price == null) {
            priceLayout = '<p>' + culture.coviewer.ViewDetails + '</p>';
        }
        else if (node.PrevPrice != "" && node.PrevPrice != node.Price) {
                priceLayout = $o.carousel.searchPriceLayouts.sale;
                priceLayout = priceLayout.replace("[1]", node.Price);
                priceLayout = priceLayout.replace("[0]", node.PrevPrice);
      
        }
          //END TODO REVISAR TODO ESTO DE PRICELAYOUT
    var result = {
            internalId: ko.observable(node.InternalId),
            thumbnail: ko.observable(node.Thumbnail),
            productURL: ko.observable(node.ProductURL),
            title: ko.observable(node.Title),
            price: ko.observable(node.Price),
            prevPrice: ko.observable(node.PrevPrice),
            stock: ko.observable(node.Stock),
            priceLayout: priceLayout
         //   currency: ko.observable($o.core.globalVariables.currencyVisitor),
         
        };
        self.results.push(result);
    };


    self.emptySearchResults = function () {
        self.results([]);
    };


    self.getProduct = function (nodeId) {
        var product = false,
            searchNode = ko.utils.arrayFirst(self.results(), function (currentNode) {
                return currentNode.internalId() == nodeId;
            });

        if (searchNode) {
            product = {
                InternalId: searchNode.internalId(),
                Thumbnail: searchNode.thumbnail(),
                Title: searchNode.title(),
                ProductUrl: searchNode.productURL()
            };
        }
        return product;
    };



}
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.fullProducts = {
        searchProduct: function (productId) {
            var productInfo = false;
            $.each($o.fullProducts.collection, function (i, prod) {
                if (prod.InternalId == productId) {
                    productInfo = prod;
                }
            });
            return productInfo;
        },

        addProductToCollection: function (product) {
            var exists = $o.fullProducts.searchProduct(product.InternalId);
            if (!exists) {
                $.each(product.Medias, function (x) {
                    product.Medias[x].FileName = $o.core.replaceDeprecatedCdnUrl(product.Medias[x].FileName);
                });

                $o.fullProducts.collection.push(product);
                $o.fullProducts.addProductsToLocalStorage(product);
            }
        },
        addProductsToLocalStorage: function () {
            var d = new Date();
            var products = {
                collection: $o.fullProducts.collection,
                expiresAt: d.setMinutes(d.getMinutes() + 60) //Tiempo en cache
            };
            if (!$o.utils || !$o.utils.disableProductsCaches) {
                $o.storage.local.set($o.core.localStorageTypes.PRODUCTSCOLLECTION, JSON.stringify(products));
            }
        },

        recoverProductsFromLocalStorage: function () {
            var productCollection = $o.storage.local.get($o.core.localStorageTypes.PRODUCTSCOLLECTION);
            if (productCollection) {
                try {
                    var now = new Date();
                    var products = JSON.parse(productCollection);
                    var expirationDate = products.expiresAt;
                    if (now.getTime() < expirationDate) {
                        $o.fullProducts.collection = products.collection;
                    } else {
                        $o.storage.local.set($o.core.localStorageTypes.PRODUCTSCOLLECTION, $o.core.localStorageActions.REMOVE);
                    }
                } catch (error) {

                }
            }
        },
        collection: []
    };
})(window);

lastSearchViewModel = function () {
    var self = this;
    self.results = ko.observableArray([]);
    self.term = ko.observable("");
    self.id = ko.observable(""); //si es related
    self.totalResults = ko.observable(0);
    self.isActive = ko.observable(true);
    self.add = function (node) {
        //Prevenir enviado de productos al cliente
        if ($o.core.globalVariables.showCoviewer == "False") {
            return;
        }

        var priceLayout = "";
        if (node.Price != "0.00" && (node.PrevPrice == node.Price)) {
            priceLayout = $o.carousel.searchPriceLayouts.normal;
            if ($o.core.globalVariables.apiVersion == "2.1") {
                priceLayout = priceLayout.replace("[0]", $o.core.globalVariables.currencyVisitor + node.Price);
            } else {
                priceLayout = priceLayout.replace("[0]", node.Price);
            }
        }
        if (node.Price == "0.00" || node.Price == null) {
            priceLayout = ' <p class="bold custom-search-product-price CVTxt3" style="font-size:9px">' + culture.coviewer.ViewDetails + '</p>';
        }
        else if (node.PrevPrice != "" && node.PrevPrice != node.Price) {
            priceLayout = $o.carousel.searchPriceLayouts.sale;

            if ($o.core.globalVariables.apiVersion == "2.1") {
                priceLayout = priceLayout.replace("[1]", $o.core.globalVariables.currencyVisitor + node.Price);
                priceLayout = priceLayout.replace("[0]", $o.core.globalVariables.currencyVisitor + node.PrevPrice);
            } else {
                priceLayout = priceLayout.replace("[1]", node.Price);
                priceLayout = priceLayout.replace("[0]", node.PrevPrice);
            }
        }

       var result = {
            internalId: ko.observable(node.InternalId),
            thumbnail: ko.observable(node.Thumbnail),
            productURL: ko.observable(node.ProductURL),
            title: ko.observable(node.Title),
            price: ko.observable(node.Price),
            prevPrice: ko.observable(node.PrevPrice),
            currency: ko.observable(node.Currency),
            linkText: culture.coviewer.Show + " " + node.Title,
            priceLayout: priceLayout
        };
        self.results.push(result);
    };

    self.emptySearchResults = function () {
        self.results([]);
    };

    self.copyResultsArrayToPreviousSearch = function () {
        ko.utils.arrayForEach(self.results(), function (currentNode) {
            previousSearchVM.results.push(currentNode);
        });
        self.emptySearchResults();
     //   $o.log(self.results());
       // $o.log(previousSearchVM.results());
    },

    self.getProduct = function (nodeId) {
        var product = false,
           searchNode = ko.utils.arrayFirst(self.results(), function (currentNode) {
               return currentNode.internalId() == nodeId;
           });

        if (searchNode) {
            product = {
                InternalId: searchNode.internalId(),
                Thumbnail: searchNode.thumbnail(),
                Title: searchNode.title(),
                ProductUrl: searchNode.productURL()
            };
        } else {}
        return product;
    };

    self.setActive = function () {
        self.isActive(true);
        previousSearchVM.isActive(false);
    };

    self.productPageFrame = function (data) {
     $o.agentTools.showProductPageFrame(data());
    };
}
mycartViewModel = function () {
    var self = this;
    self.nodes = ko.observableArray([]);
    self.isActive = ko.observable(false);

    //carousel lengths
    self.add = function (node) {
        //Prevenir enviado de productos al cliente
        if ($o.core.globalVariables.showCoviewer == "False") {
            return;
        }
        var searchNode = ko.utils.arrayFirst(self.nodes(), function (currentNode) {
            return currentNode.internalId() == node.InternalId;
        });
        if (!searchNode) {
            $o.log(node);
            var result = {
                internalId: ko.observable(node.InternalId),
                thumbnail: ko.observable($o.core.replaceDeprecatedCdnUrl(node.Thumbnail)),
                title: ko.observable(node.Title),
                cartInfo: ko.observable(""),
                carouselData: ko.observable(node.Title),
                list: "MYCART"
            };
            self.nodes.push(result);
        }
    };

    self.emptyList = function () {
        self.nodes([]);
    };

    self.setCarouselWidth = function () {
        var width;
        if ($o.core.globalVariables.device != "mobile") {
            var thumbnailWidth = $o.core.globalVariables.userType === "A" ? 70 : $o.settings.chatStyle == 4 ? 60 : 56;

            width = (thumbnailWidth * self.nodes().length);
        } else {
            if ($o.settings.chatStyle == 4) {
                width = (65 * self.nodes().length)
            } else {
                width = (50 * self.nodes().length);
            }
        }

        if ($o.core.globalVariables.userType == "V") width = width + 150;
        width = width + "px";
        viewedVM.carouselsWidth(width);


        if ($o.core.globalVariables.device != "mobile") {
            $("#mCSB_1_container").css({ 'width': width });
        }
        $("#oct8ne-nodes").mCustomScrollbar("update");
    };

    self.deleteProduct = function (internalId) {
        var searchNode = ko.utils.arrayFirst(self.nodes(), function (currentNode) {
            return currentNode.internalId() == internalId;
        });
        self.nodes.remove(searchNode);
    };

    self.getProduct = function (nodeId) {
        var searchNode = ko.utils.arrayFirst(self.nodes(), function (currentNode) {
            return currentNode.internalId() == nodeId;
        });
        return searchNode ? searchNode : false;
    };

    self.setActiveTab = function () {
        window.mylistVM.isActive(false);
        window.viewedVM.isActive(false);
        self.isActive(true);

        self.setCarouselWidth();
        $o.carousel.setCurrentNodeActive($o.core.globalVariables.internalId);
        //desactivar las otras tabs
    };

    self.accessToCheckout = function () {
        if (self.nodes().length > 0) {
            if ($o.core.isSignalRConnected()) {
                $o.hubsOut.sendVisitorCheckout($o.core.globalVariables.otherToken);
            };
            $o.iframes.changeStatusIframe($o.iframes.iframeStatus.CHAT);
            $o.saveRecord.checkoutB();
             $o.core.doPostMessageToApi("GOTOCHECKOUT");
        };
    };

    self.accessToCheckoutMobile = function () {
        if (self.nodes().length > 0) {
            if ($o.core.isSignalRConnected()) {
                $o.hubsOut.sendVisitorCheckout();
                $("#minimize-iframe").trigger("click");
                $(".menu-down").hide();
                setTimeout(function () {  $o.core.doPostMessageToApi("GOTOCHECKOUT"); }, 500);
            } else {
                 $o.core.doPostMessageToApi("GOTOCHECKOUT");
                $("#minimize-iframe").trigger("click");
                $(".menu-down").hide();
            }
            $o.saveRecord.checkoutB();
        }
    };

    self.applyCartDataToProducts = function (cartData) {        
        //receive cart data from visitor
        if (typeof cartData != "object") {
            throw "CartData must be an object";
        }      
        if ($o.utils && $o.utils.setCustomCartInfoInAgentViewer) {
          $o.utils.setCustomCartInfoInAgentViewer(cartData);
        } else {
            var nodeWithCartInfo = self.nodes().map(function (node) {
                //get elements by id
                var elems = cartData.products.filter(function (cartElement) { return cartElement.internalId == node.internalId() });
                var cartInfoText = "";

                if (elems.length == 0) return node;

                if (elems.length == 1) {
                    cartInfoText = self.getProductCartInfo(elems[0]);
                    node.cartInfo(cartInfoText);
                    node.carouselData(node.title() + "\n" + node.cartInfo());
                }

                //if length>1 there are variations
                if (elems.length > 1) {
                    cartInfoText = self.getProductVariationsCartInfo(elems);
                    cartInfoText += self.getTotalProductVariationsCartInfo(elems)
                    node.cartInfo(cartInfoText);
                    node.carouselData(node.title() + "\n" + elems.length + " " + culture.coviewer.CartInfoVariations + "\n" + node.cartInfo());
                }
                return node;
            });

            self.nodes(nodeWithCartInfo);

            //change cart tab title
            $("#my-shopping-items").attr("title", culture.coviewer.TitleListMyCart + "\n" + culture.coviewer.CartInfoTotalCartAmount + " " + self.getPriceString(cartData.totalValueCart));
        }
    };

    self.getProductCartInfo = function (elem) {
        var unitsText = elem.qty == 1 ? culture.coviewer.CartInfoUnit : culture.coviewer.CartInfoUnits;

        var line1 = elem.qty + " " + unitsText + " ";
        var line2 = "";

       var price= self.getPriceString(elem.formattedPrice)
        if (price != null) {
             line1 += culture.coviewer.CartInfoPriceAt + " " + price + culture.coviewer.CartInfoPriceByUnit + "\n";
             line2 = culture.coviewer.CartInfoProductTotal + " " + self.getPriceString(elem.formattedPrice, elem.qty);
        }
        return line1 + line2;
    }

    self.getProductVariationsCartInfo = function (elems) {
        var cartInfo = "";      
        for (var i = 0; i < elems.length; i++) {
            if (i > 0) { cartInfo += "\n"; }
            var unitsText = elems[i].qty == 1 ? culture.coviewer.CartInfoUnit : culture.coviewer.CartInfoUnits;
            var priceString = self.getPriceString(elems[i].formattedPrice);
          
            if (priceString != null) {
                cartInfo += " \t" + elems[i].qty + " " + unitsText;
                cartInfo += " " + culture.coviewer.CartInfoPriceAt + " " + priceString + culture.coviewer.CartInfoPriceByUnit;
            }
        };       
        return cartInfo;
    }

    self.getTotalProductVariationsCartInfo = function (elems) {
        var total = 0;
        var totalString = "";
        for (var i = 0; i < elems.length; i++) {          
            var priceFloat = parseFloat(elems[i].formattedPrice);
            var subTotal = parseFloat((Math.round(priceFloat * elems[i].qty * 100) / 100).toFixed(2));
           
            total = total + subTotal;
        };

        if (!isNaN(total)) {
            totalString += "\n" + culture.coviewer.CartInfoProductTotal + self.getPriceString(total);
        }
        return totalString;
    }

    self.getPriceString = function (price, qty) {
        if (!qty) qty = 1;
        var priceFloat = parseFloat(price);
        if (isNaN(priceFloat)) {
            return null;
        }
        var nodeTotalPrice = (Math.round(priceFloat * qty * 100) / 100).toFixed(2);
        var totalPriceString = self.addCurrencyToPrice(nodeTotalPrice);
        return totalPriceString;
    } 

    self.addCurrencyToPrice = function (price) {
        var totalPriceString;
        if ($o.core.globalVariables.currencyVisitor == "EUR") {
            totalPriceString = price + "";
        } else {
            totalPriceString = "$" + price;
        }
        return totalPriceString
    }
}
mylistViewModel = function () {
    var self = this;
    self.nodes = ko.observableArray([]);
    self.isActive = ko.observable(false);
    self.isLogged = ko.observable(false);
   
    //carousel lengths
    self.add = function (node) {
        //Prevenir enviado de productos al cliente
        if ($o.core.globalVariables.showCoviewer == "False") {
            return;
        }
        var searchNode = ko.utils.arrayFirst(self.nodes(), function (currentNode) {
            return currentNode.internalId() == node.InternalId;
        });
        if (!searchNode) {
            var result = {
                internalId: ko.observable(node.InternalId),
                thumbnail: ko.observable($o.core.replaceDeprecatedCdnUrl(node.Thumbnail)),
                title: ko.observable(node.Title)
            };
            self.nodes.push(result);
        }
    };

    self.setCarouselWidth = function () {
        var width;
        if ($o.core.globalVariables.device != "mobile") {
            var thumbnailWidth = $o.core.globalVariables.userType === "A" ? 70 : $o.settings.chatStyle == 4 ? 60 : 56;
            width = (thumbnailWidth * self.nodes().length);
        } else {
            if ($o.settings.chatStyle == 4) {
                width = (65 * self.nodes().length)
            } else {
                width = (50 * self.nodes().length);
            }
        }
       
        if ((self.isLogged() == false) && ($o.core.globalVariables.userType == "V")) width = width + 265;
        width = width + "px";
        viewedVM.carouselsWidth(width);

        if ($o.core.globalVariables.device != "mobile") {
            $("#mCSB_1_container").css({ 'width': width });
        } 
        $("#oct8ne-nodes").mCustomScrollbar("update");
    };
    
    self.getProduct = function (nodeId) {
        var searchNode = ko.utils.arrayFirst(self.nodes(), function (currentNode) {
            return currentNode.internalId() == nodeId;
        });
        return searchNode ? searchNode : false;
    };

    self.setActiveTab = function () {
        window.mycartVM.isActive(false);
        window.viewedVM.isActive(false);
        self.isActive(true);
        self.setCarouselWidth();
        $o.carousel.setCurrentNodeActive($o.core.globalVariables.internalId);
    };
}
previousSearchViewModel = function () {
    var self = this;
    self.results = ko.observableArray([]);
    self.term = ko.observable("");
    self.isActive = ko.observable(false);
    self.id = ko.observable("");//si es related
    self.totalResults = ko.observable(0);
    self.add = function (node) {
        //Prevenir enviado de productos al cliente
        if ($o.core.globalVariables.showCoviewer == "False") {
            return;
        }

        var priceLayout = "";
        if (node.Price != "0.00" && (node.PrevPrice == node.Price)) {
            priceLayout = $o.carousel.searchPriceLayouts.normal;
            if ($o.core.globalVariables.apiVersion == "2.1") {
                priceLayout = priceLayout.replace("[0]", $o.core.globalVariables.currencyVisitor + node.Price);
            } else {
                priceLayout = priceLayout.replace("[0]", node.Price);
            }
        }
        if (node.Price == "0.00" || node.Price == null) {
            priceLayout = ' <p class="bold custom-search-product-price CVTxt3" style="font-size:9px">' + culture.coviewer.ViewDetails + '</p>';
        }
        else if (node.PrevPrice != "" && node.PrevPrice != node.Price) {
            priceLayout = $o.carousel.searchPriceLayouts.sale;
            if ($o.core.globalVariables.apiVersion == "2.1") {
                priceLayout = priceLayout.replace("[1]", $o.core.globalVariables.currencyVisitor + node.Price);
                priceLayout = priceLayout.replace("[0]", $o.core.globalVariables.currencyVisitor + node.PrevPrice);
            } else {
                priceLayout = priceLayout.replace("[1]", node.Price);
                priceLayout = priceLayout.replace("[0]", node.PrevPrice);
            }
        }

        var result = {
            internalId: ko.observable(node.InternalId),
            thumbnail: ko.observable(node.Thumbnail),
            productURL: ko.observable(node.ProductURL),
            title: ko.observable(node.Title),
            price: ko.observable(node.Price),
            prevPrice: ko.observable(node.PrevPrice),
            currency: ko.observable(node.Currency),
            linkText: culture.coviewer.Show + " " + node.Title,
            priceLayout: priceLayout
        };
        self.results.push(result);
    };

    self.emptySearchResults = function () {
        self.results([]);
    };

    self.getProduct = function (nodeId) {
        var product = false,
           searchNode = ko.utils.arrayFirst(self.results(), function (currentNode) {
            return currentNode.internalId() == nodeId;
        });

        if (searchNode) {
            product = {
                InternalId: searchNode.internalId(),
                Thumbnail: searchNode.thumbnail(),
                Title: searchNode.title(),
                ProductUrl: searchNode.productURL()
            };
        } else {

        }
        return product;
    };
    self.setActive = function () {
        self.isActive(true);
        lastSearchVM.isActive(false);
    };

    self.productPageFrame = function (data) {
        $o.agentTools.showProductPageFrame(data());
    };
}
searchViewModel = function () {
    var self = this;
    self.results = ko.observableArray([]);
    self.totalResults = ko.observable(0);
    self.isActiveForAgent = ko.observable(true);
    self.displaySearchSection = ko.observable(true);

    self.loadingDefaultCats = ko.observable(false);
    self.isEmptyGrid = ko.observable(true); //Parrilla vacia
    self.displayFilterResults = ko.observable(false);
    self.availableDefaultFilters = ko.observableArray([]);
    self.availableFilters = ko.observableArray([]);
    self.appliedFilters = ko.observableArray([]);
    self.currentFilter = ko.observableArray([]);
    self.filterAppliedsCount = ko.observable(0);

    self.multiSelectFilter = ko.pureComputed(function () {
        //SETEAMOS POR APIVERSION
        var allowMultipleSelection = $o.core.globalVariables.apiVersion == "2.5" ? true : false;
        return allowMultipleSelection;
    }, self);


    self.add = function (node) {
        
        //Prevenir enviado de productos al cliente
        if ($o.core.globalVariables.showCoviewer == "False") {
            return;
        }

        var priceLayout = "";
        if (node.Price != "0.00" && (node.PrevPrice == node.Price)) {
            priceLayout = $o.carousel.searchPriceLayouts.normal;
            if ($o.core.globalVariables.apiVersion == "2.1") {
                priceLayout = priceLayout.replace("[0]", $o.core.globalVariables.currencyVisitor + node.Price);
            } else {
                priceLayout = priceLayout.replace("[0]", node.Price);
            }
        }
        if (node.Price == "0.00" || node.Price == null) {
            priceLayout = ' <p class="bold custom-search-product-price CVTxt3" style="font-size:9px">' + culture.coviewer.ViewDetails + '</p>';
        }
        else if (node.PrevPrice != "" && node.PrevPrice != node.Price) {
            priceLayout = $o.carousel.searchPriceLayouts.sale;
            if ($o.core.globalVariables.apiVersion == "2.1") {
                priceLayout = priceLayout.replace("[1]", $o.core.globalVariables.currencyVisitor + node.Price);
                priceLayout = priceLayout.replace("[0]", $o.core.globalVariables.currencyVisitor + node.PrevPrice);
            } else {
                priceLayout = priceLayout.replace("[1]", node.Price);
                priceLayout = priceLayout.replace("[0]", node.PrevPrice);
            }
        }

        var result = {
            internalId: ko.observable(node.InternalId),
            thumbnail: ko.observable($o.core.replaceDeprecatedCdnUrl(node.Thumbnail)),
            productURL: ko.observable(node.ProductURL),
            title: ko.observable(node.Title),
            price: ko.observable(node.Price),
            prevPrice: ko.observable(node.PrevPrice),
            currency: ko.observable($o.core.globalVariables.currencyVisitor),
            linkText: culture.coviewer.Show + " " + node.Title,
            priceLayout: priceLayout,
            outOfStock: node.OutOfStock,
            outOfStockStyle: node.OutOfStockStyle,
            stock: ko.observable(node.Stock)
        };            

        self.results.push(result);
    };

    self.emptySearchResults = function () {
        self.results([]);
    };

    self.getProduct = function (nodeId) {
        var product = false,
            searchNode = ko.utils.arrayFirst(self.results(), function (currentNode) {
                return currentNode.internalId() == nodeId;
            });

        if (searchNode) {
            product = {
                InternalId: searchNode.internalId(),
                Thumbnail: searchNode.thumbnail(),
                Title: searchNode.title(),
                ProductUrl: searchNode.productURL()
            };
        }
        return product;
    };

    self.productPageFrame = function (data) {
        $o.agentTools.showProductPageFrame(data());
    };

    self.displayAgentSearches = function () {
        self.displaySearchSection(true);
        $o.agentInfoVisitorVM.isActive(false);
    };

    self.displayInfoVisitor = function () {
        self.displaySearchSection(false);
        $o.agentInfoVisitorVM.isActive(true);
    };

    //FILTERS MANAGEMENT

    self.showAvailableFilters = function () {

        if (self.displayFilterResults()) {
            self.displayFilterResults(false);
            return;
        }

        //Si es nuevo pluguin y NO hay busquedas..mostrar todas las CATS
        if (self.isEmptyGrid() && searchVM.filterAppliedsCount() === 0) {

            if (self.multiSelectFilter()) {
                self.showDefaultCategories();
            } else { //Si es antiguo plugin??
                self.displayFilterResults(true);
                //alert("Debes buscar primero antes de filtrar.");
            }

        } else { //Si ya tiene busqueda mostrar los filtros para esa busqueda.
            self.displayFilterResults(true);
        }

    };


    self.showDefaultCategories = function () {

        self.availableFilters([]);
        self.appliedFilters([]);
        self.loadingDefaultCats(true);

        var searchUrl = $o.platform.domain + $o.platform.prefixUrlPlatform + 'getCategories';
        var cacheType = $o.utils && $o.utils.changeCacheType ? $o.utils.changeCacheType() : true;
        if ($o.utils && $o.utils.changeUrlRequest) {
            searchUrl = $o.utils.changeUrlRequest(searchUrl);
        }
        $.ajax({
            url: $o.platform.getUrlForAjax(searchUrl),
            dataType: 'jsonp',
            method: "GET",
            cache: cacheType,
            jsonpCallback: "oct8neJSONPresponseC",
            success: function (nodes) {
                if (nodes.length) {
                    self.availableDefaultFilters(nodes);
                    self.displayFilterResults(true);
                    $(".empty-search-agent").hide();

                } else {
                    console.log("No hay nodes");
                }
                self.loadingDefaultCats(false);
            }
        });
    };


    self.pickFilter = function (id) {
        id = parseInt(id);
        self.setFilter(id, "category", true);
    };

    self.printFiltersBySearch = function (filters, isRecover) {
        self.availableDefaultFilters([]);
        self.availableFilters(filters.available);
        self.appliedFilters(filters.applied);
        self.returnFiltersApplied();
        if (isRecover) {
            self.setFiltersFromRecover(filters.applied);
        }
    };



    self.setFilter = function (value, label, applyFilter) {

        if (!self.multiSelectFilter()) {
            self.currentFilter([]);
        }

        var obj = {};
        obj[label] = [value];
        var flagAddObj = true;
        var posArray = 0;
        if (self.currentFilter().length > 0) {
            self.currentFilter().forEach(function (element) {
                if (element.hasOwnProperty(label)) {
                    if ($.inArray(value, element[label]) >= 0) {
                        var pos = element[label].indexOf(value);
                        element[label].splice(pos, 1);

                        if (element[label].length === 0) {
                            self.currentFilter().splice(posArray, 1);
                        }
                        flagAddObj = false;
                        self.currentFilter(self.currentFilter());
                        return;

                    } else {
                        element[label].push(value);
                        flagAddObj = false;
                        self.currentFilter(self.currentFilter());
                        return;
                    }
                }
                posArray++;
            });
        }
        if (flagAddObj) {
            self.currentFilter.push(obj);
        }
        if (applyFilter) {
            self.applyFilters();
        }
    };


    self.applyFilters = function () { //TODO: REVISAR CONSTRUCCION DE FILTRO

        var filterNew = "";
        self.currentFilter().forEach(function (element) {
            var currentFilter = JSON.stringify(element);
            currentFilter = currentFilter.replace(/:/g, '=').replace('[', '').replace(']', '').replace(/{/g, '').replace(/}/g, '').replace(/"/g, '');
            filterNew = filterNew + "&" + currentFilter;
        });

        $o.filters.appliedFilters = filterNew;
        $o.search.resetSearch();
        $o.search.doSearch($o.search.searchTerm, $o.filters.appliedFilters, false, "true");
        self.displayFilterResults(false);
        self.returnFiltersApplied();
    };

    self.resetFilters = function () {
        $o.filters.appliedFilters = "";
        self.currentFilter([]);
        $o.search.resetSearch();
        $o.search.doSearch($o.search.searchTerm, $o.filters.appliedFilters, false, "true");
        self.displayFilterResults(false);
        self.returnFiltersApplied();
    };

    self.resetOneFilter = function (label, value) {

        var posArray = 0;
        self.currentFilter().forEach(function (element) {
            if (element.hasOwnProperty(label)) {

                if ($.inArray(value, element[label]) >= 0) {
                    var pos = element[label].indexOf(value);
                    element[label].splice(pos, 1);

                    if (element[label].length === 0) {
                        self.currentFilter().splice(posArray, 1);
                    }
                    self.currentFilter(self.currentFilter());
                }
            }
            posArray++;
        });
        self.applyFilters();
    };


    self.setFiltersFromRecover = function (appliedFilters) {

        appliedFilters.forEach(function (element) {
            self.setFilter(element.value, element.param, false);
        });

        var filterNew = "";
        self.currentFilter().forEach(function (element) {
            var currentFilter = JSON.stringify(element);
            currentFilter = currentFilter.replace(/:/g, '=').replace('[', '').replace(']', '').replace(/{/g, '').replace(/}/g, '').replace(/"/g, '');
            filterNew = filterNew + "&" + currentFilter;
        });

        $o.filters.appliedFilters = filterNew;
        self.returnFiltersApplied();
    };


    self.returnFiltersApplied = function () {   //NECESITO UN METODO QUE RETORNE NUM FILTROS APLICADOS
        var count = 0;
        self.currentFilter().forEach(function (element) {
            for (var key in element) {
                count = count + element[key].length;
            }

        });

        self.filterAppliedsCount(count);
    };
};
viewedViewModel = function () {
    var self = this;
    self.carouselsWidth = ko.observable("0");
    self.nodes = ko.observableArray([]);
    self.isActive = ko.observable(true);

    //carousel lengths
    self.add = function (node) {
        //Prevenir enviado de productos al cliente
        if ($o.core.globalVariables.showCoviewer == "False") {
            return;
        }
        var searchNode = ko.utils.arrayFirst(self.nodes(), function (currentNode) {
            return currentNode.internalId() == node.InternalId;
        });
        if (!searchNode) {
            var result = {
                internalId: ko.observable(node.InternalId),
                thumbnail: ko.observable($o.core.replaceDeprecatedCdnUrl(node.Thumbnail)),
                title: ko.observable(node.Title)
            };
            self.nodes.push(result);
            self.setCarouselWidth();
        }
    };

    self.setCarouselWidth = function () {
        var width;
        if ($o.core.globalVariables.device != "mobile") {
            var thumbnailWidth = $o.core.globalVariables.userType === "A" ? 70 : $o.settings.chatStyle == 4 ? 60 : 56;
            width = (thumbnailWidth * self.nodes().length);
        } else {
            if ($o.settings.chatStyle == 4) {
                width = (65 * self.nodes().length)
            } else {
                width = (50 * self.nodes().length);
            }
        }

        width = width + "px";       
        self.carouselsWidth(width);

        if ($o.core.globalVariables.device != "mobile") {
            $("#mCSB_1_container").css({ 'width': width });
        }           
        $("#oct8ne-nodes").mCustomScrollbar("update");
    };

    self.getProduct = function (nodeId) {
        var product = false,
           searchNode = ko.utils.arrayFirst(self.nodes(), function (currentNode) {
               return currentNode.internalId() == nodeId;
           });
        if (searchNode) {
            product = {
                InternalId: searchNode.internalId(),
                Thumbnail: searchNode.thumbnail(),
                Title: searchNode.title()
            };
        }
        return product;
    };

    self.setActiveTab = function () {
        //desactivar las otras tabs 
        window.mycartVM.isActive(false);
        window.mylistVM.isActive(false);
        self.isActive(true);
        self.setCarouselWidth();
        $o.carousel.setCurrentNodeActive($o.core.globalVariables.internalId);
    };
}
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.canva = {
        init: function() {
            $o.canva.events();
            var image = null;
            $o.canva.holder.object = $("#oct8ne-holder");
            $o.canva.holder.left = 0;
            $o.canva.holder.top = 0;

            $o.canva.target.object = $("#oct8ne-helper img");
            $o.canva.holder.helper = $("#oct8ne-helper");

            $o.canva.holder.helper.click(function(event) {
                if ((!event.isPropagationStopped()) && ($o.drag.enablePointing) && (!$o.pencil.isDrawing)) {

                    switch ($o.tools.context) {
                    case $o.tools.type.PIN:
                        $o.pin.sendPin(event);
                        break;
                    case $o.tools.type.NOTE:
                        $o.note.createNote(event);
                        break;
                    case $o.tools.type.POINT:
                        $o.drag.sendPoint(event);
                    }
                }
                $o.drag.enablePointing = true;
            });
        },

        showAlertAddToCartInAgent: function(title, action) {
            $o.canva.showAlertAddToCartInAgentUI(title, action);

        },

        showAlertAddToMyListInAgent: function (title, whoAdd) {
            $o.canva.showAlertAddToMyListInAgentUI(title, whoAdd);
        },

        update: function(parameters, recover) {
            $o.canva.updateUI(parameters, recover);
        },

        showImageOnCanva: function(left, top, width, height, internalId) {
            $o.canva.showImageOnCanvaUI(left, top, width, height, internalId);
        },

        validatePosition: function(x, y, tool) {
            $o.canva.validatePosition(x, y, tool);
        },

        getCoords: function (event) {
            var coords = {
                absleft: parseInt(Math.abs($o.canva.holder.helper.offset().left - event.pageX)) / $o.canva.target.object.width(),
                abstop: parseInt(Math.abs($o.canva.holder.helper.offset().top - event.pageY)) / $o.canva.target.object.height()
            };
            return coords;
        },

        //se usan en app mvil nativa
        getCoviewerRelativeCoords: function (event) {
            var coords = {
                relLeft: parseInt(Math.abs($o.canva.holder.object.offset().left - event.pageX)) / $o.canva.holder.object.width(),
                relTop: parseInt(Math.abs($o.canva.holder.object.offset().top - event.pageY)) / $o.canva.holder.object.height()
            };
            return coords;
        },
        holder: { width: 0, height: 0, top: 0, left: 0, object: null, helper: null },

        target: { width: 0, height: 0, top: 0, left: 0, object: null, original: { width: 0, height: 0, top: 0, left: 0 } },

        imageFromAgent: false
        
};
})(window);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.carousel = {
        init: function () {
            $o.carousel.events();
            $o.carousel.parsePriceLayout();
        },

        parsePriceLayout: function () {
            var priceData = $.isEmptyObject($o.settings.priceLayout) ? $o.carousel.defaultPriceSettings : $o.settings.priceLayout;
            $o.carousel.createCoviewerPriceLayout(priceData.coviewerTemplate);
            $o.search.createSearchPriceLayout(priceData.searchTemplate);
        },

        //a partir de la id del producto, buscamos la info en el array de search y lo enviamos al canva
        //si callback es $o.carousel.actions.VIEWINCANVA lo muestra en canva
        sendIdToCarousel: function (internalId, list, callback) {
            var product = window.searchVM.getProduct(internalId);
            $o.carousel.addProductInfoToList(product, list);
            if (callback == $o.carousel.actions.VIEWINCANVA) {
                $o.carousel.sentProductToCanva(internalId);
            }
        },

        //a partir de la info del producto COMPLETA, lo enviamos directamente  
        //si callback es $o.carousel.actions.VIEWINCANVA lo muestra en canva
        sendProductToCarousel: function (product, list, callback, recover) {
            $o.carousel.addProductInfoToList(product, list);
            if (callback == $o.carousel.actions.VIEWINCANVA) {
                $o.fullProducts.addProductToCollection(product);
                $o.carousel.sentProductToCanva(product.InternalId, recover);
            }
        },

        //aade producto al carrusel en la lista que le indicamos
        addProductInfoToList: function (product, list, save) {
            var info = false;
            switch (list) {
                case $o.carousel.lists.VIEWED:
                case $o.carousel.lists.TBAR:
                    info = viewedVM.getProduct(product.InternalId);
                    if (!info) {
                        viewedVM.add(product);
                        if (!viewedVM.isActive()) viewedVM.setActiveTab();
                    }
                    break;
                case $o.carousel.lists.MYCART:
                    info = mycartVM.getProduct(product.InternalId);
                    if (!info) mycartVM.add(product);
                    break;
                case $o.carousel.lists.MYLIST:
                    info = mylistVM.getProduct(product.InternalId);
                    if (!info) mylistVM.add(product);
                    break;
                case "NOCA":
                    mycartVM.deleteProduct(product.InternalId);
                    break;
            }

            if (save && !info) {
                product.URLMedia = product.Thumbnail;
                $o.carousel.prepareInteraction(product, list);
            }
        },

        //guarda interaccion
        prepareInteraction: function (product, list) {            
            product.ListType = list || $o.carousel.lists.VIEWED;
            product.Type = "J";
            product.Room = $o.core.globalVariables.room;
            product.SentBy = $o.core.globalVariables.userType;
            product.FromAgentSearch = $o.search.productFromSearch;
            product.Id = $o.tools.generateRandomId(),

                $o.search.productFromSearch = false;

            if ($o.core.isSignalRConnected()) {
                $o.hubsOut.sendNode(product);
            }

            if ((product.ListType == $o.carousel.lists.VIEWED) && (product.InternalId.indexOf("Oct8ne") == -1)) {
                $o.saveRecord.viewedItem(product.InternalId, product.Title, product.URLMedia, product.FromAgentSearch, product.Id, $o.core.globalVariables.userType);
            } else if ((product.ListType == $o.carousel.lists.VIEWED) && (product.InternalId.indexOf("Oct8neUpload") > -1)) {
                $o.saveRecord.uploadItem(product.InternalId, product.Title, product.URLMedia, product.Id);
            } else if ((product.ListType == $o.carousel.lists.VIEWED) && (product.InternalId.indexOf("Oct8neCatalog") > -1)) {
                $o.saveRecord.catalogItem(product.InternalId, product.Title, product.URLMedia, true, product.Id, $o.core.globalVariables.userType);
            } else if (product.ListType == $o.carousel.lists.MYCART) {
                $o.saveRecord.myCartItem(product.InternalId, product.Title, product.URLMedia, product.AddedTo, product.Id);
            } else if (product.ListType == $o.carousel.lists.MYLIST) {
                $o.saveRecord.myListItem(product.InternalId, product.Title, product.URLMedia, product.AddedTo, product.Id);
            }
        },

        //envia al canva
        sentProductToCanva: function (internalId, recover, imageIndex, fromBot) {
            //if ($o.core.globalVariables.showCoviewer == "False") {
            //    return;
            //}
            $o.sideBubbles.hide();

            if ($o.core.globalVariables.userType == "V") $o.visitorSearch.hideCoviewerTutorial();
            var productInfo = $o.fullProducts.searchProduct(internalId);

            if (!productInfo) {
                $o.carousel.loadingProduct();
                if (internalId.indexOf("Oct8neCatalog") != -1) {
                    $o.catalog.searchCatalogItem(internalId, recover);
                } else {
                    $o.platform.getFullProductInfo(internalId, "", recover);
                }
            } else {
                $o.carousel.fillCanvaInfo(productInfo, imageIndex);

                if ((imageIndex) && (imageIndex != 0)) { $o.carousel.goImageN(imageIndex + 1, "", "RECOVER"); }
                $o.carousel.setCurrentNodeActive(internalId);
                if (($o.core.globalVariables.userType == "V") && (internalId.indexOf("Oct8ne") == -1)) $o.carousel.sendNewProductToTrackingBar(productInfo);
                if (!recover) {
                    $o.carousel.prepareInteraction(productInfo, null);
                }
                if ($o.core.userType === "V" && !fromBot) {                    
                    $o.carousel.sendProductToAnalytics("V");

                    if ($o.utils && $o.utils.sendCustomProductIdToAnalytics) {
                        internalId = $o.utils.sendCustomProductIdToAnalytics(internalId);
                    }
                    if (!recover) {
                        var event = {
                            category: "Oct8ne",
                            type: "GAVisitorProductView",
                            viewedProduct: internalId
                        }
                        $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(event));
                    }
                }
            }
        },

        sendNewProductToTrackingBar: function (productInfo) {
            var product = {
                id: productInfo.InternalId,
                thumbnail: productInfo.Thumbnail,
            };
            $o.core.doPostMessageToApi("ADDPRODUCTTOLIST", JSON.stringify(product));      
        },

        sendProductToAnalytics: function (side) {
            var sender = side === "A" ? "Agent" : "Visitor";
            if (viewedVM.nodes().length && $o.variablesVisitor.status === "Attending" && !$o.carousel.sentProductsToAnalytics && $o.chat.chatsInConversation >= $o.chat.chatsForSendingAttendedEvent) {
                var event = {
                    category: "Oct8ne",
                    type: "GAViewedProduct",
                    sentBy: sender
                }
              $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(event));      

                $o.carousel.sentProductsToAnalytics = true;
            }
        },

        resetImage: function () {
            $o.carousel.changeImage($o.carousel.currentImage, "recover");
        },

        getProductFromUpload: function (internalId, mediaUrl, sentBy) {
            var who = sentBy == "V" ? culture.coviewer.UplaodCustomer : culture.coviewer.UploadAgent,
                media = { Id: 1, FileName: mediaUrl, Format: "IMG", Source: 1, Scope: 1, Type: "I", Token: "" },
                medias = new Array();
            medias[0] = media;
            var nodeInfo = {
                InternalId: internalId,
                Title: culture.coviewer.ItemUploaded + " " + who,
                Description: "",
                Price: "",
                Medias: medias,
                RouteTo: "",
                URLMedia: mediaUrl,
                Thumbnail: mediaUrl
            };
            return nodeInfo;
        },

        clickPrevImage: function () {
            if ($o.carousel.currentImage > 1) {
                var newIndex = --$o.carousel.currentImage;
                if ($o.carousel.carouselInterface == $o.carousel.carouselInterfaces.NUMBERS) {
                    $o.carousel.createImageNumbers();
                };
                $o.carousel.updateCarouselArrows(newIndex);
                $o.carousel.changeImage(newIndex);
            }
        },

        clickNextImage: function () {
            if ($o.carousel.currentImage < $o.carousel.images.length) {
                var newIndex = ++$o.carousel.currentImage;
                $o.carousel.updateCarouselArrows(newIndex);
                $o.carousel.changeImage(newIndex);
            }
        },

        goImageN: function (index, forceChange, recover) {
            if (($o.carousel.currentImage != index) && (!forceChange)) {
                $o.carousel.currentImage = index;
                $o.carousel.updateCarouselArrows(index);
                $o.carousel.changeImage(index, recover);
            }
        },

        updateCarouselArrows: function (newIndex) {
            $o.carousel.updateArrowsCarousel(newIndex);
        },

        changeImage: function (newIndex, recover) {

            $o.carousel.loadingImage();
            var image = $o.carousel.sendToCanva($o.carousel.images[newIndex - 1].FileName, $o.carousel.images[newIndex - 1].Id, $o.carousel.images[newIndex - 1].Type);
            image.Index = newIndex;
            if ($o.core.isSignalRConnected()) { //ENVIA SIGNALR SI CONVIENE
                $o.hubsOut.sendImage(image);
            }
            if (!recover) $o.saveRecord.image($o.carousel.currentImage, $o.carousel.images[newIndex - 1].FileName); //scope, url
        },

        add: function (node, imageIndex) {
            $o.carousel.fillCanvaInfo(node, imageIndex);
        },

        setCurrentNodeActive: function (nodeId, noUpdateScroll) {
            $o.carousel.setCurrentNodeActiveUI(nodeId, noUpdateScroll);
        },

        ////saveInteraction serveix per que al canviar de producte no envii un canvi d'imatge
        sendToCanva: function (fileName, id, type, saveInteraction) {

            var image = {
                InternalId: $o.core.globalVariables.internalId,
                URLMedia: fileName,
                RouteTo: id,
                Room: $o.core.globalVariables.room,
                SentBy: $o.core.userType,
                Type: type == "V" ? type : "I"
            };
            $o.canva.update(image, saveInteraction);
            return image;
        },

        images: {},
        infoLayoutFirstTime: false,
        currentImage: 1,
        carouselInterface: "",
        carouselInterfaces: {
            BULLETS: "BULLETS",
            NUMBERS: "NUMBERS"
        },
        actions: {
            VIEWINCANVA: "VIEWINCANVA"
        },
        lists: {
            VIEWED: "VIEWED",
            MYCART: "MYCART",
            MYLIST: "MYLIST",
            TBAR: "TBAR",
            LASTSEARCH: "LASTSEARCH",
            PREVIOUSSEARCH: "PREVIOUSSEARCH"
        },
        sentProductsToAnalytics: false,
        defaultPriceSettings: {
            "coviewerTemplate": {
                "normalPrice": {
                    "line1": {
                        "textTemplate": "[0]",
                        "inlineStyle": "line-height:43px;font-size:2em"
                    },
                    "line2": {
                        "textTemplate": "",
                        "inlineStyle": ""
                    }
                },
                "salePrice": {
                    "line1": {
                        "textTemplate": "[0]",
                        "inlineStyle": "font-size:1.33em; text-decoration:line-through;"
                    },
                    "line2": {
                        "textTemplate": "[1]",
                        "inlineStyle": "font-size:1.33em ;line-height: 20px;"
                    },
                    "saleIcon": true
                }
            },
            "searchTemplate": {
                "normalPrice": {
                    "line1": {
                        "textTemplate": "[0]",
                        "inlineStyle": "font-size:11px; font-weight:700"
                    },
                    "line2": {
                        "textTemplate": "",
                        "inlineStyle": ""
                    }
                },
                "salePrice": {
                    "line1": {
                        "textTemplate": "[1]",
                        "inlineStyle": "font-size:12px,font-weight:700"
                    },
                    "line2": {
                        "textTemplate": "[0]",
                        "inlineStyle": "font-size:10px ; text-decoration:line-through;font-style:italic"
                    }
                }
            }
        },
        searchPriceLayouts: {
            normal: "",
            sale: ""
        }
    };
})(window);



window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.catalog = {
        searchCatalogItem: function (id, recover) {
            var ids = [id];
            var catalogServer = $o.core.userType === "V" ? $o.settings.catalogServer : $o.core.globalVariables.catalogServer;
            
            $.ajax({
                type: "POST",
                url: catalogServer + "Resources/GetCatalogItem",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ "InternalId": id, "License": $o.settings.license }),
                dataType: "json",
                success: function (result) {
                    var catalogNode = {
                        InternalId: result.InternalId,
                        Title: result.Title,
                        Description: result.Description,
                        Thumbnail: result.Thumbnail,
                        URLMedia: result.Thumbnail,
                        Medias: result.Medias,
                        PrevPrice: result.Price,
                        Price: result.Price,
                        BuyURL: "",
                        HasOptions: false,
                        RouteTo: result.ProductUrl
                    };

                    $o.fullProducts.addProductToCollection(catalogNode);
                    $o.carousel.sentProductToCanva(id, recover);
                }
            });


        },

        getProductsByUrls: function (listUrls) {

            if ($o.utils && $o.utils.addDomainInUrlProducts) {
                listUrls = $o.utils.addDomainInUrlProducts(listUrls);
            }

            if ($o.settings.allowTrackingProductsLite && listUrls) {
                var tokenVisitor = $o.core.userType == "V"
                    ? $o.core.globalVariables.myToken
                    : $o.core.globalVariables.visitorToken;

                $.get($o.settings.catalogServer + "Tracking/Products",
                    { "license": $o.settings.license, "stringUrls": JSON.stringify(listUrls) },
                    function (result) {
                        $.each(result,
                            function (i) {
                                var catalogNode = {
                                    InternalId: result[i].InternalId,
                                    Title: result[i].Title,
                                    Description: result[i].Description,
                                    Reference: result[i].Reference,
                                    Thumbnail: result[i].Thumbnail,
                                    URLMedia: result[i].Thumbnail,
                                    Medias: result[i].Medias,
                                    PrevPrice: result[i].Price,
                                    Price: result[i].Price,
                                    BuyURL: "",
                                    HasOptions: false,
                                    RouteTo: result[i].ProductUrl
                                };

                                //Aadir parametros utm
                                if ($o.core.globalVariables.userType == "V" && catalogNode.RouteTo && catalogNode.RouteTo.length > 0) {
                                    var separator = catalogNode.RouteTo.indexOf("?") > -1 ? "&" : "?";
                                    catalogNode.RouteTo = catalogNode.RouteTo + separator + "utm_source=oct8ne&utm_medium=web";
                                }

                                // Update $lastProductsViewed

                                if ($o.bot) {
                                let productCollectionCatalog = $o.storage.local.get("oct8ne-products-collection") ? JSON.parse($o.storage.local.get("oct8ne-products-collection")).collection : "";

                                if (productCollectionCatalog === "") {
                                    var lastProductsCatalog = { "$lastProductsViewed": result[i].Reference };
                                    var totalProductsCatalog = { "$totalProductsViewed": 1 };
                                    $o.bot.variablesManager.updateAsync(JSON.stringify(lastProductsCatalog)).then(() => {
                                        $o.bot.variablesManager.updateAsync(JSON.stringify(totalProductsCatalog));
                                    });
                                } else {
                                    var ids = []
                                    productCollectionCatalog.forEach(product => {
                                        ids.push(product.Reference)
                                    })
                                    ids.push(result[i].Reference)

                                    var totalProductsCatalog = { "$totalProductsViewed": ids.length };
                                    var lastProductsCatalog = { "$lastProductsViewed": ids.reverse().slice(0, 10).toString() };
                                    $o.bot.variablesManager.updateAsync(JSON.stringify(lastProductsCatalog)).then(() => {
                                        $o.bot.variablesManager.updateAsync(JSON.stringify(totalProductsCatalog));
                                    });
                                    }
                                }


                                $o.carousel.addProductInfoToList(catalogNode, $o.carousel.lists.VIEWED);
                                $o.fullProducts.addProductToCollection(catalogNode);
                                //$o.carousel.sendProductToCarousel(catalogNode.InternalId, $o.carousel.lists.VIEWED, $o.carousel.actions.VIEWINCANVA);
                                $o.carousel.sentProductToCanva(catalogNode.InternalId, null, 0);
                            });


                    });


            }

        }
    };
})(window);

window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.canned = {
        init: function () { },
        sendCanned: function (type, body) {
            // A veces no viene body. Se printa mediante KO de la vista. Raro, no debera!!
           
            var canned = {
                Body: {
                    Original: body ? body.replace(/\\n/g, "").replace(/&#39;/g, "'") : "",
                    Translated: false
                },
                Room: $o.core.globalVariables.room,
                Category: "CANNED",
                Type: type,
                Id: $o.tools.generateRandomId(),
                SentBy: type == $o.canned.type.TRIGGER || $o.canned.type.INACTIVITYVISITOR1 || $o.canned.type.INACTIVITYVISITOR2 || $o.canned.type.INACTIVITYVISITOR3 ? "A" : $o.core.globalVariables.userType,
            };
            
            $o.canned.createCanned(canned);
            if ($o.core.isSignalRConnected()) { $o.hubsOut.sendMessage(canned); }
            $o.saveRecord.canned(canned.Body, canned.Type, canned.Id);

            if ($o.utils && $o.utils.sendCannedCallback) {
                $o.utils.sendCannedCallback(type);
            }           
        },

        sendGdpr: function (body) {
            var canned = {
                Body: {
                    Original: body ? body.replace(/\\n/g, "").replace(/&#39;/g, "'") : "",
                    Translated: false
                },
                Room: $o.core.globalVariables.room,
                Category: "GDPR",
                Type: "GDPR",
                Id: $o.tools.generateRandomId(),
                SentBy: $o.core.globalVariables.userType,
            };

            if ($o.core.agentsConnected) {
                $o.canned.createGdpr(canned);
                $o.saveRecord.gdpr(canned.Body, canned.Type, canned.Id);
            };
            if ($o.core.isSignalRConnected()) { $o.hubsOut.sendMessage(canned); }
        },

        createCanned: function (parameters, responsed) {    
            if (parameters.Type === $o.canned.type.TRIGGER && parameters.Body && parameters.Body.hasOwnProperty("Original") && parameters.Body.Original === "") {
                return false;
            }
            if (!parameters.Body || !parameters.Body.hasOwnProperty("Original")) {
                parameters.Body = {
                    Original: parameters.Body,
                    Translated: false
                }
            }
            $o.speak.messages.push(new $o.speak.canned({
                body: parameters.Body.Original,
                tokens: parameters.Tokens,
                sentBy: parameters.SentBy,
                name: parameters.Type == $o.canned.type.TRIGGER && $o.core.userType == "V" ? $o.core.globalVariables.otherName : parameters.Name ? parameters.Name : $o.core.globalVariables.myName,
                id: parameters.Id,
                time: parameters.Time ? parameters.Time : $o.speak.getMessageTime(),
                type: parameters.Type,
                response: responsed ? "[responsed]" : false
            }));

            if (parameters.Type == $o.canned.type.WELCOME) {
                var justLookingButton = $o.storage.local.get($o.core.localStorageTypes.JUSTLOOKINGBUTTON);
                if (justLookingButton) $("#welcome-just-looking").parent().show();
            }
            if (parameters.Type == "DISCONNECT") {
                $o.core.visitorIsGone();
            }
            $o.scroll.moveChatToBottom();
        },

        createCannedTriggerMessage: function (message) {
            
            $o.speak.messages.push(new $o.speak.canned({
                body: message,               
                time: $o.speak.getMessageTime(),
                type: $o.canned.type.TRIGGERMESSAGE
            }));
            $o.scroll.moveChatToBottom();
        },

        createGdpr: function (parameters, recoveredMessage) {
            if (!parameters.Body || !parameters.Body.hasOwnProperty("Original")) {
                parameters.Body = {
                    Original: parameters.Body,
                    Translated: false
                }
            }
            $o.speak.messages.push(new $o.speak.gdpr({
                body: parameters.Body.Original,
                tokens: parameters.Tokens,
                sentBy: parameters.SentBy,
                name: $o.core.globalVariables.otherName,
                id: parameters.Id,
                time: parameters.Time ? parameters.Time : $o.speak.getMessageTime(),
                type: parameters.Type,
                response: false
            }));
            if (!recoveredMessage) {
                $o.scroll.moveChatToBottom();
            }
           
        },

        sendCannedResponse: function (id, answer) {
            var response = {
                Id: id,
                Response: answer,
                Category: "CANNEDRESPONSE",
                Room: $o.core.globalVariables.room,
                SentBy: $o.core.globalVariables.userType,
            };

            $o.canned.updateCannedWithResponse(response);
            response.Response = JSON.stringify(response.Response);
            //  $o.hubsOut.sendFormResponse(response); Las respuestas del caneado se envian??

            $o.saveRecord.cannedResponse(response.Id, response.Response);
        },

        updateCannedWithResponse: function (response) {
            var canned = ko.utils.arrayFilter($o.speak.messages(), function (current) {
                return current.id == response.Id;
            });
            canned[0].response(response.Response);
        },

        type: {
            AGENTAVAILABLE: "AGENTAVAILABLE",
            AGENTSBUSY: "AGENTSBUSY", //BOTON
            AGENTSDISCONNECT: "AGENTSDISCONNECT", //BOTON
            CHECKOUT: "CHECKOUT",
            INACTIVITYVISITOR1: "INACTIVITY1",
            INACTIVITYVISITOR2: "INACTIVITY2",
            INACTIVITYVISITOR3: "INACTIVITY3", //BOTON
            NOMOREAGENTS: "NOMOREAGENTS",  //BOTON
            OVERBOOKING: "OVERBOOKING",  //BOTON
            RECONNECTSESSION: "RECONNECTSESSION",  //BOTON
            RECONNECTSESSIONEMAIL: "RSE",//BOTON // MENSAJE DEPRECATED??
            SENDSESSION: "SENDSESSION",
            TRANSFER: "TRANSFER",
            TRANSFERFROMLOGOUT: "TRANSFERFROMLOGOUT",
            TRIGGER: "TRIGGER",
            VIPMESSAGE: "VIPMESSAGE",
            GDPR: "GDPR",
            WELCOME: "WELCOME",
            TRIGGERIMAGE: "TRIGGERIMAGE",
            INITSHARING: "INITSHARING",
            EXTENSIONADVICE:"EXTENSIONADVICE"
           
        }
    };

})(window);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.chat = {
        init: function () {
            $o.chat.events();
            //se utiliza en los productos que envia el agente
        },

        displayIsTyping: function (text, chatLength, keyCode) {
            if ($o.core.globalVariables.userType === "V" && $o.core.globalVariables.isTypingWithText === "True") {
                $o.chat.displayIsTypingWithText(text, chatLength, keyCode);
            } else {
                $o.chat.displayIsTypingWithoutText(chatLength);
            }
        },

        displayIsTypingWithText: function (text, chatLength, keyCode) {
            if (chatLength === 1) {
                text = "true";
            } else if (chatLength === 0) {
                text = "false";
            }
            if (keyCode === 32 || chatLength === 1 || chatLength === 0) {
                var message = {
                    Body: {
                        Original: text,
                        Translated: false
                    },
                    Room: $o.core.globalVariables.room,
                    SentBy: $o.core.userType,
                    Type: "T"
                };

                if (!$o.core.isSignalRConnected()) {
                    if (!$o.core.globalVariables.visitorsOverflow) {
                        $o.chat.displayOfflineStatus();
                    }
                    return;
                } else {
                    var status = $o.variablesVisitor.status;
                    if (status === "Attending") { //ONLY ATTENDING
                        $o.hubsOut.sendWriting(message);
                    }
                }
            }
        },

        displayIsTypingWithoutText: function (chatLength) { //typing...
            if (($o.core.globalVariables.userType == "A" && !$o.agentTools.isAgentChatActive) || $o.core.globalVariables.userType == "V") {
                var statusTyping;
                if ((chatLength > 0) && (!$o.chat.isTyping)) {
                    statusTyping = true;
                } else if ((chatLength == 0) && ($o.chat.isTyping)) {
                    statusTyping = false;
                }

                if (statusTyping != null || statusTyping != undefined) {
                    var message = {
                        Body: {
                            Original: statusTyping ? "true" : "false",
                            Translated: false
                        },
                        Room: $o.core.globalVariables.room,
                        SentBy: $o.core.userType,
                        Type: "T"
                    };

                    if (!$o.core.isSignalRConnected()) {
                        if (!$o.core.globalVariables.visitorsOverflow) {
                            $o.chat.displayOfflineStatus();
                        }
                        return;
                    } else {
                        if ($o.core.globalVariables.userType == "V") { //VISITOR SIDE
                            var status = $o.variablesVisitor.status;
                            if (status == "Attending") { //ONLY ATTENDING
                                $o.hubsOut.sendWriting(message);
                                $o.chat.isTyping = statusTyping;
                            }
                        } else { //AGENT SIDE
                            $o.hubsOut.sendWriting(message);
                            $o.chat.isTyping = statusTyping;
                        }
                    }
                }
            }
        },

        //shows the Is typing layer, in bot when the next box takes time to arrive, for example a GTP response
        isTypingWhileBotRequest: function () {
            //if waitingForBotDelay is true after 2 seconds, shows delay
            // bot responses set waitingForBotDelay to false
            var timeoutValue = oct8ne.delay.global + 2000;
            $o.chat.waitingForBotDelay = true;
            setTimeout(function () {
                // console.log("Comprobamos $o.chat.waitingForBotDelay") 
                if ($o.chat.waitingForBotDelay) {
                    $o.chat.showTypingDelayFromBot();
                }
            }, timeoutValue);
        },

        toggleChatUploadButton: function (status) {
            var inputWidth = "";
            if (status) {
                $("#upload-visitor-tool").show();
                inputWidth = $o.core.globalVariables.isDevice ? "67%" : "225px";

            } else {
                $("#upload-visitor-tool").hide();
                inputWidth = $o.core.globalVariables.isDevice ? "80%" : "247px";
            }
            if ($o.core.globalVariables.isDevice) {
                $("#chat-input").css("width", inputWidth);
            } else {
                $(".chat-input-emoji").css("width", inputWidth);
            }
        },

        pressEnterOnSearchInput: function (text) {
            if ($o.core.globalVariables.userType === "V" && !$o.core.isSignalRConnected()) {
                $o.visitorStart.restartConnection(text, true);
            } else {
                $o.chat.prepareSend(text);
            }
        },

        postPrepareSend: function (message) {
            if ($o.bot && $o.bot.responseChecker) { $o.bot.responseChecker.startWaiting(); }
            var waitToChangeStatus = false;
            message = $o.chat.purifyMessages(message, $o.core.globalVariables.userType);
            
            if ($o.core.globalVariables.userType == "V") {
                if ((!$o.core.hasBeenWaiting || $o.core.globalVariables.visitorsOverflow) && $o.chat.sentNextMessage == true) {
                    var status = $o.variablesVisitor.status;
                    if (status != "Attending") {
                        $o.chat.messagesBeforeWaiting.push(message);
                        //  $("#chat-input").attr("readonly", true);
                        if (!$o.chat.startedChangeToWaiting) {
                            $o.chat.startedChangeToWaiting = true;
                            $o.visitorSearch.changeToWaitingStatus(message);
                        }
                        waitToChangeStatus = true;
                    }
                }
            }
            if (!waitToChangeStatus) {
                if (message.length >= 1) {
                    message = $o.chat.purifyMessages(message, $o.core.globalVariables.userType);
                    message = message.replace(/\n/g, "<br/>");

                    if ($o.core.globalVariables.userType == "A") {
                        if ($o.translateAgent.doReview) {
                            if ($o.translateAgent.waitingForReview) {
                                $o.translate.startTranslation(message, $o.translate.messageTypes.CHAT);
                            } else {
                                $o.translateAgent.reviewedMessage.translated = message;
                                $o.translateAgent.waitingForReview = false;
                                $o.chat.send($o.translateAgent.reviewedMessage)
                            }
                        } else {
                            $o.translate.startTranslation(message, $o.translate.messageTypes.CHAT);
                        }
                    } else {
                        $o.translate.startTranslation(message, $o.translate.messageTypes.CHAT);
                    }
                };
                $o.chat.isTyping = false;
                $o.chat.hideJustLookingMessage();
            }
        },

        prepareSend: function (message) {
            if ($o.core.globalVariables.room && $o.core.globalVariables.room.startsWith("TEMP")) {
                var endpoint = "Oct8ne/InitSession";
                if ($o.core.globalVariables.agentType == $o.visitorStart.agentTypes.BOT) {
                    endpoint = "Oct8ne/InitSessionWithBot";
                }
                $.post(endpoint, {
                    tempRoom: $o.core.globalVariables.room,
                    visitorData: JSON.stringify($o.core.globalVariables.visitorData)
                }, function (result) {
                    $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies,
                        [
                            { cookie: $o.cookies.tokenSession, value: result.Room },
                            { cookie: $o.cookies.sessionSummaryId, value: result.SessionSummaryId },
                        ]);
                    $o.core.globalVariables.roomForLastOperations = result.Room;

                    $o.saveRecord.saveListInteractions().then(function (result) {
                        $o.chat.postPrepareSend(message);
                    });
                });
            } else {
                $o.chat.postPrepareSend(message);
            }
        },

        sendMessagesBeforeConnected: function () {
            $.each($o.chat.messagesBeforeWaiting, function (i) {
                $o.translate.startTranslation($o.chat.messagesBeforeWaiting[i], $o.translate.messageTypes.CHAT);
            });
            $o.chat.messagesBeforeWaiting = [];
        },

        send: function (body) {
            var message = {
                Body: {
                    Original: body.original.replace(/\\n/g, "").replace(/&#39;/g, "'").trim(),
                    Translated: body.translated.length ? body.translated.replace(/\\n/g, "").replace(/&#39;/g, "'").trim() : false
                },
                Name: $o.core.globalVariables.myName,
                Room: $o.core.globalVariables.room,
                Category: "CHAT",
                //Id: $o.tools.generateRandomId(),
                SentBy: $o.core.globalVariables.userType,
                // AgentImg: "url(https://staticupload.oct8ne.com/avatar/local1/35E2DB3C711B68059718C78A66042B59-2018-07-25-16-27-01-617224.jpg)"
            };

            //envia al chat de agentes    
            if ($o.core.globalVariables.userType == "V" && $.connection.hub.state == $.signalR.connectionState.disconnected && $o.core.globalVariables.enterType !== $o.core.enterType.TREEPREVIEW) {
                $o.chat.displayOfflineStatus();
            } else {
                if (($o.core.globalVariables.userType == "A") && ($o.translateAgent.doReview)) {
                    $(".review-translation").hide();
                    $("#chat-input , .chat-input-emoji").removeClass("reviewing");
                    $(".chat-send").html(culture.coviewer.TranslateButton);
                    $o.translateAgent.waitingForReview = true;
                }

                if ($o.chat.dontSaveNextMessage) {
                    if ($o.core.agentsConnected && $o.chat.sentNextMessage == true) {
                        $o.hubsOut.sendMessage(message);
                    }
                    $o.chat.sentNextMessage = true;
                }
                else {
                    $o.chat.updateMessage(message);
                    $o.saveRecord.chat(message.Body, message.Name, message.Id, message.SentBy, false).then(function (response) {
                        //el ID es el de la tabla Interactions

                        if ($o.core.globalVariables.userType == "V") {
                            //console.log(response);
                            if (response === false) {
                                $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: $o.cookies.tokenSession, value: "" },
                                { cookie: $o.cookies.lastInteractionAFK, value: "" }, { cookie: $o.cookies.status, value: "" }]);
                                $("#lay-AFK .afk-content-advice").text(culture.coviewer.AdviceNotInDic);
                                $o.visitorStart.showLayAFK();
                                $("#chat-input").blur();
                                if ($.connection.hub.state != $.signalR.connectionState.disconnected) $.connection.hub.stop();
                                $o.core.globalVariables.sessionFinalized = true;

                                return;
                            }
                        }
                        message.Id = response;
                        if ($o.core.agentsConnected && $o.chat.sentNextMessage == true) {
                            $o.hubsOut.sendMessage(message);
                        }
                        $o.chat.sentNextMessage = true;

                    });
                }
            };
            $o.chat.dontSaveNextMessage = false;
        },

        sendTriggerAsChat: function (text) { //envia canned subtipo trigger
            var message = {
                Body: text.replace(/\\n/g, "").replace(/&#39;/g, "'"),
                Name: $o.core.globalVariables.otherName,
                Room: $o.core.globalVariables.room,
                Category: "CHAT",
                Id: $o.tools.generateRandomId(),
                SentBy: "A" //Se enva desde Visitor pero debe ser Agent!!!
            };
            $o.chat.updateMessage(message);
            $o.saveRecord.chat(message.Body, message.Name, message.Id, message.SentBy, false);
        },

        updateMessage: function (parameters, recoveredMessage) {
            var notScrolls = false;
            if (recoveredMessage === "recoverfromV") {
                notScrolls = true;
                recoveredMessage = false;
            }

            $o.chat.toogleDenyVisitorTyping(parameters.DenyVisitorTyping);
            if ($o.chat.hideTyping) {
                $o.chat.hideTyping();
            }

            if (!parameters.Body.hasOwnProperty("Original")) {
                parameters.Body = {
                    Original: parameters.Body,
                    Translated: false
                };
            }

            //---------HIPERLINK---------
            var body = $o.chat.checkUrlInBody(parameters.Body.Original, parameters.SentBy);
            var translatedBody = false;

            if (parameters.Body.Translated && parameters.Body.Translated !== null && parameters.Body.Translated !== false && parameters.Body.Translated !== "false") {
                translatedBody = $o.chat.checkUrlInBody(parameters.Body.Translated, parameters.SentBy);
            }

            if ($o.translate.isEnabled === true || recoveredMessage) {
                if (($o.core.globalVariables.userType == "V") && (parameters.SentBy == "A")) {

                    body = parameters.Body.Translated;

                    if (parameters.Body.Translated == "" && parameters.Body.Original.indexOf("<") > -1 && parameters.Body.Original.indexOf(">") > -1) { //Para enviar el hyperlink al visitante sin traducir.
                        body = parameters.Body.Original;
                    }

                    //Si el mensaje no est traducido, se enva el original (en caso de atender desde desktop y app mbil al mismo cliente y activar el traductor en uno de ellos)
                    if (parameters.Body.Translated == "false" || parameters.Body.Translated == false) {
                        body = parameters.Body.Original;
                    }

                } else if (($o.core.globalVariables.userType == "A") && (parameters.SentBy == "A")) {
                    body = parameters.Body.Original;

                }
                body = $o.chat.checkUrlInBody(body, parameters.SentBy);

            } else {
                parameters.Body.Translated = false;
            }


            if (parameters.Body.Original.indexOf("data-media-bot-type") > -1) {
                //if message comes from file bot action it becomes a DOC                
                $o.forms.createDocFromBotFile(parameters, recoveredMessage);
            } else {
                var chat = new $o.speak.chat({

                    //body: body.replace(/([\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2694-\u2697]|\uD83E[\uDD10-\uDD5D])/g, '<span class="oct8ne-emoji-in-chat">$&</span>'), //REGEX PARA EMOTIS
                    // body: body.replace(/[\p{Extended_Pictographic}\u{1F3FB}-\u{1F3FF}\u{1F9B0}-\u{1F9B3}]/gu, '<span class="oct8ne-emoji-in-chat">$&</span>'), //REGEX PARA EMOTIS UPDATED
                    // translation: translatedBody ? translatedBody.replace(/[\p{Extended_Pictographic}\u{1F3FB}-\u{1F3FF}\u{1F9B0}-\u{1F9B3}]/gu, '<span class="oct8ne-emoji-in-chat">$&</span>') : translatedBody,
                    body: body,
                    translation: translatedBody,
                    tokens: parameters.Tokens,
                    sentBy: parameters.SentBy,
                    name: parameters.Name,
                    id: parameters.Id,
                    type: parameters.Type,
                    time: parameters.Time ? parameters.Time : $o.speak.getMessageTime()
                    // agentImg: parameters.AgentImg
                });

                $o.speak.messages.push(chat);
                if (!notScrolls) {
                    $o.scroll.moveChatToBottom();
                }

                // if ($("#go-to-bottom").is(":visible") && parameters.SentBy === "V" && $o.core.globalVariables.userType == "A") {//No se porqu est solo para Agente...
                if ($("#go-to-bottom").is(":visible")) {
                    $o.chat.alertMessageInChat = $o.chat.alertMessageInChat ? $o.chat.alertMessageInChat + 1 : 1;
                    $("#warning-chat").text($o.chat.alertMessageInChat).show();
                }
            }

            if ($o.core.globalVariables.userType == "A" && parameters.SentBy == "V" && !recoveredMessage) {
                $o.agentCopilot.askForSuggestion();
            }
        },

        checkUrlInBody: function (text, sentBy) {
            text = $o.chat.purifyMessages(text, sentBy);

            var className = sentBy == "V" ? 'CHTxt5' : 'CHTxt4';
            var linkTargetClass = "";
            if ($o.utils && $o.utils.getCustomLinkTarget) {
                linkTargetClass = $o.utils.getCustomLinkTarget();
            }

            if ($o.core.globalVariables.isCustomApp) {

                if (text.indexOf($o.core.globalVariables.baseUrl) > -1) {
                    //if we add "target-parent" class link will be open in parent window (search a.target-parent )

                    linkTargetClass += "target-parent";
                    var body = linkifyHtml(text, {
                        tagName: 'a',
                        target: "_blank",
                        newLine: '\n',
                        className: className + " " + linkTargetClass
                    });
                } else {
                    var body = linkifyHtml(text, {
                        tagName: 'a',
                        target: "_blank",
                        newLine: '\n',
                        className: className + " " + linkTargetClass,
                        formatHref: function (href, type) {
                            href = href + "#native-browser";
                            return href;
                        }
                    });

                }

                body = body.replace("target=\"_blank\"", "");
                // console.log(body);
            } else {
                var body = linkifyHtml(text, {
                    tagName: 'a',
                    target: "_blank",
                    newLine: '\n',
                    className: className + " " + linkTargetClass
                });
            }

            body = $o.chat.checkEmotisInBody(body);
            return body;
        },

        checkEmotisInBody(body) {
            if ($o.utils && $o.utils.isBigEmotis) { //ADDED SPAN
                //tiene en cuenta copyright, tm, marca reg.
                // body = body.replace(/[\u{1f300}-\u{1f5ff}\u{1f900}-\u{1f9ff}\u{1f600}-\u{1f64f}\u{1f680}-\u{1f6ff}\u{2600}-\u{26ff}\u{2700}-\u{27bf}\u{1f1e6}-\u{1f1ff}\u{1f191}-\u{1f251}\u{1f004}\u{1f0cf}\u{1f170}-\u{1f171}\u{1f17e}-\u{1f17f}\u{1f18e}\u{3030}\u{2b50}\u{2b55}\u{2934}-\u{2935}\u{2b05}-\u{2b07}\u{2b1b}-\u{2b1c}\u{3297}\u{00a9}\u{00ae}\u{2122}\u{3299}\u{303d}\u{23f3}\u{24c2}\u{23e9}-\u{23ef}\u{25b6}\u{23f8}-\u{23fa}]/gu, '<span class="oct8ne-emoji-in-chat">$&</span>'); //REGEX PARA EMOTIS UPDATED - ADDED BIG EMOTIS CLASS

                //no tiene en cuenta copyright, tm, marca reg.
                body = body.replace(/[\u{1f300}-\u{1f5ff}\u{1f900}-\u{1f9ff}\u{1f600}-\u{1f64f}\u{1f680}-\u{1f6ff}\u{2600}-\u{26ff}\u{2700}-\u{27bf}\u{1f1e6}-\u{1f1ff}\u{1f191}-\u{1f251}\u{1f004}\u{1f0cf}\u{1f170}-\u{1f171}\u{1f17e}-\u{1f17f}\u{1f18e}\u{3030}\u{2b50}\u{2b55}\u{2934}-\u{2935}\u{2b05}-\u{2b07}\u{2b1b}-\u{2b1c}\u{3297}\u{3299}\u{303d}\u{23f3}\u{24c2}\u{23e9}-\u{23ef}\u{25b6}\u{23f8}-\u{23fa}]/gu, '<span class="oct8ne-emoji-in-chat">$&</span>'); //REGEX PARA EMOTIS UPDATED - ADDED BIG EMOTIS CLASS

            } else {
                body = body;
            }
            return body
        },


        purifyMessages: function (text, sentBy) {
            var allowedStyles = [
                'color',
                'background-color',
                'font-size',
                'border',
                'text-align',
                'height',
                'width',
                'border-radius',
                'margin'];

            var allowedAgentStyles = ['font-family'];

            if ($o.core.globalVariables.userType == "A") {
                allowedStyles.push(...allowedAgentStyles);
            }

            text = Core.Helpers.cleanMarkdown(text);

            DOMPurify.addHook('uponSanitizeAttribute', function (node, data) {
                if (data.attrName === 'style') {
                    const styleProperties = data.attrValue.split(';').map(property => property.trim());
                    const filteredProperties = styleProperties.filter(property => {
                        const [key] = property.split(':').map(part => part.trim());
                        return allowedStyles.includes(key);
                    });
                    data.attrValue = filteredProperties.join('; ');
                }
            });

            var tagsPermissions = {
                ALLOWED_TAGS: [
                    'p', 'br', 'b', 'i', 'u', 'strong', 'em', 'span', 'div', 'ul', 'ol', 'li',
                    'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'table', 'tr', 'td', 'th', 'thead',
                    'tbody', 'img', 'a', 'blockquote', 'pre', 'code', 'hr', 'caption',
                    'source', 'form', 'input', 'button', 'label', 'select', 'option',
                    'header', 'footer', 'article', 'section', 'nav', 'aside'
                ],
                ALLOWED_ATTR: [
                    // Safe attributes
                    'href', 'src', 'alt', 'title', 'width', 'height', 'controls', 'autoplay', 'loop',
                    'preload', 'poster', 'type', 'name', 'value', 'method', 'action', 'for', 'id',
                    'class', 'style', 'target', 'rel', 'download', 'placeholder', 'selected', 'checked',
                    'multiple', 'maxlength', 'disabled', 'readonly', 'required'
                ],
                // Remove all event attributes
                FORBID_ATTR: ['onclick', 'onload', 'onerror', 'onblur', 'onmouseover', 'onfocus', 'oninput', 'onchange', 'onsubmit'],

                // Remove dangerous tags
                FORBID_TAGS: ['script', 'iframe', 'object', 'embed', 'applet', 'link', 'style', 'svg', 'math'],

                FORCE_BODY: true
            }

            //in visitor iframes from agent are allowed            
            if ($o.core.globalVariables.userType == "V" && sentBy=="A") {
                tagsPermissions.FORBID_TAGS = tagsPermissions.FORBID_TAGS.filter(function (value) {
                    return value !== 'iframe'
                })
                tagsPermissions.ALLOWED_TAGS.push("iframe");
            }

            const sanitizedHTML = DOMPurify.sanitize(text, tagsPermissions);

            //var sanitizedHTML = DOMPurify.sanitize(text, {
            //    ALLOWED_TAGS: ['a','br'],
            //    FORBID_TAGS: ['style'],
            //    ALLOWED_ATTR: ['href','target'],
            //    ADD_ATTR: ['style','target']
            //});          
            return sanitizedHTML;
        },

        displayOfflineStatus: function () {
            if ($o.core.globalVariables.userType == "V") { //SOLO PARA VISITOR
                $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: $o.cookies.tokenSession, value: "" }]); //Para asegurar que es un visitor nuevo. By Gerard!
                //$("#offline-status-wrapper").show();
                $("#lay-AFK .afk-content-advice").text(culture.coviewer.OfflineAdvice2).show();
                $o.visitorStart.showLayAFK();
                $("#chat-input , .chat-input-emoji").blur();
            } else {
                return;
            };
        },

        sendIsAttendedToAnalytics: function (category, sentBy) {
            var mustSend = false;
            if ($o.utils && $o.utils.attendingEventConditions) {
                //condiones custom por settings
                mustSend = $o.utils.attendingEventConditions(category);
            } else {
                //default: que lleguen ms de 1 chat o choice
                if ((category == "CHAT" || category == "CHOICE") && !$o.chat.sentAttendedToAnalytics) {
                    ++$o.chat.chatsInConversation;
                    mustSend = $o.chat.chatsInConversation >= $o.chat.chatsForSendingAttendedEvent && $o.variablesVisitor.status === "Attending";
                }
            }
            if (mustSend) {
                var event = {
                    category: "Oct8ne",
                    type: "GAAttendedByAgent",
                    agentName: $o.core.globalVariables.otherName,
                    agentId: $o.core.globalVariables.agentId
                }
                $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(event));
                $o.chat.sentAttendedToAnalytics = true;
                //por si hay productos vistos anteriormente
                $o.carousel.sendProductToAnalytics("V");
            }
            //evento custom de attending
            if ($o.utils && $o.utils.attendingCustomEvent) {
                $o.utils.attendingCustomEvent(category, sentBy);
            }
        },

        imagePreviewPasted: function (imageIn64) {
            $("#pasted-image").css("background", "url(" + imageIn64 + ")");
            $("#preview-pasted").show();
        },

        refreshWindow: function () {
            $o.core.doPostMessageToApi("REFRESHPAGE");
        },

        sendAlert: function (messageText) {
            if ($o.core.globalVariables.agentType !== $o.visitorStart.agentTypes.BOT) {
                $o.chat.addAlertChat();
                var newAlert = encodeURIComponent(messageText);
                $o.core.doPostMessageToApi("NEWCHATALERT", newAlert);
            } else if ($o.core.globalVariables.isDevice && $o.visitorSearch.currentScreen !== "CHAT") {
                $o.chat.addAlertChat();
            }
        },

        alerts: null,
        agentsConnected: false,
        isTyping: false,
        VisitorSendMessage: false,
        alertMessage: null,
        alertProduct: null,
        queueChats: [],
        typingTimer: null,
        stopTypingInterval: 15000,
        messagesBeforeWaiting: [],
        startedChangeToWaiting: false,
        chatsInConversation: 0,
        sentAttendedToAnalytics: false,
        pendingAccessFormMessage: false,
        chatsForSendingAttendedEvent: 2,
        dontSaveNextMessage: false,
        sentNextMessage: true
    };
})(window);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.forms = {
        init: function () {
            $o.forms.events();
        },

        sendForm: function (type, body) {
            var form = {
                Body: {
                    Original: body ? body : "",
                    Translated: false
                },
                Room: $o.core.globalVariables.room,
                SentBy: type === "INITFORM" ? "A" : $o.core.globalVariables.userType, //INITFORM es un formulario custom de MOBIOCASION que se envia ala entrada desde Visitor. Hay que cambiar SentBy.
                Type: type,
                Category: "FORM",
                Id: $o.tools.generateRandomId()
            };

            $o.forms.createForm(form);
            if ($o.core.isSignalRConnected()) {
                $o.hubsOut.sendMessage(form);
            }
            $o.saveRecord.form(type, form.Id, body);
        },

        sendOrderForm: function (orderStatus) {
            var form = {
                Body: {
                    Original: orderStatus.OrderStatusForm[0].body,
                    Translated: false
                },
                Room: $o.core.globalVariables.room,
                SentBy: "A",
                Type: $o.forms.type.ORDER,
                Category: "FORM",
                Id: $o.tools.generateRandomId()
            };
            $o.forms.orderStatusOptions(orderStatus);
            $o.forms.createForm(form);
            $o.saveRecord.formOrder($o.forms.type.ORDER, form.Id, orderStatus.OrderStatusForm[0].body);
        },

        orderStatusOptions: function (parameters) {
            if (parameters) {
                $o.forms.orderOptions = parameters;
                $o.storage.local.set("oct8ne-order-options", JSON.stringify(parameters));
            }
            else if (!$o.forms.orderOptions) {
                $o.forms.orderOptions = JSON.parse($o.storage.local.get("oct8ne-order-options"));
            }
            return $o.forms.orderOptions;

        },

        createForm: function (parameters, recoveredMessage) {
            var customText = null;
            if ($o.utils && $o.utils.ratingsCustomText) {
                if ($o.utils.ratingsCustomText[$o.core.globalVariables.locale]) {
                    customText = $o.utils.ratingsCustomText[$o.core.globalVariables.locale]
                } else {
                    customText = $o.utils.ratingsCustomText[0]
                }
            }
            if ($o.utils && $o.utils.ratingsCustomTextFunction) {
                customText = $o.utils.ratingsCustomTextFunction($o.core.globalVariables.locale)
            }

            // || $o.utils.ratingsCustomTextFunction)

            if (!parameters.Body || !parameters.Body.hasOwnProperty("Original")) {
                parameters.Body = { Original: parameters.Body, Translated: false };
            }
            if (parameters.Type == $o.forms.type.ACCESSFORM && typeof parameters.Body == 'string') { parameters.Body.Original = JSON.parse(parameters.Body.Original) };
            $o.speak.messages.push(new $o.speak.form({
                body: parameters.Body.Original,
                room: parameters.Room ? parameters.Room : $o.core.globalVariables.room,
                sessionSummaryId: $o.core.globalVariables.userType == "V" ? $o.variablesVisitor.sessionSummaryId : $o.core.globalVariables.sessionSummaryId,
                tokens: parameters.Tokens,
                sentBy: parameters.SentBy,
                type: parameters.Type,
                id: parameters.Id,
                response: [],
                name: parameters.Name,
                customText: customText
            }));

            if (!recoveredMessage) {
                $o.forms.updateScroll(10000);
            }
        },

        createDocs: function (parameters, recoveredMessage) {
            if (!parameters.Body || !parameters.Body.hasOwnProperty("Original")) { parameters.Body = { Original: parameters.Body, Translated: false } }
            $o.speak.messages.push(new $o.speak.docs({
                body: parameters.Body.Original,
                tokens: parameters.Tokens,
                sentBy: parameters.SentBy,
                type: parameters.Type,
                id: parameters.Id,
                response: [],
                name: parameters.Name,
                caption: parameters.Caption,
                fromBot: parameters.FromBot
            }));

            if (!recoveredMessage) {
                $o.forms.updateScroll(10000);
            }

        },

        createDocFromBotFile: function (parameters, recoveredMessage) {
            $("body").append("<div id='temp_doc' style='display:none'>" + parameters.Body.Original + "</div>");

            var link = $("#temp_doc a").attr("href");
            var caption = $("#temp_doc a").text();
            var extensionIndex = link.lastIndexOf(".") + 1;
            $("#temp_doc").remove();

            parameters.Category = "DOCS";
            parameters.Body.Original = link;
            parameters.Caption = caption;
            parameters.FromBot = true;
            parameters.Type = link.substring(extensionIndex);
            $o.forms.createDocs(parameters, recoveredMessage);
        },


        sendFormResponse: function (id, answer, customFormFields) {
            var formInArray = $o.forms.getForm(id);
            if (formInArray.length === 1) {
                var response = {
                    Id: id,
                    Response: answer,
                    Category: "RESPONSE",
                    Room: formInArray[0].room,
                    SessionSummaryId: formInArray[0].sessionSummaryId,
                    SentBy: $o.core.globalVariables.userType,
                };

                $o.forms.updateFormWithResponse(response);

                response.Response = JSON.stringify(response.Response);

                if ($o.core.isSignalRConnected()) $o.hubsOut.sendFormResponse(response);
                $o.saveRecord.formResponse(response.Id, response.Response, response.Room, response.SessionSummaryId, customFormFields);
            }
        },

        updateFormWithResponse: function (response) {
            var form = $o.forms.getForm(response.Id);
            if (form.length === 1) {
                if (form[0].type === "DOCUMENT" && $o.core.globalVariables.userType === "A") {
                    var profile = { name: response.Response[0], email: response.Response[1] };
                    $o.agentInfoVisitorVM.info.updateVisitorProfile(profile);
                }
                form[0].response(response.Response);

                if ($o.core.globalVariables.userType == "A" && response.SentBy == "V") {
                    $o.agentCopilot.askForSuggestion();
                }
            }
        },

        getForm: function (id) {
            var form = ko.utils.arrayFilter($o.speak.messages(), function (current) {
                return current.id === id;
            });
            return form;
        },

        getUrlFromUploadIframe: function (url) {
            if (typeof url.data === 'string') {
                var data = url.data.split(",");
                
                if ($o.core.globalVariables.userType == "V" && url.origin.indexOf($o.core.globalVariables.uploadUrl)==0) return;
                if (data[2] == "UPLOAD") {
                    var fileUrl = data[0];
                    var isImage = $o.forms.imageValidator(fileUrl);

                    if (isImage) { //Image goes to coviewer
                        var random = Math.floor((Math.random() * 1000000) + 1);
                        var internalId = "Oct8neUpload-" + random;
                        var product = $o.carousel.getProductFromUpload(internalId, fileUrl, $o.core.globalVariables.userType);
                        $o.carousel.addMediaFromUploadUI();
                        $o.carousel.sendProductToCarousel(product, $o.carousel.lists.VIEWED, $o.carousel.actions.VIEWINCANVA);

                        if ($o.utils && $o.utils.executeActionAfterSendImage) {
                            $o.utils.executeActionAfterSendImage();
                        }

                    } else { //Any file goes to chat in under linf format , pdf,xls,etc...
                        $o.forms.sendDoc(fileUrl);
                        $o.carousel.addDocFromUploadUI();
                    }

                    if ($o.customForms.uploadedFromCustomForm) {
                        var phrase = $("#" + $o.customForms.uploadedFromCustomForm).find(".upload-success");
                        phrase.show(0).delay(3000).hide(0);
                    }

                    if ($o.forms.uploadedFromInputBot !== null) {
                        $o.forms.uploadForBotCallback(fileUrl);
                    }
                }
            } else {
                return;
            }
        },

        sendDoc: function (fileUrl) {
            var extension = fileUrl.split('.').pop().toLowerCase();
            var doc = {
                Body: {
                    Original: fileUrl,
                    Translated: false
                },
                Room: $o.core.globalVariables.room,
                SentBy: $o.core.globalVariables.userType,
                Type: extension,
                Category: "DOCS",
                Id: $o.tools.generateRandomId()
            };

            $o.forms.createDocs(doc);
            if ($o.core.isSignalRConnected()) {
                $o.hubsOut.sendMessage(doc);
            }
            $o.saveRecord.documentLink(extension, fileUrl);
        },

        sessionToEmailForm: function (stringEmail, sendEmail) { //DEPRECATED??
            $o.forms.sessionToEmail.sendEmail = sendEmail;
            $o.forms.sessionToEmail.Email = stringEmail;
        },

        imageValidator: function (fileUrl) {
            var extension = fileUrl.split('.').pop().toLowerCase();
            var isImage = $o.forms.extensionImageArray.indexOf(extension) > -1;
            return isImage;
        },

        closeSession: function () {
            // $o.core.doPostMessageToApi("CLOSESESSION");
            $.connection.hub.stop();
            $o.core.agentsConnected = false;
            var queryString = "?tokenSession=" + $o.core.globalVariables.room + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId;
            $o.visitorStart.changeStatus(queryString, "Finalized");
            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [{ cookie: $o.cookies.status, value: "Finalized" }]);
        },

        sendCustomForm: function (formType, totalFields) { //ENVIA FORMULARIO PERSONALIZADO DENTRO CHAT
            var form = $("#custom-wrapper-" + formType);
            var data = [];
            var placeholders = [];
            var regex = /^[a-zA-Z0-9._-]+([+][a-zA-Z0-9._-]+){0,1}[@][a-zA-Z0-9._-]+[.][a-zA-Z]{2,6}$/;
            var canPass = $o.settings.privacyPolicy.length ? false : true;

            if ($o.settings.privacyPolicy.length) {
                var accept = form.find("input[type='checkbox']");
                if (!accept.is(":checked")) {
                    accept.parent().addClass("data-contact-error").attr("aria-invalid", "true");
                } else {
                    canPass = true;
                    accept.parent().removeClass("data-contact-error").removeAttr("aria-invalid");
                };
            };

            if (form.find("input[type='email']").length) {     //Validacin de mail solamente
                var emailField = form.find("input[type='email']");
                var email = emailField.val();
                emailField.removeClass("data-contact-error").attr("aria-invalid", "true");
                if (!regex.test(email)) {
                    emailField.addClass("data-contact-error").removeAttr("aria-invalid");
                    canPass = false;
                    return;
                };
            };

            if (canPass) {
                for (var i = 0; i < totalFields; i++) { //Montar array de respuestas

                    var value = form.find("input[name='custom-fields-" + i + "']").val();
                    var placeholder = form.find("input[name='custom-fields-" + i + "']").attr("placeholder");

                    if (!value) {
                        value = form.find("select[name='custom-fields-" + i + "']").val();
                    }
                    data.push(value);
                    placeholders.push(placeholder);
                }
                var id = form.find("a").attr("data-form-id");
                $o.forms.sendFormResponse(id, data, placeholders);

                if ($o.utils && $o.utils.executeActionAfterCustomForm) {
                    $o.utils.executeActionAfterCustomForm(data);
                }

            };
        },

        sendSummaryCustomForm: function (formType, totalFields) { //ENVIA FORMULARIO PERSONALIZADO DENTRO CHAT
            var form = $("#custom-wrapper-" + formType);
            var data = [];
            var regex = /^[a-zA-Z0-9._-]+([+][a-zA-Z0-9._-]+){0,1}[@][a-zA-Z0-9._-]+[.][a-zA-Z]{2,6}$/;
            var canPass = $o.settings.privacyPolicy.length ? false : true;
            var emailField = form.find("input[type='email']");
            var email = emailField.val();

            if ($o.settings.privacyPolicy.length) {
                var accept = form.find("input[type='checkbox']");
                if (!accept.is(":checked")) {
                    accept.parent().addClass("data-contact-error").attr("aria-invalid", "true");
                } else {
                    canPass = true;
                    accept.parent().removeClass("data-contact-error").removeAttr("aria-invalid");
                };
            };

            if (form.find("input[type='email']").length) {     //Validacin de mail solamente
                // var emailField = form.find("input[type='email']");
                //  var email = emailField.val();
                emailField.removeClass("data-contact-error").removeAttr("aria-invalid");
                if (!regex.test(email)) {
                    emailField.addClass("data-contact-error").attr("aria-invalid", "true");
                    canPass = false;
                    return;
                };
            };

            if (canPass) {
                for (var i = 0; i < totalFields; i++) { //Montar array de respuestas
                    var value = form.find("input[name='custom-fields-" + i + "']").val();
                    data.push(value);
                }
                var id = form.find("a").attr("data-form-id");
                $o.forms.sendFormResponse(id, data);
                $o.visitorSearch.getRecordsMailInfo(email);
            };
        },

        uploadForBot: function (e) {
            let chatId = e.target.closest("form").id;
            $o.forms.uploadedFromInputBot = chatId;
            $("#visitor-upload-button").trigger("click");
        },

        skipUploadForBot: function (e) {
            var chatId = e.target.closest("form").id;
            $("#" + chatId).parent().addClass("file-uploaded");
            var text = "";
            $o.forms.sendUploadCallbackMessage(text);
        },

        uploadForBotCallback: function (url) { 
            if ($o.forms.uploadedFromInputBot) {
                var formId = $o.forms.uploadedFromInputBot

                $o.forms.uploadedFromInputBot = null;
                $("#" + formId).parent().addClass("file-uploaded");

                var text = url;
                $o.forms.sendUploadCallbackMessage(text);
            }
        },

        sendUploadCallbackMessage: function (text) {
            if ($o.core.globalVariables.userType == "V" && $o.core.globalVariables.agentType == $o.visitorStart.agentTypes.BOT) {

                //send message as attachment to bot   
                var body = [{
                    type: 1,
                    url: text,
                    caption: ""
                }];

                $o.chat.dontSaveNextMessage = true;
                $o.chat.pressEnterOnSearchInput(JSON.stringify(body));
            };
        },

        sessionToEmail: {
            sendEmail: false,
            Email: ""
        },

        type: {
            CALLBACK: "CALLBACK",
            SENDCONTACT: "SENDCONTACT",
            SKYPE: "SKYPE",
            DOCUMENT: "DOCUMENT",
            SENDSESSION: "SENDSESSION",
            VISITORUPLOAD: "VISITORUPLOAD",
            ACCESSFORM: "ACCESSFORM",
            ASKFORSS: "ASKFORSS",
            ORDER: "ORDER",
            VALORATION: "VALORATION",
            STARSVALORATION: "STARSVALORATION"
        },
        extensionImageArray: ['gif', 'png', 'jpg', 'jpeg', 'bmp', 'otf'],
        uploadedFromInputBot:null
    };

})(window);

if (window.addEventListener) addEventListener("message", $o.forms.getUrlFromUploadIframe, false);
else attachEvent("onmessage", $o.forms.getUrlFromUploadIframe);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.productsChat = {
        init: function () {
            // se utiliza en los productos que envia el agente
            $("#oct8ne-chat-room").on("click", ".holder", function () {
                var attr = $(this).find("div").attr('data-internalid');
                if (typeof attr !== typeof undefined && attr !== false) {
                    if ($o.core.globalVariables.userType == "V") {
                        if ($o.iframes.currentIframeStatus == $o.iframes.iframeStatus.CHAT) {
                            if ($o.core.globalVariables.showSearch != "True" || $o.core.globalVariables.edition == $o.core.editions.FREE) {
                                $o.iframes.changeStatusIframe($o.iframes.iframeStatus.VIEWER);
                            } else {
                                $o.iframes.changeStatusIframe($o.iframes.iframeStatus.SEARCH);
                            }
                            if ($o.core.globalVariables.isDevice) {
                                $('.icon-common-eye-mobile').trigger("click");
                            }
                            $("#pending-products").hide();
                            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: $o.cookies.pendingProducts, value: "" }]);
                        }
                    }
                    if (attr != $o.core.globalVariables.internalId && !$o.search.sendingProductToCanva) {
                        $o.search.sendingProductToCanva = true;
                        $o.carousel.sentProductToCanva(attr);
                        viewedVM.setActiveTab();
                    }
                    $o.sideBubbles.hide();
                }
            });
        },

        sentProductByAgent: function (parameters) {
            if (parameters.InternalId.indexOf("Oct8neUpload") === -1) {
                $o.productsChat.createSentProductMessage(parameters);
                $o.productsChat.agentSentProducts.push(parameters.InternalId);
            }
        },

        sentManyProductsByAgent: function (parameters) {            
                $o.productsChat.createManyProductsMessage(parameters);
                $o.productsChat.agentSentProducts.push(parameters.InternalId);            
        },

        createSentProductMessage: function (parameters) {
            var name = parameters.Name ? parameters.Name : $o.core.globalVariables.myName;
            if ($o.utils && $o.utils.customSentProductText) {
                let customText = $o.utils.customSentProductText();
                parameters.Body = customText + "<br/><b>" + parameters.Title + "</b>";
            } else {
                parameters.Body = culture.coviewer.TakeALook + "<br/><b>" + parameters.Title + "</b>";
            }

            $o.speak.messages.push(new $o.speak.product({
                body: parameters.Body,
                tokens: parameters.Tokens,
                sentBy: "A",
                name: name,
                time: parameters.Time ? parameters.Time : $o.speak.getMessageTime(),
                internalId: parameters.InternalId,
                thumbnail: parameters.URLMedia,
                title : parameters.Title
            }));
            $o.scroll.moveChatToBottom();
        },

        createManyProductsMessage: function (parameters) {

            var name = parameters.Name ? parameters.Name : $o.core.globalVariables.myName;
            parameters.Body = culture.coviewer.ViewManyProducts,

            $o.speak.messages.push(new $o.speak.manyProducts({
                body: parameters.Body,
                tokens: parameters.Tokens,
                sentBy: "A",
                name: name,
                time: parameters.Time ? parameters.Time : $o.speak.getMessageTime(),
                internalId: parameters.InternalId,
                thumbnail: parameters.URLMedia
            }));
            $o.scroll.moveChatToBottom();
        },
        agentSentProducts: [],
    };
})(window); window.oct8ne = window.$o = window.oct8ne || {};
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.speak = {
        init: function () {
            $o.chat.init();
            $o.productsChat.init();
        },

        getMessageTime: function () {
            var date = new Date(),
                hours = date.getHours(),
                minutes = date.getMinutes();
            // ampm = hours >= 12 ? 'PM' : 'AM';
            //hours = hours % 12;
            //hours = hours ? hours : 12;
            minutes = minutes < 10 ? '0' + minutes : minutes;
            var strTime = hours + ':' + minutes;
            return strTime;
        },

        messages: ko.observableArray([]),

        translatorEnabled: ko.observable(false),

        chat: function (data) {
            this.category = "CHAT";
            this.body = $o.core.replaceDeprecatedCdnUrl(data.body);
            this.translation = ko.observable($o.core.replaceDeprecatedCdnUrl(data.translation));
            this.tokens = data.tokens;
            this.sentBy = data.sentBy;
            this.name = data.name;
            this.time = data.time;
            this.id = data.id;
            this.viewing = data.translation;
            this.type = data.type;
            this.agentImg = data.agentImg;
            this.validationCode = data.validationCode;
        },

        product: function (data) {
            this.category = "PRODUCT";
            this.body = data.body;
            this.tokens = data.tokens;
            this.sentBy = data.sentBy;
            this.name = data.name;
            this.time = data.time;
            this.internalId = data.internalId;
            this.thumbnail = $o.core.replaceDeprecatedCdnUrl(data.thumbnail);
            this.title = data.title
        },

        manyProducts: function (data) {
            this.category = "MANY_PRODUCTS";
            this.body = data.body;
            this.tokens = data.tokens;
            this.sentBy = data.sentBy;
            this.name = data.name;
            this.time = data.time;
            this.internalId = data.internalId;
            this.thumbnail = $o.core.replaceDeprecatedCdnUrl(data.thumbnail);
        },

        canned: function (data) {
            this.category = "CANNED";
            this.body = data.body;
            this.tokens = data.tokens;
            this.sentBy = data.sentBy;
            this.name = data.name;
            this.time = data.time;
            this.type = data.type;
            this.id = data.id;
            this.response = ko.observable(data.response);
        },

        validation: function (data) {
            this.category = "VALIDATION";
            this.code = data.code;
            this.lastMessage = data.lastMessage;
        },
      
        gdpr: function (data) {
            this.category = "GDPR";
            this.body = data.body;
            this.tokens = data.tokens;
            this.sentBy = data.sentBy;
            this.name = data.name;
            this.time = data.time;
            this.type = data.type;
            this.id = data.id;
            this.response = ko.observable(data.response);
        },

        form: function (data) {
            this.category = "FORM";
            this.body = data.body;
            this.tokens = data.tokens;
            this.room = data.room;
            this.sessionSummaryId = data.sessionSummaryId;
            this.sentBy = data.sentBy;
            this.name = data.name;
            this.time = data.time;
            this.type = data.type;
            this.id = data.id;
            this.response = ko.observableArray(data.response);
            this.customText = data.customText;
        },

        docs: function (data) {
            this.category = "DOCS";
            this.body = data.body;
            this.tokens = data.tokens;
            this.sentBy = data.sentBy;
            this.name = data.name;
            this.time = data.time;
            this.type = data.type;
            this.id = data.id;
            this.response = ko.observableArray(data.response);
            this.caption = data.caption;
            this.fromBot = data.fromBot;
        },

        supervisorChat: function (data) {
            this.category = "SUPERVISOR";
            this.body = data.body;
            this.tokens = data.tokens;
            this.sentBy = data.sentBy;
            this.name = data.name;
            this.time = data.time;
            this.role = data.role;
            this.room = data.room;
            this.id = data.id;
        },

    };
})(window);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.translate = {
        toggleTranslation: function (status, agentLanguage, visitorLanguage) {
            $o.translate.isEnabled = status == "true" || status === true ? true : false;
            //para controlar parametros vista en knockout
            $o.speak.translatorEnabled($o.translate.isEnabled);
            $o.translate.agentLanguage = agentLanguage;
            $o.translate.visitorLanguage = visitorLanguage;
            if ($o.core.globalVariables.userType == "A") $o.translateAgent.visitorLanguageDetected = true;
        },

        startTranslation: function (message, type, action) {
            $o.translate.message = message;
            $o.translate.messageType = type;
            action = action || $o.translate.actions.TRANSLATE;
            if (($o.translate.isEnabled === true || action == $o.translate.actions.DETECT) && $o.chat.dontSaveNextMessage!==true) {               
                $o.translate.requestTranslation(action);
            } else {
                $o.translate.translationCallback();
            }
        },

        translationCallback: function (translatedMessage) {
            var translation = translatedMessage ? translatedMessage : "";
            $o.translate.message = {
                original: $o.translate.message,
                translated: translation
            };
            if ($o.translate.messageType == $o.translate.messageTypes.CHAT) {
                if ($o.core.globalVariables.userType == "A" && $o.translateAgent.waitingForReview) {
                    $o.translateAgent.reviewTranslation($o.translate.message);
                } else {
                    $o.chat.send($o.translate.message);
                }
            };
            if ($o.translate.messageType == $o.translate.messageTypes.CANNED) { };
            if ($o.translate.messageType == $o.translate.messageTypes.FORM) { };
        },

        requestTranslation: function (action) {            
            var targetLanguage = $o.core.globalVariables.userType == "A" ? $o.translate.visitorLanguage : $o.translate.agentLanguage;
            var sourceLanguage = $o.core.globalVariables.userType == "A" ? $o.translate.agentLanguage : $o.translate.visitorLanguage;
            var room = $o.core.globalVariables.room;
            var staticUrl = "/Translator",
                actionUrl = "/translate",
                data = {
                    'q': $o.translate.message,
                    'source': sourceLanguage,
                    'target': targetLanguage,
                    'userType': $o.core.globalVariables.userType,
                    'visitorRoom': room
                };

            if (action == $o.translate.actions.DETECT) {
                actionUrl = "/detect";
                data = { 'q': $o.translate.message };
            }
            if (action == $o.translate.actions.PREVIOUS) {
                data.source = targetLanguage;
                data.target = sourceLanguage;
            }

            function sendRequest(retry) {
                $.post(staticUrl + actionUrl, JSON.stringify(data))
                    .done(function (result) {
                        result = JSON.parse(result);
                        $o.translate.requestTranslationCallback(result, action);
                    })
                    .fail(function (xhr, status, error) {
                        if (!retry) {                           
                            setTimeout(function () { sendRequest(true) }, 1000);
                        } else {                                                        
                            if (action == $o.translate.actions.TRANSLATE) {
                                $o.translate.translationCallback("false");
                            }
                            if (action == $o.translate.actions.DETECT) {
                                $o.translateAgent.setVisitorLanguage($o.translate.agentLanguage);
                            }
                            if (action == $o.translate.actions.PREVIOUS) {
                                $o.translateAgent.updatePreviousMessageWithTranslation(false);
                            }
                        }
                        //NO sentry in agent coviewer, we should do a postmessage and a listener in dashboard
                        //if (typeof Sentry !== "undefined") {
                        //    debugger
                        //    Sentry.captureException(new Error(`Translation request failed after retry: ${error}`), {
                        //        extra: {
                        //            action,
                        //            data,
                        //            status,
                        //            xhrResponse: xhr.responseText
                        //        }
                        //    });
                        //}
                       
                    });
            }
           
            sendRequest(false);
        },


        requestTranslationCallback(result,action) {
            var translatedText = "";
            if (action == $o.translate.actions.TRANSLATE) {
                translatedText = result.data.translations[0].translatedText.replace(/&#39;/g, "'").replace(/&quot;/g, '"').replace(/&amp;/g, "&");
                $o.translate.translationCallback(translatedText);
            }
            //acciones del agente
            if (action == $o.translate.actions.DETECT) {
                $o.translateAgent.setVisitorLanguage(result.data.detections[0].language, true);
            }
            if (action == $o.translate.actions.PREVIOUS) {
                translatedText = result.data.translations[0].translatedText.replace(/&#39;/g, "'").replace(/&quot;/g, '"').replace(/&amp;/g, "&");
                $o.translateAgent.updatePreviousMessageWithTranslation(translatedText);
            }
        },
        isEnabled: false,
        providers: {
            "google": {
                name: "GOOGLE",
                logos: {
                    toolBox: "<span class='google-logo icon-agent-translator-logo'><span>Powered by</span></span>",
                    chatInput: "<span class='icon-agent-translator-logo google-logo'></span>"
                }
            },
            "languageWeaver": {
                name: "Language Weaver",
                logos: {
                    toolBox: "<span>Powered by <b>Language Weaver</b></span>",
                    chatInput: "<span class='translate-weaver-logo'>Language Weaver</span>"
                }
            },
            "DeepLTranslator": {
                name: "DeepL",
                logos: {
                    toolBox: "<span>Powered by <b>DeepL</b></span>",
                    chatInput: "<span>DeepL</span>"
                }
            }
        },
        apiKey: "",      
        message: null,
        messageTypes: {
            CHAT: "CHAT",
            CANNED: "CANNED",
            FORM: "FORM"
        },
        actions: {
            DETECT: "DETECT",
            TRANSLATE: "TRANSLATE",
            PREVIOUS: "PREVIOUS",
            //GETLANGUAGELIST: "GETLANGUAGELIST"
        },
        agentLanguage: "",
        visitorLanguage: ""
    };
})(window);
/// <reference path="../../cms/pro/source/adapter-base.js" />
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.core = {
        init: function () {
            $o.core.getHiddenInputs();
            $o.initializeSentry();
        },

        loadingSentryCallback: function () {
            $o.core.globalVariables.timeOffset = $o.core.getTimeOffset();
            if ($o.core.globalVariables.baseUrl.indexOf("drim.pt") !== -1) { //IF para DRIM PT
                $o.core.globalVariables.platform = "vtex";
            }

            if ($o.core.globalVariables.baseUrl.indexOf("musimundo") !== -1) { //IF para MUSIMUNDO
                $o.core.globalVariables.platform = "musimundo";
            }

            $o.core.checkAdapterAndUtils();
        },

        checkAdapterAndUtils: function () {
            //primero comprobamos si hay que cargar archivo de plataforma
            //si hay que crear nuevos, se llamaran igual que $o.core.globalVariables.platform (p.ej. shopify.js)
            if ($o.core.mustLoadPlatformUtils()) {
                $o.core.loadUtilsFile($o.core.utilsTypes.PLATFORM);
            } else {
                //despues si hay que cargar archivo de cliente
                if ($o.core.mustLoadClientUtils()) {
                    $o.core.loadUtilsFile($o.core.utilsTypes.CLIENT);
                } else {
                    //al final miramos si hay que cargar el adapter
                    if ($o.core.globalVariables.platform !== "NONE" && $o.core.globalVariables.edition > 0) {
                        $o.core.loadAdapter();
                    } else {
                        $o.core.loadFunctions();
                    }
                }
            }
        },

        loadFunctions: function () {
            $o.core.userType = $o.core.globalVariables.userType;
            var enterType = $o.core.globalVariables.enterType;
            $o.canva.holder.object = $("#oct8ne-holder");

            $o.core.postMessageFromApiListener();

            //INICIAMOS INTERACCIONES
            var userData = {
                device: Core.Helpers.isDevice(),
                type: Core.Helpers.getUserType()
            };

            Interactions.init(userData);

          //construimos los viewModels de KO
            window.searchVM = new searchViewModel();
            window.viewedVM = new viewedViewModel();
            window.mycartVM = new mycartViewModel();
            window.mylistVM = new mylistViewModel();
            window.customResxVM = new customResxViewModel();
            window.conferenceVM = null;


            $o.core.youtubeViewModel = new YouTubeViewer("youtubevideoplayer"); // TODO: Pensar en cargarlo mas tarde??!

            $o.core.viewModel = {
                youtube: $o.core.youtubeViewModel,
                search: window.searchVM,
                viewed: window.viewedVM,
                mycart: window.mycartVM,
                mylist: window.mylistVM,
                resx: window.customResxVM
            };

            if ($o.core.userType === "V") {
                $o.visitorSearch.init();
                if ($o.core.globalVariables.conferenceProvider && window.location.href.indexOf("https") === 0) {
                    $o.visitorStart.checkVisitorCapabilities();
                } else {
                    $o.visitorStart.doStart(enterType);
                }
            } else {
                if ($o.core.globalVariables.supervisorMode != "false" && $o.core.globalVariables.supervisorMode != "undefined" && $o.core.globalVariables.supervisorMode !== "") {
                    $o.supervisorMode.init($o.supervisorMode.roles.SUPERVISOR);
                }
                $o.core.agentsConnected = true;
                $o.agentSearch.init();
                if ($o.core.globalVariables.showTranslator.length) $o.translateAgent.init();

                //recupera interacciones del visitor

                // Log urls with sentry =================
                window.setSentryContext('Token visitor', { visitor: $o.core.globalVariables.visitorToken });
                window.setSentryContext('Token session', { room: $o.core.globalVariables.tokenSession });
                // Log urls with sentry =================

                $o.recoverRecords.getRecords($o.core.globalVariables.visitorToken, $o.core.globalVariables.tokenSession);
                window.agentCatalogVM = new agentCatalogViewModel();
                $o.agentInfoVisitorVM = new $o.agentInfoVisitorViewModel();
                ko.applyBindings($o.core.viewModel); //No hace falta aplicar los bindings si desde la vista hacemos un data-bind = 'with: xxxxxxxxVM'

                $o.agentTools.getCommonPhrases();
                $o.hubsOut.newViewerCreated($o.core.globalVariables.otherToken);
                $(".oct8ne-nodes").removeAttr("style");
                $o.fullProducts.recoverProductsFromLocalStorage();
                $o.agentCopilot.checkAvailability();
            }
            $("#oct8ne-chat-room").css("visibility", "visible");
        },
        //CONDICIONES PARA CARGAR O NO ARCHIVO DE PLATFORM
        mustLoadPlatformUtils: function () {
            var response = ($o.core.globalVariables.platform === "prestashop" || $o.core.globalVariables.platform === "wordpress" || $o.core.globalVariables.platform === "wordpress_v1" || $o.core.globalVariables.platform === "vtex" || $o.core.globalVariables.platform === "shopify" || $o.core.globalVariables.platform === "vtexio" || $o.core.globalVariables.platform === "tiendanube" || $o.core.globalVariables.platform === "mercadoshop" || $o.core.globalVariables.platform === "bigcommerce" || $o.core.globalVariables.platform === "shopware" || $o.core.globalVariables.platform === "LogiCommerce") && !$o.core.platformUtilsLoaded ? true : false;
            return response;
        },
        //CONDICIONES PARA CARGAR O NO ARCHIVO DE CLIENTE
        mustLoadClientUtils: function () {
            var response = ($o.core.globalVariables.clientUtils.length && $o.core.globalVariables.clientUtils !== "NULL" && $o.core.globalVariables.clientUtils !== "undefined") && (!$o.core.clientUtilsLoaded) ? true : false;
            return response;
        },

        loadUtilsFile: function (type) {
            var urlFile;
            if (type === $o.core.utilsTypes.PLATFORM) {
                urlFile = $o.core.globalVariables.cdnUrl + "api/source/js/utils/platforms/" + $o.core.globalVariables.platform.toLowerCase() + ".js?" + $o.core.getDateForCaching();
            } else if (type === $o.core.utilsTypes.CLIENT) {
                if ($o.core.globalVariables.clientUtils.indexOf("https://") > -1) {
                    urlFile = $o.core.globalVariables.clientUtils;
                } else {
                    urlFile = $o.core.globalVariables.cdnUrl + "api/source/js/utils/clients/" + $o.core.globalVariables.clientUtils + ".js?" + $o.core.getDateForCaching();
                }
            }
            $.ajax({
                type: "GET",
                url: urlFile,
                success: function () {
                    if (type === $o.core.utilsTypes.PLATFORM) {
                        $o.core.platformUtilsLoaded = true;
                    } else if (type === $o.core.utilsTypes.CLIENT) {
                        $o.core.clientUtilsLoaded = true;
                    }
                    // oct8ne.log("Utils "+ type + " CARGADO");
                    $o.core.checkAdapterAndUtils();
                },
                error: function () {
                    $o.core.errorHandler($o.core.typeHandleError.UTILS);
                },

                dataType: "script",
                cache: true
            });
        },

        loadAdapter: function () {
            var platformFileUrl;
            var adapterType = null;
            var cmsUrl = "api/source/js/cms/";

            if ($o.core.globalVariables.edition < $o.core.editions.PRO) { //GET LITE ADAPTER
                adapterType = $o.core.adapters.LITE;

                if ($o.core.globalVariables.apiVersion == "2.4" || $o.core.globalVariables.apiVersion == "2.5") {
                    $o.core.globalVariables.apiVersion = "2.3";
                }

                platformFileUrl = cmsUrl + "lite/adapter-lite-" + $o.core.globalVariables.apiVersion + ".min.js?";
            } else { //GET PRO ADAPTER
                adapterType = $o.core.adapters.PRO;

                if ($o.core.globalVariables.apiVersion == "2.5") {
                    platformFileUrl = cmsUrl + "pro/adapter-" + "2.4.js?" //+ ".min.js?";
                } else {
                    platformFileUrl = cmsUrl + "pro/adapter-" + $o.core.globalVariables.apiVersion + ".js?";
                }
            }

            if ($o.core.globalVariables.baseUrl.indexOf("idherma") > -1) {
                platformFileUrl = "api/source/js/utils/clients/idherma.js?";
            }

            $.ajax({
                type: "GET",
                url: $o.core.globalVariables.cdnUrl + platformFileUrl + $o.core.getDateForCaching(),
                success: function () {
                    //  oct8ne.log("Adapter CARGADO: " + platformFileUrl);
                    $o.core.adapterLoaded = adapterType;

                    $o.platform.init();
                    $o.core.loadFunctions();
                },
                error: function () {
                    $o.core.errorHandler($o.core.typeHandleError.ADAPTER);
                },

                dataType: "script",
                cache: true
            });
        },

        errorHandler: function (type) {
            if (type === $o.core.typeHandleError.UTILS) {
                ++$o.core.getClientFileRetries;
                if ($o.core.getClientFileRetries < $o.core.getFilesMaxRetries) {
                    $o.core.checkAdapterAndUtils();
                }
                else { //Cargamos las funciones para que no den error y mostramos cartel de error.
                    $o.core.platformUtilsLoaded = true;
                    $o.core.clientUtilsLoaded = true;
                    $o.core.checkAdapterAndUtils();
                    $o.core.displayErrorInViewer(type);
                }
            } else { //Es adapter
                ++$o.core.getAdapterFileRetries;
                if ($o.core.getAdapterFileRetries < $o.core.getFilesMaxRetries) {
                    $o.core.checkAdapterAndUtils();
                }
                else {//Cargamos las funciones para que no den error y mostramos cartel de error.
                    $o.recoverRecords.startingRecoverViewer = false;
                    $o.core.loadFunctions();
                    $o.core.displayErrorInViewer(type);
                }
            };
        },

        displayErrorInViewer: function (type) {
            var message = 'Error ' + type + ': not loaded correctly --- Domain:' + $o.core.globalVariables.baseUrl + '--- UserType:' + $o.core.globalVariables.userType;
            //(new Image()).src = '/JSError?message=' + message + '&url=none&line=00&column=00';
            var info = '<p>Error ' + type + ': not loaded correctly</p>';
            $(".error-type").append(info);
            $("#server-overload").show();
        },

        postMessageFromApiListener: function () {
            function messageFromApi(message) {   
                if (!$o.utils || !$o.utils.enableAllSitesMessages) {
                    if (message.origin !== $o.core.globalVariables.origin) return;
                }
                if (typeof message !== "object" || message.data === undefined || typeof message.data !== 'string' || message.data.length == 0) { return; }
                var info = message.data.split(","),
                    action = info[0];

                if (action === "RESIZETOCHAT") {
                    if ($o.iframes.currentIframeStatus == $o.iframes.iframeStatus.SEARCH || $o.iframes.currentIframeStatus == $o.iframes.iframeStatus.VIEWER || $o.iframes.currentIframeStatus == $o.iframes.iframeStatus.MINIMIZED) {
                        $o.iframes.changeStatusIframe($o.iframes.iframeStatus.CHAT, "", "clickOnPage");
                        $("#all-wrapper").show();
                        // $("#coviewer-minimized-no-agent,#coviewer-minimized").hide();
                    }
                }
                if (action == "MOBILE_KEYBOARD_HIDDEN") {
                    var hasFocus = $("#chat-input").is(':focus');
                    if (hasFocus) {
                        $("#chat-input").blur();
                    };
                }
                if (action == "SHOWFINALIZEDSESSION") {
                    $("#lay-AFK .afk-content-advice").text(culture.coviewer.AdviceNotInDic);
                    $o.visitorStart.showLayAFK();
                    $("#chat-input").blur();
                    if ($.connection.hub.state != $.signalR.connectionState.disconnected) $.connection.hub.stop();
                    $o.core.globalVariables.sessionFinalized = true;
                }

                if (action == "MINIMIZEORCLOSEMOBILE") {
                    $("#close-iframe-visitor").trigger("click");
                }
                if (action === "HIDESUBMENU") {
                    if ($(".chat-menu-options").is(":visible")) {
                        $(".chat-menu").attr("aria-expanded", "false");
                        $(".chat-menu-options").hide();
                    }
                }
                if (action === "RETURNPARAMETERS") {
                    var data = message.data.split("RETURNPARAMETERS,");
                    $o.visitorStart.getVisitorStartData(JSON.parse(data[1]));
                }
                if (action === "MAXIMIZEMOBILERESKYT") {
                    $("#minimized-widget").trigger("click");
                }
                if (action === "RESIZEFROMAPI") {
                    if ($o.core.globalVariables.device === "desktop") {
                        $o.iframes.changeStatusIframe(info[1]);
                    } else {
                        $("#minimized-widget").trigger("click");
                        if (info[1] == "CHAT") {
                            $("#mobile-menu .icon-common-chat-mobile").trigger("click");
                        } else if (info[1] == "SEARCH") {
                            $("#mobile-menu .icon-common-eye-mobile").trigger("click");
                        };
                    }
                }
                if (action === "SENDCHATTOIFRAME") {
                    function isInt(value) {
                        return !isNaN(value) && (function (x) { return (x | 0) === x; })(parseFloat(value))
                    }
                    if (info.length > 2 && isInt(info[2])) {
                        var triggerId = info[2];
                        //var queryString = "?domainId=" + $o.core.globalVariables.domainId + "&tokenVisitor=" + $o.variablesVisitor.tokenVisitor + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId + "&tokenSession=" + $o.core.globalVariables.room;
                        //$.post("/Oct8ne/UpdateLastTriggerLaunched" + queryString, { triggerId: triggerId });
                        $o.saveRecord.launchedTrigger(JSON.parse(triggerId));
                    }
                    $o.canned.sendCanned($o.canned.type.TRIGGER, decodeURIComponent(info[1]));
                }
                if (action === "VIDEOINITFROMEMBED") {
                    $o.visitorStart.videoInitFromEmbed();
                }
                if (action === "HIDEMEBYNEWTAB") {
                    $o.visitorStart.hideMeByNewTab();
                }
                if (action == "GETOCT8NEOPTIONS") {
                    var data = message.data.split("GETOCT8NEOPTIONS,");
                    var pageInfo = JSON.parse(data[1]);
                    $o.core.globalVariables.customOptions = (pageInfo.hasOwnProperty("context")) ? pageInfo : "";

                    if ($o.core.globalVariables.customOptions) {
                        $o.saveRecord.contextInfo($o.core.globalVariables.customOptions);
                    }

                }
            };

            if (window.addEventListener) addEventListener("message", messageFromApi, false);
            else attachEvent("onmessage", messageFromApi);
        },

        getHiddenInputs: function () {
            var userType = $("#user-type").val();
            var getCurrencySide = userType === "V" ? $("#base-url").val() : $("#url-domain").val();

            $o.core.globalVariables = {
                //VARIABLES
                /*AGENTE*/
                mySkype: $("#my-skype").val(),
                myPhone: $("#my-phone").val(),
                urlDomain: $("#url-domain").val(),
                baseUrl: $("#base-url").val(),
                tokenSession: $("#token-session").val(),
                visitorToken: $("#token-visitor").val(),

                myToken: $("#my-token").val(),
                showCoviewer: $("#show-coviewer").val(),
                allowPreviousChat: $("#allow-previous-chat").val() === "true" ? true : false,
                agentLanguage: $("#agent-language").val(),
                forceTags: $("#force-tags").val() === "true" ? true : false,
                visitorEmail: $("#visitor-email").val(),
                allowCopilot: $("#allow-copilot").val() === "true" ? true : false,

                /*VISITANTE*/
                myShopId: $("#my-shop-id").val(),
                enterType: $("#enter-type").val(),
                recoverSession: $("#token-session").val(),
                loginUrl: $("#login-url").val(),
                device: $("#device").val(),
                apiVersion: $("#api-version").val(),
                cartRedirecionForced: $("#cart-redirection-forced").val(),
                enabledDepartments: $("#enabled-departments").val(),
                chromeExtensionId: $("#chrome-ss-extension-id").val(),
                isTypingWithText: $("#is-typing-text").val(),
                origin: $("#origin").val(),
                finishedVisitorStart: false,
                startedBotOffline: false,


                /*COMUN*/
                platform: $("#platform").val(),
                myName: $("#my-name").val(),
                myEmail: $("#my-email").val(),
                otherName: $("#other-name").val(),
                userType: userType,
                urlMedia: $("#url-media").val(),
                internalId: $("#internal-id").val(),
                protocolHttp: $("#protocol-http").val(),
                currencyVisitor: getCurrencySide.indexOf("berakamall") > -1 ? "" : $("#currency-visitor").val() ? $("#currency-visitor").val() : "$",
                locale: $("#locale").val(),
                visitorProtocolPage: $("#visitor-protocol-page").val(),
                //pluginVersion: $("#plugin-version").val(),
                agentsConnected: $("#agents-connected").val(),
                edition: parseInt($("#edition").val()),
                showSearch: $("#show-search").val(),
                conferenceProvider: $("#conference-provider").val(),
                showTranslator: $("#show-translator").val(),
                translatorProvider: $("#translator-provider").val(),
                catalogServer: $("#catalog-server").val(),
                clientUtils: $("#client-utils").val(),
                cdnUrl: $("#cdn-url").val(),
                uploadUrl: $("#upload-url").val(),
                //chequeamos si el Id del agente es valido (integer)
                inviteLinkAssignedAgent: $o.core.isNormalInteger($("#invite-link-assigned-agent").val()) ? parseInt($("#invite-link-assigned-agent").val()) : null,
                inviteLinkExclusiveAgent: $("#invite-link-exclusive-agent").val() === "True" ? true : false,
                visitorsOverflow: $("#visitors-overflow").val() === "True" ? true : false,
                sessionSummaryId: $("#session-summary-id").val(),
                supervisorMode: $("#supervisor-mode").val(),
                domainId: $("#domain-id").val(),
                sessionFinalized: false,
                room: userType === "V" ? $("#token-room").val() : $("#other-token").val(),
                roomForLastOperations: userType === "V" ? $("#token-room").val() : $("#other-token").val(), //Room para usar en caso de finalizacin de sessin en bot y alguien quiere rellenar el formulario ContactUs, la variable room est borrada por finalizar la session
                serverZone: $("#environment").val(),
                oct8neVersion: $("#oct8ne-version-number").val(),
                triggerId: $o.enterData.triggerId
            }
            //console.log($("#visitors-overflow").val());
            //console.log("visitorsOverflow: " + $o.core.globalVariables.visitorsOverflow);
            //$("#hiddens-model").remove();
        },

        placeHolderIE: function () {
            $('[placeholder]').focus(function () {
                var input = $(this);
                if (input.val() === input.attr('placeholder')) {
                    input.val('');
                    input.removeClass('placeholder');
                }
            }).blur(function () {
                var input = $(this);
                if (input.val() === '' || input.val() === input.attr('placeholder')) {
                    input.addClass('placeholder');
                    input.val(input.attr('placeholder'));
                }
            }).blur().parents('form').submit(function () {
                $(this).find('[placeholder]').each(function () {
                    var input = $(this);
                    if (input.val() === input.attr('placeholder')) {
                        input.val('');
                    }
                });
            });
        },

        centerImage: function (img, maxWidth, maxHeight) {
            maxHeight = maxHeight || maxWidth;
            var result, margin;

            if (img.naturalWidth > $o.core.maxImageSize || img.naturalHeight > $o.core.maxImageSize) { img.src = 'api/img/core/no-thumb-resources.png' };

            img.removeAttribute('style');
            if (img.naturalWidth > img.naturalHeight) {
                img.style.width = maxWidth + "px";
                img.style.height = "auto";
            } else if (img.naturalWidth < img.naturalHeight) {
                img.style.height = maxHeight + "px";
                result = (img.naturalWidth * maxHeight / img.naturalHeight);
                margin = (result - maxWidth) / 2;
                img.style.marginLeft = -margin + ("px");
            } else {
                img.style.width = maxWidth + "px";
                result = (img.naturalHeight * maxWidth / img.naturalWidth);
                margin = (result - maxHeight) / 2;
                img.style.marginTop = -margin + ("px");
            }
        },

        getDateForCaching: function () {
            //4 horas: 14400000
            var dateCache = (Math.round(new Date().getTime() / 14400000));
            return dateCache;
        },

        isNormalInteger: function (str) {
            var n = Math.floor(Number(str));
            return String(n) === str && n >= 0;
        },

        isSignalRConnected: function () {
            //descomentar esta linea para ver la funcion que esta petando al enviar a signalr
            //console.log(arguments.callee.caller.toString());
            var connection = ($o.core.globalVariables.userType === "V" && $.connection.hub.state !== $.signalR.connectionState.disconnected) || $o.core.globalVariables.userType === "A";
            //console.log("connection es:" + connection);
            if ($o.core.agentsConnected && connection) {
                //console.log("Conectado, enviamos");
                return true;
            } else {
                //console.log("NO Conectado");
                return false;
            }
            //return $o.core.agentsConnected && $.connection.hub.state != $.signalR.connectionState.disconnected ? true : false;
        },

        visitorIsGone: function () {
            $o.core.globalVariables.isGone = true;
            $(".header-coviewer").addClass("title-visitor-is-gone");
            $("#visitor-is-gone-title").show();
            $("#title-page").hide();
            $("#tools-agent ul").addClass("viewer-visitor-is-gone");
            $("#common-phrases").addClass("viewer-visitor-is-gone");
            $(".chat-send").addClass("viewer-visitor-is-gone");
            $("#coviewer-wrapper").addClass("viewer-visitor-is-gone");
            $("#display-agent-searches").addClass("viewer-visitor-is-gone");
            $("#searches-section .header-content").addClass("viewer-visitor-is-gone");
            $("#agent-results, #search-panel, .search-selection").addClass("viewer-visitor-is-gone");
            $("#chat-tool").trigger("click");
            $(".info-visitor-orders").remove();
            $("#display-info-visitor").trigger("click");
        },

        getTimeOffset: function () {
            return new Date().getTimezoneOffset();
        },

        doPostMessageToApi: function (method, dataString, paramToTest) {
            if (method === null || method.length === 0) { throw "PostMessage METHOD not valid-> " + method + " : " + dataString; };
            if (dataString !== undefined && (typeof dataString !== "string" || dataString === "")) { throw "PostMessage DATA not valid-> " + method + " : " + dataString; };

            // test validations: delete
            if (paramToTest) throw "PostMessage PARAM not accepted  -> " + method + " : " + dataString + " : " + paramToTest;
            if (method.endsWith(",")) { throw "PostMessage METHOD ends with comma -> " + method + " : " + dataString; };
            if (dataString === "*" || paramToTest === "*") { throw "PostMessage PARAM is * " + method + " : " + dataString + " : " + paramToTest; }
            // test validations: delete
            //delete paramToTest too

            var target = document.referrer;
            if (target == "") { target = "*"; };
            //console.log(method + " -- " + dataString)
            parent.postMessage(method + "," + dataString, target);
        },

        replaceDeprecatedCdnUrl(text) {           
            if (typeof text == 'string') {               
                text= text.replace(/oct8neuploadcdneu.azureedge.net/gi, 'staticupload-eu.oct8ne.com');
                return text.replace(/oct8neuploadcdn.azureedge.net/gi, 'staticupload.oct8ne.com');
            } else {
                return text;
            }
        },

        agentsConnected: "",
        userType: "",
        platform: "",
        enterType: {
            SEARCHCATALOG: "SEARCHCATALOG",
            REOPEN: "REOPEN",
            CHECKOUT: "CHECKOUT",
            RECOVERSESSION: "RECOVERSESSION",
            TALKEXPERT: "TALKEXPERT",
            TALKEXPERTBAR: "TALKEXPERTBAR",
            REOPENFROMLOGIN: "REOPENFROMLOGIN",
            LOGINPAGE: "LOGINPAGE",
            LIVECHAT: "LIVECHAT",
            SCHEDULE: "SCHEDULE",
            PINCODE: "PINCODE",
            SEARCHBOX: "SEARCHBOX",
            TRACKINGBAR: "TRACKINGBAR",
            PRODUCTPAGE: "PRODUCTPAGE",
            AUTOOPEN: "AUTOOPEN",
            TRIGGER: "TRIGGER",
            VIPAREA: "VIPAREA",
            POPUP: "POPUP",
            TREEPREVIEW: "TREEPREVIEW"
        },
        conferenceVars: {
            STARTING: "STARTING",
            END: "END",
            ACCEPT: "ACCEPT",
            ENDED: "ENDED", //INTERACCION DE LOS EVENTOS END
            STARTED: "STARTED", //INTERACCION DE LOS EVENTOS START
            SCREENSHARED: "SCREENSHARED",
            STARTINGCAM: "STARTINGCAM",
            ENDCAM: "ENDCAM"
        },
        hasBeenWaiting: false,
        youtubeViewModel: null,
        editions: {
            FREE: 0,
            LITE: 1,
            PRO: 2,
            ENTERPRISE: 3
        },
        adapters: {
            ANY: 0,
            CATALOG: 1,
            LITE: 2,
            PRO: 3
        },
        adapterLoaded: "",
        clientUtilsLoaded: false,
        platformUtilsChecked: false,
        utilsTypes: {
            PLATFORM: "PLATFORM",
            CLIENT: "CLIENT"
        },
        typeHandleError: {
            ADAPTER: "ADAPTER",
            UTILS: "UTILS"
        },
        maxImageSize: 8000,
        getClientFileRetries: 0,
        getAdapterFileRetries: 0,
        getFilesMaxRetries: 3,
        localStorageTypes: {
            INACTIVITYAGENT: "oct8ne-inactivity-agent",
            INACTIVITYAGENTSJUMP: "oct8ne-inactivity-agent-jumps",
            INACTIVITYVISITOR: "oct8ne-inactivity-visitor",
            SEARCHCACHE: "oct8ne-search-cache",
            PRODUCTSCOLLECTION: "oct8ne-products-collection",
            PENDINGLIST: "oct8ne-pending-list",
            JUSTLOOKINGBUTTON: "oct8ne-just-looking-button",
            JUSTLOOKINGOPTION: "oct8ne-just-looking-option",
            SOUND: "oct8ne-sound",
            CALL: "oct8ne-call",
            OTCURRENTSESSION: "ot-current-session",
            OTCURRENTTOKEN: "ot-current-token",
            HIDENEWTUTORIAL: "oct8ne-hide-tutorial",
            LASTDISPLAY: "oct8ne-last-display",
            COVIEWERZOOM: 'oct8ne-coviewer-zoom-size-key',
            AGENTCOVIEWERESPONSIVE: 'oct8ne-coviewer-responsive',
            AGENTCOVIEWERESPONSIVEEXPANDEDCHAT: 'oct8ne-coviewer-responsive-expanded-chat',
            COVIEWERFONTSIZE: 'oct8ne-coviewer-font-size-key',
            AGENTSEARCHRESULTSTYPELIST: 'oct8ne-agent-search-type-list',
            Oct8neProvisionalInteractions: 'oct8ne-provisional-interactions',
            FORCEDHUMANINTERACTION: 'oct8ne-forced-human-interaction'
        },
        localStorageActions: {
            REMOVE: "REMOVELOCALSTORAGEVALUE"
        }
    };

    oct8ne.log = function (info, type) {
        if (oct8ne.enableLog) console[type || "log"](info);
    };
    oct8ne.enableLog = (document.cookie.indexOf('oct8ne-log') > -1) ? true : false;

    oct8ne.initializeSentry = function () {
        window.setSentryContext = function (title, objectKeyValues) {
            if (typeof title !== 'string' || title === '') title = 'No title defined';
            if (typeof objectKeyValues !== 'object') objectKeyValues = { message: 'No object context passed' };

            try {
                Sentry.setContext(title, objectKeyValues);
            }
            catch (e) { console.warn('Sentry.setContext failed => ' + e) }
        };

        // Load sentry        
        var environment = $o.core.globalVariables.serverZone;

        if (environment === "Local" || $o.core.globalVariables.userType === "V") {
            $o.core.loadingSentryCallback();
            return;
        }

        var script = document.createElement('script');
        script.src = 'https://browser.sentry-cdn.com/6.15.0/bundle.min.js';
        script.integrity = "sha384-uAr9Te+rNkmpaCjPTu4/ipQDpO1nR6fEY8JX+NHVNO5mY6LUs362JWJD8rHyaLEt";
        script.crossOrigin = "anonymous";
        document.head.append(script);

        script.onload = function () {
            var environment = $o.core.globalVariables.serverZone;
            var version = $o.core.globalVariables.oct8neVersion;
            var release = "oct8ne-visor@" + version;
            Sentry.init({
                dsn: "https://30a23526c3194cce928ac922dd06e8fb@o1075899.ingest.sentry.io/6078940",
                tracesSampleRate: 0.5,
                environment: environment,
                release: release,
            });

            var domainId = $o.core.globalVariables.domainId;
            var urlDomain = $o.core.globalVariables.baseUrl;
            var room = $o.core.globalVariables.tokenSession;
            var shortDomainName = typeof urlDomain === 'string' && urlDomain !== '' ? urlDomain.substring(0, 50) : 'unknown';
            var domainName = shortDomainName + '-' + domainId;
            var sessionId = 'DM' + domainId + '-ROOM: ' + room;

            var side = $o.core.globalVariables.userType == "V" ? "Visitor" : "Agent";

            Sentry.setTag('domainId', domainId);
            Sentry.setTag('sessionId', sessionId);
            Sentry.setTag('domainName', domainName);
            Sentry.setTag('side', side);
            Sentry.setTag('room', room);

            window.oct8neVisorSentry = {
                release: release,
                environment: environment,
                domainId: domainId,
                domainName: domainName,
                sessionId: sessionId,
                side: side,
                room: room
            };

            $o.core.loadingSentryCallback();
            // console.log('Sentry initialized', window.oct8neVisorSentry);
        };

        script.onerror = function (e) {
            $o.core.loadingSentryCallback();
            console.error('Sentry script could not be loaded', e);
        };
    };

})(window);
var customResxViewModel = function () {
    var self = this;

    self.resx = ko.observable(
        Object.fromEntries(
            Object.entries($o.customTextsList).map(([key, value]) => [key, ko.observable(value)])
        )
    );
    self.getResx = function (text) {
        return self.resx()[text];
    };

    self.updateResx = function (key, value) {
        var updatedResx = self.resx();
        updatedResx[key] = value;
        self.resx(updatedResx);
    };
}
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.drag = {
        init: function () {
            //Checks the center of the coviewer
            //$("#oct8ne-holder").css("position", "relative").append("<div style='position: absolute; top: 50%; left:50%; width:2px; height:2px; background: red'></div>");

            $o.drag.events();
        },

        sendPoint: function (event) {
            ++$o.drag.pointId;
            var coords = $o.canva.getCoords(event),
                coviewerRelativeCoords = $o.canva.getCoviewerRelativeCoords(event),
                point = {
                    MarkId: $o.drag.pointId + $o.core.userType,
                    Coords: {
                        PosX: coords.absleft,
                        PosY: coords.abstop
                    },

                    InternalId: $o.core.globalVariables.internalId,
                    URLMedia: $o.core.globalVariables.urlMedia,
                    Room: $o.core.globalVariables.room,
                    SentBy: $o.core.userType,
                    Type: "O",


                    //Propiedades para app mvil
                    CoordsCoviewer: {
                        PosX: coviewerRelativeCoords.relLeft,
                        PosY: coviewerRelativeCoords.relTop
                    },
                    CoordsImage: {
                        PosX: parseFloat($o.canva.holder.helper.css("left")),
                        PosY: parseFloat($o.canva.holder.helper.css("top"))
                    },
                    ProductInternalID: $o.core.globalVariables.internalId,
                    ImageUrl: $o.core.globalVariables.urlMedia,
                    ZoomLevel: $o.zoom.level,
                    SizeImage: {
                        Width: $o.canva.holder.helper.width(),
                        Height: $o.canva.holder.helper.height()
                    },
                    SizeCoviewer: {
                        Width: $("#oct8ne-holder").width(),
                        Height: $("#oct8ne-holder").height()
                    }
                };

            $o.drag.addPoint(point);

            if ($o.core.isSignalRConnected()) {
                $o.hubsOut.sendPoint(point);
            }
        },

        addPoint: function (parameters, recover) {
            $o.drag.addPointUI(parameters, recover);
        },

        changeDrag: function (parameters, recover) {
            if ($o.core.isSignalRConnected() && !recover) $o.hubsOut.addInteraction(parameters);
            var absPosition = {
                top: parameters.Coords.PosY,
                left: parameters.Coords.PosX
            };

            if ($o.drag.parametersHaveProportionalCoords(parameters)) {
                absPosition = $o.drag.calculateAbsolutePosition(parameters.CoordsProportionals);
            } else {
                // Sender data
                var imagePositionInSender = {
                    top: parameters.Coords.PosY,
                    left: parameters.Coords.PosX
                }
                var imageSizeInSender = {
                    width: parameters.SizeImage.Width,
                    height: parameters.SizeImage.Height
                }

                var coviewerSizeInSender = {
                    width: parameters.SizeCoviewer.Width,
                    height: parameters.SizeCoviewer.Height
                }

                //Receiver data
                var coviewerSizeInReceiver = {
                    width: $("#oct8ne-holder").width(),
                    height: $("#oct8ne-holder").height()
                }

                var imageSizeInReceiver = {
                    width: $("#oct8ne-helper").width(),
                    height: $("#oct8ne-helper").height()
                }

                //Calculate pixel that is in the center of the coviewer in sender
                var imagePixelInCenter = {
                    left: Math.abs(imagePositionInSender.left) + (coviewerSizeInSender.width / 2),
                    top: Math.abs(imagePositionInSender.top) + (coviewerSizeInSender.height / 2)
                }

                var imagesRatio = {
                    width: imageSizeInReceiver.width / imageSizeInSender.width,
                    height: imageSizeInReceiver.height / imageSizeInSender.height
                }

                var posInNewCoviewer = {
                    left: (coviewerSizeInReceiver.width / 2) - (imagePixelInCenter.left * imagesRatio.width),
                    top: (coviewerSizeInReceiver.height / 2) - (imagePixelInCenter.top * imagesRatio.height),
                }

                absPosition = {
                    left: posInNewCoviewer.left,
                    top: posInNewCoviewer.top
                }

                $o.canva.target.top = absPosition.top;
                $o.canva.target.left = absPosition.left;

                $o.canva.holder.helper.animate({ left: absPosition.left, top: absPosition.top }, 300);
            }
        },

        parametersHaveProportionalCoords: function (params) {
            if (params.hasOwnProperty("CoordsProportionals") &&
                params.CoordsProportionals != null &&
                params.CoordsProportionals.hasOwnProperty("PosX") &&
                params.CoordsProportionals.hasOwnProperty("PosY")) {
                return true;
            } else {
                return false;
            }
        },

        calculateAbsolutePosition: function (relativeCoords) {
            //Valor entre 0 y 1
            //Respecto al tamao de la imagen activa del visor
            var image = {
                width: $o.canva.holder.helper.width(),
                height: $o.canva.holder.helper.height()
            };

            var maxInset = {
                left: $o.canva.holder.object.width() - image.width,
                top: $o.canva.holder.object.height() - image.height
            };
            var absoluteCoords = {
                left: maxInset.left * relativeCoords.PosX,
                top: maxInset.top * relativeCoords.PosY
            };
            return absoluteCoords;
        },

        object: null,
        pointId: 0,
        enablePointing: true
    };
})(window);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.filters = { //DEPRECATED
        init: function () {
           
            $o.filters.events();
        },

       // createFilters: function (data, idCapa) {
      //     console.log("createFilters");
       //     searchVM.printFiltersBySearch();
            //var availableFilters;
            //if ($o.core.userType == "V") {
            //    availableFilters = $o.filters.createFiltersVisitor(data);
            //}
            //    //else if ($o.core.userType == "A" && idCapa == "filters-panel-visitor-searches") {
            //    //    availableFilters = $o.filters.createFiltersAgentWithIdVisitor(data);
            //    //}
            //else {

            //    availableFilters = $o.filters.createFiltersAgent(data);
               
            //}

            //$o.filters.printFilters(data, idCapa, availableFilters);

      //  },

        appliedFilters: ""
        //appliedFiltersAgentSearch: "",
        //appliedFiltersVisitorLastSearch: ""


    };
})(window);
var Core;
(function (Core) {
    var Helpers = (function () {
        function Helpers() {
        }
        Helpers.isDevice = function () {
            if ($o.core.globalVariables.device === "mobile") {
                return true;
            }
            else {
                return false;
            }
        };
        ;
        Helpers.getDomainId = function () {
            return $o.core.globalVariables.domainId;
        };
        ;
        Helpers.getTokenRoom = function () {
            return $o.core.globalVariables.room;
        };
        ;
        Helpers.getSessionSummaryId = function () {
            if (Core.Helpers.getUserType() === UserTypes.Agent) {
                return $o.core.globalVariables.sessionSummaryId;
            }
            else {
                return $o.variablesVisitor.sessionSummaryId;
            }
        };
        ;
        Helpers.getUserType = function () {
            if ($o.core.globalVariables.userType === UserTypes.Agent) {
                return "A";
            }
            else {
                return "V";
            }
        };
        Helpers.generateId = function () {
            return $o.tools.generateRandomId();
        };
        Helpers.getTime = function () {
            return $o.speak.getMessageTime();
        };
        Helpers.getMyName = function () {
            return $o.core.globalVariables.myName;
        };
        Helpers.getCurrentInternalId = function () {
            return $o.core.globalVariables.internalId;
        };
        Helpers.getCurrentImageUrl = function () {
            return $o.core.globalVariables.urlMedia;
        };
        Helpers.isRealTimeConnected = function () {
            var connection = ($o.core.globalVariables.userType === "V" && $.connection.hub.state !== $.signalR.connectionState.disconnected) || $o.core.globalVariables.userType === "A";
            if ($o.core.agentsConnected && connection) {
                return true;
            }
            else {
                return false;
            }
        };
        Helpers.cleanMarkdown = function (md) {
            var output = md || '';
            try {
                output = output.replace(/^#{1,6}\s*(.+)$/gm, function (_, texto) { return "<b>".concat(texto.trim(), "</b>"); });
                output = output
                    .replace(/^(-\s*?|\*\s*?|_\s*?){3,}\s*/gm, '')
                    .replace(/\n={2,}/g, '\n')
                    .replace(/~{3}.*\n/g, '')
                    .replace(/```[\s\S]*?```/g, '')
                    .replace(/\*\[.*\]:.*\n/, '')
                    .replace(/^[=\-]{2,}\s*$/g, '')
                    .replace(/^\[\^.+?\]: .*$/gm, '')
                    .replace(/\s{0,2}\[.*?\]: .*?$/g, '')
                    .replace(/^(\n)?\s{0,3}>\s?/gm, '$1');
                output = output.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                output = output.replace(/\*([A-Za-z0-9][^*]*?)\*/g, '<i>$1</i>');
                output = output.replace(/__(.*?)__/g, '<u>$1</u>');
                output = output.replace(/\[([^\]]+)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
                output = output.replace(/(`{3,})(.*?)\1/gms, '$2');
                output = output.replace(/`(.+?)`/g, '$1');
                output = output.replace(/^(\s*)[-*]\s+/gm, '$1- ');
                output = output.replace(/^(\s*)(\d+)\.\s+/gm, function (_, espacio, num) { return "".concat(espacio, "<b>").concat(num, ".</b> "); });
                output = output.replace(/\n{3,}/g, '\n\n');
                output = output.replace(/\n/g, '<br>');
            }
            catch (e) {
                console.error(e);
                return md;
            }
            return output;
        };
        return Helpers;
    }());
    Core.Helpers = Helpers;
    var UserTypes;
    (function (UserTypes) {
        UserTypes["Visitor"] = "V";
        UserTypes["Agent"] = "A";
    })(UserTypes = Core.UserTypes || (Core.UserTypes = {}));
})(Core || (Core = {}));

window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.note = {

        init: function () {
            //$o.note.object = $("#note-tool");
            //$o.note.events();
        },

        //createNote: function (event) {
        //    ++$o.note.noteId;
        //    var coords = $o.canva.getCoords(event);
        //    $o.note.currentNoteInfo = {
        //        MarkId: $o.note.noteId + $o.core.userType,
        //        Body: "",
        //        Coords: {
        //            PosX: coords.absleft,
        //            PosY: coords.abstop
        //        },
        //        Tokens: {
        //      Sender: $o.core.globalVariables.userType == "V"?$o.core.globalVariables.myRoom:$o.core.globalVariables.myToken,
        //            Receiver: $o.core.globalVariables.otherToken,
        //        },
        //        InternalId: $o.core.globalVariables.internalId,
        //        URLMedia: $o.core.globalVariables.urlMedia,
        //        SentBy: $o.core.userType,
        //        Type: "N"
        //    };
        //    $o.note.addNote($o.note.currentNoteInfo);
        //    $o.tools.addToUndo("note" + $o.note.noteId + $o.core.userType);
        //    $o.tools.change($o.tools.type.POINT);

        //},

        //addNote: function (parameters, recover) {
        //    var pinPosition = {
        //        left: parameters.Coords.PosX * $o.canva.target.object.width(),
        //        top: parameters.Coords.PosY * $o.canva.target.object.height()
        //    },
        //    createNote = function () {
        //        $o.note.createNoteUI(parameters, recover, pinPosition);
        //    };

        //    if (!recover)$o.note.notesHistory.push(parameters);

        //    if ((parameters.SentBy != $o.core.globalVariables.userType)&&(!recover)) {
        //        $o.note.mouseNoteUI(parameters, recover, pinPosition);
        //    } else {
        //        createNote(parameters, recover);
        //    }
        //},

        //object: null,
        //noteId: 0,
        //currentNoteInfo: "",
        //notesHistory: []
    };
})(window);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.pencil = {
        init: function () {
            $("#draw-button").click(function () {                
                if ($o.pencil.isDrawing) {
                    $("#color-picker").removeClass("show-picker");
                    $(this).removeClass("is-drawing").removeAttr("style");
                    $o.pencil.drawing.stop(); // Desactivar el lpiz
                    $o.pencil.isDrawing = false;
                    $o.pencil.drawing.setColor($o.pencil.pencilColor);
                    if (Core.Helpers.isDevice()) {                    
                        $("#localCanvas").css({ "z-index": 90 });                       
                    };
                } else {
                    $("#color-picker").addClass("show-picker");
                    setTimeout(function () { if ($("#color-picker").hasClass("show-picker")) $("#color-picker").removeClass("show-picker"); }, 5000);
                    $("#draw-button").addClass("is-drawing");
                    $("#draw-button").attr('style', 'color:' + $o.pencil.pencilColor + ' !important');
                    $("#pencil-me").css({ "color": $o.pencil.pencilColor });
                    $o.pencil.drawing.start(); // Activar el lpiz
                    $o.pencil.isDrawing = true;
                    if (Core.Helpers.isDevice()) {                    
                        $("#localCanvas").css({ "z-index": 100 });                     
                    };
                }
            });

            $("#color-picker").on("click", "li", function () {
                $o.pencil.pencilColor = $(this).css("color");
                $("#draw-button").attr('style', 'color:' + $o.pencil.pencilColor + ' !important');
                $("#pencil-me").css({ "color": $o.pencil.pencilColor });

                $o.pencil.drawing.setColor($o.pencil.pencilColor);
                $("#color-picker").removeClass("show-picker");
            });

            var userType = $o.core.globalVariables.userType == "A" ? "agent" : "visitor";

            $o.pencil.pencilColor = userType == "agent" ? "green" : "red";

            // $("#draw-button").css({ "color": $o.pencil.pencilColor });
            $o.pencil.drawing = new Oct8ne.Drawings.DrawingUi(
                document.getElementById("oct8ne-helper"),
                document.getElementById("localCanvas"),
                document.getElementById("remoteCanvas"),
                userType, 0 // Identificador nico del recurso actual (puede ser cualquier cosa: id, url, etc.)
            );
            $o.pencil.drawing.setColor($o.pencil.pencilColor);


            $o.pencil.drawing.onLocalSegmentAdded = function (userId, resourceId, points, color, isPermanent, segmentId) {
                // Callback invocado cuando el usuario local ha aadido un segmento

                if ($o.core.isSignalRConnected()) {
                    var drawing = {
                        Room: $o.core.globalVariables.room,
                        Data: JSON.stringify({
                            userId: userId,
                            resourceId: resourceId,
                            points: points,
                            color: color,
                            isPermanent: isPermanent,
                            segmentId: segmentId,
                            helperWidth: $("#oct8ne-helper").width(),
                            helperHeight: $("#oct8ne-helper").height()
                            //helperWidth: 217.5,
                            //helperHeight: 142
                        })
                    };
                    $o.hubsOut.sendDrawing(drawing);
                }
            };
        },

        receiveDrawing: function (data) {
            var obj = JSON.parse(data.Data);
            //console.log("Tamao al recibir: " + obj.helperWidth + " --- " + obj.helperHeight);
            //console.log("Tamao local: " + $("#oct8ne-helper").width() + " --- " + $("#oct8ne-helper").height());

            var widthFactor = $("#oct8ne-helper").width() / obj.helperWidth,
                heightFactor = $("#oct8ne-helper").height() / obj.helperHeight;


            $.each(obj.points, function (i) {
                if (obj.points[i] % 2) {
                    obj.points[i] = obj.points[i] * widthFactor;
                } else {
                    obj.points[i] = obj.points[i] * heightFactor;
                }
            });
            $o.pencil.drawing.addRemoteDrawingSegment(obj.userId, obj.resourceId, obj.points, obj.color, obj.isPermanent, obj.segmentId);

            $("#pencil-me").css({ "color": $o.pencil.pencilColor });

            if ($o.core.globalVariables.userType == "V") {
                $("#pencil-agent").css({ "color": obj.color });
                if ($('#pencil-agent').children().length == 0) {
                    $('#pencil-agent').append("<p class='avatar-agent'></p>");
                }
                $('#pencil-agent p').css({ "background": "url('" + $o.visitorStart.avatarAgent + "') center center / cover" });
            } else {
                $("#pencil-visitor").css({ "color": obj.color });
            };

        },

        changeCanvaImage: function (internalId) {
            $o.pencil.drawing.isDrawing = false;
            $o.pencil.drawing.updateCanvasDimensions(true);
            $o.pencil.drawing.setCurrentResourceId(internalId + "" + $o.carousel.currentImage);
            $o.pencil.drawing.clearAll();
        },

        drawing: false,
        isDrawing: false,
        pencilColor: ""
    }
})(window);
/*!
 *		Curve version 2.0
 *
 *		Smooth curves (cardinal splines) on canvas.
 *
 *		By Ken Fyrstenberg Nilsen (c) 2013
 *		Abdias Software, http://abdiassoftware.com/
 *
 *		MIT licensed.
*/
/**
 *		Uses an array of points (x,y) to draw a smooth curve (cardinal
 *		spline). There is no use of control points, and the curve is
 *		drawn through each point.
 *
 *		USAGE:
 *
 *			context.curve(points, tension, numberOfSegments, minSegs)
 *
 *			curve(array)
 *			curve(array, float)
 *			curve(array, float, integer)
 *			curve(array, float, integer, integer)
 *
 *		points
 *			Array of float or integers arranged as:
 *			[x1, y1, x2, y1, ..., xn, yn]. Minimum two points is
 *			required.
 *
 *		tension (optional)
 *			[0, 1], 0 = no smoothing, 0.5 = smooth (default), 1 = very
 *			smoothed.  Tension value may be outside the interval to
 *			create curles at the junction points.
 *
 *		numberOfSegments (optional)
 *			Defaults to -4 (adaptive 25%). If positive value 1 - n each
 *			line between two points will be split in number of segments
 *			(aka resolution). The higher value the higher resolution.
 *			If a negative value -1 to n the line will be divided
 *			dynamically based on line length and 1 / segments. Default
 *			is -4 which means the line will be split into 25% segments
 *			of line length between two points. The lower value the lower
 *			resolution.
 *			The default value should be OK for most scenarios but to get
 *			more speed you can use static values instead which gives
 *			best result if the line lengths between points are somewhat
 *			similar in length.
 *
 *		minSegs (optional, only used with adaptive mode)
 *			Minimum number of segments when using adaptive mode.
 *			Default value is 7. This is to avoid short distanced lines
 *			with a steep curve becoming low resolution as only the
 *			distance between the two actual points making the line is
 *			measured (the curved result could be much longer).
 *
 *		NOTE: point array must contain a minimum set of two points.
*/
if (typeof CanvasRenderingContext2D !== 'undefined') {
	CanvasRenderingContext2D.prototype.curve = function(ptsa, tension, numOfSegments, minSegments) {

		var pts, res = [],			/// clone array
			x, y,					/// our x,y coords
			t1x, t2x, t1y, t2y,		/// tension vectors
			c1, c2, c3, c4,			/// cardinal points
			st, t, i,				/// steps based on num. of segments
			pow3, pow2,				/// cache powers
			pow32, pow23,
			p0, p1, p2, p3,			/// cache points
			pl = ptsa.length,
			as = false, dx, dy,		/// adaptive segmentation
			aseg = 0.25,
			minSeg = 7;

		// use input value if provided, or use a default value	 
		tension = (typeof tension === 'number') ? tension : 0.5;

		if (typeof numOfSegments === 'number') {
			numOfSegments = parseInt(numOfSegments, 10);
			if (numOfSegments === 0) numOfSegments = -4;
			as = numOfSegments < 0 ? true : false;
			aseg = 1 / Math.abs(numOfSegments);

			if (as === true)
				minSeg = (typeof minSegments === 'number') ? parseInt(minSegments, 10) : 7;
				if (minSeg < 1) minSeg = 1;
		} else {
			as = true;
		}

		pts = ptsa.concat();		/// clone array so we don't change the original content

		pts.unshift(ptsa[1]);		/// copy 1. point and insert at beginning
		pts.unshift(ptsa[0]);
		pts.push(ptsa[pl - 2], ptsa[pl - 1]);	/// copy last point and append

		/// 1. loop goes through point array
		/// 2. loop goes through each segment between the two points + one point before and after
		for (i = 2; i < pl; i += 2) {

			p0 = pts[i];
			p1 = pts[i + 1];
			p2 = pts[i + 2];
			p3 = pts[i + 3];

			/// calc tension vectors
			t1x = (p2 - pts[i - 2]) * tension;
			t2x = (pts[i + 4] - p0) * tension;

			t1y = (p3 - pts[i - 1]) * tension;
			t2y = (pts[i + 5] - p1) * tension;

			if (as === true) {
				dx = p2 - p0;
				dy = p3 - p0;
				numOfSegments = (Math.max(minSeg, Math.abs(Math.sqrt(dx * dx + dy * dy)) * aseg + 0.5))|0;
			}

			for(t = 0; t <= numOfSegments; t++) {

				/// calc step
				st = t / numOfSegments;
			
				pow2 = Math.pow(st, 2);
				pow3 = pow2 * st;
				pow23 = pow2 * 3;
				pow32 = pow3 * 2;

				/// calc cardinals
				c1 = pow32 - pow23 + 1; 
				c2 = pow23 - pow32;
				c3 = pow3 - 2 * pow2 + st; 
				c4 = pow3 - pow2;

				/// calc x and y cords with common control vectors
				x = c1 * p0 + c2 * p2 + c3 * t1x + c4 * t2x;
				y = c1 * p1 + c2 * p3 + c3 * t1y + c4 * t2y;
			
			    /// store points in array
				this.lineTo(x, y);
			}
		}
		return this;
	}
}
 
var Oct8ne;
(function (Oct8ne) {
    var Drawings;
    (function (Drawings) {
        var DrawingBoard = (function () {
            function DrawingBoard(drawingContext, container, localCanvas, remoteCanvas, currentUserId, currentResourceId) {
                this.drawingContext = drawingContext;
                this.currentUserId = currentUserId;
                this.currentResourceId = currentResourceId;
                this.isDrawing = false;
                this.currentColor = "black";
                this.currentSegmentPoints = [];
                this.backgroundSegments = [];
                this.remoteActionsQueue = {};
                this.changed = false;
                this.segmentCounter = 1;
                this.drawingBoardErased = false;
                this.isCanvasVisible = true;
                this.minDistanceBetweenPoints = DrawingBoard.MEDIUM_DISTANCE_BETWEEN_POINTS;
                //#endregion
                this.processingVolatileDrawings = false;
                this.container = $(container);

                this.initialWidth = this.container.width();
                this.localCanvasElement = $(localCanvas);
                this.remoteCanvasElement = $(remoteCanvas);
                this.localCanvasContext = localCanvas.getContext("2d");
                this.remoteCanvasContext = remoteCanvas.getContext("2d");
            }
            //#region Canvas management public methods
            DrawingBoard.prototype.hideDrawings = function () {
                this.isCanvasVisible = false;
                this.localCanvasElement.hide();
                this.remoteCanvasElement.hide();
            };
            DrawingBoard.prototype.showDrawings = function () {
                this.isCanvasVisible = true;
            };
            DrawingBoard.prototype.setColor = function (color) {
                this.currentColor = color;
            };
            DrawingBoard.prototype.getColor = function (color) {
                return this.currentColor;
            };

            DrawingBoard.prototype.setCurrentResourceId = function (resourceId) {
                this.currentResourceId = resourceId;
            };
            DrawingBoard.prototype.setCanvasDimensions = function (width, height,isNewImage) {
                this.imageWidth = width;
                this.imageHeight = height;
                //actualizamos initialWidth solo si es nueva imagen
                if (isNewImage) this.initialWidth = width;
                if (!this.isCanvasVisible) {
                    return;
                }
                this.localCanvasElement.attr("lineWidth", "2px");
                this.remoteCanvasElement.attr("lineWidth", "2px");
                this.remoteCanvasElement.attr("width", width);
                this.remoteCanvasElement.attr("height", height);
                this.remoteCanvasContext.canvas.width = width;
                this.remoteCanvasContext.canvas.height = height;
                this.imageScale = width / this.initialWidth;
                this.remoteCanvasContext.scale(this.imageScale, this.imageScale);
                this.redrawBackground(true);
                this.minDistanceBetweenPoints = (DrawingBoard.MEDIUM_DISTANCE_BETWEEN_POINTS / this.imageScale);
                if (this.minDistanceBetweenPoints < DrawingBoard.MINIMUM_DISTANCE_BETWEEN_POINTS)
                    this.minDistanceBetweenPoints = DrawingBoard.MINIMUM_DISTANCE_BETWEEN_POINTS;
                this.localCanvasElement.css({ width: width, height: height
                });
                this.localCanvasElement.attr("width", width);
                this.localCanvasElement.attr("height", height);
                this.localCanvasContext.canvas.width = width;
                this.localCanvasContext.canvas.height = height;
                this.localCanvasContext.scale(this.imageScale, this.imageScale);
                this.localCanvasElement.show();
                this.remoteCanvasElement.show();
        };
            //#endregion
            //#region Resizing public methods
            DrawingBoard.prototype.onBeginResize = function () {
                if (this.isDrawing) {
                    this.currentSegmentPoints =[];
                    this.endDraw();
        }
            };
            DrawingBoard.prototype.onEndResize = function () {
                var _this = this;
                if (this.isDrawing) {
                    this.currentSegmentPoints =[];
                    this.endDraw();
                    return;
                }
                if (this.resizeTimer) {
                    clearTimeout(this.resizeTimer);
                }
                this.resizeTimer = setTimeout(function () {
                    var container = _this.getContainerDimensions();
                    _this.remoteCanvasElement.attr("width", container.width);
                    _this.remoteCanvasElement.attr("height", container.height);
                    var scale = container.width / container.height;
                    _this.remoteCanvasContext.scale(scale, scale);
                    _this.redrawBackground(true);
                    _this.localCanvasElement.attr("width", container.width);
                    _this.localCanvasElement.attr("height", container.height);
                    _this.localCanvasContext.scale(scale, scale);
            }, 500);
        };
            //#endregion
            //#region Remote events
            DrawingBoard.prototype.addRemoteSegment = function (segment) {
                if (segment.points.length === 0)
                    return;
                this.drawingBoardErased = false;
                if (this.remoteActionsQueue[segment.userId]) {
                    this.remoteActionsQueue[segment.userId].push({ action: "draw", segment: segment
                });
                }
                else {
                    this.remoteActionsQueue[segment.userId]=[{ action: "draw", segment: segment
                }];
                this.startDrawingAnimation(segment.userId);
        }
            };
            DrawingBoard.prototype.addDeleteSegment = function (segmentId, userId) {
                this.drawingBoardErased = false;
                if (this.remoteActionsQueue[userId]) {
                    this.remoteActionsQueue[userId].push({ action: "deletesegment", id: segmentId, userId: userId
                });
                }
                else {
                    this.remoteActionsQueue[userId]=[{ action: "deletesegment", id: segmentId, userId: userId
                }];
                this.startDrawingAnimation(userId);
        }
            };
            DrawingBoard.prototype.getCurrentDrawings = function () {
                var drawings =[];
                for (var i = 0; i < this.backgroundSegments.length; i++) {
                    var segment = this.backgroundSegments[i];
                    drawings.push({ id: segment.id, userId: segment.userId, color: segment.color, points: segment.points
            });
                }
                return drawings;
        };
            //#region Volatile drawings management
            DrawingBoard.prototype.startVolatileDrawingsDeletion = function () {
                var _this = this;
                if (this.processingVolatileDrawings)
                    return;
                this.processingVolatileDrawings = true;
                setTimeout(function () { return _this.deleteVolatileDrawings();
            }, 500);
            };
            DrawingBoard.prototype.deleteVolatileDrawings = function () {
                var pending = false;
                var currentMs = new Date().getTime();
                var backgroundSegments = this.backgroundSegments.slice(0) ;
                for (var i = 0; i < backgroundSegments.length; i++) {
                    var seg = backgroundSegments[i];
                    if (seg.deletion && currentMs > seg.deletion) {
                        this.addDeleteSegment(seg.id, seg.userId);
                    }
                    else if (seg.deletion) {
                        pending = true;
            }
                }
                this.processingVolatileDrawings = false;
                if (pending) {
                    this.startVolatileDrawingsDeletion();
        }
        };
            //#endregion
            //#region Drawing animation queue
            DrawingBoard.prototype.startDrawingAnimation = function (userId) {
                var delay = 80;
                var that = this;
                var currentAction = this.remoteActionsQueue[userId].shift();
                var currentPoint = 2;
                processAction();
                function processAction() {
                    if (!currentAction || (currentAction.segment && currentAction.segment.resourceId !== that.currentResourceId)) {
                        return;
                }
                if (that.drawingBoardErased) {
                        that.drawingBoardErased = false;
                        that.drawingContext.getPencil(userId).clearQueue().delay(1000).hide("slow");
                        delete that.remoteActionsQueue[userId];
                    return;
                }
                if (currentAction.action === "draw") {
                        var currentSegment = currentAction.segment;
                    that.changed = true;
                        var ptsToDraw = currentSegment.points.slice(0, currentPoint);
                        movePencilToImageCoord(currentSegment.points[currentPoint], currentSegment.points[currentPoint +1]);
                        that.drawPoints(that.remoteCanvasContext, currentSegment.color, ptsToDraw);
                    currentPoint += 2;
                        if (currentPoint > currentSegment.points.length) {
                            currentPoint = 0;
                            that.backgroundSegments.push(currentSegment);
                            that.drawSegment(that.remoteCanvasContext, currentSegment);
                            currentSegment.deletion = currentSegment.isPermanent ? null: ((new Date().getTime()) +DrawingBoard.MILLISECONDS_FOR_VOLATILE_DRAWINGS);
                            changeToNextAction();
                            if (currentSegment.deletion) {
                                that.startVolatileDrawingsDeletion();
                        }
                }
                }
                    else if (currentAction.action === "deletesegment") {
                        that.deleteBackgroundSegment(currentAction.id, currentAction.userId);
                        changeToNextAction();
                    }
                    else {
                        changeToNextAction();
                }
                if (currentAction) {
                        setTimeout(processAction, delay);
                }
                else {
                        that.drawingContext.getPencil(userId).clearQueue().delay(1000).fadeOut("slow");
                        delete that.remoteActionsQueue[userId];
                }
                    function changeToNextAction() {
                        if (that.remoteActionsQueue[userId]&& that.remoteActionsQueue[userId].length > 0) {
                            currentAction = that.remoteActionsQueue[userId].shift();
                        }
                        else {
                            currentAction = null;
                    }
                }
                    function movePencilToImageCoord(left, top) {
                        var containerPosition = that.container.position();
                        var pencil = that.drawingContext.getPencil(userId);
                        var pl = left * that.imageScale;
                        var pt = top * that.imageScale;
                        pencil.clearQueue().css({ left: pl +containerPosition.left + "px", top: pt +containerPosition.top + "px"
                    }).show();
            }
        }
            };
            DrawingBoard.prototype.deleteBackgroundSegment = function (segmentId, userId) {
                for (var i = 0; i < this.backgroundSegments.length; i++) {
                    var seg = this.backgroundSegments[i];
                    if (seg.id == segmentId && seg.userId == userId) {
                        this.backgroundSegments.splice(i, 1);
                        this.clearCanvas(this.remoteCanvasContext);
                        this.clearCanvas(this.localCanvasContext);
                        this.redrawBackground(true);
                        break;
            }
        }
        };
            // #endregion
            //#region Drawing
            DrawingBoard.prototype.beginDraw = function (left, top, isPermanent) {
                this.isDrawing = true;
                this.isCurrentDrawingPermanent = isPermanent;
                this.onPencilMoved(left, top);
            };
            DrawingBoard.prototype.onPencilMoved = function (left, top) {
                var currentTimer = new Date().getTime();
                var deltaX = Math.abs(left -this.prevLeft);
                var deltaY = Math.abs(top -this.prevTop);
                var tooNear = Math.sqrt(deltaX * deltaX +deltaY * deltaY) < this.minDistanceBetweenPoints;
                var oneMomentAgo = (currentTimer - this.lastPointTime < DrawingBoard.MAX_DELAY_BETWEEN_POINTS);
                if (!tooNear && !oneMomentAgo) {
                    this.addAndDrawPoint(left, top);
                    this.lastPointTime = currentTimer;
                    this.prevLeft = left;
                    this.prevTop = top;
        }
            };
            DrawingBoard.prototype.endDraw = function () {
                if (this.isDrawing) {
                    this.isDrawing = false;
                    this.changed = true;
                    this.submitCurrentSegment();
        }
            };
            DrawingBoard.prototype.clearAll = function () {
                this.clearCanvas(this.localCanvasContext);
                this.clearCanvas(this.remoteCanvasContext);
                this.currentSegmentPoints =[];
                this.backgroundSegments =[];
                this.remoteActionsQueue =[];
                this.drawingBoardErased = true;
            };
            DrawingBoard.prototype.submitCurrentSegment = function (isPartial) { 
                if (isPartial === void 0) {
isPartial = false;
            }
                            if (this.currentSegmentPoints.length == 0)
                    return;
                var newSegment = new Drawings.Segment();
                newSegment.resourceId = this.currentResourceId;
                newSegment.color = this.currentColor;
                newSegment.points = this.currentSegmentPoints;
                newSegment.deletion = this.isCurrentDrawingPermanent ? null: ((new Date()).getTime()) +DrawingBoard.MILLISECONDS_FOR_VOLATILE_DRAWINGS;
                newSegment.id = this.segmentCounter++;
                newSegment.userId = this.currentUserId;
                this.backgroundSegments.push(newSegment);
                this.changed = true;
                var lastPointX = this.currentSegmentPoints[this.currentSegmentPoints.length -2];
                var lastPointY = this.currentSegmentPoints[this.currentSegmentPoints.length -1];
                // Broadcast!
                this.drawingContext.sendDrawingSegment(newSegment.points, newSegment.color, this.isCurrentDrawingPermanent, newSegment.id);
                if (isPartial) {
                    this.currentSegmentPoints =[lastPointX, lastPointY];
                }
                else {
                    this.currentSegmentPoints =[];
                }
                this.drawSegment(this.remoteCanvasContext, newSegment);
                this.clearCanvas(this.localCanvasContext);
                if (!this.isCurrentDrawingPermanent) {
                    this.startVolatileDrawingsDeletion();
        }
            };
            DrawingBoard.prototype.addAndDrawPoint = function (left, top) {
                this.currentSegmentPoints.push(+left.toFixed(2));
                this.currentSegmentPoints.push(+top.toFixed(2));
                if (this.currentSegmentPoints.length > 2 * DrawingBoard.UPDATE_PEERS_EVERY_POINTS) {
                    this.submitCurrentSegment(true);
                }
                this.clearCanvas(this.localCanvasContext);
                this.drawPoints(this.localCanvasContext, this.currentColor, this.currentSegmentPoints);
            };
            DrawingBoard.prototype.drawSegment = function (drawingCtx, segment) {
                this.drawPoints(drawingCtx, segment.color, segment.points);
            };
            DrawingBoard.prototype.drawPoints = function (drawingCtx, color, points, lineWidth) { 
                if (lineWidth === void 0) { lineWidth = DrawingBoard.DEFAULT_PEN_SIZE; }
                drawingCtx.beginPath();
                drawingCtx.lineWidth = lineWidth;
                if (DrawingBoard.SHOW_KEY_POINTS) {
                    drawingCtx.fillStyle = "red";
                    var kpSize = DrawingBoard.DEFAULT_PEN_SIZE +1;
                    for (var i = 0; i < points.length; i += 2) {
                        drawingCtx.fillRect(points[i]- kpSize, points[i + 1]- kpSize, kpSize * 2, kpSize * 2);
            }
                }
                drawingCtx.strokeStyle = color;
                drawingCtx.curve(points);
                drawingCtx.stroke();
        };
            //#endregion
            //#region Private functions
            DrawingBoard.prototype.getContainerDimensions = function () {
                return { width: this.container.width(), height: this.container.height()
        };
            };
            DrawingBoard.prototype.redrawBackground = function (force) { 
                if (force === void 0) {
force = false;
            }
                            if (!this.changed && !force)
                    return;
                for (var i = 0; i < this.backgroundSegments.length; i++) {
                    var segment = this.backgroundSegments[i];
                    this.remoteCanvasContext.beginPath();
                    this.remoteCanvasContext.lineWidth = DrawingBoard.DEFAULT_PEN_SIZE;
                    this.remoteCanvasContext.strokeStyle = segment.color;
                    this.remoteCanvasContext.moveTo(segment.points[0], segment.points[1]);
                    this.remoteCanvasContext.curve(segment.points);
                    this.remoteCanvasContext.stroke();
                }
                this.changed = false;
            };
            DrawingBoard.prototype.highlightSegment = function (segment) {
                this.clearCanvas(this.localCanvasContext);
                this.drawPoints(this.localCanvasContext, "red", segment.points, 8);
            };
            DrawingBoard.prototype.dehighlightSegment = function (segment) {
                this.clearCanvas(this.localCanvasContext);
            };
            DrawingBoard.prototype.clearCanvas = function (ctx) {
                ctx.save();
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.clearRect(0, 0, this.imageWidth, this.imageHeight);
                ctx.restore();
            };
            DrawingBoard.prototype.log = function (message) {
                console.log("[DrawingBoard] " +message);
            };
            DrawingBoard.MILLISECONDS_FOR_VOLATILE_DRAWINGS = 10000;
            DrawingBoard.DEFAULT_PEN_SIZE = 3;
            DrawingBoard.MAX_DELAY_BETWEEN_POINTS = 50;
            DrawingBoard.MEDIUM_DISTANCE_BETWEEN_POINTS = 5;
            DrawingBoard.MINIMUM_DISTANCE_BETWEEN_POINTS = 3;
            DrawingBoard.UPDATE_PEERS_EVERY_POINTS = 25;
            DrawingBoard.SHOW_KEY_POINTS = false;
            return DrawingBoard;
        }());
        Drawings.DrawingBoard = DrawingBoard;
    }) (Drawings = Oct8ne.Drawings ||(Oct8ne.Drawings = { }));
}) (Oct8ne || (Oct8ne = { }));

var Oct8ne;
(function (Oct8ne) {
    var Drawings;
    (function (Drawings) {
        var DrawingUi = (function () {
            function DrawingUi(container, localCanvas, remoteCanvas, currentUserId, currentResourceId) {
                this.currentUserId = currentUserId;
                this.currentResourceId = currentResourceId;
                this.isDrawing = false;
                this.isStarted = false;
                this.pencils = [];
                this.color = "black";
                this.container = $(container);
                this.initialWidth = this.container.width();
                this.drawingBoard = new Drawings.DrawingBoard(this, container, localCanvas, remoteCanvas, currentUserId, currentResourceId);
                this.localCanvas = $(localCanvas);
                this.remoteCanvas = $(remoteCanvas);
                this.localCanvas.css("touch-action", "none");
                this.resource = this.container.find("img");
                this.stop();
            }
            DrawingUi.prototype.start = function () {
                var _this = this;
                this.localCanvas.css("cursor", "none");
                this.localCanvas.on("mousedown touchstart", function (e) { return _this.onMouseDown(e); });
                this.localCanvas.on("mousemove touchmove", function (e) { return _this.onMouseMove(e); });
                this.localCanvas.on("mouseleave mouseup touchend", function (e) { return _this.onMouseUp(e); });
                this.localCanvas.on("mouseleave", function (e) { return _this.onMouseLeave(e); });
                this.updateCanvasDimensions();
                this.isStarted = true;
            };
            DrawingUi.prototype.stop = function () {
                this.localCanvas.css("cursor", "move");
                this.localCanvas.off("mousedown mousemove mouseleave mouseup");
                this.updateCanvasDimensions();
                this.isStarted = false;
                this.getPencil("me").hide();
            };
            DrawingUi.prototype.onMouseDown = function (e) {
                $("#color-picker").removeClass();
                if (!this.isStarted)
                    return false;
                this.unifyTouchEvents(e);
                var coords = this.getRealCoords(e);
                var left = coords.left;
                var top = coords.top;
                var imageCoords = this.zoomedImageCoordsToActualImageCoords(left, top);
                left = imageCoords.left;
                top = imageCoords.top;
                this.drawingBoard.beginDraw(left, top, false /* true=persistent drawings*/);
                this.isDrawing = true;
                e.preventDefault();
                return false;
            };
            DrawingUi.prototype.onMouseMove = function (e) {
                if (!this.isStarted)
                    return false;
                this.unifyTouchEvents(e);
                var coords = this.getRealCoords(e);
                var left = coords.left;
                var top = coords.top;

                var pencil = this.getPencil("me");
                var containerPosition = this.container.position();
                pencil.css({ left: e.offsetX + containerPosition.left + "px", top: e.offsetY + containerPosition.top + "px" }).show();
                if (!this.isDrawing)
                    return false;
                var imageCoords = this.zoomedImageCoordsToActualImageCoords(left, top);
                left = imageCoords.left;
                top = imageCoords.top;
                this.drawingBoard.onPencilMoved(left, top);
                e.preventDefault();
                return false;
            };
            DrawingUi.prototype.onMouseLeave = function (e) {
                this.getPencil("me").hide();
            };
            DrawingUi.prototype.onMouseUp = function (e) {
                if (!this.isStarted || !this.isDrawing)
                    return false;
                this.unifyTouchEvents(e);
                var coords = this.getRealCoords(e);
                var left = coords.left;
                var top = coords.top;
                var imageCoords = this.zoomedImageCoordsToActualImageCoords(left, top);
                left = imageCoords.left;
                top = imageCoords.top;
                this.drawingBoard.onPencilMoved(left, top);
                this.drawingBoard.endDraw();
                this.getPencil("me").hide();
                this.isDrawing = false;
                e.preventDefault();
                return false;
            };
            DrawingUi.prototype.zoomedImageCoordsToActualImageCoords = function (left, top) {

                var newLeft = left;
                var newTop = top;
                var factor = this.initialWidth / this.container.width();
                newLeft = newLeft * factor;
                newTop = newTop * factor;
                return { left: newLeft, top: newTop };
            };
            DrawingUi.prototype.unifyTouchEvents = function (e) {
                if (e.type === "touchmove" || e.type === "touchstart" || e.type === "touchend") {
                    if (e.originalEvent && e.originalEvent.changedTouches) {
                        var touch = e.originalEvent.changedTouches[0];
                        var offset = $(touch.target).offset();
                        e.pageX = touch.pageX;
                        e.pageY = touch.pageY;
                        e.offsetX = touch.pageX - offset.left;
                        e.offsetY = touch.pageY - offset.top;
                    }
                }
            };
            DrawingUi.prototype.getRealCoords = function (e) {
                var htmlElement = e.target;
                var offsetX, offsetY;
                if (e.offsetX == undefined) {
                    var off = $(htmlElement).offset();
                    offsetX = e.pageX - off.left;
                    offsetY = e.pageY - off.top;
                }
                else {
                    offsetX = e.offsetX;
                    offsetY = e.offsetY;
                }
                var left = this.roundToInteger(offsetX);
                var top = this.roundToInteger(offsetY);
                if (htmlElement.tagName === "IMG") {
                    var position = $(e.target).position();
                    left += position.left;
                    top += position.top;
                }
                return { left: left, top: top };
            };
            DrawingUi.prototype.updateCanvasDimensions = function (newImage) {
                var image = this.container.find("img");
                var width = image.width();
                var height = image.height();
                //cambio javi: modifico this.initialWidth al cambiar de imagen ( se llam aqui al hacer zoom tb) para solucionar 
                // error cuando agente y visitor empiezan con tamao de helper diferente
                if(newImage)this.initialWidth = width;
                //al llamar a esta funcion modifico this.drawingBoard.initialWidth con el mismo width (solo si es nueva imagen)
                this.drawingBoard.setCanvasDimensions(width, height,newImage);
            };

            DrawingUi.prototype.sendDrawingSegment = function (points, color, isCurrentDrawingPermanent, segmentId) {
                if (!this.onLocalSegmentAdded) {
                    throw "onLocalSegmentAdded callback must be defined";
                }
                this.onLocalSegmentAdded(this.currentUserId, this.currentResourceId, points, color, isCurrentDrawingPermanent, segmentId);
            };
            DrawingUi.prototype.clearAll = function () {
                for (var p in this.pencils) {
                    if (this.pencils.hasOwnProperty(p)) {
                        this.pencils[p].hide().clearQueue();
                    }
                }
                this.drawingBoard.clearAll();
            };
            DrawingUi.prototype.getPencil = function (userId) {
                
                var result = this.pencils[userId];
                if (!result) {
                    var pencil = $("#pencil-" + userId);
                    if (pencil.length === 0)
                    //pencil = $("<img class='oct8ne-pencil' id='pencil-" + userId + "' src='/api/img/core/" + (userId === "me" ? "mypencil" : "otherpencil") + ".png' draggable='false' alt='' style='pointer-events:none; display: block; position: absolute; z-index: " + (userId === "me" ? "120" : "110") + ";'>");
                    
                    pencil = $("<span class='oct8ne-pencil icon-common-pen' id='pencil-" + userId + "' draggable='false' alt='' style='position: absolute;font-weight: bold;pointer-events: none;display: none;font-size: 30px;margin-left: -5px;margin-top: -26px; text-shadow: rgb(255, 255, 255) 1px 1px 2px;z-index: 120;  z-index: " + (userId === "me" ? "120" : "110") + ";'></span>");
                    pencil.hide();
                    this.container.parent().append(pencil);
                    result = this.pencils[userId] = pencil;
                }
                return result;
            };
            DrawingUi.prototype.setColor = function (color) {
                this.drawingBoard.setColor(color);
            };
            DrawingUi.prototype.setCurrentResourceId = function (resourceId) {
                this.currentResourceId = resourceId;
                this.drawingBoard.setCurrentResourceId(resourceId);
                //console.log("CurrentResourceId=" + this.currentResourceId);
            };
            DrawingUi.prototype.roundToInteger = function (n) {
                return Math.round(n);
            };
            DrawingUi.prototype.addRemoteDrawingSegment = function (userId, resourceId, points, color, isPermanent, segmentId) {
                if (resourceId !== this.currentResourceId) {
                    //console.log("Ignoring remote segment for resourceId=" + resourceId + " and current=" + this.currentResourceId);
                    return;
                }
                //console.log("Adding remote segment for resourceId=" + resourceId + " and current=" + this.currentResourceId);
                var segment = new Drawings.Segment();
                segment.color = color;
                segment.id = segmentId;
                segment.points = points;
                segment.userId = userId;
                segment.isPermanent = isPermanent;
                segment.resourceId = resourceId;
                this.drawingBoard.addRemoteSegment(segment);
            };
            return DrawingUi;
        }());
        Drawings.DrawingUi = DrawingUi;
    })(Drawings = Oct8ne.Drawings || (Oct8ne.Drawings = {}));
})(Oct8ne || (Oct8ne = {}));

var Oct8ne;
(function (Oct8ne) {
    var Drawings;
    (function (Drawings) {
        var Segment = (function () {
            function Segment() {
            }
            return Segment;
        }());
        Drawings.Segment = Segment;
    })(Drawings = Oct8ne.Drawings || (Oct8ne.Drawings = {}));
})(Oct8ne || (Oct8ne = {}));

window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.pin = {

        init: function () {
            $o.pin.object = $("#pin-tool");
            $o.pin.events();
        },

        sendPin: function (event) {
            ++$o.tools.undoActions;
            var coords = $o.canva.getCoords(event),
                pin = {
                    Coords: {
                        PosX: coords.absleft,
                        PosY: coords.abstop
                    },
                    Room: $o.core.globalVariables.room,
                    InternalId: $o.core.globalVariables.internalId,
                    Scope: $o.carousel.currentImage,
                    SentBy: $o.core.userType,
                    Type: "P",
                    Id: $o.tools.generateRandomId()
                };

            $o.pin.addPin(pin);
            if ($o.core.isSignalRConnected()) { $o.hubsOut.sendPin(pin); }

            $o.saveRecord.pin(pin.Id, $o.carousel.currentImage, pin.Coords.PosX, pin.Coords.PosY);  //id, scope,  coordX, coordY //GRABA INTERACCION
        },

        addPin: function (parameters, recover) {
            if (!recover) $o.pin.pinsHistory.push(parameters);
            var pinPosition = {
                left: parameters.Coords.PosX * $o.canva.target.object.width(),
                top: parameters.Coords.PosY * $o.canva.target.object.height()
            };
            if ((parameters.SentBy != $o.core.globalVariables.userType) && (!recover)) {
                $o.pin.mousePinUI(parameters, pinPosition);
            } else {
                $o.pin.addPinUI(parameters, pinPosition);
            }
            $o.tools.change($o.tools.type.POINT);
        },

        recoverPins: function (tokenVisitor, internalId, scope) {
            var userInteractions = $o.pin.pinsHistory;
            //userInteractions = userInteractions.concat($o.note.notesHistory);
            if (userInteractions) {
                for (key in userInteractions) {
                    var visitorInteraction = userInteractions[key];
                    if ((visitorInteraction.InternalId == internalId) && (visitorInteraction.Scope == scope)) {
                        var recoverInteractionData = {
                            SentBy: visitorInteraction.SentBy,
                            Coords: visitorInteraction.Coords,
                            Type: visitorInteraction.Type,
                            Id: visitorInteraction.Id
                        };
                        if ($o.core) {
                            $o.pin.addPin(recoverInteractionData, "RECOVER");

                        } else {
                            sendInteractionToIframe(recoverInteractionData, tokenVisitor);
                        }
                    }
                }
            }
        },
        object: null,
        pinsHistory: []
    };
})(window);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.saveRecord = {
        goToSave: function (record, pastRoom, pastSessionSummaryId) {
            return new Promise(function (resolve, reject) {
                if ($o.core.globalVariables.userType == "V") {
                    $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [
                        { cookie: $o.cookies.status, value: $o.variablesVisitor.status }
                    ]);

                    $o.variablesVisitor.nowInteractionAFK = new Date(); //seteas nueva interaccion

                    if (!$o.variablesVisitor.lastInteractionAFK) { //NO EVALUES AUN (es la primera!)
                        $o.variablesVisitor.lastInteractionAFK = $o.variablesVisitor.nowInteractionAFK;
                        $o.variablesVisitor.nowInteractionAFK = false;
                        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [
                            { cookie: $o.cookies.lastInteractionAFK, value: $o.variablesVisitor.lastInteractionAFK }
                        ]);
                    } else { //EVAULA TIEMPOS
                        if (($o.variablesVisitor.nowInteractionAFK - $o.variablesVisitor.lastInteractionAFK) > $o.variablesVisitor.referenceTimeAFK) {
                            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: $o.cookies.tokenSession, value: "" }, { cookie: $o.cookies.lastInteractionAFK, value: "" },]); //Para asegurar que es un visitor nuevo. By Gerard!
                            $("#lay-AFK .afk-content-advice").text(culture.coviewer.AdviceAFK1).show();
                            $o.visitorStart.showLayAFK();
                            $("#chat-input").blur();
                            if ($.connection.hub.state != $.signalR.connectionState.disconnected) $.connection.hub.stop();
                        } else {
                            $o.variablesVisitor.lastInteractionAFK = $o.variablesVisitor.nowInteractionAFK;
                            $o.variablesVisitor.nowInteractionAFK = false;
                            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [
                                { cookie: $o.cookies.lastInteractionAFK, value: $o.variablesVisitor.lastInteractionAFK }
                            ]);

                        }
                    }
                }

                if ($o.core.globalVariables.userType == "V") {
                    var roomControl = pastRoom ? pastRoom : ($o.core.globalVariables.room ? $o.core.globalVariables.room : $o.core.globalVariables.roomForLastOperations);
                    if (roomControl && !roomControl.startsWith("TEMP")) {
                        $o.saveRecord.save(record, pastRoom, pastSessionSummaryId).then(function (result) {
                            resolve(result);
                        });
                    } else {
                        var interactionsString = oct8ne.storage.local.get($o.core.localStorageTypes.Oct8neProvisionalInteractions);
                        if (interactionsString) {
                            var interactions = JSON.parse(interactionsString);
                            interactions = interactions.concat(record);
                            oct8ne.storage.local.set($o.core.localStorageTypes.Oct8neProvisionalInteractions, JSON.stringify(interactions));
                        } else {
                            oct8ne.storage.local.set($o.core.localStorageTypes.Oct8neProvisionalInteractions, JSON.stringify(record));
                        }
                        resolve();
                    }
                } else {
                    $o.saveRecord.save(record, pastRoom, pastSessionSummaryId).then(function (result) {
                        resolve(result);
                    });
                }


            });
        },

        saveListInteractions: function () {
            return new Promise(function (resolve, reject) {
                var interactionsString = oct8ne.storage.local.get($o.core.localStorageTypes.Oct8neProvisionalInteractions);
                if (interactionsString) {
                    var interactions = JSON.parse(interactionsString);
                    $o.saveRecord.save(interactions, null, null).then(function (result) {
                        //oct8ne.storage.local.set($o.core.localStorageTypes.Oct8neProvisionalInteractions, $o.core.localStorageActions.REMOVE);
                        resolve(result);
                    });
                } else {
                    resolve();
                }
            });
        },

        save: function (record, pastRoom, pastSessionSummaryId) {
            return new Promise(function (resolve, reject) {
                $.each(record, function (i) {
                    record[i].Fields = JSON.stringify(record[i].Fields);
                    if (!record[i].ProductId && $o.core.globalVariables.internalId && $o.core.globalVariables.internalId.length) record[i].ProductId = $o.core.globalVariables.internalId;
                });

                var tokenVisitor = $o.core.globalVariables.userType == "V" ? $o.core.globalVariables.myToken : $o.core.globalVariables.visitorToken;
                var tokenSession = $o.core.globalVariables.userType == "V" ? ($o.core.globalVariables.room ? $o.core.globalVariables.room : $o.core.globalVariables.roomForLastOperations) : $o.core.globalVariables.tokenSession;
                var sessionSummaryId = $o.core.globalVariables.userType == "V" ? $o.variablesVisitor.sessionSummaryId : $o.core.globalVariables.sessionSummaryId;

                if (pastRoom) { tokenSession = pastRoom; }
                if (pastSessionSummaryId) { sessionSummaryId = pastSessionSummaryId; }

                $.ajax({
                    type: "POST",
                    url: "/Data/SaveInteractions",
                    data: { sessionSummaryId: sessionSummaryId, tokenSession: tokenSession, tokenVisitor: tokenVisitor, jsonListData: JSON.stringify(record) },
                    async: true
                }).done(function (result) {

                    //el result sera el id de la interaccion guardada
                    resolve(result[0]);
                }).fail(function () {
                    resolve(false);
                });

                setTimeout(function () {
                    resolve(false);
                }, 15000);
            });

        },

        launchedTrigger: function (fields) {
            var trigger = [{
                SentBy: "V",
                Type: 'LaunchedTrigger',
                RecoverType: 4,
                Fields: fields
            }];
            $o.saveRecord.goToSave(trigger);
        },

        pageInfo: function (fields) {
            var pageInfo = [{
                SentBy: "V",
                Type: 'PageInfo',
                RecoverType: 4,
                Fields: fields
            }];
            $o.saveRecord.goToSave(pageInfo);
        },

        choice: function (fields) {
            var choice = [{
                SentBy: "A",
                Type: 'Choice',
                RecoverType: 1,
                Fields: fields
            }];
            $o.saveRecord.goToSave(choice);
        },

        customForm: function (fields) {
            var customForm = [{
                SentBy: "A",
                Type: 'CustomForm',
                RecoverType: 1,
                Fields: fields
            }];
            $o.saveRecord.goToSave(customForm);
        },

        sideBubble: function (fields) {
            var sideBubble = [{
                SentBy: "A",
                Type: 'SideBubble',
                RecoverType: 1,
                Fields: fields
            }];
            $o.saveRecord.goToSave(sideBubble);
        },

        //COMMON -- RECOVERTYPE : 1
        query: function (term, type) {
            var query = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'Query',
                RecoverType: $o.core.globalVariables.userType == "V" ? 1 : 2,
                Fields: {
                    Type: type,
                    Term: term
                }
            }];
            $o.saveRecord.goToSave(query);
        },

        linkSession: function (tokenSession) {
            var link = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'LinkSession',
                RecoverType: 1,
                Fields: tokenSession
            }];
            $o.saveRecord.goToSave(link);
        },

        translation: function (parameters) {
            var translation = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'Translation',
                RecoverType: 1,
                Fields: {
                    License: parameters.License,
                    Status: parameters.Status,
                    AgentLanguage: parameters.AgentLanguage,
                    VisitorLanguage: parameters.VisitorLanguage
                }
            }];
            $o.saveRecord.goToSave(translation);
        },

        checkTranslation: function (status) {
            var translation = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'CheckTranslation',
                RecoverType: 2,
                Fields: {
                    Status: status,
                }
            }];
            $o.saveRecord.goToSave(translation);
        },

        trackItem: function (items) {
            var itemsArray = [];
            $.each(items, function (i) {
                var trackItem = {
                    SentBy: $o.core.globalVariables.userType,
                    Type: 'TrackItem',
                    ProductId: items[i].InternalId,
                    RecoverType: 1,
                    Fields: {
                        InternalId: items[i].InternalId,
                        Thumbnail: items[i].Thumbnail
                    }
                };
                itemsArray.push(trackItem);
            });
            $o.saveRecord.goToSave(itemsArray);
        },

        viewedItem: function (internalId, title, thumbnail, fromAgentSearch, id, forcedSentBy) {
            var viewedItem = [{
                SentBy: forcedSentBy ? forcedSentBy : $o.core.globalVariables.userType,
                Type: 'ViewedItem',
                RecoverType: 1,
                ProductId: internalId,
                Fields: {
                    Title: title,
                    Thumbnail: thumbnail,
                    FromAgentSearch: fromAgentSearch,
                    Id: id
                }
            }];
            $o.saveRecord.goToSave(viewedItem);
        },

        myListItem: function (internalId, title, thumbnail, addedFrom, id) {
            var myListItem = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'MyListItem',
                RecoverType: 1,
                ProductId: internalId,
                Fields: {
                    Title: title,
                    Thumbnail: thumbnail,
                    AddedFrom: addedFrom,
                    Id: id
                }
            }];
            $o.saveRecord.goToSave(myListItem);
        },

        myCartItem: function (internalId, title, thumbnail, addedFrom, id) {
            var myCartItem = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'MyCartItem',
                ProductId: internalId,
                RecoverType: 1,
                Fields: {
                    Title: title,
                    Thumbnail: thumbnail,
                    AddedFrom: addedFrom,
                    Id: id
                }
            }];
            $o.saveRecord.goToSave(myCartItem);
        },

        deleteCartItem: function (internalId) {
            var deleteCartItem = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'DeleteCartItem',
                ProductId: internalId,
                RecoverType: 1
            }];
            $o.saveRecord.goToSave(deleteCartItem);
        },

        uploadItem: function (internalId, title, thumbnail, id) {
            var uploadItem = [{
                ProductId: internalId,
                SentBy: $o.core.globalVariables.userType,
                RecoverType: 1,
                Type: 'UploadItem',
                Fields: {
                    Title: title,
                    Thumbnail: thumbnail,
                    Id: id
                }
            }];
            $o.saveRecord.goToSave(uploadItem);
        },

        catalogItem: function (internalId, title, thumbnail, fromAgentSearch, id, forcedSentBy) {
            var catalogItem = [{
                SentBy: forcedSentBy ? forcedSentBy : $o.core.globalVariables.userType,
                Type: 'CatalogItem',
                ProductId: internalId,
                RecoverType: 1,
                Fields: {
                    Title: title,
                    Thumbnail: thumbnail,
                    FromAgentSearch: fromAgentSearch,
                    Id: id
                }
            }];
            $o.saveRecord.goToSave(catalogItem);
        },

        image: function (scope, url) {
            var image = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'Image',
                RecoverType: 1,
                Fields: {
                    Scope: scope,
                    Url: url,
                }
            }];
            $o.saveRecord.goToSave(image);
        },

        zoom: function (scope, url, level, coordX, coordY) {
            var zoom = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'Zoom',
                RecoverType: 1,
                Fields: {
                    Scope: scope,
                    Url: url,
                    Level: level,
                    CoordX: coordX,
                    CoordY: coordY
                }
            }];
            $o.saveRecord.goToSave(zoom);
        },

        pin: function (id, scope, coordX, coordY) {
            var pin = [{
                SentBy: $o.core.globalVariables.userType,
                RecoverType: 1,
                Type: 'Pin',
                Fields: {
                    Id: id,
                    Scope: scope,
                    CoordX: coordX,
                    CoordY: coordY
                }
            }];
            $o.saveRecord.goToSave(pin);
        },

        undo: function (id) {
            var undo = [{
                SentBy: "A",
                RecoverType: 1,
                Type: 'Undo',
                Fields: {
                    Id: id
                }
            }];
            $o.saveRecord.goToSave(undo);
        },


        chat: function (content, name, id, sentBy, denyVisitorTyping) {
            var chat = [{
                SentBy: sentBy,
                Type: 'Chat',
                RecoverType: 1,
                Fields: {
                    Content: content,
                    Name: name,
                    Id: $o.tools.generateRandomId().toString(),
                    DenyVisitorTyping: denyVisitorTyping
                }
            }];

            return new Promise(function (resolve, reject) {
                $o.saveRecord.goToSave(chat).then(function (chatsId) {
                    resolve(chatsId);
                });
            });
        },

        canned: function (content, type, id) {

            var canned = [{
                SentBy: 'A',
                Type: 'Canned',
                RecoverType: 1,
                Fields: {
                    Content: content,
                    Id: id,
                    SubType: type,
                    Name: $o.core.globalVariables.otherName
                }
            }];
            $o.saveRecord.goToSave(canned);
        },

        gdpr: function (content, type, id) {

            var canned = [{
                SentBy: 'A',
                Type: 'Gdpr',
                RecoverType: 1,
                Fields: {
                    Content: content,
                    Id: id,
                    SubType: type,
                    Name: $o.core.globalVariables.otherName
                }
            }];
            $o.saveRecord.goToSave(canned);
        },

        supervisorMessage: function (content, name, id, sentBy) {
            var msg = [{
                SentBy: 'A',
                Type: 'SupervisorMessage',
                RecoverType: 2,
                Fields: {
                    Content: content,
                    Id: id,
                    Role: $o.supervisorMode.role,
                    Name: $o.core.globalVariables.myName
                }
            }];
            $o.saveRecord.goToSave(msg);
        },

        cannedResponse: function (id, response) {

            var cannedResponse = [
                {
                    SentBy: $o.core.globalVariables.userType,
                    Type: 'CannedResponse',
                    RecoverType: 1,
                    Fields: {
                        Id: id,
                        Response: response
                    }
                }
            ];
            $o.saveRecord.goToSave(cannedResponse);
        },

        inactivity: function (message) {
            var inactivity = [{
                SentBy: $o.core.globalVariables.userType,
                RecoverType: 1,
                Type: 'Inactivity',
                Fields: {
                    Message: message,
                }
            }];
            $o.saveRecord.goToSave(inactivity);
        },

        inactivityServer: function () {
            var inactivityServer = [{
                SentBy: $o.core.globalVariables.userType,
                RecoverType: 4,
                Type: 'InactivityServer'
            }];
            if ($o.core.globalVariables.userType == "V" && $o.variablesVisitor.status != "Searching") {
                $o.saveRecord.goToSave(inactivityServer);
            }
        },


        statusVisitor: function (status) {
            var statusVisitor = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'StatusVisitor',
                RecoverType: status == "Attending" ? 3 : 4,
                Fields: {
                    Status: status
                }
            }];
            $o.saveRecord.goToSave(statusVisitor);
        },

        statusViewer: function (status) {
            var statusViewer = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'StatusViewer',
                RecoverType: 4,
                Fields: {
                    Status: status
                }
            }];
            if ($o.core.globalVariables.userType == "V" && $o.variablesVisitor.status != "Searching") {
                $o.saveRecord.goToSave(statusViewer);
            }
        },

        justLookingB: function () {
            var justLookingB = [{
                RecoverType: 4,
                SentBy: $o.core.globalVariables.userType,
                Type: 'JustLookingB'
            }];
            if ($o.core.globalVariables.userType == "V" && $o.variablesVisitor.status != "Searching") {
                $o.saveRecord.goToSave(justLookingB);
            }
        },

        loginB: function () {
            var loginB = [{
                RecoverType: 4,
                SentBy: $o.core.globalVariables.userType,
                Type: 'LoginB'
            }];
            if ($o.core.globalVariables.userType == "V" && $o.variablesVisitor.status != "Searching") {
                $o.saveRecord.goToSave(loginB);
            }
        },

        checkoutB: function () {
            var checkoutB = [{
                RecoverType: 4,
                SentBy: $o.core.globalVariables.userType,
                Type: 'CheckoutB'
            }];
            if ($o.core.globalVariables.userType == "V" && $o.variablesVisitor.status != "Searching") {
                $o.saveRecord.goToSave(checkoutB);
            }
        },

        myCartB: function () {
            var myCartB = [{
                RecoverType: 4,
                SentBy: $o.core.globalVariables.userType,
                Type: 'MyCartB'
            }];

            if ($o.core.globalVariables.userType == "V" && $o.variablesVisitor.status != "Searching") {
                $o.saveRecord.goToSave(myCartB);
            }
        },

        titleB: function () {
            var titleB = [{
                RecoverType: 4,
                SentBy: $o.core.globalVariables.userType,
                Type: 'TitleB'
            }];
            if ($o.core.globalVariables.userType == "V" && $o.variablesVisitor.status != "Searching") {
                $o.saveRecord.goToSave(titleB);
            }
        },

        closeViewerB: function () { //DEPRECATED,DESGLOSADO EN 2: closeByMenuB y closeViewerBySurveyB
            var closeViewerB = [{
                RecoverType: 3,
                SentBy: $o.core.globalVariables.userType,
                Type: 'CloseViewerB'
            }];
            $o.saveRecord.goToSave(closeViewerB);
        },

        closeByMenuB: function () {
            var closeByMenuB = [{
                RecoverType: 3,
                SentBy: $o.core.globalVariables.userType,
                Type: 'CloseByMenuB'
            }];
            $o.saveRecord.goToSave(closeByMenuB);
        },


        closeViewerBySurveyB: function () {
            var closeViewerBySurveyB = [{
                RecoverType: 3,
                SentBy: $o.core.globalVariables.userType,
                Type: 'CloseViewerBySurveyB'
            }];
            $o.saveRecord.goToSave(closeViewerBySurveyB);
        },


        getSummaryB: function () {
            var getSummaryB = [{
                RecoverType: 3,
                SentBy: $o.core.globalVariables.userType,
                Type: 'GetSummaryB'
            }];
            $o.saveRecord.goToSave(getSummaryB);
        },


        showSummary: function () {
            var showSummary = [{
                RecoverType: 4,
                SentBy: $o.core.globalVariables.userType,
                Type: 'ShowSummary'
            }];
            if ($o.core.globalVariables.userType == "V" && $o.variablesVisitor.status != "Searching") {
                $o.saveRecord.goToSave(showSummary);
            }
        },

        sendSummary: function (email) {
            var sendSummary = [{
                RecoverType: 3,
                SentBy: $o.core.globalVariables.userType,
                Type: 'SendSummary',
                Fields: {
                    Email: email
                }
            }];
            $o.saveRecord.goToSave(sendSummary);
        },

        rate: function (action, nameAgent) {
            var rate = [{
                RecoverType: 4,
                SentBy: $o.core.globalVariables.userType,
                Type: 'Rate',
                Fields: {
                    Action: action,
                    NameAgent: nameAgent
                }
            }];
            $o.saveRecord.goToSave(rate);
        },

        //envia records de click en pagina y iframestatus CHat
        pageClick: function () {
            var itemsArray = [{
                SentBy: $o.core.globalVariables.userType,
                RecoverType: 4,
                Type: 'PageClick'
            },
            {
                SentBy: $o.core.globalVariables.userType,
                RecoverType: 2,
                Type: 'StatusViewer',
                Fields: { Status: "CHAT" }
            }];
            //$o.saveRecord.goToSave(itemsArray);
        },


        transfer: function (oldAgent, newAgent, message, type) {
            var transfer = [
                {
                    SentBy: "A",
                    Type: 'Transfer',
                    //RecoverType: $o.core.globalVariables.userType == "V" ? type == $o.visitorTransfer.types.AGENTDISCONNECT && !newAgent ? 4 : 3 : 3,
                    RecoverType: 3,
                    Fields: {
                        OldAgent: oldAgent,
                        NewAgent: newAgent,
                        Message: message,
                        Type: type
                    }
                }];
            $o.saveRecord.goToSave(transfer);
        },

        endSessionB: function () {
            var endSessionB = [{
                RecoverType: 3,
                SentBy: $o.core.globalVariables.userType,
                Type: 'EndSessionB'
            }];
            $o.saveRecord.goToSave(endSessionB);
        },

        memo: function (text) {
            var memo = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'Memo',
                RecoverType: 2,
                Fields: {
                    Content: text
                }
            }];
            $o.saveRecord.goToSave(memo);
        },

        form: function (subType, id, body) {
            var form = [{
                SentBy: subType === "INITFORM" ? "A" : $o.core.globalVariables.userType, //INITFORM es un formulario custom de MOBIOCASION que se envia ala entrada desde Visitor. Hay que cambiar SentBy.
                Type: 'Form',
                RecoverType: 1,
                Fields: {
                    SubType: subType,
                    Id: id,
                    Content: body
                }
            }];
            $o.saveRecord.goToSave(form);
        },

        formOrder: function (subType, id, body) {
            var form = [{
                SentBy: "A",
                Type: 'Form',
                RecoverType: 1,
                Fields: {
                    SubType: subType,
                    Id: id,
                    Content: body
                }
            }];
            $o.saveRecord.goToSave(form);
        },

        //podemos responder formularios que se hayan enviado a sesiones anteriores, guardando la respuesta en esa sesion
        formResponse: function (id, responses, room, sessionSummaryId, customFormsFields) {
            var fields = {
                Id: id,
                Response: responses
            };

            if (customFormsFields) {
                fields.FieldNames = JSON.stringify(customFormsFields)
            }

            var response = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'FormResponse',
                RecoverType: 1,
                Fields: fields
            }];

            $o.saveRecord.goToSave(response, room, sessionSummaryId);
        },

        agentOut: function (name, messageType) {
            var agentOut = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'AgentOut',
                RecoverType: 4,
                Fields: {
                    Name: name,
                    MessageType: messageType
                }
            }];
            if ($o.core.globalVariables.userType == "V" && $o.variablesVisitor.status != "Searching") {
                $o.saveRecord.goToSave(agentOut);
            }
        },

        conference: function (recoverType, action, typeConference, duration) {
            var conferenceInteraction = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'Conference',
                RecoverType: recoverType,
                Fields: {
                    Action: action,
                    Type: typeConference
                }
            }];
            if (duration) conferenceInteraction[0].Fields["Duration"] = duration;
            $o.saveRecord.goToSave(conferenceInteraction);
        },

        documentLink: function (extension, url) {
            var doc = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'DocumentLink',
                RecoverType: 1,
                Fields: {
                    Id: $o.tools.generateRandomId().toString(),
                    Extension: extension,
                    Url: url
                }
            }];
            $o.saveRecord.goToSave(doc);
        },

        contextInfo: function (context) {
            var info = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'ContextInfo',
                RecoverType: 2,
                Fields: context
            }];
            $o.saveRecord.goToSave(info);
        },

        botProductSearch: function (context) {
            var info = [{
                SentBy: "A",
                Type: 'BotProductSearch',
                RecoverType: 1,
                Fields: context
            }];

            return new Promise(function (resolve, reject) {
                $o.saveRecord.goToSave(info).then(function (result) {
                    resolve(result);
                });
            });
        },


        openNewTab: function () {
            var info = [{
                SentBy: $o.core.globalVariables.userType,
                Type: 'OpenNewTab',
                RecoverType: 4,
                Fields: {
                    Action: "ClosedBecaouseNewTab"
                }
            }];
            return info;
        }

    }
})(window);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.search = {
        init: function () {
            $o.search.events();
        },
        
        resetSearch: function () {
            $o.search.itsANewSearch = true;
            $o.search.setSearchIndex($o.search.searchIndexActions.RESET);
            $o.search.nodesDeleteList();
            $o.search.sortedBy = "relevance";//$(".sort-by-relevance").text().toLowerCase();
            $o.search.direction = "desc";
            $o.search.setDefaultSortChoiceUI();
            searchVM.appliedFilters([]);
        },

        doSearch: function (searchTerm, filter, recover, sendSearchToAgent) {

            var orderBy = "&orderby=" + $o.search.sortedBy;
            var direction = "&dir=" + $o.search.direction;
            if (!filter) {
                $("#filter-button > span").hide().text("");
            };
            //Cuidado porque esto no es escalable. Cogemos la ltima palabra de la ordenacin por si ya empieza con "ordenar por..."
            var splitOrderBy1 = $(".sort-filter li:nth-child(1)").text().split(" ");
            var splitOrderBy2 = $(".sort-filter li:nth-child(2)").text().split(" ");
            var splitOrderBy3 = $(".sort-filter li:nth-child(3)").text().split(" ");
            if ($o.search.sortedBy == "relevance") {
                $(".sorted-by").text(" " + splitOrderBy3[splitOrderBy3.length - 1].toLowerCase());
            }
            else if ($o.search.sortedBy == "price") {
                $(".sorted-by").text(" " + splitOrderBy2[splitOrderBy2.length - 1].toLowerCase());
            }
            else if ($o.search.sortedBy == "name") {
                $(".sorted-by").text(" " + splitOrderBy1[splitOrderBy1.length - 1].toLowerCase());
            }
            else {
                $(".sorted-by").text(" " + $o.search.sortedBy);
            }
            
            //Antigua solucin a la que revertir si no gusta la nueva:
            //$(".sorted-by").text(" " + $o.search.sortedBy);
            if ($o.core.globalVariables.userType == "V") {
                $o.search.searchTerm = $o.chat.purifyMessages(searchTerm, $o.core.globalVariables.userType);
            }
          
            $o.search.setSearchLayoutUI();
            var search = {
                Body: filter != undefined ? searchTerm + filter + orderBy + direction : searchTerm + orderBy + direction,
                Room: $o.core.globalVariables.room,
                SentBy: "V",
                Type: "Q"
            },
                acceptSearch = false;

            if (($o.core.globalVariables.userType == "V") && (!recover) && ($o.search.itsANewSearch)) {
                if ($o.core.isSignalRConnected()) {
                    $o.hubsOut.sendSearchTerm(search, sendSearchToAgent);
                }
            }

            //solo busca si es una nueva busqueda o quedan resultados por buscar
           var allResultsReturned = $o.search.allResultsReturned ? $o.search.allResultsReturned():false;

            if ($o.search.itsANewSearch) {
                if ($o.search.itsANewSearch && !recover && !$o.search.isSearching) {
                    $o.saveRecord.query(search.Body, "Query");
                   
                    // $o.hubsOut.addInteraction(search);
                }
                $o.search.loadingSearchUI();
                acceptSearch = true;
            } else if (!allResultsReturned) {
                $o.search.loadingMoreProductsUI();
                acceptSearch = true;
            }
            if (acceptSearch) {
                $("#error-search").hide();

                $o.search.isSearching = true;
                $o.search.getSearchData(searchTerm, filter, recover);
                $o.search.setSearchIndex($o.search.searchIndexActions.ADD);
            }
            if ($o.core.globalVariables.userType == "A" && !recover && window.parent && window.parent.sendAgentSearchEventToGA) { 
                window.parent.sendAgentSearchEventToGA("Shop", searchTerm);
            }
        },

        add: function (nodes, totalItems, recover) {
            /*if ($o.core.globalVariables.showCoviewer) {
                return;
            }*/
            $("#filters-panel,#sort-results-panel").hide();
            if ($o.core.globalVariables.userType == "V") $o.visitorSearch.hideSearchTutorial();
            if ($o.search.itsANewSearch == true) {
                window.searchVM.totalResults(totalItems);
                $o.search.totalResults = totalItems;
            }
            $o.search.removeLoadingProductsUI();
            $o.search.setTotalItemsUI(totalItems);
            if (nodes.length) {
                $.each(nodes, function (i) {
                    window.searchVM.add(nodes[i]);
                });

                //&& $o.core.globalVariables.enterType != $o.core.enterType.REOPEN
                if ($o.core.userType == "V" && $o.search.newSearch == true && ($o.enterData.idProduct == "") && $o.core.globalVariables.enterType != $o.core.enterType.RECOVERSESSION && (!$o.core.globalVariables.internalId) && (!recover)) {
                    setTimeout(function () {
                        $o.search.clickFirstProductUI();
                    }, 1000);
                }
                $o.search.newSearch = false;
                $o.search.hideNoProducts();
            } else {

                if ($o.core.userType == "V" && $o.enterData.productsViewed != "" && !recover) {
                    $o.platform.getProductSummary($o.enterData.productsViewed);
                }
                $o.search.showNoProducts();
                window.searchVM.isEmptyGrid(true);
            }
            // $o.log("SE LIBERA");
            $o.search.isSearching = false;
        },

        nodesDeleteList: function () {
            window.searchVM.emptySearchResults();
        },

        searchNodeInSearchVM: function (nodeId) {
            var node = window.searchVM.searchNode(nodeId);
            return node;
        },
        
        addNodeToMyList: function (node) {
            var product = viewedVM.getProduct(node);
            $o.search.addNodeToMyListUI();
            $o.carousel.addProductInfoToList(product, $o.carousel.lists.MYLIST);
            var fullProduct = $o.fullProducts.searchProduct(product.InternalId);
            $o.carousel.prepareInteraction(fullProduct, $o.carousel.lists.MYLIST);
        },

        addNodeToCart: function (node) {
            $o.search.addNodeToCartUI();
            $o.carousel.addProductInfoToList(node, $o.carousel.lists.MYCART);
        },

        size: 10,
        sortedBy: "relevance",
        direction: "desc",
        totalResults: 0,
        itsANewSearch: true,
        newSearch: true,
        openSeeDescription: false,
        searchDirections: {
            ASC: "asc",
            DESC: "desc"
        },
        searchTerm: "",
        searchModes: {
            RESULTS: "RESULTS",
            CATEGORY: "CATEGORY",
            CATALOG: "CATALOG"
        },
        searchMode: "",
        //marcamos en indice en paginas

        searchIndexActions: {
            RESET: "RESET",
            ADD: "ADD"
        },
        isSearching: false,
        sendingProductToCanva: false,
        productFromSearch:false
    };
})(window);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.tools = {
        init: function () {
            $o.tools.events();
        },

        change: function (tool) {
            $o.canva.holder.helper.removeClass();
            $o.tools.context = tool;
            switch (tool) {
                case $o.tools.type.PIN:
                    $o.tools.addClassAddingPin();
                    break;
                case $o.tools.type.POINT:
                    $o.tools.addClassPointing();
                    break;
            }
        },

        generateRandomId: function () {
            var text = "", possible = "abcdefghijklmnopqrstuvwxyz0123456789";
            for (var i = 0; i < 8; i++) text += possible.charAt(Math.floor(Math.random() * possible.length));
            return text;
        },

        //SOLo hara undo cuando se haya acabado de hacer un pin, si se cambia de imagen y hay pins no los borrar
        undoPin: function () {
            //encontrar ultimo pin de la imagen actual
            var result = $.grep($o.pin.pinsHistory, function (e) { return e.InternalId == $o.core.globalVariables.internalId && e.Scope == $o.carousel.currentImage; });
            result = result[result.length - 1];
            if (result) {
              $o.tools.deletePin(result.Id);
                //records y signalR
                var undo = {
                    Room: $o.core.globalVariables.room,
                    Id: result.Id,
                    Type: "U"
                };
                if ($o.core.isSignalRConnected()) {
                    $o.hubsOut.sendUndo(undo);
                }
                $o.saveRecord.undo(result.Id);
            }
        },

        deletePin: function (pinId) {
            var pinToDelete = $.map($o.pin.pinsHistory, function (obj, index) {
                if (obj.Id == pinId) {
                    return index;
                };
            });
          
            //borramos del visor y del array
            $o.pin.pinsHistory.splice(pinToDelete[0], 1);
            $("#" + pinId).remove();
        },

        randomCursorPosition: function () {
            var top = Math.floor((Math.random() * 10) + 1);
            var left = Math.floor((Math.random() * 10) + 1);
            top = top < 5 ? -50 : 320;
            left = left < 5 ? -50 : 540;
            var pos = { top: top, left: left };
            return pos;
        },

        context: "DRAG",
        lastContext: "",
        undoActions: 0,

        type: {
            ZOOM: "ZOOM",
            DRAG: "DRAG",
            PIN: "PIN",
            POINT: "POINT",
            MARK: "MARK",
            ANY: "ANY"
        },

        object: null,

        button: { zoom: null, pin: null, point: null, note: null, mark: null }
    };
})(window);



function YouTubeViewer(viewerContainerId) {
    var _this = this;
    oct8ne.log("Inicializamos youtube");
    this.player = "";
    this.videoPlayerIsReady = ko.observable(false);
    this.isPlaying = ko.observable(false);
    this.isMuted = ko.observable(false);
    this.videoDuration = ko.observable(0);
    this.currentPosition = ko.observable(0);
    this.pauseTimer = 0;
    this.positionTimer = 0;
    this.lastClickTime = 0;
    this.delayBetweenClicks = 300;
    this.onAction = function (action, time) {

        var room = $o.core.globalVariables.room;
        if ($o.core.globalVariables.userType == "V") {
            if ($o.core.isSignalRConnected()) {
                $o.hubsOut.sendVideoAction(action, time, room);
            }
        } else {
            window.top.videoActionFromDrashboard(action, time, room);
        }


    };
    this.currentTimePositionFormatted = ko.pureComputed(function () {
        var pos = _this.currentPosition();
        var hours = Math.floor(pos / 3600);
        pos -= hours * 3600;
        var minutes = Math.floor(pos / 60);
        pos -= minutes * 60;
        var seconds = Math.round(pos);
        var result = (hours < 10 ? "0" : "") + hours + ":";
        result += (minutes < 10 ? "0" : "") + minutes + ":";
        result += (seconds < 10 ? "0" : "") + seconds;
        return result;
    });
    // Autocheck: if the video status changes to PLAYING, force initialization of controls
    this.autocheckingTimer = 0;
    // Player status change handler
    this.prevStatus = null;
    this.viewerContainerId = viewerContainerId;
    this.slider = "";
    this.initializeSlider();
    this.loaded = false;
    this.retries = 0;
}
YouTubeViewer.prototype.setup = function (callback) {
    oct8ne.log("Cargamos script youtube");
    var _this = this;
    $.ajax({
        type: "GET",
        url: "//www.youtube.com/iframe_api",
        success: function () {
            _this.loaded = true;
            if (callback) setTimeout(function () { callback(); }, 200);
        },
        error: function () {
            oct8ne.log("Error carga script youtube");
            ++_this.retries;
            if (_this.retries < 3) { _this.setup(callback); }
            else {
                console.log("Youtube has not been loaded!");
            }
        },
        dataType: "script",
        cache: true
    });
};

//#region Public methods
YouTubeViewer.prototype.onVisibleResourceChanged = function (user, resourceId, url, title) {
    // _super.prototype.onVisibleResourceChanged.call(this, user, resourceId, url, title);
    this.load(url);
};

YouTubeViewer.prototype.clear = function () {
    // _super.prototype.clear.call(this);
    if (this.player) {
        this.videoDuration(0);
        this.disableTimer();
        this.player.stopVideo();
        this.player.clearVideo();
    }
};

YouTubeViewer.prototype.resizeWindow = function (left, top, width, height) {

    var container = $("#" + this.viewerContainerId);
    var controls = $("#" + this.viewerContainerId + "-controls");
    var newHeight = height - 80;
    var newWidth = height * 1.77 - 120;
    var newLeft = (width - newWidth) / 2;
    var newTop = 0;
    //  container.css({ width: newWidth, height: newHeight, left: newLeft, top: newTop });
    //  controls.css({ top: newTop + newHeight - controls.height() + 10 });
    return {
        //   height: newHeight,
        //  width: newWidth
        width: "100%"
    };
};

YouTubeViewer.prototype.load = function (videoUrl) {
    var _this = this;
    this.isPlaying(false);
    this.videoPlayerIsReady(false);
    this.firstLoad = true;
    this.actionNameReceivedBeforeLoading = null;
    this.actionTimeReceivedBeforeLoading = null;
    this.videoDuration(0);
    this.disableTimer();

    var container = $("#" + this.viewerContainerId);
    //container.css({ width: "100%", height: "100%", margin:"0 auto"});
    var height = container.height();
    var width = container.width();
    this.resizeWindow(0, 0, width, height);
    var videoId = "";
    if (videoUrl.indexOf("youtu.be") != -1) {
        videoId = videoUrl.substring(videoUrl.lastIndexOf("/") + 1);
    } else {
        videoId = videoUrl.split('=')[1];
        videoId = videoId.split('&')[0];
    }
    // Patch ******************************
    if (this.player) {
        this.player.destroy();
        this.player = null;
    }
    // End patch **************************


    if (this.player) {
        this.clear();
        this.isMutedBeforeStart = this.player.isMuted();
        this.player.mute();
        this.player.loadVideoById({ videoId: videoId });
        this.startAutocheckingOfVideoPlayer();
    } else {
        this.player = new YT.Player(this.viewerContainerId, {
            height: height,
            width: width,
            playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0 },
            videoId: videoId,
            progressBar: false,
            events: {
                'onReady': function (e) {
                    Log("Video player is ready");
                    _this.isMutedBeforeStart = _this.player.isMuted();
                    _this.player.mute();
                    _this.startAutocheckingOfVideoPlayer();
                },
                'onStateChange': function (e) {
                    return _this.onPlayerStateChange(e);
                },
                'onError': function (e) {
                    var msg;
                    switch (e.data) {
                        case 100:
                            msg = culture.coviewer.VideoNotFound;
                            break;
                        case 101:
                        case 150:
                            msg = culture.coviewer.VideoNotExternal;
                            break;
                        default:
                            msg = culture.coviewer.VideoError + e.data + ".";
                            break;
                    }
                    Ui.DialogBox.error(msg);
                    Log("Youtube player ERROR " + e.data + ": " + msg);
                }
            }
        });
    }
};

// Remote actions
YouTubeViewer.prototype.processAction = function (action, time) {
    var _this = this;
    if (this.firstLoad) {
        this.actionNameReceivedBeforeLoading = action;
        this.actionTimeReceivedBeforeLoading = time;
        this.actionBeforeLoadingReceivedAtMilliseconds = new Date().getTime();
    }

    if (this.pauseTimer) {
        clearTimeout(this.pauseTimer);
        this.pauseTimer = 0;
    }

    switch (action) {
        case "play":
            this.isPlaying(true);
            this.player.seekTo(time);
            this.player.playVideo();
            this.updateUiWithVideoPosition(time);
            this.enableTimer();
            break;
        case "pause":
            this.disableTimer();
            var actualTime = this.player.getCurrentTime();
            var dif = (time - actualTime) * 1000;
            if (actualTime < time && this.isPlaying() && dif <= 4000) {
                this.pauseTimer = setTimeout(function () {
                    _this.player.pauseVideo();
                    _this.pauseTimer = 0;
                    _this.isPlaying(false);
                }, dif);
            } else {
                this.player.pauseVideo();
                this.player.seekTo(time);
                this.updateUiWithVideoPosition(time);
                this.isPlaying(false);
            }
            break;
    }
};

//#endregion
//#region UI events & computed observables
YouTubeViewer.prototype.playClicked = function () {
    if (this.isPlaying() || (new Date().getTime() - this.lastClickTime < this.delayBetweenClicks || this.videoPlayerIsReady() == false))
        return;
    this.lastClickTime = new Date().getTime();
    this.isPlaying(true);
    var actualTime = this.player.getCurrentTime();
    this.onAction("play", actualTime);
    this.player.playVideo();
    this.enableTimer();
};

YouTubeViewer.prototype.pauseClicked = function () {
    if (!this.isPlaying() || (new Date().getTime() - this.lastClickTime < this.delayBetweenClicks))
        return;
    this.lastClickTime = new Date().getTime();
    this.isPlaying(false);
    var actualTime = this.player.getCurrentTime();
    this.onAction("pause", actualTime);
    this.player.pauseVideo();
    this.disableTimer();
};

YouTubeViewer.prototype.speakerClicked = function () {
    this.isMuted(!this.isMuted());
    if (this.isMuted()) {
        this.player.mute();
    } else {
        this.player.unMute();
    }
};

//#region Private members
// Called after the video preloading
YouTubeViewer.prototype.initializePlayerStatusAndControls = function () {
    var action, time;
    Log("Initializing player and controls");
    this.stopAutocheckingOfVideoPlayer();
    if (this.actionNameReceivedBeforeLoading) {
        Log("Applying last command received during buffering: " + this.actionNameReceivedBeforeLoading + " " + this.actionTimeReceivedBeforeLoading);
        action = this.actionNameReceivedBeforeLoading;
        time = this.actionTimeReceivedBeforeLoading;
    } else {
        action = "pause";
        time = 0;
        Log("Pausing video at 0:00 after buffering");
    }

    if (action == "pause") {
        this.prevStatus = YT.PlayerState.PAUSED;
        this.player.pauseVideo();
        this.player.seekTo(time);
        this.disableTimer();
    } else if (action == "play") {
        var dif = Math.round((new Date().getTime() - this.actionBeforeLoadingReceivedAtMilliseconds) / 1000);
        this.prevStatus = YT.PlayerState.PLAYING;
        this.player.seekTo(time + dif);
        this.player.playVideo();
        this.enableTimer();
    }

    var duration = Math.floor(this.player.getDuration());
    this.videoDuration(duration);
    this.setSliderMax(duration);
    this.updateUiWithVideoPosition(time);
    this.videoPlayerIsReady(true);
    if (this.isMutedBeforeStart) {
        this.player.mute();
    } else {
        this.player.unMute();
    }
};

YouTubeViewer.prototype.startAutocheckingOfVideoPlayer = function () {
    var _this = this;
    this.stopAutocheckingOfVideoPlayer();
    var that = this;
    setTimeout(function () {
        if (!that.firstLoad)
            return;
        Log("Starting player status polling...");
        that.autocheckingTimer = setInterval(function () {
            var currentStatus = that.player.getPlayerState && that.player.getPlayerState();
            if (currentStatus === YT.PlayerState.PLAYING && that.firstLoad) {
                Log("Forcing player and controls initialization");
                that.stopAutocheckingOfVideoPlayer.bind(that);
                _this.firstLoad = false;
                that.initializePlayerStatusAndControls();
            }
        }, 1000);
    }, 5000);
};
YouTubeViewer.prototype.stopAutocheckingOfVideoPlayer = function () {
    if (this.autocheckingTimer) {
        clearInterval(this.autocheckingTimer);
        this.autocheckingTimer = 0;
    }
};

YouTubeViewer.prototype.onPlayerStateChange = function (event) {
    this.videoStopped = false;
    Log(event.data);
    switch (event.data) {
        case YT.PlayerState.PLAYING:
            if (this.firstLoad) {
                Log("First PLAY of video");
                this.stopAutocheckingOfVideoPlayer();
                this.firstLoad = false;
                this.initializePlayerStatusAndControls();
            } else {
                Log("Video PLAYING > isPlaying()=" + this.isPlaying() + " and prevStatus==" + this.getStatusDescription(this.prevStatus));
                if (!this.isPlaying() && (this.prevStatus == YT.PlayerState.PAUSED || this.prevStatus == YT.PlayerState.ENDED)) {
                    this.playClicked();
                }
                this.prevStatus = event.data;
            }
            break;

        case YT.PlayerState.PAUSED:
            if (this.player.getCurrentTime() >= this.videoDuration()) {
                this.prevStatus = event.data;
                Log("Video PAUSED before video END");
                return;
            }
            Log("Video PAUSED > isPlaying()=" + this.isPlaying() + " and prevStatus==" + this.getStatusDescription(this.prevStatus));
            if (this.isPlaying() && this.prevStatus == YT.PlayerState.PLAYING) {
                this.pauseClicked();
            }
            this.prevStatus = event.data;
            break;

        case YT.PlayerState.ENDED:
            Log("Video ENDED");
            this.videoStopped = true;
            this.isPlaying(false);
            this.updateUiWithVideoPosition(this.player.getCurrentTime());
            this.disableTimer();
            this.prevStatus = event.data;
            break;

        default:
            var status = this.getStatusDescription(event.data);
            Log("Video player status changed to " + status + "(previous state was " + this.getStatusDescription(this.prevStatus) + ")");
            break;
    }
};

YouTubeViewer.prototype.getStatusDescription = function (status) {
    var desc = status;
    switch (status) {
        case YT.PlayerState.PLAYING:
            desc = "Playing";
            break;
        case YT.PlayerState.BUFFERING:
            desc = "Buffering";
            break;
        case YT.PlayerState.PAUSED:
            desc = "Paused";
            break;
        case YT.PlayerState.ENDED:
            desc = "Ended";
            break;
        case YT.PlayerState.UNSTARTED:
            desc = "Unstarted";
            break;
    }
    return desc;
};

YouTubeViewer.prototype.enableTimer = function () {
    var _this = this;
    if (this.positionTimer) {
        var time = this.player.getCurrentTime();
        this.currentPosition(time);
        this.disableTimer();
    }
    this.positionTimer = setInterval(function () {
        _this.updateUiWithVideoPosition(_this.player.getCurrentTime());
    }, 1000);
};

YouTubeViewer.prototype.disableTimer = function () {
    if (this.positionTimer) {
        clearInterval(this.positionTimer);
        this.positionTimer = 0;
    }
};

YouTubeViewer.prototype.updateUiWithVideoPosition = function (time) {
    this.currentPosition(time);
    this.sliderControl.val(time);
};

YouTubeViewer.prototype.initializeSlider = function () {
    //$o.log("INITIALIZESLIDER");
    var _this = this;
    var readyForFirstSlide = true;
    var slider = this.sliderControl = $("#youtubevideoplayer-controls .slider");

    if (!slider.noUiSlider) {
        return;
    };

    slider.noUiSlider({
        start: 0,
        connect: "lower",
        orientation: "horizontal",
        range: {
            'min': 0,
            'max': 100
        }
    });
    slider.on('slide', function () {
        //$o.log("slide val =  " + slider.val());

        if (readyForFirstSlide) {
            readyForFirstSlide = false;
            _this.disableTimer();
        }
        _this.currentPosition(slider.val());
    });

    slider.on('set', function () {
        //$o.log("set");

        readyForFirstSlide = true;
        var time = slider.val();
        _this.updateUiWithVideoPosition(time);

        if ((_this.isPlaying() && time < _this.videoDuration())) {
            //$o.log("set PLAY");

            _this.player.seekTo(time);
            _this.enableTimer();
            _this.onAction("play", time);
        } else {
            //$o.log("set PAUSE");

            _this.onAction("pause", time);
            _this.player.seekTo(time);
            if (_this.videoStopped) {
                _this.videoStopped = false;
                _this.isPlaying(true);
                _this.enableTimer();
                Log("Playing after sliding on an ended video");
            }
        }
    });
};

YouTubeViewer.prototype.setSliderMax = function (duration) {

    if (!this.sliderControl.noUiSlider) {
        return;
    };

    this.sliderControl.noUiSlider({
        start: 0,
        range: {
            'min': 0,
            'max': duration
        }
    }, true);
};


function Log(k) {
    //$o.log(k);
}


window.oct8ne = window.$o = window.oct8ne || {};

$(function () {
    oct8ne.delay = {
        global: 0,
        chatQueue: 0,
        setGlobal: function (ms) {
            oct8ne.delay.global = oct8ne.delay.global + ms;
            //console.log("delay: " + oct8ne.delay.global);
        },
        reset: function () {
            //console.warn("reset delay: " + oct8ne.delay.global);
            oct8ne.delay.global = 0;
        }
    };

    oct8ne.registerBotResponse = function () {
        $o.chat.waitingForBotDelay = false;
        if ($o.bot && $o.bot.responseChecker) {
            $o.bot.responseChecker.onResponseReceived();
        }
    };

    oct8ne.saveDeliveryTime = function (interactionId) {
        //$.ajax({
        //    type: "POST",
        //    url: "/Data/SaveDeliveryDate",
        //    data: {
        //        tokenSession: $o.core.globalVariables.room,
        //        tokenVisitor: $o.core.globalVariables.myToken,
        //        interactionIds: parseInt(interactionId)
        //    },
        //    async: true
        //})
    };

    //ENTRADA
    $.connection.hubInterface.client.close = function () {
        $.connection.hub.stop();
        $o.inactivity.stopProcess();
        $o.core.doPostMessageToApi("CLOSEIFRAME");
    };

    $.connection.hubInterface.client.saveTempInteractions = function (room, summaryId, notifySavedTempInteractions) {
        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies,
            [
                { cookie: $o.cookies.tokenSession, value: room },
                { cookie: $o.cookies.sessionSummaryId, value: summaryId },
            ]);
        $o.core.globalVariables.roomForLastOperations = room;

        $o.saveRecord.saveListInteractions().then(function () {
            if (notifySavedTempInteractions) {
                $o.hubsOut.doneSaveTempInteraction(room);
            }
        });
    };

    //$.connection.hubInterface.client.yetConnected = function (token) {
    //    $o.hubsOut.yetConnected(token);
    //};

    $.connection.hubInterface.client.closeLastConnection = function () {
        if ($o.variablesVisitor.status != "Searching") {
            var interactionObject = $o.saveRecord.openNewTab();
            interactionObject[0].Fields = JSON.stringify(interactionObject[0].Fields); //Stringifear Fields
            $.ajax({
                type: "POST",
                url: "/Data/SaveInteractions",
                data: { sessionSummaryId: $o.variablesVisitor.sessionSummaryId, tokenSession: $o.core.globalVariables.room, tokenVisitor: $o.variablesVisitor.tokenVisitor, jsonListData: JSON.stringify(interactionObject) },
            }).always(function () { //SE EJECUTA SIEMPRE
                $.connection.hub.stop();
                $o.core.doPostMessageToApi("CLOSEMODAL");
            });
        } else {
            $.connection.hub.stop();
            $o.core.doPostMessageToApi("CLOSEMODAL");
        }
    };

    $.connection.hubInterface.client.receiveEnableClientTranslation = function (status, agentLanguage, visitorLanguage) {
        $o.translate.toggleTranslation(status, agentLanguage, visitorLanguage);
    };

    $.connection.hubInterface.client.changeStatus = function (parameters, doTransfer) {
        if ($o.core.globalVariables.room.startsWith("TEMP") && parameters.Visitor.Status == "Attending") {
            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies,
                [
                    { cookie: $o.cookies.tokenSession, value: parameters.Visitor.Room },
                    { cookie: $o.cookies.sessionSummaryId, value: parameters.Visitor.SessionSummaryId },
                ]);
            $o.core.globalVariables.roomForLastOperations = parameters.Visitor.Room;
        }

        //console.log(doTransfer);
        var queryString = "?tokenSession=" + $o.core.globalVariables.room + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId;
        if (doTransfer != "true") $o.visitorStart.changeStatus(queryString, parameters.Visitor.Status);
        $o.core.globalVariables.otherToken = parameters.Visitor.Agent.Token;
        if (parameters.Visitor.Status == "Attending") {
            $o.inactivityAgent.resetJumps();
            $o.visitorPixel.sales.setCookie();
            $o.carousel.sendProductToAnalytics("V");
            //$o.inactivity.attending.start();
            $o.core.hasBeenWaiting = true;
            $o.core.globalVariables.visitorsOverflow = false;
            $o.visitorStart.changeHeaderChatToChatting();
        } else if (parameters.Visitor.Status == "Waiting") {
            $o.core.hasBeenWaiting = true;
            $o.visitorSearch.getAgentStatusAfterWaiting(parameters);
            $o.core.globalVariables.visitorsOverflow = false;
            //  $o.inactivityAgent.clearTimerInterval();
        }

        if (doTransfer) {
            //if (parameters.Visitor.Status == "Waiting" && parameters.Visitor.Agent.Name != "Overbooking") {
            //    $o.inactivityAgent.timerInterval = setInterval($o.inactivityAgent.updateVisitorTime, 1000);
            //}

            $o.visitorTransfer.doTransferVisitor($o.core.globalVariables.agentId, null, $o.core.globalVariables.myToken, culture.coviewer.TransferMoreAvailable, $o.visitorTransfer.types.LIMITCHATEXCEEDED, parameters.Visitor.Agent.Name, "first available", null, false);
        }
        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [
            { cookie: $o.cookies.status, value: parameters.Visitor.Status }
        ]);
    };

    $.connection.hubInterface.client.changeStatusOverbookingToWaiting = function (parameters) {
        var queryString = "?tokenSession=" + $o.core.globalVariables.room
            + "&tokenVisitor=" + $o.variablesVisitor.tokenVisitor
            + "&statusVisitor=" + parameters.Status
            + "&idDept=" + $o.visitorStart.assignedDepartment.Id
            + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId
            + "&typeTransfer=" + $o.visitorTransfer.types.TAKEVISITOR;
        if ($o.core.globalVariables.room) {
            $.post("/Oct8ne/CreateSessionSameToken" + queryString);
        }
        //$o.visitorStart.changeStatus(queryString, parameters.Status);
        $o.visitorSearch.changeStatusOverbookingToWaiting(parameters);
        $o.core.hasBeenWaiting = true;
        $o.core.agentsConnected = true;

    };

    $.connection.hubInterface.client.openCoviewerFromPin = function (parameters) {
        var event = {
            category: "Oct8ne",
            type: "GAEnteredoct8ne",
            enterType: "PINCODE",
            viewedProductsBeforeEntering: 0
        }
        $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(event));
        $o.iframes.openCoviewerFromPin(parameters);
    };

    $.connection.hubInterface.client.receiveConferenceMessage = function (message, param, conferenceId) {
        $o.visitorStart.platform.processConferenceMessage(message, param);
    };

    $.connection.hubInterface.client.receiveSignalingMessage = function (message, conferenceId) {
        $o.visitorStart.platform.processSignalingMessage(message);
    };

    $.connection.hubInterface.client.receiveRefreshAgentInCall = function () {
        $o.visitorStart.platform.processConferenceMessage(99);
    };

    $.connection.hubInterface.client.receiveOnHoldCall = function (room, status) {
        if (window.conferenceVM) {
            window.conferenceVM.initOnHoldState(status);
        }
    };

    $.connection.hubInterface.client.receiveOnBackgroundApp = function () {
        if (window.conferenceVM) {
            window.conferenceVM.receiveOnBackgroundApp();
        }
    };

    $.connection.hubInterface.client.receiveOnForegroundApp = function () {
        if (window.conferenceVM) {
            window.conferenceVM.receiveOnForegroundApp();
        }
    };

    $.connection.hubInterface.client.receiveRejectedVideoCall = function () {
        if (window.conferenceVM) {
            window.conferenceVM.receiveRejectedVideoCall();
        }
    };


    //$.connection.hubInterface.client.onSelfDisconnectedConference = function () {
    //    $o.visitorStart.platform.onSelfDisconnected.trigger();
    //};

    $.connection.hubInterface.client.receiveMessage = function (parameters, delay) {
        if ($(".is-typing-layer").is(":visible") && $o.chat.waitingForBotDelay) {
            delay = null;
        }

        if (delay) {
            $o.delay.setGlobal(delay);
        }
        oct8ne.registerBotResponse();

        var executeChat = function () {
            --$o.delay.chatQueue;

            var messageToAlert = parameters.Body.Translated !== "false" && parameters.Body.Translated !== false ? parameters.Body.Translated : parameters.Body.Original;
            $o.chat.sendAlert(messageToAlert);
            if ($o.recoverRecords.startingRecoverViewer) {
                $o.chat.queueChats.push(parameters);
            } else {
                window.oct8ne.chat.updateMessage(parameters);
            }
            if ($o.delay.chatQueue > 0) {
                setTimeout(function () { $o.chat.showTypingDelayFromBot(); }, 600);
            } else {
                $o.delay.reset();
            }
            $o.chat.sendIsAttendedToAnalytics(parameters.Category, parameters.SentBy);
            $o.inactivity.attending.start();

            $o.chat.toogleDenyVisitorTyping(parameters.DenyVisitorTyping);

        };

        if (parameters.Category == "CHAT") {
            if ($o.delay.global != 0) {
                ++$o.delay.chatQueue;
                $o.chat.showTypingDelayFromBot();
                setTimeout(function () {
                    executeChat();
                    $o.chat.hideTyping();
                }, $o.delay.global);

            } else {
                executeChat();
            }

            $o.saveDeliveryTime(parseInt(parameters.Id));

        }

        if (parameters.Category == "CANNED") {

            if ($o.delay.global != 0) {
                ++$o.delay.chatQueue;
                $o.chat.showTypingDelayFromBot();
                setTimeout(function () {
                    --$o.delay.chatQueue;
                    if ($o.delay.chatQueue > 0) {
                        setTimeout(function () { $o.chat.showTypingDelayFromBot(); }, 600);
                    } else {
                        $o.delay.reset();
                    }

                    window.oct8ne.canned.createCanned(parameters);
                    $o.chat.hideTyping();
                }, $o.delay.global);

            } else {
                executeChat();
            }

        }
        if (parameters.Category == "FORM") {
            setTimeout(function () {
                $o.chat.sendAlert(culture.coviewer.ChatAlertForm);
                window.oct8ne.forms.createForm(parameters);
            }, $o.delay.global);

        }
        if (parameters.Category == "DOCS") {
            setTimeout(function () {
                $o.chat.sendAlert(culture.coviewer.ChatAlertDocument);
                window.oct8ne.forms.createDocs(parameters);
            }, $o.delay.global);

        }
        setTimeout(function () {
            $o.chat.playVisitorSound();
        }, $o.delay.global);


        if ($o.core.globalVariables.room.startsWith("TEMP")) {
            //Si es una sesin temporal
            $o.saveRecord.chat(parameters.Body.Original, parameters.Name, parameters.Id, parameters.SentBy, false);
        }
    };

    $.connection.hubInterface.client.receiveIsTyping = function (parameters) {
        window.oct8ne.chat.typing(parameters);
    };

    $.connection.hubInterface.client.receiveImage = function (parameters) {
        window.oct8ne.canva.update(parameters);
        $o.carousel.currentImage = parameters.Index;
        $o.carousel.updateCarouselArrows($o.carousel.currentImage);
        $o.inactivity.attending.restart();

    };

    $.connection.hubInterface.client.receivePoint = function (parameters) {
        window.oct8ne.drag.addPoint(parameters, false);
    };

    $.connection.hubInterface.client.receiveDrag = function (parameters) {
        window.oct8ne.drag.changeDrag(parameters);
    };

    $.connection.hubInterface.client.receivePin = function (parameters) {
        window.oct8ne.pin.addPin(parameters);
    };

    $.connection.hubInterface.client.receiveDrawing = function (parameters) {
        window.oct8ne.pencil.receiveDrawing(parameters);
    };

    $.connection.hubInterface.client.changeNode = function (parameters) {
        var product = window.viewedVM.getProduct(parameters.InternalId);
        if (parameters.SentBy == "A") {

            if (!product && parameters.FromAgentSearch) $o.canva.imageFromAgent = true;
            $o.productsChat.sentProductByAgent(parameters);

            if ($o.settings.hasOwnProperty("autoShowCoviewer") && $o.settings.autoShowCoviewer == true && ($o.iframes.currentIframeStatus == $o.iframes.iframeStatus.CHAT)) {
                $(".show-coviewer").addClass("blinking");
                $o.iframes.changeStatusIframe($o.iframes.iframeStatus.SEARCH);
            } else {
                $o.chat.addAlertProduct(parameters);
            };

            $o.carousel.loadingProduct();

            if ((($o.platform) && ((($o.platform.productBuyURL == "") || (!$o.platform.productBuyURL)) && (parameters.InternalId.indexOf("Oct8ne") == -1))) || ($o.utils && $o.utils.doAlwaysProductInfo && parameters.InternalId.indexOf("Oct8ne") == -1)) {
                $o.platform.getFullProductInfo(parameters.InternalId, $o.carousel.lists.VIEWED, "recover");
            } else {
                parameters.Thumbnail = parameters.URLMedia;

                if (parameters.RouteTo && parameters.RouteTo.length > 0) {
                    var separator = parameters.RouteTo.indexOf("?") > -1 ? "&" : "?";
                    parameters.RouteTo = parameters.RouteTo + separator + "utm_source=oct8ne&utm_medium=web";
                }

                if (parameters.InternalId.indexOf("Oct8ne") == -1) {
                    $o.carousel.sendNewProductToTrackingBar(parameters);
                    parameters.BuyURL = $o.platform.getBuyURL(parameters);
                }
                $o.carousel.sendProductToCarousel(parameters, parameters.ListType, $o.carousel.actions.VIEWINCANVA, "recover");
            }
            var internalId = parameters.InternalId;
            if ($o.utils && $o.utils.sendCustomProductIdToAnalytics) {
                internalId = $o.utils.sendCustomProductIdToAnalytics(internalId);
            }
            var event = {
                category: "Oct8ne",
                type: "GAAgentProductSuggested",
                viewedProduct: internalId
            }

            $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(event));

            if (!product) { //For first time product
                $o.carousel.sendProductToAnalytics("A", parameters.InternalId);
                if (parameters.InternalId.includes("Oct8neUpload")) {
                    $o.chat.playVisitorSound();
                }
            };
            $o.inactivity.attending.restart();

        }
    };

    $.connection.hubInterface.client.resetImage = function (parameters) {
        window.oct8ne.carousel.resetImage();
    };

    $.connection.hubInterface.client.changeZoom = function (parameters) {
        window.oct8ne.zoom.changeZoom(parameters);
    };

    $.connection.hubInterface.client.receiveVideoAction = function (action, time, room) {
        var processAction = function () { $o.core.youtubeViewModel.processAction(action, time) };
        if ($o.core.youtubeViewModel.loaded) {
            processAction();
        } else {
            $o.core.youtubeViewModel.setup(function () { processAction(); });
        }
    };

    $.connection.hubInterface.client.receiveNote = function (parameters) {
        window.oct8ne.note.addNote(parameters);
    };

    $.connection.hubInterface.client.receiveAgentLogOut = function (parameters, messageType) {
        $o.inactivity.setVisitorActive();
        $o.visitorStart.agentDisconnectedInterval = setInterval(function () {
            ++$o.visitorStart.agentDisconnectedTimer;
            //console.log("disconnected: " + $o.visitorStart.agentDisconnectedTimer);
            if ($o.visitorStart.agentDisconnectedTimer == 15) {
                $o.visitorStart.agentDisconnectedTimer = 0;
                clearInterval($o.visitorStart.agentDisconnectedInterval);
                $o.saveRecord.agentOut($o.core.globalVariables.otherName, messageType);
                $o.visitorTransfer.doTransferVisitor($o.core.globalVariables.agentId, null, $o.core.globalVariables.myToken, culture.coviewer.ChatTransferedCuz + " " + parameters.Agent.Name + " " + culture.coviewer.WasDisconnected, $o.visitorTransfer.types.AGENTDISCONNECT, $o.core.globalVariables.otherName, "first available", null, false);
            }
        }, 1000);

        if ($o.core.globalVariables.conferenceProvider && $o.visitorStart.platform != "") { $o.visitorStart.platform.processConferenceMessage(99); }

    };

    $.connection.hubInterface.client.changeTokenAgent = function (token) {
        $o.visitorStart.agentDisconnectedTimer = 0;
        clearInterval($o.visitorStart.agentDisconnectedInterval);
        $o.core.globalVariables.otherToken = token;

    };

    $.connection.hubInterface.client.changeAgent = function (parameters) {
        //parameters.Result = 0 Transfer ok
        //parameters.Result = 2 no more agents connected.
        //parameters.Result = 3 overbooking      
        oct8ne.registerBotResponse();
        if ($o.delay.global != 0) {
            $o.delay.setGlobal(700);
        };
        var canned;

        var showCanned = true;
        if ($o.utils && $o.utils.showCannedFromTransfer) {
            showCanned = $o.utils.showCannedFromTransfer(parameters);
        }

        if (parameters.Result == 0) {
            if ($o.utils && $o.utils.customTransferCallback) {
                $o.utils.customTransferCallback(parameters);
            }

            if (parameters.NewIdDepartment && parameters.NewIdDepartment != 0) { //&& $o.enterData.allowedDepartmentsId && $o.enterData.allowedDepartmentsId != "") {
                $o.enterData.allowedDepartmentsId = parameters.NewIdDepartment;
                $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [{ cookie: $o.cookies.allowedDepartmentsId, value: parameters.NewIdDepartment }]);
            }

            //console.log(parameters)
            if (parameters.OldAgent.IsBot) {
                $o.chat.toggleChatUploadButton(true);
                $o.chat.hideTyping();
                $o.choices.disableAllOnEnd(); 

                //console.log("transfer desde bot")
                if ($o.bot && $o.bot.responseChecker) {
                    $o.bot.responseChecker.disableCounter();
                }
                if ($o.utils && $o.utils.actionsAfterTransferFromBot) {
                    $o.utils.actionsAfterTransferFromBot();
                }
                oct8ne.registerBotResponse();
                var event = {
                    category: "Oct8ne",
                    type: "GATransferFromBot",
                    transferredTo: parameters.Visitor.Agent.Name
                }
                $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(event));
            }
            $o.core.globalVariables.agentType = $o.visitorStart.agentTypes.HUMAN;
            //Canned mensaje que el agente ya no esta disponible y te ha transferido
            if (parameters.TypeTransfer == $o.visitorTransfer.types.AGENTDISCONNECT || parameters.TypeTransfer == $o.visitorTransfer.types.INACTIVITYTOFIRST || parameters.TypeTransfer == $o.visitorTransfer.types.LIMITCHATEXCEEDED) {

                if (showCanned) {
                    if (parameters.TypeTransfer == $o.visitorTransfer.types.INACTIVITYTOFIRST && $o.core.globalVariables.baseUrl.indexOf("tdtprofesional") > -1) {
                        // console.log("NO SE MUESTRAN INACTIVITIES");
                    } else {
                        canned = culture.coviewer.NowAttendedBy;

                        let oldNameToTransfer = $o.core.globalVariables.otherName;

                        if ($o.utils && $o.utils.getAgentNameCustom) {
                            oldNameToTransfer = $o.utils.getAgentNameCustom();
                        }

                        canned = canned.replace("{{##old##}}", oldNameToTransfer).replace("{{##new##}}", parameters.Visitor.Agent.Name);

                        setTimeout(function () {
                            $o.canned.sendCanned($o.canned.type.TRANSFER, canned);
                        }, $o.delay.global);
                    }

                }

            } else if (parameters.TypeTransfer == $o.visitorTransfer.types.MANUALTOAGENT || parameters.TypeTransfer == $o.visitorTransfer.types.MANUALTOFIRST || parameters.TypeTransfer == $o.visitorTransfer.types.BOTTOFIRST) {
                if (showCanned) {
                    setTimeout(function () {
                        let cannedText = culture.coviewer.YouTranfered + " " + parameters.Visitor.Agent.Name;
                        if ($o.utils && $o.utils.rewriteTransferCanned) {
                            cannedText = $o.utils.rewriteTransferCanned();
                        }
                        $o.canned.sendCanned($o.canned.type.TRANSFER, cannedText);
                        
                    }, $o.delay.global);
                }
            } else if (parameters.TypeTransfer == $o.visitorTransfer.types.TAKEVISITOR) {
                if (showCanned && $o.variablesVisitor.status != "Searching") {
                    canned = culture.coviewer.NowAttendedBy;

                    let oldNameToTransfer = $o.core.globalVariables.otherName;

                    if ($o.utils && $o.utils.getAgentNameCustom) {
                        oldNameToTransfer = $o.utils.getAgentNameCustom();
                    }
                    canned = canned.replace("{{##old##}}", oldNameToTransfer).replace("{{##new##}}", parameters.Visitor.Agent.Name);
                    setTimeout(function () {
                        $o.canned.sendCanned($o.canned.type.TRANSFER, canned);
                    }, $o.delay.global);
                }
            }
            setTimeout(function () {
                $o.visitorStart.changeAgentUI(parameters);
                $o.visitorStart.sendOnAgentAssignedEventToApi(parameters.Visitor.Agent);
                $o.chat.toogleDenyVisitorTyping(false);
            }, $o.delay.global);

            //Reiniciar contador inactividad agente en lado visitor
            if (parameters.Visitor.Status == $o.variablesVisitor.status) { //Se resetea si el status  es igual porque si es diferente.. se hace en el changeStatus.
                $o.inactivityAgent.restartTimerInterval();
                $o.inactivityAgent.addJump();
            }

        } else if (parameters.Result == 2) {
            // Mensaje de que no hay mas agentes disponibles + boton de formulario
            $o.inactivityAgent.resetJumps();
            if ($o.utils && $o.utils.noAgentsInTransfer) {
                $o.utils.noAgentsInTransfer(parameters);
            } else {
                $o.inactivityAgent.clearTimerInterval();
                $.connection.hub.stop();
                $o.inactivity.setVisitorActive();
                $o.core.agentsConnected = false;
                setTimeout(function () {
                    $o.canned.sendCanned($o.canned.type.NOMOREAGENTS);
                }, $o.delay.global);
                $o.inactivity.disableChatInputUI();
                if (window.conferenceVM) {
                    window.conferenceVM.hideStartCallButtons(true);
                }
                $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [
                    { cookie: $o.cookies.sessionWithoutAgent, value: true },
                    { cookie: $o.cookies.status, value: "Finalized" }
                ]);
                $o.variablesVisitor.status = "Finalized";
                parameters.Visitor.Status = "Finalized";
            }

        } else if (parameters.Result == 3) {
            setTimeout(function () {
                $o.canned.sendCanned($o.canned.type.OVERBOOKING);
            }, $o.delay.global);
            $o.core.agentsConnected = false;
            $o.inactivity.disableChatInputUI();
            //parar contador inactividad agente en lado visitor
            $o.inactivityAgent.clearTimerInterval();
        }

        if (parameters.Visitor.Status != $o.variablesVisitor.status) {
            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [{ cookie: $o.cookies.status, value: parameters.Visitor.Status }]);
            var statusQueryString = "?tokenSession=" + $o.core.globalVariables.room + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId;
            $o.visitorStart.changeStatus(statusQueryString, parameters.Visitor.Status);
        }

        $o.inactivityAgent.lapseTime = 0;

    };

    var closeSession = function (hideMessage, fromInactivity) { //@param x 2 bool
        oct8ne.registerBotResponse();

        setTimeout(function () {

            let mustRatingsAtEnd = $o.utils && $o.utils.forceRatingAtEnd ? $o.utils.forceRatingAtEnd() : $o.settings.forceRatingsAtEnd; //UTILS SOBREESCRIBE BBDD

            if ($o.utils && $o.utils.removeUploadButton) {
                $o.utils.removeUploadButton();
            }

            if ($o.variablesVisitor.status === "Attending" && $o.settings.showRatingAgent == "True" && mustRatingsAtEnd && !fromInactivity) { //Send GET RATED form at the end of the session (not from Inactivity)
                if ($o.utils && $o.utils.overwriteRatingAtEnd) {
                    $o.utils.overwriteRatingAtEnd();
                } else {
                    //Aadir en if  Attending && activos ratings
                    var params = {
                        AgentImg: null,
                        Body: {
                            Original: null,
                            Translated: null
                        },
                        Category: "FORM",
                        DenyVisitorTyping: false,
                        Id: "EndVal",
                        Room: $o.core.globalVariables.room,
                        SentBy: "A",
                        Type: "VALORATION"
                    };
                    $.connection.hubInterface.client.receiveMessage(params, 0);
                }
            }
            if (!hideMessage) {
                $o.chat.showTypingDelayFromBot();
                setTimeout(function () {
                    $o.chat.hideTyping();
                    $o.canned.sendCanned($o.canned.type.RECONNECTSESSION);
                }, 1500);


            } //DEJAMOS EL RECONNECT SESSION
            $o.inactivity.stopProcess();
            $o.inactivity.disableChatInputUI();
            // $o.forms.disableOld();
            $.connection.hub.stop();
            $o.core.agentsConnected = false;
            var queryString = "?tokenSession=" + $o.core.globalVariables.room + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId;
            $o.visitorStart.changeStatus(queryString, "Finalized");
            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [{ cookie: $o.cookies.status, value: "Finalized" }]);
            $o.core.globalVariables.sessionFinalized = true;
            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: $o.cookies.tokenSession, value: "" }, { cookie: $o.cookies.lastInteractionAFK, value: "" },]);
        }, $o.delay.global);
    };

    $.connection.hubInterface.client.closeSessionByInactivity = function () {
        $o.saveRecord.inactivityServer();
        closeSession(false, true); //hideMessage, fromInactivity
    };

    $.connection.hubInterface.client.closeSession = function (hideMessage) {
        oct8ne.registerBotResponse();
        closeSession(hideMessage, false); //hideMessage, fromInactivity
    };

    $.connection.hubInterface.client.reciveForm = function (disconnectSignalR) {
        if (disconnectSignalR) {
            $.connection.hub.stop();
            $o.core.agentsConnected = false;
            var queryString = "?tokenSession=" + $o.core.globalVariables.room + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId;
            $o.visitorStart.changeStatus(queryString, $o.variablesVisitor.status);
            $o.canned.sendCanned($o.canned.type.AGENTSBUSY);
            $o.inactivity.disableChatInputUI();
        } else {
            $o.visitorSearch.reciveFormUI();
        }
    };

    $.connection.hubInterface.client.receiveUndo = function (parameters) {
        $o.tools.deletePin(parameters.Id);
    };

    $.connection.hubInterface.client.receiveSendToMyList = function (internalId) {

        if ($o.core.globalVariables.enterType != $o.core.enterType.CHECKOUT) {
            //$.getJSON($o.platform.domain + "oct8ne/frame/addtowishlist?callback=?&productIds=" + internalId, function (result) {
            //    $o.search.addNodeToMyList(internalId);
            //});

            $o.platform.startAddToWishListProcess(internalId);
            var node = $o.fullProducts.searchProduct($o.core.globalVariables.internalId);
            var whoAdd = "Agent";
            $o.hubsOut.alertAgentAddToMyList(node.Title, $o.core.globalVariables.otherToken, $o.core.globalVariables.myToken, $o.core.globalVariables.room, whoAdd);
            $o.visitorSearch.reciveSendToMyListUI();
        }
    };

    $.connection.hubInterface.client.receiveSendToMyCart = function (internalId) {
        if ($o.core.globalVariables.enterType != $o.core.enterType.CHECKOUT) {

            $o.platform.startAddToCartProcess(internalId);
            var node = $o.fullProducts.searchProduct($o.core.globalVariables.internalId);
            //     if ($o.iframes.currentIframeStatus == $o.iframes.iframeStatus.CHAT || $o.iframes.iframeStatus.MINIMIZED) $o.iframes.changeStatusIframe($o.iframes.iframeStatus.SEARCH);

            var event = {
                category: "Oct8ne",
                type: "GAClickAddToCart",
                addedBy: "Agent"
            }
            $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(event));
            $o.hubsOut.alertAgentAddToCart(node.Title, $o.core.globalVariables.otherToken, $o.core.globalVariables.myToken, "open");
        }
    };

    $.connection.hubInterface.client.receiveAjaxUpdates = function (what) {
        // en un futuro nos llegara la parte que tenemos que actualizar (cart, mylist, user)
        //if (what == "cart") {
        //} else if (what == "mylist") {
        //} else if (what == "user") {
        //} else {
        $o.platform.addPlatformLogin(); //DE MOMENTO SOLO ESTO TODO
        //};
    };

    $.connection.hubInterface.client.receiveOrder = function (orderStatus) {
        if ($o.platform && $o.platform.hasOwnProperty("orders")) {
            if (orderStatus.OrderId !== null) {
                $o.platform.orders.getDetailsFromVisitor(orderStatus);
            } else {
                $o.forms.sendOrderForm(orderStatus);
            }
        } else {
            for (var i = 0; i < orderStatus.OrderStatusNoPlugin.length; i++) {
                if (orderStatus.OrderStatusNoPlugin[i].action === "text") {
                    var message = {
                        Body: orderStatus.OrderStatusNoPlugin[i].body,
                        Name: $o.core.globalVariables.otherName,
                        Room: $o.core.globalVariables.room,
                        Category: "CHAT",
                        Id: $o.tools.generateRandomId(),
                        SentBy: "A" //Se enva desde Visitor pero debe ser Agent!!!
                    };
                    $o.saveRecord.chat(message.Body, message.Name, message.Id, message.SentBy, false);
                    $o.chat.updateMessage(message);
                }

                if (orderStatus.OrderStatusNoPlugin[i].action === "transfer") {
                    $o.visitorTransfer.doTransferVisitor($o.core.globalVariables.agentId, null, $o.core.globalVariables.myToken, "Transfer desde BOT", $o.visitorTransfer.types.BOTTOFIRST, "Bot", "first available", null, false);
                }
            }
        }
    };

    $.connection.hubInterface.client.receiveVisitorOrderRequest = function (orderId) {
        oct8ne.registerBotResponse();

        if ($o.platform && $o.platform.hasOwnProperty("orders")) {
            $o.platform.orders.getDetailsForTreeBot(orderId);
        } else {
            $o.hubsOut.sendVisitorOrderResult({ details: {}, error: true });
        }
    };

    //$.connection.hubInterface.client.receiveTag = function (tag) {
    //     $o.core.doPostMessageToApi("SENDANALYTICSEVENT", GAAddedTag," + tag);
    //};

    $.connection.hubInterface.client.receiveAnalyticsEvent = function (event) {
        oct8ne.registerBotResponse();
        var parsedEvent = {
            category: "Oct8ne",
            type: event.Action,
            label: event.Label,
            value: event.Value,
            customAction: event.CustomActionType
        }
        $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(parsedEvent));
    };

    $.connection.hubInterface.client.receiveRunAsyncScript = function (parameters) {
        oct8ne.registerBotResponse();
        if ($o.delay.global != 0) {
            $o.delay.setGlobal(700);
        };

        setTimeout(function () {
            if (parameters.RunInsideOct8ne) {
                var script = "try {" + decodeURIComponent(parameters.Script) + "} catch (error) {console.error('Bot script error: ' + error);}";
                eval(script);
            } else {
                $o.core.doPostMessageToApi("RUNSCRIPT", parameters.Script);
            }
        }, $o.delay.global);
    };

    $.connection.hubInterface.client.receiveAgentCoviewerLoaded = function () {
        $o.platform.manageCartData();
    }
});
$(function () {
    //SALIDA
    //Enviem a signalr y afegim interaccions
    oct8ne.hubsOut = {
        sendSummary: function (parameters) {
            $.connection.hubInterface.server.sendSummary(parameters);
        },

        sendMessage: function (parameters) {
            $o.delay.reset();
            if ((parameters.SentBy == "V") && (parameters.Category == "CHAT")) {
                $o.inactivity.setVisitorActive();
                if ($o.core.globalVariables.agentType == "BOT") {
                    $o.chat.toogleDenyVisitorTyping(true);          
                    
                    //appears isTyping when waiting for gtp response
                    $o.chat.isTypingWhileBotRequest();
                }               
            }
            $o.chat.sendIsAttendedToAnalytics(parameters.Category, parameters.SentBy);
            $.connection.hubInterface.server.sendMessage(parameters);
        },

        sendFormResponse: function (parameters) {
            $.connection.hubInterface.server.sendFormResponse(parameters);
        },

        sendTransferVisitor: function (oldAgentToken, newAgentToken, room, textToTransfer, typeTransfer) {
            $.connection.hubInterface.server.transfer(oldAgentToken, newAgentToken, room, textToTransfer, typeTransfer, 0);
        },
        sendTransferVisitor2: function (oldAgentToken, newAgentId, room, textToTransfer, typeTransfer, forceDeptIdNull, forceNoMoreAgentsResult) {
            var deptId;
            if (!$o.enterData || !$o.enterData.allowedDepartmentsId || $o.enterData.allowedDepartmentsId == "null" || forceDeptIdNull === true) {
                deptId = null;
            } else {
                deptId = $o.enterData.allowedDepartmentsId;
            }
            $.connection.hubInterface.server.transferVisitor(oldAgentToken, newAgentId, room, textToTransfer, typeTransfer, deptId, forceNoMoreAgentsResult);
        },
        //yetConnected: function (token) {
        //    $.connection.hubInterface.server.yetConnected(token);
        //},
        doneSaveTempInteraction: function (room) {
            $.connection.hubInterface.server.doneSaveTempInteraction(room);
        },

        sendResetImage: function () {
            var image = {
                Room: $o.core.globalVariables.room,
                SentBy: $o.core.userType,
                Type: "RESET"
            };
            $.connection.hubInterface.server.sendResetImage(image);
        },

        sendSearchTerm: function (parameters, sendSearchToAgent) {
            $.connection.hubInterface.server.sendSearchTerm(parameters, sendSearchToAgent);
            $o.inactivity.setVisitorActive();
        },

        sendSearchTermCatalog: function (parameters) {
            $.connection.hubInterface.server.sendSearchTermCatalog(parameters);
        },

        sendNode: function (parameters) {
            // if (!parameters.ListType) parameters.ListType = $o.carousel.lists.VIEWED;
            //$o.log("-----------------------SEND-----------------------");
            //$o.log(parameters);            
            $.connection.hubInterface.server.sendNode(parameters);
            $o.inactivity.setVisitorActive();

        },

        sendImage: function (parameters) {
            $o.inactivity.setVisitorActive();
            $.connection.hubInterface.server.sendImage(parameters);
        },


        //CONFERENCE AREA
        //sendConferenceMessage: function (message, param) {

        //    console.log(message, param)
        //    $.connection.hubInterface.server.sendConferenceMessage(message, param);
        //},

        //sendSignalingMessage: function (parameters, data) {
        //    $.connection.hubInterface.server.sendSignalingMessage(parameters, data);
        //},

        //getIceServers: function () { //SERVIDORES DE VIDEOLLAMADA!
        //    return $.connection.hubInterface.server.getIceServers();
        //},

        //END CONFERENCE AERA

        sendPoint: function (parameters) {
            $.connection.hubInterface.server.sendPoint(parameters);
        },

        sendDrag: function (parameters) {
            $.connection.hubInterface.server.sendDrag(parameters);
        },

        responseCallBack: function (parameters) {
            $.connection.hubInterface.server.sendVoiceForm(parameters);
        },

        //sendPin: function (parameters) {
        //    $.connection.hubInterface.server.sendPin(parameters);
        //},

        //sendNote: function (parameters) {
        //    $.connection.hubInterface.server.sendNote(parameters);
        //},
        sendVideoAction: function (action, time, room) {
            $.connection.hubInterface.server.videoAction(action, time, room);
        },



        //sendUndo: function (parameters) {
        //    $.connection.hubInterface.server.sendUndo(parameters);
        //},


        sendDrawing: function (parameters) {
            $.connection.hubInterface.server.sendDrawing(parameters);
        },

        sendViewChange: function (parameters) {
            $.connection.hubInterface.server.sendViewChange(parameters);
        },

        addInteraction: function () { },
        sendDataVisitorToDashboard: function (room, parameters) {
            $.connection.hubInterface.server.sendDataVisitor(room, parameters);
        },

        sendCartDataToDashboard: function (room, parameters) {            
            $.connection.hubInterface.server.sendCartData(room, parameters);
        },

        sendWriting: function (chat) {
            $.connection.hubInterface.server.isTyping(chat);
        },

        alertAgentAddToCart: function (title, tokenAgent, tokenVisitor,room, action) {            
            $.connection.hubInterface.server.alertAgentAddToCart(title, tokenAgent, tokenVisitor, room, action);
        },

        alertAgentAddToMyList: function (title, tokenAgent, tokenVisitor, tokenRoom, whoAdd) {
            $.connection.hubInterface.server.alertAgentAddToMyList(title, tokenAgent, tokenVisitor, tokenRoom, whoAdd);
        },

        sendInteractionsToAgent: function (agentToken, tokenVisitor, interactionsToSave) {
            $.connection.hubInterface.server.sendInteractionsToAgent(agentToken, tokenVisitor, interactionsToSave);
        },

        sendVisitorCheckout: function () {
            $.connection.hubInterface.server.sendVisitorCheckout($o.core.globalVariables.room, $o.core.globalVariables.room);
        },

        sendVisitorOrderResult: function (orderResult) {
            orderResult = Interactions.BaseManager.objectAdapter(orderResult, Interactions.Targets.Backend);
            $.connection.hubInterface.server.sendVisitorOrderResult(orderResult, Core.Helpers.getTokenRoom());
        }
    };
});
//Lanzar tests si se modifica

window.oct8ne = window.$o = window.oct8ne || {};
(function () {
    oct8ne.inactivity = {
        init: function () {
            $o.inactivity.recover();
            $o.inactivity.events();
        },

        timer: {
            general: null,
            ticks: 0,
            frequency: 1000,
            add: function () { return $o.inactivity.timer.ticks += ($o.inactivity.timer.frequency / 1000); },
            reset: function () {
                oct8ne.log("Reseteamos timer");
                var now = new Date();
                $o.inactivity.storage.setData(now.getTime(), $o.inactivity.attending.level);
            }
        },

        setVisitorActive: function () {
            $o.inactivity.stopProcess();
        },

        justLooking: {
            start: function () {

                oct8ne.log("Arranca inactividad JS visitante");
                var startTime = $o.inactivity.storage.getData();
                if (startTime === false) {
                   // console.log("Guardamos localstorage fecha actual");
                    var now = new Date();
                    $o.inactivity.storage.setData(now.getTime(), null);
                };
                $o.inactivity.timer.general = setInterval(function () { $o.inactivity.justLooking.increase(); }, $o.inactivity.timer.frequency);

            },

            increase: function () {
                var startTime = $o.inactivity.storage.getData();
                if (startTime) {
                    var now = new Date();
                    var inactivityTime = (now.getTime() - startTime.timer) / 1000; //In milliseconds
                    oct8ne.log("Calculamos tiempo inactividad JS visitante: " + inactivityTime);

                    if (inactivityTime > $o.inactivity.justLooking.limit) {
                        $o.inactivity.justLooking.disconnect();
                    }
                }
            },

            disconnect: function () {
                oct8ne.log("Desconectamos visitante por inactividad JL: " + $o.inactivity.timer.ticks);
                var queryString = "?tokenSession=" + $o.core.globalVariables.room + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId;
                $o.visitorStart.changeStatus(queryString, "Searching");
                $o.inactivity.stopProcess();
                $o.inactivity.disconnectCommonActions();
            },
            limit: 1200 //seconds
        },

        attending: {
            level: null,
            start: function () {
                oct8ne.log("Start Attending Inactivity");
                var startTime = $o.inactivity.storage.getData();
                if (startTime === false || startTime.level === null) {

                    if ($o.inactivity.attending.level === null) $o.inactivity.attending.level = 0;
                   // console.log("Arrancamos Attending Inactivity");
                    var now = new Date();
                    $o.inactivity.storage.setData(now.getTime(), $o.inactivity.attending.level);


                } else {
                    oct8ne.log("Ya estaba en marcha Attending Inactivity");

                }
                $o.inactivity.timer.general = setInterval(function () { $o.inactivity.attending.increase(); }, $o.inactivity.timer.frequency);
            },

            increase: function () {

                var startTime = $o.inactivity.storage.getData();
                if (startTime) {
                    var now = new Date();
                    var inactivityTime = (now.getTime() - startTime.timer) / 1000;
                    oct8ne.log("Checkeamos inactividad visitante: " + inactivityTime);
                    if (inactivityTime >= parseInt($o.settings.inactivityVisitorStages[$o.inactivity.attending.level])) {
                        $o.inactivity.attending.updateLevel();
                    }
                }

            },

            updateLevel: function () {
                var level = ++$o.inactivity.attending.level;
                oct8ne.log("Subimos nivel inactividad a: " +level);
                $o.inactivity.timer.reset();
                $o.canned.sendCanned($o.canned.type["INACTIVITYVISITOR" + level], $o.settings.inactivityVisitorMessages[level - 1]);
                if (level == 3) $o.inactivity.attending.disconnect();
            },

            disconnect: function () {
                oct8ne.log("Desconectamos por inactividad visitante");
                $o.inactivity.stopProcess();
                $o.inactivity.disableChatInputUI();
                $o.visitorStart.changeStatus("", "Searching");
                $o.canned.sendCanned($o.canned.type.RECONNECTSESSION);
                $o.inactivity.disconnectCommonActions();
            },
            restart: function () {
                oct8ne.log("Reseteamos inactividad visitante");
                $o.inactivity.stopProcess();
                $o.inactivity.attending.start();
            }
        },

        stopProcess: function () {
            oct8ne.log("STOP inactividad visitante");
            if ($o.inactivity.timer.general !== null) {

                $o.inactivity.timer.reset();
                clearInterval($o.inactivity.timer.general);
                $o.inactivity.timer.general = null;
                $o.inactivity.attending.level = null;
                $o.inactivity.storage.deleteData();
            } else {
                oct8ne.log("Ya est parada, no hacemos nada");
            }
        },

        recover: function () {
            var data = $o.inactivity.storage.getData();
            oct8ne.log("Recuperamos inactividad visitante");
            oct8ne.log(data)
            if (data) {
                //si devuelve level es de tipo attending
                if (data.level !== null) {
                    $o.inactivity.attending.level = data.level;
                    $o.inactivity.attending.start()
                } else {
                    $o.inactivity.justLooking.start()
                };
            };
        },

        disconnectCommonActions: function () {
            $.connection.hub.stop();
            $o.core.agentsConnected = false;
            $o.choices.disableAllOnEnd();
            $o.customForms.disableAll();
        },

        storage: {
            getData: function () {
                if ($o.storage.local.get($o.core.localStorageTypes.INACTIVITYVISITOR)) {
                    return JSON.parse($o.storage.local.get($o.core.localStorageTypes.INACTIVITYVISITOR));
                }
                return false;
            },

            setData: function (ticks, level) {
                if (ticks) {
                    var inactivity = {
                        timer: ticks,
                        level: level
                    }
                    oct8ne.log("Guardamos inactividad visitante: " + ticks);

                    $o.storage.local.set($o.core.localStorageTypes.INACTIVITYVISITOR, JSON.stringify(inactivity));
                } else {
                    return false;
                }
            },

            deleteData: function () {
                oct8ne.log("Borramos localStorage inactividad visitante");
                $o.storage.local.set($o.core.localStorageTypes.INACTIVITYVISITOR, $o.core.localStorageActions.REMOVE);
                // $o.storage.local.set($o.core.localStorageTypes.HIDENEWTUTORIAL, $o.core.localStorageActions.REMOVE); //Quiz no es su sitio!.
            }
        }
    };
})(window);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.inactivityAgent = {

        startCounter: function () {
            var inactivityAgentTimer = $o.storage.local.get($o.core.localStorageTypes.INACTIVITYAGENT);

            if (inactivityAgentTimer != null) { //F5
                $o.inactivityAgent.lapseTime = parseInt(inactivityAgentTimer);
            } else {
                if ($o.inactivityAgent.lapseTime == 0 || !$o.storage.local.get($o.core.localStorageTypes.INACTIVITYAGENT)) {
                    var now = new Date();
                    $o.storage.local.set($o.core.localStorageTypes.INACTIVITYAGENT, now.getTime());
                }
            };

            $o.inactivityAgent.timeInactivityLimit = $o.settings.inactivityAgentTime;
            $o.inactivityAgent.timerInterval = setInterval($o.inactivityAgent.updateVisitorTime, 1000);

        },

        updateVisitorTime: function () {
            var startDate = $o.storage.local.get($o.core.localStorageTypes.INACTIVITYAGENT);
            var endDate = new Date();

            $o.inactivityAgent.lapseTime = (endDate.getTime() - startDate) / 1000; //In milliseconds
            if ($o.utils && $o.utils.checkInactivityAfterTransfer && $o.utils.inactivityAfterTransferLimitSeconds && $o.utils.doTransferFallbackAfterTransferInactivity && $o.inactivityAgent.lapseTime >= $o.utils.inactivityAfterTransferLimitSeconds) {
                  $o.utils.doTransferFallbackAfterTransferInactivity();
            }

            oct8ne.log("agente: " + $o.inactivityAgent.lapseTime);

            if ($o.inactivityAgent.lapseTime <= $o.inactivityAgent.timeInactivityLimit) {

                oct8ne.log("agente: " + $o.inactivityAgent.lapseTime);
            } else {
                $o.inactivityAgent.clearTimerInterval();
                if ($o.variablesVisitor.status == "Waiting") {

                    var forceNoMoreAgentsResult = false;
                    var maxInactivityAgentJumps = 3;
                    if ($o.utils && ($o.utils.maxInactivityAgentJumps || $o.utils.maxInactivityAgentJumps == 0)) {
                        maxInactivityAgentJumps = $o.utils.maxInactivityAgentJumps;
                    }

                    if (maxInactivityAgentJumps <= $o.inactivityAgent.getJumps()) {
                        forceNoMoreAgentsResult = true;
                    }

                    $o.visitorTransfer.doTransferVisitor($o.core.globalVariables.agentId,
                        null,
                        $o.core.globalVariables.room,
                        culture.coviewer.TransferMoreAvailable,
                        $o.visitorTransfer.types.INACTIVITYTOFIRST,
                        $o.core.globalVariables.otherName,
                        "first available", null, forceNoMoreAgentsResult);
                }
                return;
            }
        },

        clearTimerInterval: function () {
            oct8ne.log("PAramos de contar")
            clearInterval($o.inactivityAgent.timerInterval);
            $o.storage.local.set($o.core.localStorageTypes.INACTIVITYAGENT, $o.core.localStorageActions.REMOVE);

        },

        //clearSessionStorage: function() {
        //    sessionStorage.removeItem('oct8ne-inactivity-agent');
        //},

        restartTimerInterval: function () {
            $o.inactivityAgent.clearTimerInterval();
            $o.inactivityAgent.startCounter();
        },


        addJump: function () {
            var jumps = $o.storage.local.get($o.core.localStorageTypes.INACTIVITYAGENTSJUMP);
            if (jumps != null) {
                $o.inactivityAgent.jumps = parseInt(jumps);
            }

            $o.inactivityAgent.jumps += 1;
            $o.storage.local.set($o.core.localStorageTypes.INACTIVITYAGENTSJUMP, parseInt($o.inactivityAgent.jumps));
        },

        getJumps: function () {
            return $o.inactivityAgent.jumps;
        },

        resetJumps: function () {
            $o.inactivityAgent.jumps = 0;
            $o.storage.local.set($o.core.localStorageTypes.INACTIVITYAGENTSJUMP, parseInt($o.inactivityAgent.jumps));
        },

        timerInterval: null,
        lapseTime: 0,
        jumps: 0,
        timeInactivityLimit: "" //VARIABLE DE SETTINGS
    };

})(window);
var Interactions;
(function (Interactions) {
    ;
    var Categories;
    (function (Categories) {
        Categories["Choice"] = "CHOICE";
        Categories["ChoiceResponse"] = "CHOICERESPONSE";
        Categories["Zoom"] = "ZOOM";
        Categories["Chat"] = "CHAT";
        Categories["SideBubble"] = "SIDEBUBBLE";
        Categories["SideBubbleView"] = "SIDEBUBBLEVIEW";
        Categories["Validation"] = "VALIDATION";
        Categories["CustomForm"] = "CUSTOM_FORM";
        Categories["CustomFormResponse"] = "CUSTOM_FORM_RESPONSE";
    })(Categories = Interactions.Categories || (Interactions.Categories = {}));
    var Targets;
    (function (Targets) {
        Targets["Backend"] = "BACKEND";
        Targets["Frontend"] = "FRONTEND";
    })(Targets = Interactions.Targets || (Interactions.Targets = {}));
})(Interactions || (Interactions = {}));

var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
window.oct8ne = window.$o = window.oct8ne || {};
var Interactions;
(function (Interactions) {
    function init(userData) {
        $o.tools.init();
        $o.search.init();
        $o.carousel.init();
        $o.canva.init();
        $o.drag.init();
        $o.pin.init();
        $o.speak.init();
        $o.filters.init();
        $o.scroll.init();
        $o.choices = Interactions.Choice.ChoiceManagerFactory.create(userData);
        $o.choiceResponses = Interactions.ChoiceResponse.ChoiceResponseManagerFactory.create(userData, $o.choices);
        $o.zoom = Interactions.Zoom.ZoomManagerFactory.create(userData);
        $o.sideBubbles = Interactions.SideBubble.SideBubbleManagerFactory.create(userData, "sideBubble");
        $o.customForms = Interactions.CustomForm.CustomFormManagerFactory.create(userData);
        $o.customFormsResponses = Interactions.CustomFormResponse.CustomFormResponseManagerFactory.create(userData, $o.customForms);
        if (userData.type == Core.UserTypes.Visitor) {
            $o.validations = new Interactions.Validation.ValidationManager(new Interactions.Validation.VisitorSideRealTimeConnector());
            $o.messageRatings = new Interactions.MessageRating.MessageRatingManager(new Interactions.MessageRating.VisitorSideRealTimeConnector());
            $o.delayAction = new Interactions.DelayAction.DelayManager(new Interactions.DelayAction.VisitorSideRealTimeConnector());
            $o.botErrors = new Interactions.Error.ErrorManager(new Interactions.Error.VisitorSideRealTimeConnector());
            $o.botProductSearch = new Interactions.ProductSearchFromBot.ProductSearchManager(new Interactions.ProductSearchFromBot.VisitorSideRealTimeConnector());
        }
    }
    Interactions.init = init;
    var BaseManager = (function () {
        function BaseManager() {
        }
        BaseManager.prototype.updateUI = function (data) { };
        BaseManager.prototype.create = function (data) { };
        BaseManager.prototype.remove = function () { };
        BaseManager.prototype.save = function (data) { };
        BaseManager.prototype.recover = function (data) { };
        BaseManager.prototype.search = function (data) { return null; };
        BaseManager.objectAdapter = function (obj, target) {
            var isObject = function (o) { return Object.prototype.toString.apply(o) === '[object Object]'; };
            var isArray = function (o) { return Object.prototype.toString.apply(o) === '[object Array]'; };
            var transformedObj = isArray(obj) ? [] : {};
            for (var key in obj) {
                if (obj.hasOwnProperty(key)) {
                    var transformedKey = void 0;
                    if (target === Interactions.Targets.Backend) {
                        transformedKey = key.replace(/^\w/, function (c, _) { return c.toUpperCase(); });
                    }
                    else {
                        transformedKey = key.replace(/^\w/, function (c, _) { return c.toLowerCase(); });
                    }
                    if (isObject(obj[key]) || isArray(obj[key])) {
                        transformedObj[transformedKey] = this.objectAdapter(obj[key], target);
                    }
                    else {
                        transformedObj[transformedKey] = obj[key];
                    }
                }
            }
            return transformedObj;
        };
        BaseManager.sleep = function (ms) {
            return __awaiter(this, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    return [2, new Promise(function (resolve) { return setTimeout(resolve, ms); })];
                });
            });
        };
        BaseManager.prototype.store = function (data) {
            return __awaiter(this, void 0, void 0, function () {
                var result;
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0: return [4, $o.saveRecord.goToSave(Interactions.BaseManager.objectAdapter(data, Interactions.Targets.Backend))];
                        case 1:
                            result = _a.sent();
                            return [2, result];
                    }
                });
            });
        };
        BaseManager.prototype.scrollBallHack = function (recoveredMessage) {
            if ($o.scroll.enableScroll) {
                setTimeout(function () {
                    $o.scroll.enableScroll();
                    $("#oct8ne-chat-room").mCustomScrollbar("scrollTo", "bottom", { callbacks: false });
                }, 100);
                if (!recoveredMessage) {
                    $o.scroll.moveChatToBottom();
                }
            }
        };
        return BaseManager;
    }());
    Interactions.BaseManager = BaseManager;
})(Interactions || (Interactions = {}));

var Interactions;
(function (Interactions) {
    var RealTimeConnector = (function () {
        function RealTimeConnector() {
            this.subscribeToRealTimeEvents();
        }
        RealTimeConnector.prototype.send = function (data) { };
        ;
        RealTimeConnector.prototype.subscribeToRealTimeEvents = function () { };
        ;
        return RealTimeConnector;
    }());
    Interactions.RealTimeConnector = RealTimeConnector;
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var Choice;
    (function (Choice) {
        var ChoiceManagerBase = (function (_super) {
            __extends(ChoiceManagerBase, _super);
            function ChoiceManagerBase() {
                var _this = _super.call(this) || this;
                _this.type = "Choice";
                _this.collection = [];
                return _this;
            }
            ChoiceManagerBase.prototype.create = function (choice) {
                var interactionChoice = this.addInteractionProperties(choice);
                this.send(interactionChoice);
                this.updateUI(interactionChoice);
                var fullData = this.addFullProperties(interactionChoice);
                this.save(fullData);
            };
            ChoiceManagerBase.prototype.send = function (choice) {
                this.realTime.send(choice);
            };
            ChoiceManagerBase.prototype.updateUI = function (data) {
                $o.chat.toogleDenyVisitorTyping(data.denyVisitorTyping);
                var fullData = this.addFullProperties(data);
                this.render(fullData, false);
            };
            ChoiceManagerBase.prototype.save = function (data) {
                var parsedData = this.parseDataForSaving(data);
                _super.prototype.store.call(this, parsedData);
            };
            ChoiceManagerBase.prototype.recover = function (data) {
                var formatted = Interactions.BaseManager.objectAdapter(data, Interactions.Targets.Frontend);
                var recovered = this.parseDataForRecovering(formatted);
                this.render(recovered, true);
            };
            ChoiceManagerBase.prototype.search = function (id) {
                var result = null;
                for (var _i = 0, _a = this.collection; _i < _a.length; _i++) {
                    var choice = _a[_i];
                    if (choice.id === id) {
                        result = choice;
                    }
                }
                return result;
            };
            ;
            ChoiceManagerBase.prototype.render = function (data, recoveredMessage) {
                data.body = $o.chat.checkEmotisInBody(data.body);
                data.body = $o.core.replaceDeprecatedCdnUrl(data.body);
                data.options = this.findEmojisInOptions(data.options);
                if ($o.utils && $o.utils.checkChoiceOptions) {
                    data = $o.utils.checkChoiceOptions(data);
                }
                this.collection.push(data);
                $o.speak.messages.push(data);
                $o.chat.toogleDenyVisitorTyping(data.denyVisitorTyping);
                _super.prototype.scrollBallHack.call(this, recoveredMessage);
            };
            ;
            ChoiceManagerBase.prototype.addFullProperties = function (data) {
                var newData = data;
                newData.time = Core.Helpers.getTime();
                newData.footer = ko.observable();
                newData.sentBy = Core.UserTypes.Agent;
                newData.category = Interactions.Categories.Choice;
                newData.response = ko.observable();
                newData.hideOptions = data.hideOptions === false ? false : true;
                return newData;
            };
            ChoiceManagerBase.prototype.parseDataForSaving = function (data) {
                var record = {
                    recoverType: 1,
                    sentBy: data.sentBy,
                    type: this.type,
                    fields: {
                        body: data.body,
                        id: data.id,
                        options: JSON.stringify(data.options),
                        type: data.type,
                        name: data.name,
                        time: data.time,
                        hideOptions: data.hideOptions,
                        denyVisitorTyping: data.denyVisitorTyping
                    }
                };
                var parsedData = [record];
                return parsedData;
            };
            ChoiceManagerBase.prototype.parseDataForRecovering = function (data) {
                var formatted = Interactions.BaseManager.objectAdapter(data, Interactions.Targets.Frontend);
                var recoveredChoice = {
                    category: Interactions.Categories.Choice,
                    id: formatted.fields.id,
                    name: formatted.fields.name,
                    body: formatted.fields.body,
                    type: formatted.fields.type,
                    options: Interactions.BaseManager.objectAdapter(JSON.parse(formatted.fields.options), Interactions.Targets.Frontend),
                    response: ko.observable(),
                    sentBy: formatted.sentBy,
                    time: formatted.fields.time,
                    hideOptions: formatted.fields.hideOptions,
                    denyVisitorTyping: formatted.fields.denyVisitorTyping,
                    footer: ko.observable()
                };
                return recoveredChoice;
            };
            ChoiceManagerBase.prototype.addInteractionProperties = function (data) {
                data.name = Core.Helpers.getMyName();
                data.id = Core.Helpers.generateId();
                return data;
            };
            ChoiceManagerBase.prototype.findEmojisInOptions = function (options) {
                return options.map(function (option) {
                    option.caption = $o.chat.checkEmotisInBody(option.caption);
                    option.body = $o.chat.checkEmotisInBody(option.body);
                    return option;
                });
            };
            return ChoiceManagerBase;
        }(Interactions.BaseManager));
        Choice.ChoiceManagerBase = ChoiceManagerBase;
    })(Choice = Interactions.Choice || (Interactions.Choice = {}));
})(Interactions || (Interactions = {}));

var Interactions;
(function (Interactions) {
    var Choice;
    (function (Choice) {
        ;
        var Types;
        (function (Types) {
            Types["ChoiceList"] = "ChoiceList";
            Types["ChoiceButtons"] = "ChoiceButtons";
            Types["Response"] = "RESPONSE";
        })(Types = Choice.Types || (Choice.Types = {}));
    })(Choice = Interactions.Choice || (Interactions.Choice = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var Interactions;
(function (Interactions) {
    var Choice;
    (function (Choice) {
        var VisitorSideRealTimeConnector = (function (_super) {
            __extends(VisitorSideRealTimeConnector, _super);
            function VisitorSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            VisitorSideRealTimeConnector.prototype.subscribeToRealTimeEvents = function () {
                var _this = this;
                $.connection.hubInterface.client.receiveChoice = function (choice, delay) { return __awaiter(_this, void 0, void 0, function () {
                    var interaction;
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                oct8ne.registerBotResponse();
                                if ($o.core.globalVariables.room.startsWith("TEMP")) {
                                    if (!choice.body) {
                                        choice = Interactions.BaseManager.objectAdapter(choice, Interactions.Targets.Backend);
                                    }
                                    interaction = {
                                        body: choice.Body ? choice.Body : choice.body,
                                        id: choice.Id ? choice.Id : choice.id,
                                        name: choice.Name ? choice.Name : choice.name,
                                        type: choice.Type ? choice.Type : choice.type,
                                        hideOptions: choice.HideOptions ? choice.HideOptions : choice.hideOptions,
                                        options: JSON.stringify(choice.Options ? choice.Options : choice.options),
                                        denyVisitorTyping: choice.DenyVisitorTyping ? choice.DenyVisitorTyping : choice.denyVisitorTyping,
                                        time: choice.Time ? choice.Time : choice.time
                                    };
                                    $o.saveRecord.choice(interaction);
                                }
                                if (delay) {
                                    $o.delay.setGlobal(1500);
                                }
                                ++$o.delay.chatQueue;
                                $o.chat.showTypingDelayFromBot();
                                return [4, Interactions.BaseManager.sleep($o.delay.global)];
                            case 1:
                                _a.sent();
                                --$o.delay.chatQueue;
                                if ($o.delay.chatQueue > 0) {
                                    setTimeout(function () { $o.chat.showTypingDelayFromBot(); }, 600);
                                }
                                else {
                                    $o.delay.reset();
                                }
                                $o.chat.hideTyping();
                                $o.chat.sendIsAttendedToAnalytics("CHOICE");
                                $o.chat.playVisitorSound();
                                $o.choices.updateUI(Interactions.BaseManager.objectAdapter(choice, Interactions.Targets.Frontend));
                                $o.delay.reset();
                                if ($o.variablesVisitor.status === "Attending") {
                                    $o.inactivity.attending.start();
                                }
                                return [2];
                        }
                    });
                }); };
            };
            return VisitorSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        Choice.VisitorSideRealTimeConnector = VisitorSideRealTimeConnector;
        var AgentSideRealTimeConnector = (function (_super) {
            __extends(AgentSideRealTimeConnector, _super);
            function AgentSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            AgentSideRealTimeConnector.prototype.send = function (choice) {
                window.parent.sendChoice(Interactions.BaseManager.objectAdapter(choice, Interactions.Targets.Backend), Core.Helpers.getTokenRoom());
            };
            return AgentSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        Choice.AgentSideRealTimeConnector = AgentSideRealTimeConnector;
    })(Choice = Interactions.Choice || (Interactions.Choice = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var Choice;
    (function (Choice) {
        var ChoiceVisitorSideManager = (function (_super) {
            __extends(ChoiceVisitorSideManager, _super);
            function ChoiceVisitorSideManager(hub) {
                var _this = _super.call(this) || this;
                _this.realTime = hub;
                return _this;
            }
            ChoiceVisitorSideManager.prototype.render = function (data) {
                this.disablePrevious();
                _super.prototype.render.call(this, data, false);
            };
            ;
            ChoiceVisitorSideManager.prototype.disableAllOnEnd = function () {
                for (var _i = 0, _a = $o.speak.messages(); _i < _a.length; _i++) {
                    var message = _a[_i];
                    if (message.category == "CHOICE") {
                        message.response("true");
                    }
                }
            };
            ChoiceVisitorSideManager.prototype.disablePrevious = function () {
                for (var _i = 0, _a = $o.speak.messages(); _i < _a.length; _i++) {
                    var message = _a[_i];
                    if (message.category == "CHOICE" && message.hideOptions) {
                        message.response("true");
                    }
                }
            };
            return ChoiceVisitorSideManager;
        }(Choice.ChoiceManagerBase));
        Choice.ChoiceVisitorSideManager = ChoiceVisitorSideManager;
    })(Choice = Interactions.Choice || (Interactions.Choice = {}));
})(Interactions || (Interactions = {}));

var Interactions;
(function (Interactions) {
    var Choice;
    (function (Choice) {
        var ChoiceManagerFactory = (function () {
            function ChoiceManagerFactory() {
            }
            ChoiceManagerFactory.create = function (userData) {
                if (userData.type === Core.UserTypes.Agent) {
                    var agentRealTimeHub = new Choice.AgentSideRealTimeConnector();
                    return new Choice.ChoiceAgentSideManager(agentRealTimeHub);
                }
                else {
                    var visitorRealTimeHub = new Choice.VisitorSideRealTimeConnector();
                    if (userData.device) {
                        return new Choice.ChoiceVisitorSideManager(visitorRealTimeHub);
                    }
                    else {
                        return new Choice.ChoiceVisitorSideManager(visitorRealTimeHub);
                    }
                }
            };
            return ChoiceManagerFactory;
        }());
        Choice.ChoiceManagerFactory = ChoiceManagerFactory;
    })(Choice = Interactions.Choice || (Interactions.Choice = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var ChoiceResponse;
    (function (ChoiceResponse) {
        var ChoiceResponseManagerBase = (function (_super) {
            __extends(ChoiceResponseManagerBase, _super);
            function ChoiceResponseManagerBase(choices) {
                var _this = _super.call(this) || this;
                _this.collection = [];
                _this.choices = choices;
                return _this;
            }
            ChoiceResponseManagerBase.prototype.recover = function (response) {
                var formatted = Interactions.BaseManager.objectAdapter(response, Interactions.Targets.Frontend);
                this.setChoiceAsResponsed(formatted.fields.choiceId, formatted.fields.id);
                var recovered = {
                    choiceId: formatted.fields.choiceId,
                    body: formatted.fields.body,
                    name: formatted.fields.name,
                    time: formatted.fields.time,
                    category: Interactions.Categories.ChoiceResponse,
                    id: formatted.fields.id,
                    sentBy: formatted.sentBy
                };
                this.render(recovered, true);
            };
            ;
            ChoiceResponseManagerBase.prototype.addFullProperties = function (data) {
                var newData = data;
                newData.time = Core.Helpers.getTime();
                newData.sentBy = Core.UserTypes.Visitor;
                newData.category = Interactions.Categories.ChoiceResponse;
                newData.id = data.id;
                return newData;
            };
            ;
            ChoiceResponseManagerBase.prototype.render = function (data, recoveredMessage) {
                data.body = $o.chat.checkEmotisInBody(data.body);
                this.collection.push(data);
                $o.speak.messages.push(data);
                if (!recoveredMessage) {
                    $o.scroll.moveChatToBottom();
                }
            };
            ;
            ChoiceResponseManagerBase.prototype.setChoiceAsResponsed = function (choiceId, responseId) {
                var choice = this.choices.search(choiceId);
                if (choice) {
                    choice.response(responseId);
                }
            };
            return ChoiceResponseManagerBase;
        }(Interactions.BaseManager));
        ChoiceResponse.ChoiceResponseManagerBase = ChoiceResponseManagerBase;
    })(ChoiceResponse = Interactions.ChoiceResponse || (Interactions.ChoiceResponse = {}));
})(Interactions || (Interactions = {}));

var Interactions;
(function (Interactions) {
    var ChoiceResponse;
    (function (ChoiceResponse) {
        ;
    })(ChoiceResponse = Interactions.ChoiceResponse || (Interactions.ChoiceResponse = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var Interactions;
(function (Interactions) {
    var ChoiceResponse;
    (function (ChoiceResponse) {
        var VisitorSideRealTimeConnector = (function (_super) {
            __extends(VisitorSideRealTimeConnector, _super);
            function VisitorSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            VisitorSideRealTimeConnector.prototype.postSend = function (responseInfo) {
                if ($o.bot && $o.bot.responseChecker) {
                    $o.bot.responseChecker.startWaiting();
                }
                if ($o.core.isSignalRConnected()) {
                    if ($o.variablesVisitor.status != "Attending") {
                        $.connection.hubInterface.server.sendStatus({ tokenVisitor: $o.core.globalVariables.myToken, tokenSession: $o.core.globalVariables.room, status: "Waiting" }).done(function () {
                            $o.chat.isTypingWhileBotRequest();
                            $.connection.hubInterface.server.sendChoiceResponse(Interactions.BaseManager.objectAdapter(responseInfo, Interactions.Targets.Backend), Core.Helpers.getTokenRoom());
                        });
                    }
                    else {
                        $.connection.hubInterface.server.sendChoiceResponse(Interactions.BaseManager.objectAdapter(responseInfo, Interactions.Targets.Backend), Core.Helpers.getTokenRoom());
                    }
                }
                else {
                    $o.visitorStart.restartConnection(null, true);
                    var checkConnection = setInterval(function () {
                        return __awaiter(this, void 0, void 0, function () {
                            var checkStartedBotOffline;
                            return __generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0:
                                        if (!$o.core.globalVariables.finishedVisitorRestartConnection) return [3, 3];
                                        clearInterval(checkConnection);
                                        if (!$o.bot) return [3, 2];
                                        return [4, $o.bot.connectOverflowAsync()];
                                    case 1:
                                        _a.sent();
                                        _a.label = 2;
                                    case 2:
                                        checkStartedBotOffline = setInterval(function () {
                                            return __awaiter(this, void 0, void 0, function () {
                                                return __generator(this, function (_a) {
                                                    if ($o.core.globalVariables.startedBotOffline) {
                                                        clearInterval(checkStartedBotOffline);
                                                        $.connection.hubInterface.server.sendStatus({
                                                            tokenVisitor: $o.core.globalVariables.myToken,
                                                            tokenSession: $o.core.globalVariables.room,
                                                            status: "Waiting"
                                                        }).done(function () {
                                                            sendChoiceResponseLog(1, responseInfo);
                                                            try {
                                                                if (!responseInfo || !responseInfo.id) {
                                                                    sendChoiceResponseLog(2, responseInfo);
                                                                }
                                                                $.connection.hubInterface.server.sendChoiceResponse(Interactions.BaseManager.objectAdapter(responseInfo, Interactions.Targets.Backend), Core.Helpers.getTokenRoom()).fail(function (err) {
                                                                    sendChoiceResponseLog(3, responseInfo);
                                                                });
                                                            }
                                                            catch (ex) {
                                                                sendChoiceResponseLog(4, responseInfo);
                                                            }
                                                        });
                                                    }
                                                    return [2];
                                                });
                                            });
                                        }, 100);
                                        _a.label = 3;
                                    case 3: return [2];
                                }
                            });
                        });
                    }, 100);
                }
                $o.inactivity.setVisitorActive();
            };
            ;
            VisitorSideRealTimeConnector.prototype.send = function (responseInfo) {
                if ($o.core.globalVariables.room && $o.core.globalVariables.room.startsWith("TEMP")) {
                    $.post("Oct8ne/InitSessionWithBot", {
                        tempRoom: $o.core.globalVariables.room,
                        visitorData: JSON.stringify($o.core.globalVariables.visitorData)
                    }, function (result) {
                        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [
                            { cookie: $o.cookies.tokenSession, value: result.Room },
                            { cookie: $o.cookies.sessionSummaryId, value: result.SessionSummaryId },
                        ]);
                        $o.core.globalVariables.roomForLastOperations = result.Room;
                        $o.saveRecord.saveListInteractions().then(function (result) {
                            VisitorSideRealTimeConnector.prototype.postSend(responseInfo);
                        });
                    });
                }
                else {
                    VisitorSideRealTimeConnector.prototype.postSend(responseInfo);
                }
            };
            ;
            return VisitorSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        ChoiceResponse.VisitorSideRealTimeConnector = VisitorSideRealTimeConnector;
        var AgentSideRealTimeConnector = (function (_super) {
            __extends(AgentSideRealTimeConnector, _super);
            function AgentSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            AgentSideRealTimeConnector.prototype.subscribeToRealTimeEvents = function () {
                window['getChoiceResponseFromDashboard'] = function (parameters) {
                    var response = Interactions.BaseManager.objectAdapter(parameters, Interactions.Targets.Frontend);
                    $o.choiceResponses.receive(response);
                };
            };
            return AgentSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        ChoiceResponse.AgentSideRealTimeConnector = AgentSideRealTimeConnector;
    })(ChoiceResponse = Interactions.ChoiceResponse || (Interactions.ChoiceResponse = {}));
})(Interactions || (Interactions = {}));
var sendChoiceResponseLog = function (step, responseInfo) {
};

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var Interactions;
(function (Interactions) {
    var ChoiceResponse;
    (function (ChoiceResponse) {
        var VisitorSideManager = (function (_super) {
            __extends(VisitorSideManager, _super);
            function VisitorSideManager(hub, choices) {
                var _this = _super.call(this, choices) || this;
                _this.realTime = hub;
                return _this;
            }
            VisitorSideManager.prototype.save = function (data) {
                return __awaiter(this, void 0, void 0, function () {
                    var parsedData, result;
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                parsedData = this.parseDataForSaving(data);
                                return [4, _super.prototype.store.call(this, parsedData)];
                            case 1:
                                result = _a.sent();
                                return [2, result];
                        }
                    });
                });
            };
            VisitorSideManager.prototype.clickResponseButton = function (choiceId, responseId) {
                var choice = this.choices.search(choiceId);
                if ($.connection.hub.state === $.signalR.connectionState.connected || $o.core.globalVariables.visitorsOverflow) {
                    if (choice) {
                        choice.response(responseId);
                        this.sendResponse(choice.id);
                    }
                }
            };
            VisitorSideManager.prototype.clickResponseList = function (choiceId) {
                this.sendResponse(choiceId);
            };
            VisitorSideManager.prototype.sendResponse = function (choiceId) {
                return __awaiter(this, void 0, void 0, function () {
                    var info, responseInfo, fullResponse, result;
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                info = this.getResponseInfo(choiceId);
                                responseInfo = {
                                    choiceId: choiceId,
                                    body: this.removeEmojisClassesInResponse(info.caption),
                                    name: Core.Helpers.getMyName(),
                                    id: info.id
                                };
                                if (!responseInfo.choiceId) return [3, 2];
                                fullResponse = this.addFullProperties(responseInfo);
                                this.render(fullResponse, false);
                                return [4, this.save(fullResponse)];
                            case 1:
                                result = _a.sent();
                                responseInfo.body = this.removeEmojisClassesInResponse(info.body),
                                    this.realTime.send(responseInfo);
                                _a.label = 2;
                            case 2: return [2];
                        }
                    });
                });
            };
            ;
            VisitorSideManager.prototype.getResponseInfo = function (id) {
                var searchOption = this.choices.search(id);
                if (searchOption) {
                    for (var _i = 0, _a = searchOption.options; _i < _a.length; _i++) {
                        var option = _a[_i];
                        if (option.id === searchOption.response()) {
                            return option;
                        }
                    }
                }
                return null;
            };
            ;
            VisitorSideManager.prototype.removeEmojisClassesInResponse = function (responseCaption) {
                if (responseCaption.indexOf("oct8ne-emoji-in-chat") > -1) {
                    $("body").append("<div id='appended-emoji-span' style='display:none'></div>");
                    $("#appended-emoji-span").html(responseCaption);
                    $("#appended-emoji-span .oct8ne-emoji-in-chat").contents().unwrap();
                    var html = $("#appended-emoji-span").html();
                    $("#appended-emoji-span").remove();
                    return html;
                }
                else {
                    return responseCaption;
                }
            };
            ;
            VisitorSideManager.prototype.parseDataForSaving = function (data) {
                var record = {
                    recoverType: 1,
                    sentBy: Core.UserTypes.Visitor,
                    type: "ChoiceResponse",
                    fields: {
                        body: this.removeEmojisClassesInResponse(data.body),
                        choiceId: data.choiceId,
                        id: data.id,
                        name: data.name,
                        time: data.time
                    }
                };
                return [record];
            };
            return VisitorSideManager;
        }(ChoiceResponse.ChoiceResponseManagerBase));
        ChoiceResponse.VisitorSideManager = VisitorSideManager;
    })(ChoiceResponse = Interactions.ChoiceResponse || (Interactions.ChoiceResponse = {}));
})(Interactions || (Interactions = {}));

var Interactions;
(function (Interactions) {
    var ChoiceResponse;
    (function (ChoiceResponse) {
        var ChoiceResponseManagerFactory = (function () {
            function ChoiceResponseManagerFactory() {
            }
            ChoiceResponseManagerFactory.create = function (userData, choices) {
                if (userData.type === Core.UserTypes.Agent) {
                    var agentHub = new ChoiceResponse.AgentSideRealTimeConnector();
                    return new ChoiceResponse.AgentSideManager(agentHub, choices);
                }
                else {
                    var visitorHub = new ChoiceResponse.VisitorSideRealTimeConnector();
                    if (userData.device) {
                        return new ChoiceResponse.VisitorSideManager(visitorHub, choices);
                    }
                    else {
                        return new ChoiceResponse.VisitorSideManager(visitorHub, choices);
                    }
                }
            };
            return ChoiceResponseManagerFactory;
        }());
        ChoiceResponse.ChoiceResponseManagerFactory = ChoiceResponseManagerFactory;
    })(ChoiceResponse = Interactions.ChoiceResponse || (Interactions.ChoiceResponse = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var Zoom;
    (function (Zoom) {
        var ZoomManagerBase = (function (_super) {
            __extends(ZoomManagerBase, _super);
            function ZoomManagerBase() {
                var _this = _super.call(this) || this;
                _this.level = 1;
                _this.type = "Zoom";
                _this.init();
                return _this;
            }
            ZoomManagerBase.prototype.create = function () {
                if (!$o.search.sendingProductToCanva) {
                    var data = this.createData();
                    var fullData = this.addFullProperties(data);
                    this.updateUI();
                    this.send(fullData);
                    this.save(fullData);
                }
            };
            ;
            ZoomManagerBase.prototype.updateUI = function () {
                var _this = this;
                $("#localCanvas,#remoteCanvas").hide(0);
                if (Core.Helpers.getCurrentInternalId().length) {
                    var classToAdd = "in", classToRemove = "out";
                    if (this.level === 2) {
                        classToAdd = "out";
                        classToRemove = "in";
                    }
                    this.object.removeClass("icon-common-zoom".concat(classToRemove, "-button")).addClass("icon-common-zoom".concat(classToAdd, "-button"));
                    $("#oct8ne-helper").find(".pin-shape, .note").hide();
                    if (this.level === 4) {
                        this.level = 1;
                        $o.canva.target.width = $o.canva.target.width / 4;
                        $o.canva.target.height = $o.canva.target.height / 4;
                    }
                    else {
                        this.level = this.level * 2;
                        $o.canva.target.width = $o.canva.target.width * 2;
                        $o.canva.target.height = $o.canva.target.height * 2;
                    }
                    ;
                    var img = $("#oct8ne-helper, #oct8ne-helper img");
                    $("#localCanvas,#remoteCanvas").hide(0);
                    var top_1 = ($o.canva.holder.height - $o.canva.target.height) / 2;
                    var left = this.getLeftPositionByDevice();
                    img.animate({
                        top: top_1,
                        left: left,
                        width: $o.canva.target.width, height: $o.canva.target.height
                    }, 400, function () {
                        _this.updatePins();
                        $o.pencil.drawing.updateCanvasDimensions();
                        $("#localCanvas,#remoteCanvas").show(0);
                    });
                }
            };
            ZoomManagerBase.prototype.save = function (data) {
                var parsedData = this.parseDataForSaving(data);
                _super.prototype.store.call(this, parsedData);
            };
            ZoomManagerBase.prototype.recover = function (data) {
            };
            ZoomManagerBase.prototype.send = function (data) {
                if ($o.core.isSignalRConnected()) {
                    this.realTime.send(data);
                }
            };
            ZoomManagerBase.prototype.init = function () {
                var _this = this;
                this.object = $("#zoom-tool");
                this.object.on("click", function () {
                    _this.create();
                });
            };
            ZoomManagerBase.prototype.getLeftPositionByDevice = function () {
                if (Core.Helpers.isDevice()) {
                    var leftPos = ($("#center-helper-wrapper").width() - $o.canva.target.width) / 2;
                    if (leftPos > 0)
                        leftPos = 0;
                    return leftPos;
                }
                else {
                    return ($o.canva.holder.width - $o.canva.target.width) / 2;
                }
            };
            ZoomManagerBase.prototype.addFullProperties = function (data) {
                var newData = data;
                newData.productInternalID = Core.Helpers.getCurrentInternalId();
                newData.imageUrl = Core.Helpers.getCurrentImageUrl();
                newData.level = this.level;
                return newData;
            };
            ZoomManagerBase.prototype.parseDataForSaving = function (data) {
                var record = {
                    recoverType: 1,
                    sentBy: data.sentBy,
                    type: this.type,
                    fields: {
                        level: data.level,
                        imageUrl: data.imageUrl
                    }
                };
                var parsedData = [record];
                return parsedData;
            };
            ZoomManagerBase.prototype.createData = function () {
                var data = {
                    room: Core.Helpers.getTokenRoom(),
                    sentBy: Core.Helpers.getUserType()
                };
                return data;
            };
            ZoomManagerBase.prototype.updatePins = function () {
                var _this = this;
                $("#oct8ne-helper").find(".pin-shape").each(function () {
                    var newPos = {
                        left: parseInt($(_this).attr("data-x")) * $o.canva.target.object.width(),
                        top: parseInt($(_this).attr("data-y")) * $o.canva.target.object.height()
                    };
                    $(_this).css(newPos).show();
                });
            };
            return ZoomManagerBase;
        }(Interactions.BaseManager));
        Zoom.ZoomManagerBase = ZoomManagerBase;
    })(Zoom = Interactions.Zoom || (Interactions.Zoom = {}));
})(Interactions || (Interactions = {}));

var Interactions;
(function (Interactions) {
    var Zoom;
    (function (Zoom) {
        ;
        var Types;
        (function (Types) {
        })(Types = Zoom.Types || (Zoom.Types = {}));
    })(Zoom = Interactions.Zoom || (Interactions.Zoom = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var Zoom;
    (function (Zoom) {
        var VisitorSideRealTimeConnector = (function (_super) {
            __extends(VisitorSideRealTimeConnector, _super);
            function VisitorSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            VisitorSideRealTimeConnector.prototype.subscribeToRealTimeEvents = function () {
                $.connection.hubInterface.client.changeZoom = function () {
                    $o.zoom.updateUI();
                };
            };
            VisitorSideRealTimeConnector.prototype.send = function (zoom) {
                if ($o.core.isSignalRConnected()) {
                    $.connection.hubInterface.server.sendZoom(Interactions.BaseManager.objectAdapter(zoom, Interactions.Targets.Backend));
                }
            };
            return VisitorSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        Zoom.VisitorSideRealTimeConnector = VisitorSideRealTimeConnector;
        var AgentSideRealTimeConnector = (function (_super) {
            __extends(AgentSideRealTimeConnector, _super);
            function AgentSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            AgentSideRealTimeConnector.prototype.subscribeToRealTimeEvents = function () {
                window['getChangeZoomFromDashboard'] = function () {
                    $o.zoom.updateUI();
                };
            };
            AgentSideRealTimeConnector.prototype.send = function (choice) {
                window.parent.sendZoomFromDashboard(Interactions.BaseManager.objectAdapter(choice, Interactions.Targets.Backend));
            };
            return AgentSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        Zoom.AgentSideRealTimeConnector = AgentSideRealTimeConnector;
    })(Zoom = Interactions.Zoom || (Interactions.Zoom = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var Zoom;
    (function (Zoom) {
        var ZoomVisitorSideManager = (function (_super) {
            __extends(ZoomVisitorSideManager, _super);
            function ZoomVisitorSideManager(hub) {
                var _this = _super.call(this) || this;
                _this.realTime = hub;
                return _this;
            }
            return ZoomVisitorSideManager;
        }(Zoom.ZoomManagerBase));
        Zoom.ZoomVisitorSideManager = ZoomVisitorSideManager;
    })(Zoom = Interactions.Zoom || (Interactions.Zoom = {}));
})(Interactions || (Interactions = {}));

var Interactions;
(function (Interactions) {
    var Zoom;
    (function (Zoom) {
        var ZoomManagerFactory = (function () {
            function ZoomManagerFactory() {
            }
            ZoomManagerFactory.create = function (userData) {
                if (userData.type === Core.UserTypes.Agent) {
                    var agentRealTimeHub = new Zoom.AgentSideRealTimeConnector();
                    return new Zoom.ZoomAgentSideManager(agentRealTimeHub);
                }
                else {
                    var visitorRealTimeHub = new Zoom.VisitorSideRealTimeConnector();
                    if (userData.device) {
                        return new Zoom.ZoomVisitorSideManager(visitorRealTimeHub);
                    }
                    else {
                        return new Zoom.ZoomVisitorSideManager(visitorRealTimeHub);
                    }
                }
            };
            return ZoomManagerFactory;
        }());
        Zoom.ZoomManagerFactory = ZoomManagerFactory;
    })(Zoom = Interactions.Zoom || (Interactions.Zoom = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var SideBubble;
    (function (SideBubble) {
        var SideBubbleManagerBase = (function (_super) {
            __extends(SideBubbleManagerBase, _super);
            function SideBubbleManagerBase(wrapperId) {
                var _this = _super.call(this) || this;
                _this.type = "SideBubble";
                _this.typeView = "SideBubbleView";
                _this.sideBubbleSelector = $("#" + wrapperId);
                _this.collection = [];
                _this.currentBody = ko.observable(null);
                return _this;
            }
            SideBubbleManagerBase.prototype.updateUI = function (data) {
                var fullData = this.addFullProperties(data);
                this.render(fullData, false);
            };
            SideBubbleManagerBase.prototype.save = function (data) {
                var parsedData = this.parseDataForSaving(data);
                _super.prototype.store.call(this, parsedData);
            };
            SideBubbleManagerBase.prototype.recover = function (data) {
                var recovered = this.parseDataForRecovering(data);
                this.render(recovered, true);
            };
            SideBubbleManagerBase.prototype.send = function (bubble) {
                this.realTime.send(bubble);
            };
            SideBubbleManagerBase.prototype.show = function (id) {
                var currentBubble = ko.utils.arrayFirst($o.speak.messages(), function (current) {
                    return current.id == id;
                });
                this.currentBody(currentBubble.body);
                this.prepareUI();
                this.saveView(currentBubble);
            };
            SideBubbleManagerBase.prototype.hide = function () {
                this.prepareUIClose();
            };
            SideBubbleManagerBase.prototype.addInteractionProperties = function (data) {
                data.name = Core.Helpers.getMyName();
                data.id = Core.Helpers.generateId();
                return data;
            };
            SideBubbleManagerBase.prototype.saveView = function (data) {
                var record = {
                    recoverType: 4,
                    sentBy: data.sentBy,
                    type: this.typeView,
                    fields: {
                        id: data.id
                    }
                };
                var parsedData = [record];
                _super.prototype.store.call(this, parsedData);
            };
            SideBubbleManagerBase.prototype.render = function (data, recoveredMessage) {
                data.title = $o.chat.checkEmotisInBody(data.title);
                data.title = $o.core.replaceDeprecatedCdnUrl(data.title);
                data.body = $o.chat.checkEmotisInBody(data.body);
                data.body = $o.core.replaceDeprecatedCdnUrl(data.body);
                data.link = $o.chat.checkEmotisInBody(data.link);
                data.link = $o.core.replaceDeprecatedCdnUrl(data.link);
                $o.speak.messages.push(data);
                setTimeout(function () {
                    $o.scroll.enableScroll();
                    $("#oct8ne-chat-room").mCustomScrollbar("scrollTo", "bottom", { callbacks: false });
                }, 100);
                if (!recoveredMessage) {
                    $o.scroll.moveChatToBottom();
                }
            };
            ;
            SideBubbleManagerBase.prototype.addFullProperties = function (data) {
                var newData = data;
                newData.category = SideBubble.Types.SideBubbleLink;
                newData.time = Core.Helpers.getTime();
                newData.sentBy = Core.UserTypes.Agent;
                newData.type = this.type;
                return newData;
            };
            SideBubbleManagerBase.prototype.prepareUI = function () { };
            ;
            SideBubbleManagerBase.prototype.prepareUIClose = function () {
                this.currentBody(null);
            };
            ;
            SideBubbleManagerBase.prototype.parseDataForSaving = function (data) {
                var record = {
                    recoverType: 1,
                    sentBy: data.sentBy,
                    type: data.type,
                    fields: {
                        body: data.body,
                        id: data.id,
                        link: data.link,
                        name: data.name,
                        time: data.time,
                        title: data.title,
                        type: data.type
                    }
                };
                var parsedData = [record];
                return parsedData;
            };
            SideBubbleManagerBase.prototype.parseDataForRecovering = function (data) {
                var formatted = Interactions.BaseManager.objectAdapter(data, Interactions.Targets.Frontend);
                var recoveredSideBubble = {
                    body: formatted.fields.body,
                    id: formatted.fields.id,
                    name: formatted.fields.name,
                    sentBy: formatted.sentBy,
                    time: formatted.fields.time,
                    title: formatted.fields.title,
                    type: formatted.fields.type,
                    link: formatted.fields.link,
                    category: SideBubble.Types.SideBubbleLink
                };
                return recoveredSideBubble;
            };
            return SideBubbleManagerBase;
        }(Interactions.BaseManager));
        SideBubble.SideBubbleManagerBase = SideBubbleManagerBase;
    })(SideBubble = Interactions.SideBubble || (Interactions.SideBubble = {}));
})(Interactions || (Interactions = {}));

var Interactions;
(function (Interactions) {
    var SideBubble;
    (function (SideBubble) {
        ;
        ;
        var Types;
        (function (Types) {
            Types["SideBubbleLink"] = "SIDEBUBBLELINK";
        })(Types = SideBubble.Types || (SideBubble.Types = {}));
        SideBubble.sample = {
            body: "<p><img alt=\"\" src=\"https://static-or00.inbenta.com/aa9f50bf1ce7e3bc4e1fe68bcc4f140401de9a6791d9d46a1797b095db587334/Imagen%20aviso%20MKP%20.jpg\" style=\"box-sizing: border-box; border: 0px; vertical-align: middle; max-width: 100%; float: left; height: 24px; width: 25px;\">&nbsp;&nbsp;<span style=\"box-sizing: border-box; color: rgb(105, 105, 105);\"><strong style=\"box-sizing: border-box;\">Recuerda que</strong>:</span></p>\n\n<ul style=\"box-sizing: border-box; margin: 15px 0px; font-family: Roboto, Helvetica, arial, sans-serif; font-size: 14px; text-align: justify;\">\n\t<li style=\"box-sizing: border-box;\">Recibir\u00E1s tu pedido&nbsp;antes, si la&nbsp;<strong style=\"box-sizing: border-box;\">direcci\u00F3n de env\u00EDo es la misma que la de&nbsp;</strong><strong style=\"box-sizing: border-box;\">facturaci\u00F3n</strong>. En&nbsp;<strong style=\"box-sizing: border-box;\"><a href=\"https://ayuda.fnac.es/mi-cuenta/actualizar-mis-datos-y-direcciones/\" style=\"box-sizing: border-box; color: rgb(233, 172, 0); text-decoration-line: none; background: transparent; outline: none 0px;\" target=\"_blank\">Actualizar mis datos y direcciones</a></strong>, consulta o modifica tus direcciones para pr\u00F3ximos pedidos.</li>\n\t<li style=\"box-sizing: border-box;\">Todas las compras realizadas por&nbsp;personas residentes en los pa\u00EDses pertenecientes a la Uni\u00F3n Europea estar\u00E1n sujetas al IVA.&nbsp;</li>\n\t<li style=\"box-sizing: border-box;\">En los pedidos enviados a pa\u00EDses no pertenecientes a la Comunidad Econ\u00F3mica Europea, los&nbsp;derechos de aduana y aranceles est\u00E1n incluidos en los gastos de env\u00EDo.</li>\n\t<li style=\"box-sizing: border-box;\">Los vendedores externos, en&nbsp;<strong style=\"box-sizing: border-box;\">Fnac Marketplace,&nbsp;</strong>no realizan env\u00EDos fuera de Espa\u00F1a. Consulta c\u00F3mo contactar con el vendedor&nbsp;desde&nbsp;la p\u00E1gina de ayuda&nbsp;<strong style=\"box-sizing: border-box;\"><a href=\"https://ayuda.fnac.es/fnac-marketplace/contacta-con-el-vendedor/\" style=\"box-sizing: border-box; color: rgb(233, 172, 0); text-decoration-line: none; background: transparent; outline: none 0px;\" target=\"_blank\">Contacta con el&nbsp;Vendedor</a></strong>.</li>\n</ul>",
            title: "Recibirs tu pedido antes si la direccin de envo es la misma que la de facturacin",
            link: "Ms info"
        };
        SideBubble.sample2 = {
            body: "<h2>\n\t<u><strong>Plazos de expedici\u00F3n:</strong></u>\n</h2>\n\n<ul>\n\t<li>\n\t\t<strong><u>EN ALMAC\u00C9N FNAC:</u></strong>\n\n\t\t<ul>\n\t\t\t<li>\n\t\t\t\t<strong><span style=\"box-sizing: border-box; font-weight: bolder; font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">En stock Fnac.es.</span></strong><span style=\"font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">&nbsp;El art\u00EDculo se encuentra en nuestro stock y nuestro compromiso de salida desde nuestro almac\u00E9n es de 24 horas.</span>\n\t\t\t</li>\n\t\t\t<li>\n\t\t\t\t<strong><span style=\"box-sizing: border-box; font-weight: bolder; font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">En stock, expedici\u00F3n en 48 horas.</span></strong><span style=\"font-family: Arial, Helvetica, sans-serif; font-size: 12px;\"><strong>&nbsp;</strong>El art\u00EDculo se encuentra en nuestro stock y nuestro compromiso de salida desde nuestro almac\u00E9n es de 48 horas.</span>\n\t\t\t</li>\n\t\t\t<li>\n\t\t\t\t<strong><span style=\"box-sizing: border-box; font-weight: bolder; font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">En stock, expedici\u00F3n en 72 horas.</span></strong><span style=\"font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">&nbsp;El art\u00EDculo se encuentra en nuestro stock y nuestro compromiso de salida desde nuestro almac\u00E9n es de 72 horas.</span>\n\t\t\t</li>\n\t\t</ul>\n\t</li>\n\t<li>\n\t\t<span style=\"font-family: Arial, Helvetica, sans-serif; font-size: 12px;\"><u><strong>&#8203;PR\u00D3XIMOS LANZAMIENTOS</strong></u>:</span>\n\t\t<ul>\n\t\t\t<li>\n\t\t\t\t<span style=\"font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">&#8203;<strong><span style=\"box-sizing: border-box; font-weight: bolder; font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">Art\u00EDculo en preventa</span></strong><span style=\"font-family: Arial, Helvetica, sans-serif; font-size: 12px;\"><strong>, expedici\u00F3n prevista para el\u2026</strong> No disponemos del art\u00EDculo en stock con anterioridad al lanzamiento. El proveedor nos comunica suministro de stock con anterioridad al lanzamiento. La expedici\u00F3n se realiza el d\u00EDa del lanzamiento. Generalmente son productos que puedes reservar en Fnac.es y no en las tiendas f\u00EDsicas.</span></span>\n\t\t\t</li>\n\t\t\t<li>\n\t\t\t\t<strong><span style=\"box-sizing: border-box; font-weight: bolder; font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">Novedad</span></strong><span style=\"font-family: Arial, Helvetica, sans-serif; font-size: 12px;\"><strong>&nbsp;por llegar, no disponible por el momento</strong>. Se trata de una novedad que todav\u00EDa no est\u00E1 en nuestro stock, ni disponemos de su fecha de lanzamiento.</span>\n\t\t\t</li>\n\t\t</ul>\n\t</li>\n\t<li>\n\t\t<u><strong><font face=\"Arial, Helvetica, sans-serif\"><span style=\"font-size: 12px;\">BAJO PEDIDO:</span></font></strong></u>\n\t\t<ul>\n\t\t\t<li>\n\t\t\t\t<strong><span style=\"box-sizing: border-box; font-weight: bolder; font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">Expedici\u00F3n de 5 a 8 d\u00EDas.</span></strong><span style=\"font-family: Arial, Helvetica, sans-serif; font-size: 12px;\"><strong>&nbsp;</strong>No disponemos de stock y se pide a proveedor. Nuestro compromiso de expedici\u00F3n es de 5 a 8 d\u00EDas, siempre que el proveedor lo pueda servir.</span>\n\t\t\t</li>\n\t\t\t<li>\n\t\t\t\t<strong><span style=\"box-sizing: border-box; font-weight: bolder; font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">Bajo pedido, expedici\u00F3n aproximada de 8 a 10 d\u00EDas.</span></strong><span style=\"font-family: Arial, Helvetica, sans-serif; font-size: 12px;\"><strong>&nbsp;</strong>No disponemos de stock y se pide a proveedor. Indicamos expedici\u00F3n aproximada de 8 a 10 d\u00EDas, siempre que el proveedor lo pueda servir en ese plazo.</span>\n\t\t\t</li>\n\t\t\t<li>\n\t\t\t\t<strong><span style=\"box-sizing: border-box; font-weight: bolder; font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">Bajo pedido, expedici\u00F3n aproximada de 10 a 15 d\u00EDas.</span></strong><span style=\"font-family: Arial, Helvetica, sans-serif; font-size: 12px;\"><strong>&nbsp;</strong>No disponemos de stock y se pide a proveedor. Indicamos expedici\u00F3n aproximada de 10 a 15 d\u00EDas, siempre que el proveedor lo pueda servir en ese plazo.</span>\n\t\t\t</li>\n\t\t\t<li>\n\t\t\t\t<strong><span style=\"box-sizing: border-box; font-weight: bolder; font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">Expedici\u00F3n en m\u00E1s de 30 d\u00EDas</span></strong><span style=\"font-family: Arial, Helvetica, sans-serif; font-size: 12px;\"><strong>&nbsp;</strong>No disponemos de stock y se pide a proveedor. No existe un compromiso de fecha de expedici\u00F3n, solo sabemos que ser\u00E1 en m\u00E1s de 30 d\u00EDas, siempre que el proveedor lo pueda servir.</span>\n\t\t\t</li>\n\t\t\t<li>\n\t\t\t\t<strong><span style=\"box-sizing: border-box; font-weight: bolder; font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">Bajo pedido</span></strong><span style=\"font-family: Arial, Helvetica, sans-serif; font-size: 12px;\"><strong>&nbsp;</strong>No disponemos de stock y se pide al proveedor. No existe compromiso de fecha de expedici\u00F3n, ni de entrega por parte del proveedor.</span>\n\t\t\t</li>\n\t\t</ul>\n\t</li>\n\t<li>\n\t\t<span style=\"font-family: Arial, Helvetica, sans-serif; font-size: 12px;\"><u><strong>&#8203;&#8203;SIN STOCK</strong></u>:</span>\n\t\t<ul>\n\t\t\t<li>\n\t\t\t\t<strong><span style=\"box-sizing: border-box; font-weight: bolder; font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">No disponible</span></strong><span style=\"font-family: Arial, Helvetica, sans-serif; font-size: 12px;\">&nbsp;El art\u00EDculo en cuesti\u00F3n no est\u00E1 disponible para su compra. Generalmente lo puedes encontrar vendido por vendedores de nuestra MarketPlace.</span>\n\t\t\t</li>\n\t\t</ul>\n\t</li>\n</ul>",
            title: "Plazos de expedicin",
            link: "Ver ms informacin sobre el tema"
        };
    })(SideBubble = Interactions.SideBubble || (Interactions.SideBubble = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var Interactions;
(function (Interactions) {
    var SideBubble;
    (function (SideBubble) {
        var VisitorSideRealTimeConnector = (function (_super) {
            __extends(VisitorSideRealTimeConnector, _super);
            function VisitorSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            VisitorSideRealTimeConnector.prototype.subscribeToRealTimeEvents = function () {
                var _this = this;
                $.connection.hubInterface.client.receiveSideBubble = function (sideBubble) { return __awaiter(_this, void 0, void 0, function () {
                    var interaction;
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                oct8ne.registerBotResponse();
                                if ($o.core.globalVariables.room.startsWith("TEMP")) {
                                    if (!sideBubble.Body) {
                                        sideBubble = Interactions.BaseManager.objectAdapter(sideBubble, Interactions.Targets.Backend);
                                    }
                                    interaction = {
                                        id: sideBubble.Id ? sideBubble.Id : sideBubble.id,
                                        body: sideBubble.Body ? sideBubble.Body : sideBubble.body,
                                        link: sideBubble.Link ? sideBubble.Link : sideBubble.link,
                                        name: sideBubble.Name ? sideBubble.Name : sideBubble.name,
                                        title: sideBubble.Title ? sideBubble.Title : sideBubble.title,
                                        time: sideBubble.Time ? sideBubble.Time : sideBubble.time,
                                        type: sideBubble.Type ? sideBubble.Type : sideBubble.type,
                                    };
                                    $o.saveRecord.sideBubble(interaction);
                                }
                                $o.delay.setGlobal(1500);
                                ++$o.delay.chatQueue;
                                $o.chat.showTypingDelayFromBot();
                                return [4, Interactions.BaseManager.sleep($o.delay.global)];
                            case 1:
                                _a.sent();
                                --$o.delay.chatQueue;
                                if ($o.delay.chatQueue > 0) {
                                    setTimeout(function () { $o.chat.showTypingDelayFromBot(); }, 600);
                                }
                                else {
                                    $o.delay.reset();
                                }
                                $o.chat.hideTyping();
                                $o.chat.playVisitorSound();
                                $o.sideBubbles.updateUI(Interactions.BaseManager.objectAdapter(sideBubble, Interactions.Targets.Frontend));
                                return [2];
                        }
                    });
                }); };
            };
            return VisitorSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        SideBubble.VisitorSideRealTimeConnector = VisitorSideRealTimeConnector;
        var AgentSideRealTimeConnector = (function (_super) {
            __extends(AgentSideRealTimeConnector, _super);
            function AgentSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            AgentSideRealTimeConnector.prototype.send = function (sideBubble) {
                window.parent.sendSideBubble(Interactions.BaseManager.objectAdapter(sideBubble, Interactions.Targets.Backend), Core.Helpers.getTokenRoom());
            };
            return AgentSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        SideBubble.AgentSideRealTimeConnector = AgentSideRealTimeConnector;
    })(SideBubble = Interactions.SideBubble || (Interactions.SideBubble = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var SideBubble;
    (function (SideBubble) {
        var SideBubbleVisitorSideManagerDesktop = (function (_super) {
            __extends(SideBubbleVisitorSideManagerDesktop, _super);
            function SideBubbleVisitorSideManagerDesktop(hub, wrapperId) {
                var _this = _super.call(this, wrapperId) || this;
                _this.previousStatusIsChat = false;
                _this.realTime = hub;
                return _this;
            }
            SideBubbleVisitorSideManagerDesktop.prototype.prepareUI = function () {
                $("#tutorial-coviewer").hide(0);
                $o.storage.local.set($o.core.localStorageTypes.HIDENEWTUTORIAL, true);
                if ($o.iframes.currentIframeStatus !== $o.iframes.iframeStatus.VIEWER && $o.iframes.currentIframeStatus !== $o.iframes.iframeStatus.SEARCH) {
                    this.previousStatusIsChat = true;
                    $o.iframes.changeStatusIframe($o.iframes.iframeStatus.VIEWER);
                }
            };
            SideBubbleVisitorSideManagerDesktop.prototype.prepareUIClose = function () {
                if (this.previousStatusIsChat) {
                    this.previousStatusIsChat = false;
                    $o.iframes.changeStatusIframe($o.iframes.iframeStatus.CHAT);
                }
                _super.prototype.prepareUIClose.call(this);
            };
            return SideBubbleVisitorSideManagerDesktop;
        }(SideBubble.SideBubbleManagerBase));
        SideBubble.SideBubbleVisitorSideManagerDesktop = SideBubbleVisitorSideManagerDesktop;
    })(SideBubble = Interactions.SideBubble || (Interactions.SideBubble = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var SideBubble;
    (function (SideBubble) {
        var SideBubbleVisitorSideManagerMobile = (function (_super) {
            __extends(SideBubbleVisitorSideManagerMobile, _super);
            function SideBubbleVisitorSideManagerMobile(hub, wrapperId) {
                var _this = _super.call(this, wrapperId) || this;
                _this.realTime = hub;
                return _this;
            }
            return SideBubbleVisitorSideManagerMobile;
        }(SideBubble.SideBubbleManagerBase));
        SideBubble.SideBubbleVisitorSideManagerMobile = SideBubbleVisitorSideManagerMobile;
    })(SideBubble = Interactions.SideBubble || (Interactions.SideBubble = {}));
})(Interactions || (Interactions = {}));

var Interactions;
(function (Interactions) {
    var SideBubble;
    (function (SideBubble) {
        var SideBubbleManagerFactory = (function () {
            function SideBubbleManagerFactory() {
            }
            SideBubbleManagerFactory.create = function (userData, id) {
                if (userData.type === Core.UserTypes.Agent) {
                    var agentRealTimeHub = new SideBubble.AgentSideRealTimeConnector();
                    return new SideBubble.SideBubbleAgentSideManager(agentRealTimeHub, id);
                }
                else {
                    var visitorRealTimeHub = new SideBubble.VisitorSideRealTimeConnector();
                    if (userData.device) {
                        return new SideBubble.SideBubbleVisitorSideManagerMobile(visitorRealTimeHub, id);
                    }
                    else {
                        return new SideBubble.SideBubbleVisitorSideManagerDesktop(visitorRealTimeHub, id);
                    }
                }
            };
            return SideBubbleManagerFactory;
        }());
        SideBubble.SideBubbleManagerFactory = SideBubbleManagerFactory;
    })(SideBubble = Interactions.SideBubble || (Interactions.SideBubble = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var Validation;
    (function (Validation) {
        var ValidationManager = (function (_super) {
            __extends(ValidationManager, _super);
            function ValidationManager(hub) {
                var _this = _super.call(this) || this;
                _this.type = "Validation";
                _this.realTime = hub;
                return _this;
            }
            ValidationManager.prototype.updateUI = function (parameters) {
                var validation = new $o.speak.validation({
                    code: parameters.code,
                    lastMessage: parameters.inputResponse
                });
                $o.speak.messages.push(validation);
            };
            ValidationManager.prototype.recover = function (data) {
            };
            return ValidationManager;
        }(Interactions.BaseManager));
        Validation.ValidationManager = ValidationManager;
    })(Validation = Interactions.Validation || (Interactions.Validation = {}));
})(Interactions || (Interactions = {}));

var Interactions;
(function (Interactions) {
    var Validation;
    (function (Validation) {
        ;
    })(Validation = Interactions.Validation || (Interactions.Validation = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var Validation;
    (function (Validation) {
        var VisitorSideRealTimeConnector = (function (_super) {
            __extends(VisitorSideRealTimeConnector, _super);
            function VisitorSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            VisitorSideRealTimeConnector.prototype.subscribeToRealTimeEvents = function () {
                $.connection.hubInterface.client.receiveInputValidation = function (validation) {
                    oct8ne.registerBotResponse();
                    $o.validations.updateUI(Interactions.BaseManager.objectAdapter(validation, Interactions.Targets.Frontend));
                };
            };
            return VisitorSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        Validation.VisitorSideRealTimeConnector = VisitorSideRealTimeConnector;
    })(Validation = Interactions.Validation || (Interactions.Validation = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var MessageRating;
    (function (MessageRating) {
        var MessageRatingManager = (function (_super) {
            __extends(MessageRatingManager, _super);
            function MessageRatingManager(hub) {
                var _this = _super.call(this) || this;
                _this.ratingMessage = "Valora esta respuesta";
                _this.realTime = hub;
                return _this;
            }
            MessageRatingManager.prototype.clickRatingButton = function (ratingId, allowComment, value) {
                var current = this.getCurrent(ratingId);
                this.highlightResult(current, value);
                if (allowComment) {
                    var commentForm = current.find(".rating-comment-form");
                    commentForm.attr("data-result", value.toString()).show();
                }
                else {
                    var ratingResponse = {
                        comment: "",
                        id: ratingId,
                        result: value
                    };
                    this.send(ratingResponse);
                }
            };
            MessageRatingManager.prototype.clickRatingCommentButton = function (ratingId) {
                var current = this.getCurrent(ratingId);
                var commentForm = current.find(".rating-comment-form");
                var comment = commentForm.find("textarea").val();
                commentForm.hide();
                var result = parseInt(commentForm.attr("data-result"));
                if (isNaN(result)) {
                    return false;
                }
                this.highlightResult(current, result);
                var ratingResponse = {
                    comment: comment.toString(),
                    id: ratingId,
                    result: result
                };
                this.send(ratingResponse);
            };
            MessageRatingManager.prototype.highlightResult = function (current, value) {
                if (value === 2) {
                    current.find(".bad-rate").addClass("active");
                    current.find(".good-rate").remove();
                }
                else {
                    current.find(".good-rate").addClass("active");
                    current.find(".bad-rate").remove();
                }
            };
            ;
            MessageRatingManager.prototype.showResponse = function (id) {
                var current = this.getCurrent(id);
                current.find(".rating-area,.rating-text").fadeOut(200, function () {
                    current.find(".message-rating-result").fadeIn(200, function () {
                        current.delay(3000).fadeOut(200);
                    });
                });
            };
            ;
            MessageRatingManager.prototype.getCurrent = function (id) {
                return $("[data-rating-id='" + id + "']");
            };
            MessageRatingManager.prototype.send = function (response) {
                this.realTime.send(response);
                this.showResponse(response.id);
            };
            MessageRatingManager.prototype.updateUI = function (data) {
                var fullData = this.addFullProperties(data);
                this.render(fullData);
            };
            MessageRatingManager.prototype.render = function (data) {
                if ($o.scroll.enableScroll) {
                    setTimeout(function () {
                        $o.scroll.enableScroll();
                        $("#oct8ne-chat-room").mCustomScrollbar("scrollTo", "bottom", { callbacks: false });
                    }, 100);
                }
                $o.speak.messages.push(data);
            };
            ;
            MessageRatingManager.prototype.addFullProperties = function (data) {
                var newData = data;
                newData.category = "MESSAGERATING";
                newData.message = this.ratingMessage;
                newData.time = Core.Helpers.getTime();
                newData.sentBy = Core.UserTypes.Visitor;
                return newData;
            };
            return MessageRatingManager;
        }(Interactions.BaseManager));
        MessageRating.MessageRatingManager = MessageRatingManager;
    })(MessageRating = Interactions.MessageRating || (Interactions.MessageRating = {}));
})(Interactions || (Interactions = {}));

var Interactions;
(function (Interactions) {
    var MessageRating;
    (function (MessageRating) {
        ;
        ;
    })(MessageRating = Interactions.MessageRating || (Interactions.MessageRating = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var Interactions;
(function (Interactions) {
    var MessageRating;
    (function (MessageRating) {
        var VisitorSideRealTimeConnector = (function (_super) {
            __extends(VisitorSideRealTimeConnector, _super);
            function VisitorSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            VisitorSideRealTimeConnector.prototype.subscribeToRealTimeEvents = function () {
                var _this = this;
                $.connection.hubInterface.client.receiveMessageRating = function (rating) { return __awaiter(_this, void 0, void 0, function () {
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                $o.delay.setGlobal(700);
                                return [4, Interactions.BaseManager.sleep($o.delay.global)];
                            case 1:
                                _a.sent();
                                $o.messageRatings.updateUI(Interactions.BaseManager.objectAdapter(rating, Interactions.Targets.Frontend));
                                return [2];
                        }
                    });
                }); };
            };
            VisitorSideRealTimeConnector.prototype.send = function (response) {
                if ($o.core.isSignalRConnected()) {
                    var obj = Interactions.BaseManager.objectAdapter(response, Interactions.Targets.Backend);
                    var room = Core.Helpers.getTokenRoom();
                    $.connection.hubInterface.server.sendMessageRatingResponse(obj, room, $o.core.globalVariables.domainId);
                }
            };
            return VisitorSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        MessageRating.VisitorSideRealTimeConnector = VisitorSideRealTimeConnector;
    })(MessageRating = Interactions.MessageRating || (Interactions.MessageRating = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var Interactions;
(function (Interactions) {
    var DelayAction;
    (function (DelayAction) {
        var DelayManager = (function (_super) {
            __extends(DelayManager, _super);
            function DelayManager(hub) {
                var _this = _super.call(this) || this;
                _this.delayLocalStorage = "oct8ne-delay-action";
                _this.realTime = hub;
                return _this;
            }
            DelayManager.prototype.process = function (delay, connected) {
                return __awaiter(this, void 0, void 0, function () {
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                if (!(delay.waitingAction == 1)) return [3, 2];
                                return [4, Interactions.BaseManager.sleep($o.delay.global + 500)];
                            case 1:
                                _a.sent();
                                $o.chat.showTypingDelayFromBot();
                                _a.label = 2;
                            case 2:
                                ;
                                return [4, this.start(delay.milliseconds / 1000)];
                            case 3:
                                _a.sent();
                                $o.chat.isTypingWhileBotRequest();
                                this.finish(connected);
                                return [2];
                        }
                    });
                });
            };
            DelayManager.prototype.start = function (seconds) {
                return __awaiter(this, void 0, void 0, function () {
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                $o.storage.local.set(this.delayLocalStorage, seconds);
                                return [4, Interactions.BaseManager.sleep($o.delay.global)];
                            case 1:
                                _a.sent();
                                this.storeRemainingTime(seconds);
                                return [4, Interactions.BaseManager.sleep(seconds * 1000)];
                            case 2:
                                _a.sent();
                                return [2];
                        }
                    });
                });
            };
            DelayManager.prototype.finish = function (connected) {
                return __awaiter(this, void 0, void 0, function () {
                    return __generator(this, function (_a) {
                        this.deleteStorage();
                        oct8ne.delay.reset();
                        clearInterval(this.interval);
                        if (connected) {
                            this.realTime.send();
                        }
                        return [2];
                    });
                });
            };
            DelayManager.prototype.checkPending = function () {
                var pendingDelay = $o.storage.local.get("oct8ne-delay-action");
                if (pendingDelay) {
                    this.start(pendingDelay);
                }
            };
            DelayManager.prototype.storeRemainingTime = function (pending) {
                var _this = this;
                this.interval = setInterval(function () {
                    if (pending >= 1) {
                        pending = pending - 1;
                        _this.setStorage(pending);
                    }
                    else {
                        $o.storage.local.set(_this.delayLocalStorage, $o.core.localStorageActions.REMOVE);
                    }
                }, 1000);
            };
            DelayManager.prototype.setStorage = function (seconds) {
                $o.storage.local.set(this.delayLocalStorage, seconds);
            };
            DelayManager.prototype.tryRecover = function () {
                var pendingDelay = $o.storage.local.get(this.delayLocalStorage);
                if (pendingDelay) {
                    var recoveredDelay = {
                        milliseconds: parseInt(pendingDelay) * 1000,
                        waitingAction: 0
                    };
                    this.process(recoveredDelay, $o.core.isSignalRConnected());
                }
            };
            DelayManager.prototype.deleteStorage = function () {
                $o.storage.local.set(this.delayLocalStorage, $o.core.localStorageActions.REMOVE);
            };
            return DelayManager;
        }(Interactions.BaseManager));
        DelayAction.DelayManager = DelayManager;
    })(DelayAction = Interactions.DelayAction || (Interactions.DelayAction = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var Interactions;
(function (Interactions) {
    var DelayAction;
    (function (DelayAction) {
        var VisitorSideRealTimeConnector = (function (_super) {
            __extends(VisitorSideRealTimeConnector, _super);
            function VisitorSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            VisitorSideRealTimeConnector.prototype.subscribeToRealTimeEvents = function () {
                var _this = this;
                oct8ne.registerBotResponse();
                $.connection.hubInterface.client.receiveDelay = function (delay) { return __awaiter(_this, void 0, void 0, function () {
                    var delayData;
                    return __generator(this, function (_a) {
                        delayData = Interactions.BaseManager.objectAdapter(delay, Interactions.Targets.Frontend);
                        delayData.milliseconds = parseInt(delayData.milliseconds);
                        $o.delayAction.process(delayData, true);
                        return [2];
                    });
                }); };
            };
            VisitorSideRealTimeConnector.prototype.send = function () {
                if ($o.bot && $o.bot.responseChecker) {
                    $o.bot.responseChecker.startWaiting();
                }
                if ($o.core.isSignalRConnected()) {
                    var room = Core.Helpers.getTokenRoom();
                    $.connection.hubInterface.server.sendDelayCallback(room, $o.core.globalVariables.agentId);
                }
            };
            return VisitorSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        DelayAction.VisitorSideRealTimeConnector = VisitorSideRealTimeConnector;
    })(DelayAction = Interactions.DelayAction || (Interactions.DelayAction = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var Error;
    (function (Error) {
        var ErrorManager = (function (_super) {
            __extends(ErrorManager, _super);
            function ErrorManager(hub) {
                var _this = _super.call(this) || this;
                _this.realTime = hub;
                return _this;
            }
            ErrorManager.prototype.process = function (error) {
                $o.inactivity.stopProcess();
                $o.inactivity.disableChatInputUI();
                $.connection.hub.stop();
                $o.core.agentsConnected = false;
                var queryString = "?tokenSession=" + $o.core.globalVariables.room + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId;
                $o.visitorStart.changeStatus(queryString, "Finalized");
                $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [{ cookie: $o.cookies.status, value: "Finalized" }]);
                $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: $o.cookies.tokenSession, value: "" }, { cookie: $o.cookies.lastInteractionAFK, value: "" },]);
                $o.core.globalVariables.sessionFinalized = true;
                $("#chat-input, .chat-input-emoji").blur();
                var errorMessage = "Operation code: " + error.operationCode;
                if (error.errorCode !== -1) {
                    errorMessage += ", Error code: ".concat(error.errorCode);
                }
                $("#error-bot-content-message").html(errorMessage);
                $("#error-bot-message").show();
                console.error("Error on Oct8ne bot conversation! ".concat(errorMessage, ", Message: ").concat(error.message));
                $("#refresh-page-error-bot, #minimize-by-menu").on("click", function () {
                    $o.core.doPostMessageToApi("RESTARTFROMERROR");
                });
            };
            return ErrorManager;
        }(Interactions.BaseManager));
        Error.ErrorManager = ErrorManager;
    })(Error = Interactions.Error || (Interactions.Error = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var Interactions;
(function (Interactions) {
    var Error;
    (function (Error) {
        var VisitorSideRealTimeConnector = (function (_super) {
            __extends(VisitorSideRealTimeConnector, _super);
            function VisitorSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            VisitorSideRealTimeConnector.prototype.subscribeToRealTimeEvents = function () {
                var _this = this;
                $.connection.hubInterface.client.receiveError = function (error) { return __awaiter(_this, void 0, void 0, function () {
                    return __generator(this, function (_a) {
                        $o.botErrors.process(Interactions.BaseManager.objectAdapter(error, Interactions.Targets.Frontend));
                        return [2];
                    });
                }); };
            };
            return VisitorSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        Error.VisitorSideRealTimeConnector = VisitorSideRealTimeConnector;
    })(Error = Interactions.Error || (Interactions.Error = {}));
})(Interactions || (Interactions = {}));

var Interactions;
(function (Interactions) {
    var CustomForm;
    (function (CustomForm) {
        var CustomFormManagerFactory = (function () {
            function CustomFormManagerFactory() {
            }
            CustomFormManagerFactory.create = function (userData) {
                if (userData.type === Core.UserTypes.Agent) {
                    var agentRealTimeHub = new CustomForm.AgentSideRealTimeConnector();
                    return new CustomForm.CustomFormAgentSideManager(agentRealTimeHub);
                }
                else {
                    var visitorRealTimeHub = new CustomForm.VisitorSideRealTimeConnector();
                    if (userData.device) {
                        return new CustomForm.CustomFormVisitorSideManager(visitorRealTimeHub);
                    }
                    else {
                        return new CustomForm.CustomFormVisitorSideManager(visitorRealTimeHub);
                    }
                }
            };
            return CustomFormManagerFactory;
        }());
        CustomForm.CustomFormManagerFactory = CustomFormManagerFactory;
        ;
    })(CustomForm = Interactions.CustomForm || (Interactions.CustomForm = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var CustomForm;
    (function (CustomForm) {
        var CustomFormManagerBase = (function (_super) {
            __extends(CustomFormManagerBase, _super);
            function CustomFormManagerBase() {
                var _this = _super.call(this) || this;
                _this.type = "CustomForm";
                _this.collection = [];
                return _this;
            }
            CustomFormManagerBase.prototype.resetCollection = function () {
                this.collection = [];
            };
            CustomFormManagerBase.prototype.updateUI = function (data) {
                $o.chat.toogleDenyVisitorTyping(false);
                var fullData = this.addFullProperties(data);
                this.render(fullData, false);
            };
            CustomFormManagerBase.prototype.recover = function (data) {
                var formatted = Interactions.BaseManager.objectAdapter(data, Interactions.Targets.Frontend);
                var recovered = this.parseDataForRecovering(formatted);
                this.render(recovered, true);
            };
            CustomFormManagerBase.prototype.search = function (id) {
                for (var _i = 0, _a = this.collection; _i < _a.length; _i++) {
                    var form = _a[_i];
                    if (form.id === id) {
                        return form;
                    }
                }
                return null;
            };
            CustomFormManagerBase.prototype.render = function (data, recoveredMessage) {
                this.collection.push(data);
                $o.speak.messages.push(data);
                $o.chat.toogleDenyVisitorTyping(true);
                _super.prototype.scrollBallHack.call(this, recoveredMessage);
            };
            CustomFormManagerBase.prototype.addFullProperties = function (data) {
                var newData = data;
                newData.time = Core.Helpers.getTime();
                newData.sentBy = Core.UserTypes.Agent;
                newData.response = ko.observable();
                newData.category = Interactions.Categories.CustomForm;
                newData.formFields = this.parseFields(data.formFields);
                return newData;
            };
            CustomFormManagerBase.prototype.parseDataForRecovering = function (data) {
                var formFields = Interactions.BaseManager.objectAdapter(JSON.parse(data.fields.formFields), Interactions.Targets.Frontend);
                var recoveredForm = {
                    category: Interactions.Categories.CustomForm,
                    header: data.fields.header,
                    id: data.fields.id,
                    formFields: this.parseFields(formFields),
                    userCanCancel: data.fields.userCanCancel,
                    name: data.fields.name,
                    response: ko.observable(),
                    sentBy: data.sentBy,
                    time: data.fields.time,
                    type: data.fields.type
                };
                return recoveredForm;
            };
            CustomFormManagerBase.prototype.parseFields = function (data) {
                var parsedFields = [];
                for (var _i = 0, data_1 = data; _i < data_1.length; _i++) {
                    var newField = data_1[_i];
                    if (newField.type == "checkbox") {
                        if (newField.defaultValue != "" && newField.defaultValue != "false" && newField.defaultValue != "False") {
                            newField.defaultValue = "checked";
                        }
                        else {
                            newField.defaultValue = "";
                        }
                    }
                    newField.type = newField.type;
                    newField.label = newField.label;
                    newField.value = ko.observable(newField.defaultValue);
                    newField.name = newField.variableName;
                    if (newField.type == "number") {
                        newField.minNumber = "";
                        newField.maxNumber = "";
                    }
                    if (newField.type == "select") {
                        newField.selectOptionsAsArray = newField.selectOptionsAsArray.map(function (option) {
                            if (option.value === "null")
                                option.value = "";
                            return option;
                        });
                    }
                    if (newField.maxLength !== null || newField.minLength !== null) {
                        var minLength = 0;
                        if (newField.minLength !== null) {
                            minLength = newField.minLength;
                            if (newField.type == "number") {
                                var minNumber = "";
                                for (var i = 0; i < minLength; i++) {
                                    if (i == 0) {
                                        minNumber = minNumber + "1";
                                    }
                                    else {
                                        minNumber = minNumber + "0";
                                    }
                                }
                                newField.minNumber = parseInt(minNumber);
                            }
                        }
                        ;
                        var maxLength = "";
                        if (newField.maxLength !== null) {
                            maxLength = newField.maxLength;
                            if (newField.type == "number") {
                                var maxNumber = "";
                                for (var i = 0; i < maxLength; i++) {
                                    maxNumber = maxNumber + "9";
                                }
                                newField.maxNumber = parseInt(maxNumber);
                            }
                        }
                        ;
                    }
                    newField.maxLength = newField.maxLength ? newField.maxLength : "";
                    newField.minLength = newField.minLength ? newField.minLength : "";
                    newField.required = newField.required;
                    newField.selectOptions = newField.selectOptions;
                    newField.list = newField.list;
                    newField.validationCode = newField.validationCode;
                    parsedFields.push(newField);
                }
                return parsedFields;
            };
            return CustomFormManagerBase;
        }(Interactions.BaseManager));
        CustomForm.CustomFormManagerBase = CustomFormManagerBase;
    })(CustomForm = Interactions.CustomForm || (Interactions.CustomForm = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var Interactions;
(function (Interactions) {
    var CustomForm;
    (function (CustomForm) {
        var VisitorSideRealTimeConnector = (function (_super) {
            __extends(VisitorSideRealTimeConnector, _super);
            function VisitorSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            VisitorSideRealTimeConnector.prototype.subscribeToRealTimeEvents = function () {
                var _this = this;
                $.connection.hubInterface.client.receiveCustomForm = function (form, delay) { return __awaiter(_this, void 0, void 0, function () {
                    var interaction;
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                oct8ne.registerBotResponse();
                                if ($o.core.globalVariables.room.startsWith("TEMP")) {
                                    if (!form.Type) {
                                        form = Interactions.BaseManager.objectAdapter(form, Interactions.Targets.Backend);
                                    }
                                    interaction = {
                                        id: form.Id ? form.Id : form.id,
                                        type: form.Type ? form.Type : form.type,
                                        userCanCancel: form.UserCanCancel ? form.UserCanCancel : form.userCanCancel,
                                        formFields: JSON.stringify(form.FormFields ? form.FormFields : form.formFields),
                                        header: form.Header ? form.Header : form.header,
                                        name: form.Name ? form.Name : form.name,
                                        time: form.Time ? form.Time : form.time
                                    };
                                    $o.saveRecord.customForm(interaction);
                                }
                                if (delay) {
                                    $o.delay.setGlobal(1500);
                                }
                                ++$o.delay.chatQueue;
                                $o.chat.showTypingDelayFromBot();
                                return [4, Interactions.BaseManager.sleep($o.delay.global)];
                            case 1:
                                _a.sent();
                                --$o.delay.chatQueue;
                                if ($o.delay.chatQueue > 0) {
                                    setTimeout(function () { $o.chat.showTypingDelayFromBot(); }, 600);
                                }
                                else {
                                    $o.delay.reset();
                                }
                                $o.chat.hideTyping();
                                $o.chat.playVisitorSound();
                                $o.customForms.updateUI(Interactions.BaseManager.objectAdapter(form, Interactions.Targets.Frontend));
                                $o.delay.reset();
                                if ($o.variablesVisitor.status === "Attending") {
                                    $o.inactivity.attending.start();
                                }
                                return [2];
                        }
                    });
                }); };
            };
            return VisitorSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        CustomForm.VisitorSideRealTimeConnector = VisitorSideRealTimeConnector;
        var AgentSideRealTimeConnector = (function (_super) {
            __extends(AgentSideRealTimeConnector, _super);
            function AgentSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            AgentSideRealTimeConnector.prototype.send = function (choice) {
                window.top.sendChoice(Interactions.BaseManager.objectAdapter(choice, Interactions.Targets.Backend), Core.Helpers.getTokenRoom());
            };
            return AgentSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        CustomForm.AgentSideRealTimeConnector = AgentSideRealTimeConnector;
    })(CustomForm = Interactions.CustomForm || (Interactions.CustomForm = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var CustomForm;
    (function (CustomForm) {
        var CustomFormVisitorSideManager = (function (_super) {
            __extends(CustomFormVisitorSideManager, _super);
            function CustomFormVisitorSideManager(hub) {
                var _this = _super.call(this) || this;
                _this.uploadedFromCustomForm = null;
                _this.realTime = hub;
                return _this;
            }
            CustomFormVisitorSideManager.prototype.disableAll = function () {
                for (var _i = 0, _a = $o.speak.messages(); _i < _a.length; _i++) {
                    var message = _a[_i];
                    if (message.category == "CUSTOM_FORM") {
                        message.response("endSession");
                    }
                }
            };
            CustomFormVisitorSideManager.prototype.upload = function (e) {
                var formId = e.target.closest("form").id;
                this.uploadedFromCustomForm = formId;
                $("#visitor-upload-button").trigger("click");
            };
            return CustomFormVisitorSideManager;
        }(CustomForm.CustomFormManagerBase));
        CustomForm.CustomFormVisitorSideManager = CustomFormVisitorSideManager;
    })(CustomForm = Interactions.CustomForm || (Interactions.CustomForm = {}));
})(Interactions || (Interactions = {}));

var Interactions;
(function (Interactions) {
    var CustomFormResponse;
    (function (CustomFormResponse) {
        var CustomFormResponseManagerFactory = (function () {
            function CustomFormResponseManagerFactory() {
            }
            CustomFormResponseManagerFactory.create = function (userData, customForms) {
                if (userData.type === Core.UserTypes.Agent) {
                    var agentHub = new CustomFormResponse.AgentSideRealTimeConnector();
                    return new CustomFormResponse.AgentSideManager(agentHub, customForms);
                }
                else {
                    var visitorHub = new CustomFormResponse.VisitorSideRealTimeConnector();
                    if (userData.device) {
                        return new CustomFormResponse.VisitorSideManager(visitorHub, customForms);
                    }
                    else {
                        return new CustomFormResponse.VisitorSideManager(visitorHub, customForms);
                    }
                }
            };
            return CustomFormResponseManagerFactory;
        }());
        CustomFormResponse.CustomFormResponseManagerFactory = CustomFormResponseManagerFactory;
        ;
    })(CustomFormResponse = Interactions.CustomFormResponse || (Interactions.CustomFormResponse = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var Interactions;
(function (Interactions) {
    var CustomFormResponse;
    (function (CustomFormResponse) {
        var CustomFormResponseManagerBase = (function (_super) {
            __extends(CustomFormResponseManagerBase, _super);
            function CustomFormResponseManagerBase(customForms) {
                var _this = _super.call(this) || this;
                _this.type = "CustomFormResponse";
                _this.collection = [];
                _this.customForms = customForms;
                return _this;
            }
            CustomFormResponseManagerBase.prototype.recover = function (response) {
                var formatted = Interactions.BaseManager.objectAdapter(response, Interactions.Targets.Frontend);
                this.setCustomFormAsResponsed(formatted.fields.customFormId, formatted.fields.responses);
            };
            ;
            CustomFormResponseManagerBase.prototype.setCustomFormAsResponsed = function (customFormId, response) {
                var customForm = this.customForms.search(customFormId);
                if (customForm) {
                    customForm.response(response);
                    var parsedResponse = JSON.parse(response);
                    if (parsedResponse === null) {
                        return;
                    }
                    for (var _i = 0, _a = customForm.formFields; _i < _a.length; _i++) {
                        var field = _a[_i];
                        if (field !== null) {
                            var fieldName = field.name;
                            if (field.type == "checkbox") {
                                if (parsedResponse[fieldName] != "" && parsedResponse[fieldName] != "false") {
                                    field.value("checked");
                                }
                                else {
                                    field.value("");
                                }
                            }
                            else if (field.type == "date") {
                                var date = new Date(parsedResponse[fieldName]);
                                field.value(date.toISOString().substring(0, 10));
                            }
                            else {
                                if (parsedResponse) {
                                    field.value(parsedResponse[fieldName]);
                                }
                            }
                        }
                    }
                }
            };
            return CustomFormResponseManagerBase;
        }(Interactions.BaseManager));
        CustomFormResponse.CustomFormResponseManagerBase = CustomFormResponseManagerBase;
    })(CustomFormResponse = Interactions.CustomFormResponse || (Interactions.CustomFormResponse = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var Interactions;
(function (Interactions) {
    var CustomFormResponse;
    (function (CustomFormResponse) {
        var VisitorSideRealTimeConnector = (function (_super) {
            __extends(VisitorSideRealTimeConnector, _super);
            function VisitorSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            VisitorSideRealTimeConnector.prototype.postSend = function (responseInfo) {
                if ($o.bot && $o.bot.responseChecker) {
                    $o.bot.responseChecker.startWaiting();
                }
                if ($o.core.isSignalRConnected()) {
                    if ($o.variablesVisitor.status != "Attending") {
                        $.connection.hubInterface.server.sendStatus({ tokenVisitor: $o.core.globalVariables.myToken, tokenSession: $o.core.globalVariables.room, status: "Waiting" }).done(function () {
                            $.connection.hubInterface.server.sendCustomFormResponse(Interactions.BaseManager.objectAdapter(responseInfo, Interactions.Targets.Backend), Core.Helpers.getTokenRoom());
                        });
                    }
                    else {
                        $.connection.hubInterface.server.sendCustomFormResponse(Interactions.BaseManager.objectAdapter(responseInfo, Interactions.Targets.Backend), Core.Helpers.getTokenRoom());
                    }
                }
                else {
                    $o.visitorStart.restartConnection(null, true);
                    var checkConnection = setInterval(function () {
                        return __awaiter(this, void 0, void 0, function () {
                            var checkStartedBotOffline;
                            return __generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0:
                                        if (!$o.core.globalVariables.finishedVisitorRestartConnection) return [3, 3];
                                        clearInterval(checkConnection);
                                        if (!$o.bot) return [3, 2];
                                        return [4, $o.bot.connectOverflowAsync()];
                                    case 1:
                                        _a.sent();
                                        _a.label = 2;
                                    case 2:
                                        checkStartedBotOffline = setInterval(function () {
                                            return __awaiter(this, void 0, void 0, function () {
                                                return __generator(this, function (_a) {
                                                    if ($o.core.globalVariables.startedBotOffline) {
                                                        clearInterval(checkStartedBotOffline);
                                                        $.connection.hubInterface.server.sendStatus({
                                                            tokenVisitor: $o.core.globalVariables.myToken,
                                                            tokenSession: $o.core.globalVariables.room,
                                                            status: "Waiting"
                                                        }).done(function () {
                                                            setTimeout(function () {
                                                                $.connection.hubInterface.server.sendCustomFormResponse(Interactions.BaseManager.objectAdapter(responseInfo, Interactions.Targets.Backend), Core.Helpers.getTokenRoom());
                                                            }, 4000);
                                                        });
                                                    }
                                                    return [2];
                                                });
                                            });
                                        }, 100);
                                        _a.label = 3;
                                    case 3: return [2];
                                }
                            });
                        });
                    }, 100);
                }
                $o.inactivity.setVisitorActive();
            };
            VisitorSideRealTimeConnector.prototype.send = function (responseInfo) {
                if ($o.core.globalVariables.room && $o.core.globalVariables.room.startsWith("TEMP")) {
                    $.post("Oct8ne/InitSessionWithBot", {
                        tempRoom: $o.core.globalVariables.room,
                        visitorData: JSON.stringify($o.core.globalVariables.visitorData)
                    }, function (result) {
                        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [
                            { cookie: $o.cookies.tokenSession, value: result.Room },
                            { cookie: $o.cookies.sessionSummaryId, value: result.SessionSummaryId },
                        ]);
                        $o.core.globalVariables.roomForLastOperations = result.Room;
                        $o.saveRecord.saveListInteractions().then(function (result) {
                            VisitorSideRealTimeConnector.prototype.postSend(responseInfo);
                        });
                    });
                }
                else {
                    VisitorSideRealTimeConnector.prototype.postSend(responseInfo);
                }
            };
            return VisitorSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        CustomFormResponse.VisitorSideRealTimeConnector = VisitorSideRealTimeConnector;
        var AgentSideRealTimeConnector = (function (_super) {
            __extends(AgentSideRealTimeConnector, _super);
            function AgentSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            AgentSideRealTimeConnector.prototype.subscribeToRealTimeEvents = function () {
                window['getCustomFormResponseFromDashboard'] = function (parameters) {
                    var response = Interactions.BaseManager.objectAdapter(parameters, Interactions.Targets.Frontend);
                    $o.CustomFormResponses.receive(response);
                };
            };
            return AgentSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        CustomFormResponse.AgentSideRealTimeConnector = AgentSideRealTimeConnector;
    })(CustomFormResponse = Interactions.CustomFormResponse || (Interactions.CustomFormResponse = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var Interactions;
(function (Interactions) {
    var CustomFormResponse;
    (function (CustomFormResponse) {
        var VisitorSideManager = (function (_super) {
            __extends(VisitorSideManager, _super);
            function VisitorSideManager(hub, CustomForms) {
                var _this = _super.call(this, CustomForms) || this;
                _this.realTime = hub;
                return _this;
            }
            VisitorSideManager.prototype.save = function (data) {
                return __awaiter(this, void 0, void 0, function () {
                    var parsedData, result;
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                parsedData = this.parseDataForSaving(data);
                                return [4, _super.prototype.store.call(this, parsedData)];
                            case 1:
                                result = _a.sent();
                                return [2, result];
                        }
                    });
                });
            };
            VisitorSideManager.prototype.clickResponseButton = function (event) {
                var formId = event.target.id;
                var formData = new FormData((document.getElementById(formId)));
                var checkbox = $("#" + formId + " input[type=checkbox]");
                checkbox.each(function (i) {
                    var cb = $(checkbox[i]);
                    formData.append(cb.attr('name'), cb.is(':checked') ? "true" : "false");
                });
                var dates = $("#" + formId + " input[type=date]");
                dates.each(function (x) {
                    var dt = $(dates[x]);
                    var value = dt.prop("value");
                    var date = new Date(value);
                    formData.set(dt.attr('name'), date.toISOString());
                });
                var object = {};
                formData.forEach(function (value, key) {
                    object[key] = value;
                });
                this.setResponsedAndSend(formId, object);
            };
            VisitorSideManager.prototype.skipResponse = function (event) {
                var formId = event.target.getAttribute("data-form-id");
                this.setResponsedAndSend(formId, null);
            };
            VisitorSideManager.prototype.setResponsedAndSend = function (formId, formData) {
                var customForm = this.customForms.search(formId);
                if (customForm) {
                    customForm.response(JSON.stringify(formData));
                    this.sendResponse(customForm);
                }
            };
            VisitorSideManager.prototype.sendResponse = function (customForm) {
                return __awaiter(this, void 0, void 0, function () {
                    var responseInfo, fullResponseInfo, result;
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                responseInfo = {
                                    id: customForm.id,
                                    data: customForm.response()
                                };
                                fullResponseInfo = {
                                    id: customForm.id,
                                    data: customForm.response(),
                                    name: Core.Helpers.getMyName(),
                                    category: Interactions.Categories.CustomFormResponse,
                                    sentBy: Core.UserTypes.Agent,
                                    time: Core.Helpers.getTime()
                                };
                                return [4, this.save(fullResponseInfo)];
                            case 1:
                                result = _a.sent();
                                if (result === false) {
                                    throw ("Error saving custom form response");
                                }
                                ;
                                this.realTime.send(responseInfo);
                                return [2];
                        }
                    });
                });
            };
            ;
            VisitorSideManager.prototype.parseDataForSaving = function (data) {
                var record = {
                    recoverType: 1,
                    sentBy: Core.UserTypes.Visitor,
                    type: "CustomFormResponse",
                    fields: {
                        customFormId: data.id,
                        name: data.name,
                        time: data.time,
                        responses: data.data
                    }
                };
                return [record];
            };
            return VisitorSideManager;
        }(CustomFormResponse.CustomFormResponseManagerBase));
        CustomFormResponse.VisitorSideManager = VisitorSideManager;
    })(CustomFormResponse = Interactions.CustomFormResponse || (Interactions.CustomFormResponse = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var Interactions;
(function (Interactions) {
    var ProductSearchFromBot;
    (function (ProductSearchFromBot) {
        var ProductSearchManager = (function (_super) {
            __extends(ProductSearchManager, _super);
            function ProductSearchManager(hub) {
                var _this_1 = _super.call(this) || this;
                _this_1.delay = 0;
                _this_1.searchParams = null;
                _this_1.realTime = hub;
                return _this_1;
            }
            ProductSearchManager.prototype.process = function (search, delay) {
                this.delay = delay;
                this.searchParams = search;
                if (search === undefined)
                    throw 'search cannot be undefined';
                if (!search['source'] == undefined)
                    throw 'search.source cannot be empty';
                if (!search['searchType'] == undefined)
                    throw 'search.searchType cannot be empty';
                if (!search['query'] == undefined)
                    throw 'search.query cannot be empty';
                if (!search['maxProducts'])
                    throw 'search.maxProducts cannot be empty';
                if (search.source == Source.Oct8neCatalog) {
                    this.processInternalCatalogSearch(search);
                }
                else if (search.source == Source.ShopCatalog) {
                    this.processShopCatalogSearch(search);
                }
            };
            ProductSearchManager.prototype.processShopCatalogSearch = function (search) {
                var searchBaseUrl = "".concat($o.platform.domain).concat($o.platform.prefixUrlPlatform);
                var searchUrl = "";
                if (search.searchType == SearchType.Id) {
                    searchUrl = "productinfo?productIds=".concat(JSON.parse(search.query).join());
                    $o.platform.manageRequests("".concat(searchBaseUrl).concat(searchUrl), "BOT_SHOP_PRODUCT_ID", "processShopProductId");
                }
                else if (search.searchType == SearchType.Keyword) {
                    searchUrl = "search?search=".concat(search.query, "&page=1&pageSize=").concat(search.maxProducts, "&orderby=relevance&dir=desc");
                    $o.platform.manageRequests("".concat(searchBaseUrl).concat(searchUrl), "BOT_SHOP_SEARCH", "processShopSearchResults");
                }
            };
            ProductSearchManager.prototype.processShopSearchResultsAsync = function (productSummaries) {
                return __awaiter(this, void 0, void 0, function () {
                    var hasResults, prods, ids, _i, prods_1, summary, search;
                    return __generator(this, function (_a) {
                        if (!productSummaries['results'])
                            productSummaries["results"] = [];
                        hasResults = this.checkResultsCount(productSummaries.results.length);
                        if (!hasResults) {
                            this.setResultsResponseAsync(null);
                            return [2];
                        }
                        prods = productSummaries.results;
                        if (prods.length > this.searchParams.maxProducts) {
                            prods = prods.slice(0, this.searchParams.maxProducts);
                        }
                        ids = [];
                        for (_i = 0, prods_1 = prods; _i < prods_1.length; _i++) {
                            summary = prods_1[_i];
                            ids.push(summary.internalId);
                        }
                        search = {
                            maxProducts: this.searchParams.maxProducts,
                            query: JSON.stringify(ids),
                            searchType: SearchType.Id,
                            source: Source.ShopCatalog
                        };
                        this.processShopCatalogSearch(search);
                        return [2];
                    });
                });
            };
            ProductSearchManager.prototype.processShopProductIdAsync = function (products) {
                return __awaiter(this, void 0, void 0, function () {
                    var hasResults, parsedNodes;
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                if (!products)
                                    throw 'products cannot be empty';
                                hasResults = this.checkResultsCount(products.length);
                                if (!hasResults) {
                                    this.setResultsResponseAsync(null);
                                    return [2];
                                }
                                $o.delay.setGlobal(this.delay);
                                ++$o.delay.chatQueue;
                                $o.chat.showTypingDelayFromBot();
                                return [4, Interactions.BaseManager.sleep(this.delay)];
                            case 1:
                                _a.sent();
                                --$o.delay.chatQueue;
                                if ($o.delay.chatQueue > 0) {
                                    setTimeout(function () { $o.chat.showTypingDelayFromBot(); }, 600);
                                }
                                else {
                                    $o.delay.reset();
                                }
                                $o.chat.playVisitorSound();
                                if (products.hasOwnProperty("results")) {
                                    products = products.results;
                                }
                                if ($o.utils && $o.utils.parseFullInfoFromCustomPlatform) {
                                    $o.utils.parseFullInfoFromCustomPlatform(products, $o.platform.productInfoRecover, $o.platform.productInfoChangeToImage, $o.platform.productInfoAddToList);
                                }
                                else {
                                    parsedNodes = $o.platform.parseFullInfoFromPlatform(products);
                                    if (parsedNodes) {
                                        this.showSearchResults(parsedNodes);
                                    }
                                }
                                this.delay = 0;
                                $o.delay.reset();
                                return [2];
                        }
                    });
                });
            };
            ProductSearchManager.prototype.processInternalCatalogSearch = function (search) {
                var defaultCategory = [];
                if ($o.utils && $o.utils.getStartDefaultCatalog) {
                    $o.utils.getStartDefaultCatalog();
                    defaultCategory.push(parseInt($o.utils.startDefaultCatalog));
                }
                if (search.searchType == SearchType.Reference) {
                    search.query = "#" + search.query;
                }
                var _this = this;
                $.ajax({
                    type: "POST",
                    url: $o.settings.catalogServer + "Resources/ListFilteredCatalogsFullInfo",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({ "Categories": defaultCategory, "SearchTerm": search.query, "License": $o.settings.license, "Size": search.maxProducts }),
                    dataType: "json",
                    success: function (products) {
                        var hasResults = _this.checkResultsCount(products.length);
                        if (!hasResults) {
                            _this.setResultsResponseAsync(null);
                            return;
                        }
                        for (var _i = 0, products_1 = products; _i < products_1.length; _i++) {
                            var product = products_1[_i];
                            product.URLMedia = $o.core.replaceDeprecatedCdnUrl(product.Thumbnail);
                        }
                        _this.processInternalCatalogResultsAsync(products);
                    }
                });
            };
            ProductSearchManager.prototype.processInternalCatalogResultsAsync = function (products) {
                return __awaiter(this, void 0, void 0, function () {
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                $o.delay.setGlobal(this.delay);
                                ++$o.delay.chatQueue;
                                $o.chat.showTypingDelayFromBot();
                                return [4, Interactions.BaseManager.sleep(this.delay)];
                            case 1:
                                _a.sent();
                                --$o.delay.chatQueue;
                                if ($o.delay.chatQueue > 0) {
                                    setTimeout(function () { $o.chat.showTypingDelayFromBot(); }, 600);
                                }
                                else {
                                    $o.delay.reset();
                                }
                                $o.chat.playVisitorSound();
                                this.showSearchResults(products);
                                this.delay = 0;
                                $o.delay.reset();
                                return [2];
                        }
                    });
                });
            };
            ProductSearchManager.prototype.showSearchResults = function (parsedNodes) {
                var _this_1 = this;
                if (!Array.isArray(parsedNodes))
                    throw 'parsedNodes must be an array';
                var productsLength = parsedNodes.length;
                if (this.searchParams.searchType == SearchType.Keyword && (productsLength > this.searchParams.maxProducts)) {
                    parsedNodes = parsedNodes.slice(0, this.searchParams.maxProducts);
                }
                this.setResultsResponseAsync(parsedNodes);
                $o.chat.hideTyping();
                var firstProductId;
                parsedNodes.forEach(function (value, index) {
                    if (_this_1.searchParams.searchType != SearchType.Keyword || (_this_1.searchParams.searchType == SearchType.Keyword && index < _this_1.searchParams.maxProducts)) {
                        var parsedNode = value;
                        $o.carousel.sendProductToAnalytics("A");
                        parsedNode.SentBy = "A";
                        $o.search.productFromSearch = true;
                        $o.canva.imageFromAgent = true;
                        if (parsedNodes.length > 1) {
                            if (index == 0) {
                                $o.productsChat.sentManyProductsByAgent(parsedNode);
                            }
                        }
                        else {
                            $o.productsChat.sentProductByAgent(parsedNode);
                        }
                        $(".show-coviewer").addClass("blinking");
                        if (parsedNode.BuyURL && $o.platform) {
                            $o.platform.productBuyURL = parsedNode.BuyURL;
                        }
                        if (parsedNode.InternalId.indexOf("Oct8neCatalog") >= 0 && parsedNode.ProductUrl) {
                            parsedNode.RouteTo = parsedNode.ProductUrl;
                        }
                        if ($o.platform && $o.platform.productInfoAddToList) {
                            $o.carousel.addProductInfoToList(parsedNode, $o.carousel.lists.VIEWED);
                        }
                        $o.fullProducts.addProductToCollection(parsedNode);
                        $o.carousel.sendProductToCarousel(parsedNode, $o.carousel.lists.VIEWED, "", "recover");
                        if (index == 0) {
                            firstProductId = parsedNode.InternalId;
                        }
                    }
                });
                setTimeout(function () {
                    var fromBot = true;
                    $o.carousel.sentProductToCanva(firstProductId, false, null, fromBot);
                    if ($o.utils && $o.utils.sendCustomProductIdToAnalytics) {
                        firstProductId = $o.utils.sendCustomProductIdToAnalytics(firstProductId);
                    }
                    var event = {
                        category: "Oct8ne",
                        type: "GAAgentProductSuggested",
                        viewedProduct: firstProductId
                    };
                    $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(event));
                }, 500);
                $o.carousel.loadingProduct();
                $o.iframes.changeStatusIframe($o.iframes.iframeStatus.SEARCH);
                if (Core.Helpers.isDevice()) {
                    $o.chat.addAlertProduct();
                }
                ;
            };
            ProductSearchManager.prototype.checkResultsCount = function (resultsCount) {
                return resultsCount > 0;
            };
            ProductSearchManager.prototype.setResultsResponseAsync = function (results) {
                return __awaiter(this, void 0, void 0, function () {
                    var resultsSummaryData, _i, results_1, result, fields;
                    var _this_1 = this;
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                resultsSummaryData = [];
                                if (results !== null) {
                                    for (_i = 0, results_1 = results; _i < results_1.length; _i++) {
                                        result = results_1[_i];
                                        resultsSummaryData.push({
                                            InternalId: result.InternalId,
                                            Thumbnail: $o.core.replaceDeprecatedCdnUrl(result.Thumbnail),
                                            Title: result.Title
                                        });
                                    }
                                    ;
                                }
                                fields = {
                                    Source: this.searchParams.source,
                                    Query: this.searchParams.query,
                                    MaxProducts: this.searchParams.maxProducts,
                                    SearchType: this.searchParams.searchType,
                                    Results: resultsSummaryData.length,
                                    ResultsData: JSON.stringify(resultsSummaryData),
                                    Name: $o.core.globalVariables.agentName
                                };
                                return [4, $o.saveRecord.botProductSearch(fields)];
                            case 1:
                                _a.sent();
                                setTimeout(function () {
                                    if ($o.core.agentsConnected) {
                                        _this_1.realTime.send(resultsSummaryData.length);
                                    }
                                }, 1500);
                                return [2];
                        }
                    });
                });
            };
            return ProductSearchManager;
        }(Interactions.BaseManager));
        ProductSearchFromBot.ProductSearchManager = ProductSearchManager;
        var Source;
        (function (Source) {
            Source[Source["Oct8neCatalog"] = 1] = "Oct8neCatalog";
            Source[Source["ShopCatalog"] = 2] = "ShopCatalog";
        })(Source || (Source = {}));
        var SearchType;
        (function (SearchType) {
            SearchType[SearchType["Keyword"] = 1] = "Keyword";
            SearchType[SearchType["Id"] = 2] = "Id";
            SearchType[SearchType["Reference"] = 3] = "Reference";
        })(SearchType || (SearchType = {}));
    })(ProductSearchFromBot = Interactions.ProductSearchFromBot || (Interactions.ProductSearchFromBot = {}));
})(Interactions || (Interactions = {}));

var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var Interactions;
(function (Interactions) {
    var ProductSearchFromBot;
    (function (ProductSearchFromBot) {
        var VisitorSideRealTimeConnector = (function (_super) {
            __extends(VisitorSideRealTimeConnector, _super);
            function VisitorSideRealTimeConnector() {
                return _super.call(this) || this;
            }
            VisitorSideRealTimeConnector.prototype.subscribeToRealTimeEvents = function () {
                var _this = this;
                oct8ne.registerBotResponse();
                $o.chat.hideTyping();
                $.connection.hubInterface.client.receiveProductSearchFromBot = function (search, delay) { return __awaiter(_this, void 0, void 0, function () {
                    return __generator(this, function (_a) {
                        if (delay) {
                            $o.delay.setGlobal(delay);
                        }
                        $o.botProductSearch.process(Interactions.BaseManager.objectAdapter(search, Interactions.Targets.Frontend), $o.delay.global);
                        return [2];
                    });
                }); };
            };
            VisitorSideRealTimeConnector.prototype.send = function (resultsCount) {
                if ($o.bot && $o.bot.responseChecker) {
                    $o.bot.responseChecker.startWaiting();
                }
                if ($o.core.isSignalRConnected()) {
                    $.connection.hubInterface.server.sendProductSearchResultsCallback(resultsCount, Core.Helpers.getTokenRoom());
                }
                else {
                    $o.visitorStart.restartConnection(null, true);
                    var checkConnection = setInterval(function () {
                        return __awaiter(this, void 0, void 0, function () {
                            var checkStartedBotOffline;
                            return __generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0:
                                        if (!$o.core.globalVariables.finishedVisitorRestartConnection) return [3, 3];
                                        clearInterval(checkConnection);
                                        if (!$o.bot) return [3, 2];
                                        return [4, $o.bot.connectOverflowAsync()];
                                    case 1:
                                        _a.sent();
                                        _a.label = 2;
                                    case 2:
                                        checkStartedBotOffline = setInterval(function () {
                                            return __awaiter(this, void 0, void 0, function () {
                                                return __generator(this, function (_a) {
                                                    if ($o.core.globalVariables.startedBotOffline) {
                                                        clearInterval(checkStartedBotOffline);
                                                        setTimeout(function () {
                                                            $.connection.hubInterface.server.sendProductSearchResultsCallback(resultsCount, Core.Helpers.getTokenRoom());
                                                        }, 4000);
                                                    }
                                                    return [2];
                                                });
                                            });
                                        }, 100);
                                        _a.label = 3;
                                    case 3: return [2];
                                }
                            });
                        });
                    }, 100);
                }
            };
            return VisitorSideRealTimeConnector;
        }(Interactions.RealTimeConnector));
        ProductSearchFromBot.VisitorSideRealTimeConnector = VisitorSideRealTimeConnector;
    })(ProductSearchFromBot = Interactions.ProductSearchFromBot || (Interactions.ProductSearchFromBot = {}));
})(Interactions || (Interactions = {}));

window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.visitorTransfer= {
        doTransfer: function (oldAgentToken, newAgentToken, room, textToTransfer, typeTransfer, oldAgentName, newAgentName) {

            if ($o.core.isSignalRConnected()) {
                $o.hubsOut.sendTransferVisitor(oldAgentToken, newAgentToken, room, textToTransfer, typeTransfer);
            }

             $o.saveRecord.transfer(oldAgentName, newAgentName, textToTransfer, typeTransfer);
        },

        doTransferVisitor: function (oldAgentToken, newAgentToken, room, textToTransfer, typeTransfer, oldAgentName, newAgentName, forceDeptIdNull, forceNoMoreAgentsResult) {

            if (forceNoMoreAgentsResult == null) {
                forceNoMoreAgentsResult = false;
            }

            if ($o.core.isSignalRConnected()) { $o.hubsOut.sendTransferVisitor2(oldAgentToken, newAgentToken, room, textToTransfer, typeTransfer, forceDeptIdNull, forceNoMoreAgentsResult);}

            $o.saveRecord.transfer(oldAgentName, newAgentName, textToTransfer, typeTransfer);
        },


        types: {
            MANUALTOAGENT: "MANUALTOAGENT",
            MANUALTOFIRST: "MANUALTOFIRST",
            INACTIVITYTOFIRST: "INACTIVITYTOFIRST",
            AGENTDISCONNECT: "AGENTDISCONNECT",
            VISITORSTART: "VISITORSTART",
            LIMITCHATEXCEEDED: "LIMITCHATEXCEEDED",
            TAKEVISITOR: "TAKEVISITOR",
            BOTTOFIRST: "BOTTOFIRST"
        }
    };
})(window);

window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.variablesVisitor = {
        sendCookiesToApi: function (nameFunction, arrayCookies) {
            for (key in arrayCookies) {
                switch (arrayCookies[key].cookie) {
                    case $o.cookies.status:
                        $o.variablesVisitor.status = arrayCookies[key].value;
                        break;
                    case $o.cookies.tokenVisitor:
                        $o.variablesVisitor.tokenVisitor = arrayCookies[key].value;
                        break;
                    case $o.cookies.tokenSession:
                        $o.core.globalVariables.room = arrayCookies[key].value;
                        break;
                    case $o.cookies.connection:
                        $o.variablesVisitor.connection = arrayCookies[key].value;
                        break;
                    case $o.cookies.coviewerStatus:
                        $o.variablesVisitor.coviewerStatus = arrayCookies[key].value;
                        break;
                    case $o.cookies.pendingProducts:
                        $o.variablesVisitor.pendingProducts = arrayCookies[key].value;
                        break;
                    case $o.cookies.statusBeforeMin:
                        $o.variablesVisitor.statusBeforeMin = arrayCookies[key].value;
                        break;
                    case $o.cookies.sessionWithoutAgent:
                        $o.variablesVisitor.sessionWithoutAgent = arrayCookies[key].value;
                        break;
                    case $o.cookies.sessionSummaryId:
                        $o.variablesVisitor.sessionSummaryId = arrayCookies[key].value;
                        break;
                    case $o.cookies.visitorOverFlow:
                        $o.variablesVisitor.visitorsOverflow = arrayCookies[key].value;
                        break;
                }
            }
             $o.core.doPostMessageToApi(nameFunction,  JSON.stringify(arrayCookies));
        },

        nameFunction: {
            deleteCookies: "DELETECOOKIESOCT8NE",
            saveCookies: "SAVECOOKIESOCT8NE"
        },
        tokenVisitor: "",
        tokenSession: "",
        status: "",
        coviewerStatus: "",
        domain: "",
        connection: "",
        pendingMessages: "",
        pendingProducts: "",
        statusBeforeMin: "",
        currencyVisitor: "",
        sessionWithoutAgent: "",
        sessionSummaryId: "",
        lastInteractionAFK: false,
        nowInteractionAFK: false,
        visitorLocation: "",
        visitorData: {},
        forcedHumanAttention: false,
        referenceTimeAFK: 0 //6 horas // en milisegundos. (60000 --> 1min , 240000 --> 4mins , 1800000 --> 30min)

    };


    //constantes
    oct8ne.cookies = {
        status: "STATUS",
        pixelSale: "OCT8NEPIXELSALE",
        tokenVisitor: "TOKENVISITOR",
        tokenSession: "TOKENSESSION",
        coviewerStatus: "COVIEWERSTATUS",
        sessionId: "SESSIONID",
        connection: "CONNECTION",
        pendingProducts: "PENDINGPRODUCTS",
        statusBeforeMin: "STATUSBEFOREMIN",
        sessionWithoutAgent: "SESSIONWITHOUTAGENT",
        sessionSummaryId: "SESSIONSUMMARYID",
        lastInteractionAFK: "LASTINTERACTIONAFK",
        visitorOverFlow: "OCT8NEOVERFLOW",
        firstEnter: "FIRSTENTER",
        allowedDepartmentsId: "ALLOWEDDEPARTMENTSID",
        forcedHumanAttention : "FORCEDHUMANATTENTION"
    };
})(window);
window.oct8ne = window.$o = window.oct8ne || {};
(function () {
    oct8ne.visitorPixel = {
        sales: {
            setCookie: function () {
                if ($o.core.globalVariables.domainId != null && $o.core.globalVariables.room != null) {

                    var pixelValue = {
                        room: $o.core.globalVariables.room,
                        date: new Date()
                    }

                    $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies,
                        [
                            { cookie: $o.cookies.pixelSale, value: JSON.stringify(pixelValue) }
                            //PREVIOUS FORMAT (before 08/22)
                            //{ cookie: $o.cookies.pixelSale, value: $o.core.globalVariables.room }
                        ]
                    );
                    return true;
                }
                return false;
            }
        }
    };
})(window);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.visitorRatings = {
        init: function () {
            $o.visitorRatings.events();
        },
        getQuestionsList: function () {
            $.post("/Ratings/GetQuestionsList", { domainId: $o.variablesVisitor.domain }, function (result) {
                $o.visitorRatings.printRatings(result);
            });
        },
        saveRatingAnswers: function () {

        },

        saveRateAgent: function (domain, tokenSession, idAgent, value, comment, agentName, typeRating) {
            var ratingMessageType = ""; 
            if (typeRating == $o.visitorRatings.TypeRatingGoodBad) {
                ratingMessageType = value ? "GAGoodRating" : "GABadRating";
            } else {
                if ($o.utils && $o.utils.customStarRatingsEvent) {
                    ratingMessageType = $o.utils.customStarRatingsEvent();
                } else {
                    ratingMessageType = parseInt(value) >= 4 ? "GAGoodRating" : "GABadRating";
                }
            }

            var event = {
                category: "Oct8ne",
                type: ratingMessageType,
                ratedAgent: agentName
            }
            $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(event));

            if (comment) {
                comment = comment.replaceAll("\n", ". ");
                comment = comment.trim();
            }

            $.post("/Ratings/SaveResponseAgentRating", { domainId: domain, tokenSession: tokenSession, agentId: idAgent, response: value, comment: comment, typeRating: typeRating });
            $o.saveRecord.rate(value, $o.core.globalVariables.otherName);
        },
        agentRated: false,
        TypeRatingGoodBad: 1,
        TypeRatingStars: 3

    };




})(window);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {

    oct8ne.recoverRecords = {

        getRecords: function (tokenVisitor, tokenSession, onlyMessages, showOnlyPreviousSessions) {
            var date = new Date();
            var timeZone = date.getTimezoneOffset();
            $o.recoverRecords.startingRecoverViewer = true;
            if (onlyMessages) {
                $("#oct8ne-chat-room").append('<div class="loading-message-interactions" id="loading-message-interactions"></div>');
            };
            var dataUrl = "Data/GetInteractionsBySessionFromVisitor";

            if ($o.utils && $o.utils.showPreviousSessionsOnVisitor) {
                dataUrl = "Data/GetInteractionsBySession";
            }
            if (tokenSession.startsWith("TEMP")) {
                var interactionsString = oct8ne.storage.local.get($o.core.localStorageTypes.Oct8neProvisionalInteractions);
                if (interactionsString) {
                    var interactions = JSON.parse(interactionsString);
                    if (interactions && !showOnlyPreviousSessions) {
                        $o.recoverRecords.recoverViewerFromVisitor(tokenVisitor, interactions, onlyMessages);
                    } else {
                        $o.recoverRecords.startingRecoverViewer = false;
                    }
                    if ($o.settings.allowTrackingProductsLite) $o.catalog.getProductsByUrls([$o.core.globalVariables.actualUrl]);
                    $o.core.doPostMessageToApi("COVIEWER_READY");
                }
            } else {
                $.post(dataUrl, { "sessionSummaryId": parseInt($o.core.globalVariables.sessionSummaryId), "tokenSession": tokenSession, "tokenVisitor": tokenVisitor, "recoverType": 1, "utcOffSet": timeZone }, function (records) {
                    if (records.DataInteractions && !showOnlyPreviousSessions) {
                        $o.recoverRecords.recoverViewerFromVisitor(tokenVisitor, records.DataInteractions, onlyMessages);
                    } else {
                        $o.recoverRecords.startingRecoverViewer = false;
                    }
                    if (records.LastSessionToken) {
                        $o.recoverRecords.loadPreviousButton(records.LastSessionToken, records.LastSessionSummaryId, records.DateLastSession);
                    }
                    if ($o.settings.allowTrackingProductsLite) $o.catalog.getProductsByUrls([$o.core.globalVariables.actualUrl]);
                    $o.core.doPostMessageToApi("COVIEWER_READY");
                }).fail(function () {
                    //controlar error recuperar mensajes de signalr
                    //y permitir entrada mensajes de visitor
                    $o.recoverRecords.startingRecoverViewer = false;
                });
            }

        },

        //  RECUPERA COVIEWER
        recoverViewerFromVisitor: function (token, visitorInteractions, onlyMessages) {           
            //$o.visitorSearch.showCoviewerTutorial();
            var changeNodeInteractionsIds = [],
                lastSearch = "",
                lastRelatedSearch = "",
                translationEnabled = false;

            //--- recorremos interacciones
            if (onlyMessages) {
                $o.speak.messages([]);
                $o.customForms.resetCollection();
            }
            var foundProductsByBotSearch = 0;
            var recoveredProductsFromBotSearch = 0;
            var botInteractionName = null;

            if (visitorInteractions) {
                var undeliveredInteractionIds = [];
                var checkDelivery;
                var i = 0;
                for (key in visitorInteractions) {
                    checkDelivery = false;
                    i++;
                    var visitorInteraction = visitorInteractions[key];
                    visitorInteraction.Tokens = {
                        Sender: (visitorInteraction.sentBy != "V") ? token : $o.core.globalVariables.myToken,
                        Receiver: (visitorInteraction.sentBy != "V") ? token : $o.core.globalVariables.myToken,
                    };
                    try {
                        visitorInteraction.Fields = JSON.parse(visitorInteraction.Fields);
                    } catch {
                        visitorInteraction.Fields = visitorInteraction.Fields;
                    }

                    //CHAT
                    if (visitorInteraction.Type == "Chat") {
                        $o.recoverRecords.hidePreviousInputChatForms();
                        checkDelivery = true;

                        var chatRecord = {
                            Body: visitorInteraction.Fields.Content,
                            Tokens: visitorInteraction.Tokens,
                            SentBy: visitorInteraction.SentBy,
                            Name: visitorInteraction.Fields.Name,
                            Id: visitorInteraction.Fields.Id,
                            Time: visitorInteraction.CreatedAt,
                            Type: visitorInteraction.Fields.Type,
                            DenyVisitorTyping: visitorInteraction.Fields.DenyVisitorTyping
                        };
                        if ($o.chat.chatsInConversation < $o.chat.chatsForSendingAttendedEvent) {
                            ++$o.chat.chatsInConversation;
                            if ($o.chat.chatsInConversation >= $o.chat.chatsForSendingAttendedEvent) {
                                $o.chat.sentAttendedToAnalytics = true;
                            }
                        }

                        //This is used for chats from with upload button
                        if (visitorInteraction.Fields.Type == "singleFile") {
                            $o.recoverRecords.lastUploadChatId = visitorInteraction.Fields.Id;
                            $o.chat.toogleDenyVisitorTyping(true);
                        }
                        //This is used for chats from with upload button

                        $o.chat.updateMessage(chatRecord, "recoverfromV");
                        if ($o.variablesVisitor.status == "Attending") $o.visitorStart.changeHeaderChatToChatting();
                    }

                    //TRANSLATION
                    else if (visitorInteraction.Type == "Translation") {
                        $o.translate.toggleTranslation(visitorInteraction.Fields.Status, visitorInteraction.Fields.AgentLanguage, visitorInteraction.Fields.VisitorLanguage);
                    }
                    //ITEMS
                    //search product from bot 
                    //agrupamos productos si hay varios
                    else if (visitorInteraction.Type == "BotProductSearch") {
                        var parsedResults = JSON.parse(visitorInteraction.Fields.ResultsData);
                        if (parsedResults.length > 1) {
                            foundProductsByBotSearch = parsedResults.length;
                            recoveredProductsFromBotSearch = parsedResults.length;
                            botInteractionName = visitorInteraction.Fields.Name;
                        }
                        for (var i = 0; i < parsedResults.length; i++) {
                            $o.carousel.sendProductToCarousel(parsedResults[i], $o.carousel.lists.VIEWED, null, "recover");
                        }
                    }
                    else if (!onlyMessages && (visitorInteraction.Type == "ViewedItem") || (visitorInteraction.Type == "MyCartItem") || (visitorInteraction.Type == "MyListItem") || (visitorInteraction.Type == "UploadItem") || (visitorInteraction.Type == "CatalogItem") || (visitorInteraction.Type == "TrackItem") || (visitorInteraction.Type == "DeleteCartItem")) {
                        if (visitorInteraction.Type == "DeleteCartItem") {
                            $o.recoverRecords.removedFromCartInteractions.push(visitorInteraction);
                        } else {

                            //parseamos info
                            var list = "";
                            if (visitorInteraction.Type == "MyCartItem") list = $o.carousel.lists.MYCART;
                            if (visitorInteraction.Type == "MyListItem") list = $o.carousel.lists.MYLIST;
                            if ((visitorInteraction.Type == "UploadItem") || (visitorInteraction.Type == "CatalogItem") || (visitorInteraction.Type == "TrackItem") || (visitorInteraction.Type == "ViewedItem")) list = $o.carousel.lists.VIEWED;
                            var itemRecord = {
                                InternalId: visitorInteraction.ProductId,
                                ListType: list,
                                Tokens: visitorInteraction.Tokens,
                                SentBy: visitorInteraction.SentBy,
                                Thumbnail: visitorInteraction.Fields.Thumbnail,
                                URLMedia: visitorInteraction.Fields.Thumbnail,
                                Time: visitorInteraction.CreatedAt,
                                Title: visitorInteraction.Fields.Title,
                                Order: parseInt(key),
                                Type: visitorInteraction.Type
                            };
                            $o.recoverRecords.changeNodeInteractions.push(itemRecord);
                            //\parseamos info
                            if (visitorInteraction.Type != "MyCartItem") {
                                //si no esta en la lista de nodos vistos lo aadimos
                                //SOLO se aade de IDs si no esta en la lista
                                if (($.inArray(itemRecord.InternalId, changeNodeInteractionsIds) == -1) && (visitorInteraction.Type != "TrackItem")) {
                                    changeNodeInteractionsIds.push(itemRecord.InternalId);
                                }
                                if (foundProductsByBotSearch == 0) {
                                    if (visitorInteraction.SentBy == "A" && visitorInteraction.Fields.FromAgentSearch) {
                                        $o.productsChat.sentProductByAgent(itemRecord);
                                    }
                                } else {
                                    if (foundProductsByBotSearch == recoveredProductsFromBotSearch) {
                                        itemRecord.Name = botInteractionName;
                                        $o.productsChat.sentManyProductsByAgent(itemRecord);

                                    }
                                    --recoveredProductsFromBotSearch;
                                    if (recoveredProductsFromBotSearch == 0) {
                                        foundProductsByBotSearch = 0;
                                    }
                                }

                                $o.carousel.addProductInfoToList(itemRecord, itemRecord.ListType);

                                if (visitorInteraction.Type == "UploadItem") {
                                    var product = $o.carousel.getProductFromUpload(itemRecord.InternalId, itemRecord.Thumbnail, itemRecord.SentBy);
                                    $o.fullProducts.addProductToCollection(product);
                                }
                            } else {
                                $o.recoverRecords.addToCartInteractions.push(itemRecord);
                            }
                            $o.carousel.sentProductsToAnalytics = true;
                        }
                    }

                    //QUERY
                    else if (visitorInteraction.Type == "Query" && !onlyMessages) {
                        var queryType = visitorInteraction.Fields.Type;
                        var term = visitorInteraction.Fields.Term;
                        if (queryType == "Catalog") {
                            lastRelatedSearch = term;
                        }
                        if (queryType == "Query") {
                            lastSearch = $o.recoverRecords.searchInteractionToObject(term);
                        }
                    }

                    //CANNED
                    else if (visitorInteraction.Type == "Canned") {
                        checkDelivery = true;
                        var responsed = false;
                        var cannedRecord = {
                            Body: visitorInteraction.Fields.Content,
                            Tokens: visitorInteraction.Tokens,
                            SentBy: visitorInteraction.SentBy,
                            Type: visitorInteraction.Fields.SubType,
                            Name: visitorInteraction.Fields.Name,
                            Id: visitorInteraction.Fields.Id,
                            Time: visitorInteraction.CreatedAt,
                            Response: visitorInteraction.Fields.Response
                        };
                        if ((visitorInteraction.Fields.SubType == $o.canned.type.NOMOREAGENTS) || (visitorInteraction.Fields.SubType == $o.canned.type.AGENTSBUSY) || (visitorInteraction.Fields.SubType == $o.canned.type.OVERBOOKING)) { responsed = true; }
                        $o.canned.createCanned(cannedRecord, responsed);

                        if (visitorInteraction.Fields.SubType == $o.canned.type.TRANSFER) {
                            $o.chat.toogleDenyVisitorTyping(false);
                        }
                    }

                    else if (visitorInteraction.Type == "Gdpr") {
                        checkDelivery = true;
                        var gdprRecord = {
                            Body: visitorInteraction.Fields.Content,
                            Tokens: visitorInteraction.Tokens,
                            SentBy: visitorInteraction.SentBy,
                            Type: visitorInteraction.Fields.SubType,
                            Name: visitorInteraction.Fields.Name,
                            Id: visitorInteraction.Fields.Id,
                            Time: visitorInteraction.CreatedAt,
                            Response: visitorInteraction.Fields.Response
                        };

                        $o.canned.createGdpr(gdprRecord, true);

                    }

                    //RESPUESTA CANNED
                    else if (visitorInteraction.Type == "CannedResponse") {

                        checkDelivery = true;
                        var cannedResponseRecord = {
                            Id: visitorInteraction.Fields.Id,
                            Response: visitorInteraction.Fields.Response
                        };
                        $o.canned.updateCannedWithResponse(cannedResponseRecord);
                    }

                    //FORM
                    else if (visitorInteraction.Type == "Form") {
                        $o.recoverRecords.hidePreviousInputChatForms();
                        checkDelivery = true;
                        var formRecord = {
                            Body: visitorInteraction.Fields.Content,
                            Tokens: visitorInteraction.Tokens,
                            SentBy: visitorInteraction.SentBy,
                            Name: visitorInteraction.Fields.Name,
                            Time: visitorInteraction.CreatedAt,
                            Id: visitorInteraction.Fields.Id,
                            Type: visitorInteraction.Fields.SubType,
                            Response: visitorInteraction.Fields.Response
                        };
                        $o.forms.createForm(formRecord, true);
                    }

                    //RESPUESTA FORM
                    else if (visitorInteraction.Type == "FormResponse") {
                        var responseRecord = {
                            Id: visitorInteraction.Fields.Id,
                            Response: JSON.parse(visitorInteraction.Fields.Response)
                        };
                        $o.forms.updateFormWithResponse(responseRecord);
                    }

                    //DOCUMENT LINK
                    else if (visitorInteraction.Type == "DocumentLink") {
                        checkDelivery = true;
                        var doc = {
                            Body: visitorInteraction.Fields.Url,
                            Room: $o.core.globalVariables.room,
                            SentBy: visitorInteraction.SentBy,
                            Type: visitorInteraction.Fields.Extension,
                            Category: "DOCS",
                            Id: $o.tools.generateRandomId()
                        };
                        $o.forms.createDocs(doc, true);
                    }

                    //IMAGE
                    else if (visitorInteraction.Type == "Image" && !onlyMessages) {
                        var imageRecord = {
                            InternalId: visitorInteraction.ProductId,
                            URLMedia: visitorInteraction.Fields.Thumbnail,
                            Scope: visitorInteraction.Fields.Scope,
                            Order: parseInt(key)
                        };
                        $o.recoverRecords.lastImageChange = imageRecord;
                    }

                    //PIN
                    else if (visitorInteraction.Type == "Pin" && !onlyMessages) {
                        var pin = {
                            Coords: {
                                PosX: visitorInteraction.Fields.CoordX,
                                PosY: visitorInteraction.Fields.CoordY
                            },
                            InternalId: visitorInteraction.ProductId,
                            Scope: visitorInteraction.Fields.Scope,
                            Type: "P",
                            Id: visitorInteraction.Fields.Id
                        };
                        $o.pin.pinsHistory.push(pin);
                    }

                    //UNDO
                    else if (visitorInteraction.Type == "Undo" && !onlyMessages) {
                        $o.tools.deletePin(visitorInteraction.Fields.Id);
                    }

                    //ZOOM
                    else if (visitorInteraction.Type == "Zoom" && !onlyMessages) {
                        var zoomRecord = {
                            InternalId: visitorInteraction.ProductId,
                            Level: visitorInteraction.Fields.Level,
                            Scope: visitorInteraction.Fields.Scope,
                            Order: parseInt(key)
                        };
                        $o.recoverRecords.lastZoomChange = zoomRecord;
                    }

                    //SIDEBUBBLE
                    else if (visitorInteraction.Type == "SideBubble") {
                        $o.recoverRecords.hidePreviousInputChatForms();
                        $o.sideBubbles.recover(visitorInteraction);
                    }

                    //CHOICE
                    else if (visitorInteraction.Type == "Choice") {
                        $o.recoverRecords.hidePreviousInputChatForms();
                        $o.choices.recover(visitorInteraction);
                    }
                    else if (visitorInteraction.Type == "ChoiceResponse") {
                        $o.choiceResponses.recover(visitorInteraction);
                    }
                    else if (visitorInteraction.Type == "CustomForm") {
                        $o.recoverRecords.hidePreviousInputChatForms();
                        $o.customForms.recover(visitorInteraction);
                    }
                    else if (visitorInteraction.Type == "CustomFormResponse") {
                        $o.customFormsResponses.recover(visitorInteraction);
                    }


                    if (checkDelivery && visitorInteraction.DeliveryDate == null && visitorInteraction.SentBy == "A") {
                        undeliveredInteractionIds.push(visitorInteraction.Id)
                    }

                }
                //--FIN de recorrer interaccions


                if (undeliveredInteractionIds.length) {
                    //$.ajax({
                    //    type: "POST",
                    //    url: "/Data/SaveDeliveryDate",
                    //    traditional: true,
                    //    data: {
                    //        tokenSession: $o.core.globalVariables.room,
                    //        tokenVisitor: $o.core.globalVariables.myToken,
                    //        interactionIds: undeliveredInteractionIds
                    //    },
                    //    async: true
                    //})
                }

                if (!onlyMessages) {
                    //recupera busqueda
                    if (lastSearch != "") {
                        $o.search.sortedBy = lastSearch.orderby;
                        $o.search.direction = lastSearch.dir;
                        $o.search.doSearch(lastSearch.term, undefined, "RECOVER");
                        $("#search-term").val(lastSearch.term);
                    } else if (lastRelatedSearch != "" && lastSearch == "") {
                        //$o.platform.searchProductsByCategory(lastRelatedSearch, "RECOVER");
                        $("#search-term").val("");
                    }

                    $o.recoverRecords.cartManagement();

                    //recorremos los productos vistos y recopilamos los que no se han visto anteriormente
                    //sirve por si se han visto varios productos rapido sin abrir oct8ne
                    if ($o.enterData.productsViewed.length) {
                        $o.recoverRecords.newProductsFromTrackingBar(changeNodeInteractionsIds);
                    };

                    $o.recoverRecords.showCurrentProduct();

                    $o.enterData.idProduct = "";
                } else {
                    $("#loading-message-interactions").remove();
                    $("#oct8ne-chat-room").animate({ scrollTop: 10000 }, 1000);
                }

                $o.recoverRecords.startingRecoverViewer = false;
                $.each($o.chat.queueChats, function (i) {
                    window.oct8ne.chat.updateMessage($o.chat.queueChats[i], "recoverfromV");
                });
            }

            var customerDataConditions = false;
            if (!onlyMessages && $o.platform) customerDataConditions = true;
            if (!$o.utils || !$o.utils.doIntensiveCostumerDataRequests) {
                customerDataConditions = customerDataConditions && $o.variablesVisitor.status != "Searching";
            }
            if (customerDataConditions && $o.platform) {
                // console.log("from-recover-records");
                $o.platform.addPlatformLogin();
            }
        },

        showCurrentProduct: function () {

            // decidimos el producto que se ha de mostrar en el visor
            var lastInteraction = $o.recoverRecords.changeNodeInteractions[$o.recoverRecords.changeNodeInteractions.length - 1];
            //si hay productos de tracking bar nuevos o ( que no coinciden con el ultimo visto o no hay vistos anteriormente)
            if (($o.enterData.idProduct) && ($o.enterData.idProduct != "") && ($o.enterData.idProduct != "undefined") && (((lastInteraction != undefined) && ($o.enterData.idProduct != lastInteraction.InternalId) && ($o.core.globalVariables.pageType == "Product")) || (lastInteraction == undefined) || $o.core.globalVariables.enterType == $o.core.enterType.RECOVERSESSION)) {
                if ($o.platform) { $o.platform.getFullProductInfo($o.enterData.idProduct, $o.carousel.lists.VIEWED); }
            } else {

                //si no hay productos de tracking bar o es igual al de la ltima interaccion cojemos la ultima interaccion
                if (lastInteraction) {
                    var imageChangeScope = 0;

                    //si hay cambio de imagen en el producto a mostrar
                    if (($o.recoverRecords.lastImageChange != "") && ($o.recoverRecords.lastImageChange.InternalId == lastInteraction.InternalId) && ($o.recoverRecords.lastImageChange.Order > lastInteraction.Order)) {
                        imageChangeScope = $o.recoverRecords.lastImageChange.Scope - 1;
                    }

                    //si hay cambio de zoom en el producto a mostrar resetea al agente
                    if ($o.core.isSignalRConnected()) {
                        if ($o.recoverRecords.lastZoomChange != "" && $o.recoverRecords.lastZoomChange.InternalId == lastInteraction.InternalId && $o.recoverRecords.lastZoomChange.Order > lastInteraction.Order) {
                            if ((imageChangeScope != 0 && $o.recoverRecords.lastZoomChange.Order > $o.recoverRecords.lastImageChange.Order) || (imageChangeScope == 0)) {
                                if ($o.core.isSignalRConnected()) $o.hubsOut.sendResetImage();
                            }
                        }
                    }
                    if ((lastInteraction.Type == "CatalogItem") || (lastInteraction.Type == "UploadItem")) {
                        $o.carousel.sentProductToCanva(lastInteraction.InternalId, "RECOVER");
                    } else {
                        if ($o.platform) { $o.platform.getFullProductInfo(lastInteraction.InternalId, lastInteraction.List, "RECOVER", imageChangeScope); }

                    }
                }
            };
        },

        newProductsFromTrackingBar: function (changeNodeInteractionsIds) {
            var productsFromPage = $o.enterData.productsViewed.split(",");
            $.each(productsFromPage, function (w) {
                var productSeenBefore = false;
                $.each(changeNodeInteractionsIds, function (x) {
                    if (productsFromPage[w] == changeNodeInteractionsIds[x]) {
                        productSeenBefore = true;
                    }
                });
                if (!productSeenBefore) {
                    $o.recoverRecords.newProductsFromPage.push(productsFromPage[w]);
                }
            });
            $o.enterData.productsViewed = "";
            //FALTA MOSTRAR newProductsFromPage!!!!!!!!!!!!!!!!!!!!!!
        },

        loadPreviousButton: function (lastSession, sessionSummaryId, dateLastSession) {
            $("#oct8ne-chat-room ul").prepend("<li class='recover-chat CHTxt5 CHBkg3' id='get-previous-chat' data-token='" + lastSession + "'  data-sessionSummaryId='" + sessionSummaryId + "' onclick='$o.recoverRecords.displayPreviousChats()'><p class='message'>" + culture.coviewer.ViewPreviousChatButton + "</p></li>");
            $o.recoverRecords.previousChatDateTime = dateLastSession;
        },

        hidePreviousInputChatForms: function () {
            if ($o.recoverRecords.lastUploadChatId != null) {
                $("#" + $o.recoverRecords.lastUploadChatId).parent().addClass("file-uploaded");
                $o.recoverRecords.lastUploadChatId = null;
            }
        },

        displayPreviousChats: function () {
            var tokenSession = $("#get-previous-chat").attr("data-token");
            var sessionSummaryId = $("#get-previous-chat").attr("data-sessionSummaryId");
            var date = new Date();
            var timeZone = date.getTimezoneOffset();

            $.post("../Data/GetChatInteractionsBySessionFromVisitor", { "tokenSession": tokenSession, "sessionSummaryId": sessionSummaryId, "utcOffSet": timeZone, "domainId": $o.core.globalVariables.domainId, "locale": $o.core.globalVariables.locale }, function (records) {
                $("#get-previous-chat").remove();
                var timeToDisplay = $o.recoverRecords.previousChatDateTime.split(" ");
                timeToDisplay = timeToDisplay[0];

                if (records) {
                    var chatBubble;
                    var chatsHtml = "<li class='recovered recovered-time'>" + culture.coviewer.StartPreviousChatDate + $o.recoverRecords.previousChatDateTime + "</li>";
                    $.each(records.DataInteractions, function (i) {
                        records.DataInteractions[i].Fields = JSON.parse(records.DataInteractions[i].Fields);

                        if (records.DataInteractions[i].Type == "FormResponse") {
                            var responses = JSON.parse(records.DataInteractions[i].Fields.Response);
                            var responsesItems = "";
                            $.each(responses, function (i) {
                                responsesItems += "<p>" + responses[i] + "</p>";
                            });

                            var responsesHtml = responsesItems;
                            chatBubble = "<li class='recovered recovered-" + records.DataInteractions[i].Type.toLowerCase() + "'>";
                            chatBubble += "<div class='recovered-holder'><p><span>" + records.DataInteractions[i].CreatedAt + "</span>" + responsesHtml + "</p></div></li>";
                            chatsHtml += chatBubble;
                        }

                        if ((records.DataInteractions[i].Type != "FormResponse") && (records.DataInteractions[i].Fields.Content.Original)) {
                            chatBubble = "<li class='recovered recovered-" + records.DataInteractions[i].Type.toLowerCase() + "'>";

                            if (records.DataInteractions[i].Type == "Canned") {
                                chatBubble += "<div class='recovered-holder'><p>" + records.DataInteractions[i].Fields.Content.Original + "<span>" + records.DataInteractions[i].CreatedAt + "</span></p></div></li>";

                            } else if (records.DataInteractions[i].Type == "Gdpr") {
                                chatBubble += "<div class='recovered-holder-" + records.DataInteractions[i].Type.toLowerCase() + "'><p>" + records.DataInteractions[i].Fields.Content.Original + "</p></div></li>";
                            } else if (records.DataInteractions[i].Type == "Chat") {
                                var text = "";
                                var body = records.DataInteractions[i].Fields.Content;
                                if (body.hasOwnProperty("Translated")) {
                                    text = body.Original;
                                    if (body.Translated != false) text += " / <i>" + body.Translated + "</i>";
                                }
                                chatBubble += "<div class='recovered-bubble " + records.DataInteractions[i].SentBy + "'><div class='recovered-holder'><p>" + text + "</p><p> <span>" + records.DataInteractions[i].CreatedAt + "</span></p ></div ></div ></li > ";

                            }
                            chatsHtml += chatBubble;
                        }
                    });

                    chatsHtml += "<li class='recovered recovered-time'>" + culture.coviewer.EndPreviousChatDate + timeToDisplay + "</li>";
                    $("#oct8ne-chat-room ul").prepend(chatsHtml);
                    if (records.LastSessionToken) $o.recoverRecords.loadPreviousButton(records.LastSessionToken, records.LastSessionSummaryId, records.DateLastSession);
                    $o.chat.noUpdateScroll = true;
                } else {
                    //console.log("There is no chat to recover");
                }
            });
        },

        cartManagement: function () {
            //--- gestion cart
            var nodesToDeleteFromCart = [];
            $.each($o.recoverRecords.removedFromCartInteractions, function (h) {
                $.each($o.recoverRecords.addToCartInteractions, function (j) {
                    if ($o.recoverRecords.removedFromCartInteractions[h].ProductId == $o.recoverRecords.addToCartInteractions[j].InternalId) {
                        nodesToDeleteFromCart.push(j);
                    };
                });
            });
            $.each(nodesToDeleteFromCart, function (m) {
                $o.recoverRecords.addToCartInteractions.splice(nodesToDeleteFromCart[m], 1);
            });

            //$.each($o.recoverRecords.addToCartInteractions, function (x) {
            //    $o.recoverRecords.changeNodeInteractions.push($o.recoverRecords.addToCartInteractions[x]);
            //});
        },

        searchInteractionToObject: function (searchString) {
            var pairs = (searchString).split('&');
            var result = {};
            for (var i in pairs) {
                var pair = pairs[i].split('=');
                if (!pair[1]) {
                    result["term"] = decodeURIComponent(pair[0] || '');
                } else {
                    result[pair[0].toLowerCase()] = decodeURIComponent(pair[1] || '');
                }
            }
            return result;
        },

        interactionsList: {
            agent: "",
            visitors: {},
            fromTransfer: []
        },

        changeNodeInteractions: [],
        lastImageChange: "",
        lastZoomChange: "",
        addToCartInteractions: [],
        newProductsFromPage: [],
        removedFromCartInteractions: [],
        startingRecoverViewer: false,
        lastUploadChatId: null
    };
})(window);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.visitorSearch = {
        init: function () {
            $o.visitorSearch.events();

            $("#send-access-form-info").on("click", function () {
                var validDepts = true, validInfo = false, errorClass = "data-contact-error";

                if ($o.visitorStart.showDepartmentsSelect) {
                    $o.visitorStart.selectedDepartment = $("#select-department").val();
                    if ($o.visitorStart.selectedDepartment == "null") {
                        $("#select-department").addClass(errorClass);
                        validDepts = false;
                    } else {
                        $("#select-department").removeClass(errorClass);
                        validDepts = true;
                    }
                }
                if ($o.settings.showAccessForm) {
                    var regex = /^[a-zA-Z0-9._-]+([+][a-zA-Z0-9._-]+){0,1}[@][a-zA-Z0-9._-]+[.][a-zA-Z]{2,6}$/;
                    $o.visitorSearch.accesFormNameInput = $("#access-form-name"),
                        $o.visitorSearch.accesFormEmailInput = $("#access-form-email"),
                        $o.visitorSearch.accesFormMessageInput = $("#access-form-message");

                    if ($o.visitorSearch.accesFormNameInput.val().length <= 0) $o.visitorSearch.accesFormNameInput.addClass(errorClass);
                    else $o.visitorSearch.accesFormNameInput.removeClass(errorClass);

                    if ($o.visitorSearch.accesFormEmailInput.val().length <= 0) $o.visitorSearch.accesFormEmailInput.addClass(errorClass);
                    else if (!regex.test($o.visitorSearch.accesFormEmailInput.val().trim())) $o.visitorSearch.accesFormEmailInput.addClass(errorClass);
                    else $o.visitorSearch.accesFormEmailInput.removeClass(errorClass);

                    if ($("#access-form-phone").is(":visible")) { //campo opcional para Sellam y Fodeocci (if en vista)
                        $o.visitorSearch.accesFormPhoneInput = $("#access-form-phone");
                        var regexPhone = /^(\(?\+?[0-9]*\)?)?[0-9_\- \(\)]*$/;
                        if ($o.visitorSearch.accesFormPhoneInput.val().length <= 0) {
                            $o.visitorSearch.accesFormPhoneInput.addClass(errorClass);
                        } else if (!regexPhone.test($o.visitorSearch.accesFormPhoneInput.val().trim())) {
                            $o.visitorSearch.accesFormPhoneInput.addClass(errorClass);
                        } else {
                            $o.visitorSearch.accesFormPhoneInput.removeClass(errorClass);
                        }

                    }


                    if ($o.visitorSearch.accesFormMessageInput.val().length <= 0) $o.visitorSearch.accesFormMessageInput.addClass(errorClass);
                    else $o.visitorSearch.accesFormMessageInput.removeClass(errorClass);

                    if ($o.visitorSearch.accesFormNameInput.val().length > 0 && $o.visitorSearch.accesFormEmailInput.val().length > 0 && $o.visitorSearch.accesFormMessageInput.val().length > 0 && ($o.visitorSearch.accesFormPhoneInput ? $o.visitorSearch.accesFormPhoneInput.val().length > 0 : true)) {
                        if (regex.test($o.visitorSearch.accesFormEmailInput.val().trim())) {
                            validInfo = true;
                            if ($("#access-form-phone").is(":visible")) {
                                if (!regexPhone.test($o.visitorSearch.accesFormPhoneInput.val().trim())) {
                                    validInfo = false;
                                }
                            }
                        }
                    }
                    var checkboxPolicy = $("#checkbox-conditions-access");
                    if (checkboxPolicy.length) {
                        if (!checkboxPolicy.is(":checked")) {
                            validInfo = false;
                            $("#info-wrapper .checkbox-conditions-wrapper").addClass("not-accepted");
                        } else {
                            $("#info-wrapper .checkbox-conditions-wrapper").removeClass("not-accepted");
                        }
                    }
                } else {
                    validInfo = true;
                }

                if (validInfo && validDepts) {
                    if ($o.visitorStart.showDepartmentsSelect) {
                        var event = {
                            category: "Oct8ne",
                            type: "GASelectedDepartment",
                            department: $("#select-department option:selected").text()
                        }
                        $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(event));
                    }
                    if ($o.settings.showAccessForm) {
                        $o.chat.pendingAccessFormMessage = {
                            name: $o.visitorSearch.accesFormNameInput.val(),
                            email: $o.visitorSearch.accesFormEmailInput.val(),
                            message: $o.visitorSearch.accesFormMessageInput.val()
                        };
                        if ($("#access-form-phone").is(":visible")) { //Aadimos phone si lleva
                            $o.chat.pendingAccessFormMessage.phone = $o.visitorSearch.accesFormPhoneInput.val();
                        }
                    }

                    $o.visitorSearch.accesFormActive = true;
                    $o.visitorSearch.connectFromAccessForm = true;
                    var showEmailUs = false;
                    if ($o.utils && $o.utils.rewriteVisitorStartResult) {
                        showEmailUs = $o.utils.rewriteVisitorStartResult();
                    }

                    var deptId = $o.visitorStart.assignedDepartment.Id || $o.visitorStart.selectedDepartment || 0;

                    $.post("Oct8ne/AgentsConnected", { domainId: $o.variablesVisitor.domain, deptId: deptId, isReconnect: false }, function (result) {
                        $o.core.agentsConnected = result == "True";
                        $o.visitorStart.connectVisitor(true).then(function (connectionResult) {
                            $o.visitorStart.visitorStart($o.core.globalVariables.enterType);
                            if (!$o.core.agentsConnected && connectionResult == false) {
                                $o.visitorStart.agentsDisconnectedChangesUI();
                                //    //$o.inactivityAgent.clearTimerInterval();
                                //    //$o.inactivity.setVisitorActive();
                                //    //$(".connecting-agent,.agent-info").hide();
                                //    //$o.inactivity.disableChatInputUI();
                                //    ////$o.canned.sendCanned($o.canned.type.NOMOREAGENTS);
                                $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [
                                    { cookie: $o.cookies.sessionWithoutAgent, value: true }
                                ]);
                            }
                        });
                    });

                    if ($o.settings.showAccessForm) {
                        $("#email-us-email").val($o.visitorSearch.accesFormEmailInput.val());
                        $("#email-us-name").val($o.visitorSearch.accesFormNameInput.val());
                        $("#email-us-comments").text($o.visitorSearch.accesFormMessageInput.val());
                    }
                    $("#access-form-wrapper").hide();

                    if ($o.core.globalVariables.enterType !== $o.core.enterType.PINCODE) {
                        if (showEmailUs !== true) {
                            $o.visitorStart.showChatWrapperUI();
                        }
                    }
                }
            });
        },

        //Send canned message in chat when user choose just looking TODO: revisar NOT USING 
        sendJustLookingChatMessage: function (message, justLookingButton) {

            if ($o.utils && $o.utils.changeWelcomeMessage) {
                message = $o.utils.changeWelcomeMessage(message);
            }

            $o.visitorSearch.sendJustLookingChatMessageUI(message, justLookingButton);
        },
        sendGdprMessage: function (message) {
            $o.visitorSearch.sendGdprMessageUI(message);
        },
        sendVipChatMessage: function (message) {
            $o.visitorSearch.sendVipChatMessageUI(message);
        },

        //Change User's status to "Waiting" in activity dashboard.
        changeToWaitingStatus: function (message, callback) {
            $o.inactivity.setVisitorActive();
            var queryString = "statusVisitor=" + $o.variablesVisitor.status
                + "&tokenVisitor=" + $o.variablesVisitor.tokenVisitor
                + "&tokenSession=" + $o.core.globalVariables.room
                + "&domainId=" + $o.variablesVisitor.domain + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId;
            if ($.connection.hub.state == $.signalR.connectionState.disconnected) {
                $.post("Oct8ne/AgentsConnected?" + queryString, { domainId: $o.variablesVisitor.domain, deptId: $o.visitorStart.assignedDepartment.Id, isReconnect: true }, function (agentsConnected) {
                    $o.visitorSearch.enableSelectResult = false;
                    if (agentsConnected == "True") {
                        $o.core.agentsConnected = true;
                        $o.visitorStart.restartConnection(null, true);
                        if (callback) {
                            callback($o.core.globalVariables.room);
                        }
                    } else {
                        $o.core.agentsConnected = false;
                        $o.canned.sendCanned($o.canned.type.NOMOREAGENTS);
                        $o.inactivity.disableChatInputUI();
                        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [
                            { cookie: $o.cookies.sessionWithoutAgent, value: true }
                        ]);
                    }
                });
            } else {
                var deptId = $o.visitorStart.assignedDepartment.Id || 0;
                $.post("Oct8ne/AgentsConnectedWithReasonTransfer?" + queryString, { domainId: $o.variablesVisitor.domain, deptId: deptId, isReconnect: true }, function (result) {
                    if (result.agentsConnected == true) {
                        $.connection.hubInterface.server.sendStatus({ tokenVisitor: $o.core.globalVariables.myToken, tokenSession: $o.core.globalVariables.room, status: "Waiting" }).done(
                            function () {
                                $o.core.hasBeenWaiting = true;
                                if (message) $o.chat.sendMessagesBeforeConnected(message);
                                if (callback) {
                                    callback($o.core.globalVariables.room);
                                }
                            });
                        if (result.reason === "LIMITCHATEXCEEDED") {
                            var queryString = "?tokenSession=" + $o.core.globalVariables.room
                                + "&tokenVisitor=" + $o.variablesVisitor.tokenVisitor
                                + "&statusVisitor=" + $o.variablesVisitor.status
                                + "&idDept=" + deptId
                                + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId
                                + "&typeTransfer=" + result.reason;
                            $.post("/Oct8ne/CreateSessionSameToken" + queryString);
                        }
                    } else {
                        //  if (!$o.forms.sessionToEmail.sendEmail) $o.forms.receiveInvitation("reconnect-session-email", "invitation");
                        // else $o.forms.receiveInvitation("reconnect-session", "invitation");
                        $o.canned.sendCanned($o.canned.type.NOMOREAGENTS);
                        $o.inactivity.disconnectCommonActions();
                        $o.inactivity.stopProcess();
                        $o.inactivity.disableChatInputUI();
                        $o.visitorStart.changeStatus("?" + queryString, "Searching");
                        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [
                            { cookie: $o.cookies.sessionWithoutAgent, value: true }
                        ]);

                        var queryStringSameToken = "?tokenSession=" + $o.core.globalVariables.room
                            + "&tokenVisitor=" + $o.variablesVisitor.tokenVisitor
                            + "&statusVisitor=" + $o.variablesVisitor.status
                            + "&idDept=" + $o.visitorStart.assignedDepartment.Id
                            + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId
                            + "&typeTransfer=" + result.reason;
                        $.post("/Oct8ne/CreateSessionSameToken" + queryStringSameToken);
                        //oct8ne.log("test transfer","warn");
                    }
                });
            }
            $o.visitorSearch.changeToWaitingStatusUI();

            //  $o.inactivityAgent.init();
        },

        getAgentStatusAfterWaiting: function (data) {
            //Esta en la overbooking list

            if (data.Visitor.Agent.AgentId == 0) {
                $o.canned.sendCanned($o.canned.type.OVERBOOKING);
                $o.inactivity.disableChatInputUI();
            }
            //l'agent que tenia assignat ja no esta disponible
            else {
                $o.core.globalVariables.otherToken = data.Visitor.Agent.Token;
                // $("#other-token").val(data.Visitor.Agent.Token);
                $o.core.globalVariables.otherName = data.Visitor.Agent.Name;
                // $("#other-name").val(data.Visitor.Agent.FirstName);
                $o.visitorSearch.assignedAgentName = data.Visitor.Agent.Name;
                $o.visitorSearch.otherAgentAfterWaitingUI(data.Visitor.Agent);
                //$o.log("Llenado de token");
            }


        },

        //Change status from overbooking to waiting.
        changeStatusOverbookingToWaiting: function (visitor) {
            $o.canned.sendCanned($o.canned.type.AGENTAVAILABLE, visitor.Agent.Name);
            var isOldAgent = $o.core.globalVariables.otherToken == visitor.Agent.Token;
            $o.core.globalVariables.otherToken = visitor.Agent.Token;
            $o.core.globalVariables.otherName = visitor.Agent.Name;
            $o.visitorSearch.assignedAgentName = visitor.Agent.Name;
            $o.visitorSearch.changeStatusOverbookingToWaitingUI(visitor);

            $("#chat-input").attr("readonly", false).focus();
            $("#chat-input").removeClass("chat-input-disabled");

            if ($(".emoji-wysiwyg-editor").is(":visible")) {
                $(".chat-input-emoji").removeClass("chat-input-disabled"); //Nuevo Visor
                $(".emoji-wysiwyg-editor").attr("contenteditable", true).focus();   //NUevo visor
            }
            //var myToken = $o.core.globalVariables.myToken;
            //var savingVisitor;
            //savingVisitor = $o.recoverRecords.interactionsList.visitors[myToken];
            //if (savingVisitor && !isOldAgent) {
            //    $o.hubsOut.sendInteractionsToAgent(visitor.Agent.Token, myToken, JSON.stringify(savingVisitor.interactions));
            //}
        },

        postGetRecordsMailInfo: function (visitorEmail) {
            var email = visitorEmail,
                agentName = $o.core.globalVariables.otherName,
                visitorName = "You",
                sessionId = $o.core.globalVariables.roomForLastOperations,
                //1-emailTimeLineLinkUrl: caso smarthouse, link a timeline va a pgina nuestra
                //2-sendEmailBaseUrl: caso dermacenter, todas las webs tienen el mismo baseurl
                //3. caso normal
                url = $o.core.globalVariables.emailTimeLineLinkUrl || $o.core.globalVariables.sendEmailBaseUrl || $o.core.globalVariables.baseUrl,
                baseUrl = $o.core.globalVariables.protocolHttp + url,
                //  headerBkg = $(".CVBkg1").css("backgroundColor"),
                headerBkg = $(".mailHeaderBkg").css("backgroundColor"),
                textColor = $(".mailTextColor").css("color"),

                logoUrl = $(".mailImageLogoSrc").attr("data-attr"),
                viewedProducts = viewedVM.nodes(),
                mycartProducts = mycartVM.nodes(),
                mylistProducts = mylistVM.nodes();
            var products = []
                .concat(viewedProducts)
                .concat(mycartProducts)
                .concat(mylistProducts);
            //    listCounter = { CV: 0, ML: 0, CA: 0 },
            //    viewedTable = "", myListTable = "", myCartTable = "",



            //    createHeader = function (title) {
            //        var tr = "<tr ><td colspan='4'><h3 style='margin:5px 0 0 0'>" + title + "</h3></td></tr><tr>";
            //        return tr;
            //    },

            //    createRow = function (internalId, title, URLMedia) {
            //        var protocol;
            //        if (URLMedia.indexOf('http://') > -1 || URLMedia.indexOf('https://') > -1) protocol = "";
            //        else protocol = $o.core.globalVariables.protocolHttp;

            //        var tdElement = "<td align='center' class='mini-img'><a href='" + baseUrl + "?recoverSession=" + sessionId + "&productId=" + internalId + "' style='outline: 0; text-decoration: none'><img  width='150' style='border: 1px dotted #999999; width: 150px;' alt='" + title + "' src='" + protocol + URLMedia + "'></a></td>";
            //        return tdElement;
            //    },

            //    createViewMoreRow = function () {
            //        var tr = "</tr><tr><td colspan='4' align='right' height='10' style='padding:5px'><a href='" + baseUrl + "' >" + culture.coviewer.ViewMore + "</a></td>";
            //        return tr;
            //    };

            //for (var i = 0; i < viewedProducts.length; i++) {
            //    if (listCounter.CV < 8) {
            //        if (listCounter.CV == 0) {
            //            var header = createHeader(culture.coviewer.ItemsYouViewed);
            //            viewedTable += header;
            //        }
            //        if (listCounter.CV == 4) viewedTable += "</tr><tr>";
            //        var row = createRow(viewedProducts[i].internalId(), viewedProducts[i].title(), viewedProducts[i].thumbnail());
            //        viewedTable += row;

            //    }
            //    else if (listCounter.CV == 8) {
            //        var viewMoreRow = createViewMoreRow();
            //        viewedTable += viewMoreRow;
            //    }
            //    ++listCounter.CV;
            //};
            //for (var i = 0; i < mylistProducts.length; i++) {
            //    if (listCounter.ML < 8) {
            //        if (listCounter.ML == 0) {
            //            var header = createHeader(culture.coviewer.ItemsMyList);
            //            viewedTable += header;
            //        }
            //        if (listCounter.ML == 4) viewedTable += "</tr><tr>";
            //        var row = createRow(mylistProducts[i].internalId(), mylistProducts[i].title(), mylistProducts[i].thumbnail());
            //        viewedTable += row;

            //    }
            //    else if (listCounter.ML == 8) {
            //        var viewMoreRow = createViewMoreRow();
            //        viewedTable += viewMoreRow;
            //    }
            //    ++listCounter.ML;
            //};
            //for (var i = 0; i < mycartProducts.length; i++) {
            //    if (listCounter.CA < 8) {
            //        if (listCounter.CA == 0) {
            //            var header = createHeader(culture.coviewer.ItemsCart);
            //            viewedTable += header;
            //        }
            //        if (listCounter.CA == 4) viewedTable += "</tr><tr>";
            //        var row = createRow(mycartProducts[i].internalId(), mycartProducts[i].title(), mycartProducts[i].thumbnail());
            //        viewedTable += row;

            //    }
            //    else if (listCounter.CA == 8) {
            //        var viewMoreRow = createViewMoreRow();
            //        viewedTable += viewMoreRow;
            //    }
            //    ++listCounter.CA;
            //};

            //if (viewedTable.length) viewedTable += "</tr>";
            //if (myListTable.length) myListTable += "</tr>";
            //if (myCartTable.length) myCartTable += "</tr>";
            //var products = myCartTable + myListTable + viewedTable;


            function buildProductArray(products) {
                var arr = [];
                for (var i = 0; i < products.length; i++) {
                    arr.push({
                        internalId: products[i].internalId(),
                        title: products[i].title(),
                        thumbnail: products[i].thumbnail()
                    });
                }
                return arr;
            }


            var productsToSend = {
                viewed: buildProductArray(viewedProducts),
                myList: buildProductArray(mylistProducts),
                cart: buildProductArray(mycartProducts)
            };


            
            var queryString = "?domainId=" + $o.variablesVisitor.domain + "&locale=" + $o.core.globalVariables.locale + "&tokenSession=" + $o.core.globalVariables.roomForLastOperations
                + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId;

            if ($o.utils && $o.utils.actualPageLogo) {
                logoUrl = $o.utils.actualPageLogo;
            }

            var useLiteralBaseUrlForLinks = false;
            if ($o.utils && $o.utils.useLiteralBaseUrlForLinks) {
                useLiteralBaseUrlForLinks = $o.utils.useLiteralBaseUrlForLinks;
            }

            if ($o.utils && $o.utils.rewriteBaserUrlForLinks) {
                baseUrl = $o.utils.rewriteBaserUrlForLinks;
            }

            //  console.log(products)

            $.post("Records/SendSummaryMail" + queryString, { email: email, agentName: agentName, visitorName: visitorName, language: $o.core.globalVariables.locale, baseUrl: baseUrl, sessionId: sessionId, headerBkg: headerBkg, textColor: textColor, logoUrl: logoUrl, products: JSON.stringify(productsToSend), token: $o.core.globalVariables.myToken, sessionSummaryId: $o.core.globalVariables.sessionSummaryId, useLiteralBaseUrlForLinks: useLiteralBaseUrlForLinks }, function () {
                var interaction = {
                    Body: email,
                    Room: $o.core.globalVariables.room,
                    SentBy: "V",
                    Type: "SU",
                    Name: "Visitor"
                };
                if ($o.core.isSignalRConnected()) {
                    $o.hubsOut.sendSummary(interaction);
                }
            });
        },

        //crea mail: PENDIENTE PARA MOVIL!!!
        getRecordsMailInfo: function (visitorEmail) {
            if ($o.core.globalVariables.room && $o.core.globalVariables.room.startsWith("TEMP")) {
                var endpoint = "Oct8ne/InitSession";
                if ($o.core.globalVariables.agentType == $o.visitorStart.agentTypes.BOT) {
                    endpoint = "Oct8ne/InitSessionWithBot";
                }
                $.post(endpoint, {
                    tempRoom: $o.core.globalVariables.room,                    
                    visitorData: JSON.stringify($o.core.globalVariables.visitorData)
                }, function (result) {
                    $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies,
                        [
                            { cookie: $o.cookies.tokenSession, value: result.Room },
                            { cookie: $o.cookies.sessionSummaryId, value: result.SessionSummaryId },
                        ]);
                    $o.core.globalVariables.roomForLastOperations = result.Room;

                    $o.saveRecord.saveListInteractions().then(function (result) {
                        $o.visitorSearch.postGetRecordsMailInfo(visitorEmail);
                    });
                });
            } else {
                $o.visitorSearch.postGetRecordsMailInfo(visitorEmail);
            }
        },

        actionWhenClosingIframe: function () {
            $o.saveRecord.closeViewerB();
            $o.iframes.changeStatusIframe($o.iframes.iframeStatus.CLOSE);
            $o.inactivityAgent.clearTimerInterval();
            $o.storage.local.set($o.core.localStorageTypes.SEARCHCACHE, $o.core.localStorageActions.REMOVE);

            if ($o.core.globalVariables.conferenceProvider && $o.visitorStart.platform != "") {
                conferenceVM.removeCallInformation();
            };
        },

        getViewedProductsForEmail: function (userData) {
            var allCurrentProducts = viewedVM.nodes();
            var viewedList = $o.visitorSearch.getProductUrls(allCurrentProducts);

            if ($o.visitorSearch.pendingUrlCatalogs.length > 0) {
                $o.visitorSearch.getCatalogUrls(viewedList, userData);
            }
            else if ($o.visitorSearch.pendingUrlProducts.length > 0) {
                $o.platform.getFullProductInfoManyProducts(viewedList, userData, $o.visitorSearch.pendingUrlProducts);
            } else {
                $o.visitorSearch.sendFormEmail(viewedList, userData);
            };
        },

        getCatalogUrls: function (viewedList, userData) {
            $.ajax({
                type: "POST",
                url: $o.settings.catalogServer + "Resources/GetCatalogItems",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ "InternalIds": JSON.stringify($o.visitorSearch.pendingUrlCatalogs), "License": $o.settings.license }),
                dataType: "json",
                success: function (result) {
                    $.each(viewedList, function (i) {
                        $.each(result, function (x) {

                            if ((result[x].InternalId == viewedList[i].Id) && (result[x].ProductUrl)) {
                                //viewedList[i].RouteTo = result[x].RouteTo.replace("https:", "").replace("http:", "");
                                viewedList[i].ProductUrl = result[x].ProductUrl;
                            }
                        });
                    });
                    if ($o.visitorSearch.pendingUrlProducts.length) {
                        $o.platform.getFullProductInfoManyProducts(viewedList, userData, $o.visitorSearch.pendingUrlProducts);
                    } else {
                        $o.visitorSearch.sendFormEmail(viewedList, userData);
                    }
                }
            });
        },

        postSendFormEmail: function (allCurrentProducts, userData, fullProductsInfo) {            
            var protocol = $o.core.globalVariables.protocolHttp;
            var doubleSlashPos;
            //LIO de PROTOCOLOS.EN PRESTA  llegan 2. (http:http://).. .los  borramos y le cascamos el protocolo otra vez
            for (var i = 0; i < allCurrentProducts.length; i++) {
                if (allCurrentProducts[i].ProductUrl.lastIndexOf("//") > -1) {
                    doubleSlashPos = allCurrentProducts[i].ProductUrl.lastIndexOf("//");
                    allCurrentProducts[i].ProductUrl = allCurrentProducts[i].ProductUrl.substring(doubleSlashPos, allCurrentProducts[i].ProductUrl.length);
                    allCurrentProducts[i].ProductUrl = protocol + allCurrentProducts[i].ProductUrl;
                }
                if (allCurrentProducts[i].Thumbnail.lastIndexOf("//") > -1) {
                    doubleSlashPos = allCurrentProducts[i].Thumbnail.lastIndexOf("//");
                    allCurrentProducts[i].Thumbnail = allCurrentProducts[i].Thumbnail.substring(doubleSlashPos, allCurrentProducts[i].Thumbnail.length);
                    allCurrentProducts[i].Thumbnail = protocol + allCurrentProducts[i].Thumbnail;
                }
            };
            //END LIO de PROTOCOLOS.EN PRESTA. Ahora ya esta como MAGENTO

            if (fullProductsInfo) {
                for (var i = 0; i < fullProductsInfo.length; i++) {
                    for (var x = 0; x < allCurrentProducts.length; x++) {
                        if (fullProductsInfo[i].hasOwnProperty("internalId")) {
                            if (fullProductsInfo[i].internalId == allCurrentProducts[x].Id) {

                                if (fullProductsInfo[i].hasOwnProperty("productUrl")) {
                                    if (fullProductsInfo[i].productUrl.indexOf("http://") > -1 || fullProductsInfo[i].productUrl.indexOf("https://") > -1) {
                                        allCurrentProducts[x].ProductUrl = fullProductsInfo[i].productUrl;
                                    }
                                    else {
                                        allCurrentProducts[x].ProductUrl = protocol + fullProductsInfo[i].productUrl;
                                    }
                                }
                            }
                        }
                        //no aadia links desde ajax productInfo 
                        else if (fullProductsInfo[i].hasOwnProperty("InternalId")) {
                            if (fullProductsInfo[i].InternalId == allCurrentProducts[x].Id) {

                                if (fullProductsInfo[i].hasOwnProperty("ProductUrl")) {
                                    if (fullProductsInfo[i].ProductUrl.indexOf("http://") > -1 || fullProductsInfo[i].ProductUrl.indexOf("https://") > -1) {
                                        allCurrentProducts[x].ProductUrl = fullProductsInfo[i].RouteTo;
                                    }
                                    else {
                                        allCurrentProducts[x].ProductUrl = protocol + fullProductsInfo[i].RouteTo;
                                    }

                                }
                            }
                        }
                    };
                };
            };

            var productsToSend = [];
            for (var i = 0; i < allCurrentProducts.length; i++) {
                productsToSend.push({
                    id: allCurrentProducts[i].Id,
                    title: allCurrentProducts[i].Title,
                    thumbnail: allCurrentProducts[i].Thumbnail,
                    productUrl: allCurrentProducts[i].ProductUrl
                });
            }
          
           

            //caso dermacenter, todas las webs tienen el mismo baseurl
            var baseUrl = $o.core.globalVariables.sendEmailBaseUrl || $o.core.globalVariables.baseUrl;

            var emailsToSend;
            var pageLogo;

            if ($o.utils && $o.utils.emailsContactUs) {
                emailsToSend = $o.utils.emailsContactUs;
            }

            if ($o.utils && $o.utils.actualUrlForContactUs) {
                baseUrl = $o.utils.actualUrlForContactUs();
            }

            if ($o.utils && $o.utils.actualPageLogo) {
                pageLogo = $o.utils.actualPageLogo;
            }




            var queryStringSendEmail = "?tokenSession=" + $o.core.globalVariables.roomForLastOperations
                + "&tokenVisitor=" + $o.variablesVisitor.tokenVisitor
                + "&domainId=" + $o.variablesVisitor.domain
                + "&assignedAgent=" + $o.core.globalVariables.inviteLinkAssignedAgent
                + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId;

            $.post("Oct8ne/SendEmailUs" + queryStringSendEmail, { firstName: userData.name, email: userData.email, product: userData.product, knowUs: userData.knowUs, phone: userData.phone, zip: userData.zip, language: $o.core.globalVariables.locale, comments: userData.comments, baseUrl: baseUrl, products: JSON.stringify(productsToSend), emails: emailsToSend, pageLogo: pageLogo, visitorLocation: $o.variablesVisitor.visitorLocation }, function (confirm) {
                if (confirm == "True") {

                    if ($o.utils && $o.utils.sendContactFormCallback) {
                        $o.utils.sendContactFormCallback();
                    } else {
                        $(".contact-form-fields").find("input, textarea").attr("readonly", "readonly");
                        $("#email-us-form-loading, .checkbox-conditions-wrapper").hide();
                        $("#email-success").show().find("p").html(culture.coviewer.EmailAgreement);
                    }
                } else {
                    $("#email-us-form-message").show().html(culture.coviewer.EmailError).css("color", "rgb(214, 2, 2)");
                    $("#send-email-us").show();
                    $("#email-us-form-loading").hide();
                }
            });

            //console.log(htmlCode);

            if ($o.core.isSignalRConnected()) {
                $.connection.hub.stop();
                var queryString = "?tokenSession=" + $o.core.globalVariables.room + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId;
                $o.visitorStart.changeStatus(queryString, "Searching");
                $o.core.agentsConnected = false;
            }
        },

        sendFormEmail: function (allCurrentProducts, userData, fullProductsInfo) {
            if ($o.core.globalVariables.room && $o.core.globalVariables.room.startsWith("TEMP")) {
                var endpoint = "Oct8ne/InitSession";
                if ($o.core.globalVariables.agentType == $o.visitorStart.agentTypes.BOT) {
                    endpoint = "Oct8ne/InitSessionWithBot";
                }
                $.post(endpoint, {
                    tempRoom: $o.core.globalVariables.room,
                    visitorData: JSON.stringify($o.core.globalVariables.visitorData)
                }, function (result) {
                    $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies,
                        [
                            { cookie: $o.cookies.tokenSession, value: result.Room },
                            { cookie: $o.cookies.sessionSummaryId, value: result.SessionSummaryId },
                        ]);
                    $o.core.globalVariables.roomForLastOperations = result.Room;
                    $o.saveRecord.saveListInteractions().then(function (result) {
                        $o.visitorSearch.postSendFormEmail(allCurrentProducts, userData, fullProductsInfo);
                    });
                });
            } else {
                $o.visitorSearch.postSendFormEmail(allCurrentProducts, userData, fullProductsInfo);
            }
        },

        getProductUrls: function (list) {
            var protocol = $o.core.globalVariables.protocolHttp;
            var listWithUrls = [];

            $.each(list, function (i) {
                var url = "";
                if (list[i].internalId().indexOf('Oct8neCatalog') > -1) {
                    $o.visitorSearch.pendingUrlCatalogs.push(list[i].internalId());
                } else {
                    var product = $o.fullProducts.searchProduct(list[i].internalId());
                    if (product) {
                        url = protocol + product.RouteTo;
                    } else {
                        $o.visitorSearch.pendingUrlProducts.push(list[i].internalId());
                    }
                }

                var thumb = list[i].thumbnail().indexOf('upload.oct8ne.com') > -1 || list[i].internalId().indexOf('Catalog') > -1 ? list[i].thumbnail() : protocol + list[i].thumbnail();

                listWithUrls.push({
                    Id: list[i].internalId(),
                    Title: list[i].title(),
                    Thumbnail: thumb,
                    ProductUrl: url
                });
            });

            return listWithUrls;
        },
        accesFormActive: false,
        accesFormNameInput: "",
        accesFormEmailInput: "",
        accesFormMessageInput: "",
        assignedAgentName: "",
        enableSelectResult: true,
        disableChangeToWaiting: false,
        openProduct: false,
        showedJustLookingMessage: false,
        showedGdprMessage: false,
        pendingUrlProducts: [],
        pendingUrlCatalogs: []
    };
})(window);

window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.visitorStart = {
        doStart: function (enterType) {
            $o.chat.toogleDenyVisitorTyping(true);//Para que el vistante no pueda escribir hasta que haya pasado el Visitor/Start
            $o.variablesVisitor.lastInteractionAFK = new Date(); //est para que al clicar sobre el chat mientras aparece "Conectando con un agente" no aparezca la capa de AFK

            $o.core.doPostMessageToApi("GETPARAMETERS");
            $o.visitorStart.events();
            $o.visitorStart.enterTypeForStart = enterType;

            if ($o.core.globalVariables.conferenceProvider && $o.visitorStart.platform != "") { //Puede tener conferenceProvider,  pero que no hayan los archivos de videoconferencia cargados. En caso de NO ser https!.
                $.connection.hub.disconnected(function () {
                    $o.visitorStart.platform.onSelfDisconnected.trigger();
                });
            };
        },

        getVisitorStartData: function (info) {
            var pageInfo = JSON.parse(info);

            var array_productsViewed = $o.enterData.productsViewed.split(',');
            $o.core.globalVariables.lastProductsViewed = $o.enterData.productsViewed !== "" ? array_productsViewed.slice(-10, array_productsViewed.length).join() : "";
            $o.core.globalVariables.totalProductsViewed = $o.enterData.productsViewed !== "" ? array_productsViewed.length : 0;


            $o.core.globalVariables.pageUrl = pageInfo.pageUrl;
            $o.core.globalVariables.urlHash = pageInfo.urlHash;
            $o.core.globalVariables.userAgent = pageInfo.userAgent;
            $o.core.globalVariables.isDevice = pageInfo.isDevice;

            $o.core.globalVariables.pageTitle = pageInfo.pageTitle;
            $o.core.globalVariables.pageType = pageInfo.pageType;
            $o.core.globalVariables.customOptions = (pageInfo.hasOwnProperty("options")) ? JSON.parse(pageInfo.options) : "";
            $o.core.globalVariables.customData = (pageInfo.hasOwnProperty("customData")) ? JSON.parse(pageInfo.customData) : "";
            $o.core.globalVariables.navigationUrls = (pageInfo.hasOwnProperty("navigation")) ? pageInfo.navigation : "";
            $o.core.globalVariables.actualUrl = (pageInfo.hasOwnProperty("actualUrl")) ? pageInfo.actualUrl : "";
            $o.core.globalVariables.triggerMessage = (pageInfo.hasOwnProperty("triggerMessage")) ? pageInfo.triggerMessage : null;
            $o.core.globalVariables.forceAssignToAgents = (pageInfo.hasOwnProperty("forceAssignToAgents")) ? pageInfo.forceAssignToAgents : false;
            $o.core.globalVariables.treePreviewId = (pageInfo.hasOwnProperty("treePreviewId")) ? pageInfo.treePreviewId : false;
            $o.core.globalVariables.treePreviewNodeId = (pageInfo.hasOwnProperty("treePreviewNodeId")) ? pageInfo.treePreviewNodeId : false;
            $o.core.globalVariables.firstAccessPage = $o.core.globalVariables.navigationUrls.length ? $o.core.globalVariables.navigationUrls[0] : "";
            $o.core.globalVariables.domainName = pageInfo.domainName;
            $o.core.globalVariables.isCustomApp = pageInfo.customApp;
            //form oct8ne.bot.gotoHome/gotoAction
            $o.core.globalVariables.treeStartFromGoto = (pageInfo.hasOwnProperty("treeStartFromGoto")) ? JSON.parse(pageInfo.treeStartFromGoto) : null;
            $o.storage.local.values = pageInfo.localStorageValues;
            oct8ne.log("RECUPERAMOS localStorage");

            $o.core.globalVariables.forceAssignToAgents = (pageInfo.hasOwnProperty("forceAssignToAgents")) ? pageInfo.forceAssignToAgents : false;

            var productId = $o.enterData.idProduct;
            if (productId === "") {
                productId = 0
            } else {
                productId = parseInt($o.enterData.idProduct);
            }
            $o.core.globalVariables.botProductId = productId;
            $o.core.globalVariables.customTheme = pageInfo.customTheme;

            if (typeof ($o.core.globalVariables.customTheme) === "string" && $o.core.globalVariables.customTheme.length) {
                $o.visitorStart.loadCustomThemeFromApi($o.core.globalVariables.customTheme, $o.visitorStart.continueLoadingWithVisitorDataLoaded);
            } else {
                $o.visitorStart.continueLoadingWithVisitorDataLoaded()
            }

            if (pageInfo.tagFromCookiesData) {
                $o.core.globalVariables.tagFromCookiesData = pageInfo.tagFromCookiesData;
            }

            if ($o.utils && $o.utils.getCustomVisitorStartData) {
                $o.utils.getCustomVisitorStartData(pageInfo);
            }
        },

        continueLoadingWithVisitorDataLoaded: function () {
            $o.fullProducts.recoverProductsFromLocalStorage();
            $o.inactivity.init();
            $o.visitorStart.setSound();
            $o.visitorStart.startVisitorConnection($o.visitorStart.enterTypeForStart);
        },

        startVisitorConnection: function (enterType) {
            if ($o.core.globalVariables.customOptions && ($o.core.globalVariables.customOptions.hasOwnProperty("user"))) {
                if ($o.core.globalVariables.customOptions.user.name && $o.core.globalVariables.customOptions.user.email) {
                    $("#access-form-name,#email-us-name").val($o.core.globalVariables.customOptions.user.name);
                    $("#email-us-email,#access-form-email").val($o.core.globalVariables.customOptions.user.email);
                }
            }
            if (enterType == $o.core.enterType.TREEPREVIEW) {
                TreePreview.preparePreview();
            }
            $o.visitorSearch.enableSelectResult = false;
            if ($o.core.globalVariables.agentsConnected == "True") {
                $o.visitorStart.showAccessForm = $o.visitorStart.checkAccessFormData(enterType);
                if (enterType == $o.core.enterType.PINCODE) $o.core.doPostMessageToApi("SHOWPINCODELOADING");
                if (enterType == $o.core.enterType.LOGINPAGE) $o.platform.goneToLogin = true;
                $o.core.agentsConnected = true;
                $o.visitorStart.connectVisitor().then(function (result) {
                    $o.visitorStart.showContent(enterType, result);
                    if (result) {
                        $o.delayAction.tryRecover();
                    }
                });

            } else if (enterType != $o.core.enterType.PINCODE) {
                $o.core.agentsConnected = false;
                $o.visitorStart.agentsDisconnectedChangesUI();
                $o.iframes.init();
                $o.visitorStart.visitorStart(enterType);
            } else {
                $o.iframes.changeStatusIframe($o.iframes.iframeStatus.CLOSE);
            }
        },

        connectVisitor: function () {
            return new Promise(function (resolve, reject) {
                var forceConnection = false;
                if ($o.settings.license == "F3EF64437344DAD9D0C599891E248C6B" && ($o.core.globalVariables.pageUrl.indexOf("bolsa") > -1 || $o.core.globalVariables.pageUrl.indexOf("compra") > -1 || $o.core.globalVariables.pageUrl.indexOf("checkout") > -1)) {
                    forceConnection = true;

                }
                if ($o.settings.license == "883AD255BBCC9AAABAA4214ACB2BF62E" && ($o.core.globalVariables.pageUrl.indexOf("bolsa") > -1 || $o.core.globalVariables.pageUrl.indexOf("compra") > -1 || $o.core.globalVariables.pageUrl.indexOf("checkout") > -1)) {
                    forceConnection = true;
                }

                if ($o.core.agentsConnected == true && (((!$o.core.globalVariables.visitorsOverflow || forceConnection) && ($o.visitorStart.showAccessForm == false || $o.visitorSearch.accesFormActive == true)) || $o.visitorSearch.connectFromAccessForm === true)) {
                    $o.visitorSearch.connectFromAccessForm === false;
                    $.connection.hub.reconnected(function () {
                        setTimeout(function () {
                            $o.visitorStart.reconnectVisitorSignalR();
                        }, 5000);
                    });
                    $.connection.hub.start().done(function () {
                        resolve(true);
                    });
                } else {
                    resolve(false);
                }
            });
        },

        showContent: function (enterType, checkInactivity) {
            if ($o.core.globalVariables.room && $o.core.isSignalRConnected()) {
                $.connection.hubInterface.server.closeLastConnection($o.core.globalVariables.room);
            }
            $("#email-us-form").hide(); //PORQUE? NO DEBERIA ESTAR AQUI.
            if (checkInactivity && $o.variablesVisitor.status == "") $o.inactivity.justLooking.start();

            if ($o.visitorStart.showDepartmentsSelect || $o.visitorStart.showAccessForm) {
                $o.visitorStart.showAccessFormWrapperUI($o.visitorStart.showDepartmentsSelect, $o.settings.showAccessForm);
                if ($("#iframe-status").val() !== "MINIMIZED") {
                    $("#iframe-status").val($o.iframes.iframeStatus.CHAT);
                    $o.iframes.changeStatusIframe($o.iframes.iframeStatus.CHAT);
                }
                $o.iframes.init();
            } else {
                $o.visitorStart.visitorStart(enterType);
                if (enterType != $o.core.enterType.PINCODE) $o.visitorStart.showChatWrapperUI();

                if ($o.utils && $o.utils.dontMinimizeMobileOnReopen) {
                    $o.scroll.coviewerStatus = "max";
                }

                $o.iframes.init();
            }
        },

        checkAccessFormData: function (enterType) {
            $o.visitorStart.showDepartmentsSelect = $o.visitorStart.checkDepartments(enterType);
            if ($o.visitorStart.checkFormAndDepts(enterType) && ($o.settings.showAccessForm || $o.visitorStart.showDepartmentsSelect)) {
                return true;
            } else {
                return false;
            }
        },

        checkDepartments: function (enterType) {
            //comprobamos que no sea reopen
            if ($o.visitorStart.checkFormAndDepts(enterType) && $o.core.globalVariables.enabledDepartments == 'True') {
                //solo hay dept initial
                if ($o.settings.listDepts.length == 1) {
                    $o.visitorStart.selectedDepartment = $o.settings.listDepts[0].id;
                    //varios depts
                } else if ($o.settings.listDepts.length > 1) {
                    var agentsConnected = [];
                    $.each($o.settings.listDepts, function (i) {
                        if ($o.settings.listDepts[i].agentsConnected == "True") agentsConnected.push($o.settings.listDepts[i].id);
                    });
                    //solo hay agentes conectados en uno
                    if (agentsConnected.length == 1) {
                        $o.visitorStart.selectedDepartment = agentsConnected[0];
                        //agentes conectados en varios
                    } else if (agentsConnected.length > 1) {
                        return true;
                    }
                }
            }
            return false;
        },

        checkFormAndDepts: function (enterType) {
            if ((($o.core.globalVariables.room == "")
                && ((enterType != $o.core.enterType.AUTOOPEN) || (enterType == $o.core.enterType.AUTOOPEN && !$o.core.globalVariables.inviteLinkAssignedAgent))
                && (enterType != $o.core.enterType.CHECKOUT && enterType != $o.core.enterType.PINCODE && enterType != $o.core.enterType.REOPEN && enterType != $o.core.enterType.LOGINPAGE && enterType != $o.core.enterType.PRODUCTPAGE && enterType != $o.core.enterType.REOPENFROMLOGIN && enterType != $o.core.enterType.RECOVERSESSION))) {
                return true;
            } else {
                return false;
            }
        },

        resetVariables: function () {
            $o.translate.isEnabled = false;
        },

        visitorStart: function (enterType) {
            var enterTypeRaw = enterType;

            $o.visitorStart.resetVariables();
            if ($o.utils && $o.utils.commonCustomInterface) { $o.utils.commonCustomInterface(); }
            //var domainId = $o.core.getCookie("VisitorDomainId");
            var time = new Date();
            // var search = $o.enterData.searchTerm || $o.core.getCookie("Oct8ne-Search-" + domainId) || "";
            if (($o.core.globalVariables.room != "") &&
                (enterType != $o.core.enterType.CHECKOUT &&
                    enterType != $o.core.enterType.LOGINPAGE &&
                    enterType != $o.core.enterType.PRODUCTPAGE &&
                    enterType != $o.core.enterType.REOPENFROMLOGIN &&
                    enterType != $o.core.enterType.RECOVERSESSION) &&
                enterType != $o.core.enterType.TREEPREVIEW) {
                $o.core.globalVariables.enterType = $o.core.enterType.REOPEN;
                enterType = $o.core.enterType.REOPEN;
            }

            if (!$o.core.globalVariables.room || $o.core.globalVariables.room == "" || $o.core.globalVariables.room == undefined) {
                $o.variablesVisitor.status = "";
            }

            if ($o.core.globalVariables.inviteLinkAssignedAgent && enterType == $o.core.enterType.AUTOOPEN) {
                $o.variablesVisitor.status = "Waiting";
            }
            var queryString = "statusVisitor=" + $o.variablesVisitor.status
                + "&tokenVisitor=" + $o.variablesVisitor.tokenVisitor
                + "&tokenSession=" + $o.core.globalVariables.room
                + "&domainId=" + $o.variablesVisitor.domain
                + "&locale=" + $o.core.globalVariables.locale
                + "&baseUrl=" + $o.core.globalVariables.baseUrl
                + "&currencyVisitor=" + $o.core.globalVariables.currencyVisitor
                + "&apiVersion=" + $o.core.globalVariables.apiVersion
                + "&assignedAgent=" + $o.core.globalVariables.inviteLinkAssignedAgent
                + "&exclusiveAgent=" + $o.core.globalVariables.inviteLinkExclusiveAgent
                + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId
                + "&platform=" + $o.core.globalVariables.platform
                + "&forceAssignToAgents=" + $o.core.globalVariables.forceAssignToAgents;

            var visitorHasAudioDevices = $o.core.globalVariables.conferenceProvider ? $o.core.globalVariables.visitorHasAudioDevices : false;
            var visitorHasVideoDevices = $o.core.globalVariables.conferenceProvider ? $o.core.globalVariables.visitorHasVideoDevices : false;

            var connectionId = $.connection.hub.id;
            if (!connectionId || connectionId == undefined || connectionId == "undefined") {
                connectionId = null;//asegurar de que al servidor no se envia un string "undefined"
            }

            var triggerId = !$o.enterData.triggerId ? 0 : $o.enterData.triggerId;

            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [
                { cookie: "visitorStartRequested", value: "ENTERTYPE: " + enterType + " -- TOKENSESSION: " + $o.core.globalVariables.room + " - TRIGGERID: " + triggerId + " - STARTPAGE: " + $o.core.globalVariables.actualUrl }
            ]);

            $.post("Oct8ne/Start?" + queryString,
                {
                    connectionId: connectionId,
                    deptSelected: parseInt($o.visitorStart.selectedDepartment),
                    time: time.getTimezoneOffset(),
                    entertype: enterType,
                    iframeStatus: $o.iframes.currentIframeStatus,
                    pageTitle: $o.core.globalVariables.pageTitle,
                    pageUrl: $o.core.globalVariables.pageUrl,
                    pageType: $o.core.globalVariables.pageType,
                    visitorHasAudioDevices: visitorHasAudioDevices,
                    visitorHasVideoDevices: visitorHasVideoDevices,
                    customOptions: JSON.stringify($o.core.globalVariables.customOptions),
                    visitorProtocolPage: window.location.protocol,
                    visitorsOverflow: $o.core.globalVariables.visitorsOverflow === true,
                    allowedDepartmentsId: $o.enterData.allowedDepartmentsId,
                    startDefaultCategories: $o.utils && $o.utils.startDefaultCatalog ? $o.utils.startDefaultCatalog : null,
                    totalCartValue: null,
                    triggerId: triggerId
                },
                function (result) {
                    $o.core.globalVariables.visitorData = JSON.parse(JSON.stringify(result));

                    var pageInfo = {
                        Title: $o.core.globalVariables.pageTitle,
                        Url: $o.core.globalVariables.pageUrl,
                        PageType: $o.core.globalVariables.pageType
                    }
                    $o.saveRecord.pageInfo(pageInfo);

                    if (result.TriggerId != 0) {
                        $o.saveRecord.launchedTrigger(result.TriggerId);
                    }

                    if ($o.core.globalVariables.visitorData) {
                        $o.core.globalVariables.visitorData.GdprMessage = null;
                    }
                    if ($o.core.globalVariables.visitorData && $o.core.globalVariables.visitorData.Agent) {
                        $o.core.globalVariables.visitorData.Agent.CannedMessage = null;
                    }

                    $o.settings.botServer = $o.settings.botServerHttp;
                    $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: "visitorStartRequested", value: false }]);

                    $o.chat.toogleDenyVisitorTyping(false); //Para que el visitante pueda escribir una vez se le haya asignado un agente

                    if (result.VisitorNotInDicc || (result.License == "9D78F0EE93468E25586B540ADE7B0461" && (result.Agent && result.Agent.AgentId == 0))) {
                        if ($o.core.globalVariables.room.startsWith("TEMP")) {
                            $o.iframes.changeStatusIframe($o.iframes.iframeStatus.CLOSE);
                            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: $o.cookies.tokenSession, value: "" },
                            { cookie: $o.cookies.lastInteractionAFK, value: "" }, { cookie: $o.cookies.status, value: "" }]);
                            return;
                        }
                        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: $o.cookies.tokenSession, value: "" },
                        { cookie: $o.cookies.lastInteractionAFK, value: "" }, { cookie: $o.cookies.status, value: "" }]);
                        $("#lay-AFK .afk-content-advice").text(culture.coviewer.AdviceNotInDic);
                        $o.visitorStart.showLayAFK();
                        $("#chat-input").blur();
                        if ($.connection.hub.state != $.signalR.connectionState.disconnected) $.connection.hub.stop();
                        $o.core.globalVariables.sessionFinalized = true;

                        return;
                    }

                    if ($.connection.hub.id) {
                        $o.core.globalVariables.visitorsOverflow = false;
                    }

                    var rightNowInteraction2 = new Date();
                    $o.variablesVisitor.lastInteractionAFK = rightNowInteraction2;
                    $o.core.globalVariables.myToken = result.Token;
                    if (result.Status == "Attending" && result.Status != $o.variablesVisitor.status) {
                        var queryString = "?tokenSession=" + result.Room + "&sessionSummaryId=" + result.SessionSummaryId;
                        $o.visitorStart.changeStatus(queryString, result.Status);
                        $o.visitorPixel.sales.setCookie();
                        $o.carousel.sendProductToAnalytics("V");
                        //$o.inactivity.attending.start();
                        $o.core.hasBeenWaiting = true;
                        $o.visitorStart.changeHeaderChatToChatting();
                    }
                    $o.variablesVisitor.lastInteractionAFK = null;

                    if ($o.utils && $o.utils.actionsAfterVisitorStart) { $o.utils.actionsAfterVisitorStart(result); }

                    var rightNowInteraction = new Date();
                    if (result.EnterType === $o.core.enterType.TRIGGER && $o.core.globalVariables.device != "mobile" && $o.variablesVisitor.soundNotificationEnabled === 'True' && $o.core.globalVariables.room === '') {
                        var resp = $("#visitor-sound")[0].play();
                        if (resp !== undefined) { resp.then(function () { }).catch(function (e) { }); }
                    }

                    if ((result.Status != "Searching") &&
                        (!$o.core.globalVariables.inviteLinkAssignedAgent || enterType != $o.core.enterType.AUTOOPEN)) {
                        $o.core.hasBeenWaiting = true;
                    }
                    if (enterType == $o.core.enterType.REOPEN &&
                        result.EnterType == $o.core.enterType.PINCODE &&
                        result.Status != "Attending") {
                        $o.iframes.changeStatusIframe($o.iframes.iframeStatus.CLOSE); //Cierra la ventana de pinCode cuando carga de nuevo la pagina.
                    } else {

                        $o.variablesVisitor.visitorLocation = result.Location;

                        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies,
                            [
                                { cookie: $o.cookies.status, value: result.Status },
                                { cookie: $o.cookies.tokenVisitor, value: result.Token },
                                { cookie: $o.cookies.sessionId, value: result.SessionId },
                                { cookie: $o.cookies.tokenSession, value: result.Room },
                                { cookie: $o.cookies.connection, value: $.connection.hub.id },
                                { cookie: $o.cookies.sessionSummaryId, value: result.SessionSummaryId },
                                { cookie: $o.cookies.lastInteractionAFK, value: rightNowInteraction },
                                { cookie: $o.cookies.visitorOverFlow, value: $o.core.globalVariables.visitorsOverflow },
                                { cookie: $o.cookies.firstEnter, value: "true" }

                            ]);

                        $o.variablesVisitor.lastInteractionAFK = rightNowInteraction;
                        $o.core.globalVariables.myToken = result.Token;
                        $o.core.globalVariables.room = result.Room;
                        $o.core.globalVariables.roomForLastOperations = result.Room;
                        $o.core.globalVariables.sessionSummaryId = result.SessionSummaryId;

                        if (enterType != $o.core.enterType.REOPEN && enterType != $o.core.enterType.CHECKOUT) {
                            $o.saveRecord.statusVisitor(result.Status);
                            if ($o.core.globalVariables.customOptions) {
                                $o.saveRecord.contextInfo($o.core.globalVariables.customOptions);
                            }
                        };
                        if (enterType == $o.core.enterType.treePreview) {
                            $o.visitorStart.agentsConnectedChangesUI(result);
                            $o.visitorStart.sendOnAgentAssignedEventToApi(result.Agent);
                            $o.core.globalVariables.botTreeEnabled = true;
                        }
                        if (enterType == $o.core.enterType.PINCODE) $o.iframes.showToken(result.Room);
                        var schedule = enterType == $o.core.enterType.SCHEDULE
                            ? $o.core.globalVariables.recoverSession
                            : "";

                        $o.visitorStart.assignedDepartment = result.DeptSelected;

                        if (result.Agent && (result.Agent.AgentId != 0 || result.Agent.Name == "Overbooking")) {
                            $o.core.globalVariables.agentId = result.Agent.AgentId;
                            $o.core.globalVariables.agentName = result.Agent.Name;
                            $o.visitorSearch.assignedAgentName = result.Agent.Name;
                            $o.core.globalVariables.agentType = result.Agent.Role === 99 ? $o.visitorStart.agentTypes.BOT : $o.visitorStart.agentTypes.HUMAN;

                            if (result.Agent.Role !== 99 && result.Status == "Searching") {
                                oct8ne.storage.local.set($o.core.localStorageTypes.FORCEDHUMANINTERACTION, "true");
                            }

                            $o.visitorStart.agentsConnectedChangesUI(result);
                            $o.visitorStart.sendOnAgentAssignedEventToApi(result.Agent);

                            if ($.connection.hub.id)
                                $.connection.hubInterface.server.sendDashboard(result.Room,
                                    schedule,
                                    $o.iframes.currentIframeStatus);
                            $o.visitorSearch.enableSelectResult = true;
                            $o.visitorStart.enableSelectResult = true;
                            var pageUrlSanitize;
                            if ($o.core.globalVariables.pageUrl.indexOf("?") != -1
                            ) { //Limpiamos Https de los parametros para evaluar si hay que cargar conferencia.
                                pageUrlSanitize = $o.core.globalVariables.pageUrl.split("?");
                                pageUrlSanitize = pageUrlSanitize[0];
                            } else {
                                pageUrlSanitize = $o.core.globalVariables.pageUrl;
                            };

                            //SOLO SI HAY VIDEOCNFERENCIA
                            if ($o.core.globalVariables.conferenceProvider && pageUrlSanitize.indexOf("https") != -1) {
                                var session = {
                                    "visitor": {
                                        //Si viene de BOT las sobreescribimos para que Visitor no pueda llamar
                                        'hasAudioDevices': result.Agent.Role === 99 ? false : $o.core.globalVariables.visitorHasAudioDevices,
                                        'hasVideoDevices': result.Agent.Role === 99 ? false : $o.core.globalVariables.visitorHasVideoDevices,
                                        'isWebRtcSupported': result.Agent.Role === 99 ? false : $o.core.globalVariables.visitorIsWebRtcSupported
                                    },
                                    "agent": {
                                        'hasAudioDevices': result.Agent.AgentHasAudioDevices &&
                                            (result.Agent.AllowAudioConference || result.Agent.AllowMobileAudioConference)
                                            ? true
                                            : false,
                                        'hasVideoDevices': result.Agent.AgentHasVideoDevices &&
                                            (result.Agent.AllowVideoConference || result.Agent.AllowMobileVideoConference)
                                            ? true
                                            : false,
                                        'isWebRtcSupported': result.Agent.AgentIsWebRtcSupported
                                    }
                                };

                                if (!result.VisitorCanStartConference) {
                                    window.conferenceVM.hideStartCallButtons(true); //To hide the posibility to make first calls in Visitor side (by setting)
                                }
                                if (!$o.variablesVisitor.oct8neIsHidden) {
                                    window.conferenceVM.updateSessionInfo(session);
                                    //Una vez sabemos las capabilities de agente, updateamos info del conferenceVM en Visitor
                                    window.conferenceVM.resumeCallIfNeeded();
                                    //Rellamada Conferencia si hay una establecida.
                                }
                            }
                            //END SOLO SI HAY VIDEOCNFERENCIA

                            if (enterType == $o.core.enterType.REOPEN || enterType == $o.core.enterType.CHECKOUT) {
                                var inactivityAgentTimer =
                                    $o.storage.local.get($o.core.localStorageTypes.INACTIVITYAGENT);
                                if (inactivityAgentTimer != null) {
                                    $o.inactivityAgent.lapseTime = parseInt(inactivityAgentTimer);
                                    $o.inactivityAgent.startCounter();
                                };
                            } else {
                                $o.inactivityAgent.clearTimerInterval();
                            }

                            if (enterType == $o.core.enterType.AUTOOPEN &&
                                $o.core.globalVariables.inviteLinkAssignedAgent) {
                                $o.inactivityAgent.startCounter();
                            }
                            $o.visitorStart.displaySoundVisitorUI();
                            //antiguo initBOT                           

                        } else if (enterType == $o.core.enterType.PINCODE) {
                            $o.visitorStart.agentsConnectedChangesUI(result);
                            $o.visitorStart.sendOnAgentAssignedEventToApi(result.Agent);

                            $.connection.hubInterface.server.sendDashboard(result.Room,
                                schedule,
                                $o.iframes.currentIframeStatus);
                            $o.visitorSearch.enableSelectResult = true;
                        } else if ($o.core.globalVariables.forceAssignToAgents) {
                            //si hay bots conectados pero no agentes, y tienen el forceAssignToAgents
                            $o.visitorStart.agentsDisconnectedChangesUI();
                            var event = {
                                category: "Oct8ne",
                                type: "GAContactFormViewed"
                            }
                            $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(event));

                            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies,
                                [
                                    { cookie: $o.cookies.sessionWithoutAgent, value: true }
                                ]);
                            $o.core.agentsConnected = false;
                        } else {
                            if (enterType != $o.core.enterType.REOPEN) {
                                var event = {
                                    category: "Oct8ne",
                                    type: "GAContactFormViewed"
                                }
                                $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(event));
                            }
                            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies,
                                [
                                    { cookie: $o.cookies.sessionWithoutAgent, value: true }
                                ]);
                            $o.core.agentsConnected = false;
                            //$o.visitorStart.displayFormCuzNoAgentsConnected(); //DEPRECATED!?
                        }

                        if ($o.settings.showAccessForm &&
                            enterType != $o.core.enterType.REOPEN &&
                            $o.visitorSearch.accesFormActive == true ||
                            ($o.core.globalVariables.customOptions.hasOwnProperty("user") &&
                                ($o.core.globalVariables.customOptions.user.email != null || $o.core.globalVariables.customOptions.user.extraInfo != null))) {
                            var email, name, origin;
                            //si hay info de contexto, esta prevalecer sobre los datos de los forms
                            if ($o.core.globalVariables.customOptions.hasOwnProperty("user")) {
                                email = $o.core.globalVariables.customOptions.user.email;
                                if ($o.core.globalVariables.customOptions.user.hasOwnProperty("name")) {
                                    name = $o.core.globalVariables.customOptions.user.name;
                                } else {
                                    if (email) {
                                        name = $o.core.globalVariables.myName;
                                    }
                                }
                                var extraInfo = null;
                                if ($o.core.globalVariables.customOptions.user.hasOwnProperty("extraInfo")) {
                                    extraInfo = $o.core.globalVariables.customOptions.user.extraInfo;
                                }

                                origin = "Context Info";
                            } else {
                                //si rellena access form
                                email = $o.visitorSearch.accesFormEmailInput.val();
                                name = $o.visitorSearch.accesFormNameInput.val();
                                origin = "Access chat form";
                            }
                            $o.core.globalVariables.myName = name;
                            var user = {
                                Email: email,
                                FirstName: name,
                                Origin: origin,
                                EnterPage: $o.core.globalVariables.sendEmailBaseUrl || $o.core.globalVariables.baseUrl,
                                //Identifier: id
                                extraInfo: extraInfo
                            };
                            if ($o.core.globalVariables.room && $o.core.globalVariables.room.startsWith("TEMP") && $o.settings.showAccessForm && $o.visitorSearch.accesFormActive == true) {
                                var endpoint = "Oct8ne/InitSession";
                                if ($o.core.globalVariables.agentType == $o.visitorStart.agentTypes.BOT) {
                                    endpoint = "Oct8ne/InitSessionWithBot";
                                }
                                $.post(endpoint, {
                                    tempRoom: $o.core.globalVariables.room,
                                    visitorData: JSON.stringify($o.core.globalVariables.visitorData)
                                }, function (resultInit) {
                                    $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies,
                                        [
                                            { cookie: $o.cookies.tokenSession, value: resultInit.Room },
                                            { cookie: $o.cookies.sessionSummaryId, value: resultInit.SessionSummaryId },
                                        ]);
                                    $o.core.globalVariables.roomForLastOperations = resultInit.Room;

                                    $o.saveRecord.saveListInteractions().then(function (resultSave) {
                                        $o.visitorStart.initBot(result);
                                        $o.visitorStart.sendAccessFormData(result, user, resultInit.Room, resultInit.SessionSummaryId, enterType);
                                    });
                                });
                            } else {
                                $o.visitorStart.initBot(result);
                                $o.visitorStart.sendAccessFormData(result, user, result.Room, result.SessionSummaryId, enterType);
                            }
                        } else {
                            $o.visitorStart.initBot(result);

                            $o.visitorStart.recoverSession(enterType,
                                result.Agent ? result.Agent.CannedMessage : " ",
                                result.Agent,
                                result.Agent ? result.GdprMessage : " ");
                        }

                    }

                    if ($o.core.globalVariables.tagFromCookiesData) {
                        if ($o.utils && $o.utils.customTagFromCookiesData) {
                            $o.utils.customTagFromCookiesData(result);
                        } else {
                            var stringData = $o.core.globalVariables.tagFromCookiesData.join("||");
                            var queryString = "domainId=" + $o.core.globalVariables.domainId + "&room=" + result.Room + "&tagNames=" + stringData;
                            $.post("Tags/TagSessionSummaryFromStart?" + queryString);
                        }
                    }

                    if (result.Status == "Attending" && $o.core.globalVariables.agentType == $o.visitorStart.agentTypes.BOT && $o.utils && $o.utils.afterChangeToAttendingBot) {
                        $o.utils.afterChangeToAttendingBot();
                    }
                });
        },

        initBot: async function (result) {
            if (!$o.visitorStart.botInitiated && result && result.Agent && result.Agent.BotType != 0) {
                $o.visitorStart.botInitiated = true;
                var botManager = BotFactory.create(result.Agent.BotType);
                if (botManager != null) {
                    $o.bot = botManager;
                    await $o.bot.init($o.core.globalVariables.visitorsOverflow, result.License);
                }
            }
        },

        sendAccessFormData: function (result, user, room, summaryId, enterType) {
            var queryStringData = "?domainId=" +
                result.Domain +
                "&tokenVisitor=" +
                result.Token +
                "&sessionSummaryId=" +
                summaryId +
                "&tokenSession=" +
                room;
            $.post("/Oct8ne/DataVisitor" + queryStringData, user);

            if ($o.core.globalVariables.visitorData) {
                $o.core.globalVariables.visitorData.Profile.Email = user.Email;
                $o.core.globalVariables.visitorData.Profile.Name = user.FirstName;
            }

            if ($o.core.isSignalRConnected())
                $o.hubsOut.sendDataVisitorToDashboard(room, user);

            $o.visitorStart.recoverSession(enterType,
                result.Agent ? result.Agent.CannedMessage : " ",
                result.Agent,
                result.Agent ? result.GdprMessage : " ");
        },

        enterActions: function () {
            if ($o.enterData.searchTerm && $o.enterData.searchTerm.length > 0) { //SI ES BSQUEDA
                var recover = $o.core.globalVariables.enterType == $o.core.enterType.REOPEN ? "recover" : null;
                $o.search.doSearch($o.enterData.searchTerm.replace("&", "%26"), "", recover);
            } else if ($o.enterData.productsViewed && $o.enterData.productsViewed.length > 0 && $o.enterData.productsViewed != "false") { //SI ES CATALOGO
                $o.platform.getProductSummary($o.enterData.productsViewed, $o.enterData.idProduct);
                $o.carousel.loadingProduct();
            }
            //Para las LITE con plugin que no tienen el productsViewed, que se muestre el producto actual en el covisor

            else if (($o.enterData.idProduct && $o.enterData.idProduct.length > 0 && $o.enterData.idProduct != "false") && (!$o.enterData.productsViewed || $o.enterData.productsViewed.length == 0 || $o.enterData.productsViewed == "false") && $o.core.globalVariables.edition == 1) {
                $o.platform.getFullProductInfo($o.enterData.idProduct, $o.carousel.lists.VIEWED);
            }
            //if ((!$o.enterData.searchTerm) && ($o.enterData.idProduct) && (window.location.pathname.indexOf("V3") === -1)) {
            //    $o.platform.searchProductsByCategory($o.enterData.idProduct);
            //}
        },

        recoverSession: function (enterType, message, agentsConnected, gdprMessage) {
            if (gdprMessage && enterType != $o.core.enterType.REOPEN && enterType != $o.core.enterType.RECOVERSESSION && enterType != $o.core.enterType.CHECKOUT && enterType != $o.core.enterType.LOGINPAGE && enterType != $o.core.enterType.REOPENFROMLOGIN) {
                if ($o.utils && $o.utils.setCustomGdprMessage) {
                    gdprMessage = $o.utils.setCustomGdprMessage(gdprMessage);
                }
                $o.visitorSearch.sendGdprMessage(gdprMessage);
            }

            if ((enterType == $o.core.enterType.TALKEXPERT) || (enterType == $o.core.enterType.LIVECHAT) || (enterType == $o.core.enterType.TRACKINGBAR) || (enterType == $o.core.enterType.TALKEXPERTBAR) || enterType == $o.core.enterType.SEARCHBOX || enterType == $o.core.enterType.AUTOOPEN) {

                var stopCannedByUtils = $o.utils && $o.utils.stopWelcomeCanned ? $o.utils.stopWelcomeCanned : false;
                var disabledByBot = $o.core.globalVariables.agentType === $o.visitorStart.agentTypes.BOT;

                if (!stopCannedByUtils && !disabledByBot) {
                    $o.visitorSearch.sendJustLookingChatMessage(message);
                }

            } else if (enterType != $o.core.enterType.REOPEN && enterType != $o.core.enterType.CHECKOUT && enterType != $o.core.enterType.treePreview && enterType != $o.core.enterType.PRODUCTPAGE && enterType != $o.core.enterType.LOGINPAGE && enterType != $o.core.enterType.REOPENFROMLOGIN && enterType != $o.core.enterType.TRIGGER && enterType != $o.core.enterType.VIPAREA && enterType != $o.core.enterType.RECOVERSESSION && enterType != $o.core.enterType.POPUP && enterType != $o.core.enterType.TREEPREVIEW) { //SEARCH o
                var justLookingOption = $o.storage.local.get($o.core.localStorageTypes.JUSTLOOKINGOPTION);
                if (justLookingOption == "true") {
                    $o.chat.showJustLookingMessage();
                }
                $o.visitorSearch.sendJustLookingChatMessage(message, true);
            } else if (enterType == $o.core.enterType.RECOVERSESSION) {
                //enviamos canned a BBD para mostrarlo cuando lo recupere
                //solo lo hace cuando clicas en el mail, si haces f5 en la pagina no lo enva
                if (message) {
                    var canned = {
                        Body: {
                            Original: message ? message.replace(/\\n/g, "").replace(/&#39;/g, "'") : "",
                            Translated: false
                        },
                        Room: $o.core.globalVariables.room,
                        Category: "CANNED",
                        Type: $o.canned.type.WELCOME,
                        Id: $o.tools.generateRandomId(),
                        SentBy: "V"
                    };
                    $o.saveRecord.canned(canned.Body, canned.Type, canned.Id);
                }
            }
            //if ((enterType == $o.core.enterType.AUTOOPEN) && ($o.core.globalVariables.inviteLinkAssignedAgent)) {
            //    if (agentsConnected) $o.visitorSearch.changeToWaitingStatus();
            //}

            if ((enterType == $o.core.enterType.TRACKINGBAR) || (enterType == $o.core.enterType.PINCODE) || (enterType == $o.core.enterType.TALKEXPERT) || (enterType == $o.core.enterType.treePreview) || (enterType == $o.core.enterType.LIVECHAT) || (enterType == $o.core.enterType.TALKEXPERTBAR) || (enterType == $o.core.enterType.AUTOOPEN)) {
                $o.visitorStart.enterActions();
                if ($o.utils && $o.utils.showPreviousSessionsOnVisitor) {
                    //It's in utils, enters by 1st time, go to recover records but without printing interactions,
                    //Only get if there are previous sessions
                    $o.visitorStart.goToRecoverPreviousSessions = true;
                }
            } else if ((enterType == $o.core.enterType.TRIGGER) || (enterType == $o.core.enterType.POPUP)) {
                //if (agentsConnected && $o.enterData.statusFromTrigger == "WAITING") $o.visitorSearch.changeToWaitingStatus();
                var messageTrigger = $o.enterData.cannedMessage.length && $o.enterData.cannedMessage != "undefined" ? $o.enterData.cannedMessage : message;
                //$o.visitorSearch.sendJustLookingChatMessage(messageTrigger); YA NO VA COMO DE SISTEMA, AHORA TIENE QUE SER CHAT BUBBLE NORMAL
                //$o.chat.sendTriggerAsChat(messageTrigger);
                $o.canned.sendCanned($o.canned.type.TRIGGER, $o.core.globalVariables.triggerMessage);
                if ($o.utils && $o.utils.showPreviousSessionsOnVisitor) {
                    $o.visitorStart.goToRecoverRecords = true;
                }
                $o.visitorStart.enterActions();
            } else if (enterType == $o.core.enterType.VIPAREA) {
                $o.visitorSearch.sendVipChatMessage($o.enterData.vipMessage);
                $o.visitorStart.enterActions();
            } else if (enterType == $o.core.enterType.CHECKOUT || enterType == $o.core.enterType.REOPEN || enterType == $o.core.enterType.LOGINPAGE || enterType == $o.core.enterType.PRODUCTPAGE || enterType == $o.core.enterType.REOPENFROMLOGIN) {
                if (enterType === $o.core.enterType.CHECKOUT && $o.platform !== undefined && $o.platform.hideTotallyCartAndMyListButtons !== undefined) {
                    $o.platform.hideTotallyCartAndMyListButtons();
                }
                if ($o.core.globalVariables.device == "mobile") {
                    if ($o.core.globalVariables.pageUrl.indexOf("Reskyt") == -1) {

                        var dontMinimizeMobileOnReopen = $o.utils && $o.utils.dontMinimizeMobileOnReopen;

                        if ($o.core.globalVariables.pageUrl.indexOf("peggy?customApp=2&oct8neOpen=1&oct8neOpen=Webview") == -1 && $o.core.globalVariables.pageUrl.indexOf("peggy?oct8neOpen=Webview&customApp=2&oct8neOpen=1") == -1 && $o.core.globalVariables.pageUrl.indexOf("peggy?oct8neOpen=Webview&customApp=2&oct8neOpen=1") == -1 && !dontMinimizeMobileOnReopen) {
                            $o.visitorStart.minimizeCoviewerMobile(false, true, false);
                        } else {
                            $("#minimized-widget").trigger("click");
                        }
                    }
                    else {
                        $("#minimized-widget").trigger("click");
                    }
                }
                $o.visitorStart.goToRecoverRecords = true;
            } else if ((enterType == $o.core.enterType.RECOVERSESSION)) {
                $o.saveRecord.linkSession($o.core.globalVariables.recoverSession);
                $o.visitorStart.goToRecoverRecords = true;
                //if (agentsConnected) $o.visitorSearch.changeToWaitingStatus();
                $o.visitorStart.enterActions();
            }
            if (enterType == $o.core.enterType.SEARCHBOX || enterType == $o.core.enterType.TRACKINGBAR) {
                $("#iframe-status").val($o.iframes.iframeStatus.SEARCH);
                var newStatus = $o.iframes.iframeStatus.SEARCH;
                if (window.location.href.indexOf("jafgifts") > -1) { newStatus = $o.iframes.iframeStatus.CHAT; }

                $("#iframe-status").val(newStatus);
                $o.iframes.changeStatusIframe(newStatus);
            }

            if ($o.chat.pendingAccessFormMessage) {
                setTimeout(function () {
                    //evitamos que se solape con la interaccin del cannedmessage, si esta tarda en grabarse
                    $o.forms.sendForm($o.forms.type.ACCESSFORM, $o.chat.pendingAccessFormMessage);
                    if ($o.bot) {
                        $o.chat.sentNextMessage = false;
                    }
                    $o.chat.prepareSend($o.chat.pendingAccessFormMessage.message);
                    $o.chat.pendingAccessFormMessage = false;

                    // $o.visitorSearch.changeToWaitingStatus();
                }, 500);
            }
            if ($o.visitorStart.goToRecoverRecords) {
                //COVIEWER_READY inside getREcords-> launches oct8ne.chatOpen event
                $o.recoverRecords.getRecords($o.variablesVisitor.tokenVisitor, $o.core.globalVariables.room);
            }
            else if ($o.visitorStart.goToRecoverPreviousSessions) {
                var showOnlyPreviousSessions = true;
                $o.recoverRecords.getRecords($o.variablesVisitor.tokenVisitor, $o.core.globalVariables.room, false, showOnlyPreviousSessions);
            }
            else {
                //COVIEWER_READY launches oct8ne.chatOpen event                
                $o.core.doPostMessageToApi("COVIEWER_READY");
                if ($o.platform) {
                    $o.platform.addPlatformLogin();
                }
            }
            if ($o.settings.allowTrackingProductsLite) {
                if (enterType != $o.core.enterType.REOPEN &&
                    enterType != $o.core.enterType.CHECKOUT &&
                    enterType != $o.core.enterType.REOPENFROMLOGIN &&
                    enterType != $o.core.enterType.LOGINPAGE &&
                    enterType != $o.core.enterType.PRODUCTPAGE) {
                    $o.catalog.getProductsByUrls($o.core.globalVariables.navigationUrls);
                }
            }
        },

        //Recupera la conexi - boton reconnect
        //el callback es el primer mensaje si el visitor esta en visitorsOverflow
        restartConnection: function (callbackText, changeToWaiting) {
            $o.visitorSearch.enableSelectResult = false;
            var visitorStart = function () {
                var time = new Date();
                var search = $o.enterData.searchTerm || "";
                var queryString = "statusVisitor=" + $o.variablesVisitor.status
                    + "&tokenVisitor=" + $o.variablesVisitor.tokenVisitor
                    + "&tokenSession=" + $o.core.globalVariables.room
                    + "&domainId=" + $o.variablesVisitor.domain
                    + "&locale=" + $o.core.globalVariables.locale
                    + "&baseUrl=" + $o.core.globalVariables.baseUrl
                    + "&currencyVisitor=" + $o.core.globalVariables.currencyVisitor
                    + "&apiVersion=" + $o.core.globalVariables.apiVersion
                    + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId
                    + "&platform=" + $o.core.globalVariables.platform
                    + "&forceAssignToAgents=" + $o.core.globalVariables.forceAssignToAgents;

                var connectionId = $.connection.hub.id;
                if (!connectionId || connectionId == undefined || connectionId == "undefined") {
                    connectionId = null;//asegurar de que al servidor no se envia un string "undefined"
                }
                var triggerId = !$o.enterData.triggerId ? 0 : $o.enterData.triggerId;

                $.post("Oct8ne/Start?" + queryString, {
                    connectionId: connectionId,
                    time: time.getTimezoneOffset(),
                    iframeStatus: $o.iframes.currentIframeStatus,
                    pageTitle: $o.core.globalVariables.pageTitle,
                    pageUrl: $o.core.globalVariables.pageUrl,
                    pageType: $o.core.globalVariables.pageType,
                    visitorProtocolPage: window.location.protocol,
                    visitorsOverflow: $o.core.globalVariables.visitorsOverflow === true,
                    allowedDepartmentsId: $o.enterData.allowedDepartmentsId,
                    startDefaultCategories: $o.utils && $o.utils.startDefaultCatalog ? $o.utils.startDefaultCatalog : null,
                    triggerId: triggerId
                }, function (result) {

                    $o.core.globalVariables.visitorData = JSON.parse(JSON.stringify(result));
                    var pageInfo = {
                        Title: $o.core.globalVariables.pageTitle,
                        Url: $o.core.globalVariables.pageUrl,
                        PageType: $o.core.globalVariables.pageType
                    }
                    $o.saveRecord.pageInfo(pageInfo);

                    $o.core.globalVariables.myToken = result.Token;
                    if (result.VisitorNotInDicc) {
                        //alert("NO EST EN EL DICCIONARIO");
                        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: $o.cookies.status, value: "" }, { cookie: $o.cookies.tokenSession, value: "" }, { cookie: $o.cookies.lastInteractionAFK, value: "" }]);
                        $("#lay-AFK .afk-content-advice").text(culture.coviewer.AdviceNotInDic);
                        $o.visitorStart.showLayAFK();
                        $("#chat-input").blur();
                        if ($.connection.hub.state != $.signalR.connectionState.disconnected) $.connection.hub.stop();
                        $o.core.globalVariables.sessionFinalized = true;

                    }

                    if ($.connection.hub.id) {
                        //$o.core.globalVariables.visitorsOverflow = false;
                    }

                    if (result.Agent) {
                        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [
                            { cookie: $o.cookies.status, value: result.Status },
                            { cookie: $o.cookies.sessionId, value: result.SessionId },
                            { cookie: $o.cookies.tokenSession, value: result.Room },
                            { cookie: $o.cookies.connection, value: $.connection.hub.id },
                            { cookie: $o.cookies.visitorOverFlow, value: false },
                            { cookie: $o.cookies.firstEnter, value: "true" }
                        ]);

                        var rightNowInteraction2 = new Date();
                        $o.variablesVisitor.lastInteractionAFK = rightNowInteraction2;
                        $o.core.globalVariables.myToken = result.Token;
                        if (result.Status == "Attending" && result.Status != $o.variablesVisitor.status) {
                            var queryString = "?tokenSession=" + result.Room + "&sessionSummaryId=" + result.SessionSummaryId;
                            $o.visitorStart.changeStatus(queryString, result.Status);
                            $o.visitorPixel.sales.setCookie();
                            $o.carousel.sendProductToAnalytics("V");
                            //$o.inactivity.attending.start();
                            $o.core.hasBeenWaiting = true;
                            $o.visitorStart.changeHeaderChatToChatting();
                        }
                        //$o.variablesVisitor.lastInteractionAFK = null;

                        $o.core.globalVariables.agentId = result.Agent.AgentId;
                        $o.core.globalVariables.agentName = result.Agent.Name;
                        $o.visitorSearch.assignedAgentName = result.Agent.Name;
                        $o.core.globalVariables.agentType = result.Agent.Role === 99 ? $o.visitorStart.agentTypes.BOT : $o.visitorStart.agentTypes.HUMAN;

                        $o.visitorStart.agentsConnectedChangesUI(result);
                        $o.visitorStart.sendOnAgentAssignedEventToApi(result.Agent);
                        //pasa la interaccion de la primera busqueda para poder recuperarla  desde el coviewer del agente
                        //var schedule = enterType == $o.core.enterType.SCHEDULE ? $o.core.globalVariables.recoverSession : "";
                        var schedule = "";
                        if ($o.core.isSignalRConnected()) {
                            $.connection.hubInterface.server.sendDashboard(result.Room, schedule, $o.iframes.currentIframeStatus)
                                .done(
                                    function () {
                                        var search = {
                                            Body: $o.search.searchTerm,
                                            Room: $o.core.globalVariables.room,
                                            SentBy: "V",
                                            Type: "Q"
                                        };
                                        $o.hubsOut.sendSearchTerm(search, "true");
                                    });
                        }
                    }
                    if (callbackText) {
                        $o.core.globalVariables.botTreeEnabled = result.Agent.IsBotTree;
                        if ($o.core.globalVariables.botTreeEnabled) {
                            if ($o.core.globalVariables.visitorsOverflow) {
                                $o.bot.connectOverflowAsync();
                                var checkStartedBotOffline = setInterval(function () {
                                    if ($o.core.globalVariables.startedBotOffline) {
                                        clearInterval(checkStartedBotOffline);
                                        $o.chat.prepareSend(callbackText);
                                    }
                                }, 100);
                            }
                        } else {
                            $o.core.hasBeenWaiting = true;
                            $o.chat.prepareSend(callbackText);
                        }
                    }

                    $o.visitorSearch.enableSelectResult = true;
                    $o.core.globalVariables.finishedVisitorRestartConnection = true;

                });
            };
            if (!$o.core.isSignalRConnected()) {
                $.connection.hub.start().done(function () {
                    $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [{ cookie: $o.cookies.connection, value: $.connection.hub.id }]);
                    visitorStart();
                });
            } else {
                visitorStart();
            }
        },

        reconnectVisitorSignalR: function () {
            $o.visitorSearch.enableSelectResult = false;
            var queryString = "statusVisitor=" + $o.variablesVisitor.status
                + "&tokenVisitor=" + $o.variablesVisitor.tokenVisitor
                + "&tokenSession=" + $o.core.globalVariables.room
                + "&domainId=" + $o.variablesVisitor.domain
                + "&locale=" + $o.core.globalVariables.locale
                + "&baseUrl=" + $o.core.globalVariables.baseUrl
                + "&currencyVisitor=" + $o.core.globalVariables.currencyVisitor
                + "&apiVersion=" + $o.core.globalVariables.apiVersion
                + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId
                + "&license=" + $o.settings.license;

            $.post("Reconnect/ReconnectedSignalR?" + queryString, {
                connectionId: $.connection.hub.id,
                iframeStatus: $o.iframes.currentIframeStatus,
                pageTitle: $o.core.globalVariables.pageTitle,
                pageUrl: $o.core.globalVariables.pageUrl,
                pageType: $o.core.globalVariables.pageType,
                visitorsOverflow: false
            }, function (result) { });
        },

        changeStatus: function (queryString, status) {

            if (status != "Waiting") { //CONTROLA INACTIVIDAD AGENTE EN VISITOR
                $o.inactivityAgent.clearTimerInterval();
            } else {
                if ($o.platform && (!$o.utils || !$o.utils.doIntensiveCostumerDataRequests)) {
                    $o.platform.addPlatformLogin();
                }
                $o.inactivityAgent.startCounter();
            }

            if (status !== "Attending") {
                $.post("/Oct8ne/Changestatus" + queryString, { status: status });
                $o.saveRecord.statusVisitor(status);
            }

            if (status == "Attending") {
                if ($o.core.globalVariables.agentType == $o.visitorStart.agentTypes.BOT && $o.utils && $o.utils.afterChangeToAttendingBot) {
                    $o.utils.afterChangeToAttendingBot();
                }

                if ($o.utils && $o.utils.additionalActionAfterAttending) {
                    $o.utils.additionalActionAfterAttending();
                }

            }

            if (status == "Finalized") {
                if ($o.core.globalVariables.agentType == $o.visitorStart.agentTypes.BOT && $o.utils && $o.utils.removeGotoBotNodeButton) {
                    $o.utils.removeGotoBotNodeButton();
                }
            }
        },

        finishLoading: function () {
            //FUNCIONES NO NECESARIAS PARA LA CARGA
            ko.applyBindings($o.core.viewModel);
            $("#oct8ne-chat-room").css({ opacity: 1 });
            $o.visitorRatings.init();
            $o.forms.init();
        },

        checkVisitorCapabilities: function () { //CheckVisitor capabilities e inicializa conference VM            
            var settings = {
                isConferenceAllowed: false,
                name: "Visitor",
                role: $o.core.globalVariables.userType,
                conferenceProviderName: $o.core.globalVariables.conferenceProvider,
                ringTone: true,
                chromeExtensionId: $o.core.globalVariables.chromeExtensionId,
                videoUnavailableBackgroundImage: "https://static.oct8ne.com/api/img/dashboard/video-unavailable.png",
                recordingMode: "none",
                ssOnly: $o.settings.ssOnly
            };

            $o.visitorStart.platform = new Oct8ne.Conference.PlatformConnector($.connection.hubInterface.server, "/conference", true);
            window.conferenceVM = new conferenceViewModel(settings, $o.visitorStart.platform, Oct8ne.Conference.LogLevel.None); //Aadir parametro logLevel para debuggar Oct8ne.Conference.LogLevel.ConferenceCoreAndProvider or None

            var capabilityProvider = Oct8ne.Conference.Providers.CapabilitiesProviderFactory.createCapabilityProvider($o.core.globalVariables.conferenceProvider, $o.core.globalVariables.chromeExtensionId);
            var promise = capabilityProvider.getCapabilitiesAsync();
            if (promise) {
                var count = 0;
                var doStart = false;
                var interval = setInterval(function () {
                    if (count < 5) {
                        count++;
                    } else {
                        clearInterval(interval);
                        if (doStart === false) { doStart = true; $o.visitorStart.doStart($o.core.globalVariables.enterType); }
                    }
                }, 100);
                promise.then(function (caps) {
                    $o.core.globalVariables.visitorHasAudioDevices = caps.hasAudioDevices;
                    $o.core.globalVariables.visitorHasVideoDevices = caps.hasVideoDevices;
                    $o.core.globalVariables.visitorIsWebRtcSupported = caps.isWebRtcSupported;
                    $o.core.globalVariables.visitorBrowserDevice = caps.browser;
                    if (doStart === false) { doStart = true; $o.visitorStart.doStart($o.core.globalVariables.enterType); } //Si tiene Conference, antes debe hacer el checkcapablities.
                });
            }
        },

        sendCustomEvent: function (customAction, label, value) {
            var event = {
                category: "Oct8ne",
                type: "GACustomAction",
                label: label,
                value: value,
                customAction: customAction
            }
            $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(event));
        },

        hideMeByNewTab: function () {
            if ($o.variablesVisitor.status != "Searching") {
                var interactionObject = $o.saveRecord.openNewTab();
                interactionObject[0].Fields = JSON.stringify(interactionObject[0].Fields);
                $.ajax({
                    type: "POST",
                    url: "/Data/SaveInteractions",
                    data: { sessionSummaryId: $o.variablesVisitor.sessionSummaryId, tokenSession: $o.core.globalVariables.room, tokenVisitor: $o.variablesVisitor.tokenVisitor, jsonListData: JSON.stringify(interactionObject) },
                }).always(function () {
                    if ($o.core.isSignalRConnected()) {
                        $.connection.hub.stop();
                    }
                    $o.core.doPostMessageToApi("CLOSEMODAL");
                });
            }
            else {
                if ($o.core.isSignalRConnected()) {
                    $.connection.hub.stop();
                }
                $o.core.doPostMessageToApi("CLOSEMODAL");
            }
        },

        setSound: function () {
            var soundVisitor = "true";
            soundVisitor = $o.storage.local.get($o.core.localStorageTypes.SOUND);
            $o.variablesVisitor.enabledSoundVisitor = soundVisitor == "false" ? soundVisitor : "true";
        },

        sendOnAgentAssignedEventToApi: function (agent) {
            var agentData = {
                id: agent.AgentId,
                name: agent.Name,
                avatar: agent.Avatar
            }
            $o.core.doPostMessageToApi("NEW_AGENT_ASSIGNED", encodeURIComponent(JSON.stringify(agentData)));
        },

        loadCustomThemeFromApi: function (themeUrl, callback) {
            //if client has custom theme, we delete its tag
            $("#custom-theme-tag").remove();

            if (themeUrl.indexOf("http") == -1) {
                themeUrl = $o.core.globalVariables.cdnUrl + "api/source/css/themes/" + themeUrl;
            };

            if (themeUrl.indexOf(".css") == -1) {
                themeUrl = themeUrl + ".css";
            };

            let link = document.createElement('link');
            link.type = 'text/css';
            link.rel = 'stylesheet';
            link.href = themeUrl;
            link.onload = callback;
            link.onerror = function () {
                callback();
                throw ("Custom theme URL is not valid");
            }
            $("head").append(link)
        },

        showLayAFK: function () {
            $("#lay-AFK").show();
            $o.accessibility.trapFocus($o.accessibility.trapFocusPopups.layAFK);
        },

        assignedAgentName: "",
        enableSelectResult: true,
        disableChangeToWaiting: false,
        openProduct: false,
        showedJustLookingMessage: false,
        showedGdprMessage: false,
        agentDisconnectedTimer: 0,
        agentDisconnectedInterval: "",
        selectedDepartment: 0,
        assignedDepartment: "",
        platform: "",
        showAccessForm: false,
        showDepartmentsSelect: false,
        goToRecoverRecords: false,
        agentTypes: {
            BOT: "BOT",
            HUMAN: "HUMAN"
        },
        botInitiated: false
    };
})(window);

generateConferenceId = function () {
    return $o.core.globalVariables.room;
};
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.storage = {
        local: {
            get: function (key) {                
                $o.storage.local.defineValues();
                var value = $o.storage.local.values[key];
                return value;
            },

            set: function (key, value) {
                //guardamos en variable por si necesitamos el valor antes de recargar pgina               
                $o.storage.local.defineValues();
                if (value !== $o.core.localStorageActions.REMOVE) {
                    $o.storage.local.values[key] = value;
                }
                else {
                    $o.storage.local.values[key] = null;
                }
                $o.core.doPostMessageToApi("SETLOCALSTORAGE" , key + "," + value);
            },

            defineValues: function () {
                if (typeof $o.storage.local.values === "undefined") {
                    $o.storage.local.values = {};
                }
            },

            values: {}
        },

        conferenceAdapter: {
            get: function (key) {
                var value = $o.storage.local.get(key);
                return value ? JSON.parse(value) : null;
            },
            set: function (key, value) {
                $o.storage.local.set(key, JSON.stringify(value));
            },
            remove: function (key) {
                $o.storage.local.set(key, $o.core.localStorageActions.REMOVE);
            }
        }
    };
})(window);

//EVENTOS 
$o.canva.events = function () {
    $o.canva.UI();
};

//FUNCIONES QUE MODIFICAN EL DOM 
$o.canva.UI = function () {
    $o.canva.showAlertAddToCartInAgentUI = function (title, action) {
        // $o.log("Por aqui!");
        // $("#add-to-mycart p").text(title);
        $("#add-to-mycart").delay(500).fadeIn(100).delay(3500).fadeOut(400);

        //if (action == $o.platform.iframeMagentoStatus.OPEN) {
        //    $("#info-actions-visitor").find("span").html(culture.coviewer.StartedAddToCart + "   <b> " + title + "</b><br /><a href=''>" + culture.coviewer.ViewPage + "</a>");
        //    $("#info-actions-visitor").stop().delay(300).animate({ right: 45 });
        //}
        //else if (action == $o.platform.iframeMagentoStatus.CLOSED) {
        //    $("#info-actions-visitor").effect("shake", { times: 3 }, 150, function () {
        //        $(this).find("span").fadeOut(200, function () {
        //            $(this).html(culture.coviewer.CancelledAddToCart+" <b> " + title + "</b>").fadeIn(200, function () {
        //                $(this).parent().delay(3000).animate({ right: -250 });
        //            });
        //        });
        //    });
        //} else if (action == $o.platform.iframeMagentoStatus.ADDED) {
        //    $("#info-actions-visitor").find("span").fadeOut(200, function () {
        //        $(this).html("<b>" + title + "</b>" + culture.coviewer.AddedToCart).fadeIn(200);
        //        $("#info-actions-visitor").prepend("<div class='cart-check'></div>");
        //        $("#info-actions-visitor,.cart-check").delay(1000).animate({ width: "+=32", right:"30" }, 500, function () {
        //            $("#info-actions-visitor").delay(3000).animate({ right: -250 }, function () {
        //                $(".cart-check").remove();
        //                $("#info-actions-visitor").css({ width: 205 });
        //            });
        //        });
        //    });
        //    $("#my-shopping-items").effect("pulsate", { times: 4 }, 200, function () {
        //        window.contentVM.setNodesFilter("Cart");
        //    });
        //}
    };

    $o.canva.showAlertAddToMyListInAgentUI = function (title, whoAdd) {
        $("#add-to-mylist").delay(500).fadeIn(100).delay(1500).fadeOut(400);
        //$("#info-actions-visitor").find("span").html(whoAdd + culture.coviewer.AddedToMylist + "<b>" + title + "</b>");
        //$("#info-actions-visitor").stop().delay(300).animate({ right: 45 }).delay(2000).animate({ right: -250 }, function () {
        //    $("#my-list-items").show("pulsate", { times: 4 }, 200, function () {
        //        window.contentVM.setNodesFilter("Mylist");
        //    });
        //});
    };

    $o.canva.updateUI = function (parameters, recover) {
        if ($o.core.globalVariables.userType == "A") $o.tools.undoActions = 0;
        if (parameters.Type == "V") {
            $("#video-wrapper").show();
            var loadVideo = function () { $o.core.youtubeViewModel.load(parameters.URLMedia); };
            if ($o.core.youtubeViewModel.loaded) {
                loadVideo()
            } else {
                $o.core.youtubeViewModel.setup(function () { loadVideo() });
            }
            $o.search.sendingProductToCanva = false;
            $o.canva.holder.helper.children("div").remove();
        } else {
            $("#video-wrapper").hide();
            $o.tools.change($o.tools.type.POINT);
            $o.zoom.level = 1;
            $("#zoom-tool").removeClass("icon-common-zoomout-button").addClass("icon-common-zoomin-button");
            $o.canva.target.object.hide();
            $o.canva.holder.helper.children("div").remove();
            $o.core.globalVariables.urlMedia = parameters.URLMedia;

            var preload = (new Image()),
                path = parameters.URLMedia;


            preload.onerror = function () {
                var thumb = viewedVM.getProduct(parameters.InternalId);
                parameters.URLMedia = thumb.Thumbnail;
                if (recover == "onError") {
                    $("#loading-product").fadeOut(100);
                    if ($o.core.globalVariables.userType == "V") $o.visitorSearch.enableSelectResult = true;
                }
                else $o.canva.updateUI(parameters, "onError");
            };

            preload.onload = function () {
                var canvaImage = this,
                    ratio = canvaImage.width / canvaImage.height,
                    height = 0, width = 0, left = 0, top = 0;

                $o.canva.holder.width = $o.canva.holder.object.width();
                $o.canva.holder.height = $o.canva.holder.object.height();
                $o.canva.target.object.css({ height: "", width: "" });
                if (canvaImage.width > $o.core.maxImageSize) {
                    //console.warn("Imagen demasiado grande - Image too big");
                    path = "/api/img/core/no-thumb-resources.png";
                };

                $o.canva.target.object.attr({ src: path });                
                $o.canva.target.object.attr({ alt: parameters.Title });

                if ($o.canva.holder.width == 0) $o.canva.holder.width = 529;
                if ($o.canva.holder.height == 0) $o.canva.holder.height = 310;

                if (ratio < 1) {
                    //img vertical
                    height = $o.canva.holder.height;
                    width = height * ratio;
                } else {
                    //img horizontal
                    width = $o.canva.holder.width;
                    height = width / ratio;

                    if (height > $o.canva.holder.height) {
                        height = $o.canva.holder.height;
                        width = height * ratio;
                    }
                }
                left = ($o.canva.holder.width - width) / 2;
                top = ($o.canva.holder.height - height) / 2;

                $o.carousel.hideLoadingImage();
                $("#oct8ne-helper, #oct8ne-helper img,#item-title-up").show();


                $o.canva.showImageOnCanva(left, top, width, height, parameters.InternalId);

                if ($o.canva.imageFromAgent) {
                    $("#agent-suggestions-items").show("pulsate", { times: 4 }, 200, function () {
                        window.viewedVM.setActiveTab();
                    });

                    $o.canva.imageFromAgent = false;
                }

                $o.search.sendingProductToCanva = false;
            };

            preload.src = path;

            if ($o.core.youtubeViewModel.isPlaying()) $o.core.youtubeViewModel.clear();

        }
    };

    $o.canva.showImageOnCanvaUI = function (left, top, width, height, internalId) {

        $o.canva.target.object.css({
            height: height + "px",
            width: width + "px"
        });
        $o.canva.holder.helper.css({
            height: height + "px",
            width: width + "px",
            top: top + "px",
            left: left + "px"
        });
        $o.canva.target.width = width;
        $o.canva.target.height = height;
        $o.canva.target.object.show();

        var visitorToken = (($o.core.globalVariables.userType == "V") && ($o.core.agentsConnected)) ? $o.core.globalVariables.myToken : $o.core.globalVariables.otherToken;

        $o.pin.recoverPins(visitorToken, internalId, $o.carousel.currentImage);
        if ($o.core.globalVariables.userType == "V") $o.visitorSearch.enableSelectResult = true;

        if (!$o.pencil.drawing) $o.pencil.init();

        $o.pencil.changeCanvaImage(internalId);

    };

    $o.canva.validatePosition = function (x, y, tool) {
        var validation = [];
        var img = $o.canva.holder.helper;
        var holder = $o.canva.holder.object;
        var bottom = -(img.height() - holder.height());
        var right = -(img.width() - holder.width());

        validation["left"] = x;
        validation["top"] = y;
        if (x < right) validation["left"] = right;
        if (y < bottom) validation["top"] = bottom;
        if (x > 0) validation["left"] = 0;
        if (y > 0) validation["top"] = 0;
        if (!tool) {
            if (img.width() <= holder.width()) {
                validation["left"] = parseInt(right / 2);
            }
            if (img.height() <= holder.height()) {
                validation["top"] = parseInt(bottom / 2);
            }

            if ((validation["top"] != null) || (validation["left"] != null)) {
                img.animate({ top: validation["top"], left: validation["left"] }, 200);
            }
        }
        return validation;
    };




};
//EVENTOS  
$o.carousel.events = function () {

    $("#oct8ne-nodes").on("click", "li div div", function () {
        var nodeId = $(this).attr("data-nodeid");
        if (nodeId != $o.core.globalVariables.internalId && !$o.search.sendingProductToCanva) {
            $o.search.sendingProductToCanva = true;
            $o.carousel.sentProductToCanva(nodeId);
        } else {
            $o.sideBubbles.hide();
        }
    });

    $("#prev-image").on("click", function () {
        if (!$o.search.sendingProductToCanva) {
            $o.search.sendingProductToCanva = true;
            $o.carousel.clickPrevImage();

        }
    });
    $("#next-image").on("click", function () {
        if (!$o.search.sendingProductToCanva) {
            $o.search.sendingProductToCanva = true;
            $o.carousel.clickNextImage();
        }
    });

    $("#items-order-list").on("click", "li", function () {
        if ($(this).hasClass("current")) {
            return;
        };


        if (!$o.search.sendingProductToCanva) {
            $o.carousel.goImageN($(this).index() + 1);
            $("#items-order-list li").removeClass().addClass("custom-coviewer-image-dots CVBkg5");
            $(this).removeClass().addClass("current custom-coviewer-image-dots CVBkg4");
            $o.search.sendingProductToCanva = true;
        }
    });

    $(".coviewer-wrapper").on("click", "#item-title-up", function () {
        if ($o.core.globalVariables.userType == "V") {
            $o.saveRecord.titleB(); //ojo con la redireccion! SETIMEOUT?
            var productId = $o.fullProducts.searchProduct($o.core.globalVariables.internalId);
            if (productId.InternalId.indexOf("Oct8ne") == -1 && productId.RouteTo != null && productId.RouteTo != "") {
                $o.iframes.changeStatusIframe($o.iframes.iframeStatus.CHAT);//normmaly we go to 'chat' status
                if ($o.utils && $o.utils.rewriteIframeStatusInTitleBtn) { //some clients wants 'viewer' status
                    $o.iframes.changeStatusIframe($o.iframes.iframeStatus.VIEWER);
                }
                $o.core.doPostMessageToApi("GOTOPRODUCTPAGE", productId.RouteTo);
            }
        } else {
            return false;
        };
    });

    $("#oct8ne-content").on("click", "#mylist-advice", function () {
        $o.platform.loginShowMyList();
        $o.saveRecord.loginB();
    });

    $o.carousel.UI();
};

//FUNCIONES QUE MODIFICAN EL DOM 
$o.carousel.UI = function () {
    $o.carousel.createCoviewerPriceLayout = function (data) {
        var normalData = data.normalPrice;
        var normalLayout = "<div id='normal-price'><div style='" + normalData.line1.inlineStyle + "'>" + normalData.line1.textTemplate + "</div>";
        if (normalData.line2.textTemplate != "") {
            normalLayout += "<div   style='" + normalData.line2.inlineStyle + "'>" + normalData.line2.textTemplate + "</div>";

        } normalLayout += "</div>";
        normalLayout = normalLayout.replace("[0]", "<span>[0]</span>");

        var saleData = data.salePrice;
        var saleLayout = "<div id='sale-price'>";
        if (saleData.saleIcon) {
            saleLayout += '<div class="offer-icon custom-coviewer-sale-icon"><div class="sale-text custom-coviewer-sale-text BkgCorp"><span>' + culture.coviewer.Sale + '</span></div><div class="BorderUpCorp"></div></div>';
        }
        saleLayout += "<div style='" + saleData.line1.inlineStyle + "'>" + saleData.line1.textTemplate + "</div>";
        if (saleData.line2.textTemplate != "") {
            saleLayout += "<div style='" + saleData.line2.inlineStyle + "'>" + saleData.line2.textTemplate + "</div>";
        };
        saleLayout = saleLayout.replace("[0]", "<span class='price-old'>[0]</span>");
        saleLayout = saleLayout.replace("[1]", "<span class='price-new'>[1]</span>");
        saleLayout += "</div>";
        $("#price-wrapper").html(normalLayout + saleLayout);
    };

    $o.carousel.updateArrowsCarousel = function (newIndex) {
        newIndex < $o.carousel.images.length ? $("#next-image").show() : $("#next-image").hide();
        newIndex > 1 ? $("#prev-image").show() : $("#prev-image").hide();
        if ($o.carousel.carouselInterface == $o.carousel.carouselInterfaces.BULLETS) {
            $("#items-order-list li").removeClass().addClass("CVBkg5 custom-coviewer-image-dots");
            $("#items-order-list li:nth-child(" + newIndex + ")").removeClass().addClass("current CVBkg4 custom-coviewer-image-dots");
        } else {
            $(".current-img").html(newIndex);
        }
    };

    $o.carousel.setCurrentNodeActiveUI = function (nodeId, noUpdateScroll) {
        if (nodeId !== undefined && $("#oct8ne-nodes li").length) {
            $("#oct8ne-nodes li").removeClass("active  BorderCorp");
            var nodeIdScaped = nodeId.replace(/(?=[() ])/g, '\\');
            var node = $("#oct8ne-nodes li div div[data-nodeid='" + nodeIdScaped + "']");
            if (!node.length) { return; }

            node.parent().parent().addClass("active BorderCorp").focus();
            setTimeout(function () {
                $("#oct8ne-nodes").mCustomScrollbar("scrollTo", node.parent());
            }, 300);
        }
    };

    $o.carousel.fillCanvaInfo = function (node, imageIndex) {
        //$("#show-coviewer").show();

        //DESCRIPTION ZONE

        if ($o.search.openSeeDescription) {
            $("#info-icon-button ").trigger("click");
            $o.search.openSeeDescription = false;
        }
        if (node.Description == "" || node.Description == undefined || node.Description == null) {
            $(".info-icon-button").hide();
        } else {
            $(".info-icon-button").show();
        }

        var descString = node.Description;
        var descDiv = document.getElementById("item-description");

        if ($o.utils && $o.utils.descriptionWithHtml) {
            descDiv.innerHTML = descString;
        } else {
            descDiv.innerHTML = descString;
            descDiv.innerHTML = descDiv.textContent;
        }

        $("#item-description img , #item-description iframe ,#item-description a").remove();
        //END DESCRIPTION ZONE

        //MY LIST ZONE
        var isNodeAddedMyList = mylistVM.getProduct(node.InternalId);
        if (isNodeAddedMyList) {
            $("#add-to-mylist-tool-visitor").removeClass("icon-common-wishlist-icon custom-coviewer-icon-mylist CVTxt3").addClass("icon-common-like-button-high  custom-coviewer-icon-mylist-highlighted TxtCorp");
        } else {
            $("#add-to-mylist-tool-visitor").removeClass("icon-like-button-high custom-coviewer-icon-mylist-highlighted TxtCorp").addClass("icon-common-wishlist-icon custom-coviewer-icon-mylist CVTxt3");
        };

        // END MY LIST ZONE


        // GENERAL VARS 

        var imageOrder = imageIndex ? imageIndex : 0;
        $o.core.globalVariables.internalId = node.InternalId;
        $o.carousel.currentImage = 1;
        $o.carousel.images = {};
        $o.carousel.images = node.InternalId.indexOf("Oct8neUpload") == -1 ? node.Medias : "";

        //MANAGEMENT ARROWS
        $("#prev-image").hide();
        node.InternalId.indexOf("Oct8neUpload") == -1 ? (node.Medias.length == 1 ? $("#next-image").hide() : $("#next-image").show()) : $("#next-image").hide();


        //MANAGEMNT BULLETS
        $o.carousel.carouselInterface = node.Medias.length > 6 ? $o.carousel.carouselInterfaces.NUMBERS : $o.carousel.carouselInterfaces.BULLETS;

        if ($o.carousel.carouselInterface == $o.carousel.carouselInterfaces.BULLETS) {
            $o.carousel.createImageBullets(node.Medias);
        } else {
            node.InternalId.indexOf("Oct8neUpload") == -1 ? $(".total-img").html($o.carousel.images.length) : $(".items-order-list").hide();
            $o.carousel.createImageNumbers();
        };


        //TITULO PRODUCTO 
        var html = "<span class='main-title' title='" + node.Title + "'>" + node.Title + "</span>";
        $("#node-name, #item-title-up, #item-title").html(node.Title);
        if (node.InternalId.indexOf("Oct8neUpload") == -1 && node.InternalId.indexOf("Oct8neCatalog") == -1) {
            if ($o.core.globalVariables.userType == "V") {
                html = html + "<p class='button-view-in-page BkgCorp'><span class='icon-common-view-in-page'></span><span >" + culture.coviewer.ViewInPage + "</span></p>";
            }
            $("#item-title-up").addClass("view-in-page");
        } else {
            $("#item-title-up").removeClass("view-in-page");
        }
        $("#item-title-up").html(html);
        if (node.Title.length > 30) {
            $(".main-title").addClass("item-title-mini");
        } else {
            $(".main-title").removeClass("item-title-mini");
        }
        //END TITULO PRODUCTO

        //PRICE ZONE

        $(".view-grouped-product").remove();
        if (node.Price == "0.00" || node.Price == null) {
            if (node.InternalId.indexOf("Oct8neCatalog") >= 0) {
                $("#price-wrapper").hide();
                $("#price-wrapper-catalog").show().find("span").html(node.Price);
            } else {

                $("#price-wrapper,#price-wrapper-catalog").hide();
                if (node.InternalId.indexOf("Oct8ne") == -1) {
                    if ($o.core.globalVariables.userType == "A") {
                        $(".coviewer-tools").append('<div class="view-grouped-product" title="View product details">' + culture.coviewer.PricingDetails + '</div>');
                    }
                }
            }
        } else {
            if (node.InternalId.indexOf("Oct8neCatalog") >= 0) {
                $("#price-wrapper").hide();
                $("#price-wrapper-catalog").show().find("span").html(node.Price);
            } else {

                $("#price-wrapper>div").hide();
                if (node.PrevPrice != node.Price) { //ES PRECIO "SALE"
                    if ($o.core.globalVariables.apiVersion == "2.1") {
                        $("#sale-price").find("span.price-old").html($o.core.globalVariables.currencyVisitor + node.PrevPrice);
                        $("#sale-price").find("span.price-new").html($o.core.globalVariables.currencyVisitor + node.Price);
                    } else {
                        $("#sale-price").find("span.price-old").html(node.PrevPrice);
                        $("#sale-price").find("span.price-new").html(node.Price);
                    }
                    $("#sale-price,#sale-price div").show();
                } else { //ES PRECIO NORMAL
                    if ($o.core.globalVariables.apiVersion == "2.1") {
                        $("#normal-price span").html($o.core.globalVariables.currencyVisitor + node.Price);
                    } else {
                        $("#normal-price span").html(node.Price);
                    }

                    $("#normal-price").show();
                }

                $("#item-price-up").removeClass("grouped-price").html($o.core.globalVariables.currency + node.Price); //FALTA LA CURRENCY

                $("#price-wrapper-catalog").hide();

                if (node.InternalId.indexOf("Oct8neUpload") >= 0) { //Si es un Upload no mostra el icono de sale ni preu
                    $("#price-wrapper").hide();
                } else {
                    $("#price-wrapper,#product-page-tool").show();
                    $("#price-wrapper-catalog").hide();
                }
            }
        }

        //END PRICE ZONE

        if ($o.platform && $o.core.adapterLoaded === $o.core.adapters.PRO && $o.core.globalVariables.enterType != $o.core.enterType.CHECKOUT) $o.platform.showCartAndList(node.InternalId);


        //BUTTON ZONE - 'HAS OPTIONS' LOGICAL - Change button TEXT
        let cartButtonText = culture.coviewer.AddToCart;
        var cartButtonElement = $("#add-to-cart-tool:not('.custom-button-text')");

        if (!node.HasOptions || node.HasOptions == "false") {
            if ($o.utils && $o.utils.rewriteAddToCartText) { //some clients wants a different text with some logical by utils
                cartButtonText = $o.utils.rewriteAddToCartText();
                cartButtonElement.html(cartButtonText).attr("title", cartButtonText);
            } else {
                cartButtonElement.html("<span class='icon-common-mycart-icon CVTxt4'></span>" + cartButtonText).attr("title", cartButtonText);
            }
        } else {
            cartButtonText = culture.coviewer.SeeProductPage;
            if ($o.utils && $o.utils.rewriteSeeProductPageText) {
                //some clients wants a different text with some logical by utils
                var altText = $o.utils.rewriteSeeProductPageText();
                if (altText !== null) cartButtonText = altText;
            }
            cartButtonElement.html(cartButtonText).attr("title", cartButtonText);
        }

        //add class depending on text length
        cartButtonElement.removeClass("cartButtonLargeText cartButtonExtraLargeText");
        if (cartButtonText.length > 20 && cartButtonText.length < 32) { cartButtonElement.addClass("cartButtonLargeText"); }
        if (cartButtonText.length >= 32) { cartButtonElement.addClass("cartButtonExtraLargeText"); }

        //CATALOG BUTTON MANAGEMENT

        if (node.InternalId.indexOf("Oct8neCatalog") >= 0) {
            if ($o.platform && $o.platform.hideTotallyCartAndMyListButtons) $o.platform.hideTotallyCartAndMyListButtons();
            if (node.RouteTo) {
                $("#view-catalog-page").show().find("a").attr("href", node.RouteTo);
            } else {
                $("#view-catalog-page").hide();
            }
        } else {
            if ($o.core.globalVariables.edition == $o.core.editions.LITE && node.RouteTo && $o.platform && $o.core.globalVariables.userType == "V") {
                $("#view-catalog-page").show().find("a").attr("href", node.RouteTo);
            }
            else {
                $("#view-catalog-page").hide();
            }
        }
        //END CATALOG BUTTON MANAGEMENT

        if (node.InternalId.indexOf("Oct8neUpload") == -1) {
            $o.carousel.sendToCanva($o.carousel.images[imageOrder].FileName, $o.carousel.images[imageOrder].Id, $o.carousel.images[imageOrder].Type, "no-save");
        } else {
            $("#view-catalog-page").hide();
            if ($o.platform && $o.platform.hideTotallyCartAndMyListButtons) $o.platform.hideTotallyCartAndMyListButtons();
            $o.carousel.sendToCanva(node.URLMedia, node.URLMedia, "I", "no-save");
        }
        $o.search.sendingProductToCanva = false;
    };


    $o.carousel.loadingProduct = function () {
        $("#oct8ne-helper,#item-title-up,#product-page-tool").hide();
        $("#loading-product").fadeIn(100);
    };

    $o.carousel.loadingImage = function () {
        $("#loading-product").fadeIn(100);
    };

    $o.carousel.hideLoadingImage = function () {
        $("#loading-product").hide(0);
    };

    $o.carousel.createImageBullets = function (medias) {
        $("#items-number-list").hide();
        $("#items-order-list").empty();
        $.each(medias, function (i) {
            var li = i == 0 ? "<li class='current custom-coviewer-image-dots CVBkg4'></li>" : "<li class='CVBkg5 custom-coviewer-image-dots '></li>";
            $("#items-order-list").append(li);
        });
        var dotsLength = medias.length * 28;
        if (dotsLength > 180) dotsLength = 180;

        $("#items-order-list").css({ "margin": "12px auto", "width": dotsLength + "px" }).show();
    };

    $o.carousel.createImageNumbers = function () {
        $("#items-order-list").hide();
        $("#items-number-list").show();
        $(".current-img").html($o.carousel.currentImage);
        $(".total-img").html($o.carousel.images.length);
    };

    $o.carousel.addMediaFromUploadUI = function () {
        if ($o.core.userType == "A") {
            $("#upload-loading").remove();
        }
        else {
            if ($o.iframes.currentIframeStatus == $o.iframes.iframeStatus.CHAT) $o.iframes.changeStatusIframe($o.iframes.iframeStatus.SEARCH);
            if (window.location.pathname.indexOf("V3") > -1) {
                $(".upload-visitor-tool").addClass("icon-common-clip-upload").removeClass("loading-image");
            } else {
                $(".upload-visitor-tool").addClass("icon-common-upload-button").removeClass("loading-image");
            }
        }
        $(".info-icon-button").hide();
    };

    $o.carousel.addDocFromUploadUI = function () { //SUBIDA DE PDF
        if ($o.core.userType == "A") {
            $("#upload-loading").remove();
        }
        else {

            if (window.location.pathname.indexOf("V3") > -1) {
                $(".upload-visitor-tool").addClass("icon-common-clip-upload").removeClass("loading-image");
            } else {
                $(".upload-visitor-tool").addClass("icon-common-upload-button").removeClass("loading-image");
            }
        }
        $(".info-icon-button").hide();
    };
};
//EVENTOS 
$o.chat.events = function () {

    $(".chat-send").on("click", function () { //SOLO BOTON EN AGENTE
        if ($o.core.globalVariables.isGone) {
            return;
        }
        var text = $("#chat-input").val();
        var chatLength = $("#chat-input").val().trim().length;
        if (chatLength > 0) {
            $o.chat.pressEnterOnSearchInput(text);
        }
        $("#chat-input").val("");
        $(".emoji-wysiwyg-editor").text("");
        if ($("#go-to-bottom").is(":visible")) {
            $("#oct8ne-chat-room").mCustomScrollbar("update");
        }
        return false;
        //  $o.chat.clickSendButton();
    });

    $("#chat-input").on("keyup", function (event) { //Ojo no tocar keyup.Debe ser as para contar correctamente el chatLength
        if ($o.core.globalVariables.isGone) {
            return;
        }
        var text = $("#chat-input").val();
        var chatLength = $("#chat-input").val().trim().length;
        if (event.keyCode == 13) {
            event.preventDefault();
            if (chatLength > 0) {
                $o.chat.pressEnterOnSearchInput(text);
            }
            $("#chat-input").val("");
            if ($("#go-to-bottom").is(":visible")) {
                $("#oct8ne-chat-room").mCustomScrollbar("update");
            }
            return false;
        } else {
            $o.chat.displayIsTyping(text, chatLength, event.keyCode);
        }
    });

    $("#chat-tool-box").on("keyup", ".emoji-wysiwyg-editor", function (event) { //EVENTO SOLO PARA NUEVO VISOR INPUT PARA EMOJIS
        if ($o.core.globalVariables.isGone) {
            return;
        }
        var text = $(".emoji-wysiwyg-editor").text();
        var chatLength = $(".emoji-wysiwyg-editor").text().trim().length;

        if ($o.core.globalVariables.userType === "A" && text.indexOf("#") === 0) { //CONTROL DE FILTRO COMMON PRHASES PARA AGENTE
            $o.agentTools.managementPhrasesFromChat(event, text, chatLength);
        }
        else {
            if (event.keyCode === 13) {
                event.preventDefault();
                if (chatLength > 0) {
                    $o.chat.pressEnterOnSearchInput(text);
                }
                $(".emoji-wysiwyg-editor").text("");
                if ($("#go-to-bottom").is(":visible")) {
                    $("#oct8ne-chat-room").mCustomScrollbar("scrollTo", "bottom");
                }
                return false;
            } else {
                $o.chat.displayIsTyping(text, chatLength, event.keyCode);
            }
        }
    });


    $("#chat-tool-box").on("paste", ".emoji-wysiwyg-editor", function (e) {
        if ($o.core.globalVariables.isGone) {
            return;
        }
        if ($o.settings.allowUploads && $o.settings.showCoviewer == "True" && !window.clipboardData) {
            //window.clipboardData-> En IE11 No podemos copiar imgenes         

            var image = e.originalEvent.clipboardData.items;
            if (image.length === 0) {
                return;
            }
            var blob = image[0].getAsFile();
            $o.chat.isMyPastedImageFile = blob;
            if (blob !== null) {
                var reader = new FileReader();
                reader.onload = function (event) {
                    $o.chat.imagePreviewPasted(event.target.result); // data url en formato baseUrl!
                    $o.chat.myPastedImageIn64 = event.target.result;
                };
                reader.readAsDataURL(blob);
            }
        }
    });


    $("#refresh-page-button , #refresh-page-afk").on("click", function () {
        $o.chat.refreshWindow();
    });

    $("#go-to-bottom").on("click", function () {
        $("#oct8ne-chat-room").mCustomScrollbar("scrollTo", "bottom");
    });

    $("#close-preview-pasted").on("click", function () {
        // console.log("CIERRA");
        $o.chat.closePastedPreview();
    });

    $(".oct8ne-chat-room").on("click", "a.target-parent", function (e) {
        e.preventDefault();
        $o.core.doPostMessageToApi("GOTOPRODUCTPAGE", $(this).attr("href"));
    });

    $("#send-pasted-image").on("click", function () {

        $(this).removeClass("icon-common-send");
        $(this).addClass("loading");


        var formDataToUpload = new FormData();
        formDataToUpload.append('token', $o.core.globalVariables.myToken);
        formDataToUpload.append('room', $o.core.globalVariables.room);
        formDataToUpload.append('files', $o.chat.isMyPastedImageFile);
        formDataToUpload.append('type', 'Coviwer');

        var callMethod = "SaveVisitorImage";
        if ($o.core.globalVariables.userType === "A") {
            callMethod = "SaveAgentImage";
        };


        $.ajax({
            type: "POST",
            url: $o.core.globalVariables.uploadUrl + "Files/" + callMethod,
            data: formDataToUpload,
            async: true,
            processData: false,
            contentType: false,
            success: function (result) {
                //  console.log(result);
                var imageToTreat = result.split(";");
                imageToTreat = imageToTreat[0];
                imageToTreat = imageToTreat.slice(19, -1); //RARO!
                //  console.log(imageToTreat);

                if (typeof imageToTreat === 'string') {
                    var data = imageToTreat.split(",");
                    if (data[2] == "UPLOAD") {
                        var fileUrl = data[0];
                        var isImage = $o.forms.imageValidator(fileUrl);

                        if (isImage) { //Image goes to coviewer
                            var random = Math.floor((Math.random() * 1000000) + 1);
                            var internalId = "Oct8neUpload-" + random;
                            var product = $o.carousel.getProductFromUpload(internalId, fileUrl, $o.core.globalVariables.userType);
                            $o.carousel.addMediaFromUploadUI();
                            $o.carousel.sendProductToCarousel(product, $o.carousel.lists.VIEWED, $o.carousel.actions.VIEWINCANVA);

                            if ($o.utils && $o.utils.executeActionAfterSendImage) {
                                $o.utils.executeActionAfterSendImage();
                            }
                        }
                    }
                }
                $o.chat.closePastedPreview();
            }
        });

    });


    $o.chat.UI();
};

//FUNCIONES QUE MODIFICAN EL DOM 
$o.chat.UI = function () {
    $o.chat.showJustLookingMessage = function () {
        $("#just-looking-option").show();
        $o.storage.local.set($o.core.localStorageTypes.JUSTLOOKINGOPTION, true);
    };

    $o.chat.hideJustLookingMessage = function () {
        $("#welcome-just-looking").parent().remove();
        $("#just-looking-option").hide();
        $o.storage.local.set($o.core.localStorageTypes.JUSTLOOKINGOPTION, false);
        $o.storage.local.set($o.core.localStorageTypes.JUSTLOOKINGBUTTON, $o.core.localStorageActions.REMOVE);
    };

    $o.chat.addAlertChat = function () { };

    $o.chat.typing = function (parameters) {
        if (parameters.Body.Original === "false") {
            $(".is-typing-layer").hide();
        } else if (parameters.Body.Original === "true") {

            $(".is-typing-layer").find('p').hide();
            $(".is-typing-layer .is-typing-dot").show();
            $(".is-typing-layer").show();
            clearTimeout($o.chat.typingTimer);
            $o.chat.typingTimer = setTimeout(function () {
                $(".is-typing-layer").hide();
            }, $o.chat.stopTypingInterval);
        } else {
            //text preview
            $(".is-typing-layer").find('p').text(parameters.Body.Original + '...').show();
            $(".is-typing-layer .is-typing-dot").hide();
            $(".is-typing-layer").show();
            clearTimeout($o.chat.typingTimer);
            $o.chat.typingTimer = setTimeout(function () {
                $(".is-typing-layer").hide();
            }, $o.chat.stopTypingInterval);
        }
    };

    $o.chat.hideTyping = function () {      
        $(".is-typing-layer").hide();
    };

    $o.chat.showTypingDelayFromBot = function () {
        $(".is-typing-layer").find('p').text("").css({ 'font-size': '', 'padding': '' });
        $(".is-typing-layer").show();
    };

    //Function cuando MINIMIZED
    $o.chat.addAlertProduct = function (parameters) {
        if ($o.iframes.currentIframeStatus !== $o.iframes.iframeStatus.SEARCH && $o.iframes.currentIframeStatus !== $o.iframes.iframeStatus.VIEWER) {
            if ($o.iframes.currentIframeStatus === $o.iframes.iframeStatus.MINIMIZED) {

                if ($o.utils && $o.utils.customSentProductText) {
                    let customText = $o.utils.customSentProductText();
                    $o.chat.sendAlert(customText + "<br/><b>" + parameters.Title + "</b>");

                } else {
                    $o.chat.sendAlert(culture.coviewer.TakeALook + "<br/><b>" + parameters.Title + "</b>");
                }
            }

            var product = parseInt($o.variablesVisitor.pendingProducts);
            $o.chat.alertProduct = product ? product + 1 : 1;
            $("#pending-products").text($o.chat.alertProduct).show();
            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [{ cookie: $o.cookies.pendingProducts, value: $o.chat.alertProduct }]);
        }
    };

    $o.chat.playVisitorSound = function () {

        if ($o.variablesVisitor.soundNotificationEnabled == 'True') {
            var controlSound = $o.storage.local.get($o.core.localStorageTypes.SOUND) ? $o.storage.local.get($o.core.localStorageTypes.SOUND) : "true";
            if (controlSound == "true") {
                var resp = $("#visitor-sound")[0].play();
                if (resp !== undefined) { resp.then(function () { }).catch(function (e) { }); }
            }
        };
    };

    $o.chat.showRatingsAreaInForm = function () {
        $(".rating-area-form").show();
    };

    $o.chat.closePastedPreview = function () {
        $("#preview-pasted").hide();
        $("#pasted-image").css("background", "none");
        $("#send-pasted-image").addClass("icon-common-send");
        $("#send-pasted-image").removeClass("loading");
    };

    $o.chat.dataURItoBlob = function (data) {
        var binStr = atob(data).split(',')[1],
            len = binStr.length,
            arr = new Uint8Array(len);

        for (var i = 0; i < len; i++) {
            arr[i] = binStr.charCodeAt(i);
        }
        return new Blob(arr);
    };

    $o.chat.toogleDenyVisitorTyping = function (status) {
        if ($o.core.globalVariables.userType === "V") {
            $o.chat.canVisitorType = !status;
            if (status === true) {
                $(".emoji-wysiwyg-editor").html("").hide(0);
                // $("#chat-input").val("").show().css({ "cursor": "not-allowed", "opacity": "1", "background": "#fbfbfb" }).attr("readonly", "readonly");
                $(".emoji-picker-icon").hide();
            } else {
                $(".emoji-wysiwyg-editor").show(0).attr("readonly", "false");
                // $("#chat-input").hide();
                $(".emoji-picker-icon").show();
                if (document.hasFocus()) {
                    $(".emoji-wysiwyg-editor").focus();
                }   
            }
        }
    };
};

//EVENTOS 
$o.drag.events = function () {
    $o.drag.object = $("#point-tool");
    $o.drag.object.click(function () {
        $o.tools.change($o.tools.type.POINT);
    });

    $o.canva.holder.helper.draggable()
        .on("dragstart", function (event, ui) {
            $o.canva.holder.helper.removeClass().addClass("dragging");
            $o.drag.enablePointing = false;
            startX = ui.position.left;
            startY = ui.position.top;
        })
        .on("dragstop", function (event, ui) {
            if ($o.zoom.level == 1) {
                $o.canva.holder.helper.animate({ top: startY, left: startX }, 200);
            }
            else {
                var dragPosition = $o.canva.validatePosition(ui.position.left, ui.position.top);
                $o.canva.holder.helper.removeClass();

                var drag = {
                    Coords: {
                        PosX: dragPosition['left'],
                        PosY: dragPosition['top']
                    },
                    SizeImage: {
                        Width: $o.canva.holder.helper.width(),
                        Height: $o.canva.holder.helper.height()
                    },
                    SizeCoviewer: {
                        Width: $("#oct8ne-holder").width(),
                        Height: $("#oct8ne-holder").height()
                    },
                    Room: $o.core.globalVariables.room,
                    SentBy: $o.core.userType,
                    ProductInternalID: $o.core.globalVariables.internalId,
                    ImageUrl: $o.core.globalVariables.urlMedia,
                    Type: "D",
                    ZoomLevel: $o.zoom.level
                };

                if ($o.core.isSignalRConnected()) { $o.hubsOut.sendDrag(drag); }
                if ($o.tools.context == $o.tools.type.POINT) {
                    $o.canva.holder.helper.removeClass().addClass("pointing");
                } if ($o.tools.context == $o.tools.type.PIN) {
                    $o.canva.holder.helper.removeClass().addClass("adding-pin");
                }
            }


        });
    $o.drag.UI();
    var startX, startY, stop;
};

//FUNCIONES QUE MODIFICAN EL DOM 
$o.drag.UI = function () {
    $o.drag.addPointUI = function (parameters, recover) {
        var pointPosition = {
            left: parameters.Coords.PosX * $o.canva.target.object.width(),
            top: parameters.Coords.PosY * $o.canva.target.object.height() + 15
        };
        var createPoint = function () {
            var colorClass = (parameters.SentBy == "A") ? "agent-point" : "visitor-point";
            $o.canva.holder.helper.append("<div data-x=" + parameters.Coords.PosX + " data-y=" + parameters.Coords.PosY + " style=\"left:" + pointPosition.left + "px; top:" + pointPosition.top + "px \" class='point " + colorClass + "' id='point" + parameters.MarkId + "'></div>");
            var currentPin = $("#point" + parameters.MarkId);
            currentPin
                .css({ width: '0', height: '0' })
                .show()
                .animate({ width: '50px', height: '50px', left: "-=25px", top: "-=25px" }, { duration: 350, queue: true })
                .animate({ width: '0', height: '0', left: "+=25px", top: "+=25px" }, { duration: 350, queue: true })
                .queue(function () {
                    $(this).dequeue();
                    $(this).remove();
                });
        };

        if ((parameters.SentBy != $o.core.globalVariables.userType)) {
            var otherCursorPosition = {
                left: pointPosition.left + parseInt($o.canva.holder.helper.position().left),
                top: pointPosition.top + parseInt($o.canva.holder.helper.position().top)
            };
            $(".other-cursor")
                .css({ opacity: 1 })
                .stop().animate({ top: otherCursorPosition.top, left: otherCursorPosition.left }, 1200, "easeOutExpo", function () {
                    createPoint();
                    var newPos = $o.tools.randomCursorPosition();
                    $(".other-cursor").delay(1000).animate({ top: newPos.top, left: newPos.left }, 1200, "easeOutQuad");
                });
        } else {
            createPoint(parameters, recover);
        }
    };
};
//EVENTOS 
$o.filters.events = function () {

    $(".filter-panel-wrapper").on("click", ".filter-title", function () { //PASAR A KO!
        $(this).next().slideToggle();
        $(this).find("span").toggleClass("plus-sign");
    });



//    //FILTER VISITOR
//    $("#filter-button").on("click", function () {
//        if (!$o.search.isSearching) {
//            if ($(this).hasClass("opened")) {
//                $(this).removeClass("opened CVBkg5").addClass("CVBkg2");
//            } else {
//                $(this).removeClass("CVBkg2").addClass("opened CVBkg5");
//            };
//            $("#sort-button").removeClass("opened CVBkg5").addClass("CVBkg2");
//            $("#filters-panel").css("overflow", "hidden");
//            $("#filters-panel").slideToggle(300, function () { $("#filters-panel").css("overflow", "auto"); });
//            $("#sort-results-panel").hide();
//        }
//    });

   
    //$(".filter-panel-wrapper").on("click", ".filter-options li", function () { //PASAR A KO!
       
    //    if ($(this).prev().attr("checked") !== "checked") {
    //        $(this).prev().attr("checked", true);
    //    } else {
    //        $(this).prev().attr("checked", false);
    //    }
    // });

    //$(".filter-panel-wrapper").on("change", ".filter-options input", function () { //PASAR A KO!
    //    $(this).next().trigger("click");
    //});

    

//    $("#filters-panel").on("click", "li", function () { //Escoge el filtro y realiza la bsqueda.
        
//        $o.search.resetSearch();
//        var filterValue = $(this).attr("data-param");
//        var filterParam = $(this).parent().parent().attr("data-param");

//        var filter = $o.filters.appliedFilters + "&" + encodeURIComponent(filterParam) + "=" + encodeURIComponent(filterValue);
//        $o.search.doSearch($o.search.searchTerm, filter, false, "true");
//        $("#filters-panel").slideToggle();
//        $o.filters.appliedFilters = filter;
//        var filterNum = $o.filters.appliedFilters.split("&").length - 1;
//        $("#filter-button").removeClass("opened CVBkg5").addClass("CVBkg2");
//        $("#filter-button p").disableSelection().text(filterNum).show();
//    });

    //    $("#filters-panel").on("click", "#filters-applied div p", function () { //Borra el filtro selecionado y realiza la bsqueda con los filtros activos
//        var param = $(this).parent().attr("data-param");
//        $(this).parent().remove();
//        var filterArray = $o.filters.appliedFilters.split("&");
//        for (var i = 0; i < filterArray.length; i++) {
//            if (!filterArray[i].search(param)) {
//                var index = filterArray.indexOf(filterArray[i]);
//                filterArray.splice(index, 1);
//            }
//        }
//        var filterNum = filterArray.length - 1;
//        if (filterNum == 0) {
//            $("#filter-button p").text("").hide();
//            $("#filter-button").removeClass("opened CVBkg5").addClass("CVBkg2");
//        } else {
//            $("#filter-button p").disableSelection().text(filterNum).show();
//        }
//        var filterNew = filterArray.join("&");
//        $o.search.resetSearch();
//        $o.search.doSearch($o.search.searchTerm, filterNew, false, "true");
//        $("#filters-panel").slideToggle();
//        $o.filters.appliedFilters = filterNew;
//    });

//    //FILTER AGENT SEARCH
//    $(".header-content").on("click", "#filter-button-agent" , function () {
//      //  $("#filters-panel-agent").css("overflow", "hidden");
//       // $("#filters-panel-agent").slideToggle(300, function () { $("#filters-panel-agent").css("overflow", "auto"); });
//        if ($("#filters-panel-agent").is(":visible")) {
//            $("#filters-panel-agent").hide();
//        } else {
//            $("#filters-panel-agent").show();
//        }
//        $("#sort-results-panel-agent").hide();      
//    });

//    $("#filters-panel-agent").on("click", "p", function () {
//        $(this).next().slideToggle();
//    });

//    $("#filters-panel-agent").on("click", "li", function () {
//        $o.search.resetSearch();
//        var filterValue = $(this).attr("data-param");
//        var filterParam = $(this).parent().parent().attr("data-param");
//        var filter = $o.filters.appliedFiltersAgentSearch + "&" + filterParam + "=" + filterValue;
//        $o.search.doSearch($o.search.searchTerm, filter);
//        $("#filters-panel-agent").slideToggle();
//        $o.filters.appliedFiltersAgentSearch = filter;
//    });



//    $("#filters-panel-agent").on("click", "#filters-applied-agent div p", function () { //Borra el filtro selecionado y realiza la bsqueda con los filtros activos
//        var param = $(this).parent().attr("data-param");
//        $(this).parent().remove();
//        var filterArray = $o.filters.appliedFiltersAgentSearch.split("&");
//        for (var i = 0; i < filterArray.length; i++) {
//            if (!filterArray[i].search(param)) {
//                var index = filterArray.indexOf(filterArray[i]);
//                filterArray.splice(index, 1);
//            }
//        }
//        var filterNew = filterArray.join("&");
//        $o.search.resetSearch();
//        $o.search.doSearch($o.search.searchTerm, filterNew);
//        $("#filters-panel-agent").slideToggle();
//        $o.filters.appliedFiltersAgentSearch = filterNew;
//    });

//    //FILTER AGENT VISITOR LAST-SEARCH

//    //$(".header-content").on("click", "#current-visitor-searches" ,function () {
//    //    $(this).css("color", "#545454");
//    //    $("#previous-visitor-searches").css("color", "#ffffff"); //OJO SETTINGS
//    //    if ($(".empty-search-visitor").is(":visible")) return;
//    //    lastSearchVM.setActive();
//    //    if (".overview:empty") $(".no-visitor-results-search").show();
//    //});

//    //$(".header-content").on("click","#previous-visitor-searches" ,function () {
//    //    $(this).css("color", "#545454");
//    //    $("#current-visitor-searches").css("color", "#ffffff");  //OJO SETTINGS
//    //    if ($(".empty-search-visitor").is(":visible")) return;
//    //    previousSearchVM.setActive();
//    //    if (".overview:empty") $(".no-visitor-results-search").show();
//    //});



    //SORT SECTION
    $(".sort-choice").click(function () {
        $(this).next().toggle(0);
    });


    $(".sort-filter li").click(function () {

        if ($("#search-term").val().length) {
            var trigger = $(this),
                dir = trigger.children().removeClass("CVTxt3").attr("class"),// == "asc" ? "desc" : "asc",
                sortBy = trigger.attr("id").replace("sort-by-", "");
            var splitOrderBy = trigger.text().split(" ");
            $(".sorted-by").text(splitOrderBy[splitOrderBy.length - 1].toLowerCase());
            $(".sorted-dir").text(dir);
            $("#sort-button").removeClass("opened");
            var dirNew = dir == "asc" ? "desc" : "asc";
            trigger.children().removeClass().addClass(dirNew + " CVTxt3");
            //trigger.siblings().children().removeClass();
            $o.search.resetSearch();
            $o.search.sortedBy = sortBy;
            $o.search.direction = dir;
            $o.search.doSearch($o.search.searchTerm, $o.filters.appliedFilters, false, "true");
            $("#sort-results-panel").hide();
            $("#sort-results-panel-agent").hide();
            sortBy = sortBy.substr(0, 6);
            $(".sort-choice a").text("Sorted by " + sortBy.charAt(0).toUpperCase() + sortBy.slice(1));
        }
    });

    //SORT DE VISITOR (DEPRECATED SOLO En VIEJO VISOR??)
    $("#sort-button").on("click", function () {
        if (!$o.search.isSearching) {
            if ($(this).hasClass("opened")) {
                $(this).removeClass("opened CVBkg5").addClass("CVBkg2");
            } else {
                $(this).removeClass("CVBkg2").addClass("opened CVBkg5");
            };
            $("#filter-button").removeClass("opened CVBkg5").addClass("CVBkg2");
            $("#sort-results-panel").css("overflow", "hidden");
            $("#sort-results-panel").slideToggle(300, function () { $("#sort-results-panel").css("overflow", "auto"); });
            $("#filters-panel").hide();
        }
    });

    //SORT DE AGENTE
        $(".header-content").on("click", "#sort-button-agent" , function () {
      //  $("#sort-results-panel-agent").css("overflow", "hidden");
      //  $("#sort-results-panel-agent").slideToggle(300, function () { $("#sort-results-panel-agent").css("overflow", "auto"); });
        if ($("#sort-results-panel-agent").is(":visible")) {
            $("#sort-results-panel-agent").hide();
        } else {
            $("#sort-results-panel-agent").show();
        }
        $("#filters-panel-agent").hide();
    });

//    $o.filters.UI();
//};

////FUNCIONES QUE MODIFICAN EL DOM 
//$o.filters.UI = function () {

//    $o.filters.createFiltersVisitor = function (data) {
//        //$o.log(data);
//        $("#filters-panel").empty();
//        var availableFilters = data.available;
//        var appliedFilters = data.applied;
//        if (appliedFilters.length > 0) {
//            $("#filters-panel").append("<div id='filters-applied' class='filters-applied'></div>");

//            $.each(appliedFilters, function (i) {  //Pinta los filtros aplicados
//                var appliedFilter = appliedFilters[i];
//                var filterWrapper = "<div data-paramLabel='" + appliedFilter.paramLabel + "' data-param='" + appliedFilter.param + "'>";
//                filterWrapper += "<span class='CHBkg2 CVTxt4' >" + appliedFilter.paramLabel + "</span><p class='CVBkg1' data-value='" + appliedFilter.value + "'>" + appliedFilter.valueLabel + "</p>";
//                $("#filters-applied").append(filterWrapper);
//            });
//        };
//        return availableFilters;
//    };

//  $o.filters.createFiltersAgentWithIdVisitor = function (data) {
//        var appliedFilters = data.applied;
//        var availableFilters = data.available;
//        if (appliedFilters.length > 0) {
//            var filterNames = " (";
//            $.each(appliedFilters, function (i) {  //Pinta los filtros aplicados
//                var appliedFilter = appliedFilters[i];
//                filterNames = filterNames + appliedFilter.valueLabel;
//                if (i != appliedFilters.length - 1) {
//                    filterNames += ", ";
//                } else { filterNames += ")"; }
//            });

//            window.contentVM.filtersApplied(filterNames);
//        }
//        return availableFilters;
//    };

//    $o.filters.createFiltersAgent = function (data) {
//        $("#filters-panel-agent").empty();
//        var availableFilters = data.available;
//        var appliedFilters = data.applied;
//        if (appliedFilters.length > 0) {
//            $("#filters-panel-agent").append("<div id='filters-applied-agent' class='filters-applied-agent'></div>");
//            $.each(appliedFilters, function (i) {  //Pinta los filtros aplicados
//                var appliedFilter = appliedFilters[i];
//                var filterWrapper = "<div data-paramLabel='" + appliedFilter.paramLabel + "' data-param='" + appliedFilter.param + "'>";
//                filterWrapper += "<span>" + appliedFilter.paramLabel + "</span><p data-value=" + appliedFilter.value + ">" + appliedFilter.valueLabel + "</p>";
//                $("#filters-applied-agent").append(filterWrapper);
//            });
//        }
//        return availableFilters;
//    };

    //$o.filters.printFilters = function (data, idCapa, availableFilters) {
    //    $.each(availableFilters, function (i) { //Pinta los filtros disponibles
    //        var filter = availableFilters[i];
    //        var filterWrapper = "<div data-paramLabel='" + filter.paramLabel + "' data-param='" + filter.param + "'>";
    //        filterWrapper += "<p  class='CVBkg2 CVTxt4'>" + filter.paramLabel + "</p>";
    //        filterWrapper += "<ul>";
    //        $.each(filter.options, function (x) {
    //            filterWrapper += '<li class="CVBkg5 CVTxt3" data-param="' + filter.options[x].value + '">' + filter.options[x].valueLabel + ' (' + filter.options[x].count + ')</li>';
    //        });
    //        filterWrapper += "</ul>";
    //        filterWrapper = filterWrapper.replace(/&lt;/g, "<").replace(/&gt;/g, ">");
    //        if ($o.core.userType == "V") {
    //            $("#filters-panel").append(filterWrapper);
    //        }
          
    //        if ($o.core.userType != "A" || idCapa != "filters-panel-visitor-searches") { //JEIEM OJOOOO
    //            $("#filters-panel-agent").append(filterWrapper);
    //        }
    //    });
    //};

};
//EVENTOS 
$o.forms.events = function () {
    /*VOICE FORMS DESDE AGENT TOOLS*/
    $("#agent-number").css("opacity", "0.5").attr("readonly", "readonly");

    $("input[name='call-invite']").change();

    $("#call-back-invitation").click(function () {
        $("#agent-number").css("opacity", "0.5").attr("readonly", "readonly");
    });

    $("#contact-invitation").click(function () {
        $("#agent-number").css("opacity", "1").removeAttr("readonly");
    });

    $("#invitation-send").click(function () { //FORMULARIO RADIO BUTTON EN VOZ ---  DEPRECATED ??
        if ($("#call-back-invitation").is(":checked")) {
            $o.forms.sendForm($o.forms.type.CALLBACK);
        };
        if ($("#contact-invitation").is(":checked")) {
            if ($("#agent-number").val() == 0) {
                alert(culture.coviewer.NumberBeforeSend);
            } else {
                var phoneNum = $("#agent-number").val();
                $o.forms.sendForm($o.forms.type.SENDCONTACT, phoneNum);
            }
        };
        $("#voice-tool-box").hide();
        $("#chat-tool-box").show();
        $("#chat-tool").addClass("active");
        $("#voice-tool").removeClass("active");
    });

    /*SKYPE DESDE AGENT TOOLS*/
    $("#skype-invitation").click(function () {
        var user = $o.core.globalVariables.mySkype;
        var link = "skype:" + user + "?call";
        if (!user) {
            alert(culture.coviewer.ConfigureSkype);
        } else {
            $o.forms.sendForm($o.forms.type.SKYPE, link);
            $("#voice-tool-box").hide();
            $("#chat-tool-box").show();
            $("#chat-tool").addClass("active");
            $("#voice-tool").removeClass("active");
        }
    });

    /*ASK SS FOR VISITOR DESDE AGENT TOOLS*/
    $("#allow-visitor-ss-only").click(function () {
        $o.forms.sendForm($o.forms.type.ASKFORSS);
        $("#voice-tool-box").hide();
        $("#chat-tool-box").show();
        $("#chat-tool").addClass("active");
        $("#voice-tool").removeClass("active");
    });



    /*UPLOAD DESDE AGENT TOOLS*/

    $("#upload-agent-file-path").change(function () {
        var ext = $("#upload-agent-file-path").val().split('.').pop().toLowerCase();
        if (ext != "") {
            if ($.inArray(ext, ['gif', 'png', 'jpg', 'jpeg', 'bmp', 'otf', 'pdf', 'xlsx', 'xls', 'doc', 'docx']) != -1) {

                $("#upload-token-agent").val($o.core.globalVariables.myToken);
                $("#upload-token-room").val($o.core.globalVariables.room);

                var posit = parseInt($("#oct8ne-nodes ul").css("width").replace("px", ""));
                $("#oct8ne-nodes ul").css("width", posit + 125 + 'px').append("<li id='upload-loading'>");

                if (navigator.appName.indexOf("Internet Explorer") != -1) { //yeah, he's using IE
                    $("#upload-agent-form").submit();
                } else if ((this.files[0].size / 1024 / 1024) < 10) {
                    if ((this.files[0].size / 1024 / 1024) != 0) {
                        $("#upload-agent-form").submit();
                    } else {
                        alert(culture.coviewer.EmptyUploadFile);
                    }
                } else {
                    alert(culture.coviewer.LargerUploadFile);
                }
            } else {
                alert(culture.coviewer.IncorrectExtensionUpload);
            };

            $(".upload-message").text(culture.coviewer.ImageUploaded);
            setTimeout(function () {
                $(".upload-message").text("");
            }, 4000);

            setTimeout(function () {
                $("#upload-tool").removeClass("active");
                $("#chat-tool").addClass("active");
                $("#tools-container").children().fadeOut(0);
                $("#chat-tool-box").fadeIn(0);
            }, 1000);
        }
    });

    /*ENVIAR FORMULARIOS DESDE AGENT TOOLS*/
    $("#get-info-doc").click(function () {
        $o.forms.sendForm($o.forms.type.DOCUMENT, "");
        backToChatState();
    });

    $("#get-send-email").click(function () {
        $o.forms.sendForm($o.forms.type.SENDSESSION, "");
        backToChatState();
    });

    $("#get-request-phone").click(function () {
        $o.forms.sendForm($o.forms.type.CALLBACK);
        backToChatState();
    });

    $("#get-stars-valoration").click(function () {
        $o.forms.sendForm($o.forms.type.STARSVALORATION);
        backToChatState();
    });

    $("#get-valoration").click(function () {
        $o.forms.sendForm($o.forms.type.VALORATION);
        backToChatState();
    });


    $(".get-custom-form-js").on("click", function () {
        var subtype = $(this).attr("attr-data");
        $o.forms.sendForm(subtype);
        backToChatState();
    });

    function backToChatState() {
        $("#form-tool-box").hide();
        $("#chat-tool-box").show();
        $("#chat-tool").addClass("active");
        $("#form-tool").removeClass("active");
    };

    $("#oct8ne-communications").on("click", ".download-doc", function () {
        var link = $(this).attr("data-link");
        link = link + "&token=" + $o.core.globalVariables.myToken + "&room=" + $o.core.globalVariables.room + "&who=" + $o.core.globalVariables.userType;
        window.location.href = link;
    });


    //FUNCIONES DE VISITOR
    $("#oct8ne-communications").on("click", "input", function () {
        $(this).focus();
    });

    /*RESPONDE  AL BOTON JUST LOOKING DE VISITANTE*/
    $("#oct8ne-communications").on("click", "#welcome-just-looking", function () {
        $o.chat.showJustLookingMessage();
        $o.saveRecord.justLookingB();
    });

    /*RELLENA EL VOICE FORM DESDE VISITANTE*/
    $("#oct8ne-communications").on("click", ".sending-phone", function () { //DEPRECATED CUANDO BORREMOS EL VISOR VIEJO
        var phone = $(this).prev().val();
        var canPass = $o.settings.privacyPolicy.length ? false : true;
        if ($o.settings.privacyPolicy.length) {
            var accept = $(this).prev().prev().find("input");
            if (!accept.is(":checked")) {
                accept.parent().addClass("data-contact-error").attr("aria-invalid", "true");
            } else {
                canPass = true;
                accept.parent().removeClass("data-contact-error").removeAttr("aria-invalid");
            }
        };

        if (phone == "") {
            alert(culture.coviewer.EnterPhoneNumber);
        } else {
            if (canPass) {
                var response = [phone];
                $o.forms.sendFormResponse($(this).attr("data-form-id"), response);
            };
        };
    });

    $("#oct8ne-communications").on("click", ".sending-phone-new", function () { //EVENTO NUEVO VISOR
        var phone = $(this).parent().parent().prev().find("input").val();
        var canPass = $o.settings.privacyPolicy.length ? false : true;
        $(this).parent().parent().prev().find("input").removeClass("data-contact-error").removeAttr("aria-invalid");

        if ($o.settings.privacyPolicy.length) {
            var accept = $(this).parent().parent().next().find("input");
            if (!accept.is(":checked")) {
                accept.parent().addClass("data-contact-error").attr("aria-invalid","true");
            } else {
                canPass = true;
                accept.parent().removeClass("data-contact-error").removeAttr("aria-invalid");
            }
        };

        if (phone == "") {
            //  alert(culture.coviewer.EnterPhoneNumber);
            $(this).parent().parent().prev().find("input").addClass("data-contact-error").attr("aria-invalid", "true");
        } else {
            if (canPass) {

                var response = [phone];
                $o.forms.sendFormResponse($(this).attr("data-form-id"), response);
            };
        };
    });

    /*RESPUESTAS DE SKYPE*/
    $("#oct8ne-communications").on("click", "#skype-decline", function () {
        var response = ["decline"];
        $o.forms.sendFormResponse($(this).attr("data-form-id"), response);
    });

    $("#oct8ne-communications").on("click", "#skype-accept", function () {
        var response = ["accept"];
        $o.forms.sendFormResponse($(this).attr("data-form-id"), response);
    });

    /*ALLOW SCREEN SHARING LADO VISITOR*/

    $("#oct8ne-communications").on("click", "#allow-visitor-ss", function () {
        var formId = $(this).attr("data-form-id");
        conferenceVM.installExtensionFlow(generateConferenceId(), formId);
    });

    $(".oct8ne-chat-room").on("click", ".install-advice-button", function () {
        var link = $("#crhome-extension-link a").attr("href");
        window.open(link);
        $(".install-advice").hide();
        $(".refresh-advice").show();
    });

    $(".oct8ne-chat-room").on("click", ".refresh-advice-button", function () {
        if ($o.core.userType == "V") {
            $o.core.doPostMessageToApi("REFRESHPAGE");    
        }
    });

    $(".oct8ne-chat-room").on("click", ".valoration-area span", function () {
        $(".error-valoration").hide();
        if ($(this).hasClass("active")) {
            $(this).removeClass("active");
        } else {
            $(this).addClass("active").siblings().removeClass("active");
        }
     });

    $(".oct8ne-chat-room").on("click", "#send-valoration", function () {
        $(".error-valoration").hide();
        var value = $(".valoration-area span.active").attr("data-form-id");
        if (!value) {
            $(".error-valoration").show();
        } else {
            value = value.split("-")[0];
            var formId = $(this).attr("data-form-id");
            var comment = $(".comment-valoration").val();
            var  response = [value, comment];
            $o.forms.sendFormResponse(formId, response);

            //MARCA LA SESSION
            var domain = $("#domain-id").val();
            var idAgent = $o.core.globalVariables.agentId;
            var tokenSession = $(this).attr("data-form-room");
            var agentName = $o.core.globalVariables.otherName;
            value = value === "bad" ? false : true;

            $o.visitorRatings.saveRateAgent(domain, tokenSession, idAgent, value, comment, agentName, $o.visitorRatings.TypeRatingGoodBad);
            $o.visitorRatings.agentRated = true;
        }
    });

    $(".oct8ne-chat-room").on("click", "#send-valoration-stars", function () {
        $(".error-valoration").hide();
        var input = $("#rating-area-stars input");

        var value = "";
        var i;
        for (i = 0; i < input.length; i++) {
            if (input[i].checked) {
                value = input[i].value;
            }
        }
        if (!value) {
            $(".error-valoration").show();
        } else {
            var formId = $(this).attr("data-form-id");
            var comment = $(".comment-valoration").val();
            var response = [value, comment];
            $o.forms.sendFormResponse(formId, response);

            var domain = $("#domain-id").val();
            var idAgent = $o.core.globalVariables.agentId;
            var tokenSession =$(this).attr("data-form-room");
            var agentName = $o.core.globalVariables.otherName;
            $o.visitorRatings.saveRateAgent(domain, tokenSession, idAgent, value, comment, agentName, $o.visitorRatings.TypeRatingStars);
            $o.visitorRatings.agentRated = true;

        }
    });


    /*VALIDAR Y RESPONDER FORMULARIO*/
    $("#oct8ne-communications").on("click", ".submit-contact-form", function () { //DEPRECATED CUANDO BORREMOS EL VISOR VIEJO
        var cName = $(this).parent().parent().prev().prev().prev();
        var cNameValid = false;
        var cEmail = $(this).parent().parent().prev();
        var regex = /^[a-zA-Z0-9._-]+([+][a-zA-Z0-9._-]+){0,1}[@][a-zA-Z0-9._-]+[.][a-zA-Z]{2,6}$/;
        var canPass = $o.settings.privacyPolicy.length ? false : true;

        if (cName.val() != "") { cNameValid = true; cName.removeClass("data-contact-error").removeAttr("aria-invalid"); };



        if ($o.settings.privacyPolicy.length) {
            var accept = $(this).parent().parent().prev().prev().prev().prev().find("input");
            if (!accept.is(":checked")) {
                accept.parent().addClass("data-contact-error").attr("aria-invalid","true");
            } else {
                canPass = true;
                accept.parent().removeClass("data-contact-error").removeAttr("aria-invalid");
            }
        };

        if (regex.test(cEmail.val()) && cNameValid) {

            if (canPass) {
                var data = [cName.val(), cEmail.val()];
                $o.forms.sendFormResponse($(this).attr("data-form-id"), data);

                var user = {
                    Email: data[1],
                    FirstName: data[0],
                    Origin: "Chat form",
                    EnterPage: $o.core.globalVariables.sendEmailBaseUrl || $o.core.globalVariables.baseUrl
                };

                var queryString = "?domainId=" + $o.core.globalVariables.domainId + "&tokenVisitor=" + $o.variablesVisitor.tokenVisitor + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId + "&tokenSession=" + $o.core.globalVariables.room;
                $.post("/Oct8ne/DataVisitor" + queryString, user);
                //REVISAR
                if ($o.core.isSignalRConnected()) $o.hubsOut.sendDataVisitorToDashboard($o.core.globalVariables.room, user);
            };
        } else {
            cEmail.addClass("data-contact-error").attr("aria-invalid", "true");
            if (!cNameValid) cName.addClass("data-contact-error").attr("aria-invalid", "true");
            if (regex.test(cEmail.val())) cEmail.removeClass("data-contact-error").removeAttr("aria-invalid");
        }
    });


    $("#oct8ne-communications").on("click", ".submit-contact-form-new", function () { //EVENTO NUEVO VISOR 

        var cEmail = $(this).parent().parent().prev().find("input.customers-email"),
            cName = $(this).parent().parent().prev().find("input.customers-name"),
            cNameValid = false;
        canPass = $o.settings.privacyPolicy.length ? false : true,
            regex = /^[a-zA-Z0-9._-]+([+][a-zA-Z0-9._-]+){0,1}[@][a-zA-Z0-9._-]+[.][a-zA-Z]{2,6}$/;

        if (cName.val() != "") { cNameValid = true; cName.removeClass("data-contact-error").removeAttr("aria-invalid"); };

        if ($o.settings.privacyPolicy.length) { //FALTA CHEKEAR
            var accept = $(this).parent().parent().next().find("input");
            if (!accept.is(":checked")) {
                accept.parent().addClass("data-contact-error").attr("aria-invalid", "true");
            } else {
                canPass = true;
                accept.parent().removeClass("data-contact-error").removeAttr("aria-invalid");
            }
        };


        if (regex.test(cEmail.val()) && cNameValid) {
            cEmail.removeClass("data-contact-error").removeAttr("aria-invalid");
            if (canPass) {
                var data = [cName.val(), cEmail.val()];
                $o.forms.sendFormResponse($(this).attr("data-form-id"), data);

                var user = {
                    Email: data[1],
                    FirstName: data[0],
                    Origin: "Chat form",
                    EnterPage: $o.core.globalVariables.sendEmailBaseUrl || $o.core.globalVariables.baseUrl
                };

                var queryString = "?domainId=" + $o.core.globalVariables.domainId + "&tokenVisitor=" + $o.variablesVisitor.tokenVisitor + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId + "&tokenSession=" + $o.core.globalVariables.room;
                $.post("/Oct8ne/DataVisitor" + queryString, user);
                //REVISAR
                if ($o.core.isSignalRConnected()) $o.hubsOut.sendDataVisitorToDashboard($o.core.globalVariables.room, user);
            };

        } else {
            cEmail.addClass("data-contact-error").attr("aria-invalid", "true");
            if (!cNameValid) cName.addClass("data-contact-error").attr("aria-invalid", "true");
            if (regex.test(cEmail.val())) cEmail.removeClass("data-contact-error").removeAttr("aria-invalid");
        }
    });


    $("#oct8ne-communications").on("click", ".submit-send-session", function () { //DEPRECATED CUANDO BORREMOS EL VISOR VIEJO 
        var email = $(this).prev().val(),
            canPass = $o.settings.privacyPolicy.length ? false : true,
            regex = /^[a-zA-Z0-9._-]+([+][a-zA-Z0-9._-]+){0,1}[@][a-zA-Z0-9._-]+[.][a-zA-Z]{2,6}$/;

        if ($o.settings.privacyPolicy.length) {
            var accept = $(this).prev().prev().find("input");
            if (!accept.is(":checked")) {
                accept.parent().addClass("data-contact-error").attr("aria-invalid", "true");
            } else {
                canPass = true;
                accept.parent().removeClass("data-contact-error").removeAttr("aria-invalid");
            }
        }
        if (regex.test(email)) {
            $(this).prev().removeClass("data-contact-error").removeAttr("aria-invalid");
            if (email && canPass === true) {
                $o.visitorSearch.getRecordsMailInfo(email);
                var data = [email];
                $o.forms.sendFormResponse($(this).attr("data-form-id"), data);
            }
        } else {
            $(this).prev().addClass("data-contact-error").attr("aria-invalid", "true");
        }
    });

    $("#oct8ne-communications").on("click", ".submit-send-session-new", function () { //EVENTO NUEVO VISOR
        var email = $(this).parent().parent().prev().find("input").val(),
            canPass = $o.settings.privacyPolicy.length ? false : true,
            regex = /^[a-zA-Z0-9._-]+([+][a-zA-Z0-9._-]+){0,1}[@][a-zA-Z0-9._-]+[.][a-zA-Z]{2,6}$/;


        if ($o.settings.privacyPolicy.length) { //FALTA CHEKEAR

            var accept = $(this).parent().parent().next().find("input");
            if (!accept.is(":checked")) {
                accept.parent().addClass("data-contact-error").attr("aria-invalid", "true");
            } else {
                canPass = true;
                accept.parent().removeClass("data-contact-error").removeAttr("aria-invalid");
            }
        };

        if (regex.test(email)) {
            $(this).parent().parent().prev().find("input").removeClass("data-contact-error").removeAttr("aria-invalid");
            if (email && canPass === true) {
                $o.visitorSearch.getRecordsMailInfo(email);
                var data = [email];
                $o.forms.sendFormResponse($(this).attr("data-form-id"), data);
            }
        } else {
            $(this).parent().parent().prev().find("input").addClass("data-contact-error").attr("aria-invalid", "true");
        }
    });

    /*UPLOAD DE VISITANTE*/
    $("#upload-visitor-tool").on("change", "#upload-visitor-file-path", function (e) {
        e.preventDefault();
        $("#upload-token-visitor").val($o.core.globalVariables.myToken);
        $("#upload-token-room").val($o.core.globalVariables.room);

        var ext = $("#upload-visitor-file-path").val().split('.').pop().toLowerCase();
        if (ext != "") {
            if ($.inArray(ext, ['gif', 'png', 'jpg', 'jpeg', 'bmp', 'otf', 'pdf', 'xlsx', 'xls', 'doc', 'docx']) != -1) {

                var posit = parseInt($("#oct8ne-nodes ul").css("width").replace("px", ""));
                $("#oct8ne-nodes ul").css("width", posit + 125 + 'px').append("<li id='upload-loading'>");

                if ($("#mylist-advice").is(":visible")) {
                    $("#mylist-advice").hide();
                }

                if (navigator.appName.indexOf("Internet Explorer") != -1) { //yeah, he's using IE
                    if ($o.core.userType == "V") { $(".upload-visitor-tool").removeClass("icon-common-upload-button , icon-common-clip-upload").addClass("loading-image"); }
                    $("#upload-visitor-form").submit();
                } else if ((this.files[0].size / 1024 / 1024) < 10) {
                    if ((this.files[0].size / 1024 / 1024) != 0) {
                        if ($o.core.userType == "V") { $(".upload-visitor-tool").removeClass("icon-common-upload-button , icon-common-clip-upload").addClass("loading-image"); }
                        $("#upload-visitor-form").submit();
                    } else {
                        alert(culture.coviewer.EmptyUploadFile);
                    }
                } else {
                    alert(culture.coviewer.LargerUploadFile);
                }

            } else {
                alert(culture.coviewer.IncorrectExtensionUpload);
            }

            $("#upload-tool").removeClass();
        }
    });

    /*BOTON RECONECTAR SESION DESDE VISITOR*/
    $("#oct8ne-communications").on("click", ".submit-reconnect-session", function (e) {
        $o.visitorSearch.actionWhenClosingIframe();

        //if (($o.variablesVisitor.nowInteractionAFK - $o.variablesVisitor.lastInteractionAFK) < $o.variablesVisitor.referenceTimeAFK) {
        //    $("#chat-input").attr("readonly", false).focus();
        //    $("#chat-input").removeClass("chat-input-disabled");

        //    if ($(".emoji-wysiwyg-editor").is(":visible")) {
        //        $(".chat-input-emoji").removeClass("chat-input-disabled"); //Nuevo Visor
        //        $(".emoji-wysiwyg-editor").attr("contenteditable", true).focus();   //NUevo visor
        //    }
        //    $o.canned.sendCannedResponse($(this).attr("data-form-id"), ["responsed"]);
        //    //$o.visitorSearch.changeToWaitingStatus();
        //    $o.variablesVisitor.status = "";
        //    $o.core.globalVariables.room = "";
        //    var queryString = "statusVisitor=" + $o.variablesVisitor.status
        //        + "&tokenVisitor=" + $o.variablesVisitor.tokenVisitor
        //        + "&tokenSession=" + $o.core.globalVariables.room
        //        + "&domainId=" + $o.variablesVisitor.domain + "&sessionSummaryId=" + $o.variablesVisitor.sessionSummaryId;
        //    $.post("Visitor/AgentsConnected?" + queryString, { domainId: $o.variablesVisitor.domain, deptId: $o.visitorStart.assignedDepartment.Id, isReconnect: true }, function (agentsConnected) {
        //        $o.core.agentsConnected = true;
        //        $o.core.hasBeenWaiting = false;
        //        $o.visitorSearch.enableSelectResult = false;
        //        $o.chat.startedChangeToWaiting = false;
        //        if (agentsConnected == "True") {
        //            if (!$o.core.isSignalRConnected()) {
        //                $.connection.hub.start().done(function () {
        //                    $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [{ cookie: $o.cookies.connection, value: $.connection.hub.id }]);
        //                    $o.visitorStart.visitorStart($o.visitorStart.enterTypeForStart);
        //                });
        //            }
        //        } else {
        //            $o.core.globalVariables.agentsConnected = false;
        //            $o.core.agentsConnected = false;
        //            $o.canned.sendCanned($o.canned.type.NOMOREAGENTS);
        //            $o.inactivity.disableChatInputUI();
        //            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [
        //                { cookie: $o.cookies.sessionWithoutAgent, value: true }
        //            ]);
        //        }
        //    });
        //}
    });

    $("#oct8ne-communications").on("click", ".busy-js , .overbooking-js ,.no-agents-js", function () {
        $("#email-us-form").show();
        $("#chat-wrapper").hide();
        $o.storage.local.set($o.core.localStorageTypes.LASTDISPLAY, "form");
        $o.canned.sendCannedResponse($(this).attr("data-form-id"), ["responsed"]);
        $o.forms.closeSession(); //CERRAR SESION AUNQUE SE VEA EL FORMULARIO DE CONTACTO

    });


    /*FORMULARIO ENVIADO DESDE END SESSION DE AGENTE*/
    $("#oct8ne-communications").on("click", ".submit-send-session-recover", function () {
        var email = $(this).prev().val();
        var regex = /^[a-zA-Z0-9._-]+([+][a-zA-Z0-9._-]+){0,1}[@][a-zA-Z0-9._-]+[.][a-zA-Z]{2,6}$/;
        if (regex.test(email)) {
            if (email) {
                //$o.forms.sessionToEmailForm(email, true);
                $o.visitorSearch.getRecordsMailInfo(email);
            }
            //  $(".message-email").html(culture.coviewer.EmailSummary);
            $(this).parent().parent().html("<p class='CHTxt4'>" + culture.coviewer.EmailSummary + "</p>");
            $(this).prev().hide();
            $(this).hide();
        } else {
            $(this).prev().addClass("data-contact-error").attr("aria-invalid","true");
        }
    });

    /*Formulario Para buscar un pedido*/
    $("#oct8ne-communications").on("click", "#sending-search-order", function () {
        var orderOptions = $o.forms.orderStatusOptions();
        var inputDataId = $(this).attr("data-form-id");

        orderOptions.OrderId = $("input[data-form-id="+inputDataId+"]").val();
        $o.platform.orders.getDetailsFromVisitor(orderOptions);
        var data = [orderOptions.OrderId];
        $o.forms.sendFormResponse($(this).attr("data-form-id"), data);
    });

    $o.forms.UI();
};

//FUNCIONES QUE MODIFICAN EL DOM 
$o.forms.UI = function () {
    $o.forms.removeFormCheckout = function () {
        $(".from-checkout").parent().parent().remove();
    };

    $o.forms.updateScroll = function (value) {
        $("#oct8ne-chat-room").scrollTop(value);
    };
};
//EVENTOS 
//$o.note.events = function() {
//    $o.note.object.click(function () {
//        $o.tools.change($o.tools.type.NOTE);
//    });

//    $o.canva.holder.helper
//        .on("click", ".note", function (e) {
//            $(this).find(".note-message").toggle("slide");
//            e.stopPropagation();
//        })
//        .on("click", ".note textarea", function (e) {
//            $(this).find(".note-message").toggle("slide");
//            e.stopPropagation();
//        })
//        .on("click", ".send-note", function (e) {
//            var sendButton = $(this);
//            $o.note.currentNoteInfo.Body = $(this).prev().val();

//            if ($o.core.agentsConnected && $o.note.currentNoteInfo.Body) {
//                $o.hubsOut.sendNote($o.note.currentNoteInfo);
//            }

//            $o.hubsOut.addInteraction($o.note.currentNoteInfo);
//            $o.note.currentNoteInfo = "";

//            sendButton.parent().hide("slide");
//            sendButton.prev().attr("readonly", "readonly");
//            sendButton.remove();
//            e.stopPropagation();
//        })
//        .on("click", ".close-note", function (e) {
//            var noteWrapper = $(this).parent();
//            noteWrapper.hide("slide");
//            if (!noteWrapper.find("textarea").val().length) {
//                noteWrapper.parent().remove();
//            }
//            e.stopPropagation();
//        });
//    $o.note.UI();
//};

////FUNCIONES QUE MODIFICAN EL DOM 
//$o.note.UI = function () {

//    $o.note.createNoteUI = function (parameters, recover, pinPosition) {
//        if (!recover) $o.hubsOut.addInteraction(parameters);
//        var colorClass = (parameters.SentBy == "A") ? "icon-agent-notes" : "icon-notes";
//        $o.canva.holder.helper.append("<div data-zoom=" + parameters.Coords.Zoom + " data-x=" + parameters.Coords.PosX + " data-y=" + parameters.Coords.PosY + " style=\"left:" + pinPosition.left + "px; top:" + pinPosition.top + "px \" class='note " + colorClass + "' id='note" + parameters.MarkId + "'></div>");
//        var currentNote = $("#note" + parameters.MarkId);

//        currentNote.append("<div class='note-message'><textarea>" + parameters.Body + "</textarea><div class='close-note'>" + culture.coviewer.Close + "</div></div>");

//        if ((currentNote.offset().left - $("#oct8ne-holder").offset().left) > 250) {
//            currentNote.find(".note-message").css("margin-left", "-155px");
//        }
//        if ((currentNote.offset().top - $("#oct8ne-holder").offset().top) > 130) {
//            currentNote.find(".note-message").css("margin-top", "-127px");
//        }

//        if (parameters.Body != "") {
//            currentNote.find("textarea").attr("readonly", "readonly");
//        } else {
//            currentNote.find("textarea").after("<div class='send-note'>" + culture.coviewer.Send + "</div>");
//        }
//    };

//    $o.note.mouseNoteUI = function (parameters, recover, pinPosition) {
//        var otherCursorPosition = {
//            left: pinPosition.left + parseInt($o.canva.holder.helper.position().left),
//            top: pinPosition.top + parseInt($o.canva.holder.helper.position().top+20)
//        };
//        var sender = $o.core.globalVariables.userType == "V" ? "agent" : "visitor";
//        $(".other-cursor")
//           .css({ opacity: 1, top: "311px", left: "212px" })
//            .addClass(sender + "-note").
//            stop().animate({ top: otherCursorPosition.top, left: otherCursorPosition.left }, 1800, "easeOutExpo", function () {
//                $o.note.createNoteUI(parameters, recover, pinPosition);
//                var newPos = $o.tools.randomCursorPosition();
//                $(".other-cursor").delay(5000).animate({ top: newPos.top, left: newPos.left }, 1200, "easeOutQuad", function () {
//                    $(this).removeClass(sender + "-note").css({ opacity: .5 });
//                });
//            });
//    };
//};
//EVENTOS 
$o.pin.events = function () {
    $o.pin.object.click(function () {
        $o.tools.change($o.tools.type.PIN);
    });
    $o.pin.UI();
};

//FUNCIONES QUE MODIFICAN EL DOM 
$o.pin.UI = function () {
    $o.pin.mousePinUI = function (parameters, pinPosition) {
        var currentImage = $o.carousel.currentImage,
            currentItem = $o.core.globalVariables.internalId;


        $(".other-cursor")
                    .stop()
                    .css({ opacity: 1, top: "311px", left: "212px" })
                    .addClass("agent-pin")
                    .animate({ top: pinPosition.top + parseInt($o.canva.holder.helper.position().top), left: pinPosition.left + parseInt($o.canva.holder.helper.position().left) }, 1500, "easeOutExpo", function () {
                     
                        var newPos = $o.tools.randomCursorPosition();
            if (currentImage == $o.carousel.currentImage && currentItem == $o.core.globalVariables.internalId) {
                $o.pin.addPin(parameters, pinPosition);
                $(".other-cursor").delay(1000).animate({ top: newPos.top, left: newPos.left }, 1000, "easeOutQuad", function() {
                    $(this).removeClass("agent-pin").css({ opacity: .5 });
                });
            } else {
                $(".other-cursor").delay(2000).css({ top: newPos.top, left: newPos.left }).removeClass("agent-pin").css({ opacity: .5 });
            }
        });
    };

    $o.pin.addPinUI = function (parameters, pinPosition) {
        $o.canva.holder.helper.append("<div data-x=" + parameters.Coords.PosX + " data-y=" + parameters.Coords.PosY + " id=" + parameters.Id + " style=\"left:" + pinPosition.left + "px; top:" + pinPosition.top + "px \" class='TxtCorp icon-common-pin-icon pin-shape'></div>");
    };
};
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.scroll = {
        init: function () {
            //controlamos visibility para actualizar chat
            function getHiddenProp() {
                var prefixes = ['webkit', 'moz', 'ms', 'o'];
                if ('hidden' in document) return 'hidden';
                for (var i = 0; i < prefixes.length; i++) {
                    if ((prefixes[i] + 'Hidden') in document)
                        return prefixes[i] + 'Hidden';
                }
                return null;
            }

            var visProp = getHiddenProp();

            if (visProp) {
                var evtname = visProp.replace(/[H|h]idden/, '') + 'visibilitychange';
                document.addEventListener(evtname, visChange);
            }

            function visChange() {
                if (!isHidden()) {
                    if ($o.core.agentsConnected) {

                        //  $("#oct8ne-chat-room").mCustomScrollbar("scrollTo", "bottom", { timeout: 500 });


                    };
                }
            }

            function isHidden() {
                var prop = getHiddenProp();
                if (!prop) return false;
                return document[prop];
            }

            //final visibility

            if (mCustomScrollbar) {


                $("#oct8ne-nodes").mCustomScrollbar({
                    updateOnContentResize: true,
                    axis: "x",
                    theme: "dark-thin",
                    scrollInertia: 200,
                    scrollbarPosition: "inside",
                    autoHideScrollbar: true,
                    scrollButtons: {
                        enable: true,
                        scrollAmount: "auto"
                    },
                    mouseWheel: { preventDefault: true },
                    advanced: { updateOnSelectorChange: "ul li" },
                    alwaysShowScrollbar: 0
                });

                $("#results-search").mCustomScrollbar({
                    updateOnContentResize: true,
                    axis: "y",
                    scrollInertia: 200,
                    autoHideScrollbar: true,
                    scrollbarPosition: "inside",
                    scrollButtons: {
                        enable: true,
                        scrollAmount: "auto"
                    },
                    theme: "dark-thin",
                    mouseWheel: { preventDefault: true },
                    callbacks: {
                        onTotalScroll: function () {  //REVISAR  onUpdate en vez de onTotalScroll
                            if ($o.scroll.enableSearch) {
                                setTimeout(function () {
                                    $o.scroll.enableSearch = true;
                                }, 500);

                                if ($o.search.searchMode == $o.search.searchModes.RESULTS) {
                                    $o.search.itsANewSearch = false;
                                    $o.search.doSearch($o.search.searchTerm, $o.core.userType == "V" ? $o.filters.appliedFilters : $o.filters.appliedFilters);
                                } else {
                                    $o.search.itsANewSearch = false;
                                }
                            }
                        }
                    },
                    alwaysShowScrollbar: 0
                });

                $("#oct8ne-chat-room").mCustomScrollbar({
                    updateOnContentResize: true,
                    alwaysTriggerOffsets: false,
                    axis: "y",
                    scrollInertia: 300,
                    autoHideScrollbar: true,
                    scrollbarPosition: "inside",
                    //scrollButtons: {
                    //    enable: true,
                    //    scrollAmount: "auto"
                    //},
                    theme: "dark-thin",
                    mouseWheel: { preventDefault: true },
                    callbacks: {
                        onUpdate: function () {
                            if (!$o.chat.noUpdateScroll) {
                                $("#oct8ne-chat-room").mCustomScrollbar("scrollTo", "bottom", { callbacks: false });
                            }
                            //else {
                            //    $o.chat.noUpdateScroll = false;
                            //}
                        },
                        //onTotalScroll: function () {
                        //    console.log("on total");
                        //    $("#oct8ne-chat-room").mCustomScrollbar("scrollTo", "bottom", { callbacks: false });
                        //},
                        onScroll: function () {
                            var chatHeight = $("#oct8ne-chat-room .mCSB_container").height();
                            if ((chatHeight + this.mcs.top) > 550) {
                                $o.scroll.disableScroll();
                            } else {
                                $o.scroll.enableScroll();
                            }
                        }
                    },
                    alwaysShowScrollbar: 0
                });
            } else {
                document.getElementById("server-overload").style.display = 'block';
            }
        },


        disableScroll: function () { //Muestra Boton y descativa scroll temporalmente
            $("#go-to-bottom").fadeIn(500);
            $o.chat.noUpdateScroll = true;

        },

        enableScroll: function () { //Esconde boton y activa scroll again
            $("#go-to-bottom").fadeOut(300);
            $("#warning-chat").text("").hide();
            $o.chat.noUpdateScroll = false;
            $o.chat.alertMessageInChat = null;
        },

        moveScroll: function (target, value) {//DEPRECATED
            $("#" + target).scrollTop(value);
        },

        moveChatToBottom: function () { //Only in Mobile cuz we are removed customscrollbar plugin and we need to force the scroll to bottom
            return; //In desktop, nothing happens
        },

        enableSearch: true
    };
})(window);
//EVENTOS 
$o.search.events = function () {
    $("#search-term").on("keyup", function (e) {
        if ((e.keyCode === $.ui.keyCode.ENTER) && ($(this).val().length) && (!$o.search.isSearching)) {
            if ($(this).val() === "No previous searches") return; //Problema con el knockout; hay que capar la bsqueda de "No previous searches".

            $("#no-results-search,#no-products-related").hide();
            $(".preload-image,.results .loading,.results .loading-products").remove();
            var searchInput = $(this).val().replace("&", "%26");

            $o.search.searchTerm = searchInput;

            $("#filter-button p").text("");
            $o.search.resetSearch();
            $o.search.doSearch(searchInput, $o.filters.appliedFilters, false, "true");
            if ($("#results-search").not(":visible")) {
                $("#results-search").show();
            }
            if ($o.core.globalVariables.userType === "A") {
                $("#info-catalog").trigger("click");
                $(".empty-search-agent").hide();
            }
        } else {
            if (e.keyCode === $.ui.keyCode.ENTER && $o.core.globalVariables.apiVersion == "2.5" && !$o.search.isSearching) {
                $("#no-results-search,#no-products-related").hide();
                $(".preload-image,.results .loading,.results .loading-products").remove();
                $o.search.searchTerm = "";
                $o.search.resetSearch();
                $o.search.doSearch($o.search.searchTerm, $o.filters.appliedFilters, false, "true");
                if ($("#results-search").not(":visible")) {
                    $("#results-search").show();
                }
                if ($o.core.globalVariables.userType === "A") {
                    $("#info-catalog").trigger("click");
                    $(".empty-search-agent").hide();
                }
            }
        }
    });

    $("#search-action").on("click", function () {
        if (($("#visitor-last-search").hasClass("active") || $("#info-catalog").hasClass("active"))||($o.core.userType==="V")) {
            if ($("#search-term").val().length && !$o.search.isSearching) {
                if ($("#search-term").val() === "No previous searches") return; //Problema con el knockout; hay que capar la bsqueda de "No previous searches".

                $("#no-results-search,#no-products-related").hide();
                $(".preload-image,.results .loading,.results .loading-products").remove();
                var searchInput = $("#search-term").val().replace("&", "%26");

                $o.search.searchTerm = searchInput;

                $("#filter-button p").text("");
                $o.search.resetSearch();
                $o.search.doSearch(searchInput, $o.filters.appliedFilters, false, "true");
                if ($("#results-search").not(":visible")) {
                    $("#results-search").show();
                }
                if ($o.core.globalVariables.userType === "A") {
                    $("#info-catalog").trigger("click");
                    $(".empty-search-agent").hide();
                }
            } else {
                if ($o.core.globalVariables.apiVersion == "2.5" && !$o.search.isSearching) {
                    $("#no-results-search,#no-products-related").hide();
                    $(".preload-image,.results .loading,.results .loading-products").remove();
                    $o.search.searchTerm = "";
                    $o.search.resetSearch();
                    $o.search.doSearch($o.search.searchTerm, $o.filters.appliedFilters, false, "true");
                    if ($("#results-search").not(":visible")) {
                        $("#results-search").show();
                    }
                    if ($o.core.globalVariables.userType === "A") {
                        $("#info-catalog").trigger("click");
                        $(".empty-search-agent").hide();
                    }
                }
            };
        }
        else {
            var currentCategory = $("#filter-catalog-id").attr("data-filter-id");
            window.agentCatalogVM.getCatalog(currentCategory);
            $o.catalog.totalItems = 0;
        }           
    });

    //$(".results")
    //     .on("mouseenter", "li", function () {
    //         $(this).find(".product-info").show();
    //     })
    //     .on("mouseleave", "li", function () {
    //         $(this).find(".product-info").hide();
    //     });

    $("#more-info-item").on("click", function (e) {
        var info = $(this);
        if ($o.search.openSeeDescription) {   //cierra
            info.animate({ "bottom": "0" }, 150);
            $("#info-icon-button").attr("aria-expanded", "false");
        } else {//abre
            var newHeight = $("#item-description").height() + 30;
            info.animate({ "bottom": newHeight }, 300);
            $("#info-icon-button").attr("aria-expanded", "true");
        }
        $o.search.openSeeDescription = $o.search.openSeeDescription ? false : true;
    });


    $o.search.UI();
};

//FUNCIONES QUE MODIFICAN EL DOM 
$o.search.UI = function () {

    $o.search.createSearchPriceLayout = function (data) {
        var normalData = data.normalPrice;
        var normalLayout = "<div class='normal-price custom-search-product-price CVTxt3'><div style='" + normalData.line1.inlineStyle + "'>" + normalData.line1.textTemplate + "</div>";
        if (normalData.line2.textTemplate !== "") {
            normalLayout += "<div style='" + normalData.line2.inlineStyle + "'>" + normalData.line2.textTemplate + "</div>";

        } normalLayout += "</div>";
        normalLayout = normalLayout.replace("[0]", "<span>[0]</span>");
        // $o.carousel.priceLayouts.coviewer.normal = normalLayout;
        // $("#search-normal-price").html(normalLayout);
        $o.carousel.searchPriceLayouts.normal = normalLayout;

        var saleData = data.salePrice;
        var saleLayout = "<div class='sale-price custom-search-product-price-offer CVTxt3'>";
        saleLayout += "<div style='" + saleData.line1.inlineStyle + "'>" + saleData.line1.textTemplate + "</div>";
        if (saleData.line2.textTemplate !== "") {
            saleLayout += "<div style='" + saleData.line2.inlineStyle + "'>" + saleData.line2.textTemplate + "</div>";
        };

        saleLayout = saleLayout.replace("[0]", "<span>[0]</span>");
        saleLayout = saleLayout.replace("[1]", "<span>[1]</span>");

        saleLayout += "</div>";
        $o.carousel.searchPriceLayouts.sale = saleLayout;

    };

    $o.search.setDefaultSortChoiceUI = function () {
        $(".sort-choice a").text(culture.coviewer.SortedByRelevance);
    };

    $o.search.setSearchLayoutUI = function () {
        $(".my-list-items").hide();
        $(".my-search-items").show();
        $("#acces-to-mylist").text(culture.coviewer.AccessMyList);
    };

    $o.search.loadingSearchUI = function () {
        var targetDiv = $o.core.globalVariables.userType === "V" ? $(".results-wrapper") : $("#results-search .overview");
        targetDiv.append("<div class='loading custom-search-loading CVTxt4'><p class='custom-search-loading-text'>" + culture.coviewer.LoadingInteractions + "</p></div>").find(".loading").fadeIn(100);
    };

    $o.search.loadingMoreProductsUI = function () {
        var targetDiv = $o.core.globalVariables.userType === "V" ? $(".results") : $("#results-search .overview");
        targetDiv.append("<div class='loading-products custom-search-loading-products  CVBkg5 CVTxt4'>" + culture.coviewer.LoadingMoreProducts + "</div>").fadeIn(100);
    };

    $o.search.removeLoadingProductsUI = function () {
        if ($(".loading-products").length) $("#results-search").mCustomScrollbar("scrollTo", "-=50", { scrollInertia: 800, scrollEasing: "easeOut" });
        $(".preload-image,.results-wrapper .loading,.results .loading-products , .overview .loading").remove();

    };

    $o.search.setTotalItemsUI = function (totalItems) {
        $(".results>ul").css({ "height": (totalItems * 130) / 2 + "px !important" });
    };

    $o.search.clickFirstProductUI = function () {
        //$o.log("busca el primero");
        $(".product:first-child").trigger("click");
    };

    $o.search.hideNoProducts = function () {
        $("#no-results-search, #no-products-related").hide();
    };

    $o.search.showNoProducts = function () {
        $("#no-results-search").show();
        if (!$o.search.searchTerm || $o.search.searchTerm == "''") {
            $("#no-results-search span").html('""');
            } else {
           
            $("#no-results-search span").html('"' + $o.search.searchTerm.replace("%26", "&") + '"');
            }
        
    };

    $o.search.showNoProductsInCatalog = function () {
        $("#no-results-search").show();
        $("#no-results-search span").html('"' + culture.coviewer.EmptyCatalog + '"');

    };

    $o.search.showNoProductsInAgentCatalog = function () {
        $("#no-results-catalog").show();
        // $("#no-results-catalog span").html('"' + culture.coviewer.EmptyCatalog + '"');
    };


    $o.search.addNodeToMyListUI = function () {
        $("#add-to-mylist-tool-visitor").removeClass("icon-common-wishlist-icon custom-coviewer-icon-mylist CVTxt3").addClass("icon-common-like-button-high custom-coviewer-icon-mylist-highlighted TxtCorp");
        $("#add-to-mylist").delay(500).fadeIn(100).delay(1500).fadeOut(400);
    };

    $o.search.addNodeToCartUI = function () {        
        $("#add-to-mycart-toast").fadeIn(300).delay(3000).fadeOut(500);
    };

    $o.search.updateTyniScrollUI = function () {
        //$o.scroll.updateTinyScroll("results-search","relative");
    };
};
//EVENTOS 
$o.tools.events = function () {
    $o.tools.object = $("#oct8ne-tools");
    $("#coviewer-tools-box li").on("click", function () { //DEPRECATED
        if ($(this).attr("id") != "undo-tool") $(this).addClass("current-tool").siblings().removeClass();
    });

    $("#undo-tool").click(function () {
         $o.tools.undoPin();
    });
    $o.tools.UI();
};

//FUNCIONES QUE MODIFICAN EL DOM 
$o.tools.UI = function () {
    $o.tools.addClassAddingPin = function () {
        $o.canva.holder.helper.css({ opacity: 1 }).addClass("adding-pin");
    };
    
    $o.tools.addClassPointing = function() { //DEPRECATED
        $o.canva.holder.helper.addClass("pointing");
        $("#point-tool").addClass("current-tool").siblings().removeClass();
        $("#coviewer-tools-box li").addClass("current-tool").siblings().removeClass();
    };

    $o.tools.addClassAddingNote = function () { //DEPRECATED
        $o.canva.holder.helper.css({ opacity: 1 }).addClass("adding-note");
    };
};
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.accessibility = {
        currentPopup: null,
        init: function () {
            $("body").on("keypress", '[tabIndex="0"]', function (e) {
                if (e.keyCode === 13 || e.keyCode === 32) { document.activeElement.click(); }
            });
           
            $(document).on("keydown", function (e) {
                // Ctrl-Enter -> Focus chat input
                if (e.ctrlKey && e.key === "Enter") {                    
                    e.preventDefault();
                    $(".chat-input-emoji").focus();
                }

                // Alt-C -> Go to chat room
                if (e.altKey && e.key.toLowerCase() === "c") {
                    e.preventDefault();
                    $("#mCSB_2").focus();
                }
            });
        },

        trapFocus(popup) {
            $o.accessibility.currentPopup = popup;
            var current = $o.accessibility.currentPopup;
            var focusableElements = document.querySelectorAll(current.focusableElements);
            var firstFocusableEl = focusableElements[0];
            if (firstFocusableEl) {
                setTimeout(function () {
                    firstFocusableEl.focus();
                    $(current.element).on('keydown', function (e) {
                        $o.accessibility.createFocusTrap(e);
                    });
                }, 1000)
            }
        },

        releaseFocus() {
            var current = $o.accessibility.currentPopup;
            var popupElement = $(current.element);
            popupElement.off('keydown', $o.accessibility.createFocusTrap);
            current.hideCallbackFunction();
            $o.accessibility.currentPopup = null;
        },

        createFocusTrap: function (e) {
            var current = $o.accessibility.currentPopup
            var focusableElements = document.querySelectorAll(current.focusableElements);
            var firstFocusableEl = focusableElements[0];
            var lastFocusableEl = focusableElements[focusableElements.length - 1];
            var KEYCODE_TAB = 9;

            var isTabPressed = (e.key === 'Tab' || e.keyCode === KEYCODE_TAB);
            var isScapePressed = (e.key === 'Escape');

            if (isScapePressed) {
                $o.accessibility.releaseFocus(current.element);
                current.hideCallbackFunction();
            }

            if (!isTabPressed) {return;}

            if (e.shiftKey) /* shift + tab */ {
                if (document.activeElement === firstFocusableEl) {
                    lastFocusableEl.focus();
                    e.preventDefault();
                }
            } else /* tab */ {
                if (document.activeElement === lastFocusableEl) {
                    firstFocusableEl.focus();
                    e.preventDefault();
                }
            }        
        },
        trapFocusPopups: {
            tutorial: {
                element: "#tutorial-coviewer",
                focusableElements: [
                    "#tutorial-coviewer .close-new-tutorial"
                ],
                hideCallbackFunction: function () { $o.visitorSearch.hideCoviewerTutorial() }
            },
            poweredBy: {
                element: "#oct8ne-version",
                focusableElements: [
                    "#oct8ne-version a.colored, #oct8ne-version .version-privacy, #close-legend-new"
                ],
                hideCallbackFunction: function () { $("#close-legend-new").trigger("click"); }
            },
            layAFK: {
                element: "#lay-AFK",
                focusableElements: [
                    "#refresh-page-afk"
                ],
                hideCallbackFunction: function () { $o.chat.refreshWindow(); }
            }
        }
    }

})(window);
window.oct8ne = window.$o = window.oct8ne || {};

(function () {
    oct8ne.iframes = {
        init: function () {
            $o.iframes.currentIframeStatus = $("#iframe-status").val();
            $o.variablesVisitor.statusBeforeMin = $("#status-before-min").val();
            //$o.log("iframe " + $o.iframes.currentIframeStatus);
            if ($o.iframes.currentIframeStatus === $o.iframes.iframeStatus.PINCODE) {
                $("#all-wrapper").hide();
            } else {
                $o.visitorStart.showAllWrapperUI();
            }
            $o.iframes.changeStatusIframe($o.iframes.currentIframeStatus, true);

            $(".chat-menu").on("click", function (e) {
                e.stopPropagation();
                $(".chat-menu-options").toggle();
                if ($(".chat-menu-options").is(":visible")) {
                    $(".chat-menu").attr("aria-expanded", "true");
                } else {
                    $(".chat-menu").attr("aria-expanded", "false");
                }
                if ($(".send-summary-feedback").is(":visible")) {
                    $(".chat-menu-options ul").show(0);
                    $(".send-summary-feedback").hide(0);
                }
            });

            $(".close-summary-form").on("click", function () {
                $("#summary-form").hide();
                $("#email-adress-summary").val();
            });

            $(".close-summary-finalized-form").on("click", function () {
                $("#summary-finalized-form").hide();
                $("#email-adress-summary").val();
                $o.saveRecord.closeViewerBySurveyB();
                $o.visitorSearch.actionWhenClosingIframe();
            });

            $("#all-wrapper").on("click", function () {
                // console.log("allwraper");
                if ($(".chat-menu-options").is(":visible")) $(".chat-menu-options").hide();
            });

            $(".show-coviewer, .chat-header #pending-products").on("click", function (e) {
                e.stopPropagation();
                if ($o.iframes.enableChangeStatus) {
                    $o.iframes.enableChangeStatus = false;
                    var newStatus = "";
                    
                    if ($o.iframes.currentIframeStatus == $o.iframes.iframeStatus.CHAT) {
                        var customerDataConditions = true;

                        if (!$o.utils || !$o.utils.doIntensiveCostumerDataRequests) {
                            if ($o.core.agentsConnected || !$o.platform) {
                                customerDataConditions = true;
                            } else {
                                customerDataConditions = false;
                            }
                        }

                        if (customerDataConditions && $o.platform) {
                            $o.platform.addPlatformLogin();//Actualiza el Cart del visitor
                        };
                        newStatus = ($o.core.globalVariables.showSearch != "True" || $o.core.globalVariables.edition == $o.core.editions.FREE) ? $o.iframes.iframeStatus.VIEWER : $o.iframes.iframeStatus.SEARCH;

                        $("#pending-products").hide();
                        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: $o.cookies.pendingProducts, value: "" }]);
                        setTimeout(function () { $o.visitorSearch.showCoviewerTutorial(); }, 600);
                    } else {
                        $(".show-coviewer").attr("aria-expanded", "false");
                        newStatus = $o.iframes.iframeStatus.CHAT;
                    }
                    $o.iframes.changeStatusIframe(newStatus);               
                    setTimeout(function () { $o.iframes.enableChangeStatus = true; }, 100);

                    if ($("#tutorial-coviewer").is(":visible")) { $(".close-new-tutorial").trigger("click"); }
                }
            });

            $(".minimize-chat , #minimize-chat-no-agent, .minimize-chat-header").on("click", function () { /*Antes era minimize-coviewer*/
                $(".chat-menu-options,.summary-form ,.block-modal").hide();
                $o.iframes.previousIframeStatus = $o.iframes.currentIframeStatus == $o.iframes.iframeStatus.MINIMIZED ? $o.iframes.iframeStatus.CHAT : $o.iframes.currentIframeStatus;
                if ($o.core.globalVariables.agentsConnected != "True" || ($o.utils && $o.utils.forceCLoseAlways)) {
                    $o.iframes.changeStatusIframe($o.iframes.iframeStatus.CLOSE);
                }
                else {
                    $o.iframes.changeStatusIframe($o.iframes.iframeStatus.MINIMIZED);
                }
                $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [{ cookie: $o.cookies.statusBeforeMin, value: $o.iframes.previousIframeStatus }]);
            });


            //$(".maximize-chat-header , #warning-visitor").on("click", function () {  /*Antes era maximize-coviewer - DEPRECATED*/
            //    var statusBeforeMin = $o.variablesVisitor.statusBeforeMin;
            //    if (statusBeforeMin) {

            //        if (statusBeforeMin == $o.iframes.iframeStatus.SEARCH) {
            //            $("#pending-products").hide();
            //            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: $o.cookies.pendingProducts, value: "" }]);
            //        }
            //        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: $o.cookies.statusBeforeMin, value: "" }]);
            //    };

            //    $o.iframes.currentIframeStatus = $o.iframes.previousIframeStatus || statusBeforeMin;

            //    $o.iframes.changeStatusIframe($o.iframes.currentIframeStatus);
            //    $("#coviewer-minimized , #coviewer-minimized-no-agent").hide(0, function () { $("#all-wrapper").show(0); });

            //});


            //$(".maximize-chat-header-new").on("click", function () {  /*Evento EXCLUSIVO PARA NUEVO VISOR - DEPRECATED*/
            //    var statusBeforeMin = $o.variablesVisitor.statusBeforeMin;
            //    if (statusBeforeMin) {

            //        if (statusBeforeMin == $o.iframes.iframeStatus.SEARCH) {
            //            $("#pending-products").hide();
            //            $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: $o.cookies.pendingProducts, value: "" }]);
            //        }
            //        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.deleteCookies, [{ cookie: $o.cookies.statusBeforeMin, value: "" }]);
            //    };

            //    $o.iframes.currentIframeStatus = $o.iframes.previousIframeStatus || statusBeforeMin;
            //    $o.iframes.changeStatusIframe($o.iframes.currentIframeStatus);

            //    //$("#coviewer-minimized , #coviewer-minimized-no-agent").hide(0, function () {
            //    //    $("#coviewer-wrapper , #chat-wrapper, #bottom-menu").show(0);
            //    //});
            //});

            $("#pincode-wrapper span").on("click", function () {
                $o.inactivity.stopProcess();
                $o.core.doPostMessageToApi("CLOSEIFRAME");
            });
        },

        openCoviewerFromPin: function (agent) {
            var result = {
                Agent: agent
            };
            var queryString = "?tokenSession=" + $o.core.globalVariables.room;
            $.post("Oct8ne/AgentAssignedFromPhonePin" + queryString, { agentId: agent.Id });

            $("#pincode-wrapper").hide(0);
            $o.iframes.changeStatusIframe($o.iframes.iframeStatus.SEARCH);
            $o.visitorStart.showAllWrapperUI();
            $("#search-wrapper,#chat-wrapper").show(0);
            $o.visitorSearch.enableSelectResult = true;
            // $o.core.doPostMessageToApi("SENDANALYTICSEVENT","Attended Session, " + agent.Name);
            $o.visitorSearch.assignedAgentName = agent.Name;
            $o.visitorStart.agentsConnectedChangesUI(result);
            $o.visitorStart.changeHeaderChatToChatting();


            $o.visitorSearch.sendJustLookingChatMessage(culture.coviewer.WelcomeMessagePhone);
        },

        showToken: function (token) {
            var pinCode = token.split(".")[0].slice(token.split(".")[0].length - 4, token.split(".")[0].length);
            $("#pincode-wrapper").show().find("#pin").text(pinCode).show(0);
        },

        changeStatusIframe: function (newStatus, isOpening, clickOnPage) {
            if (newStatus == $o.iframes.iframeStatus.SEARCH && ($o.core.globalVariables.showSearch != "True" || $o.core.globalVariables.edition == $o.core.editions.FREE)) { newStatus = $o.iframes.iframeStatus.VIEWER; };
            $o.iframes.currentIframeStatus = newStatus;

            //si es minimized toggleamos a true

            if ($o.chat.alerts !== null && $o.chat.alerts.hasOwnProperty("toggle")) {
                $o.chat.alerts.toggle(newStatus === $o.iframes.iframeStatus.MINIMIZED);
            };
            switch (newStatus) {
                case $o.iframes.iframeStatus.CLOSE:
                    var tokenVisitor = $o.variablesVisitor.tokenVisitor;
                    $.post("Oct8ne/CloseSession", { tokenVisitor: tokenVisitor }, function (data) {
                        $o.inactivity.stopProcess();
                        $o.core.doPostMessageToApi("CLOSEIFRAME");
                    });
                    break;
                case $o.iframes.iframeStatus.SEARCH:
                    if ($o.core.globalVariables.enterType == $o.core.enterType.PINCODE) {
                        $o.core.doPostMessageToApi("REMOVELAYBORDER");
                    }
                    if ($("#all-wrapper").is(":hidden")) {
                        // $("#coviewer-minimized , #coviewer-minimized-no-agent").hide(0);
                        $("#all-wrapper").show(0);
                    }
                    $(".show-coviewer").addClass("js-reverse").attr("aria-expanded", "true");
                    $o.visitorSearch.enableSelectResult = true;
                    if (!isOpening) $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [{ cookie: $o.cookies.coviewerStatus, value: $o.iframes.iframeStatus.SEARCH }]);
                    $("#search-wrapper, #coviewer-wrapper").delay(10).show(0);
                    break;
                case $o.iframes.iframeStatus.VIEWER:
                    if ($o.core.globalVariables.enterType == $o.core.enterType.PINCODE) {
                        $o.core.doPostMessageToApi("REMOVELAYBORDER");
                    }
                    $(".show-coviewer").addClass("js-reverse").attr("aria-expanded", "true");
                    $("#search-wrapper").hide();
                    if (!isOpening) $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [{ cookie: $o.cookies.coviewerStatus, value: $o.iframes.iframeStatus.VIEWER }]);
                    $("#coviewer-wrapper").delay(10).show(0);
                    break;
                case $o.iframes.iframeStatus.CHAT:
                    $(".show-coviewer").removeClass("js-reverse").attr("aria-expanded", "false");
                    $("#search-wrapper,#coviewer-wrapper").hide();                    
                     if (!isOpening) $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [{ cookie: $o.cookies.coviewerStatus, value: $o.iframes.iframeStatus.CHAT }]);
                    break;
                case $o.iframes.iframeStatus.MINIMIZED:
                    // $("#all-wrapper").hide(0);

                    // saveStatusIframeInCookie(isOpening, $o.iframes.iframeStatus.MINIMIZED);
                    if (isOpening) {
                        $o.core.doPostMessageToApi("HIDEWRAPPER");

                        // $("#coviewer-wrapper , #chat-wrapper, #email-us-form").hide(0);
                    }
                    //if ($o.core.agentsConnected) {
                    //    $("#coviewer-minimized").show(0);
                    //} else {
                    //    $("#coviewer-minimized-no-agent").show(0);
                    //}
                    if (!isOpening) {
                        $o.variablesVisitor.sendCookiesToApi($o.variablesVisitor.nameFunction.saveCookies, [{ cookie: $o.cookies.coviewerStatus, value: $o.iframes.iframeStatus.MINIMIZED }]);
                    }
                    break;
                case $o.iframes.iframeStatus.PINCODE:
                    $("#all-wrapper").hide(0);
                    $("#pincode-wrapper").show(0);
                    $o.core.doPostMessageToApi("COVIEWERLOADED");
                    break;
            }

            var viewChange = {
                View: newStatus,
                Room: $o.core.globalVariables.room,
                SentBy: $o.core.userType,
                Type: "CV"
            };
            if (viewChange.Room && $o.core.isSignalRConnected()) $o.hubsOut.sendViewChange(viewChange);
            if (clickOnPage) {
                $o.saveRecord.pageClick();
            } else if (!isOpening) {
                $o.saveRecord.statusViewer(newStatus);
            } //state
        },
        iframeStatus: {
            CLOSE: "CLOSE",
            CHAT: "CHAT",
            VIEWER: "VIEWER",
            SEARCH: "SEARCH",
            MINIMIZED: "MINIMIZED",
            PINCODE: "PINCODE"
        },
        currentIframeStatus: "",
        previousIframeStatus: "",
        enableChangeStatus: true
    };
})(window);
//EVENTOS 
$o.inactivity.events = function () {
    $o.inactivity.UI();
};

//FUNCIONES QUE MODIFICAN EL DOM 
$o.inactivity.UI = function () {
    $o.inactivity.disableChatInputUI = function () {
        $o.chat.toogleDenyVisitorTyping(true)
    };

    $o.inactivity.messageTypesUI = function (messageType) { //DEPRECATED??
     //   var queryString = "?tokenSession=" + $o.core.globalVariables.room;
        if (messageType == 1) {
            $o.canned.sendCanned($o.canned.type.AGENTSDISCONNECT);
            $("#chat-input").addClass("chat-input-disabled");
            $("#chat-input").attr("readonly", true).blur();
            $(".chat-input-emoji").addClass("chat-input-disabled").attr("contenteditable", false).blur();  //NUevo visor
            $o.core.agentsConnected = false;
            $.connection.hub.stop();
            //$o.visitorStart.changeStatus(queryString, "Searching");
        } else if (messageType == 2) {
                $.connection.hubInterface.server.sendStatus({ tokenVisitor: $o.core.globalVariables.myToken,  tokenSession: $o.core.globalVariables.room,status: "Waiting" });
            $o.canned.sendCanned($o.canned.type.TRANSFERFROMLOGOUT);
        } else {
            $o.canned.sendCanned($o.canned.type.NOMOREAGENTS);
            $("#chat-input").addClass("chat-input-disabled");
            $("#chat-input").attr("readonly", true).blur();
            $(".chat-input-emoji").addClass("chat-input-disabled").attr("contenteditable", false).blur();  //NUevo visor
            $o.core.agentsConnected = false;
            $.connection.hub.stop();
            //$o.visitorStart.changeStatus(queryString, "Searching");
        }
    };
};
$o.visitorRatings.events = function () {


    $("#send-survey").on("click", function () {
        $o.visitorRatings.saveRatings();
    });

    $("#close-survey").on("click", function () {
        $o.saveRecord.closeViewerBySurveyB();
        $o.visitorSearch.actionWhenClosingIframe();
    });

    $("#visitor-survey")
        .on("click", ".answer-options span", function () {
            var self = $(this),
                index = self.index();
            self.parent().find("span").removeClass("icon-common-like-button-high").addClass("icon-common-wishlist-icon");

            self.parent().find("rating-value").val(index + 1);

            self.parent().find("span:lt(" + (index + 1) + ")")
                .removeClass("icon-common-wishlist-icon")
                .addClass("icon-common-like-button-high");
        })
        .on("click", ".answer-bool input[type=radio]", function () {
        });

    $("#rating-area span").click(function (e) { //CONTROLA THUMBS
        e.stopPropagation();
        if ($(this).hasClass("active")) { //ACTIVO

            if ($o.visitorRatings.agentRated) { //RATEADO
                $(this).removeClass("active");
                $o.visitorRatings.agentRated = false;
                var domain = $("#domain-id").val();
                var idAgent = $o.core.globalVariables.agentId;
                var tokenSession = $o.core.globalVariables.roomForLastOperations;
                $o.visitorRatings.saveRateAgent(domain, tokenSession, idAgent, "DELETE", "","", $o.visitorRatings.TypeRatingGoodBad);

            } else { //NO RATEADO
                $(this).removeClass("active");
                $("#comment-agent").toggle();
            }
        } else { //NO ACTIU 
            $(this).addClass("active").siblings().removeClass("active");
            if ($("#comment-agent").is(":hidden")) $("#comment-agent").toggle();
        }
    });

    

    //Si se clica fuera de la ventana de comentario sobre el agente, se esconde
    $(document).mouseup(function (e) {
        var container = $(".comment-agent");

        if (!container.is(e.target) && container.has(e.target).length === 0) {
            container.hide();
        } else {
            var container_stars = $(".rating-stars");

            if (!container_stars.is(e.target) && container_stars.has(e.target).length === 0) {
                container_stars.hide();
            }
        }


    });

    $("#skip-rating , #save-rating").click(function (e) { // ENVIA POST
        e.stopPropagation();
        var comment = $("#comment-agent textarea").val();
        var value = $("#rating-area span.active").attr("id");
        var domain = $("#domain-id").val();

        var idAgent = $o.core.globalVariables.agentId;
        var tokenSession = $o.core.globalVariables.roomForLastOperations;
        value = value == "bad" ? false : true;
        var agentName = $o.core.globalVariables.otherName;
        $o.visitorRatings.saveRateAgent(domain, tokenSession, idAgent, value, comment, agentName, $o.visitorRatings.TypeRatingGoodBad);
        $("#comment-agent").toggle();
        $o.visitorRatings.agentRated = true;
        $("#comment-agent textarea").val("");

    });

    $("#comment-agent").click(function (e) {
        e.stopPropagation();
    });

    $("#rating-area-menu-stars span").click(function (e) { //CONTROLA THUMBS
        e.stopPropagation();
        if ($(this).hasClass("active-star")) { //ACTIVO

            if ($o.visitorRatings.agentRated) { //RATEADO
                $(this).removeClass("active-star");
                $o.visitorRatings.agentRated = false;
                var domain = $("#domain-id").val();
                var idAgent = $o.core.globalVariables.agentId;
                var tokenSession = $o.core.globalVariables.roomForLastOperations;
                $o.visitorRatings.saveRateAgent(domain, tokenSession, idAgent, "DELETE", "","", $o.visitorRatings.TypeRatingStars);

            } else { //NO RATEADO
                $(this).removeClass("active-star");
                $("#rating-stars").toggle();
            }
        } else { //NO ACTIU 
            $(this).addClass("active-star").siblings().removeClass("active-star");
            if ($("#rating-stars").is(":hidden")) {
                $("#rating-stars").toggle();
            }
        }
    });

    $("#skip-rating-stars , #save-rating-stars").click(function (e) { // ENVIA POST
        e.stopPropagation();
        var comment = $("#rating-stars textarea").val();
        var input = $("#rating-area-stars input");
        
        var value = "";
        var i;
        for (i = 0; i < input.length; i++) {
            if (input[i].checked) {
                value = input[i].value;
            }
        }
        if (!value) {
            $("#rating-stars").toggle();
            $("#rating-area-menu-stars span").removeClass("active-star");
            return;
        }
        var domain = $("#domain-id").val();

        var idAgent = $o.core.globalVariables.agentId;
        var tokenSession = $o.core.globalVariables.roomForLastOperations;
        var agentName = $o.core.globalVariables.otherName;
        $o.visitorRatings.saveRateAgent(domain, tokenSession, idAgent, value, comment, agentName, $o.visitorRatings.TypeRatingStars);
        $("#rating-stars").toggle();
        $o.visitorRatings.agentRated = true;
        $("#rating-stars textarea").val("");

    });

    $("#rating-stars").click(function (e) {
        e.stopPropagation();
    });



    //RATING AREA EN FORM SUMMARY


    $("#rating-area-form span").click(function () { // ENVIA POST
        if ($(this).hasClass("active")) { //ACTIVO
            if ($o.visitorRatings.agentRated) { //RATEADO
                $(this).removeClass("active");
                $o.visitorRatings.agentRated = false;
                //var domain = $("#domain-id").val();
                //var idAgent = $o.core.globalVariables.agentId;
                //var tokenSession = $o.core.globalVariables.roomForLastOperations;
                //$o.visitorRatings.saveRateAgent(domain, tokenSession, idAgent, "DELETE", "");

            } else { //NO RATEADO
                $(this).removeClass("active");
            }
        } else { //NO ACTIU 
            $(this).addClass("active").siblings().removeClass("active");
        }
    });

    $("#save-rating-form").click(function () { // ENVIA POST
        var value = $("#rating-area-form span.active").attr("id");
        if (!value) return;
        var comment = $("#rating-area-form textarea").val();
        var domain = $("#domain-id").val();
        var idAgent = $o.core.globalVariables.agentId;
        var tokenSession = $o.core.globalVariables.roomForLastOperations;
        var agentName = $o.core.globalVariables.otherName;

        value = value === "bad" ? false : true;
        $o.visitorRatings.saveRateAgent(domain, tokenSession, idAgent, value, comment, agentName, $o.visitorRatings.TypeRatingGoodBad);
        $o.visitorRatings.agentRated = true;
        $("#rating-area-form textarea").val("");
        $("#rating-area-form").remove();
        $("#rating-area-success").show();
    });

    $o.visitorRatings.UI();
};


$o.visitorRatings.UI = function () {

    $o.visitorRatings.printRatings = function (result) {
        if (result.length) {
            $("#visitor-survey").show();
            var layout = "<ul>";
            $.each(result, function (i) {

                layout += "<li data-questionid='" + result[i].Id + "' data-type=" + result[i].Type + ">";
                layout += "<p class='question'>" + (i + 1) + ". " + result[i].Question + "</p>";

                if (result[i].Type == 1) {
                    layout += "<div class='answer-bool' data-answerid=" + result[i].Id + "><input type='radio' class='survey-radio-yes' value='Yes' name='response-" + result[i].Id + "'>" + culture.coviewer.RatingSummaryYes + "<input type='radio' class='survey-radio-no' value='No' name='response-" + result[i].Id + "' >" + culture.coviewer.RatingSummaryNo + "</div>";
                }
                else if (result[i].Type == 2) {

                    layout += "<div class='rating-points answer' data-answerid=" + result[i].Id + "><input type='hidden' class='rating-value'>" +
                        "<p class='answer-options'><span class='icon-common-wishlist-icon glyph'></span>" +
                        "<span class='icon-common-wishlist-icon glyph'></span>" +
                        "<span class='icon-common-wishlist-icon glyph'></span>" +
                        "<span class='icon-common-wishlist-icon glyph'></span>" +
                        "<span class='icon-common-wishlist-icon glyph'></span>" +
                        "</div>";
                }
                else if (result[i].Type == 3) {
                    layout += "<div class='answer-text' data-answerid=" + result[i].Id + "><textarea data-answerid=" + result[i].Id + " placeholder='" + culture.coviewer.RatingSummaryPlaceHolder + "'></textarea></div>";
                }
                layout += "</li>";
            });
            if (($o.settings.showRatingAgent == "True") && (!$o.visitorRatings.agentRated)) {

                layout += "<li  data-agent='true' data-questionid='0' data-type='1'><p class='answer-bool'>" + culture.coviewer.RatingSummaryAgent + "</p><div class='answer-bool answer-agents'><input type='radio' class='survey-radio-yes' name='response-agents' value='true'>" + culture.coviewer.RatingSummaryGood + "<input type='radio' class='survey-radio-no' name='response-agents' value='false'>" + culture.coviewer.RatingSummaryBad + "</div></li>";
            }
            $("#survey-form").append(layout);
        } else {
            $o.visitorSearch.actionWhenClosingIframe();
        }
    };


    $o.visitorRatings.saveRatings = function () {
        var answers = [];
        $("#survey-form li").each(function () {
            var answerValue = "";
            var typeResponse = 2;
            if ($(this).attr("data-type") == 1) {
                answerValue = $(this).find('input[type=radio]:checked').val();
            }
            if ($(this).attr("data-type") == 2) {
                answerValue = $(this).find("span.icon-common-like-button-high").length;
            }
            if ($(this).attr("data-type") == 3) {
                answerValue = $(this).find("textarea").val();
            }


            if ($(this).attr("data-agent") == 'true') {
                answerValue = $(this).find('input[type=radio]:checked').val();
                typeResponse = 1;
            }

            var answer = {
                RatingQuestionId: $(this).attr("data-questionid"),
                Response: answerValue,
                TypeResponse: typeResponse
            };

            answers.push(answer);

        });

        $.post("/Ratings/SaveResponseSessionRating", { tokenSession: $o.core.globalVariables.roomForLastOperations, tokenAgent: $o.core.globalVariables.otherToken, jsonResult: JSON.stringify(answers) }, function (result) {
            $o.visitorSearch.actionWhenClosingIframe();
        });
    };

};
//EVENTOS 
$o.visitorSearch.events = function () {

    $(".results")
        .on("click", "li", function (e) {//To send product to coviewer.
            if (!e.isPropagationStopped()) {

                var nodeId = $(this).attr("data-nodeid");
                if (($o.visitorSearch.enableSelectResult) && (nodeId !== $o.core.globalVariables.internalId) && (!$o.search.sendingProductToCanva)) {
                    $o.search.sendingProductToCanva = true;
                    $o.carousel.sendIdToCarousel(nodeId, $o.carousel.lists.VIEWED, $o.carousel.actions.VIEWINCANVA);
                }
            }
        })
        //To hide more actions.
        .on("mouseleave", ".more-actions-menu", function () {
            $(this).hide().css({ 'top': 3 });
        });


    //Reset input box
    $("#search-term").on("mousedown", function () {
        //   $o.log($(this).is(':focus'));
        if (!$(this).is(':focus') && ($(this).val() !== "")) $(this).attr("placeholder", culture.coviewer.SearchAgain).val("").focus();
    });

    // Button to start experience  (YES and "ask us anything")
    //$("#go-button, #just-looking-engage").on("click", function () {
    //    $o.visitorSearch.changeToWaitingStatus();
    //});

    //Button for just looking.
    $("#just-looking-button").click(function () {
        $("#engage-chat, .question-panel").hide();
        $("#just-looking-wrapper,.sort-panel").show();
        $o.visitorSearch.sendJustLookingChatMessage();
        $("#search-banner").show();
        //$o.saveRecord.justLookingB();
    });

    //Boton no agents "keep searching"
    $("#keep-searching").on("click", function () {
        $(".bridge-no-agents").hide();
        $(".sort-panel").show();
        $("#no-agent-header").html(culture.coviewer.MylistTip + "<span>" + culture.coviewer.Email + "</span>.");
    });

    //Boton no agents "Email Us"
    $("#email-us").on("click", function () {
        $(".bridge-no-agents").hide();
        $(".sort-panel , #email-us-form").show();
        $o.storage.local.set($o.core.localStorageTypes.LASTDISPLAY, "form");
    });

    $("#close-coviewer").on("click", function () {
        $o.storage.local.set($o.core.localStorageTypes.JUSTLOOKINGOPTION, $o.core.localStorageActions.REMOVE);
        $o.iframes.changeStatusIframe($o.iframes.iframeStatus.CLOSE);
    });

    //Boton overbooking agents "Email Us"  (Revisar operativa)
    $("#email-us-overbooking").on("click", function () {
        $(".bridge-overbooking").hide();
        $(".sort-panel,#email-us-form").show();
        $o.storage.local.set($o.core.localStorageTypes.LASTDISPLAY, "form");
    });

    $("#email-us-product").on("focus", function () {
        if ($o.core.globalVariables.internalId) {
            var product = viewedVM.getProduct($o.core.globalVariables.internalId);
            if (product.Title.length) $(this).val(product.Title + " (" + product.InternalId + ")");
        }
    });

    //Send email us button
    $("#send-email-us").on("click", function () {
        $("#email-us-form-message").hide();

        //validacion
        var canPass = true;
        var canPassMail = true;
        var regexMail = /^[a-zA-Z0-9._-]+([+][a-zA-Z0-9._-]+){0,1}[@][a-zA-Z0-9._-]+[.][a-zA-Z]{2,6}$/;
        var regexPhone = /^(\(?\+?[0-9]*\)?)?[0-9_\- \(\)]*$/;
        var nameInput = $("#email-us-name"),
            commentsInput = $("#email-us-comments"),
            emailInput = $("#email-us-email"),
            zipInput = $("#email-us-zip"),
            phoneInput = $("#email-us-phone"),
            productInput = $("#email-us-product"),
            knowUsInput = $("#email-us-know-us"),
            errorClass = "data-contact-error",
            checkboxPolicy = $("#checkbox-conditions-contact");

        //Comprobacin campo nombre: no puede estar vaco
        if (nameInput.val().length <= 0 && (!$o.utils || !$o.utils.allowNullName)) {
            nameInput.addClass(errorClass).attr("aria-invalid","true");
            canPass = false;
        } else {
            nameInput.removeClass(errorClass).removeAttr("aria-invalid");
        }

        //Comprobacin campo mail: no puede estar vaco y debe cumplir con el regex de mail
        if (emailInput.val().length <= 0) {
            emailInput.addClass(errorClass).attr("aria-invalid", "true");
            canPass = false;
            canPassMail = false;
        }
        else if (!regexMail.test(emailInput.val().trim())) {
            emailInput.addClass(errorClass).attr("aria-invalid", "true");
            canPass = false;
            canPassMail = false;
        }
        else {
            emailInput.removeClass(errorClass).removeAttr("aria-invalid");
            phoneInput.removeClass(errorClass).removeAttr("aria-invalid");
        }

        //Comprobacin campo comentarios: no puede estar vaco
        if (commentsInput.val().length <= 0) {
            commentsInput.addClass(errorClass).attr("aria-invalid", "true");
            canPass = false;
        }
        else commentsInput.removeClass(errorClass).removeAttr("aria-invalid");

        //Comprobacin campo telfono: slo validamos si tiene la clase 'mandatory'. Entonces queremos que no est vaco y que cumpla con el regex de telfono
        if (phoneInput.length && phoneInput.hasClass("mandatory")) {
            if (phoneInput.val().length <= 0) {
                phoneInput.addClass(errorClass).attr("aria-invalid", "true");
                canPass = false;
            }
            else if (!regexPhone.test(phoneInput.val().trim())) {
                phoneInput.addClass(errorClass).attr("aria-invalid", "true");
                canPass = false;
            }
            else phoneInput.removeClass(errorClass).removeAttr("aria-invalid");
        }

        //Comprobacin campo telfono: si tiene la clase 'optional-combined'. Validamos (que no este vaco y regex) pero lo combinamos con el campo Mail. Tiene que tener alguno de los 2 campos para que 'canPass' sea true.
        if (phoneInput.length && phoneInput.hasClass("optional-combined") && !canPassMail) {
            if (phoneInput.val().length <= 0) {
                phoneInput.addClass(errorClass).attr("aria-invalid", "true");
                canPass = false;
            }
            else if (!regexPhone.test(phoneInput.val().trim())) {
                phoneInput.addClass(errorClass).attr("aria-invalid", "true");
                canPass = false;
            }
            else {
                phoneInput.removeClass(errorClass).removeAttr("aria-invalid");
                emailInput.removeClass(errorClass).removeAttr("aria-invalid");
                canPass = true;
            }
        }


        //Comprobacin campo Proteccin de Datos: debe estar marcado si es que existe en el formulario
        if (checkboxPolicy.length) {
            if (!checkboxPolicy.is(":checked")) {
                canPass = false;
                $(".form-wrapper .checkbox-conditions-wrapper").addClass("not-accepted").attr("aria-invalid", "true");
            } else {
                $(".form-wrapper .checkbox-conditions-wrapper").removeClass("not-accepted").removeAttr("aria-invalid");
            }
        }

        if ($o.utils && $o.utils.customContactFormValidation) {
            canPass = $o.utils.customContactFormValidation(canPass);
        }

        if (canPass) {
            $("#email-us-form-loading").show(); // Deberia ser el loading! TODO: Rehacer loading feedback y mensajes. 
            $("#send-email-us").hide();
            var userData = {
                name: nameInput.val(),
                email: emailInput.val(),
                comments: commentsInput.val(),
                phone: phoneInput.val(),
                zip: zipInput.val(),
                product: productInput.val(),
                knowUs: knowUsInput.val()
            };
            $o.visitorSearch.getViewedProductsForEmail(userData);

            var event = {
                category: "Oct8ne",
                type: "GAContactFormSent"
            }
            $o.core.doPostMessageToApi("SENDANALYTICSEVENT", JSON.stringify(event));

        }
    });

    // Fold and Unfold coviewer.
    $(".coview-switch img").click(function () {
        var layout = "";
        if (($o.iframes.currentIframeStatus === $o.iframes.iframeStatus.V) || ($o.iframes.currentIframeStatus === $o.iframes.iframeStatus.CLOSE)) {
            $(this).attr("src", "/api/img/core/right-arrow.png");
            layout = $o.iframes.iframeStatus.S;
        }
        else {
            $(this).attr("src", "/api/img/core/left-arrow.png");
            layout = $o.iframes.chatShown ? $o.iframes.iframeStatus.CLOSE : $o.iframes.iframeStatus.V;
        };
        $o.iframes.toggleIframeParts(layout);
    });


    // CLOSE OCT8NE SYSTEM.
    $(".close-iframe-visitor-js").click(function () { //CERRAR VISOR         
        $(".chat-menu-options").hide();
        if ($o.core.globalVariables.internalId && $o.settings.showSendSummary === "True") {
            $(".chat-menu-options").hide();
            $(".chat-menu").attr("aria-expanded", "false");
            $("#summary-finalized-form").show();
            //TODO: HACER QUE SOLO SEA UN POST
            $o.saveRecord.closeByMenuB();
            $o.saveRecord.showSummary();
            $o.iframes.changeStatusIframe($o.iframes.iframeStatus.CHAT);
        } else {
            $o.saveRecord.closeByMenuB();
            $o.visitorSearch.actionWhenClosingIframe();
        }
    });


    $(".send-summary").on("click", function () { //BOTON MOSTRAR GET SUMMARY ANTIGUO VISOR!
        $o.saveRecord.getSummaryB();
        $(".chat-menu-options").hide();
        $(".chat-menu").attr("aria-expanded", "false");
        $("#summary-form").show();
        $o.saveRecord.showSummary();
    });

    $(".send-summary-button").on("click", function () { //ENVIA MAIL (GET SUMMARY)
        var email = $o.settings.privacyPolicy.length ? $(this).prev().prev() : $(this).prev();
        var emailAdress = email.val();
        var regex = /^[a-zA-Z0-9._-]+([+][a-zA-Z0-9._-]+){0,1}[@][a-zA-Z0-9._-]+[.][a-zA-Z]{2,6}$/;
        var canPass = false;

        if (!regex.test(emailAdress)) {
            email.addClass("data-contact-error").attr("aria-invalid", "true");
        } else {
            canPass = true;
            email.removeClass("data-contact-error").removeAttr("aria-invalid");
        }

        if ($o.settings.privacyPolicy.length) {
            var checkboxPolicy = $(this).prev().find(".checkbox-conditions-summary");
            if (!checkboxPolicy.is(":checked")) {
                canPass = false;
                $(this).prev().addClass("not-accepted");
            } else {
                if (canPass) canPass = true;
                $(this).prev().removeClass("not-accepted").removeAttr("aria-invalid");
            }
        }

        if (canPass) {
            $o.visitorSearch.getRecordsMailInfo(emailAdress);
            $("#summary-form p , #summary-finalized-form>p ").delay(400).show(0).html(culture.coviewer.SummarySent);
            $(".email-adress-summary,.send-summary-button,.checkbox-conditions-summary-wrapper").hide(0);
            $(".close-summary-finalized-form").css("margin", "0 57px 0 0");
            setTimeout(function () {
                $o.saveRecord.sendSummary(emailAdress); //EMAIL
                $o.canned.sendCanned($o.canned.type.SENDSESSION, culture.coviewer.SummarySentTo + " " + emailAdress);
            }, 1000);
        }
    });

    $(".summary-button").on("click", function () { //EVENTO SOLO NUEVO VISOR!
        var form;
        if ($o.core.globalVariables.agentsConnected == "True") {
            form = $("#send-summary-menu-chat");
        } else {
            form = $("#send-summary-menu-form");
        }

        var email = form.find(".summary-input");
        var emailAdress = email.val();
        var regex = /^[a-zA-Z0-9._-]+([+][a-zA-Z0-9._-]+){0,1}[@][a-zA-Z0-9._-]+[.][a-zA-Z]{2,6}$/;
        var canPass = false;

        if (!regex.test(emailAdress)) {
            email.addClass("data-contact-error").attr("aria-invalid", "true");
        } else {
            canPass = true;
            email.removeClass("data-contact-error").removeAttr("aria-invalid");
        }

        if ($o.settings.privacyPolicy.length) {
            var checkboxPolicy = form.find(".checkbox-conditions-wrapper");
            var checkboxPolicyCheck = checkboxPolicy.find("input");

            if (!checkboxPolicyCheck.is(":checked")) {
                canPass = false;
                checkboxPolicy.addClass("not-accepted");
            } else {
                if (canPass) canPass = true;
                checkboxPolicy.removeClass("not-accepted").removeAttr("aria-invalid");
            }
        }

        if (canPass) {
            //  console.log("Mostrar capa!")
            $o.visitorSearch.getRecordsMailInfo(emailAdress);

            $(".chat-menu-options ul").hide(0);
            $(".send-summary-feedback").show(0);
             setTimeout(function () {
                $o.saveRecord.sendSummary(emailAdress); //EMAIL
                $o.canned.sendCanned($o.canned.type.SENDSESSION, culture.coviewer.SummarySentTo + " " + emailAdress);
            }, 1000);
        }
    });

    $(".feedback-ok").on("click", function () {  //EVENTO SOLO NUEVO VISOR!
        $(".send-summary-feedback , .chat-menu-options").hide(0);
        $(".chat-menu").attr("aria-expanded", "false");
        $(".chat-menu-options ul").show(0);
    });

     //$("#sound-option").on("click", function () { //EL CONTROL SE REALIZA MEDIANTE SESSION STORAGE. SI NO ESTA HABILITADO,SUENA SIEMPRE; no se puede cambiar a OFF!
    //    var controlSound = $("#sound-option span").attr("class");

    //    if (controlSound === "icon-common-volume-on HTxt1") {
    //        $o.storage.local.set($o.core.localStorageTypes.SOUND, "false");
    //        $("#sound-option span").removeClass().addClass("icon-common-volume-off HTxt1");
    //        //Cambiar a off
    //    } else {
    //        //Cambiar a on
    //        $o.storage.local.set($o.core.localStorageTypes.SOUND, "true");
    //        $("#sound-option span").removeClass().addClass("icon-common-volume-on HTxt1");
    //    };
    //});

    $("#back-to-oct8ne").on("click", function () {
        $("#summary-finalized-form").hide();
    });

    // Minimize all coviewer and chat and results.
    $(".results-info img").click(function () {
        $o.iframes.toggleIframeParts($o.iframes.iframeStatus.M);
        $o.iframes.iframeCentered = false;
    });
    // Switch between results search and mylist.
    $("#acces-to-mylist").click(function () {
        $o.visitorSearch.switchResultsMyList();
    });

    $(".powered-by-oct8ne").on("click", function () { //No hay evento en Mobil. No se muestra la capa en Mobil.

        $("#block-modal").attr("aria-modal", "true").show();
    });

    $("#close-legend , #oct8ne-version .icon-common-close-button").on("click", function () {
        $("#block-modal").attr("aria-modal", "false").hide();
    });

    $(".close-new-tutorial").on("click", function () {  //EVENTOS NUEVO VISOR
        $("#tutorial-coviewer").attr("aria-modal", "false").fadeOut(200);
        $o.storage.local.set($o.core.localStorageTypes.HIDENEWTUTORIAL, true);
        if ($(".custom-chat-input").is(":visible")) {
            $(".custom-chat-input").focus();
        } else {
            $(".show-coviewer").focus();
        }
        //GUARDAR SESSION STORAGE
    });

  

    $("#close-legend-new").on("click", function () {
        $("#block-modal").attr("aria-modal", "false").animate({
            top: "395px",
            height: "1px",
            opacity: "0"
        }).hide(0);

        $("#oct8ne-version").hide();
    });

    $o.visitorSearch.UI();
};

//FUNCIONES QUE MODIFICAN EL DOM 
$o.visitorSearch.UI = function () {
    $o.visitorSearch.otherAgentAfterWaitingUI = function (data) {
        $("#just-looking-wrapper,#engage-chat, .question-panel").hide();
        $("#yes-chat,.sort-panel").show();
        $(".agent-avatar-image, .other-cursor img").css({ "background": "url('" + data.Avatar + "') center center / cover" });
        $("#yes-chat #welcome-message").html($o.visitorSearch.assignedAgentName + culture.coviewer.AgentBusy + data.Name);
        $(".name-agent").html($o.visitorSearch.assignedAgentName);

        if ($o.utils && $o.utils.rewriteProfileAgent) { $o.utils.rewriteProfileAgent(); }
    };

    $o.visitorSearch.changeStatusOverbookingToWaitingUI = function (visitor) {
        $o.visitorStart.avatarAgent = visitor.Agent.Avatar;
        $(".agent-avatar-image, .other-cursor  .avatar-agent").css({ "background": "url('" + visitor.Agent.Avatar + "') center center / cover" });
        $(".name-agent").html(visitor.Agent.Name);

        if ($o.utils && $o.utils.rewriteProfileAgent) { $o.utils.rewriteProfileAgent(); }
    };

    $o.visitorSearch.reciveFormUI = function () {
        $("#yes-chat, .sort-panel").hide();
        $("#busy-agent, .bridge-no-agents").show();
    };

    $o.visitorSearch.reciveSendToMyListUI = function () {
        $("#my-list-items").show("pulsate", { times: 5 }, 200, function () {
            mylistVM.setActiveTab();
        });
    };
    $o.visitorSearch.hideSearchBannerUI = function () { //DEPRECATED ??
        $("#search-banner,#results-scrollbar,#speed-search").hide();
        $("#minimized-viewer-message,#all-wrapper").show();
    };

    $o.visitorSearch.sendJustLookingChatMessageUI = function (message, justLookingButton) {
        if (!$o.visitorSearch.showedJustLookingMessage) {
            if (message !== null) {
                $o.visitorSearch.showedJustLookingMessage = true;
                if (justLookingButton) {
                    $o.storage.local.set($o.core.localStorageTypes.JUSTLOOKINGBUTTON, true);
                } else {
                    $o.storage.local.set($o.core.localStorageTypes.JUSTLOOKINGBUTTON, $o.core.localStorageActions.REMOVE);
                };

                $o.canned.sendCanned($o.canned.type.WELCOME, message);
            }
        }
    };

    $o.visitorSearch.sendGdprMessageUI = function (message) {
        if (!$o.visitorSearch.showedGdprMessage) {
            if (message !== null) {
                $o.visitorSearch.showedGdprMessage = true;
                $o.canned.sendGdpr(message);
            }
        }
    };

    $o.visitorSearch.sendVipChatMessageUI = function (message) {
        if (message !== null) {
            $o.canned.sendCanned($o.canned.type.VIPMESSAGE, message);
        }
    };
    $o.visitorSearch.changeToWaitingStatusUI = function () {

    };
    $o.visitorSearch.showSearchTutorial = function () {
        $("#tutorial-search").show();
    };
    $o.visitorSearch.showCoviewerTutorial = function () {
        var hideTutorial = $o.storage.local.get($o.core.localStorageTypes.HIDENEWTUTORIAL);
        if ((window.location.pathname.indexOf("V3") > -1) && hideTutorial) {
            return;
        } else {
            $("#tutorial-coviewer").attr("aria-modal", "true").show(200);
            $o.accessibility.trapFocus($o.accessibility.trapFocusPopups.tutorial);
            if (!$o.core.agentsConnected) {
                $("#instructions-upload").remove();
            };
        };
    };


    $o.visitorSearch.hideCoviewerTutorial = function () {
        $("#tutorial-coviewer,#tutorial-search").attr("aria-modal", "false").remove();

    };
    $o.visitorSearch.hideSearchTutorial = function () {
        $("#tutorial-coviewer,#tutorial-search").attr("aria-modal", "false").remove();
    };
};
//EVENTOS 
$o.visitorStart.events = function () {
    $o.accessibility.init();
    $o.visitorStart.UI();
};

//FUNCIONES QUE MODIFICAN EL DOM 
$o.visitorStart.UI = function () {
    $o.visitorStart.showChatWrapperUI = function () {
        $("#chat-wrapper").show();
        $(".email-us-form").hide();
        $o.storage.local.set($o.core.localStorageTypes.LASTDISPLAY, "chat");
    };

    $o.visitorStart.showAllWrapperUI = function () {
        $("#all-wrapper").show(0);
        $o.visitorStart.finishLoading();
      $o.core.doPostMessageToApi("COVIEWERLOADED");
    };

    $o.visitorStart.agentsConnectedChangesUI = function (result) {
        $(".connecting-agent").hide();
        $("#chat-input").attr("readonly", false);
        $o.core.globalVariables.otherName = $o.visitorSearch.assignedAgentName;
        $o.core.globalVariables.otherToken = result.Agent.Token;
        $o.visitorStart.avatarAgent = result.Agent.Avatar;

        $(".name-agent").html($o.visitorSearch.assignedAgentName);
        $(".agent-avatar-image, .other-cursor  .avatar-agent").css({ "background": "url('" + result.Agent.Avatar + "') center center / cover" });
        if ($o.utils && $o.utils.rewriteProfileAgent) { $o.utils.rewriteProfileAgent(); }

        if ($o.settings.showRatingAgent) $o.visitorStart.printRatedAgent(result.Agent.AgentRated, result.Agent.AgentRateType);
        //$("#coviewer-visitor").after("<input type='hidden' id='other-token' value='" + result.Agent.Token + "' />");
        // $(".sort-panel, #instructions-upload").show();
    };

    $o.visitorStart.agentsDisconnectedChangesUI = function () {
        $o.visitorSearch.enableSelectResult = true;
        $("#chat-wrapper").hide(0);
        $(".sort-panel , #email-us-form").show();
        $o.storage.local.set($o.core.localStorageTypes.LASTDISPLAY, "form");
    };

    $o.visitorStart.displayFormCuzNoAgentsConnected = function () {
        $("#chat-wrapper").hide();
        $(".email-us-form").show();
        $o.storage.local.set($o.core.localStorageTypes.LASTDISPLAY, "form");
        if ($.connection.hub.state != $.signalR.connectionState.disconnected) $.connection.hub.stop();
    };


    $o.visitorStart.enterByCheckoutUI = function () { };

    $o.visitorStart.changeAgentUI = function (result) {
        $o.core.globalVariables.otherToken = result.Visitor.Agent.Token;
        $o.core.globalVariables.agentId = result.Visitor.Agent.AgentId;
        $o.core.globalVariables.otherName = result.Visitor.Agent.Name;

        $o.visitorStart.avatarAgent = result.Visitor.Agent.Avatar;
        $o.visitorStart.assignedDepartment.Name = result.NewDepartment;

        if ($o.core.globalVariables.enabledDepartments == "True") {
            $(".after-join-agent .message-agent").text(result.NewDepartment);
        }

        $(".name-agent").html(result.Visitor.Agent.Name);
        $(".agent-avatar-image, .other-cursor  .avatar-agent").css({ "background": "url('" + result.Visitor.Agent.Avatar + "') center center / cover" });
        if ($o.utils && $o.utils.rewriteProfileAgent) { $o.utils.rewriteProfileAgent(); }

        $o.visitorStart.printRatedAgent(result.Visitor.Agent.AgentRated);
        //se debe bindear con nuevos parametros de capabilities TODO:ARAMIS
        $o.visitorStart.reBindingCallCapabilities(result.Visitor);

    };

    $o.visitorStart.printRatedAgent = function (agentRated, rateType) {
        if (rateType === $o.visitorRatings.TypeRatingGoodBad) {
            if (agentRated != null) {
                var rated = agentRated ? "good" : "bad";
                $("#" + rated).addClass("active");
                $o.visitorRatings.agentRated = true;
            } else {
                $("#rating-area > span").removeClass("active");
                $o.visitorRatings.agentRated = false;
            }
        } else if (rateType === $o.visitorRatings.TypeRatingStars) {
            if (agentRated != null) {
                var index = (agentRated - 5) * -1;
                var input = $("#rating-area-stars input");
                input[index].checked = true;
                $("#rating-area-menu-stars > span").addClass("active-star");
                $o.visitorRatings.agentRated = true;
            } else {
                $("#rating-area-menu-stars > span").removeClass("active-star");
                $o.visitorRatings.agentRated = false;
            }
        }
    };

    $o.visitorStart.changeHeaderChatToChatting = function () {
        if ($o.core.globalVariables.enabledDepartments == "True" && $o.visitorStart.assignedDepartment.Name != "") $(".after-join-agent .message-agent").text($o.visitorStart.assignedDepartment.Name);
        $(".before-join-agent").hide();
        $(".after-join-agent").show();
        if ($o.core.globalVariables.conferenceProvider) $o.chat.showRatingsAreaInForm(); //Debe salir aunque no tenga "https" pero si Provider. Se hace aqui cuando tiene agente asignado.
    };

    $o.visitorStart.changeHeaderChatToAvailable = function () {
        $(".after-join-agent").hide();
        $(".before-join-agent").show();
    };

    $o.visitorStart.collpaseChatComunications = function () {
        var height = "158px";
        if (window.location.pathname.indexOf("V3") > -1) {
            height = "203px";
        }

        $(".oct8ne-communications, .chat-scrollbar, .oct8ne-chat-room, .chat-scrollbar.scrollbar").css({ "height": height, "margin-top": "190px" });
        $(".oct8ne-communications .real-background").css({ "height": height });
        if ($("#search-wrapper").length) $("#oct8ne-conference-body , #oct8ne-conference-toolbar , #oct8ne-conference-info").removeClass("bigger");
    };

    $o.visitorStart.expandChatComunications = function () {
        var height = "348px";
        if (window.location.pathname.indexOf("V3") > -1) {
            if ($o.settings.chatStyle == 4) {
                height = "388px";
            } else {
                height = "393px";
            }
        } 

        $(".oct8ne-communications, .chat-scrollbar, .oct8ne-chat-room, .chat-scrollbar.scrollbar , .oct8ne-communications .real-background").css({ "height": height, "margin-top": "0px" });
        if ($("#search-wrapper").length) $("#oct8ne-conference-body , #oct8ne-conference-toolbar , #oct8ne-conference-info").addClass("bigger");
        if ($o.iframes.currentIframeStatus == $o.iframes.iframeStatus.CHAT) {
            $(".chat-header .show-coviewer").trigger("click");
        }
        if ($("#tutorial-coviewer").is(":visible")) {
            $("#tutorial-coviewer").attr("aria-modal", "false").hide();
        }

    };

    $o.visitorStart.resetChatComunications = function () {
        if ($("#on-hold-lay").is(":visible")) {
            return;
        }

        var height = "348px";
        if (window.location.pathname.indexOf("V3") > -1) {
            height = "393px";
        }
        $(".oct8ne-communications, .chat-scrollbar, .oct8ne-chat-room, .chat-scrollbar.scrollbar , .oct8ne-communications .real-background").css({ "height": height, "margin-top": "0px" });
    };

    $o.visitorStart.showAccessFormWrapperUI = function (askDepts, askInfo) {
        $("#access-form-wrapper").show();

        if (!askDepts) { $("#departments-wrapper").hide(); }
        if (!askInfo) { $("#info-wrapper").hide(); }
        if (askDepts && askInfo) $("#departments-wrapper .title-section").hide();
    };

    $o.visitorStart.videoInitFromEmbed = function () {
        $(".btn-start-audio").trigger("click");
    };

    $o.visitorStart.reBindingCallCapabilities = function (visitorNewParams) { //Por si viene de BOT!! Hay que des-sobreescribirlas

        if ($o.core.globalVariables.conferenceProvider) {
            var session = {
                "visitor": {
                    'hasAudioDevices': $o.core.globalVariables.visitorHasAudioDevices, //&& visitorNewParams.VisitorCanStartConference,
                    'hasVideoDevices': $o.core.globalVariables.visitorHasVideoDevices, //&& visitorNewParams.VisitorCanStartConference,
                    'isWebRtcSupported': $o.core.globalVariables.visitorIsWebRtcSupported
                },
                "agent": {
                    'hasAudioDevices': visitorNewParams.Agent.AgentHasAudioDevices && (visitorNewParams.Agent.AllowAudioConference || visitorNewParams.Agent.AllowMobileAudioConference) ? true : false,
                    'hasVideoDevices': visitorNewParams.Agent.AgentHasVideoDevices && (visitorNewParams.Agent.AllowVideoConference || visitorNewParams.Agent.AllowMobileVideoConference) ? true : false,
                    'isWebRtcSupported': visitorNewParams.Agent.AgentIsWebRtcSupported
                }
            };
            //para asegurar que est en entornos SSL y tiene el conferenceVM cargado
            if (window.conferenceVM) {
                if (!visitorNewParams.VisitorCanStartConference) {
                    window.conferenceVM.hideStartCallButtons(true);
                }
                window.conferenceVM.updateSessionInfo(session); //Una vez sabemos las capabilities de agente, updateamos info del conferenceVM en Visitor
                // window.conferenceVM.resumeCallIfNeeded(); //TODO:ARAMIS Rellamada Conferencia si hay una establecida
            }
        }
    };

    //PARCHE PARA EXEL. QUIEREN EMBED PARA QUE LLAME INICIALMENTE
    //if ($o.enterData.initVideoCall === "true") {
    //    setTimeout(function () { //SETIMEOUT PARA ASEGURAR QUE EL TRIGGER CLIC FUNCIONA
    //        $(".btn-start-video.init-call").trigger("click");
    //    }, 500); 
    //}

};
/*! @license DOMPurify 3.1.7 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.1.7/LICENSE */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).DOMPurify=t()}(this,(function(){"use strict";const{entries:e,setPrototypeOf:t,isFrozen:n,getPrototypeOf:o,getOwnPropertyDescriptor:r}=Object;let{freeze:i,seal:a,create:l}=Object,{apply:c,construct:s}="undefined"!=typeof Reflect&&Reflect;i||(i=function(e){return e}),a||(a=function(e){return e}),c||(c=function(e,t,n){return e.apply(t,n)}),s||(s=function(e,t){return new e(...t)});const u=b(Array.prototype.forEach),m=b(Array.prototype.pop),p=b(Array.prototype.push),f=b(String.prototype.toLowerCase),d=b(String.prototype.toString),h=b(String.prototype.match),g=b(String.prototype.replace),T=b(String.prototype.indexOf),y=b(String.prototype.trim),E=b(Object.prototype.hasOwnProperty),_=b(RegExp.prototype.test),A=(N=TypeError,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return s(N,t)});var N;function b(e){return function(t){for(var n=arguments.length,o=new Array(n>1?n-1:0),r=1;r<n;r++)o[r-1]=arguments[r];return c(e,t,o)}}function S(e,o){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:f;t&&t(e,null);let i=o.length;for(;i--;){let t=o[i];if("string"==typeof t){const e=r(t);e!==t&&(n(o)||(o[i]=e),t=e)}e[t]=!0}return e}function R(e){for(let t=0;t<e.length;t++){E(e,t)||(e[t]=null)}return e}function w(t){const n=l(null);for(const[o,r]of e(t)){E(t,o)&&(Array.isArray(r)?n[o]=R(r):r&&"object"==typeof r&&r.constructor===Object?n[o]=w(r):n[o]=r)}return n}function C(e,t){for(;null!==e;){const n=r(e,t);if(n){if(n.get)return b(n.get);if("function"==typeof n.value)return b(n.value)}e=o(e)}return function(){return null}}const L=i(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),v=i(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),D=i(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),O=i(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),x=i(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),k=i(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),M=i(["#text"]),I=i(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","face","for","headers","height","hidden","high","href","hreflang","id","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),U=i(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),P=i(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),F=i(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),H=a(/\{\{[\w\W]*|[\w\W]*\}\}/gm),z=a(/<%[\w\W]*|[\w\W]*%>/gm),B=a(/\${[\w\W]*}/gm),W=a(/^data-[\-\w.\u00B7-\uFFFF]/),G=a(/^aria-[\-\w]+$/),Y=a(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),j=a(/^(?:\w+script|data):/i),X=a(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),q=a(/^html$/i),$=a(/^[a-z][.\w]*(-[.\w]+)+$/i);var K=Object.freeze({__proto__:null,MUSTACHE_EXPR:H,ERB_EXPR:z,TMPLIT_EXPR:B,DATA_ATTR:W,ARIA_ATTR:G,IS_ALLOWED_URI:Y,IS_SCRIPT_OR_DATA:j,ATTR_WHITESPACE:X,DOCTYPE_NAME:q,CUSTOM_ELEMENT:$});const V=1,Z=3,J=7,Q=8,ee=9,te=function(){return"undefined"==typeof window?null:window};var ne=function t(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:te();const o=e=>t(e);if(o.version="3.1.7",o.removed=[],!n||!n.document||n.document.nodeType!==ee)return o.isSupported=!1,o;let{document:r}=n;const a=r,c=a.currentScript,{DocumentFragment:s,HTMLTemplateElement:N,Node:b,Element:R,NodeFilter:H,NamedNodeMap:z=n.NamedNodeMap||n.MozNamedAttrMap,HTMLFormElement:B,DOMParser:W,trustedTypes:G}=n,j=R.prototype,X=C(j,"cloneNode"),$=C(j,"remove"),ne=C(j,"nextSibling"),oe=C(j,"childNodes"),re=C(j,"parentNode");if("function"==typeof N){const e=r.createElement("template");e.content&&e.content.ownerDocument&&(r=e.content.ownerDocument)}let ie,ae="";const{implementation:le,createNodeIterator:ce,createDocumentFragment:se,getElementsByTagName:ue}=r,{importNode:me}=a;let pe={};o.isSupported="function"==typeof e&&"function"==typeof re&&le&&void 0!==le.createHTMLDocument;const{MUSTACHE_EXPR:fe,ERB_EXPR:de,TMPLIT_EXPR:he,DATA_ATTR:ge,ARIA_ATTR:Te,IS_SCRIPT_OR_DATA:ye,ATTR_WHITESPACE:Ee,CUSTOM_ELEMENT:_e}=K;let{IS_ALLOWED_URI:Ae}=K,Ne=null;const be=S({},[...L,...v,...D,...x,...M]);let Se=null;const Re=S({},[...I,...U,...P,...F]);let we=Object.seal(l(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Ce=null,Le=null,ve=!0,De=!0,Oe=!1,xe=!0,ke=!1,Me=!0,Ie=!1,Ue=!1,Pe=!1,Fe=!1,He=!1,ze=!1,Be=!0,We=!1,Ge=!0,Ye=!1,je={},Xe=null;const qe=S({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let $e=null;const Ke=S({},["audio","video","img","source","image","track"]);let Ve=null;const Ze=S({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),Je="http://www.w3.org/1998/Math/MathML",Qe="http://www.w3.org/2000/svg",et="http://www.w3.org/1999/xhtml";let tt=et,nt=!1,ot=null;const rt=S({},[Je,Qe,et],d);let it=null;const at=["application/xhtml+xml","text/html"];let lt=null,ct=null;const st=r.createElement("form"),ut=function(e){return e instanceof RegExp||e instanceof Function},mt=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!ct||ct!==e){if(e&&"object"==typeof e||(e={}),e=w(e),it=-1===at.indexOf(e.PARSER_MEDIA_TYPE)?"text/html":e.PARSER_MEDIA_TYPE,lt="application/xhtml+xml"===it?d:f,Ne=E(e,"ALLOWED_TAGS")?S({},e.ALLOWED_TAGS,lt):be,Se=E(e,"ALLOWED_ATTR")?S({},e.ALLOWED_ATTR,lt):Re,ot=E(e,"ALLOWED_NAMESPACES")?S({},e.ALLOWED_NAMESPACES,d):rt,Ve=E(e,"ADD_URI_SAFE_ATTR")?S(w(Ze),e.ADD_URI_SAFE_ATTR,lt):Ze,$e=E(e,"ADD_DATA_URI_TAGS")?S(w(Ke),e.ADD_DATA_URI_TAGS,lt):Ke,Xe=E(e,"FORBID_CONTENTS")?S({},e.FORBID_CONTENTS,lt):qe,Ce=E(e,"FORBID_TAGS")?S({},e.FORBID_TAGS,lt):{},Le=E(e,"FORBID_ATTR")?S({},e.FORBID_ATTR,lt):{},je=!!E(e,"USE_PROFILES")&&e.USE_PROFILES,ve=!1!==e.ALLOW_ARIA_ATTR,De=!1!==e.ALLOW_DATA_ATTR,Oe=e.ALLOW_UNKNOWN_PROTOCOLS||!1,xe=!1!==e.ALLOW_SELF_CLOSE_IN_ATTR,ke=e.SAFE_FOR_TEMPLATES||!1,Me=!1!==e.SAFE_FOR_XML,Ie=e.WHOLE_DOCUMENT||!1,Fe=e.RETURN_DOM||!1,He=e.RETURN_DOM_FRAGMENT||!1,ze=e.RETURN_TRUSTED_TYPE||!1,Pe=e.FORCE_BODY||!1,Be=!1!==e.SANITIZE_DOM,We=e.SANITIZE_NAMED_PROPS||!1,Ge=!1!==e.KEEP_CONTENT,Ye=e.IN_PLACE||!1,Ae=e.ALLOWED_URI_REGEXP||Y,tt=e.NAMESPACE||et,we=e.CUSTOM_ELEMENT_HANDLING||{},e.CUSTOM_ELEMENT_HANDLING&&ut(e.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(we.tagNameCheck=e.CUSTOM_ELEMENT_HANDLING.tagNameCheck),e.CUSTOM_ELEMENT_HANDLING&&ut(e.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(we.attributeNameCheck=e.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),e.CUSTOM_ELEMENT_HANDLING&&"boolean"==typeof e.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements&&(we.allowCustomizedBuiltInElements=e.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),ke&&(De=!1),He&&(Fe=!0),je&&(Ne=S({},M),Se=[],!0===je.html&&(S(Ne,L),S(Se,I)),!0===je.svg&&(S(Ne,v),S(Se,U),S(Se,F)),!0===je.svgFilters&&(S(Ne,D),S(Se,U),S(Se,F)),!0===je.mathMl&&(S(Ne,x),S(Se,P),S(Se,F))),e.ADD_TAGS&&(Ne===be&&(Ne=w(Ne)),S(Ne,e.ADD_TAGS,lt)),e.ADD_ATTR&&(Se===Re&&(Se=w(Se)),S(Se,e.ADD_ATTR,lt)),e.ADD_URI_SAFE_ATTR&&S(Ve,e.ADD_URI_SAFE_ATTR,lt),e.FORBID_CONTENTS&&(Xe===qe&&(Xe=w(Xe)),S(Xe,e.FORBID_CONTENTS,lt)),Ge&&(Ne["#text"]=!0),Ie&&S(Ne,["html","head","body"]),Ne.table&&(S(Ne,["tbody"]),delete Ce.tbody),e.TRUSTED_TYPES_POLICY){if("function"!=typeof e.TRUSTED_TYPES_POLICY.createHTML)throw A('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if("function"!=typeof e.TRUSTED_TYPES_POLICY.createScriptURL)throw A('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');ie=e.TRUSTED_TYPES_POLICY,ae=ie.createHTML("")}else void 0===ie&&(ie=function(e,t){if("object"!=typeof e||"function"!=typeof e.createPolicy)return null;let n=null;const o="data-tt-policy-suffix";t&&t.hasAttribute(o)&&(n=t.getAttribute(o));const r="dompurify"+(n?"#"+n:"");try{return e.createPolicy(r,{createHTML:e=>e,createScriptURL:e=>e})}catch(e){return console.warn("TrustedTypes policy "+r+" could not be created."),null}}(G,c)),null!==ie&&"string"==typeof ae&&(ae=ie.createHTML(""));i&&i(e),ct=e}},pt=S({},["mi","mo","mn","ms","mtext"]),ft=S({},["annotation-xml"]),dt=S({},["title","style","font","a","script"]),ht=S({},[...v,...D,...O]),gt=S({},[...x,...k]),Tt=function(e){p(o.removed,{element:e});try{re(e).removeChild(e)}catch(t){$(e)}},yt=function(e,t){try{p(o.removed,{attribute:t.getAttributeNode(e),from:t})}catch(e){p(o.removed,{attribute:null,from:t})}if(t.removeAttribute(e),"is"===e&&!Se[e])if(Fe||He)try{Tt(t)}catch(e){}else try{t.setAttribute(e,"")}catch(e){}},Et=function(e){let t=null,n=null;if(Pe)e="<remove></remove>"+e;else{const t=h(e,/^[\r\n\t ]+/);n=t&&t[0]}"application/xhtml+xml"===it&&tt===et&&(e='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+e+"</body></html>");const o=ie?ie.createHTML(e):e;if(tt===et)try{t=(new W).parseFromString(o,it)}catch(e){}if(!t||!t.documentElement){t=le.createDocument(tt,"template",null);try{t.documentElement.innerHTML=nt?ae:o}catch(e){}}const i=t.body||t.documentElement;return e&&n&&i.insertBefore(r.createTextNode(n),i.childNodes[0]||null),tt===et?ue.call(t,Ie?"html":"body")[0]:Ie?t.documentElement:i},_t=function(e){return ce.call(e.ownerDocument||e,e,H.SHOW_ELEMENT|H.SHOW_COMMENT|H.SHOW_TEXT|H.SHOW_PROCESSING_INSTRUCTION|H.SHOW_CDATA_SECTION,null)},At=function(e){return e instanceof B&&("string"!=typeof e.nodeName||"string"!=typeof e.textContent||"function"!=typeof e.removeChild||!(e.attributes instanceof z)||"function"!=typeof e.removeAttribute||"function"!=typeof e.setAttribute||"string"!=typeof e.namespaceURI||"function"!=typeof e.insertBefore||"function"!=typeof e.hasChildNodes)},Nt=function(e){return"function"==typeof b&&e instanceof b},bt=function(e,t,n){pe[e]&&u(pe[e],(e=>{e.call(o,t,n,ct)}))},St=function(e){let t=null;if(bt("beforeSanitizeElements",e,null),At(e))return Tt(e),!0;const n=lt(e.nodeName);if(bt("uponSanitizeElement",e,{tagName:n,allowedTags:Ne}),e.hasChildNodes()&&!Nt(e.firstElementChild)&&_(/<[/\w]/g,e.innerHTML)&&_(/<[/\w]/g,e.textContent))return Tt(e),!0;if(e.nodeType===J)return Tt(e),!0;if(Me&&e.nodeType===Q&&_(/<[/\w]/g,e.data))return Tt(e),!0;if(!Ne[n]||Ce[n]){if(!Ce[n]&&wt(n)){if(we.tagNameCheck instanceof RegExp&&_(we.tagNameCheck,n))return!1;if(we.tagNameCheck instanceof Function&&we.tagNameCheck(n))return!1}if(Ge&&!Xe[n]){const t=re(e)||e.parentNode,n=oe(e)||e.childNodes;if(n&&t){for(let o=n.length-1;o>=0;--o){const r=X(n[o],!0);r.__removalCount=(e.__removalCount||0)+1,t.insertBefore(r,ne(e))}}}return Tt(e),!0}return e instanceof R&&!function(e){let t=re(e);t&&t.tagName||(t={namespaceURI:tt,tagName:"template"});const n=f(e.tagName),o=f(t.tagName);return!!ot[e.namespaceURI]&&(e.namespaceURI===Qe?t.namespaceURI===et?"svg"===n:t.namespaceURI===Je?"svg"===n&&("annotation-xml"===o||pt[o]):Boolean(ht[n]):e.namespaceURI===Je?t.namespaceURI===et?"math"===n:t.namespaceURI===Qe?"math"===n&&ft[o]:Boolean(gt[n]):e.namespaceURI===et?!(t.namespaceURI===Qe&&!ft[o])&&!(t.namespaceURI===Je&&!pt[o])&&!gt[n]&&(dt[n]||!ht[n]):!("application/xhtml+xml"!==it||!ot[e.namespaceURI]))}(e)?(Tt(e),!0):"noscript"!==n&&"noembed"!==n&&"noframes"!==n||!_(/<\/no(script|embed|frames)/i,e.innerHTML)?(ke&&e.nodeType===Z&&(t=e.textContent,u([fe,de,he],(e=>{t=g(t,e," ")})),e.textContent!==t&&(p(o.removed,{element:e.cloneNode()}),e.textContent=t)),bt("afterSanitizeElements",e,null),!1):(Tt(e),!0)},Rt=function(e,t,n){if(Be&&("id"===t||"name"===t)&&(n in r||n in st))return!1;if(De&&!Le[t]&&_(ge,t));else if(ve&&_(Te,t));else if(!Se[t]||Le[t]){if(!(wt(e)&&(we.tagNameCheck instanceof RegExp&&_(we.tagNameCheck,e)||we.tagNameCheck instanceof Function&&we.tagNameCheck(e))&&(we.attributeNameCheck instanceof RegExp&&_(we.attributeNameCheck,t)||we.attributeNameCheck instanceof Function&&we.attributeNameCheck(t))||"is"===t&&we.allowCustomizedBuiltInElements&&(we.tagNameCheck instanceof RegExp&&_(we.tagNameCheck,n)||we.tagNameCheck instanceof Function&&we.tagNameCheck(n))))return!1}else if(Ve[t]);else if(_(Ae,g(n,Ee,"")));else if("src"!==t&&"xlink:href"!==t&&"href"!==t||"script"===e||0!==T(n,"data:")||!$e[e]){if(Oe&&!_(ye,g(n,Ee,"")));else if(n)return!1}else;return!0},wt=function(e){return"annotation-xml"!==e&&h(e,_e)},Ct=function(e){bt("beforeSanitizeAttributes",e,null);const{attributes:t}=e;if(!t)return;const n={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:Se};let r=t.length;for(;r--;){const i=t[r],{name:a,namespaceURI:l,value:c}=i,s=lt(a);let p="value"===a?c:y(c);if(n.attrName=s,n.attrValue=p,n.keepAttr=!0,n.forceKeepAttr=void 0,bt("uponSanitizeAttribute",e,n),p=n.attrValue,n.forceKeepAttr)continue;if(yt(a,e),!n.keepAttr)continue;if(!xe&&_(/\/>/i,p)){yt(a,e);continue}ke&&u([fe,de,he],(e=>{p=g(p,e," ")}));const f=lt(e.nodeName);if(Rt(f,s,p))if(!We||"id"!==s&&"name"!==s||(yt(a,e),p="user-content-"+p),Me&&_(/((--!?|])>)|<\/(style|title)/i,p))yt(a,e);else{if(ie&&"object"==typeof G&&"function"==typeof G.getAttributeType)if(l);else switch(G.getAttributeType(f,s)){case"TrustedHTML":p=ie.createHTML(p);break;case"TrustedScriptURL":p=ie.createScriptURL(p)}try{l?e.setAttributeNS(l,a,p):e.setAttribute(a,p),At(e)?Tt(e):m(o.removed)}catch(e){}}}bt("afterSanitizeAttributes",e,null)},Lt=function e(t){let n=null;const o=_t(t);for(bt("beforeSanitizeShadowDOM",t,null);n=o.nextNode();)bt("uponSanitizeShadowNode",n,null),St(n)||(n.content instanceof s&&e(n.content),Ct(n));bt("afterSanitizeShadowDOM",t,null)};return o.sanitize=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=null,r=null,i=null,l=null;if(nt=!e,nt&&(e="\x3c!--\x3e"),"string"!=typeof e&&!Nt(e)){if("function"!=typeof e.toString)throw A("toString is not a function");if("string"!=typeof(e=e.toString()))throw A("dirty is not a string, aborting")}if(!o.isSupported)return e;if(Ue||mt(t),o.removed=[],"string"==typeof e&&(Ye=!1),Ye){if(e.nodeName){const t=lt(e.nodeName);if(!Ne[t]||Ce[t])throw A("root node is forbidden and cannot be sanitized in-place")}}else if(e instanceof b)n=Et("\x3c!----\x3e"),r=n.ownerDocument.importNode(e,!0),r.nodeType===V&&"BODY"===r.nodeName||"HTML"===r.nodeName?n=r:n.appendChild(r);else{if(!Fe&&!ke&&!Ie&&-1===e.indexOf("<"))return ie&&ze?ie.createHTML(e):e;if(n=Et(e),!n)return Fe?null:ze?ae:""}n&&Pe&&Tt(n.firstChild);const c=_t(Ye?e:n);for(;i=c.nextNode();)St(i)||(i.content instanceof s&&Lt(i.content),Ct(i));if(Ye)return e;if(Fe){if(He)for(l=se.call(n.ownerDocument);n.firstChild;)l.appendChild(n.firstChild);else l=n;return(Se.shadowroot||Se.shadowrootmode)&&(l=me.call(a,l,!0)),l}let m=Ie?n.outerHTML:n.innerHTML;return Ie&&Ne["!doctype"]&&n.ownerDocument&&n.ownerDocument.doctype&&n.ownerDocument.doctype.name&&_(q,n.ownerDocument.doctype.name)&&(m="<!DOCTYPE "+n.ownerDocument.doctype.name+">\n"+m),ke&&u([fe,de,he],(e=>{m=g(m,e," ")})),ie&&ze?ie.createHTML(m):m},o.setConfig=function(){mt(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}),Ue=!0},o.clearConfig=function(){ct=null,Ue=!1},o.isValidAttribute=function(e,t,n){ct||mt({});const o=lt(e),r=lt(t);return Rt(o,r,n)},o.addHook=function(e,t){"function"==typeof t&&(pe[e]=pe[e]||[],p(pe[e],t))},o.removeHook=function(e){if(pe[e])return m(pe[e])},o.removeHooks=function(e){pe[e]&&(pe[e]=[])},o.removeAllHooks=function(){pe={}},o}();return ne}));
//# sourceMappingURL=purify.min.js.map
