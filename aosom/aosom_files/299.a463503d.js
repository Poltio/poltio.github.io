(window.webpackJsonp=window.webpackJsonp||[]).push([[299],{"../common-use/assets/js/trackMonitor/index.js":function(e,t,r){"use strict";function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,o=new Array(t);r<t;r++)o[r]=e[r];return o}function n(e){return function(e){if(Array.isArray(e))return o(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return o(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return o(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var i;r.r(t);var a=!!(null==(i=navigator)?void 0:i.sendBeacon),s=null,l=null,c=window.requestAnimationFrame?window.requestAnimationFrame:setTimeout,u=null,d=null,p=function(e,t,r){return{session_id:r.session_id,request_id:r.request_id,spm:r.spm,data_type:r.data_type||"behavior",event_type:r.event_type,event_detail:"string"==typeof r.event_detail?r.event_detail:JSON.stringify(r.event_detail),page_url:location.href,os:function(){try{if(window.navigator.userAgentData&&window.navigator.userAgentData.platform)return window.navigator.userAgentData.platform;var e=window.navigator.userAgent;return/android/i.test(e)?"Android":/iPad|iPhone|iPod/.test(e)?"iOS":/Win/.test(e)?"Windows":/Mac/.test(e)?"MacOS":/Linux/.test(e)?"Linux":"Unknown"}catch(e){return console.error("[TM]: Get OS platform failed:",e),"Unknown"}}(),user_id:localStorage.getItem("TRACK_MONITOR_USER")||function(){try{var e,t=localStorage.getItem("userInfo");return t?null==(e=JSON.parse(t))?void 0:e.uid:null}catch(e){return console.error("[TM]: Parse user info failed:",e),null}}(),user_type:window.isWholesale?"2B":"2C",fingerprint_code:"",screen_width:window.screen.width,screen_height:window.screen.height,lib_version:"1.2.0",lib_type:"js",event_time:(new Date).getTime().toString(),timezone_offset:(new Date).getTimezoneOffset().toString(),app_id:e,channel_id:t,_siteId:window.siteId,_lang:window.slang,_version:"test"}};t.default=function(e){var t=e.url,r=void 0===t?window.location.hostname.startsWith("www.aosom")?window.location.origin+"/track/sotuiMessage":({100:"https://popdev.aosom.com",110:"https://popdev.aosom.ca",200:"https://popdev.aosom.co.uk",201:"https://popdev.aosom.ie",210:"https://popdev.aosom.de",211:"https://popdev.aosom.pl",212:"https://popdev.aosom.nl",220:"https://popdev.aosom.it",230:"https://popdev.aosom.fr",231:"https://popdev.aosom.be",240:"https://popdev.aosom.es",241:"https://popdev.aosom.pt",250:"https://popdev.aosom.ro",260:"https://popdev.aosom.at",280:"https://popdev.aosom.se"}[window.siteId]||window.location.origin)+"/track/sotuiMessage":t,o=e.cacheNumber,i=void 0===o?30:o,v=e.reportInterval,m=void 0===v?3e4:v,f=e.maxCacheSize,w=void 0===f?57344:f,g=e.maxRetries,h=void 0===g?10:g;e.app_id=e.app_id||window.siteId,e.islogger=e.islogger||function(){try{return"true"===localStorage.getItem("TRACK_MONITOR_LOGGER")}catch(e){return console.error("[TM]: 获取日志状态失败:",e),!1}}(),e.channel_id=e.channel_id||("web"===window.mode?"PC":"H5");var T=0,_=function(e){try{localStorage.setItem("TRACK_MONITOR_USER",e)}catch(e){console.error("[TM]: monitor bind user fail: ",e)}},y=function(){localStorage.removeItem("TRACK_MONITOR_USER")},b=function(){var e=[];try{e=JSON.parse(localStorage.getItem("TRACK_MONITOR_DATA")||"[]")}catch(e){console.error("[TM]: get monitor data fail: ",e)}return e},S=function(e){try{localStorage.setItem("TRACK_MONITOR_DATA",JSON.stringify(e))}catch(t){console.error("[TM]: save monitor data error: ",e),localStorage.setItem("TRACK_MONITOR_DATA","[]")}},A=function(t){var o=new URLSearchParams;o.append("body",JSON.stringify({body:t,_lang:window.slang,_siteId:+window.siteId,_version:"test"}));var n=JSON.stringify(t,null,2);if(a){var i=navigator.sendBeacon(r,new Blob([o.toString()],{type:"application/x-www-form-urlencoded"}));return e.islogger&&console.log("[TM]: Track Monitor Report By SendBeacon:\n",n),i?Promise.resolve():Promise.reject()}return M({url:r,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:o.toString(),reportData:n,withCredentials:!0})},M=function(t){var r=t.method,o=t.url,n=t.data,i=t.reportData,a=t.headers,s=void 0===a?{}:a,l=t.withCredentials,c=void 0!==l&&l;return new Promise((function(t,a){var l=new XMLHttpRequest;l.open(r,o,!0),Object.keys(s).forEach((function(e){l.setRequestHeader(e,s[e])})),l.withCredentials=!!c,l.onreadystatechange=function(){if(4===l.readyState)if(l.status>=200&&l.status<300)try{var e=JSON.parse(l.responseText);t(e)}catch(e){a(e)}else a(new Error("[TM]: Request failed with status "+l.status))},l.onerror=function(){return a(new Error("[TM]: Network error"))},l.ontimeout=function(){return a(new Error("[TM]: Request timeout"))},n?(l.send(n),e.islogger&&console.log("[TM]: Track Monitor Report By XHR:\n",i)):l.send()}))},O=function(e){void 0===e&&(e=!1);var t=b();if(t.length)return!T&&(t.length>=i||e)?(u&&(clearTimeout(u),u=null),S([]),void A(t).then((function(){T=0})).catch((function(){console.error("[TM]: send report fail, retryCount: ",T),R(t)})).finally((function(){O()}))):void(null===u&&(u=setTimeout((function(){var e=b();e.length?d||(S([]),d=A(e).then((function(){T=0})).catch((function(){R(e)})).finally((function(){u=null,d=null,O()}))):u=null}),(T+1)*m)))},R=function(e){if(++T>h)T=0;else{var t=b();S(t.concat(e))}},I=function(t){A([p(e.app_id,e.channel_id,t)])},k=function(t){var r=[p(e.app_id,e.channel_id,t)];try{var o=b();o&&(r=r.concat(o),S(r));var n=new Blob([JSON.stringify(r)]).size;O(n>=w)}catch(e){console.error("[TM]: lazy report fail: ",e)}};c((function(){O(!0)}));!function(e){try{l=new WeakMap}catch(e){console.error("[TM]: create WeakMap fail: ",e)}var t=function(e,t){void 0===t&&(t=!1);var o=null==l?void 0:l.get(e);if(!o||t){o&&(o.viewTimer&&clearTimeout(o.viewTimer),o.exposeTimer&&clearTimeout(o.exposeTimer));var n=e.dataset.durationView||500,i=e.dataset.durationExpose||500;if(null==l||l.set(e,{duration_view:n,duration_expose:i,viewTimer:null,exposeTimer:null}),null==s||s.observe(e),t){var a=e.getBoundingClientRect();a.top>=0&&a.left>=0&&a.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&a.right<=(window.innerWidth||document.documentElement.clientWidth)&&r(e)}}},r=function(t){var r=null==l?void 0:l.get(t);if(r){var n,i=t.dataset.eventDetail,a=null!=(n=t.dataset.traceid)?n:null,s=t.dataset.spm;t.hasAttribute("track-view")&&(r.viewTimer=window.setTimeout((function(){e({spm:s,request_id:a,data_type:"behavior",event_type:"view",event_detail:i}),t.removeAttribute("track-view"),t.hasAttribute("track-expose")&&r.exposeTimer||o(t),r.viewTimer=null}),parseInt(r.duration_view,10))),t.hasAttribute("track-expose")&&(r.exposeTimer=window.setTimeout((function(){e({spm:s,request_id:a,data_type:"behavior",event_type:"expose",event_detail:i}),r.exposeTimer=null}),parseInt(r.duration_expose,10)))}},o=function(e){var t=null==l?void 0:l.get(e);t&&(null==s||s.unobserve(e),t.viewTimer&&clearTimeout(t.viewTimer),t.exposeTimer&&clearTimeout(t.exposeTimer),null==l||l.delete(e))},i=function(e){e.forEach((function(e){var t=e.target,n=null==l?void 0:l.get(t);n&&(n.viewTimer&&(clearTimeout(n.viewTimer),n.viewTimer=null),n.exposeTimer&&(clearTimeout(n.exposeTimer),n.exposeTimer=null),e.isIntersecting&&(r(t),t.hasAttribute("track-view")||t.hasAttribute("track-expose")||o(t)))}))};s=function(){var e=null;try{e=new IntersectionObserver(i,{root:null,threshold:.5})}catch(e){console.error("[TM]: create IntersectionObserver fail: ",e)}return e}(),new Set(n(document.querySelectorAll("[track-expose]")).concat(n(document.querySelectorAll("[track-view]")))).forEach((function(e){return t(e)})),new MutationObserver((function(e){e.forEach((function(e){if("attributes"===e.type&&e.target instanceof HTMLElement){var r=e.target,i=e.attributeName;r.hasAttribute("track-expose")||r.hasAttribute("track-view")?["data-event-detail","data-traceid","data-spm","data-duration-view","data-duration-expose"].includes(i)?t(r,!0):"track-expose"!==i&&"track-view"!==i||t(r,!1):o(r)}else"childList"===e.type&&(e.addedNodes.forEach((function(e){e instanceof HTMLElement&&(e.hasAttribute("track-expose")||e.hasAttribute("track-view")?t(e):new Set(n(e.querySelectorAll("[track-expose]")).concat(n(e.querySelectorAll("[track-view]")))).forEach((function(e){return t(e)})))})),e.removedNodes.forEach((function(e){e instanceof HTMLElement&&((null==l?void 0:l.get(e))?o(e):new Set(n(e.querySelectorAll("[track-expose]")).concat(n(e.querySelectorAll("[track-view]")))).forEach((function(e){return o(e)})))})))}))})).observe(document.body,{attributes:!0,childList:!0,subtree:!0})}(k),window.addEventListener("beforeunload",(function(){O(!0)}));var x=function(){e.islogger=!0;try{localStorage.setItem("TRACK_MONITOR_LOGGER","true")}catch(e){console.error("[TM]: enable logger fail:",e)}},E=function(){e.islogger=!1;try{localStorage.setItem("TRACK_MONITOR_LOGGER","false")}catch(e){console.error("[TM]: disable logger fail:",e)}};return window.trackMonitor={report:k,realtimeReport:I,bindUser:_,unBindUser:y,enableLogger:x,disableLogger:E},{bindUser:_,unBindUser:y,report:k,realtimeReport:I,enableLogger:x,disableLogger:E}}}}]);