
window.baBounceManagement=window.baBounceManagement||{ignoreHash:false,requestUrl:'https://api.bounce-commerce.de/request',redirectUrl:'https://api.bounce-commerce.de/redirect?hash=',evilMethods:['Conv.Init','clarity.js','https://js.smct.io/'],initialData:{},setSessionStorage(){sessionStorage.setItem('ba_last_page',window.baBounceManagement.getWindowUrl())},getWindowUrl(){let request_uri=window.location.href
if(window.location.href.includes('wpm@')){const page_viewed_event=window.dataLayer.find(event=>event?.event?.includes('page_viewed'))
request_uri=page_viewed_event.shopifyPixelEvent.context.window.location.href}
return request_uri},deleteLocalStorage:function(){if((new Date()).getTime()>=Date.parse(localStorage.getItem('ba_expires_at'))){localStorage.removeItem('ba_hash')
localStorage.removeItem('ba_expires_at')
localStorage.removeItem('ba_redirect')}},setLocalStorage:function(data){data.hash&&localStorage.setItem('ba_hash',data.hash)
data.expires_at&&localStorage.setItem('ba_expires_at',data.expires_at)
data.redirect!==undefined&&data.redirect!==null&&localStorage.setItem('ba_redirect',data.redirect)},sendRequest:async function(strURI,strAim){const strHash=localStorage.getItem('ba_hash')
const objPostData=new FormData()
objPostData.append('request_uri',window.baBounceManagement.getWindowUrl())
objPostData.append('last_page',sessionStorage.getItem('ba_last_page'))
if(null!=strHash)objPostData.append('hash',strHash)
if(document.referrer)objPostData.append('referrer',document.referrer)
if(strAim)objPostData.append('aim',strAim)
if(strURI)objPostData.append('uri',strURI)
try{const request=await fetch(window.baBounceManagement.requestUrl,{method:'POST',mode:'cors',body:objPostData,})
return request.json()}catch(e){return null}},redirect:function(){window.baBounceManagement.setLocalStorage(window.baBounceManagement.initialData)
if(window.baBounceManagement.ignoreHash||(''===window.top.location.hash&&'#'!==window.location.href.slice(-1))){location.replace(window.baBounceManagement.redirectUrl+localStorage.getItem('ba_hash'))}},removeRedirectOnNavigation:function(){history._pushState=history.pushState
history.pushState=function(state,title,url){const stackTrace=new Error().stack
const isEvilMethod=window.baBounceManagement.evilMethods.some(method=>stackTrace.includes(method))
if(isEvilMethod)return history.replaceState.apply(this,[state,title,url])
window.removeEventListener("popstate",window.baBounceManagement.redirect)
history.replaceState(state,title,url)
history.pushState=history._pushState}},initializeRedirect(data){window.baBounceManagement.setLocalStorage(data)
window.baBounceManagement.initialData=data
if(window.bavBounceManagement.requestRedirect||window.bavBounceManagement.requestRedirect===undefined){if(data.redirect){window.baBounceManagement.ignoreHash=!!data.ignore_hash
history.pushState(null,null,window.location.href)
window.baBounceManagement.removeRedirectOnNavigation()
window.addEventListener("popstate",window.baBounceManagement.redirect)}else{history.pushState=new Proxy(history.pushState,{apply:(target,thisArg,argumentsList)=>target.apply(thisArg,argumentsList)})
window.removeEventListener("popstate",window.baBounceManagement.redirect)}}},redirectTo404(data){window.location.replace(data['404_url'])},}
window.baBounceManagement.deleteLocalStorage()
window.bavBounceManagement&&window.baBounceManagement.sendRequest(window.bavBounceManagement.strURI,window.bavBounceManagement.strAim,).then(function(data){if(!data)return
if(data['404']&&data['404_url']){window.baBounceManagement.redirectTo404(data)
return}else if(data['404']&&!data['404_url']){return}
window.baBounceManagement.initializeRedirect(data)}).catch(function(error){})
window.addEventListener('beforeunload',()=>{window.baBounceManagement.setSessionStorage()})